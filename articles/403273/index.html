<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation with convenient Pebble, stable Noolite and affordable esp8266</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since the last article (the link has passed almost a year. And this year, I rethought some things, the Internet and it turned out something like IoT :...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation with convenient Pebble, stable Noolite and affordable esp8266</h1><div class="post__text post__text-html js-mediator-article">  Since the last article (the <a href="https://geektimes.ru/post/276716/">link</a> has passed almost a year. And this year, I rethought some things, the Internet and it turned out something like IoT :) ‚Üí Internet of things). <br><br>  I will try to briefly present the new portion of accumulated knowledge, describe where I aspire and what I want to achieve ‚Üí I ask for reading. <br><a name="habracut"></a><br><h2>  Noolite F v2.0 </h2><br>  <b>In the title, I slipped the words: pebble &amp; noolite.</b>  <b>Let's go to them!</b> <br>  I still control the noolite with my pebble, garage and gate.  About noolite already written a lot of useful information, the <a href="https://geektimes.ru/search/%3Ftarget_type%3Dposts%26q%3Dnoolite%26order_by%3Ddate">search</a> shows new articles. <br><br>  In addition to the blocks of the first generation of the noolite system, I had new ones: the power block SLF-1-200 (nooLite-F) with feedback ( <a href="https://geektimes.ru/post/288164/">and encryption of the new generation</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/geektimes/post_images/312/be1/be5/312be1be5d922ebcc46d307015f01eb0.png" alt="image"><br><br>  power unit SB-1-150 <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/0a1/575/b81/0a1575b813bdd72fa22800bf8b33374d.png" alt="image"><br><br>  and updated usb adapter MTRF-64 USB. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/61e/842/1de/61e8421deaa8155d33aba9f064002a3b.png" alt="image"><br><br>  The whole world in my house on the system noolite. <br><br>  More recently, I had a first-generation noolite USB adapter for 16 devices, and now for 64 channels (MTRF-64 USB), and also for new-generation devices with feedback (noolite F) in my ‚Äúsystem home cramp‚Äù.  Notechnology is moving in the right direction, creating a new modern device. <br><br>  <b>There are 2 most important options for new devices: feedback and the principle of identification of devices by addresses: ID.</b>  Now you don‚Äôt need to write to channel 1 of devices and control the channel.  Now you can access a specific device in one channel by its ID and sending it an execution command. <br><br>  Documentation for new generation units <a href="http://www.noo.com.by/assets/files/PDF/MTRF-64-USB.pdf">is available</a> on the manufacturer‚Äôs website. <br><br><div class="spoiler">  <b class="spoiler_title">Everything works via serial port using python code.</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- #!/usr/bin/env python import serial import time class NooLiteCommand: def __init__(self, ch, cmd, mode=0, ctr=0, res=0, fmt=0, d0=0, d1=0, d2=0, d3=0, id0=0, id1=0, id2=0, id3=0): self.st = 171 self.mode = mode self.ctr = ctr self.res = res self.ch = ch self.cmd = cmd self.fmt = fmt self.d0 = d0 self.d1 = d1 self.d2 = d2 self.d3 = d3 self.id0 = id0 self.id1 = id1 self.id2 = id2 self.id3 = id3 self.sp = 172 @property def crc(self): crc = sum([ self.st, self.mode, self.ctr, self.res, self.ch, self.cmd, self.fmt, self.d0, self.d1, self.d2, self.d3, self.id0, self.id1, self.id2, self.id3, ]) return crc if crc &lt; 256 else divmod(crc, 256)[1] def to_bytes(self): return bytearray([ self.st, self.mode, self.ctr, self.res, self.ch, self.cmd, self.fmt, self.d0, self.d1, self.d2, self.d3, self.id0, self.id1, self.id2, self.id3, self.crc, self.sp ]) class NooliteSerial: def __init__(self, tty_name): self.tty = self._get_tty(tty_name) def on(self, ch): self.send_command(ch, 2, 2, 0) pass def off(self, ch): self.send_command(ch, 0, 2, 0) pass def status(self, ch): m = self.send_command(ch, 128, 2, 0) pass def send_command(self, ch, cmd, mode=0, ctr=0, res=0, fmt=0, d0=0, d1=0, d2=0, d3=0, id0=0, id1=0, id2=0, id3=0): command = NooLiteCommand(ch, cmd, mode, ctr, res, fmt, d0, d1, d2, d3, id0, id1, id2, id3) self.tty.write(command.to_bytes()) while True: bytes_response = list(self.tty.read(117)) if bytes_response: all_responses.append(bytes_response) if bytes_response[3] == 0: break else: break return all_responses @staticmethod def _get_tty(tty_name): serial_port = serial.Serial(tty_name, timeout=0.1) if not serial_port.is_open: serial_port.open() serial_port.flushInput() serial_port.flushOutput() return serial_port noo_serial = NooliteSerial('/dev/ttyUSB0') #ch, cmd, mode, ctr #noo_serial.send_command(1, 15, 2, 0) #    1 #noo_serial.send_command(0, 4, 2, 0) #switch #noo_serial.send_command(0, 2, 2, 0) #turn on #noo_serial.send_command(0, 3, 2, 0) #   #noo_serial.send_command(0, 0, 2, 0) #turn off #noo_serial.send_command(0, 15, 2, 0) #  #noo_serial.send_command(0, 128, 2, 0,0,1) #CMD_Read_State + fmt = 1 #noo_serial.on(0) #noo_serial.status(0) #noo_serial.off(0) #noo_serial.off(0) #noo_serial.status(0) #noo_serial.send_command(ch=0,ctr=8, cmd=4, id0=0,id1=0,id2=48,id3=114) #switch noolite ID 0.0.48.114</span></span></code> </pre> <br></div></div><br>  Using the right functions at the right time, we can manage noolite blocks and get status from new ones.  Since I have 99% of these are old blocks, it remains for me to use the old scheme of recording 1 block in 1 channel, taking into account the fact that the usb adapter supports both old and new blocks (thanks to the developers for compatibility without tambourine dances).  On the fly, you can manage and receive the status of new blocks and manage old ones. <br><br>  Until recently, there was not a single pushbutton switch in the house.  I had to add light to the garage (I just got there to put things in order: D), and there was also a switch in the backlight of the makeup mirror.  Knowing that there is a <b>power unit SB-1-150</b> , I set the switch to normal and connected the unit.  The backlight mirror made of white plate, 3w 4000 K light bulbs, white light.  SB-1-150 is unique in that it can be placed in a wall switch box (switch) in the context of an existing circuit and connecting a push button switch to the unit itself. <br><br><div class="spoiler">  <b class="spoiler_title">Exactly what it takes to make up my girls :)</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/63d/97d/4ff/63d97d4ff9ed73ee3fe00abba6a94fed.png" alt="image"><br></div></div><br><h2>  Pebble </h2><br>  When I started to get involved in automation, one of the main factors was: competent and convenient control. <br><br>  It seems to be convenient to control from a smartphone, but ... and it is not convenient, to load an application every time, where small uncomfortable buttons, left advertising or until you reach the button ... all desire disappears.  Voice control disappears, as it is also inconvenient and strange :) - let it remain in the plots of science fiction films. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/5ea/226/ba7/5ea226ba78a2e6fb2e61a63458aa88af.png" alt="image"><br><br>  And I solved the problem differently - through a wristwatch, which CONSTANTLY with me, do not occupy space and combine all the conveniences, mobility and speed of control.  In general - Pebble is alive!  But the most important thing is that, for hours, you can still write applications ‚Äî your own applications, for managing your automation systems.  This is generally a ‚Äúbomb‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Pebble is alive!</b> <div class="spoiler_text">  <a href="https://www.youtube.com/watch%3Fv%3Dj3dQNRg8cCI">Video control with gate clock</a> <br></div></div><br>  The tragedy of closing pebble.com companies (Fitbit bought all pebble.com for patents) did not affect their performance and performance.  Ios, android has recently been updated - the clock is untied from pebble cloud services (in case of termination of support) and authorization. <br><br>  Visually, nothing has changed, but the service is still live: <a href="http://cloudpebble.net/">cloudpebble.net</a> - WTF?  This is a very useful thing.  If you can write code on JS (and there is no desire to spend a lot of time on C ++) - please, welcome on board :) - cloud pebble allows you to quickly ‚Äúadd‚Äù the application.  Well, that's how I did.  Of course, JS performance should not be compared with C ++ (this is sacred), be patient.  Yes! <br><br><div class="spoiler">  <b class="spoiler_title">Pebble cloud JS code for working with API</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UI = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ui'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ajax = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ajax'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> noolite = [ [<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/mqtt/gate/slidegate'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/gate.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/mqtt/gate/garage'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/door.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'!'</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/103'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/100'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/system2.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'1  '</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'2  '</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 1'</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/101'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 2'</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/102'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/system/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/system1.png'</span></span>], ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> water = [ [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 1 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/20'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 2 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/21'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 3 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/22'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 4 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/23'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 5 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/switch/5'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 6 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/switch/6'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 7 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/switch/7'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 8 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/switch/8'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 9 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/admin/poliv/switch/9'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/water.png'</span></span>], ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> light1 = [ [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/6'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/0'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'  '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'  '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/7'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'  '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/8'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 1 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 1 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/3'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 1 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/4'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/5'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/9'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> light2 = [ [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/15'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/16'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 2 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/10'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 2 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/11'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' 2 '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/12'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/13'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], [<span class="hljs-string"><span class="hljs-string">'  '</span></span>,<span class="hljs-string"><span class="hljs-string">'http://your-home-server-ip-address:1183/noolite/switch/14'</span></span>, <span class="hljs-string"><span class="hljs-string">'images/light.png'</span></span>], ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menu = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UI.Menu({ <span class="hljs-attr"><span class="hljs-attr">sections</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">items</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }] }] }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menu1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UI.Menu({ <span class="hljs-attr"><span class="hljs-attr">sections</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">items</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }] }] }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menu2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UI.Menu({ <span class="hljs-attr"><span class="hljs-attr">sections</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">items</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }] }] }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menu3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UI.Menu({ <span class="hljs-attr"><span class="hljs-attr">sections</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">items</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }] }] }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;noolite.length; i++) { items[i] = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: noolite[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: noolite[i][<span class="hljs-number"><span class="hljs-number">2</span></span>] }; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items1 = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;light1.length; i++) { items1[i] = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: light1[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: light1[i][<span class="hljs-number"><span class="hljs-number">2</span></span>] }; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items2 = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;light2.length; i++) { items2[i] = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: light2[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: light2[i][<span class="hljs-number"><span class="hljs-number">2</span></span>] }; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items3 = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;water.length; i++) { items3[i] = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: water[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">subtitle</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: water[i][<span class="hljs-number"><span class="hljs-number">2</span></span>] }; } menu.items(<span class="hljs-number"><span class="hljs-number">0</span></span>, items); menu1.items(<span class="hljs-number"><span class="hljs-number">0</span></span>, items1); menu2.items(<span class="hljs-number"><span class="hljs-number">0</span></span>, items2); menu3.items(<span class="hljs-number"><span class="hljs-number">0</span></span>, items3); menu.show(); menu.on(<span class="hljs-string"><span class="hljs-string">'select'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.itemIndex == <span class="hljs-number"><span class="hljs-number">4</span></span>) { menu1.show(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.itemIndex == <span class="hljs-number"><span class="hljs-number">5</span></span>) { menu2.show(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.itemIndex ==<span class="hljs-number"><span class="hljs-number">8</span></span>) { menu3.show(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = noolite[e.itemIndex][<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(url); ajax({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'get'</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'switched OK'</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Failure! console.log('error'); } ); } }); menu1.on('select', function(e) { var url = light1[e.itemIndex][1]; console.log(url); ajax({ url: url, method: 'get' }, function(data) { console.log('switched OK'); }, function(error) { // Failure! console.log('error'); } ); }); menu2.on('select', function(e) { var url = light2[e.itemIndex][1]; console.log(url); ajax({ url: url, method: 'get' }, function(data) { console.log('switched OK'); }, function(error) { // Failure! console.log('error'); } ); }); menu3.on('select', function(e) { var url = water[e.itemIndex][1]; ajax({ url: url, method: 'get' }, function(data) { console.log('switched OK'); }, function(error) { // Failure! console.log('error'); } ); });</span></span></code> </pre><br></div></div><br>  The code is written, compiled directly on the cloud Pebble website and through the phone, downloading the compiled application can be installed on the watch - in seconds.  Everything is so simple that any young automator can do it;) <br><br>  It‚Äôs a pity ... it‚Äôs a pity that Pebble has ceased to exist and for the current moment I don‚Äôt see an alternative.  Pebble Time will always be in our hearts! <br><br><h2>  MQTT </h2><br>  Last year I met such a wonderful protocol as MQTT (History: The first version of the protocol was developed by Dr. Andy Stanford-Clarke (IBM) and Arlen Nipper (Arcom) in 1999 and published under a royalty free license. The MQTT 3.1.1 specification was standardized by the OASIS consortium in 2014. <a href="https://ru.wikipedia.org/wiki/MQTT">Reference</a> ). <br><br>  There is a lot of information about how the protocol works and what kind of clients there are ... and was very disappointed that there are no real clients for mobile applications, only on android. <br><br>  Understanding that the lack of a good mobile application is a very big problem (hole) in the field of IoT (many people speak and do very little ....) - I decided to create a client for android, ios, wp with my team, at work. so that it meets all the criteria and is comfortable.  I‚Äôll write about the client separately a little later, as well as how we made friends with ESP8266 + MTRF64 (Noolite) and prepared the Nodemcu firmware.  It will be great, convenient, cheap and beautiful!  Follow the news of the application <a href="http://mqtt.ximxim.com/">here</a> . <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/96c/60d/e63/96c60de63c38253cccee7ddb9aad0b4b.png" alt="image"><br><br>  <s>Now you can control Noolite lighting without any home servers and usb adapters for $ 50-100!</s> <br><br><h2>  General scheme of home automation </h2><br>  The following scheme still exists: <br><br><blockquote>  Video surveillance: xeoma video surveillance [ip camera] <br>  Server on the system unit: nginx + gunicorn + python + mqtt broker <br>  Management: Pebble watch + MQTT client <br>  Control modules (system nodes): ESP8266 + optocouplers \ sensors ds18b20, dht11 [22] </blockquote><br>  Due to the fact that I saw a lot of conveniences in the MQTT protocol, starting from the subscription architecture and instant communication with end IoT devices, ending with the fact that MQTT messages can fly through the router, without ‚Äúforwarding‚Äù all kinds of ports and dancing with a tambourine.  Conveniently!  Fun!  Fervently :) <br><br>  All this led me to decentralization of the system, that is, the departure from one ‚Äúhome wormwood‚Äù and the transition to many so-called nodes and the use of the cloud MQTT broker (there are free MQTT brokers, for example: <a href="http://mqtt.ximxim.com/">mqtt.ximxim.com</a> (on the website login and pass for access )) - since esp8266 solve all problems, and it in turn works through wifi using the MQTT protocol. <br><br>  Given that MQTT Buddy will provide script services, I won‚Äôt think at all that I need to write some home scripts, I‚Äôll just create them in a cloud solution and this will be a real IoT and it works!  From words to deeds! <br><br><h2>  ESP8266 </h2><br>  When I became acquainted with this development board, I was immediately bribed by the fact that the board is small, there is support for the LUA programming language in Nodemcu.  What you need + MQTT module is.  In automation, simple and reliable solutions are the foundation.  Cost from $ 2 to $ 5 for a fee (for 5 models immediately with a usb adapter on board) allows you to quickly deploy subsystems. <br><br>  WiFi connection is fast, there are a lot of possibilities  For example: control of the gate \ garage \ watering \ lighting.  My 30% lawn irrigation works from the Noolite system (dry contact blocks), the remaining 70% of the esp8266 development board is controlled via LUA using the MQTT protocol. <br><br><div class="spoiler">  <b class="spoiler_title">Sample code on LUA for esp8266, getting ip and invoking MQTT work file</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--load credentials dofile("credentials.lua") function init(name, pass) wifi.setmode(wifi.STATION) wifi.sta.config(name, pass) wifi.sta.connect() tmr.alarm(0, 1000, 1, function() if wifi.sta.getip()== nil then print("IP unavaiable, Waiting...") else tmr.stop(0) print("Config done, IP is "..wifi.sta.getip()) print("mac : "..wifi.sta.getmac()) dofile("mqtt.lua") end end) end print("START!") init(SSID,PASSWORD)</span></span></code> </pre><br><br>  - mqtt.lua file <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> door = <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-comment"><span class="hljs-comment">-- gpio13 local window = 6 -- gpio12 local cooler = 5 --gpio14 local led = 4 --GPIO2 board led! LOW == turn ON local light1 = 8 --gpio 15 local light2 = 1 --gpio 5 local light3 = 2 -- gpio 4 function register_myself() m:subscribe("mqtt_buddy/#",0,function(conn) print ("subscribed to Xim mqtt.ximxim.com server") end) end m = mqtt.Client("MQTT_BUDDY_SHOW_ROOM", 120, MQTT_USER, MQTT_PASS) m:on("connect", function(client) print ("connected to Xim mqtt.ximxim.com server") end) m:on("offline", function(client) reconnect_mqtt() end) m:on("message", function(client, topic, data) --print(topic.." data:"..data) if topic == "mqtt_buddy/window" and data == "1" then print "open-close window..." gpio.write(window, gpio.HIGH) gpio.write(led, gpio.LOW) tmr.alarm(1, 1000, tmr.ALARM_SINGLE, function() gpio.write(window, gpio.LOW) gpio.write(led, gpio.HIGH) print "command to close\open window is sent!" end) elseif topic == "mqtt_buddy/door" and data == "1" then print "open-close door..." gpio.write(door, gpio.HIGH) gpio.write(led, gpio.LOW) tmr.alarm(2, 1000, tmr.ALARM_SINGLE, function() gpio.write(door, gpio.LOW) gpio.write(led, gpio.HIGH) print "command to close\open door is sent!" end) elseif topic == "mqtt_buddy/cooler" then if data == "1" then print "switch on fan..." gpio.write(cooler, gpio.HIGH) gpio.write(led, gpio.LOW) else print "switch off fan..." gpio.write(cooler, gpio.LOW) gpio.write(led, gpio.HIGH) end elseif topic == "mqtt_buddy/light1" then if data == "1" then print "switch light1 ON..." gpio.write(light1, gpio.HIGH) gpio.write(led, gpio.LOW) else print "switch light1 off..." gpio.write(light1, gpio.LOW) gpio.write(led, gpio.HIGH) end elseif topic == "mqtt_buddy/light2" then if data == "1" then print "switch light2 ON..." gpio.write(light2, gpio.HIGH) gpio.write(led, gpio.LOW) else print "switch light2 off..." gpio.write(light2, gpio.LOW) gpio.write(led, gpio.HIGH) end elseif topic == "mqtt_buddy/light3" then if data == "1" then print "switch light3 ON..." gpio.write(light3, gpio.HIGH) gpio.write(led, gpio.LOW) else print "switch light3 off..." gpio.write(light3, gpio.LOW) gpio.write(led, gpio.HIGH) end end end) m:connect(MQTT_SERVER, MQTT_SERVER_PORT, 0, function(conn) register_myself() end)</span></span></code> </pre><br></div></div><br><h3>  Problem </h3><br>  Addressing a huge community of <b>thinking people</b> , I wanted to touch on an extremely important topic, or rather the problem I want to solve, but I don‚Äôt have enough time for deeper research / knowledge. <br><br>  Essence: during decentralization, there remains video surveillance, which somehow DEMANDS having a host machine for (minimum) transferring source images either to a surveillance server (for example, ivideon) or generally processing video on a home machine, like xeoma (although they also have a cloud) one way or another, it is necessary to ‚ÄúFLIP‚Äù video streams, pictures on final computing powers (cloud solutions) - or vice versa - streaming is simple. <br><br>  There are thoughts to get source images from the camera (there is also a problem here, not every camera has a URL for receiving a picture from the camera and it‚Äôs not at all clear how others will recognize this URL ...) and forward to the MQTT channel where binary data is supported ( there is a picture can be easily transferred via mqtt protocol in binary form). <br><br>  Perhaps someone has already tried to implement such things = ESP8266 + IP web cam? <br>  Call out pliz (bogdanovich.alex [@] gmail.com).  I will be very grateful! <br><br>  At implementation of probros, the home server question will disappear.  What for?  Because he eats electricity and the furnace heats me :) <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/148/bfb/eab/148bfbeab6e37921aa198344af6564de.png" alt="image"><br><br>  All positive day and good mood! </div><p>Source: <a href="https://habr.com/ru/post/403273/">https://habr.com/ru/post/403273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../403259/index.html">Internet Archive has released an archive of software for the first Macintosh</a></li>
<li><a href="../403263/index.html">How is the work in the service center "NAG"</a></li>
<li><a href="../403265/index.html">Hotel Industry Announces Airbnb War</a></li>
<li><a href="../403267/index.html">To systems on a chip through FPGAs: the week of digital microelectronics in Kiev - April 24-29, 2017</a></li>
<li><a href="../403271/index.html">Copter Shot</a></li>
<li><a href="../403275/index.html">Searches for the lack of antimatter in the universe remain in the annoying state of uncertainty</a></li>
<li><a href="../403277/index.html">These Indian women scientists sent a rocket to Mars for an amount less than the budget of the film "Martian"</a></li>
<li><a href="../403279/index.html">RFID news: sales of chipped fur coats have pierced ... ceilings</a></li>
<li><a href="../403281/index.html">Windows 10 will suppress background applications</a></li>
<li><a href="../403283/index.html">3D printer Funtastique EVO v1.0: first acquaintance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>