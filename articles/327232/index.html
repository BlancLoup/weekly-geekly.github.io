<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to use a token to make a Windows domain safer? Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some of you have probably heard about the incident that was made public recently. The American semiconductor manufacturer Allegro MicroSystem LLC sued...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to use a token to make a Windows domain safer? Part 1</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/98a/a92/61f/98aa9261f6bf4602a630636c8ac18dc7.jpg"></div><br><p>  Some of you have probably heard about the <a href="http://www.securitylab.ru/news/485878.php">incident</a> that was made public recently.  The American semiconductor manufacturer Allegro MicroSystem LLC sued its former IT specialist for sabotage.  Nimesh Patel, who has worked for the company for 14 years, destroyed important financial data in the first week of the new fiscal year. </p><a name="habracut"></a><br><p>  How did this happen? </p><br><p>  Two weeks after his dismissal, Patel went to the territory of the company's headquarters in Worcester (Massachusetts, USA) in order to catch a corporate Wi-Fi network.  Using the credentials of a former colleague and a working laptop, Patel logged into the corporate network.  Then he introduced the code into the Oracle module and programmed its implementation on April 1, 2016, the first week of the new fiscal year.  The code was intended to copy certain headers or pointers into a separate database table and then remove them from the module.  Exactly on April 1 data was deleted from the system.  And since the attacker logged into the Allegro network legally, his actions were not immediately noticed. </p><br><p>  The general public does not know the details, but most likely the incident was made possible largely due to the fact that the company used password authentication to access the network.  Surely there were other security problems, but it is the password that can be stolen unnoticed by the user and the fact that the password is stolen will not be detected, at best, until the use of the stolen credentials is used. </p><br><p>  The use of strong two-factor authentication and the ban on the use of passwords in combination with a sound security policy could help, if not avoid the described development of events, then greatly complicate the implementation of such a plan. </p><br><p>  We will talk about how you can significantly improve the security of your company and protect yourself from such incidents.  You will learn how to configure authentication and signature of important data using tokens and cryptography (both foreign and domestic). </p><br><p>  In the first article, we will explain how to configure strong two-factor authentication using PKI when logging into a domain account in Windows. </p><br><p>  In the following articles we will tell you how to set up Bitlocker, protect email and the simplest workflow.  We will also set up secure access to corporate resources and secure remote access via VPN. </p><br><h2>  Two-factor authentication </h2><br><p>  Experienced system administrators and security services are well aware that users are extremely unconscious about compliance with security policies, they can write their credentials on a sticker and stick it next to the computer, pass passwords to their colleagues, and the like.  Especially often this happens when the password is complex (containing more than 6 characters and consisting of letters of different register, numbers and special characters) and it is difficult to remember.  But such policies are set by administrators for a reason.  This is necessary to protect the user account from simply dictionary passwords.  Also, administrators recommend changing passwords at least once every 6 months, simply from the consideration that during this time it is theoretically possible even to reset a complex password. </p><br><p>  Let's remember what authentication is.  In our case, this is the process of verifying the authenticity of a subject or object.  User authentication is the process of authenticating a user. </p><br><p>  And two-factor authentication is such an authentication, in which you need to use at least two different ways to confirm your identity. </p><br><p>  The simplest example of two-factor authentication in real life is a safe with a lock and code combination.  To open such a safe you need to know the code and own the key. </p><br><h2>  Token and smart card </h2><br><p>  Probably the most reliable and easy to implement method of two-factor authentication is the use of a cryptographic token or a smart card.  A token is a USB device that is both a reader and a smart card at the same time.  The first factor in this case is the fact of possession of the device, and the second is the knowledge of its PIN-code. </p><br><p>  Use a token or a smart card, then to someone, which is more convenient.  But historically, it turned out that in Russia, tokens are more accustomed to using tokens, since they do not require the use of embedded or external smart card readers.  Tokens have their drawbacks.  For example, you can‚Äôt print a photo on it. </p><br><p>  The photo shows a typical smart card and reader. </p><br><img src="https://habrastorage.org/files/bf0/8e8/782/bf08e87826774010820fd66086f411e3.jpg"><br><br><p>  But back to corporate security. </p><br><p>  And we start with the Windows domain, because in most companies in Russia, the corporate network is built around it. </p><br><p>  As you know, Windows domain policies, user settings, group settings in Active Directory provide and differentiate access to a huge number of applications and network services. </p><br><p>  By protecting an account in the domain, we can protect most, and in some cases, all internal information resources. </p><br><h2>  Why is two-factor domain-token authentication with a PIN code safer than a regular password scheme? </h2><br><p>  The PIN code is tied to a specific device, in our case to a token.  Knowledge of the PIN-code in itself does not give anything. </p><br><p>  For example, a PIN from a token can be dictated over the phone to others and it will not give anything to an attacker if you are careful enough about the token and do not leave it unattended. </p><br><p>  With a password, the situation is completely different, if an attacker picked up, guessed, spied, or somehow took possession of a password from an account in the domain, then he will be able to freely enter both the domain itself and other services of the company that use this same account. </p><br><p>  The token is a unique non-replicable physical object.  It has a legitimate user.  Two-factor authentication by token can be bypassed only when the administrator intentionally or due to an oversight left for this ‚Äúloopholes‚Äù in the system. </p><br><h2>  Advantages of entering the domain by token </h2><br><p>  The PIN from the token is easier to remember, since it can be much easier than a password.  Everyone probably saw at least once in their life how an ‚Äúexperienced‚Äù user could not painfully authenticate himself in the system with several attempts, remembering and entering his ‚Äúsecure‚Äù password. </p><br><p>  The PIN code does not need to be constantly changed, since the tokens are more resistant to brute force PIN codes.  After a number of unsuccessful input attempts, the token is blocked. </p><br><p>  When using a token for a user, the login is as follows: after booting the computer, it simply connects the token to the USB port of the computer, enters 4-6 digits and presses the Enter button.  The speed of entering numbers for ordinary people is higher than the speed of entering letters.  Therefore, the PIN is entered faster. </p><br><img src="https://habrastorage.org/files/e51/f94/d63/e51f94d633e740d881b7922ccd851433.jpg"><br><br><p>  Tokens allow you to solve the problem of "abandoned workplace" - when a user leaves his workplace and forgets to log out of his account. </p><p></p><p>  Domain policy can be configured so that the computer is automatically blocked when removing the token.  Also, the token can be equipped with an RFID tag for the passage between company premises, therefore, without taking the token from his workplace, the employee simply cannot move around the territory. </p><br><h2>  Disadvantages, where do without them </h2><br><p>  Tokens or smart cards are not free (decided by the budget). </p><br><p>  They need to be taken into account, administered and maintained (solved by token management systems and smart cards). </p><br><p>  Some information systems may ‚Äúout of the box‚Äù not support authentication by tokens (solved by systems like Single Sign-On ‚Äî designed to enable the organization to use a single account to access any area resources). </p><br><h2>  Configuring two-factor authentication in the Windows domain </h2><br><p>  Theoretical part: </p><br><p>  The Active Directory directory service supports authentication using a smart card and a token, starting with Windows 2000. It is embedded in the public key initialization (PKINIT) extension for the Kerberos <a href="https://tools.ietf.org/html/rfc4556">RFC 4556</a> protocol. </p><br><p>  The Kerberos protocol was specifically designed to provide strong user authentication.  It can use centralized storage of authentication data and is the basis for building Single Sing-On mechanisms.  The protocol is based on the key entity Ticket (ticket). </p><br><img src="https://habrastorage.org/files/fae/1f7/d88/fae1f7d8860d4088b8992826f5a599e4.png"><br><p>  A ticket is an encrypted data packet that is issued by a trusted authentication center in terms of the Kerberos Key Distribution Center (KDC). </p><br><p>  When a user performs primary authentication after successfully verifying its authenticity, the KDC issues a primary user identity for accessing network resources ‚Äî the Ticket Granting Ticket (TGT). </p><br><p>  Later, when accessing individual network resources, the user submits the TGT, receives an identity from the KDC for access to a specific network resource - Ticket Granting Service (TGS). </p><br><p>  One of the advantages of the Kerberos protocol, which provides a high level of security, is that, for any interactions, neither passwords nor password hash values ‚Äã‚Äãare transmitted in the clear. </p><br><p>  The PKINIT extension allows you to use two-factor authentication by tokens or smart cards during the Kerberos pre-authentication stage. </p><br><p>  Logon can be provided by using both the domain‚Äôs directory service and the local directory service.  A TGT is created based on an electronic signature that is calculated on a smart card or token. </p><br><p>  All domain controllers must have the Domain Controller Authentication, or Kerberos Authentication certificate installed, as the client and server mutual authentication is implemented. </p><br><p>  Practice: </p><br><p>  We proceed to the setting. </p><br><p>  We will make it so that you can enter the domain under your account only upon the presentation of the token and knowing the PIN code. </p><br><p>  For the demonstration, we will use <a href="https://www.rutoken.ru/products/all/rutoken-ecp-pki/">Rutoken EDS PKI</a> manufactured by ‚ÄúAktiv‚Äù company. </p><br><img src="https://habrastorage.org/files/fa0/9fb/e33/fa09fbe335dd48398d64552b2aeb80e4.JPG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  <b>Stage 1 - Setting up the domain</b> First, install the certification services. </p><br><p>  Disclaimer </p><br><p>  This article is not a tutorial on the implementation of corporate PKI.  Issues of design, deployment and competent application of PKI are not considered here due to the immensity of this topic. </p><br><p>  All domain controllers and all client computers within the forest where the implementation of such a solution is being implemented must necessarily trust the Root Certification Authority (Certificate Authority). </p><br><p>  The task of the certification authority is to verify the authenticity of encryption keys using electronic signature certificates. </p><br><p>  Technically, a certification authority is implemented as a component of a global directory service responsible for managing users' cryptographic keys.  Public keys and other information about users are stored by certification authorities in the form of digital certificates. </p><br><p>  A certificate authority issuing certificates for using smart cards or tokens must be placed in the NT Authority repository. </p><br><p>  Go to Server Manager and select Add Roles and Components. </p><br><p>  When adding server roles, select Active Directory Certificate Services (Microsoft strongly recommends not doing this on a domain controller, so as not to stumble on performance problems).  In the window that opens, select "Add components" and select "Certification Authority". </p><br><p>  On the page to confirm the installation of components, click "Install". </p><br><p>  <b>Stage 2 - Setting the entrance to the domain using a token</b> </p><br><p>  To log in, we need a certificate that contains the Smart Card Logon and Client Authentication identifiers. </p><br><p>  The certificate for smart cards or tokens must also contain the user's UPN (suffix for the member's name).  By default, the user principal name suffix for the account is the DNS domain name that contains the user account. </p><br><p>  The certificate and private key must be placed in the appropriate sections of the smart card or token, and the private key must be located in the protected memory area of ‚Äã‚Äãthe device. </p><br><p>  The certificate must contain the path to the distribution point of the certificate revocation list (CRL distribution point).  This file contains a list of certificates with the certificate‚Äôs serial number, revocation date and reason for revocation.  It is used to transmit information about revoked certificates to users, computers, and applications trying to verify the authenticity of the certificate. </p><br><p>  Configure the installed certification services.  In the upper right corner, click on the yellow triangle with an exclamation mark and click "Configure Certificate Services ...". </p><br><img src="https://habrastorage.org/files/e63/17f/d6c/e6317fd6c07341bfbf6491ef2abd297c.jpg"><br><br><p>  In the "Credentials" window, select the required user credentials to configure the role.  Select "Certification Authority". </p><br><p>  Select "Enterprise CA". </p><br><p>  CA's enterprises are integrated with AD.  They publish certificates and certificate revocation lists in AD. </p><br><p>  Specify the type of "root CA". </p><br><p>  In the next step, select ‚ÄúCreate a new private key‚Äù. </p><br><p>  Select the validity period of the certificate. </p><br><p>  <b>Stage 3 - Adding Certificate Templates</b> </p><br><p>  To add certificate templates, open the Control Panel, select ‚ÄúAdministration‚Äù and open the Certificate Authority. </p><br><p>  Click on the name of the folder "Certificate Templates", select "Management". </p><br><p>  Click on the ‚ÄúSmart Card User‚Äù template name and select ‚ÄúCopy Template‚Äù.  The following screenshots show which parameters in the ‚ÄúNew Template Properties‚Äù window need to be changed. </p><br><img src="https://habrastorage.org/files/35d/4a8/2e8/35d4a82e8dbd4fbe85150c8759c028fa.jpg"><br><br><img src="https://habrastorage.org/files/f36/738/34d/f3673834daa44ba4bab308058793f6d2.jpg"><br><br><img src="https://habrastorage.org/files/ec7/b6e/fc3/ec7b6efc33174545a9a6d6e391c4562f.jpg"><br><br><p>  If there is no ‚ÄúAktiv ruToken CSP v1.0‚Äù in the list of suppliers, then you need to install the ‚ÄúRutoken for Windows drivers‚Äù kit. </p><br><p>  Starting with Windows Server 2008 R2, instead of a special provider from the manufacturer, you can use the Microsoft Base Smart Card Crypto Provider. </p><br><p>  For Rutoken devices, the mini-driver library, which supports the Microsoft Base Smart Card Crypto Provider, is distributed through Windows Update. </p><br><p>  You can check whether the ‚Äúminidriver‚Äù is installed on your server by connecting Rutoken to it and looking in the device manager. </p><br><img src="https://habrastorage.org/files/99c/630/68b/99c63068b253424cb9d0a461a4c18353.png"><br><p>  If for some reason there is no ‚Äúmini driver‚Äù, you can install it forcibly by installing the ‚ÄúRutoken drivers for Windows‚Äù kit, and then use the ‚ÄúMicrosoft Base Smart Card Crypto Provider‚Äù. </p><br><p>  The Rutoken Drivers for Windows kit is distributed free of charge from the <a href="https://www.rutoken.ru/support/download/drivers-for-windows/">Rutoken</a> website. </p><br><img src="https://habrastorage.org/files/38e/c28/373/38ec2837356747858568393d232a12a4.jpg"><br><br><img src="https://habrastorage.org/files/763/6fe/39c/7636fe39c977416cbd83f9cf09329120.jpg"><br><br><p>  Add two new templates ‚ÄúCertification Agent‚Äù and ‚ÄúUser with Rutoken‚Äù. </p><br><p>  Next, we need to issue a certificate to the domain administrator.  Open the Run service and specify the <i>mmc</i> command.  Add the Certificates snap-in. </p><br><p>  In the "Certificate Manager Snap-in" window, select "my user account".  In the Add / Remove Snap-in window, confirm the addition of certificates. </p><br><p>  Select the Certificates folder. </p><br><img src="https://habrastorage.org/files/4e7/081/b3b/4e7081b3ba2b4053be2d9bd640b4915b.jpg"><br><p>  Request a new certificate.  The page for registering the certificate will open.  At the certificate request stage, select the ‚ÄúAdministrator‚Äù registration policy and click ‚ÄúApplication‚Äù. </p><br><img src="https://habrastorage.org/files/864/364/485/86436448589446cabcc3d6289e469261.jpg"><br><p>  In the same way, request a certificate for the Registration Agent. </p><br><p>  To request a certificate for a specific user, click "Certificates", select "Register as.". </p><br><img src="https://habrastorage.org/files/179/6c0/8f9/1796c08f9c1e493f8572aa0b4c6f8787.jpg"><br><br><p>  In the window for the certificate request, select the "User with Rutoken" checkbox. </p><br><p>  Now you need to select a user. </p><br><p>  In the field "Enter the names of the selected objects" enter the user name in the domain and click "Check Name". </p><br><p>  In the window to select a user, click "Request". </p><br><p>  In the drop-down list, select the name of the token and enter the PIN. </p><br><img src="https://habrastorage.org/files/b2f/72e/3b4/b2f72e3b4faa4643b1a8b076609c7820.jpg"><br><br><p>  In the same way, select certificates for other users in the domain. </p><br><p>  <b>Stage 4 - Setting Up User Accounts</b> </p><br><p>  To set up accounts, open the list of users and AD computers. </p><br><p>  Select the Users folder and the "Properties" item. </p><br><img src="https://habrastorage.org/files/66c/df1/cfc/66cdf1cfc3a74ca69d74b09b2730d2af.jpg"><br><br><p>  Go to the ‚ÄúAccounts‚Äù tab, check the box ‚ÄúYou need a smart card for interactive logging into the network‚Äù. </p><br><img src="https://habrastorage.org/files/806/91c/bc0/80691cbc044e4eb6b36eda11d5092db8.jpg"><br><br><p>  Configure security policies.  To do this, open the Control Panel and select "Administration".  Open the menu to manage Group Policy. </p><br><p>  In the left pane of the Group Policy Management window, click the Default Domain Policy and select Edit. </p><br><img src="https://habrastorage.org/files/e48/2ff/ecf/e482ffecfea34cb7b1beaee444217529.jpg"><br><br><p>  In the left part of the Group Policy Management Editor, select Security Settings. </p><br><img src="https://habrastorage.org/files/d27/b7f/d04/d27b7fd04dad4598b3d71139e436c1ad.jpg"><br><br><p>  Open the Interactive Login: Require Smart Card policy. </p><br><p>  On the Security Policy Settings tab, select the Define Next Policy Setting and Enabled checkboxes. </p><br><p>  Open the Interactive Logon: Smart Card Removal Behavior policy. </p><br><p>  On the "Security Policy Settings" tab, select the "Define the following policy setting" checkbox, from the drop-down list, select "Lock Workstation". </p><br><p>  Reboot the computer.  And the next time you try to authenticate to the domain, you can already use the token and its PIN. </p><br><img src="https://habrastorage.org/files/238/84a/767/23884a767dde4ab2bf8d496f5dcba036.jpg"><br><br><p>  <b>BINGO!</b> </p><br><p>  Two-factor authentication to log on to the domain is configured, which means that the level of security for logging on to the Windows domain is significantly improved without spending a hefty amount on additional protection.  Now, no login is possible without a token, and users can breathe easy and not suffer with complex passwords. </p><br><p>  The next step is secure mail, about this and setting up secure authentication in other systems, read our next articles. </p><p></p><p></p></div><p>Source: <a href="https://habr.com/ru/post/327232/">https://habr.com/ru/post/327232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327220/index.html">Nalivator-9000: robot barman on Raspberry Pi and Go</a></li>
<li><a href="../327222/index.html">3D modeling and high performance computing (HPC) in the development of new products</a></li>
<li><a href="../327224/index.html">From engineers to managers: maintaining technical skills</a></li>
<li><a href="../327226/index.html">Open source databases on large machines: disk speed and innodb_io_capacity. Part 2</a></li>
<li><a href="../327228/index.html">The book "React.js. Fast start"</a></li>
<li><a href="../327234/index.html">Jerminal - terminal emulator for java programs</a></li>
<li><a href="../327236/index.html">Dive into Ethereum</a></li>
<li><a href="../327238/index.html">We invite you to the IV conference on the practical application of data science DataScience Lab May 13</a></li>
<li><a href="../327240/index.html">As we from the CRUD-engine service did</a></li>
<li><a href="../327242/index.html">Open machine learning course. Topic 9. Time Series Analysis with Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>