<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Raspbian and QEMU</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everybody! They gave me a raspberry pi recently, and I decided to use it. But, as is usually the case, at home there is very little time for thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Raspbian and QEMU</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6b5/05e/080/6b505e08021e99b16b7acd1d9672fc68.png" alt="image"><br>  Hello everybody!  They gave me a raspberry pi recently, and I decided to use it.  But, as is usually the case, at home there is very little time for this, and there‚Äôs nothing to connect it to at work.  Therefore, I decided to put raspbian on a virtual machine in order to use it at work.  Who cares how I did ask to join <a name="habracut"></a><br>  To achieve my goal, I used a variety of articles and posts on forums in various parts of the Internet, links to those articles that I recall will be given at the end of my story.  Also, please do not kick for mistakes and style of narration, but indicate all the shortcomings in the comments, since  This is my first publication on Habr√© in particular, and somewhere else in general. <br><br>  So, let's begin!  To make raspbian work on QEMU, we first need the Linux kernel under the arm-platform.  There are already ready cores, but for general development I decided to try to assemble myself. <br>  To do this, you will need a machine with an operating system from the Linux family (in fact, I just don‚Äôt know if it can be done on other operating systems).  I used one of the varieties of Debian, namely Kali Linux, since  He was at that moment at hand. <br>  1. From the beginning, download the packages that we need to build the kernel by running the following command: <br><pre><code class="bash hljs">sudo apt-get install git libncurses5-dev gcc-arm-linux-gnueabihf</code> </pre> <br>  <i>If you are using a 32-bit system, then you will need to install the x86 libraries:</i> <br><pre> <code class="bash hljs">sudo apt-get install ia32-libs</code> </pre><br><br>  2. You also need to install a cross-compiler, for this you need to add a repository: <br> <code><a href="http://www.emdebian.org/debian/"></a> deb www.emdebian.org/debian unstable main</code> <br>  And execute the following commands: <br><pre> <code class="bash hljs">apt-get update apt-get install gcc-4.7-arm-linux-gnueabihf</code> </pre> <br>  And for compatibility create a symbolic label on the compiler: <br><pre> <code class="bash hljs">ln -s <span class="hljs-string"><span class="hljs-string">'which arm-linux-gnueabihf-gcc-4.7'</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/arm-linux/gnueabihf-gcc</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      3. The next step is to download the kernel sources and the patch to support the core of the ARM11 architecture and apply this patch to the sources.  To do this, run the following commands: <br><pre> <code class="bash hljs">mkdir /git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/raspberrypi/linux.git wget http://xecdesign.com/downloads/linux-qemu/linux-arm.patch patch -p1 -d linux/ &lt; linux-arm.patch</code> </pre><br><br>  4. Next we will need to configure the kernel for the needs of Raspbian. <br>  To do this, execute the following commands: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux make ARCH=arm versatile_defconfig make ARCH=arm menuconfig</code> </pre><br>  And in the menu that appears, select the following settings. <br>  <b>IMPORTANT!!!</b>  If you select an option, if you have appeared opposite the option, press the space once more, so that &lt;*&gt; appears. <br>  a) Specify the cross compiler: <br> <code>General Setup -&gt; Cross-compiler tool prefix <br> arm-linux-gnueabihf-</code> <br>  <b>IMPORTANT!</b>  Be sure to include a '-' at the end. <br><br>  b) CPU settings: <br> <code>System Type-&gt; <br> [*] Support ARMV6 processor <br> [*] ARM errata: Invalidation of the Instruction Cache Operation fail <br> [*] ARM errata: Possible cache data corruption with hit-under-miss enabled <br></code> <br><br>  c) Enable support for hard-float binaries: <br> <code>Floating point emulation -&gt; <br> [*] VFP-format floating point maths <br></code> <br><br>  d) Enabling EABI for ARM: <br> <code>Kernel Features -&gt; <br> [*] Use the ARM EABI to compile the kernel <br> [*] Allow old ABI binaries to run with this kernel <br></code> <br><br>  e) Enable QEMU disk support: <br> <code>Bus Support-&gt; <br> [*] PCI Support <br> Device Drivers -&gt; <br> SCSI Device Support <br> [*] SCSI Device Support <br> [*] SCSI Disk Support <br> [*] SCSI CDROM Support <br> [*] SCSI low-level drivers -&gt; <br> [*] SYM53C8XX Version 2 SCSI support</code> <br> <br>  f) Enable devtmpfs: <br> <code>Device Drivers -&gt; <br> Generic Driver Options -&gt; <br> [*] Maintain a devtmpfs filesystem to mount at /dev <br> [*] Automount devtmpfs at /dev, after the kernel mounted the root</code> <br> <br>  g) Inclusion of important file systems: <br> <code>File Systems -&gt; <br> &lt;*&gt; Ext3 journaling file system support <br> &lt;*&gt; The Extended 4 (ext4) filesystem <br> DOS/FAT/NT Filesystems -&gt; <br> &lt;*&gt; VFAT (Windows-95) fs support</code> <br> <br>  g) Enable tmpfs: <br> <code>File Systems -&gt; <br> Pseudo filesystems-&gt; <br> [*] Tmpfs Virtual Memory file system support (former shm fs)</code> <br> <br>  h) Enable message interface: <br> <code>Device Drivers -&gt; <br> Input device support -&gt; <br> [*] Event interface</code> <br> <br>  i) <i>(optional)</i> Enable /proc/config.gz <br> <code>General Setup -&gt; <br> [*] Kernel .config support <br> [*] Enable access to .config through /proc/config.gz</code> <br> <br>  j) <i>(optional)</i> Use larger fonts and incorporate the logo: <br> <code>Device Drivers -&gt; <br> Graphics Support -&gt; <br> [*] Bootup logo <br> Console display driver support -&gt; <br> [*] Select compiled-in fonts <br> [*] VGA 8x16 font</code> <br> <br>  Save and exit. <br><br>  Next, we go to the compilation of the kernel itself.  To do this, run the following commands: <br><pre> <code class="bash hljs">make ARCH=arm make arch=arm INSTALL_MOD_PATH=../modules modules_install</code> </pre><br><br>  Well, I immediately copy it to the root, because  then I will write the parameters from the root. <br><pre> <code class="bash hljs">cp arch/arm/boot/zImage /kernel-qemu</code> </pre><br><br>  This completes the kernel build for QEMU.  If you do not want to repeat all this, then at the end I will post links to all files. <br><br>  <b>The next step</b> is to install QEMU. <br>  For users of Windows OS, everything is very simple.  Go to <a href="http://lassauge.free.fr/qemu">QEMU ON WINDOWS</a> and download the archive with the latest version of QEMU. <br>  <b>IMPORTANT!!!</b>  The QEMU version should be at least 1.5.0, since  it fixed a critical bug for emulating Raspbian <br>  For Windows users I will not describe in detail the process of starting Raspbian, since  it is very similar with the startup process on the Linux family of OS.  If you have questions, we will meet in comments. <br><br>  So, for starters, copy the source code for QEMU: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://git.qemu-project.org/qemu.git</code> </pre><br>  Also install the dependencies: <br><pre> <code class="bash hljs">apt-get install libsdl1.2-dev</code> </pre><br>  Go to the setup and installation: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> qemu ./configure -target-list=<span class="hljs-string"><span class="hljs-string">"arm-softmmu arm-linux-user"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-sdl -static make sudo make install</code> </pre><br>  If you get the message <b>Error: DTC not present</b> , then run the following command: <br><pre> <code class="bash hljs">git submodule update --init dtc</code> </pre><br>  Now you have QEMU and the kernel, it remains to download the <a href="http://downloads.raspberrypi.org/raspbian_latest">Raspbian image</a> and perform a ‚Äúsetup‚Äù boot. <br><br>  To run Raspbian for the first time, execute the following command: <br><pre> <code class="bash hljs">qemu-system-arm -kernel /kernel-qemu -cpu arm1176 -m 256 -M versalitepb -append <span class="hljs-string"><span class="hljs-string">"root=/dev/sda2 panic=1 rootfstype=ext4 rw init=/bin/bash"</span></span> -hda &lt;___Rapbian&gt;</code> </pre><br>  After downloading you will see the bash prompt: <br><img src="http://habrastorage.org/files/448/b1b/b86/448b1bb860b54d9" alt="image"><br>  Enter: <br><pre> <code class="bash hljs">nano /etc/ld.so.preload</code> </pre><br>  Comment out the line, press [Ctrl] + [x], save and exit <br><img src="http://habrastorage.org/files/9da/e7f/2fd/9dae7f2fd12a45ef8145c785daddad13.png" alt="image"><br>  Also execute: <br><pre> <code class="bash hljs">nano /etc/udev/rules.d/90-qemu.rules</code> </pre><br>  And enter: <br> <code>KERNEL=="sda",SYMLINK+="mmcblk0" <br> KERNEL=="sda?",SYMLINK+="mmcblk0p%n", <br></code> <br>  Save, close and turn off virtualku: <br><pre> <code class="bash hljs">shutdown -h now</code> </pre><br><br>  Now everything is ready to launch a virtual Raspbian.  Run the command: <br><pre> <code class="bash hljs">qemu-system-arm -kernel /kernel-qemu -cpu arm1176 -m 256 -M versalitepb -append <span class="hljs-string"><span class="hljs-string">"root=/dev/sda2 panic=1 rootfstype=ext4 rw"</span></span> -hda &lt;___Rapbian&gt;</code> </pre><br>  And if everything went well, then you will see the standard Raspbian prompt: <br><img src="http://habrastorage.org/files/299/08c/a35/29908ca35d3c4fd799bbd5de0afa7467.png" alt="image"><br><br>  It may also be useful to resize the disk.  To do this on the host: <br><pre> <code class="bash hljs">qemu-img resize &lt;__Raspbian&gt; +6G</code> </pre><br>  Then download Raspbian and do the following: <br><pre> <code class="bash hljs">sudo fdisk /dev/sda</code> </pre><br>  Press [p] and note the Start value for sda2. <br>  Then press [d] and delete the 2 section. <br>  Then press [n] - to create a new section. <br>  Press [p] to indicate that it will be primary. <br>  Indicate that he will be the second by pressing [2]. <br>  Set the First sector to Start. <br>  For Last Sector, just press [Enter] to use all the free space. <br>  Press [w] to exit, saving changes to the partition table. <br>  Reboot by running the command: <br><pre> <code class="bash hljs">sudo shutdown -r now</code> </pre><br>  After reboot, execute the command: <br><pre> <code class="bash hljs">sudo resize2fs /dev/sda2</code> </pre><br>  That's all.  Having executed the command <br><pre> <code class="bash hljs">df -h</code> </pre><br>  You will see the new size of your disk. <br><br>  On this, probably all I wanted to say.  Please do not kick much for the style of presentation, but rather point out specific errors in the comments. <br><br>  Links to materials: <br>  1. Compiling the kernel - <a href="http://xecdesign.com/compiling-a-kernel">xecdesign.com/compiling-a-kernel</a> <br>  2. QEMU - <a href="http://wiki.qemu.org/">wiki.qemu.org</a> <br>  3. <a href="http://yadi.sk/d/Yz7imZ3mKgAC9">My core</a> </div><p>Source: <a href="https://habr.com/ru/post/216205/">https://habr.com/ru/post/216205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216193/index.html">Asterisk + Cisco SPA5XX, SPA3XX - DND with server notification</a></li>
<li><a href="../216197/index.html">Learning NAS Synology to route traffic to an OpenVPN tunnel with certificate authentication</a></li>
<li><a href="../216199/index.html">Logitech G700. One year later</a></li>
<li><a href="../216201/index.html">Collect and analyze logs with Lumberjack + Logstash + Elasticsearch + RabbitMQ</a></li>
<li><a href="../216203/index.html">Notes for sales managers in a web-studio or ‚ÄúSay a word about a poor marketer‚Äù</a></li>
<li><a href="../216207/index.html">Implementing Koh-Zhao steganographic method on Ruby</a></li>
<li><a href="../216209/index.html">Law ‚Ññ139-–§–ó: view from a small provider</a></li>
<li><a href="../216213/index.html">How a designer find a job in IT</a></li>
<li><a href="../216215/index.html">Creating a failover IPSec VPN tunnel between Mikrotik RouterOS and Kerio Control</a></li>
<li><a href="../216219/index.html">We expand the functionality of the exchange of orders between 1C-Bitrix and 1C Enterprise UT 11</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>