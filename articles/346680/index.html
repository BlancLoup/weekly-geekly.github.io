<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bobaos - access to the KNX TP / UART bus with the Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are not familiar with automation systems and the KNX standard, you can get the necessary information in Google or from official sites. If you w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bobaos - access to the KNX TP / UART bus with the Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article"><p>  If you are not familiar with automation systems and the KNX standard, you can get the necessary information in Google or from official sites.  If you work with this standard, then many things will be clear to you, and perhaps you, like me, have long been interested in the question of how you can get access to the physical KNX bus, bypassing IP routers. </p><br><p>  Next, I will show how I solved this problem for myself using the Raspberry Pi and the KNX BAOS 838 kBerry module from Weinzierl. </p><br><p><img src="https://habrastorage.org/webt/su/wr/is/suwrisllhke1azam7kq_jirkfqu.jpeg"></p><a name="habracut"></a><br><h2 id="motivaciya">  Motivation </h2><br><p>  The KNX standard implies a decentralized system operating in the absence of a central PLC controller.  Decentralization ensures reliability, but the absence of a PLC in the system deprives us of the flexibility we need.  You can use different IP gateways, and communicate via UPD from the server, but this solution was not considered, because access directly to the bus looks more reliable. </p><br><h2 id="suschestvuyuschie-resheniya">  Existing solutions </h2><br><p>  On the market, you can find solutions for this problem, with the following of them I worked closely: </p><br><h3 id="loxone-miniserver">  Loxone miniserver </h3><br><ul><li>  Price: ~ 600 Euro </li><li>  Plus: its own tire, a large range of devices. </li><li>  Plus: a simple configurator, programming logic in blocks, good documentation. </li><li>  Minus: there is no possibility to program in high level languages.  There is a built-in PicoC interpreter, but it is problematic to implement, for example, access to the cloud. </li></ul><br><h3 id="iridium-server-dlya-umc">  iRidium Server for UMC </h3><br><ul><li>  Price: recommended retail 119000r, or ~ 1700 euros. </li><li>  Plus: support for a large number of automation systems, in addition to KNX. </li><li>  Plus: JavaScript support. </li><li>  Minus: project file - zip archive, which complicates its editing.  Those.  In order to edit a script, you should either use iRidium Studio with a built-in script editor, which does not have the charms of your usual IDE / editor, or think of a way to unpack / assemble a project. </li><li>  Minus: JavaScript engine.  For example, there is no usual setTimeout / setInterval, instead of them IR.SetTimeout / IR.SetInterval.  There is no compatibility with nodejs. </li><li>  Minus: stability of work, frequent reboots. </li></ul><br><h3 id="evika-logicmachine">  EVIKA LogicMachine </h3><br><ul><li>  Price: ~ 3000 euros. </li><li>  Plus: in addition to KNX TP / UART, there are RS-485, RS-232 and other interfaces on the board, depending on the configuration. </li><li>  Plus: language lua, cron schedules, and more. </li></ul><br><p>  Some solutions are good, but the price pushes away, plus I would like to use more flexibility in programming. </p><br><h2 id="reshenie">  Decision </h2><br><p>  The task was solved using the Raspberry Pi and the Weinzierl KNX BAOS Module 838 kBerry module. <br>  The cost of the module is ~ 70 euros, in the amount of the Raspberry Pi + power supply, the DIN rail housing is about 150 euros. </p><br><p>  As the runtime, nodejs is used, from the dependencies the "serialport" module for communication with the UART. </p><br><div class="spoiler">  <b class="spoiler_title">Brief description of the communication protocol</b> <div class="spoiler_text"><p>  Our application is connected via a serial port to the BAOS 838 module and communicates via the ObjectServer protocol, a description of which can be found at the link at the end of the article. </p><br><p>  The frame with the data is in protocol FT1.2 as follows: </p><br><pre><code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|0x68|</span></span>L<span class="hljs-params"><span class="hljs-params">|L|</span></span><span class="hljs-number"><span class="hljs-number">0x68</span></span><span class="hljs-params"><span class="hljs-params">|CR|</span></span>data<span class="hljs-params"><span class="hljs-params">|C|</span></span><span class="hljs-number"><span class="hljs-number">0x16</span></span><span class="hljs-params"><span class="hljs-params">|  L -   data +1    CR -  ,  0x73  , 0x53   , C -  = (   +  ) mod 256</span></span></code> </pre> <br><p>  There are also fixed-length frames, such as reset request, reset indication, acknowledge frame. </p><br><p>  Reset request is sent when the connection is opened, reset indication is sent from the baos 838 module to the Raspberry Pi when the module is reset, acknowledge sends each side when receiving data. </p><br><p>  Data data consists of the following fields: </p><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|  |</span></span>  <span class="hljs-params"><span class="hljs-params">|  |</span></span> MainService <span class="hljs-params"><span class="hljs-params">| 1 |</span></span>  .  <span class="hljs-number"><span class="hljs-number">0xF0</span></span> <span class="hljs-params"><span class="hljs-params">| SubService |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| .   : , , . |</span></span> StartItem <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> ID   <span class="hljs-params"><span class="hljs-params">| NumberOfItems |</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-params"><span class="hljs-params">|    ...      .       .</span></span></code> </pre> <br><p>  Communication scheme: </p><br><ol><li>  Our application (client) sends a reset request. </li><li>  BAOS 838 (server) sends acknowledge. </li><li>  The client sends the first request (for example GetDatapointDescription.Req).  Odd frame. </li><li>  The server receives the request, sends acknowledge. </li><li>  The server sends a response to the request. </li><li>  The client sends an acknowledge acknowledgment. <br>  .... </li></ol></div></div><br><h2 id="podklyuchenie">  Connection </h2><br><p>  The module connects to the GPIO contacts of the Raspberry Pi board; for more details, see the links at the end of the article. </p><br><h2 id="ets">  ETS </h2><br><p>  Like any KNX device, the BAOS 838 module is configured via ETS.  The application in this case uses "KNX BAOS 830", it can be downloaded from the official website of the manufacturer.  The device supports up to 1000 multicast addresses. </p><br><h2 id="nastroyka-raspberry-pi">  Configure Raspberry Pi </h2><br><p>  First of all, install raspbian-stretch-lite, set up access via ssh. </p><br><p>  Next, configure the UART interface.  For Raspberry Pi 3: </p><br><pre> <code class="bash hljs">sudo sh -c <span class="hljs-string"><span class="hljs-string">"echo dtoverlay=pi3-miniuart-bt &gt;&gt;/boot/config.txt"</span></span></code> </pre> <br><p>  From /boot/cmdline.txt we remove the record <strong>console = serial0,115200</strong> </p><br><p>  Add a user to the dialout group: </p><br><pre> <code class="bash hljs">sudo usermod -a -G dialout YOURUSERNAME</code> </pre> <br><p>  Reboot </p><br><pre> <code class="bash hljs">reboot</code> </pre> <br><p>  Install nodejs, git: </p><br><pre> <code class="bash hljs">curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - sudo apt-get install -y nodejs git</code> </pre> <br><p>  Preparation is completed, go to our project. </p><br><h2 id="bobaos-cli">  bobaos-cli </h2><br><p>  For testing, you can use a simple command line interface.  Install: </p><br><pre> <code class="bash hljs">sudo npm install -g bobaos-cli</code> </pre> <br><p>  Run: </p><br><pre> <code class="bash hljs">% bobaos-cli bobaos&gt; <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> Commands: <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>...] Provides <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a given <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> Exits application. open [options] Open serial port getDatapointDescription [options] GetDatapointDescription.Req service setDatapointValue [options] SetDatapointValue.Req service with <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"set and send to bus"</span></span> readDatapointFromBus [options] SetDatapointValue.Req service with <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> <span class="hljs-string"><span class="hljs-string">"read via bus"</span></span> getDatapointValue [options] GetDatapointValue.Req service getParameterByte [options] GetParameterByte.Req service</code> </pre> <br><p>  Next we open the port with the open command.  By default, the connection to the device / dev / ttyAMA0 is opened; if the system has a different interface, use the -p, --port option. </p><br><p>  Further, we can get information about configured datapoints: </p><br><pre> <code class="bash hljs">bobaos&gt; getDatapointDescription -s 1 -n 10 { service: <span class="hljs-string"><span class="hljs-string">'GetDatapointDescription.Res'</span></span>, direction: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 10, payload: [ { id: 1, valueType: 8, configFlags: 95, dpt: <span class="hljs-string"><span class="hljs-string">'dpt9'</span></span> }, { id: 2, valueType: 7, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt5'</span></span> }, { id: 3, valueType: 7, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt5'</span></span> }, { id: 4, valueType: 7, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt5'</span></span> }, { id: 5, valueType: 7, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt5'</span></span> }, { id: 6, valueType: 0, configFlags: 95, dpt: <span class="hljs-string"><span class="hljs-string">'dpt1'</span></span> }, { id: 7, valueType: 0, configFlags: 95, dpt: <span class="hljs-string"><span class="hljs-string">'dpt1'</span></span> }, { id: 8, valueType: 0, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt1'</span></span> }, { id: 9, valueType: 0, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt1'</span></span> }, { id: 10, valueType: 14, configFlags: 87, dpt: <span class="hljs-string"><span class="hljs-string">'dpt16'</span></span> } ] } bobaos&gt;</code> </pre> <br><p>  In my case, the first one is a temperature sensor, followed by several single-byte values, several single-byte values, and the string value dpt16. </p><br><p>  We get the values: </p><br><pre> <code class="bash hljs">bobaos&gt; getDatapointValue -s 1 -n 10 { service: <span class="hljs-string"><span class="hljs-string">'GetDatapointValue.Res'</span></span>, direction: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 10, payload: [ { id: 1, state: 16, length: 2, value: &lt;Buffer 0c bf&gt; }, { id: 2, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 3, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 4, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 5, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 6, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 7, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 8, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 9, state: 0, length: 1, value: &lt;Buffer 00&gt; }, { id: 10, state: 0, length: 14, value: &lt;Buffer 00 00 00 00 00 00 00 00 00 00 00 00 00 00&gt; } ] } bobaos&gt;</code> </pre> <br><p>  Values ‚Äã‚Äãare returned in an unconverted form, for conversion, you can use the knx-dpts-baos library, which supports types from dpt1 to dpt18. </p><br><p>  Set the value: </p><br><pre> <code class="bash hljs">bobaos&gt; setDatapointValue -s 2 -v 128 -t dpt5 { service: <span class="hljs-string"><span class="hljs-string">'SetDatapointValue.Res'</span></span>, direction: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 2, number: 0, payload: null } bobaos&gt; getDatapointValue -s 2 { service: <span class="hljs-string"><span class="hljs-string">'GetDatapointValue.Res'</span></span>, direction: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 2, number: 1, payload: [ { id: 2, state: 16, length: 1, value: &lt;Buffer 80&gt; } ] } bobaos&gt;</code> </pre> <br><p>  bobaos-cli can be used for quick testing, installation, reading data from the bus. </p><br><h2 id="ispolzovanie-v-prilozheniyah">  Application Use </h2><br><p>  Install the npm package: </p><br><pre> <code class="bash hljs">npm install --save bobaos</code> </pre> <br><p>  Add to our script: </p><br><pre> <code class="hljs pgsql"> const Baos = require(<span class="hljs-string"><span class="hljs-string">'bobaos'</span></span>); const app = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Baos({serialPort: {device: <span class="hljs-string"><span class="hljs-string">'/dev/ttyAMA0'</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>}); // send requests <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> successful initial <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> app.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, () =&gt; { app .getDatapointDescription(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) .getParameterByte(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) .readDatapointFromBus(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) // good .readDatapointFromBus(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) // error! .getDatapointValue(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) .setDatapointValue(<span class="hljs-number"><span class="hljs-number">2</span></span>, Buffer.alloc(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0xc0</span></span>)) .getDatapointValue(<span class="hljs-number"><span class="hljs-number">2</span></span>); }); // <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> incoming events <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> responses app.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'service'</span></span>, console.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>);</code> </pre> <br><p>  The output should look something like this: </p><br><pre> <code class="bash hljs">{ service: <span class="hljs-string"><span class="hljs-string">'GetParameterByte.Res'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 10, payload: &lt;Buffer 01 03 05 07 09 0b 0a 00 00 00&gt; } { service: <span class="hljs-string"><span class="hljs-string">'SetDatapointValue.Res'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 0, payload: null } { service: <span class="hljs-string"><span class="hljs-string">'GetDatapointValue.Res'</span></span>, error: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, start: 1, number: 1, payload: [ { id: 1, state: 4, length: 2, value: &lt;Buffer 0c fb&gt; } ] } .... ....</code> </pre> <br><p>  Now we have the right to experiment as we please, create any scripts, use the capabilities of nodejs, npm packages.  There is still a lot of work ahead, but a good start has been made, which pleases and motivates to continue further. </p><br><h2 id="ssylki">  Links </h2><br><ol><li>  <a href="https://github.com/shabunin/bobaos">Github repository</a> </li><li>  <a href="https://www.weinzierl.de/index.php/en/all-knx/knx-module-en/knx-baos-module-838-en">KNX BAOS Module 838 kBerry</a> .  Under the link you can see the information, download the application for ETS. </li><li>  <a href="https://www.weinzierl.de/images/download/development/830/KnxBAOS_Protocol_v2.pdf">Protocol Description</a> </li><li>  <a href="">Official installation documentation for the Raspberry Pi</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346680/">https://habr.com/ru/post/346680/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346666/index.html">ICO regulation. Estonia</a></li>
<li><a href="../346668/index.html">Networks and neighbors: methods of survival of machine learning in the ‚Äúwild‚Äù. Open Workshop AI @ MIPT</a></li>
<li><a href="../346670/index.html">Web components: review and use in production</a></li>
<li><a href="../346672/index.html">Single Sign-On, or Dancing Six</a></li>
<li><a href="../346676/index.html">Testing components with Puppeteer and Jest</a></li>
<li><a href="../346682/index.html">Digital events in Moscow from January 15 to 21</a></li>
<li><a href="../346684/index.html">Running in bags, blindfolded, back to front</a></li>
<li><a href="../346686/index.html">Projection modeling. Abstracts for beginners</a></li>
<li><a href="../346688/index.html">Anton Arnautov - about accelerators</a></li>
<li><a href="../346692/index.html">‚ÄúThe notion that this framework is outdated is wrong‚Äù: Andrey Gritsevich (Solar Security) about Ext JS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>