<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grab - python library for parsing sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About five or six years ago, when I was still programming mostly in PHP, I started using curl to parse websites. I needed a tool that allowed to emula...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grab - python library for parsing sites</h1><div class="post__text post__text-html js-mediator-article">  About five or six years ago, when I was still programming mostly in PHP, I started using curl to parse websites.  I needed a tool that allowed to emulate the user's session on the site, send the headers of a regular browser, give a convenient way to send POST requests.  At first I tried to use the curl extension directly, but its interface was very inconvenient and I wrote a wrapper with a simpler interface.  As time went on, I moved to python and ran into the same oak curl-extension API.  I had to rewrite the wrapper in python. <br><a name="habracut"></a><br><h4>  What is grab? </h4><br>  This is a library for parsing sites.  Its main functions are: <br><ul><li>  Preparing a network request (cookies, http headers, POST / GET data) </li><li>  Request to server (possible via HTTP / SOCKS proxy) </li><li>  Getting the server's response and its initial processing (header parsing, cookies parsing, document encoding definition, redirect processing (even a red refresh in the meta refresh tag is supported)) </li><li>  Working with the DOM response tree (if it is an HTML document) </li><li>  Working with forms (filling, auto-filling) </li><li>  Debugging: logging the process to the console, network requests and responses to files </li></ul><br><br>  Further I will tell about each item in more detail.  First, let's talk about initializing the work object and preparing a network request.  I will give an example of code that requests a page from Yandex and saves it to a file: <br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab(log_file=<span class="hljs-string"><span class="hljs-string">'out.html'</span></span>) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>)</code> </pre> <br>  In fact, the `log_file` parameter is intended for debugging - it indicates where to save the response body for further study.  But you can also use it to download the file. <br><br>  We saw how you can configure the Grab object - right in the constructor.  And here are some other variants of the same code: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = grab() &gt;&gt;&gt; g.setup(url=<span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>, log_file=<span class="hljs-string"><span class="hljs-string">'out.html'</span></span>) &gt;&gt;&gt; g.request()</code> </pre><br>  or <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>, log_file=<span class="hljs-string"><span class="hljs-string">'out.html'</span></span>)</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The shortest: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Grab(log_file=<span class="hljs-string"><span class="hljs-string">'out.html'</span></span>).go(<span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>)</code> </pre><br><br>  I summarize: you can set the configuration of Grab through the constructor, through the `setup` method or through the` go` and `request` methods.  In the case of the `go` method, the requested URL can be passed as a positional argument; in other cases, it must be passed as a named argument.  The difference between the `go` and` request` methods is that the `go` requires the required first parameter URL, while request does not require anything and uses the URL that we specified earlier. <br><br>  In addition to the `log_file` option, there is the` log_dir` option, which makes debugging a multi-step parser incredibly easy. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Grab &gt;&gt;&gt; logging.basicConfig(level=logging.DEBUG) &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.setup(log_dir=<span class="hljs-string"><span class="hljs-string">'log/grab'</span></span>) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>) DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">02</span></span>] GET http://yandex.ru &gt;&gt;&gt; g.setup(post={<span class="hljs-string"><span class="hljs-string">'hi'</span></span>: <span class="hljs-string"><span class="hljs-string">u', !'</span></span>}) &gt;&gt;&gt; g.request() DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">03</span></span>] POST http://yandex.ru</code> </pre><br><br>  See you  Each request received its own number.  The response to each request was recorded in the /tmp/tnome number.html file, a /tmp/trnome.log file was also created, in which the http-response headers were recorded.  And what does the above code do?  He goes to the main page of Yandex.  And then makes a meaningless POST request to the same page.  Please note that in the second request we do not specify the URL - by default, the url of the previous request is used. <br><br>  Let's take another debugging Grab setting. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.setup(debug=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://youporn.com'</span></span>) &gt;&gt;&gt; g.request_headers {<span class="hljs-string"><span class="hljs-string">'Accept-Language'</span></span>: <span class="hljs-string"><span class="hljs-string">'en-us;q=0.9,en,ru;q=0.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept-Encoding'</span></span>: <span class="hljs-string"><span class="hljs-string">'gzip'</span></span>, <span class="hljs-string"><span class="hljs-string">'Keep-Alive'</span></span>: <span class="hljs-string"><span class="hljs-string">'300'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.3'</span></span>, <span class="hljs-string"><span class="hljs-string">'User-Agent'</span></span>: <span class="hljs-string"><span class="hljs-string">'Mozilla/5.0 (Windows; U; Windows NT 5.1; en; rv:1.9.0.2) Gecko/2008091620 Firefox/3.0.2'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept-Charset'</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8,windows-1251;q=0.7,*;q=0.7'</span></span>, <span class="hljs-string"><span class="hljs-string">'Host'</span></span>: <span class="hljs-string"><span class="hljs-string">'www.youporn.com'</span></span>}</code> </pre><br><br>  We made a request to youporn.com.  The `debug` option enables memorization of outgoing requests.  If we are not sure about something, you can see what we sent to the server.  The attribute `request_headers` contains a dictionary with the keys and values ‚Äã‚Äãof the http request headers. <br><br>  Consider the basic capabilities for compiling queries. <br><br><h4>  HTTP request methods </h4><br>  POST request.  It's pretty simple.  In the `post` option, specify a dictionary with keys and values.  Grab will automatically change the type of request to POST. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.setup(post={<span class="hljs-string"><span class="hljs-string">'act'</span></span>: <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'redirec_url'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'captcha'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'login'</span></span>: <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-string"><span class="hljs-string">'123'</span></span>}) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru/ajax/auth/'</span></span>) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.xpath_text(<span class="hljs-string"><span class="hljs-string">'//error'</span></span>)   </code> </pre><br><br>  GET request.  If no explicit POST data or request method is specified, Grab will generate a GET request. <br><br>  PUT, DELETE, HEAD methods.  Theoretically, everything will work if you specify the option method = 'delete', method = 'put' or method = 'head'.  Practically, I have worked very little with these methods and am not sure about their efficiency. <br><br>  Important note about POST requests.  Grab is designed so that it saves all the specified options and uses them in the following requests.  The only option it does not save is the `post` option.  If he saved it, then in the following example you would send a POST request to the second URL, and this is hardly what you wanted: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g.setup(post={<span class="hljs-string"><span class="hljs-string">'login'</span></span>: <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-string"><span class="hljs-string">'123'</span></span>}) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://example.com/login'</span></span>) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://example.com/news/recent'</span></span>)</code> </pre><br><br><h4>  Configuring http headers </h4><br>  Now let's look at how you can customize the http headers to send.  Just set the headers dictionary with the `headers` option.  By default, Grab generates some headers to look more like a browser: Accept, Accept-Language, Accept-Charset, Keep-Alive.  You can also change them with the `headers` option: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.setup(headers={<span class="hljs-string"><span class="hljs-string">'Accept-Encoding'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://digg.com'</span></span>) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.response.headers.get(<span class="hljs-string"><span class="hljs-string">'Content-Encoding'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> &gt;&gt;&gt; g.setup(headers={<span class="hljs-string"><span class="hljs-string">'Accept-Encoding'</span></span>: <span class="hljs-string"><span class="hljs-string">'gzip'</span></span>}) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://digg.com'</span></span>) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.response.headers[<span class="hljs-string"><span class="hljs-string">'Content-Encoding'</span></span>] gzip</code> </pre><br><br><h4>  Work with cookies </h4><br>  By default, Grab saves the received cookies and sends them in the next request.  You get emulation of user sessions out of the box.  If you do not need this, disable the `reuse_cookies` option.  You can set cookies manually with the `cookies` option, it should contain a dictionary, the processing of which is similar to the processing of the data passed to the` post` option. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g.setup(cookies={<span class="hljs-string"><span class="hljs-string">'secureid'</span></span>: <span class="hljs-string"><span class="hljs-string">'234287a68s7df8asd6f'</span></span>})</code> </pre><br><br>  You can specify a file that should be used as a cookie storage, using the `cookiefile` option.  This will allow you to save cookies between program launches. <br><br>  At any time you can write cookies of the Grab object to the file using the `dump_cookies` method or download from the file using the` load_cookies` method.  To clear the Grab object's cookies, use the `clear_cookies` method. <br><br><h4>  User-Agent </h4><br>  By default, Grab is implemented as a real browser.  It has a list of different User-Agent strings, one of which is randomly selected when creating a Grab object.  Of course, you can set your User-Agent with the `user_agent` option. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Grab &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://whatsmyuseragent.com/'</span></span>) &gt;&gt;&gt; g.xpath(<span class="hljs-string"><span class="hljs-string">'//td[contains(./h3/text(), "Your User Agent")]'</span></span>).text_content() <span class="hljs-string"><span class="hljs-string">'The Elements of Your User Agent String Are:\nMozilla/5.0\r\nWindows\r\nU\r\nWindows\r\nNT\r\n5.1\r\nen\r\nrv\r\n1.9.0.1\r\nGecko/2008070208\r\nFirefox/3.0.1'</span></span> &gt;&gt;&gt; g.setup(user_agent=<span class="hljs-string"><span class="hljs-string">'Porn-Parser'</span></span>) &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://whatsmyuseragent.com/'</span></span>) &gt;&gt;&gt; g.xpath(<span class="hljs-string"><span class="hljs-string">'//td[contains(./h3/text(), "Your User Agent")]'</span></span>).text_content() <span class="hljs-string"><span class="hljs-string">'The Elements of Your User Agent String Are:\nPorn-Parser'</span></span></code> </pre><br><br><h4>  Work with a proxy server </h4><br>  Everything is trite.  In the `proxy` option, you need to pass the proxy address as‚Äú server: port ‚Äù, in the` proxy_type` option, we pass its type: ‚Äúhttp‚Äù, ‚Äúsocks4‚Äù or ‚Äúsocks5‚Äù If your proxies require authorization, use the option `proxy_userpwd`, meaning which has the form "user: password". <br>  The simplest search engine proxy servers based on Google search: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Grab, GrabError &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> quote &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://www.google.ru/search?num=100&amp;q='</span></span> + quote(<span class="hljs-string"><span class="hljs-string">'free proxy +":8080"'</span></span>)) &gt;&gt;&gt; rex = re.compile(<span class="hljs-string"><span class="hljs-string">r'(?:(?:[-a-z0-9]+\.)+)[a-z0-9]+:\d{2,4}'</span></span>) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> proxy <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rex.findall(g.drop_space(g.css_text(<span class="hljs-string"><span class="hljs-string">'body'</span></span>))): ... g.setup(proxy=proxy, proxy_type=<span class="hljs-string"><span class="hljs-string">'http'</span></span>, connect_timeout=<span class="hljs-number"><span class="hljs-number">5</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">5</span></span>) ... <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: ... g.go(<span class="hljs-string"><span class="hljs-string">'http://google.com'</span></span>) ... <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> GrabError: ... <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> proxy, <span class="hljs-string"><span class="hljs-string">'FAIL'</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: ... <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> proxy, <span class="hljs-string"><span class="hljs-string">'OK'</span></span> ... <span class="hljs-number"><span class="hljs-number">210.158</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.201</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> FAIL ... proxy2.com:<span class="hljs-number"><span class="hljs-number">80</span></span> OK ‚Ä¶. <span class="hljs-number"><span class="hljs-number">210.107</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.251</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> OK ‚Ä¶.</code> </pre><br><br><h4>  Work with answer </h4><br>  Let's say you made a network request using Grab.  What's next?  The `go` and` request` methods will return a Response object, which is also available through the `response` attribute of the Grab object.  You may be interested in the following attributes and methods of the Response object: code, body, headers, url, cookies, charset. <br><ul><li>  code - HTTP response code.  If the answer is different from the 200th, no exceptions will be generated, keep this in mind. </li><li>  body is the actual body of the response, excluding http headers </li><li>  headers - and these are headers in the dictionary </li><li>  url - may be different from the original, if there was a redirect </li><li>  cookies - cookies in the dictionary </li><li>  charset is the document encoding, is searched in the META tag of the document, also in the Content-Type http header of the response and the xml declaration of the XML documents. </li></ul><br><br>  The Grab object has a `response_unicode_body` method that returns the response body converted to unicode, note that HTML entities of the type" &amp; "are not converted to unicode counterparts. <br><br>  The response object of the last request is always stored in the attribute `response` of the Grab object. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://aport.ru'</span></span>) &gt;&gt;&gt; g.response.code <span class="hljs-number"><span class="hljs-number">200</span></span> &gt;&gt;&gt; g.response.cookies {<span class="hljs-string"><span class="hljs-string">'aportuid'</span></span>: <span class="hljs-string"><span class="hljs-string">'AAAAGU5gdfAAABRJAwMFAg=='</span></span>} &gt;&gt;&gt; g.response.headers[<span class="hljs-string"><span class="hljs-string">'Set-Cookie'</span></span>] <span class="hljs-string"><span class="hljs-string">'aportuid=AAAAGU5gdfAAABRJAwMFAg==; path=/; domain=.aport.ru; expires=Wed, 01-Sep-21 18:21:36 GMT'</span></span> &gt;&gt;&gt; g.response.charset <span class="hljs-string"><span class="hljs-string">'windows-1251'</span></span></code> </pre><br><br><h4>  Working with response text (grab.ext.text extension) </h4><br>  The `search` method allows you to set whether a given string is present in the response body, the` search_rex` method takes a regular expression object as a parameter.  The `assert_substring` and` assert_rex` methods generate a DataNotFound exception if the argument was not found.  Also in this extension are such convenient functions as `find_number - searches for the first numeric entry,` drop_space` - removes any whitespace characters, and `normalize_space` - replaces sequences of spaces with one space. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru'</span></span>) &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">u'Google'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">u''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">u''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">u''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">u''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">''</span></span>) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">""</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> File <span class="hljs-string"><span class="hljs-string">"grab/ext/text.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">37</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> search <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> GrabMisuseError(<span class="hljs-string"><span class="hljs-string">'The anchor should be byte string in non-byte mode'</span></span>) grab.grab.GrabMisuseError: The anchor should be byte string <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> non-byte mode &gt;&gt;&gt; g.search(<span class="hljs-string"><span class="hljs-string">''</span></span>, byte=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re &gt;&gt;&gt; g.search_rex(re.compile(<span class="hljs-string"><span class="hljs-string">'Google'</span></span>)) &lt;_sre.SRE_Match object at <span class="hljs-number"><span class="hljs-number">0xb6b0a6b0</span></span>&gt; &gt;&gt;&gt; g.search_rex(re.compile(<span class="hljs-string"><span class="hljs-string">'Google\s+\w+'</span></span>, re.U)) &lt;_sre.SRE_Match object at <span class="hljs-number"><span class="hljs-number">0xb6b0a6e8</span></span>&gt; &gt;&gt;&gt; g.search_rex(re.compile(<span class="hljs-string"><span class="hljs-string">'Google\s+\w+'</span></span>, re.U)).group(<span class="hljs-number"><span class="hljs-number">0</span></span>‚Äå) <span class="hljs-string"><span class="hljs-string">u'Google Chrome'</span></span> &gt;&gt;&gt; g.assert_substring(<span class="hljs-string"><span class="hljs-string">'  '</span></span>) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">""</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> File <span class="hljs-string"><span class="hljs-string">"grab/ext/text.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">62</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assert_substring <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.search(anchor, byte=byte): File <span class="hljs-string"><span class="hljs-string">"grab/ext/text.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">37</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> search <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> GrabMisuseError(<span class="hljs-string"><span class="hljs-string">'The anchor should be byte string in non-byte mode'</span></span>) grab.grab.GrabMisuseError: The anchor should be byte string <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> non-byte mode &gt;&gt;&gt; g.assert_substring(<span class="hljs-string"><span class="hljs-string">u'  '</span></span>) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">""</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> File <span class="hljs-string"><span class="hljs-string">"grab/ext/text.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assert_substring <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> DataNotFound(<span class="hljs-string"><span class="hljs-string">'Substring not found: %s'</span></span> % anchor) grab.grab.DataNotFound &gt;&gt;&gt; g.drop_spaces(<span class="hljs-string"><span class="hljs-string">'foo bar'</span></span>) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">""</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AttributeError: <span class="hljs-string"><span class="hljs-string">'Grab'</span></span> object has no attribute <span class="hljs-string"><span class="hljs-string">'drop_spaces'</span></span> &gt;&gt;&gt; g.drop_space(<span class="hljs-string"><span class="hljs-string">'foo bar'</span></span>) <span class="hljs-string"><span class="hljs-string">'foobar'</span></span> &gt;&gt;&gt; g.normalize_space(<span class="hljs-string"><span class="hljs-string">' foo \n \t bar'</span></span>) <span class="hljs-string"><span class="hljs-string">'foo bar'</span></span> &gt;&gt;&gt; g.find_number(<span class="hljs-string"><span class="hljs-string">'12    '</span></span>) <span class="hljs-string"><span class="hljs-string">'12'</span></span></code> </pre><br><br><h4>  Working with the DOM tree (grab.ext.lxml extension) </h4><br>  We approach the most interesting.  Thanks to the wonderful lxml library, Grab gives you the opportunity to work with xpath expressions to search for data.  Briefly, through the `tree` attribute, you can access a DOM tree with an ElementTree interface.  The tree is built using the lxml library parser.  You can work with the DOM tree using two query languages: xpath and css. <br><br>  Methods for working with xpath: <br><ul><li>  xpath - return the first element satisfying the query </li><li>  xpath_list - return all elements xpath_text - return the text content of the element (and all nested elements) </li><li>  xpath_number - return the first numeric occurrence from the text of the element (and all nested elements) </li></ul><br>  If the item was not found, then the `xpath`,` xpath_text` and `xpath_number` functions will generate a DataNotFound exception. <br><br>  The `css`,` css_list`, `css_text`, and` css_number` functions work in the same way, with one exception; the argument should not be the xpath path, but the css selector. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru'</span></span>) &gt;&gt;&gt; g.xpath(<span class="hljs-string"><span class="hljs-string">'//h2/a[@class="topic"]'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru/blogs/qt_software/127555/'</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.xpath_text(<span class="hljs-string"><span class="hljs-string">'//h2/a[@class="topic"]'</span></span>)  Qt Creator <span class="hljs-number"><span class="hljs-number">2.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>‚Äå &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.css_text(<span class="hljs-string"><span class="hljs-string">'h2 a.topic'</span></span>)  Qt Creator <span class="hljs-number"><span class="hljs-number">2.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>‚Äå &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'Comments:'</span></span>, g.css_number(<span class="hljs-string"><span class="hljs-string">'.comments .all'</span></span>) Comments: <span class="hljs-number"><span class="hljs-number">5</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urlparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlsplit &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">', '</span></span>.join(urlsplit(x.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>)).netloc <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> g.css_list(<span class="hljs-string"><span class="hljs-string">'.hentry a'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-string"><span class="hljs-string">'habrahabr.ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>).startswith(<span class="hljs-string"><span class="hljs-string">'http:'</span></span>)) labs.qt.nokia.com, labs.qt.nokia.com, thisismynext.com, www.htc.com, www.htc.com, droider.ru, radikal.ru, www.gosuslugi.ru, bit.ly</code> </pre><br><br><h4>  Forms (grab.ext.lxml_form extension) </h4><br>  When I implemented the auto-fill functionality, I was very pleased.  Look and you!  So, there are methods `set_input` - fills the field with the specified name,` set_input_by_id` - by the value of the id attribute, and `set_input_by_number` - just by number.  These methods work with a form that can be set by hand, but usually Grab guesses correctly what form you need to work with.  If the form is one, everything is clear, and if there are several?  Grab will take the form in which the most fields.  To manually set the form, use the `choose_form` method.  Method `submit` you can send the completed form.  Grab will build a POST / GET request for the fields that we have not explicitly filled out (for example, hidden fields), will calculate the action of the form and the method of the request.  There is also a method `form_fields` which returns all fields and form values ‚Äã‚Äãin the dictionary. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g.go(<span class="hljs-string"><span class="hljs-string">'http://ya.ru/'</span></span>) &gt;&gt;&gt; g.set_input(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">u' '</span></span>) &gt;&gt;&gt; g.submit() &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">', '</span></span>.join(x.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> g.css_list(<span class="hljs-string"><span class="hljs-string">'.b-serp-url__link'</span></span>)) http://gigporno.ru/, http://drochinehochu.ru/, http://porno.bllogs.ru/, http://www.pornoflv.net/, http://www.plombir.ru/, http://vuku.ru/, http://www.carol.ru/, http://www.Porno-Mama.ru/, http://kashtanka.com/, http://www.xvidon.ru/</code> </pre><br><br><h4>  Transports </h4><br>  By default, Grab uses pycurl for all network operations.  This functionality is also implemented in the form of expansion, and you can connect another transport extension, for example, for requests through the urllib2 library.  There is only one problem, you must first write this extension :) Works on the urllib2 extension are underway, but very slowly - I am 100% satisfied with pycurl.  I think the pycurl and urllib2 extensions will be similar in their capabilities, except that urllib2 does not know how to work with SOCKS proxies.  All the examples in this article use the pycurl transport, which is enabled by default. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>g = Grab() &gt;&gt;&gt; g.curl &lt;pycurl.Curl object at <span class="hljs-number"><span class="hljs-number">0x9d4ba04</span></span>&gt; &gt;&gt;&gt; g.extensions [&lt;grab.ext.pycurl.Extension object at <span class="hljs-number"><span class="hljs-number">0xb749056c</span></span>&gt;, &lt;grab.ext.lxml.Extension object at <span class="hljs-number"><span class="hljs-number">0xb749046c</span></span>&gt;, &lt;grab.ext.lxml_form.Extension object at <span class="hljs-number"><span class="hljs-number">0xb6de136c</span></span>&gt;, &lt;grab.ext.django.Extension object at <span class="hljs-number"><span class="hljs-number">0xb6a7e0ac</span></span>&gt;]</code> </pre><br><br><h4>  Hammer mode (hammer-mode) </h4><br>  This mode is enabled by default.  Grab has a timeout for each request.  In the hammer mode, in the case of a timeout, Grab does not immediately generate an exception, but tries several times to make a query with increasing timeouts.  This mode allows you to significantly increase the stability of the program.  micro-pauses in the work of sites or breaks in the channel are quite often.  To enable mode, use the `hammer_mode` option, to adjust the number and length of timeouts, use the` hammer_timeouts` option to which the list of numeric pairs should be transferred: the first number is the timeout for connecting to the server socket, the second number is the timeout for the entire operation, including getting an answer. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging &gt;&gt;&gt; logging.basicConfig(level=logging.DEBUG) &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.setup(hammer_mode=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, hammer_timeouts=((<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>))) &gt;&gt;&gt; URL = <span class="hljs-string"><span class="hljs-string">'http://download.wikimedia.org/enwiki/20110803/enwiki-20110803-stub-articles5.xml.gz'</span></span> &gt;&gt;&gt; g.go(URL, method=<span class="hljs-string"><span class="hljs-string">'head'</span></span>) DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">01</span></span>] HEAD http://download.wikimedia.org/enwiki/<span class="hljs-number"><span class="hljs-number">20110803</span></span>/enwiki<span class="hljs-number"><span class="hljs-number">-20110803</span></span>-stub-articles5.xml.gz &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'File size: %d Mb'</span></span> % (int(g.response.headers[<span class="hljs-string"><span class="hljs-string">'Content-Length'</span></span>]) / (<span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>)) File size: <span class="hljs-number"><span class="hljs-number">3</span></span> Mb &gt;&gt;&gt; g.go(URL, method=<span class="hljs-string"><span class="hljs-string">'get'</span></span>) DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">02</span></span>] GET http://download.wikimedia.org/enwiki/<span class="hljs-number"><span class="hljs-number">20110803</span></span>/enwiki<span class="hljs-number"><span class="hljs-number">-20110803</span></span>-stub-articles5.xml.gz DEBUG:grab:Trying another timeouts. Connect: <span class="hljs-number"><span class="hljs-number">2</span></span> sec., total: <span class="hljs-number"><span class="hljs-number">2</span></span> sec. DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">03</span></span>] GET http://download.wikimedia.org/enwiki/<span class="hljs-number"><span class="hljs-number">20110803</span></span>/enwiki<span class="hljs-number"><span class="hljs-number">-20110803</span></span>-stub-articles5.xml.gz DEBUG:grab:Trying another timeouts. Connect: <span class="hljs-number"><span class="hljs-number">30</span></span> sec., total: <span class="hljs-number"><span class="hljs-number">30</span></span> sec. DEBUG:grab:[<span class="hljs-number"><span class="hljs-number">04</span></span>] GET http://download.wikimedia.org/enwiki/<span class="hljs-number"><span class="hljs-number">20110803</span></span>/enwiki<span class="hljs-number"><span class="hljs-number">-20110803</span></span>-stub-articles5.xml.gz &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'Downloaded: %d Mb'</span></span> % (len(g.response.body) / (<span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>)) Downloaded: <span class="hljs-number"><span class="hljs-number">3</span></span> Mb</code> </pre><br><br><h4>  Django extension (grab.ext.django) </h4><br>  Yes Yes.  There is something like this :-) Suppose you have a Movie model with an ImageField field of `picture`.  Here's how to download a picture and save it to a Movie object. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>obj = Movie.objects.get(pk=<span class="hljs-number"><span class="hljs-number">797</span></span>) &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://img.yandex.net/i/www/logo.png'</span></span>) &gt;&gt;&gt; obj.picture = g.django_file() &gt;&gt;&gt; obj.save()</code> </pre><br><br><h4>  What else is in Grab? </h4><br>  There are other chips, but I am afraid that the article will be too big.  The main rule of the Grab library user is that if something is not clear, you need to look into the code.  Documentation is weak <br><br><h4>  Development plans </h4><br>  I have been using Grab for many years, including in production sites, such as the aggregator, where you can buy <a href="http://desconto.ru/">discount coupons</a> in Moscow and other cities.  In 2011, I started writing tests and documentation.  Maybe I'll write a functional for asynchronous requests based on multicurl.  It would also be nice to finish urllib-transport. <br><br>  How can I help the project?  Just use it, send bug reports and patches.  You can also order me to <a href="https://grablab.org/">write parsers, grabbers</a> , information processing scripts.  I regularly write these things using grab. <br><br>  Official project repository: <a href="http://bitbucket.org/lorien/grab">bitbucket.org/lorien/grab You</a> can also put the library from pypi.python.org, but usually the code is fresh in the repository. <br><br>  UPD: In comments sounded all sorts of alternatives to hornbeam.  I decided to summarize them with a list + something from my head.  In fact, alternatives to these car and small truck.  I think that every N-th programmer one day decides to bind himself a utility for network requests: <br><ul><li>  <a href="http://github.com/lispython/human_curl">github.com/lispython/human_curl</a> </li><li>  <a href="http://docs.python-requests.org/en/latest/index.html">docs.python-requests.org/en/latest/index.html</a> </li><li>  <a href="http://wwwsearch.sourceforge.net/mechanize/">wwwsearch.sourceforge.net/mechanize/</a> </li><li>  <a href="http://github.com/mattseh/python-web/">github.com/mattseh/python-web/</a> </li><li>  <a href="http://code.google.com/p/urllib3/">code.google.com/p/urllib3/</a> </li><li>  <a href="http://scrapy.org/">scrapy.org/</a> </li></ul><br><br>  UPD2: Please write your library questions to the google group: <a href="http://groups.google.com/group/python-grab/">groups.google.com/group/python-grab/</a> Other grab users will find it helpful to familiarize themselves with the questions and answers. <br><br>  UPD3: Current documentation is available at: <a href="http://docs.grablib.org/">docs.grablib.org/</a> <br><br>  UPD4: Current project site: <a href="http://grablib.org/">grablib.org</a> <br><br>  UPD5: Fixed source code examples in the article.  After another upgrade, Habrahabr, for reasons that were incomprehensible to me, did not correct the formatting of the code in old articles and it went everywhere.  Thanks to Alexey Mazanov for correcting the article.  He also wants to get on Habr, if you have an invite, his email is: egocentrist@me.com </div><p>Source: <a href="https://habr.com/ru/post/127584/">https://habr.com/ru/post/127584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127576/index.html">Intel Capital provided security system developer investments for smart devices</a></li>
<li><a href="../127579/index.html">Orchard CMS extension: packaging and publishing modules</a></li>
<li><a href="../127581/index.html">A look at Lenovo's Honeycomb tablets at IFA 2011</a></li>
<li><a href="../127582/index.html">AviSynth + VirtualDub: Extract Audio from the Command Line</a></li>
<li><a href="../127583/index.html">Programming Windows Phone 7. Lecture 1. Introduction</a></li>
<li><a href="../127585/index.html">Taxer - concluding a tax online agreement</a></li>
<li><a href="../127587/index.html">Idea 10.5.2 released</a></li>
<li><a href="../127588/index.html">Parser RSS to bash for Lostfilm: gentle mode for RSS server, check downloaded</a></li>
<li><a href="../127589/index.html">Canobuvosti, 107th edition</a></li>
<li><a href="../127590/index.html">OpenStreetMap News ‚Ññ7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>