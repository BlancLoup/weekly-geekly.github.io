<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I wrote a PeerJS (WebRTC) client for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had to write a client application on Android for a server that organized video communication between users using the PeerJS library. This ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I wrote a PeerJS (WebRTC) client for Android</h1><div class="post__text post__text-html js-mediator-article">  Recently, I had to write a client application on Android for a server that organized video communication between users using the <a href="http://peerjs.com/">PeerJS</a> library.  This library is an add-on for WebRTC, or something like that. <br><br>  He approached the matter with enthusiasm, as he had not done anything so complicated before. <br>  Naturally, the first step was the search for libraries, projects that implement such functionality. <br>  I found the <a href="https://code.google.com/p/webrtc/source/browse/">sample</a> WebRTC, but then I found a <a href="https://github.com/SDkie/Webrtc-for-Android">project</a> that implemented all of this simpler. <br><a name="habracut"></a><br>  I started to customize it, because the broker I use is peerjs. <br>  Changed javascript code when connecting and started catching error messages.  Not immediately, but I dare say that the thing is that the standard WebView (through which we execute the JavaScript code) does not support WebRTC. <br><br>  ‚ÄúHow to get around this problem‚Äù - I asked myself this question.  Long googled and found nothing sensible. <br>  I decided that it would be useful to dig into the PeerJS API and see how they implement everything. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I found several requests that the library sends, and which will be easy to reproduce, and also understand how peerjs connects clients.  Via WebSocket! <br><br>  After that, I came across a <a href="https://github.com/pchab/AndroidRTC">project</a> and it decided everything! <br>  Further I will result the code which finds room in one Activity. <br><br>  Well, first, you need to take the daddy libs from the last mentioned project and add yourself to the project. <br>  Next, create an Activity and add links to the objects that we will create later: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> factoryStaticInitialized; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GLSurfaceView surfaceView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VideoRenderer.Callbacks localRender; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VideoRenderer.Callbacks remoteRender; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VideoRenderer localRenderer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VideoSource videoSource; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VideoTrack videoTrack; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AudioTrack audioTrack; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MediaStream localMediaStream; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> videoSourceStopped; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initiator = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> video = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> audio = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebSocketClient client; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PeerConnectionFactory factory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PeerConnection peerConnection; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PCObserver pcObserver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PCObserver(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SDPObserver sdpObserver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SDPObserver(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MediaConstraints sdpMediaConstraints; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LinkedList&lt;PeerConnection.IceServer&gt; iceServers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;PeerConnection.IceServer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LinkedList&lt;IceCandidate&gt; queuedRemoteCandidates = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;IceCandidate&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Toast logToast; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Boolean[] quit = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Boolean[] { <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String token = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    ,       private String connectionId = "mc_"; //    ,    "mc_"</span></span></code> </pre> <br><br>  Create a GLSurfaceView in onCreate, in which we will display the video, and add it to some container: <br><pre> <code class="java hljs"> surfaceView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GLSurfaceView(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); surfaceView.setLayoutParams(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT)); LinearLayout content = (LinearLayout)findViewById(R.id.activity_webrtc_content); content.addView(surfaceView);</code> </pre><br><br>  Next, configure the video display locations: <br><pre> <code class="java hljs"> VideoRendererGui.setView(surfaceView); remoteRender = VideoRendererGui.create(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); localRender = VideoRendererGui.create(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>);</code> </pre><br>  Here we indicate that the resulting video will be displayed at 100% of the height and width of the surfaceView, and the video from our camera will be displayed in the lower left corner, indented to the left 1% of the width, 74% of the height to the right, and 25%. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!factoryStaticInitialized) { PeerConnectionFactory.initializeAndroidGlobals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); factoryStaticInitialized = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } audioManager = ((AudioManager) getSystemService(AUDIO_SERVICE)); <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"deprecation"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isWiredHeadsetOn = audioManager.isWiredHeadsetOn(); audioManager.setMode(isWiredHeadsetOn ? AudioManager.MODE_IN_CALL : AudioManager.MODE_IN_COMMUNICATION); audioManager.setSpeakerphoneOn(!isWiredHeadsetOn); sdpMediaConstraints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints(); sdpMediaConstraints.mandatory.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"OfferToReceiveAudio"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); sdpMediaConstraints.mandatory.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"OfferToReceiveVideo"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); iceServers.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeerConnection.IceServer(<span class="hljs-string"><span class="hljs-string">"stun:stun.l.google.com:19302"</span></span>)); createPC();</code> </pre><br>  initializeAndroidGlobals - and do not ask why this method.  I only know that without it, do not create a connection. <br>  iceServers - read more on the Internet.  Sometimes the video is not transmitted because you need to add more servers in the same way.  And on the server side, if you plan to communicate from the site too, you need to add iceServer. <br><br>  Next, we implement the createPC () method: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createPC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ factory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeerConnectionFactory(); MediaConstraints pcConstraints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints(); pcConstraints.mandatory.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"OfferToReceiveAudio"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); pcConstraints.mandatory.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"OfferToReceiveVideo"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); pcConstraints.optional.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"RtpDataChannels"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); pcConstraints.optional.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaConstraints.KeyValuePair(<span class="hljs-string"><span class="hljs-string">"DtlsSrtpKeyAgreement"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)); peerConnection = factory.createPeerConnection(iceServers, pcConstraints, pcObserver); <span class="hljs-comment"><span class="hljs-comment">//       createDataChannelToRegressionTestBug2302(peerConnection); //  -   logAndToast("Creating local video source..."); MediaConstraints videoConstraints = new MediaConstraints(); videoConstraints.mandatory.add(new MediaConstraints.KeyValuePair("maxHeight", "240")); videoConstraints.mandatory.add(new MediaConstraints.KeyValuePair("maxWidth", "320")); //       localMediaStream = factory.createLocalMediaStream("ARDAMS"); VideoCapturer capturer = getVideoCapturer(); videoSource = factory.createVideoSource(capturer, videoConstraints); videoTrack = factory.createVideoTrack("ARDAMSv0", videoSource); localRenderer = new VideoRenderer(localRender); videoTrack.addRenderer(localRenderer); //  ,     localMediaStream.addTrack(videoTrack); audioTrack = factory.createAudioTrack("ARDAMSa0", factory.createAudioSource(new MediaConstraints())); //     localMediaStream.addTrack(audioTrack); peerConnection.addStream(localMediaStream, new MediaConstraints()); GetID getId = new GetID(); try { getId.execute(); //  ,   http-   id   }catch (Exception e) { logAndToast("No Internet connection"); disconnectAndExit(); } }</span></span></code> </pre><br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetID</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt;</span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... params)</span></span></span><span class="hljs-function"> </span></span>{ NetHelper a = NetHelper.getInstance(RTCActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  http ,    id String result = a.executeHttpGet("http://0.peerjs.com:9000/" + roomKey + "/id?ts=" + Calendar.getInstance().getTimeInMillis() + ".7330598266421392"); // roomKey -  .      PeerJS    "lwjd5qra8257b9" // 7330598266421392 -   ,    id if (result==null) return null; result = result.replace("\n", ""); // id      ,     return result; } @Override protected void onPostExecute(String result) { super.onPostExecute(result); if (result==null) return; id = result; //  ,        WebSocketClient.Listener listener = new WebSocketClient.Listener() { @Override public void onMessage(byte[] arg0) { } @Override public void onMessage(final String data) { runOnUiThread(new Runnable() { public void run() { try { JSONObject json = new JSONObject(data); String type = (String) json.get("type"); if (type.equalsIgnoreCase("candidate")) { JSONObject jsonCandidate = json.getJSONObject("payload").getJSONObject("candidate"); IceCandidate candidate = new IceCandidate( (String) jsonCandidate.get("sdpMid"), jsonCandidate.getInt("sdpMLineIndex"), (String) jsonCandidate.get("candidate")); if (queuedRemoteCandidates != null) { queuedRemoteCandidates.add(candidate); } else { peerConnection.addIceCandidate(candidate); } } else if (type.equalsIgnoreCase("answer") || type.equalsIgnoreCase("offer")) { connectionId = json.getJSONObject("payload").getString("connectionId"); friendId = json.getString("src"); JSONObject jsonSdp = json.getJSONObject("payload").getJSONObject("sdp"); SessionDescription sdp = new SessionDescription( SessionDescription.Type.fromCanonicalForm(type), preferISAC((String) jsonSdp.get("sdp"))); peerConnection.setRemoteDescription(sdpObserver, sdp); } else if (type.equalsIgnoreCase("bye")) { logAndToast("Remote end hung up; dropping PeerConnection"); disconnectAndExit(); } else { //throw new RuntimeException("Unexpected message: " + data); } } catch (JSONException e) { //throw new RuntimeException(e); } } }); } @Override public void onError(Exception arg0) { runOnUiThread(new Runnable() { public void run() { disconnectAndExit(); } }); } @Override public void onDisconnect(int arg0, String arg1) { runOnUiThread(new Runnable() { public void run() { disconnectAndExit(); } }); } @Override public void onConnect() { //    runOnUiThread(new Runnable() { public void run() { if (initiator){ logAndToast("Creating offer..."); peerConnection.createOffer(sdpObserver, sdpMediaConstraints); } } }); } }; URI uri = null; try { //  URI  .   peerjs      uri = new URI("ws", "", "0.peerjs.com", 9000, "/peerjs", "key=" + roomKey + "&amp;id=" + id + "&amp;token=" + token, ""); // roomKey -  ,    // id -      id // token -    (     ) } catch (URISyntaxException e) { disconnectAndExit(); } client = new WebSocketClient(uri, listener, null); //    client.connect(); } }</span></span></code> </pre><br>  If you know the id (issued by the broker) of the user to which you want to connect, then in the socket's onConnect method, you need to create an offer. <br>  If not, then do nothing. <br><br>  the code from the socket listener must be executed in this method <br><pre> <code class="java hljs">runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } });</code> </pre><br><br>  In the onMessage (final String data) method we get the message.  It may be: <br>  - offer that another user sent to connect to us: <br>  - answer that was sent by the user to whom we sent an offer to connect to it: <br>  - Candidate - they contain information on iceServer.  We add them to our connection. <br><br>  I‚Äôll draw your attention to the fact that messages have a structure defined by peerjs, so other brokers will have to parse them differently. <br><br>  We implement this class: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PCObserver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PeerConnection</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Observer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onIceCandidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IceCandidate candidate)</span></span></span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ JSONObject json = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); JSONObject payload = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); JSONObject jsonCandidate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"CANDIDATE"</span></span>); jsonPut(jsonCandidate, <span class="hljs-string"><span class="hljs-string">"sdpMid"</span></span>, candidate.sdpMid); jsonPut(jsonCandidate, <span class="hljs-string"><span class="hljs-string">"sdpMLineIndex"</span></span>, candidate.sdpMLineIndex); jsonPut(jsonCandidate, <span class="hljs-string"><span class="hljs-string">"candidate"</span></span>, candidate.sdp); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"candidate"</span></span>, jsonCandidate); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"media"</span></span>); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"connectionId"</span></span>, connectionId); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"payload"</span></span>, payload); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"dst"</span></span>, friendId); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"src"</span></span>, id); sendMessage(json); } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ disconnectAndExit(); } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSignalingChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PeerConnection.SignalingState newState)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onIceConnectionChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PeerConnection.IceConnectionState newState)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onIceGatheringChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PeerConnection.IceGatheringState newState)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAddStream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MediaStream stream)</span></span></span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stream.videoTracks.size() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { stream.videoTracks.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).addRenderer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VideoRenderer(remoteRender)); } } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRemoveStream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MediaStream stream)</span></span></span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ stream.videoTracks.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).dispose(); } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataChannel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DataChannel dc)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRenegotiationNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br>  This class sends candidates to the second user and receives the incoming stream from video and audio. <br><br>  And one more class: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SDPObserver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SdpObserver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SessionDescription localSdp; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SessionDescription origSdp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SessionDescription sdp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionDescription(origSdp.type, preferISAC(origSdp.description)); localSdp = sdp; runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ peerConnection.setLocalDescription(sdpObserver, sdp); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendLocalDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logAndToast(<span class="hljs-string"><span class="hljs-string">"Sending "</span></span> + localSdp.type); JSONObject json = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); JSONObject payload = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); JSONObject sdp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"type"</span></span>, localSdp.type.canonicalForm().toUpperCase()); jsonPut(sdp, <span class="hljs-string"><span class="hljs-string">"sdp"</span></span>, localSdp.description); jsonPut(sdp, <span class="hljs-string"><span class="hljs-string">"type"</span></span>, localSdp.type.canonicalForm().toLowerCase()); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"sdp"</span></span>, sdp); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"media"</span></span>); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"connectionId"</span></span>, connectionId); jsonPut(payload, <span class="hljs-string"><span class="hljs-string">"browser"</span></span>, <span class="hljs-string"><span class="hljs-string">"Chrome"</span></span>); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"payload"</span></span>, payload); jsonPut(json, <span class="hljs-string"><span class="hljs-string">"dst"</span></span>, friendId); sendMessage(json); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSetSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (initiator) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peerConnection.getRemoteDescription() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { drainRemoteCandidates(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendLocalDescription(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peerConnection.getLocalDescription() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { logAndToast(<span class="hljs-string"><span class="hljs-string">"Creating answer"</span></span>); peerConnection.createAnswer(SDPObserver.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, sdpMediaConstraints); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendLocalDescription(); drainRemoteCandidates(); } } } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String error)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSetFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String error)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drainRemoteCandidates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (IceCandidate candidate : queuedRemoteCandidates) { peerConnection.addIceCandidate(candidate); } queuedRemoteCandidates = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br>  This class defines the SDP protocol settings by which information about iceServer and offer / answer is sent. <br>  Offer / Answer also sends this class in the sendLocalDescription () method.  Offer / Answer also have a specific peerjs structure. <br><br>  Also add some secondary methods: <br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">//        private VideoCapturer getVideoCapturer() { String[] cameraFacing = { "front", "back" }; int[] cameraIndex = { 0, 1 }; int[] cameraOrientation = { 0, 90, 180, 270 }; for (String facing : cameraFacing) { for (int index : cameraIndex) { for (int orientation : cameraOrientation) { String name = "Camera " + index + ", Facing " + facing + ", Orientation " + orientation; VideoCapturer capturer = VideoCapturer.create(name); if (capturer != null) { logAndToast("Using camera: " + name); return capturer; } } } } return null; } @Override protected void onDestroy() { disconnectAndExit(); super.onDestroy(); } private void logAndToast(String msg) { Log.d(TAG, msg); if (logToast != null) { logToast.cancel(); } logToast = Toast.makeText(this, msg, Toast.LENGTH_SHORT); logToast.show(); } private void sendMessage(JSONObject json) { client.send(json.toString()); //   } private static void jsonPut(JSONObject json, String key, Object value) { try { json.put(key, value); } catch (JSONException e) { } } //  ,     .   sdp- private static String preferISAC(String sdpDescription) { String[] lines = sdpDescription.split("\r\n"); int mLineIndex = -1; String isac16kRtpMap = null; Pattern isac16kPattern = Pattern.compile("^a=rtpmap:(\\d+) ISAC/16000[\r]?$"); for (int i = 0; (i &lt; lines.length) &amp;&amp; (mLineIndex == -1 || isac16kRtpMap == null); ++i) { if (lines[i].startsWith("m=audio ")) { mLineIndex = i; continue; } Matcher isac16kMatcher = isac16kPattern.matcher(lines[i]); if (isac16kMatcher.matches()) { isac16kRtpMap = isac16kMatcher.group(1); continue; } } if (mLineIndex == -1) { Log.d(TAG, "No m=audio line, so can't prefer iSAC"); return sdpDescription; } if (isac16kRtpMap == null) { Log.d(TAG, "No ISAC/16000 line, so can't prefer iSAC"); return sdpDescription; } String[] origMLineParts = lines[mLineIndex].split(" "); StringBuilder newMLine = new StringBuilder(); int origPartIndex = 0; newMLine.append(origMLineParts[origPartIndex++]).append(" "); newMLine.append(origMLineParts[origPartIndex++]).append(" "); newMLine.append(origMLineParts[origPartIndex++]).append(" "); newMLine.append(isac16kRtpMap); for (; origPartIndex &lt; origMLineParts.length; ++origPartIndex) { if (!origMLineParts[origPartIndex].equals(isac16kRtpMap)) { newMLine.append(" ").append(origMLineParts[origPartIndex]); } } lines[mLineIndex] = newMLine.toString(); StringBuilder newSdpDescription = new StringBuilder(); for (String line : lines) { newSdpDescription.append(line).append("\r\n"); } return newSdpDescription.toString(); } //      private void disconnectAndExit() { synchronized (quit[0]) { if (quit[0]) { return; } quit[0] = true; if (peerConnection != null) { peerConnection.dispose(); peerConnection = null; } if (client != null) { client.send("{\"type\": \"bye\"}"); client.disconnect(); client = null; } if (videoSource != null) { videoSource.dispose(); videoSource = null; } if (factory != null) { factory.dispose(); factory = null; } if (audioManager!=null) audioManager.abandonAudioFocus(audioFocusListener); finish(); } } @Override public void onStop() { disconnectAndExit(); super.onStop(); } @Override public void onPause() { super.onPause(); surfaceView.onPause(); if (videoSource != null) { videoSource.stop(); //    videoSourceStopped = true; } } @Override public void onResume() { super.onResume(); surfaceView.onResume(); if (videoSource != null &amp;&amp; videoSourceStopped) { videoSource.restart(); //    } } //   -  private static void createDataChannelToRegressionTestBug2302(PeerConnection pc) { DataChannel dc = pc.createDataChannel("dcLabel", new DataChannel.Init()); dc.close(); dc.dispose(); }</span></span></code> </pre><br><br>  We have the variable initiator.  By default, it is false.  It means whether you are calling someone or waiting for a call. <br>  I check in the asynchronous task the presence in the database on the server id of the user I'm calling.  If found, then it is connected to the broker.  I put initiator = true.  When the socket is connected, an offer will be created immediately and we will connect to the second user. <br>  If there is no user id, then we just wait.  When someone wants to call us, he should find out our id and send an offer. <br><br>  If you want to make buttons to turn off the transmission of video, audio, then the code will help you: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ImageView noVideo = (ImageView)findViewById(R.id.activity_webrtc_video); noVideo.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnClickListener(){ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (video){ noVideo.setImageResource(R.drawable.video_off); video = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; videoTrack.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ noVideo.setImageResource(R.drawable.video_on); video = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; videoTrack.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } }); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ImageView noAudio = (ImageView)findViewById(R.id.activity_webrtc_voice); noAudio.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnClickListener(){ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (audio){ noAudio.setImageResource(R.drawable.voice_off); audio = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; audioTrack.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ noAudio.setImageResource(R.drawable.voice_on); audio = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; audioTrack.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } });</code> </pre><br><br>  Well, of course, we add activity to the manifest and permissions: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.CAMERA"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.MODIFY_AUDIO_SETTINGS"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.RECORD_AUDIO"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera.autofocus"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:glEsVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0x00020000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  Well, that's all.  Please do not be offended at the confused story.  And the quality of the code does not aspire to the standard. <br><br>  I hope someone will come in handy. </div><p>Source: <a href="https://habr.com/ru/post/247079/">https://habr.com/ru/post/247079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247059/index.html">Drupal - choosing a business consultant</a></li>
<li><a href="../247071/index.html">Features and configuration of 3CX WebMeeting</a></li>
<li><a href="../247073/index.html">Expressive ReactJS or Type Angular features in our framework</a></li>
<li><a href="../247075/index.html">New Year's digest of Microsoft Azure</a></li>
<li><a href="../247077/index.html">Face recognition in 4 lines on jQuery</a></li>
<li><a href="../247081/index.html">Template specialization by base class</a></li>
<li><a href="../247083/index.html">5 ways to attract more customers using psychology</a></li>
<li><a href="../247085/index.html">Microsoft CloudOS Network - what is it?</a></li>
<li><a href="../247087/index.html">OpenStack Cloud: Myths and Reality</a></li>
<li><a href="../247089/index.html">How to choose key aspects of life in order to invest time and energy in them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>