<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of Nuclear NAT in FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are quite a few common variants of NAT under FreeBSD. This is also natd, ipnat, pfnat, ng_nat, or as an option ‚Äúbuy an ASA 5550 and don‚Äôt get it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of Nuclear NAT in FreeBSD</h1><div class="post__text post__text-html js-mediator-article"> There are quite a few common variants of NAT under FreeBSD.  This is also natd, ipnat, pfnat, ng_nat, or as an option ‚Äúbuy an ASA 5550 and don‚Äôt get it.‚Äù <br><img src="https://habrastorage.org/storage/habraeffect/b9/97/b99736548ba24d502fff01b96620615a.png"><br><br>  Unfortunately, recently I came across very few good and most importantly accessible articles on ipfw nat which appeared, if my memory serves me as early as 7.0. <br>  We will consider it under a magnifying glass today. <br><br>  True adherents of pf under kat are recommended not to drop in, so as not to injure yourself with excessive knowledge. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  <i>First, explain why ipfw nat</i> <br>  First, because I am a supporter of simple and obvious solutions, the support of which is possible almost at a glance without long meditations and reflections on the topic ‚Äúbut how does it work?  Ooh.  Unfortunately, I can not attribute to these non-trivial hybrids of the form ipfw + pfnat. <br>  Secondly, there are already quite a lot of documentation on ng_nat and pfnat (nat on intif from somenet to any -&gt; extif - Y?). <br>  Thirdly, I use ipfw, and I love it - for simplicity, clarity, predictability, dummynet and hybrids of the form ipfw + pf + altq ... in general, we look at ‚ÄúFirst‚Äù. <br><br>  <i>Materiel</i> <br>  We will consider ipfw nat on the example of a spherical horse-like network in vacuum depicted just above.  Actually, according to the scheme, everything is pretty clear - we will immediately make a reservation that we will network 172.16.0.0/21, the address hangs on em1, say 8.8.8.8 and the internal resources of the network to which we do not need to broadcast addresses - such as, for example, corporate <s>porn archives</s> mail servers and other necessary things will live with addresses, say 8.8.8.9, 8.8.8.10 <br>  The ipfw nat functionality almost completely duplicates the libalias functionality, which is also used by natd, ng_nat. <br>  If a very crude end in itself NAT server is reduced to replacing src-ip in packets that came to the internal interface (in our case em0) to the address of the outgoing interface (in our example em1) and entering data into its correspondence table for the inverse transformation upon the arrival of the necessary packets in reply.  Further, all the appropriately aligned packages fly away either by default or wherever you need (if, say, a PBR is freaked out). <br><br>  <i>Total in the base case, we need the following</i> <br><br>  Enumerate the kernel with ipfw, ipfw nat, libalias support <br><br> <code># cd /sys/i386/conf/ <br> # cp GENERIC NAT <br> # vim NAT <br></code> <br><br>  Then we insert something similar to this: <br><br> <code>ident NAT <br> options IPFIREWALL <br> options IPFIREWALL_DEFAULT_TO_ACCEPT <br> options IPFIREWALL_FORWARD <br> options IPFIREWALL_VERBOSE <br> options IPFIREWALL_VERBOSE_LIMIT=50 <br> options IPFIREWALL_NAT <br> options LIBALIAS <br> options ROUTETABLES=2 <br> options DUMMYNET <br> options HZ="1000" <br></code> <br><br>  We assemble and install a new core as a precautionary one. <br><br> <code># cp -R /boot/kernel /boot/good <br> # config NAT <br> # cd ../compile/NAT <br> # make depend <br> # make <br> # make install <br></code> <br><br>  Add to /etc/rc.conf <br> <code>firewall_enable="YES" <br> firewall_nat_enable="YES" <br> dummynet_enable="YES" <br> firewall_type="/etc/firewall" <br></code> <br><br>  As if it should hint that we will carry out the initialization of ipfw using the / etc / firewall that you want in the simplest case, to look like this: <br><br> <code>#        <br> table 2 add 172.16.0.0/21 <br> <br> #        nat <br> table 9 add 8.8.8.8 <br> table 9 add 8.8.8.9 <br> table 9 add 8.8.8.10 <br> <br> #      nat =) <br> nat 1 config log if em1 reset same_ports <br> add 1200 nat 1 ip from table\(2\) to not table\(9\) via em1 <br> add 1300 nat 1 ip from any to 8.8.8.8 via em1 <br></code> <br><br>  To calm your conscience you can do something else in /etc/sysctl.conf <br><br> <code>net.inet.ip.fw.one_pass=1 <br> net.inet.ip.fastforwarding=1 <br> net.inet.tcp.maxtcptw=40960 <br> kern.ipc.somaxconn=4096 <br> kern.ipc.nmbclusters=65536 <br> net.inet.tcp.nolocaltimewait=1 <br> net.inet.ip.portrange.randomized=0 <br></code> <br><br>  After the reboot everything should work.  It checks the performance of this all very simple method <br><br> <code>ipfw nat 1 show <br> nat 1: icmp=271, udp=45462, tcp=61534, sctp=0, pptp=0, proto=1, frag_id=2 frag_ptr=0 / tot=107270 <br></code> <br><br>  This is the scant statistics compared to pfctl ‚Äìsa, using the log parameter to collect ipfw nat. <br><br>  <i>Let's briefly run through the options with scant knowledge about which we can learn from man:</i> <br><br>  <b>if</b> - interface on which address translation will be performed <br>  <b>log</b> - includes logging of ‚Äúexhaustive‚Äù statistics on internal connections that we have already seen (ipfw nat1 show) <br>  <b>reset</b> - hints that the interface should be cleared when the interface is changed <br>  <b>deny_in</b> - prohibits passing packets from the outside for which no match was found in the internal table. <br>  <b>same_ports</b> - if possible, keep the original ports in outgoing packets (it is recommended to enable) <br>  <b>unreg_only</b> - to disguise only packets coming from <a href="http://www.faqs.org/rfcs/rfc1918.html">"unreal" networks</a> . <br>  <b>redirect_addr intip extip</b> - instructs to wrap traffic coming to extip to the machine with intip.  Similarly, the redirect_port and redirect_proto options work, which are useful for ‚Äúpushing‚Äù some machines with necessary services for NAT. <br><br>  Actually we can populate instances of nat as many as you like and on any interfaces / ip (ipfw nat 2 config log if em2 reset same_ports, for example) and wrap the traffic in them as we like. <br>  The memory that ipfw nat uses in its work is the memory available to the kernel and looks with <br> <code># sysctl -a | grep kmem <br> vm.kmem_size_scale: 3 <br> vm.kmem_size_max: 335544320 <br> vm.kmem_size_min: 0 <br> vm.kmem_size: 335544320 <br></code> <br><br>  To spin it using the KVA_PAGES kernel option (maximum 512, which corresponds to 2GB for i386). <br><br>  Somehow it is subjective, with a good load on the channel (I get out at&gt; 350-400Mbit / s), a periodic restart of the nat instance may be required, in order to free up the memory that is eaten by its labels.  I think the dog rummaged through the slow mechanism for shooting expired sessions.  Restart can be done with an elementary script like: <br><br> <code>#!/bin/sh <br> /sbin/ipfw nat 1 delete &amp;&amp; /sbin/ipfw nat 1 config log if em1 reset same_ports <br></code> <br><br>  Also, as everyone comes around, they step on the rake with the fact that libalias itself is categorically not friendly with the hardware checksum readers as well as with tcp segmentation offload, we initially recommend configuring cards in a similar way: <br><br> <code>cat /etc/rc.conf | grep ifconfig <br> ifconfig_em1="inet 8.8.8.8 netmask 255.255.255.0 -rxcsum -txcsum -tso" <br></code> <br><br>  That's all.  Everything works transparently, does not initially have diseases with services such as pptp, ftp (pfnat) and does not suffer from depressing sluggishness due to switching to user space (natd).  The only thing that can really be missed is the normal way to nat-it from under the address pool.  The only thing that comes to mind in this case is to spawn many instances on aliases, but it looks like it is not as beautiful as, say, pfnat. <br><br>  Somehow it turned out messy, but I hope visually. <br><br>  <b>On the topic of the next article, the question arises</b> - would it be interesting for someone to see a step-by-step guide on installing billing with traffic distribution on remote NAS and netflow accounting?  Well, actually, how are solutions freely scalable horizontally, unlike all that I described in previous articles?  Or write about something less narrowly specific? <br><br>  PS I was hinted that I had already used it in my examples under the guise of the ‚Äúreal‚Äù ipishki dns google.  Yes, I know about <a href="http://www.rfc-editor.org/rfc/rfc3330.txt">RFC3330</a> where it says that "192.0.2.0/24 is assigned as" TEST-NET ", but somehow I don‚Äôt know, it‚Äôs clearer for myself that you can do something :) </div><p>Source: <a href="https://habr.com/ru/post/102739/">https://habr.com/ru/post/102739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102728/index.html">GLONASS-GPS Navigator Presentation for Lada Cars</a></li>
<li><a href="../102729/index.html">About stereotypes</a></li>
<li><a href="../102733/index.html">Self-motivated team</a></li>
<li><a href="../102734/index.html">Presented color e-book</a></li>
<li><a href="../102737/index.html">Opening the blog of the PocketBook company</a></li>
<li><a href="../102740/index.html">NetBeans CSS Macros</a></li>
<li><a href="../102742/index.html">Celery - distributed task queue</a></li>
<li><a href="../102744/index.html">Korean Galaxy Tab Video Presentation</a></li>
<li><a href="../102745/index.html">Chiefs and how to live with them</a></li>
<li><a href="../102747/index.html">Pros and cons of working from home</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>