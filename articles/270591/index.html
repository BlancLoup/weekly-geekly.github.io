<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kaggle: determining the tonality of texts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 



 # {Data Science for newbies} 

 My name is Gleb Morozov, we are already familiar with the previous articles. Due to numerous requests, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kaggle: determining the tonality of texts</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br><img src="https://habrastorage.org/files/012/7ad/f21/0127adf21d9c410ca5777c78a92a7bf8.png"><br><br>  <b># {Data Science for newbies}</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My name is Gleb Morozov, we are already familiar with the previous articles.  Due to numerous requests, I continue to describe the experience of my participation in educational projects of <a href="http://dscourse.mlclass.ru/">MLClass.ru</a> (by the way, who have not had time - I recommend <a href="http://dscourse.mlclass.ru/">downloading the materials</a> while they are still available). <br><a name="habracut"></a><br><h3>  Data </h3><br>  The data for the work is provided as part of the Bag of Words competition held on the Kaggle website and represent a training sample of 25,000 reviews from the IMBD website, each of which relates to one of the classes: negative / positive.  The task is to predict to which of the classes each review from the test sample will apply. <br><br><pre><code class="hljs lisp">library(<span class="hljs-name"><span class="hljs-name">magrittr</span></span>) library(<span class="hljs-name"><span class="hljs-name">tm</span></span>) require(<span class="hljs-name"><span class="hljs-name">plyr</span></span>) require(<span class="hljs-name"><span class="hljs-name">dplyr</span></span>) library(<span class="hljs-name"><span class="hljs-name">ggplot2</span></span>) library(<span class="hljs-name"><span class="hljs-name">randomForest</span></span>)</code> </pre> <br>  Load the data into RAM. <br><br><pre> <code class="hljs pgsql">data_train &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.delim("labeledTrainData.tsv",<span class="hljs-keyword"><span class="hljs-keyword">header</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, sep = "\t", <span class="hljs-keyword"><span class="hljs-keyword">quote</span></span> = "", stringsAsFactors = F)</code> </pre><br>  The resulting table consists of three columns: id, sentiment and review.  It is the last column that is the object of our work.  Let's see what the review itself is.  (since the review is quite long, I will give only the first 700 characters) <br><br><pre> <code class="hljs perl">paste(<span class="hljs-keyword"><span class="hljs-keyword">substr</span></span>(data_train[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>],<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">700</span></span>),<span class="hljs-string"><span class="hljs-string">"..."</span></span>) <span class="hljs-comment"><span class="hljs-comment">## [1] "\"With all this stuff going down at the moment with MJ i've started listening to his music, watching the odd documentary here and there, watched The Wiz and watched Moonwalker again. Maybe i just want to get a certain insight into this guy who i thought was really cool in the eighties just to maybe make up my mind whether he is guilty or innocent. Moonwalker is part biography, part feature film which i remember going to see at the cinema when it was originally released. Some of it has subtle messages about MJ's feeling towards the press and also the obvious message of drugs are bad m'kay.&lt;br /&gt;&lt;br /&gt;Visually impressive but of course this is all about Michael Jackson so unless you remotely lik ..."</span></span></code> </pre><br>  It is seen that in the text there is garbage in the form of HTML tags. <br><br><h3>  Bag of Words </h3><br>  Bag of Words, or bag of words, is a model often used in word processing, which is an unordered set of words in the text being processed.  Often the model is presented in the form of a matrix, in which the lines correspond to a separate text, and the columns represent the words contained in it.  Cells at the intersection are the number of occurrences of the word in the corresponding document.  This model is convenient because it translates the human language of words into a computer-friendly language of numbers. <br><br><h4>  Data processing </h4><br>  For data processing, I will use the capabilities of the tm package.  In the following code block, the following actions are performed: <br><br><ul><li>  a vector is created from texts </li><li>  the corpus is created - a collection of texts </li><li>  all letters are in lower case </li><li>  punctuation marks are removed </li><li>  so-called "stop words" are deleted, since  Frequently encountered words in a language that do not carry information in themselves (in English, for example, and) In addition, I decided to immediately remove the word, which will most likely be found often in reviews, but is not of interest to the model - the movie. </li><li>  is stemming, i.e.  words are transformed into their basic form </li></ul><br><br><pre> <code class="hljs mel">train_corpus &lt;- data_train$review %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., <span class="hljs-keyword"><span class="hljs-keyword">tolower</span></span>) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeWords, c(<span class="hljs-string"><span class="hljs-string">"movie"</span></span>, stopwords(<span class="hljs-string"><span class="hljs-string">"english"</span></span>))) %&gt;% tm_map(., stemDocument)</code> </pre><br>  Now create a frequency matrix. <br><br><pre> <code class="hljs objectivec">frequencies &lt;- DocumentTermMatrix(train_corpus) frequencies <span class="hljs-meta"><span class="hljs-meta">## </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;DocumentTermMatrix (documents: 25000, terms: 92244)&gt;</span></span></span><span class="hljs-meta">&gt; ## Non-/sparse entries: 2387851/2303712149 ## Sparsity : 100% ## Maximal term length: 64 ## Weighting : term frequency (tf)</span></span></code> </pre><br>  Our matrix contains more than 90,000 terms, i.e.  the model based on it will contain 90000 signs!  It is necessary to reduce it and for this we use the fact that there are a lot of rarely found words in reviews, i.e.  it is discharged (sparse term).  I decided to cut it very much (in order for the model to fit in the RAM, taking into account 25,000 objects in the training set) and leave only those words that occur at least 5% of the reviews. <br><br><pre> <code class="hljs objectivec">sparse &lt;- removeSparseTerms(frequencies, <span class="hljs-number"><span class="hljs-number">0.95</span></span>) sparse <span class="hljs-meta"><span class="hljs-meta">## </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;DocumentTermMatrix (documents: 25000, terms: 373)&gt;</span></span></span><span class="hljs-meta">&gt; ## Non-/sparse entries: 1046871/8278129 ## Sparsity : 89% ## Maximal term length: 10 ## Weighting : term frequency (tf)</span></span></code> </pre><br>  As a result, 373 terms remained in the matrix.  Transform the matrix into the data frame and add a column with the target attribute. <br><br><pre> <code class="hljs php">reviewSparse = <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.data.frame(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.matrix(sparse)) vocab &lt;- names(reviewSparse) reviewSparse$sentiment &lt;- data_train$sentiment %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.factor(.) %&gt;% revalue(., c(<span class="hljs-string"><span class="hljs-string">"0"</span></span>=<span class="hljs-string"><span class="hljs-string">"neg"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span> = <span class="hljs-string"><span class="hljs-string">"pos"</span></span>)) row.names(reviewSparse) &lt;- <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span></code> </pre><br>  Now we will train the Random Forest model using the received data.  I use 100 trees due to memory limitation. <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">model_rf</span></span> &lt;- randomForest(sentiment ~ ., <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = reviewSparse, ntree = 100)</span></span></code> </pre><br>  Using the trained model we will create a forecast for test data. <br><br><pre> <code class="hljs pgsql">data_test &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.delim("testData.tsv", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, sep = "\t", <span class="hljs-keyword"><span class="hljs-keyword">quote</span></span> = "", stringsAsFactors = F) test_corpus &lt;- data_test$review %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., tolower) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeWords, c("movie", stopwords("english"))) %&gt;% tm_map(., stemDocument) test_frequencies &lt;- DocumentTermMatrix(test_corpus,control=list(<span class="hljs-keyword"><span class="hljs-keyword">dictionary</span></span> = vocab)) reviewSparse_test &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.data.frame(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.matrix(test_frequencies)) <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.names(reviewSparse_test) &lt;- <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> sentiment_test &lt;- predict(model_rf, newdata = reviewSparse_test) pred_test &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.data.frame(cbind(data_test$id, sentiment_test)) colnames(pred_test) &lt;- c("id", "sentiment") pred_test$sentiment %&lt;&gt;% revalue(., c("1"="0", "2" = "1")) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>.csv(pred_test, file="Submission.csv", <span class="hljs-keyword"><span class="hljs-keyword">quote</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.names=<span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>)</code> </pre><br>  After downloading and evaluation on the Kaggle website, the model received an estimate of AUC statistics - 0.73184. <br><br>  Let's try to approach the problem from the other side.  When compiling the frequency matrix and cutting it, we leave the most common words, but, most likely, many words that are often found in movie reviews, but do not reflect the mood of the review.  For example, words like movie, film, etc.  But, since  we have a training sample with a marked mood of the reviews, we can distinguish words whose frequencies differ significantly from negative and positive reviews. <br><br>  To begin with, we will create a frequency matrix for negative reviews. <br><br><pre> <code class="hljs mel">freq_neg &lt;- data_train %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(sentiment == <span class="hljs-number"><span class="hljs-number">0</span></span>) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(review) %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., <span class="hljs-keyword"><span class="hljs-keyword">tolower</span></span>) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeNumbers) %&gt;% tm_map(., removeWords, c(stopwords(<span class="hljs-string"><span class="hljs-string">"english"</span></span>))) %&gt;% tm_map(., stemDocument) %&gt;% DocumentTermMatrix(.) %&gt;% removeSparseTerms(., <span class="hljs-number"><span class="hljs-number">0.999</span></span>) %&gt;% as.<span class="hljs-keyword"><span class="hljs-keyword">matrix</span></span>(.) freq_df_neg &lt;- colSums(freq_neg) freq_df_neg &lt;- data.frame(word = names(freq_df_neg), freq = freq_df_neg) rownames(freq_df_neg) &lt;- NULL head(arrange(freq_df_neg, desc(freq))) ## word freq ## <span class="hljs-number"><span class="hljs-number">1</span></span> movi <span class="hljs-number"><span class="hljs-number">27800</span></span> ## <span class="hljs-number"><span class="hljs-number">2</span></span> film <span class="hljs-number"><span class="hljs-number">21900</span></span> ## <span class="hljs-number"><span class="hljs-number">3</span></span> one <span class="hljs-number"><span class="hljs-number">12959</span></span> ## <span class="hljs-number"><span class="hljs-number">4</span></span> like <span class="hljs-number"><span class="hljs-number">12001</span></span> ## <span class="hljs-number"><span class="hljs-number">5</span></span> just <span class="hljs-number"><span class="hljs-number">10539</span></span> ## <span class="hljs-number"><span class="hljs-number">6</span></span> make <span class="hljs-number"><span class="hljs-number">7846</span></span></code> </pre><br>  And for positive reviews. <br><br><pre> <code class="hljs mel">freq_pos &lt;- data_train %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(sentiment == <span class="hljs-number"><span class="hljs-number">1</span></span>) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(review) %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., <span class="hljs-keyword"><span class="hljs-keyword">tolower</span></span>) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeNumbers) %&gt;% tm_map(., removeWords, c(stopwords(<span class="hljs-string"><span class="hljs-string">"english"</span></span>))) %&gt;% tm_map(., stemDocument) %&gt;% DocumentTermMatrix(.) %&gt;% removeSparseTerms(., <span class="hljs-number"><span class="hljs-number">0.999</span></span>) %&gt;% as.<span class="hljs-keyword"><span class="hljs-keyword">matrix</span></span>(.) freq_df_pos &lt;- colSums(freq_pos) freq_df_pos &lt;- data.frame(word = names(freq_df_pos), freq = freq_df_pos) rownames(freq_df_pos) &lt;- NULL head(arrange(freq_df_pos, desc(freq))) ## word freq ## <span class="hljs-number"><span class="hljs-number">1</span></span> film <span class="hljs-number"><span class="hljs-number">24398</span></span> ## <span class="hljs-number"><span class="hljs-number">2</span></span> movi <span class="hljs-number"><span class="hljs-number">21796</span></span> ## <span class="hljs-number"><span class="hljs-number">3</span></span> one <span class="hljs-number"><span class="hljs-number">13706</span></span> ## <span class="hljs-number"><span class="hljs-number">4</span></span> like <span class="hljs-number"><span class="hljs-number">10138</span></span> ## <span class="hljs-number"><span class="hljs-number">5</span></span> time <span class="hljs-number"><span class="hljs-number">7889</span></span> ## <span class="hljs-number"><span class="hljs-number">6</span></span> good <span class="hljs-number"><span class="hljs-number">7508</span></span></code> </pre><br>  Let us combine the resulting tables and calculate the difference between the frequencies. <br><br><pre> <code class="hljs perl">freq_all &lt;- merge(freq_df_neg, freq_df_pos, by = <span class="hljs-string"><span class="hljs-string">"word"</span></span>, all = T) freq_all$freq.x[is.na(freq_all$freq.x)] &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> freq_all$freq.y[is.na(freq_all$freq.y)] &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> freq_all$diff &lt;- <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(freq_all$freq.x - freq_all$freq.y) head(arrange(freq_all, desc(diff))) <span class="hljs-comment"><span class="hljs-comment">## word freq.x freq.y diff ## 1 movi 27800 21796 6004 ## 2 bad 7660 1931 5729 ## 3 great 2692 6459 3767 ## 4 just 10539 7109 3430 ## 5 love 2767 5988 3221 ## 6 even 7707 5056 2651</span></span></code> </pre><br>  Fine!  We see, as expected, among the words with the greatest difference such terms as <b>bad</b> , <b>great</b> and <b>love</b> .  But also here are just common words like <b>movie</b> .  It happened that in frequent words, even a small percentage difference gives a high absolute difference.  In order to eliminate this omission, we normalize the difference by dividing it by the sum of frequencies.  The resulting metric will lie between <b>0</b> and <b>1</b> , and the higher its value is, the more important this value is in determining the difference between positive and negative feedback.  But what to do with words that are found only in one class of reviews and at the same time their frequency is small?  To reduce their importance, we add a coefficient to the denominator. <br><br><pre> <code class="hljs perl">freq_all$diff_norm &lt;- <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(freq_all$freq.x - freq_all$freq.y)/ (freq_all$freq.x +freq_all$freq.y + <span class="hljs-number"><span class="hljs-number">300</span></span>) head(arrange(freq_all, desc(diff_norm))) <span class="hljs-comment"><span class="hljs-comment">## word freq.x freq.y diff diff_norm ## 1 worst 2436 246 2190 0.7344064 ## 2 wast 1996 192 1804 0.7250804 ## 3 horribl 1189 194 995 0.5912062 ## 4 stupid 1525 293 1232 0.5816808 ## 5 bad 7660 1931 5729 0.5792134 ## 6 wors 1183 207 976 0.5775148</span></span></code> </pre><br>  Select the 500 words with the highest difference coefficient. <br><br><pre> <code class="hljs pgsql">freq_word &lt;- arrange(freq_all, <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>(diff_norm)) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(word) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">500</span></span>)</code> </pre><br>  We use the resulting dictionary to create a frequency matrix on which we will train the Random Forest model. <br><br><pre> <code class="hljs php">vocab &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(freq_word$word) frequencies = DocumentTermMatrix(train_corpus,control=<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>(dictionary = vocab)) reviewSparse_train &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.data.frame(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.matrix(frequencies)) row.names(reviewSparse_train) &lt;- <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> reviewSparse_train$sentiment &lt;- data_train$sentiment %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.factor(.) %&gt;% revalue(., c(<span class="hljs-string"><span class="hljs-string">"0"</span></span>=<span class="hljs-string"><span class="hljs-string">"neg"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span> = <span class="hljs-string"><span class="hljs-string">"pos"</span></span>)) model_rf &lt;- randomForest(sentiment ~ ., data = reviewSparse_train, ntree = <span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br>  After downloading and evaluation on the Kaggle website, the model received an estimate according to AUC statistics - 0.83120, i.e.  After working with the signs, we got a 10% improvement in statistics! <br><br><h4>  TF-IDF </h4><br>  When creating the matrix, the document term as a metric of the importance of the word, we simply used the frequency of the word in the review.  The <b>tm</b> package has the ability to use another measure called <b>tf-idf</b> .  <b>TF-IDF</b> (from <b>TF - term frequency, IDF - inverse document frequency</b> ) is a statistical metric used to assess the importance of a word in the context of a document that is part of a document collection or corpus.  The weight of a word is proportional to the number of words used in the document, and inversely proportional to the frequency of words in other documents in the collection. <br><br>  Using <b>tf-idf</b> , we will create a dictionary of <b>500</b> terms with the highest indicator of this metric.  In order for this dictionary to reflect the importance of words most relevantly, we will use an additional training sample in which the mood of the reviews is not marked.  On the basis of the dictionary, create a matrix of the document-term and train the model. <br><br><pre> <code class="hljs mel">data_train_un &lt;- read.delim(<span class="hljs-string"><span class="hljs-string">"unlabeledTrainData.tsv"</span></span>,header = TRUE, sep = <span class="hljs-string"><span class="hljs-string">"\t"</span></span>, quote = <span class="hljs-string"><span class="hljs-string">""</span></span>, stringsAsFactors = F) train_review &lt;- c(data_train$review, data_train_un$review) train_corpus &lt;- train_review %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., <span class="hljs-keyword"><span class="hljs-keyword">tolower</span></span>) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeNumbers) %&gt;% tm_map(., removeWords, c(stopwords(<span class="hljs-string"><span class="hljs-string">"english"</span></span>))) %&gt;% tm_map(., stemDocument) tdm &lt;- TermDocumentMatrix(train_corpus, <span class="hljs-keyword"><span class="hljs-keyword">control</span></span> = list(weighting = function(x) weightTfIdf(x, <span class="hljs-keyword"><span class="hljs-keyword">normalize</span></span> = F))) library(slam) freq &lt;- rollup(tdm, <span class="hljs-number"><span class="hljs-number">2</span></span>,FUN = sum) freq &lt;- as.<span class="hljs-keyword"><span class="hljs-keyword">matrix</span></span>(freq) freq_df &lt;- data.frame(word = row.names(freq), tfidf = freq) names(freq_df) &lt;- c(<span class="hljs-string"><span class="hljs-string">"word"</span></span>, <span class="hljs-string"><span class="hljs-string">"tf_idf"</span></span>) row.names(freq_df) &lt;- NULL freq_df %&lt;&gt;% arrange(desc(tf_idf)) vocab &lt;- as.<span class="hljs-keyword"><span class="hljs-keyword">character</span></span>(freq_df$word)[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">500</span></span>] train_corpus &lt;- data_train$review %&gt;% VectorSource(.)%&gt;% Corpus(.) %&gt;% tm_map(., <span class="hljs-keyword"><span class="hljs-keyword">tolower</span></span>) %&gt;% tm_map(., PlainTextDocument) %&gt;% tm_map(., removePunctuation) %&gt;% tm_map(., removeNumbers) %&gt;% tm_map(., removeWords, c(stopwords(<span class="hljs-string"><span class="hljs-string">"english"</span></span>))) %&gt;% tm_map(., stemDocument) frequencies = DocumentTermMatrix(train_corpus,<span class="hljs-keyword"><span class="hljs-keyword">control</span></span>=list(dictionary = vocab, weighting = function(x) weightTfIdf(x, <span class="hljs-keyword"><span class="hljs-keyword">normalize</span></span> = F) )) reviewSparse_train &lt;- as.data.frame(as.<span class="hljs-keyword"><span class="hljs-keyword">matrix</span></span>(frequencies)) rm(data_train_un, tdm, dtm, train_review) reviewSparse_train &lt;- as.data.frame(as.<span class="hljs-keyword"><span class="hljs-keyword">matrix</span></span>(frequencies)) row.names(reviewSparse_train) &lt;- NULL colnames(reviewSparse_train) = make.names(colnames(reviewSparse_train)) reviewSparse_train$sentiment &lt;- data_train$sentiment %&gt;% as.factor(.) %&gt;% revalue(., c(<span class="hljs-string"><span class="hljs-string">"0"</span></span>=<span class="hljs-string"><span class="hljs-string">"neg"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span> = <span class="hljs-string"><span class="hljs-string">"pos"</span></span>)) rm(data_train, train_corpus, freq, freq_df) model_rf &lt;- randomForest(sentiment ~ ., data = reviewSparse_train, ntree = <span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br><br>  We use this model on a test sample and get the value of <b>AUC - 0.81584</b> . <br><br><h3>  Conclusion </h3><br>  This work is one of the possible options for creating a predictive model based on text data.  One option to improve the quality of the model may be an increase in the number of terms used from the document-term matrix, but this way requires a significant increase in the used machine resources.  It can also lead to much better results to refer not to the frequencies of words, but to their meanings and the connections between them.  To do this, refer to the <b>word2vec</b> model.  In addition, a large field for research is the consideration of terms in the context of the document. </div><p>Source: <a href="https://habr.com/ru/post/270591/">https://habr.com/ru/post/270591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270581/index.html">The Linux Piter conference program has been published.</a></li>
<li><a href="../270583/index.html">Highload Dev Conf'2015 was held on October 17 in Minsk</a></li>
<li><a href="../270585/index.html">Webinar: Kerio Control - Monitoring and Statistics</a></li>
<li><a href="../270587/index.html">How MTT leaked its customer base</a></li>
<li><a href="../270589/index.html">A selection of free tools for developers</a></li>
<li><a href="../270593/index.html">WebPack: how does Hot Reloading work inside</a></li>
<li><a href="../270597/index.html">Conference KazooCon 2015 - how it was</a></li>
<li><a href="../270599/index.html">The worm that changed the Internet</a></li>
<li><a href="../270601/index.html">Digest KolibriOS # 10: briefly about the accumulated</a></li>
<li><a href="../270603/index.html">Fast closing tabs in the assembly Vivaldi 1.0.321.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>