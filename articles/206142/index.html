<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arcanum and Fallout 2 with touch screen and stylus in Windows 8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow it happened that I got a Windows 8 tablet. Not a very successful model - cumbersome as an assistant, rather weak as a workstation, but with a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arcanum and Fallout 2 with touch screen and stylus in Windows 8</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a2c/470/fde/a2c470fdecb2bcad12a185d3c30187d1.jpg" align="right">  Somehow it happened that I got a Windows 8 tablet.  Not a very successful model - cumbersome as an assistant, rather weak as a workstation, but with a stylus, and most importantly, with a 32-bit Win32 system.  Having a certain number of old games from sales of GOG and Steam, I planned to somehow sit down with this tablet and replay everything that can and cannot be.  But somehow there was not enough time and mood, and even test launches showed that you need to play with the mouse - the cursor from the touch-screen ran off unknown where, and even a right click with a long press would be frankly inconvenient.  The tablet was gathering dust for half a year in a corner before the recent <a href="http://habrahabr.ru/post/205838/">distribution of</a> Fallout from GOG and this distribution pushed me to action.  Friday night began, the tablet got a USB mouse, and I got comfortable on the couch and started on the list from the very top - with Arcanum. <br>  After half an hour of creating a character (and this is a very important and responsible business!), The left hand barely held the device, and the right wrist suspiciously began to pull, hinting about tunnel syndrome and other pleasures of an uncomfortable grip.  Remembering <s>not the</s> good word of the developers of some ergonomic folding mouse, I climbed to look for drivers, patches, or at least something to play with the touchscreen, or at least the stylus. <br>  There were no patches.  The only similar driver was paid and without trial mode.  It was at this moment that an idiotic (I now understand!) Thought came to my mind - ‚Äúafter all, some WM_TOUCH comes after all and is incorrectly converted to WM_MOUSEMOVE‚Äù ... Looking ahead, Arkanum now completely controls my touchscreen, though the weekend is over and more like to sleep than to play. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">For impatient</b> <div class="spoiler_text">  The project is available on <a href="https://github.com/Nomad1/touchmouse">github</a> , there are source codes and a binary.  This is a DLL file that should be used as a launcher for playing through rundll32.  Pressing with two fingers makes a right click, pressing with three fingers imitates the ESC key - this is enough for Arcanum.  Fallout 2 is supported in beta mode, the instruction is in the same place on github.  Right-click does not work there, the cursor is occasionally shifted, but this can be corrected by dragging it to the lower left corner of the screen. </div></div><br><br><h3>  Visual studio 6.0 </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/1e2/059/2ac/1e20592accf51fa7f6043dcc98a0a27b.png" align="right">  Somehow it happened that I was sick a dozen years ago by the hooks, patches and injections for Win32 and then with great pleasure I closed this page in my life.  And now, dreaming of ‚Äúhalf an hour to get to bed and then play,‚Äù I took out the old hard drive, wrote off a couple of projects and my favorite tool - VS98, also known as Visual Studio 6.0.  Yes, I constantly use VS 2012 for W8 and WP mobile programs, but, I confess, I have no idea what the Platform SDK looks like in it now, and whether something like coding low-level things in C # or C ++ has become fashionable / mandatory / CLI.  And then it turned out that VS98, with its weight of 120 megabytes at the same time, works fine under wine on my working machine. <br>  Cleaning up old projects from tin, like IAT's substitution, was dragged out, but after a couple of hours I introduced my module into the game and could track its message flow (subclassing via SetWindowLong and blah blah blah).  Spy ++, for obvious reasons, did not want to work with a full-screen game, because I wrote logs and then studied everything that looked like a mouse and a touch.  On this Friday night ended and I postponed the continuation in the morning. <br><br><h3>  WM_TOUCH </h3><br>  In the morning I looked through a couple of articles about working with a touchscreen and sat down to catch WM_TOUCH.  An excellent message comes regularly, although it contains in one block a dozen or two taps.  It was interesting that the coordinates in the game came correct - they exactly corresponded to the place of pressing on the screen.  This did not seem to matter, because I began to generate WM_MOUSEMOVE for each event.  The result was surprised - nothing has changed.  Nothing at all.  Replaced WM_MOUSEMOVE with SetCursorPos and did see the result - crawling the cursor became noticeably less chaotic.  It seemed that the matter was in a hat - you <i>just</i> need <i>to</i> understand what is going wrong and why the cursor shifts towards each time ... Only when it got dark on the street, I realized that something went wrong :) All logical and non-logical methods formulas, adjustments of coordinates, witchcraft with mouse_event, SendInput, cancellation of certain events - in no case could I get the cursor to move to the place of the click.  It seemed to be nonsense or mysticism, but somewhere inside the game there was an own pair of coordinates, which was changed in a way that was not clear to me and was not controlled directly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  DirectInput and all-all </h3><br>  On Sunday I woke up demotivated, but still with reliable.  Today I wanted to try to repeat everything that comes from a real mouse, but with touchscreen data.  I hooked up the rodent and started tracking its actions, and then it turned out that mouse actions do not go through my window procedure at all.  Calling myself an ass, not knowing the realities of the games, I dug into Google and found what confused me: Often games get information about the mouse either through DirectInput or in raw form, bypassing the Window Message Queue.  Touchscreen and stylus events are the exception - they go through the message queue and somewhere in the depths of DefWindowProc turn into mouse actions.  Accordingly, WM_MOUSEMOVE and others like it may be absent altogether (and this is what happens for the mouse) and the attempt to send them, substitution, etc., does not affect the game in any way.  Literally, two-thirds of my experiments were simply ignored by the game, and the rest were in conflict with DefWindowProc.  Moreover, WM_TOUCH was sent only for compatibility with Windows 7 programs, and the main touch events in Windows 8 are already considered WM_POINTER *. <br><br><h3>  Accident or fishing? </h3><br>  At this stage, I already knew what I needed and saw the light at the end of the tunnel - I will not allow DefWindowProc to handle touchscreen events at all and will do everything myself.  Emotional uplifting did its job, and at some point suddenly the touchscreen began to put the cursor exactly at the place of depression.  It was strange, because the interception module was not yet ready.  The search for the dichotomy of the desired area (we turn off half the program and look at the behavior, then either return back or turn off half the remaining code) showed that I simultaneously caused <pre><code class="hljs lisp">RegisterTouchWindow(<span class="hljs-name"><span class="hljs-name">hWnd</span></span>, TWF_WANTPALM)</code> </pre>  and <pre> <code class="hljs lisp">SetProp(<span class="hljs-name"><span class="hljs-name">hWnd</span></span>, <span class="hljs-string"><span class="hljs-string">"MicrosoftTabletPenServiceProperty"</span></span>, (<span class="hljs-name"><span class="hljs-name">HANDLE</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  <i>* Despite the idiotic appearance and meaning of the last command, it is quite correct and <a href="http://msdn.microsoft.com/en-us/library/ms812373.aspx">documented</a> , albeit for the Tablet PC of the 2003 year.</i> <br>  Calling these two methods leads to the fact that in WM_TOUCH we get only one coordinate at a time, and the internals of DefWindowProc generate relatively correct coordinates.  But the point is that usually WM_TOUCH is not sent immediately when pressed, but accumulates data for the ‚Äúpress and hold‚Äù feature.  That is characteristic, colleagues already once <a href="http://mollyrocket.com/forums/viewtopic.php%3Fp%3D7496">faced</a> a similar situation: <br><blockquote>  <i>At the end of four days of futility, I gave up and did two things.</i>  <i>First, I‚Äôm looking at what I‚Äôm not really using the word although fuck ‚Äô.</i> <i><br></i>  <i>(...)</i> <i><br></i>  <i>Thankfully, my surprise was actually answered by my forum post.</i>  <i>I‚Äôm on the screen, and I‚Äôm not sure what I‚Äôve wanted to write on.</i>  <i>TabletPC disables press and hold for your window.</i> <i><br></i>  <i>(...)</i> <i><br></i>  <i>It has been the case for the TabletPC SDK.</i>  <i>Or, ‚Äúpress and hold‚Äù was (since it would have been a funeral)</i> </blockquote><br>  It was still not a complete solution, but still a huge progress!  Actually, it was in this mode that Fallout 2 became playable, although it rarely loses the coincidence of virtual and real coordinates - the cursor shifts to the side.  This is solved right in the game by dragging the cursor to a place where it can no longer move. <br><br><h3>  Full implementation </h3><br>  Then everything was a matter of technology - when DefWindowProc stopped interfering and WM_TOUCH / WP_POINTER stopped sticking together, I began to process them and send events via mouse_event;  the behavior of the cursor has become predictable.  The only thing that could not be solved was the one-time work of the mouse and touchscreen.  The mouse does not generate any WM_ messages at all, therefore we cannot find out its exact coordinates, and GetCursorPos only gives what we write there.  After intercepting touchscreen events, the values ‚Äã‚Äãof GetCursorPos stopped changing at all, although the cursor was moving with the mouse and so.  For Arcanum, the right button is still critical, so it was hung up by pressing with two fingers.  To exit the menu and save, you need ESC, it took root on a gesture of 3 or more fingers.  I decided to stop at this today, cleaned up the code, uploaded it on <a href="https://github.com/Nomad1/touchmouse">github</a> and ... instead of playing, sat down to write an article on Habr;) <br><br><div class="spoiler">  <b class="spoiler_title">For skeptics and nostalgic</b> <div class="spoiler_text"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63c/10d/a5a/63c10da5a96465adb102eaabefbbdd58.png"></div><br>  The touchscreen was chosen spell, used, and then with the right "click" out of the caste mode </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/da3/198/323/da31983239ca53ee9155d1d1368abde3.png"></div>  The introductory videos are skipped by tap, the character is created and the inventory is also opened with a touchscreen (on the "clean" version it is not possible) </td></tr></tbody></table><br></div></div><br><br><h3>  Bugs and flaws </h3><br><ul><li>  I‚Äôve already written a couple of times, but I'll duplicate it: if I move the mouse, the cursor will get lost, you only have to play with the touch.  The cursor can be zagan in the corner of the screen and then pull out from there tachim, it vosstanavlivaet synchronization of coordinates </li><li>  In Fallout 2, intercepting WindowProc crashes the game after some time.  In the next versions I will figure it out, but for now you can play without it: the project has two entry points - with and without interception of WM messages.  Unfortunately, the buttons in the game are too small and it is not convenient to press them with your finger, the stylus is better. </li><li>  The hook for creating new windows works for a few seconds while the game starts.  If some other program starts at this time, the DLL will be loaded into its address space.  As a result, it can not be removed before the reboot.  Not critical, but the DLL can be renamed.  During the debugging, I have accumulated hundreds of such renamed ones. </li><li>  <s>Windows 8 is rich in <s>wretched</s> fashionable gestures, some of which interfere with play.</s>  <s>They can be turned off programmatically, but for this you need to compile in something newer than VS 6.0.</s>  <s>In the meantime, you can disable these gestures in the registry:</s> <pre> <code class="hljs tex">[HKEY_LOCAL_MACHINE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ImmersiveShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EdgeUI</span></span></span></span>] "DisabledEdges"=dword:0000000f</code> </pre>  - implemented </li><li>  The code is written by a bearded dinosaur in the 98th IDE.  Well, excuse me, Panov.  He can also crumble, because you know? </li><li>  The DLL came out large (48kb), but some antiviruses can still do it on the rack ‚Äî there are injects, global hooks and, in general, interference with the system! </li></ul><br><br><h3>  Support </h3><br>  Anyone wishing to express their gratitude can not bother and say "thank you".  You can even out loud and in front of the monitor, do not necessarily write about it.  Those who wish to call me necrophilia or something else, I advise you too to say it out loud several times and not to increase the entropy of the world Internet.  The project at the same time will not interfere with testing for more old games, solving problems with Fallout, <s>upgrading to a newer IDE</s> , fixes, a wiki page, etc. I don‚Äôt mind the specific game patches.  Fork, do, then smogim. <br><br>  <b>UPD:</b> At lunchtime, I updated the project to VS 2012, added auto-disabling Windows 8 charms, support for the button on the stylus.  At the same time I tried to work with ASI Loader, but something did not work out.  A strange crash was also captured at startup and a hack fix was made for it. <br><br>  <b>UPD 2:</b> As it turned out, the library worked incorrectly if the non-default mouse speed was set or ‚ÄúExtended pointer accuracy‚Äù was turned on.  I do not see a complete solution to this problem yet, because the DLL at startup turns off these items as incompatible with touch controls.  If anyone is interested, then ‚ÄúExtended accuracy‚Äù is someone's stupid joke, which doubles the mouse offset on any axis, if its value is more than 6 pixels and quadruples if more than 10. That is,  By moving the mouse 7 pixels to the left and 12 up, with this mode we will get an offset of 14 pixels to the left and 48 up.  I do not see any increased accuracy in this; moreover, limits 6 and 10 were set somewhere inside the system a decade ago and cannot be changed by the user. <br><br></div><p>Source: <a href="https://habr.com/ru/post/206142/">https://habr.com/ru/post/206142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206126/index.html">Foxconn nanoPC AT-7300 nettop review on Intel Core i3-3217U</a></li>
<li><a href="../206128/index.html">Electronics and seals: we collect a robot toy for a cat on STM32</a></li>
<li><a href="../206130/index.html">NASA unveiled Valkyrie - a humanoid robot that will participate in the final competition DARPA</a></li>
<li><a href="../206136/index.html">Broadcasting XXI century</a></li>
<li><a href="../206138/index.html">Cisco vs Aruba: Arguments Exhausted?</a></li>
<li><a href="../206144/index.html">The power of a word. How a simple explanation saved user relationships.</a></li>
<li><a href="../206146/index.html">We buy train tickets in the New Year</a></li>
<li><a href="../206148/index.html">Creating your own drivers for Linux</a></li>
<li><a href="../206150/index.html">The second life of old dial gauges</a></li>
<li><a href="../206152/index.html">Tuning mooedit, work on the bugs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>