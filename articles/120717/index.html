<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with KVM virtual machines. Host Preparation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 As promised in the previous article , today we will talk about the basic configuration of the host machine for KVM. 



 First you nee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with KVM virtual machines. Host Preparation</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a96/529/876/a96529876e11ead69bf59f8f8a880992.jpg" alt="tux and beastie" align="left">  As promised in the <a href="http://habrahabr.ru/blogs/virtualization/120432/">previous article</a> , today we will talk about the basic configuration of the host machine for KVM. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First you need to find out if our processor has the necessary instructions to support virtualization. <br><br> <code>$ egrep '(vmx|svm)' /proc/cpuinfo</code> <br> <br>  If there is - this is great. <br><br><h4>  Preparing the operating system </h4><br><br>  I probably will not describe the installation of Debian Squeeze: if you got to KVM, then installing the system is a trifling matter. <br><br>  You will need to install a 64-bit OS, since the necessary packages are only for this architecture. <br><br>  In Debian Squeeze, the ‚Äúfreshness‚Äù of packages with KVM and related programs does not suit us at all, since a lot of all sorts of fixes and features will simply pass us by.  Therefore, we will add the Debian Sid and experimental repositories: <br><br> <code><a href="http://ftp.ru.debian.org/debian"></a> <a href="http://ftp.ru.debian.org/debian"></a> <a href="http://ftp.ru.debian.org/debian"></a> <a href="http://ftp.ru.debian.org/debian"></a> deb http://ftp.ru.debian.org/debian sid main contrib non-free <br> deb-src http://ftp.ru.debian.org/debian sid main contrib non-free <br> <br> deb http://ftp.ru.debian.org/debian experimental main contrib non-free <br> deb-src http://ftp.ru.debian.org/debian experimental main contrib non-free</code> <br> <br>  We indicate that our base distribution is stable, and not what the system thought: <br><br> <code># echo 'APT::Default-Release "stable";' &gt; /etc/apt/apt.conf.d/default</code> <br> <br>  From there we will need packages: <br><br> <code># aptitude -t experimental install linux-image-2.6.39-1-amd64 qemu-kvm virtinst libvirt-bin</code> <br> <br>  From the stable repository we will need: <br><br> <code># aptitude install uml-utilities bridge-utils</code> <br> <br>  On your desktop you can put <b>virt-manager</b> (GUI utility) that allows you to conveniently create the necessary configurations of virtual machines. <br><br><h5>  Core </h5><br><br>  The more recent the kernel is, the better (within certain limits: for example, I would not recommend installing from git).  A good option would be 2.6.39, released recently. <br><br>  It should be noted that there is no module in the standard kernel to support writing to UFS2, and if you plan to run the FreeBSD guest, you will need to build a kernel with this module.  And, of course, the latest versions of cgroups are missing from the Debian kernel. <br><br>  What should be included in the kernel to use the maximum amount of functionality required: <br><br> <code>CONFIG_VIRTIO_BLK=y <br> CONFIG_VIRTIO_NET=y <br> CONFIG_VIRTIO_CONSOLE=y <br> CONFIG_HW_RANDOM_VIRTIO=y <br> CONFIG_VIRTIO=y <br> CONFIG_VIRTIO_RING=y <br> CONFIG_VIRTIO_PCI=y <br> CONFIG_VIRTIO_BALLOON=y <br> CONFIG_CGROUPS=y <br> CONFIG_CGROUP_NS=y <br> CONFIG_CGROUP_FREEZER=y <br> CONFIG_CGROUP_DEVICE=y <br> CONFIG_CGROUP_CPUACCT=y <br> CONFIG_CGROUP_MEM_RES_CTLR=y <br> CONFIG_CGROUP_MEM_RES_CTLR_SWAP=y <br> CONFIG_CGROUP_MEM_RES_CTLR_SWAP_ENABLED=y <br> CONFIG_CGROUP_SCHED=y <br> CONFIG_BLK_CGROUP=y <br> CONFIG_NET_CLS_CGROUP=y</code> <br> <br>  Then we follow the <a href="http://libguestfs.org/download/binaries/debian-packages/">link</a> and install all the deb-packages from there, copy insmod.static to /sbin/insmod.static (this is necessary, because libguestfs uses a statically compiled version of insmod, but <a href="http://bugs.debian.org/cgi-bin/bugreport.cgi%3Fbug%3D627353">there is no</a> such file in Debian and Ubuntu versions and <a href="">febootstrap have fixed</a> this problem, insmod.static no longer needs to be uploaded to the server).  libguestfs allows us to access the VDS disk through the libguestfs API (C, Perl, Python, PHP) or the guestfish utility. <br><br><h5>  First pancake </h5><br><br>  Now we have installed everything necessary to run VDS, access them to the network and install the virtual machine itself. <br><br>  Let's try to install something, for example, the same Debian.  So far, without setting up the network, just by default. <br><br>  Download the netinstall installer: <br><br> <code><a href=""></a> $ wget cdimage.debian.org/debian-cd/6.0.1a/i386/iso-cd/debian-6.0.1a-i386-netinst.iso</code> <br> <br>  We edit <b>/etc/libvirt/qemu.conf</b> so that virtual machines work for us from an unprivileged user: <br><br> <code>user = "username" <br> group = "libvirt"</code> <br> <br>  Since we will use tun-devices, you need to set the capability <b>CAP_NET_ADMIN</b> , you can do it for a separate executable file, and for the user as a whole, or configure that libvirt does not reset the necessary permissions for qemu / kvm. <br><br>  Expose for a separate file: <br><br> <code>sudo setcap cap_net_admin=ei /usr/bin/kvm</code> <br> <br>  Or expose to the user as a whole in the <b>/etc/security/capability.conf</b> file: <br><br> <code>cap_net_admin username</code> <br> <br>  Or set the appropriate setting in <b>/etc/libvirt/qemu.conf</b> : <br><br> <code>clear_emulator_capabilities = 0</code> <br> <br>  Add a user to the libvirt and kvm groups: <br><br> <code># adduser username libvirt <br> # adduser username kvm</code> <br> <br>  Run the installation of the virtual machine: <br><br> <code>$ virt-install --connect qemu:///system -n debian_guest -r 512 --arch=i686 --vcpus=1 --os-type=linux --os-variant=debiansqueeze --disk debian-6.0.1a-i386-netinst.iso,device=cdrom --disk debian_guest.img,bus=virtio,size=2,sparse=false,format=raw --network=default,model=virtio --hvm --accelerate --vnc</code> <br> <br>  Let us analyze in detail the parameters that we specified: <br><br><ul><li>  <b>--connect qemu: /// system The</b> URL by which we connect to KVM.  You can connect via ssh. </li><li>  <b>-n debian_guest</b> The name of the guest. </li><li>  <b>-r 512</b> The allocated amount of RAM in megabytes. </li><li>  <b>--arch = i686</b> Guest operating system architecture. </li><li>  <b>--vcpus = 1 The</b> number of virtual processors available to the guest. </li><li>  <b>--os-type = linux --os-variant = debianlenny</b> Specific operating system parameters. </li><li>  <b>--disk debian-6.0.1a-i386-netinst.iso, device = cdrom Boot</b> from the disk whose image was specified. </li><li>  <b>--disk debian_guest.img, bus = virtio, size = 2, sparse = false, format = raw</b> Create an image of a 2GB system, which we immediately place on the disk (you can create an image of zero size, but then fragmentation is possible, which is somewhat slower) .  The format is simple, you can do with the dd file.  Virtio disk driver, use virtio better than ide: their performance differs, if not by an order of magnitude, then by times. </li><li>  <b>--network = default, model = virtio</b> Network default settings.  In this case, libvirt will create a bridge, make a dhcp server and issue through it an address for the virtual machine to access. </li><li>  <b>--hvm</b> Full virtualization - that is, you can use your own kernels. </li><li>  <b>--accelerate</b> Work via / dev / kvm. </li><li>  <b>--vnc</b> Run VNC to connect to the text console. </li></ul><br><br><h5>  Configuration and Management Utilities </h5><br><br>  For managing the installation and for cloning virtual machines, we have two great utilities ‚Äî graphical and console-based: <b>virt-manager</b> and <b>virsh</b> , respectively.  Of course, the console version is much richer in its capabilities, but nothing compares to the type of graphs from which the sysadmin‚Äôs heart is thrilled. <br><br>  I think with <b>virt-manager</b> you will figure it out for yourself, let's try digging through the console internals of <b>virsh</b> .  Here are a few commands that should be performed and see what happens: <br><br> <code>$ virsh --connect qemu:///system list --all <br> $ virsh --connect qemu:///system dominfo debian_guest <br> $ virsh --connect qemu:///system stop debian_guest</code> <br> <br>  To not write a thousand times - <b>connect qemu: /// system</b> , add: <br><br> <code>export VIRSH_DEFAULT_CONNECT_URI= qemu:///system</code> <br> <br>  In .bashrc or just run this command in the terminal. <br><br><h5>  Network preparation </h5><br><br>  The official documentation suggests using several network options: NAT, bridged, and direct use of network cards.  And, unfortunately, in various examples that I found on the network and on the official site, only NAT and bridged networks are considered. <br><br>  In my configuration, TUN / TAP devices are used to which traffic is routed to eth0.  I will briefly describe why this routing method was chosen: <br><br>  NAT does not suit us, since each VDS must be accessible from the network directly. <br>  The scheme with bridges is not very reliable, since theoretically there is the possibility of ‚Äúcapturing‚Äù the IP address of another virtual machine. <br>  So: <br><br> <code>&lt;interface type='ethernet'&gt; <br> &lt;mac address='52:54:00:ef:40:1d'/&gt; <br> &lt;ip address='10.10.10.100'/&gt; <br> &lt;target dev='debian_guest'/&gt; <br> &lt;model type='virtio'/&gt; <br> &lt;/interface&gt; <br></code> <br><br>  This configuration section should be specified directly in the guest configuration file located at <b>/etc/libvirt/qemu/debian_guest.xml</b> .  Edit best through: <br><br> <code>$ virsh edit debian_guest</code> <br> <br>  Then the configuration will be updated on the fly, provided that the machine is not running.  Otherwise, you will need to wait until it stops, and start it again. <br><br>  Let's create the virtual device we need. <br><br>  To begin with, we need to give our user the ability to call system commands without passwords.  To do this, add to sudoers: <br><br> <code>$ sudo visudo <br> <br> Cmnd_Alias QEMU = /sbin/ifconfig, /sbin/modprobe, /usr/sbin/brctl, /usr/sbin/tunctl, /sbin/sysctl, /bin/ip, /usr/bin/cgcreate, /usr/bin/cgdelete, /sbin/tc <br> username ALL=(ALL:ALL) NOPASSWD: QEMU</code> <br> <br>  We enable the possibility of forwarding and proxying arp requests: <br><br> <code>sudo sysctl net.ipv4.conf.all.forwarding=1 <br> sudo sysctl net.ipv4.conf.all.proxy_arp=1</code> <br> <br>  You can also add these parameters to /etc/sysctl.conf and apply them: <br><br> <code>sudo sysctl -p</code> <br> <br>  Create a virtual network card and raise the device: <br><br> <code>sudo tunctl -b -u username -t debian_guest <br> sudo ifconfig debian_guest 0.0.0.0 up</code> <br> <br>  Let's create a route to the device we need from the desired IP address: <br><br> <code>sudo ip route add 10.10.10.100 dev debian_guest</code> <br> <br>  Now you can run VDS: <br><br> <code>$ virsh start debian_guest</code> <br> <br>  Having connected to the console, we will see that there is no network, but we have an <b>eth1</b> device, instead of <b>eth0</b> .  This happened because the system when loading in <b>/etc/udev/rules.d/70-persistent-net.rules</b> prescribes the mac-address of the network card, and if the mac has changed, it creates another entry about the network card, like this: <br><br> <code>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="xx:xx:xx:xx:xx:xx", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"</code> <br> <br>  You need to delete this file and reboot the VDS - after that the network card will be determined correctly. <br><br>  Let's write new network settings in the guest system: <br><br> <code># ifconfig eth0 10.10.10.100 netmask 255.255.255.0 <br> # route add default gw 10.10.10.10</code> <br> <br>  <b>10.10.10.10</b> is the IP address of the host system.  Now we can ping other machines. <br><br>  Add DNS servers to /etc/resolv.conf, and it will be absolutely wonderful: <br><br> <code>nameserver 8.8.8.8</code> <br> <br>  By the way, I note that it turned out to be very convenient to call network devices belonging to VDS, as well as the VDS themselves - there is no need to look for who owns the tap0 or vnet0 device, or how else you can call them. <br><br>  If you need to issue another IP address to the virtual machine, it will be enough just to register another route on the host machine: <br><br> <code># ip route add 10.10.10.101 dev debian_guest</code> <br> <br>  And in the guest system create an alias for the network device: <br><br> <code># ifconfig eth0:1 10.10.10.101</code> <br> <br><h4>  In the next part </h4><br><br>  In the next article I will talk about how to create a VDS image, what generally changes from system to system, and how these parameters can be conveniently changed. </div><p>Source: <a href="https://habr.com/ru/post/120717/">https://habr.com/ru/post/120717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120708/index.html">Taxer - Online Electronic Reporting</a></li>
<li><a href="../120712/index.html">Using mongo-cl-driver as a mongo database provider in common-lisp</a></li>
<li><a href="../120714/index.html">How to install additional packages in freenas 0.8</a></li>
<li><a href="../120715/index.html">Servlets and Reflection</a></li>
<li><a href="../120716/index.html">We write a game for Android using AndEngine. Part 1</a></li>
<li><a href="../120718/index.html">Flash games for dummies</a></li>
<li><a href="../120719/index.html">Why does code readability matter?</a></li>
<li><a href="../120720/index.html">ActiveGift.me - How we give presents. Briefly about sore</a></li>
<li><a href="../120724/index.html">Linaro announced cheap board for opensource developers</a></li>
<li><a href="../120725/index.html">There was a Samsung Galaxy GIO, became "Nedo - Samsung Galaxy ACE"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>