<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your application on Node.js with storage in Dropbox is just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despite the fact that robots remain my main hobby, I spend a lot of effort to stay in the trends of my main path - programming. By the will of fate, I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your application on Node.js with storage in Dropbox is just</h1><div class="post__text post__text-html js-mediator-article">  Despite the fact that robots remain my main hobby, I spend a lot of effort to stay in the trends of my main path - programming.  By the will of fate, I recently managed to get acquainted with Node.js, I found out about its express web framework, made friends with a new template engine Jade, and to top it all connected it all with a folder in Dropbox. <br><img src="https://habrastorage.org/storage2/033/c43/c14/033c43c148a87ac4af45bfb9de366c66.png" alt="image"><br>  In this post I will try to briefly describe how you can organize a web service for storing files using only free solutions. <br>  All interested - please under the cat. <br><a name="habracut"></a><br><h4>  Prepare a bridgehead </h4><br>  So, we will need: <br><ul><li>  Node.js installed on the local machine </li><li>  Dropbox Account </li><li>  Application Node.js server (if you want to start the service not only locally) </li></ul><br>  If everything should be clear with the first two points, then I would like to dwell on the third one.  I have already mentioned that everything should turn out to be free, and I am not going to back down from my words. <br>  In the process of my ‚Äúfloundering‚Äù in the Node.js world, I came across a number of platforms ready to provide Node.js server at our disposal for free.  Personally, I experienced two of them: Heroku and Nodester.  As a result, I still stopped at the second, although, to be honest, this decision is not justified by anything. <br>  To register in Nodester you need to get a coupon.  You can do this on their website or on the command line via nodester-cli.  I received a coupon the day after the request was sent.  It is very fast, although I do not exclude that I was just lucky. <br><br><h4>  Create a project </h4><br><h5>  Locally </h5><br>  We have to start with something.  To do this, we will create a folder in any place convenient for us (I have habr-nodebox called) and the package.json file in it: <br><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"habr-nodebox"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"node"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.6.17"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"andbas"</span></span>, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.5.x"</span></span>, <span class="hljs-string"><span class="hljs-string">"jade"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.26.x"</span></span>, <span class="hljs-string"><span class="hljs-string">"dbox"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.4.x"</span></span> } }</code> </pre> <br>  Fields name, version, author - just give some information about the project and can be changed without any problems;  node is the version of Node.js used in the project;  The dependencies section lists all used third-party modules.  As I already mentioned, the project will use express and jade.  The dbox plugin, as the name implies, will be used to work with Dropbox.  I tried another plugin called dropbox, but, unfortunately, it did not allow to authorize the application, because it implemented the old Dropbox API, which used / token.  Currently, Dropbox uses the oauth standard for authentication. <br>  After saving this file in the command line, call: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">npm install</code> </pre><br>  If everything was written correctly, then npm will download all modules mentioned in dependencies and install them in the current directory. <br>  In addition, we will create two more folders public and view.  The first will be used for static files (CSS, JS and others), while the view will be used for Jade templates. <br><br><h5>  Meanwhile in Dropbox </h5><br>  If we want to be able to add some files to Dropbox, we need to perform several actions, the first of which will be to get the key and the secret string for our application.  To do this, go to the <a href="https://www.dropbox.com/developers/apps">application</a> page of our Dropbox account through a browser and create a new application there.  In the Access type field, set the value of the App folder (the application will have limited access only to its own folder in Dropbox). <br>  On the app page, write yourself somewhere App key and App Secret.  That's actually the first step already passed. <br>  To automate the next steps in authorization, I suggest writing a small script for the same node.js.  The script is as follows (dbox-init.js in the folder of our application): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbox = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"dbox"</span></span>), stdin = process.stdin, stdout = process.stdout; ask(<span class="hljs-string"><span class="hljs-string">'App key'</span></span>, /^\S+$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app_key</span></span></span><span class="hljs-function">) </span></span>{ ask(<span class="hljs-string"><span class="hljs-string">'App secret'</span></span>, /^\S+$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app_secret</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = dbox.app({ <span class="hljs-string"><span class="hljs-string">'app_key'</span></span>: app_key, <span class="hljs-string"><span class="hljs-string">'app_secret'</span></span>: app_secret }); app.request_token(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, request_token</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(request_token){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Please visit '</span></span>, request_token.authorize_url, <span class="hljs-string"><span class="hljs-string">' to authorize your app.'</span></span>); ask(<span class="hljs-string"><span class="hljs-string">'Is this done? (yes)'</span></span>, /^yes$/, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">answer</span></span></span><span class="hljs-function">) </span></span>{ app.access_token(request_token, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, access_token</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'app_key: '</span></span> + app_key); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'app_secret: '</span></span> + app_secret); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'oauth_token: '</span></span> + access_token.oauth_token); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'oauth_token_secret: '</span></span> + access_token.oauth_token_secret); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'uid: '</span></span> + access_token.uid); process.exit(); }); }); } }); }); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ask</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">question, format, callback</span></span></span><span class="hljs-function">) </span></span>{ stdin.resume(); stdout.write(question + <span class="hljs-string"><span class="hljs-string">": "</span></span>); stdin.once(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ data = data.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format.test(data)) { callback(data); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { stdout.write(<span class="hljs-string"><span class="hljs-string">"It should match: "</span></span>+ format +<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); ask(question, format, callback); } }); }</code> </pre><br>  In order to run the script just type in the command line: <br><br><pre> <code class="bash hljs">node dbox-init</code> </pre><br>  The script runs along with you all the stages of oauth authentication in Dropbox and helps to get all the keys we need.  The steps are as follows: <br><ul><li>  the script requests the App key and the App Secret (those that we received earlier) and generates a link based on them </li><li>  we copy the link into the browser and authorize the application to work with our dropbox account, we receive a notification that the application is authorized </li><li>  to the question of the script about whether we passed the authorization boldly write ‚Äúyes‚Äù </li><li>  we receive and write to the secluded place the data necessary for authorization, specifically: app_key, app_secret, oauth_token, oauth_token_secret and uid </li></ul><br>  At this preparatory work passed, we can proceed to writing the application itself. <br><br><h4>  Into the battle: we sketch the controller </h4><br>  We turn, in my opinion, to the most interesting - writing the controller.  The main actions are: view all files, add new ones, receive existing ones.  I will not torment and immediately provide the code (web.js). <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>), app = express.createServer(express.logger()), fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>), dropbox = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"dbox"</span></span>).app({<span class="hljs-string"><span class="hljs-string">"app_key"</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_app_key'</span></span>], <span class="hljs-string"><span class="hljs-string">"app_secret"</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_app_secret'</span></span>] }), client = dropbox.createClient({<span class="hljs-attr"><span class="hljs-attr">oauth_token_secret</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_oauth_token_secret'</span></span>], <span class="hljs-attr"><span class="hljs-attr">oauth_token</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_oauth_token'</span></span>], <span class="hljs-attr"><span class="hljs-attr">uid</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_uid'</span></span>]}); app.use(express.static(__dirname+<span class="hljs-string"><span class="hljs-string">'/public'</span></span>)); app.set(<span class="hljs-string"><span class="hljs-string">'views'</span></span>, __dirname + <span class="hljs-string"><span class="hljs-string">'/views'</span></span>); app.set(<span class="hljs-string"><span class="hljs-string">'view engine'</span></span>, <span class="hljs-string"><span class="hljs-string">'jade'</span></span>); app.set(<span class="hljs-string"><span class="hljs-string">'view options'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">layout</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }); app.use(express.bodyParser()); app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ client.metadata(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply</span></span></span><span class="hljs-function">) </span></span>{ res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">content</span></span> : reply }); }); }); app.get(<span class="hljs-string"><span class="hljs-string">'/:path'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = req.params.path; client.get(path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply, metadata</span></span></span><span class="hljs-function">)</span></span>{ res.send(reply); }); }); app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileMeta = req.files[<span class="hljs-string"><span class="hljs-string">'file-input'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fileMeta) { fs.readFile(fileMeta.path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; client.put(fileMeta.name, data, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply</span></span></span><span class="hljs-function">) </span></span>{ res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = process.env[<span class="hljs-string"><span class="hljs-string">'app_port'</span></span>] || <span class="hljs-number"><span class="hljs-number">5000</span></span>; app.listen(port, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Listening on "</span></span> + port); });</code> </pre><br>  I think a little clarification of what is happening here will not hurt. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>), app = express.createServer(express.logger()), fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>), dropbox = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"dbox"</span></span>).app({<span class="hljs-string"><span class="hljs-string">"app_key"</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_app_key'</span></span>], <span class="hljs-string"><span class="hljs-string">"app_secret"</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_app_secret'</span></span>] }), client = dropbox.createClient({<span class="hljs-attr"><span class="hljs-attr">oauth_token_secret</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_oauth_token_secret'</span></span>], <span class="hljs-attr"><span class="hljs-attr">oauth_token</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_oauth_token'</span></span>], <span class="hljs-attr"><span class="hljs-attr">uid</span></span>: process.env[<span class="hljs-string"><span class="hljs-string">'dbox_uid'</span></span>]});</code> </pre><br>  Announcement of the main building blocks of our application: <br><ul><li>  express - as mentioned earlier, the web framework </li><li>  app is the actual web application itself. </li><li>  fs - file system interface </li><li>  dropbox - factory to create Dropbox client </li><li>  client - Dropbox client simplifies working with API </li></ul><br><pre> <code class="javascript hljs">app.use(express.static(__dirname+<span class="hljs-string"><span class="hljs-string">'/public'</span></span>)); app.set(<span class="hljs-string"><span class="hljs-string">'views'</span></span>, __dirname + <span class="hljs-string"><span class="hljs-string">'/views'</span></span>); app.set(<span class="hljs-string"><span class="hljs-string">'view engine'</span></span>, <span class="hljs-string"><span class="hljs-string">'jade'</span></span>); app.set(<span class="hljs-string"><span class="hljs-string">'view options'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">layout</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }); app.use(express.bodyParser());</code> </pre><br>  Initialization of our web application.  Here we set the basic parameters: the paths to static files (public), the directory for templates (views), the engine of these templates (jade), disable the main layout, to simplify writing a little and get along with one template, and finally pass to our application bodyParser, which will parse the body of incoming requests. <br>  And now for the main magic.  Next will follow the three main handlers of our service. <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ client.metadata(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply</span></span></span><span class="hljs-function">) </span></span>{ res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">content</span></span> : reply }); }); });</code> </pre><br>  This code is responsible for the main page.  On it we will display a list of files in our Dropbox folder, so we make a request through the client and get the meta information.  It contains information about all files in our application.  We pass this information to our template engine, which will render the page. <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/:path'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = req.params.path; client.get(path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply, metadata</span></span></span><span class="hljs-function">)</span></span>{ res.send(reply); }); });</code> </pre><br>  The method written above will process file requests.  Everything is very simple - we get the file name and send the request to Dropbox.  The received answer is redirected to the user. <br><br><pre> <code class="javascript hljs">app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileMeta = req.files[<span class="hljs-string"><span class="hljs-string">'file-input'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fileMeta) { fs.readFile(fileMeta.path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; client.put(fileMeta.name, data, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status, reply</span></span></span><span class="hljs-function">) </span></span>{ res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); } });</code> </pre><br>  Almost all the work for us did express.  The file sent in the post request body to the server has been temporarily saved to the file system.  We were presented with all the necessary information for us in the <b>req.files ['file-input']</b> object, where file-input is the name attribute of the input element of the form in html.  We just have to take the file from the file system and send it to Dropbox.  After that we will be redirected to the main page. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = process.env[<span class="hljs-string"><span class="hljs-string">'app_port'</span></span>] || <span class="hljs-number"><span class="hljs-number">5000</span></span>; app.listen(port, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Listening on "</span></span> + port); });</code> </pre><br>  At the end we set the port for our application, the default value will be 5000. It remains only to write one simple page using the jade template, and we‚Äôll do this. <br><br><h4>  Jade pattern - it's all indenting </h4><br>  The first acquaintance with Jade for me personally was painful.  Plain html is somehow closer. <br>  However, the discomfort quickly passed.  The second page was written without hostility.  In general, you get used quickly.  I recommend to try. <br>  To discuss jade convenience is certainly great, but it's time to show the code.  To do this, create an index.jade file in the views folder and write in it: <br><br><pre> <code class="javascript hljs">!!! <span class="hljs-number"><span class="hljs-number">5</span></span> html(lang=<span class="hljs-string"><span class="hljs-string">"en"</span></span>) head title habr-nodebox body each item, i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> content.contents div a(href=<span class="hljs-string"><span class="hljs-string">"#{item.path}"</span></span>) #{item.path} - #{item.size} div form#upload-form(action=<span class="hljs-string"><span class="hljs-string">"/"</span></span>, method=<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, enctype=<span class="hljs-string"><span class="hljs-string">"multipart/form-data"</span></span>) input#file-input(name=<span class="hljs-string"><span class="hljs-string">"file-input"</span></span>, type=<span class="hljs-string"><span class="hljs-string">"file"</span></span>) input#submit(value=<span class="hljs-string"><span class="hljs-string">"Upload file"</span></span>, type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span>)</code> </pre><br>  I tried to make the template more transparent and understandable.  Of course, to achieve outstanding stylistic results with this will not work, but you will not sacrifice anything for the sake of clarity. <br>  We just created a simple HTML page with a list of files in our folder.  To do this, we went through the each loop through all the file entries.  Let me remind you that content metadata was carefully obtained for our template in the controller.  Each element of the list is a link leading us to the controller method for queries of the form ‚Äú/: path‚Äù.  Following the list is a form for downloading new files.  It consists of two input elements, one for the file and one for the form submission. <br><br><h4>  Launch </h4><br>  That's actually our application and it is ready, it remains only to start it.  Maybe someone noticed when he read that all the keys to Dropbox were written as variables of the process.env [] array.  This is done in order not to leave them in the code and be able to publish the application without fear of being compromised.  In order to transfer your values ‚Äã‚Äãto the process.env array, it is enough to write them in the form of key = value before calling node.  The command line should get something like this: <br><pre> <code class="bash hljs">$ dbox_app_key=abc1qwe2rty3asd dbox_app_secret=123asd123asd123 dbox_oauth_token_secret=aaabbbccc111222 dbox_oauth_token=123asd123asd123 dbox_uid=12345678 node web</code> </pre><br>  On services such as Nodester, it is possible to install process.env, so this was the only way, without any problems, that came to my mind. <br>  The result, after adding several files, will look like this. <br><br><img src="https://habrastorage.org/storage2/552/e41/be9/552e41be981729500309eb9fd2e0eabc.png"><br>  That's all, if someone has a desire to run such code online - just upload it to any Node.js server.  I tested on Nodester - everything worked, I think the rest will not cause problems either. <br>  Code can be found <a href="https://github.com/andbas/habr-nodebox">here.</a> </div><p>Source: <a href="https://habr.com/ru/post/146735/">https://habr.com/ru/post/146735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146729/index.html">A project management system like Jira, only to be ‚Äúcloudy‚Äù and up to 5 users free</a></li>
<li><a href="../146730/index.html">Non-volatile solution</a></li>
<li><a href="../146732/index.html">Drop-down menu in Twitter Bootstrap</a></li>
<li><a href="../146733/index.html">Comparison table of 39 single-board computers</a></li>
<li><a href="../146734/index.html">Google Drive already has 10 million users.</a></li>
<li><a href="../146738/index.html">Oval Elephant - another competitor to Raspberry Pi</a></li>
<li><a href="../146739/index.html">How many times did the user run your program?</a></li>
<li><a href="../146740/index.html">Research In Motion incurs losses, dismisses 5,000 employees and transfers BB 10</a></li>
<li><a href="../146741/index.html">Google Now cards</a></li>
<li><a href="../146742/index.html">Latex calculations? Yes, easily!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>