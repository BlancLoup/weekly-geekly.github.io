<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Measuring code coverage tests on Android using JaCoCo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Posted by: Mike Gouline 
 https://blog.gouline.net/2015/06/23/code-coverage-on-android-with-jacoco/ 
 Translation: Semen Soldatenko 

 Since this feat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Measuring code coverage tests on Android using JaCoCo</h1><div class="post__text post__text-html js-mediator-article">  Posted by: Mike Gouline <br>  <a href="https://blog.gouline.net/2015/06/23/code-coverage-on-android-with-jacoco/">https://blog.gouline.net/2015/06/23/code-coverage-on-android-with-jacoco/</a> <br>  Translation: Semen Soldatenko <br><br>  Since this feature appeared in the Android Gradle plugin version 0.10.0, many articles have been written about measuring code coverage by tests (test coverage) - and I have no illusions about this.  However, what annoys me is the need to look at a few such articles and even the Gradle documentation before you get a fully working solution.  So here, another article that will try to fix it and save your time. <br><a name="habracut"></a><br><h2>  Formulation of the problem </h2><br>  There is an Android project with unit tests (unit tests), and we want to create a report on code coverage for the tests performed.  The solution should support different modes of build (build types) and product variations (product flavors). <br><br><h2>  Decision </h2><br>  The solution consists of several parts, so let's take it step by step. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Enable code coverage data collection. </h3><br>  You need to include support for collecting data on code coverage by tests for the build mode in which you will run the tests.  Your <code>build.gradle</code> should contain the following: <br><br><pre> <code class="hljs lua">android { ... buildTypes { <span class="hljs-built_in"><span class="hljs-built_in">debug</span></span> { testCoverageEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ... } ... }</code> </pre><br><h3>  Configure JaCoCo </h3><br>  Although all of this section could be placed in <code>build.gradle</code> , such a ‚Äúmounted installation‚Äù will make your build script unreadable, so I recommend putting all this into a separate build script, and then importing. <br><br>  We will begin setting up JaCoCo by creating a <code>jacoco.gradle</code> file in the project root directory.  You can create it anywhere you want, but keeping it in the project root directory will make it easy to refer to it from all subprojects. <br><br>  The easiest part is importing JaCoCo: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">apply</span></span> plugin: <span class="hljs-string"><span class="hljs-string">'jacoco'</span></span> jacoco { <span class="hljs-attribute"><span class="hljs-attribute">toolVersion</span></span> = <span class="hljs-string"><span class="hljs-string">"0.7.5.201505241946"</span></span> }</code> </pre><br>  Please note that you do not need to declare any dependencies in order to use the ‚Äújacoco‚Äù plugin - all you need is to connect the Android plugin. <br><br>  To check which version is the latest, look for <a href="">org.jacoco: org.jacoco.core</a> in jCenter, but update carefully - the latest version may still be incompatible, which can lead to some oddities, such as a blank report. <br><br>  The next step is to create Gradle tasks for all product variations and build modes (in fact, you will only test the debug build (debug), but it‚Äôs very convenient to have this option for any special debug build configuration). <br><br><pre> <code class="hljs pgsql">def buildTypes = android.buildTypes.collect { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.name } def productFlavors = android.productFlavors.collect { flavor -&gt; flavor.name }</code> </pre><br>  Notice that the <code>collect</code> in Groovy takes a list as input, calls the function with each item in the list, and returns the results in a new list.  In this case, the input receives lists of objects ‚Äúassembly mode‚Äù and ‚Äúproduct variation‚Äù, which are converted into lists of their names. <br><br>  For projects in which product variations are not specified, we will add a blank name: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!productFlavors) productFlavors.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>)</code> </pre><br>  Now we can scroll through them like this, which is essentially a nested loop in Groovy: <br><br><pre> <code class="hljs erlang-repl">productFlavors.each { productFlavorName -&gt; buildTypes.each { buildTypeName -&gt; ... } }</code> </pre><br>  The most important part is what we put inside the loop, so let's look at it in more detail. <br><br>  First, we will prepare the task names with the correct placement of capital letters: <br><ul><li>  <code>sourceName</code> - the name of the build source (build source name), for <code>blueDebug</code> : <code>blueDebug</code> </li><li>  <code>sourcePath</code> - the path to the source codes of the build (build source path), eg: <code>blue/debug</code> </li><li>  <code>testTaskName</code> is the task for executing tests on which the task of measuring code coverage will depend, for <code>testBlueDebug</code> : <code>testBlueDebug</code> </li></ul><br>  Here is how we define them: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">def</span></span> sourceName, sourcePath if (!productFlavorName) { <span class="hljs-attribute"><span class="hljs-attribute">sourceName</span></span> = sourcePath = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${buildTypeName}</span></span></span><span class="hljs-string">"</span></span> } else { <span class="hljs-attribute"><span class="hljs-attribute">sourceName</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${productFlavorName}</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${buildTypeName.capitalize()}</span></span></span><span class="hljs-string">"</span></span> sourcePath = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${productFlavorName}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${buildTypeName}</span></span></span><span class="hljs-string">"</span></span> } def testTaskName = <span class="hljs-string"><span class="hljs-string">"test</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${sourceName.capitalize()}</span></span></span><span class="hljs-string">UnitTest"</span></span></code> </pre><br>  Now the challenge is how it actually looks like: <br><br><pre> <code class="hljs bash">task <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${testTaskName}</span></span></span><span class="hljs-string">Coverage"</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>:JacocoReport, dependsOn: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$testTaskName</span></span></span><span class="hljs-string">"</span></span>) { group = <span class="hljs-string"><span class="hljs-string">"Reporting"</span></span> description = <span class="hljs-string"><span class="hljs-string">"Generate Jacoco coverage reports on the </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${sourceName.capitalize()}</span></span></span><span class="hljs-string"> build."</span></span> classDirectories = fileTree( dir: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${project.buildDir}</span></span></span><span class="hljs-string">/intermediates/classes/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${sourcePath}</span></span></span><span class="hljs-string">"</span></span>, excludes: [<span class="hljs-string"><span class="hljs-string">'**/R.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/R$*.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*$ViewInjector*.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/BuildConfig.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/Manifest*.*'</span></span>] ) def coverageSourceDirs = [ <span class="hljs-string"><span class="hljs-string">"src/main/java"</span></span>, <span class="hljs-string"><span class="hljs-string">"src/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$productFlavorName</span></span></span><span class="hljs-string">/java"</span></span>, <span class="hljs-string"><span class="hljs-string">"src/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$buildTypeName</span></span></span><span class="hljs-string">/java"</span></span> ] additionalSourceDirs = files(coverageSourceDirs) sourceDirectories = files(coverageSourceDirs) executionData = files(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${project.buildDir}</span></span></span><span class="hljs-string">/jacoco/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${testTaskName}</span></span></span><span class="hljs-string">.exec"</span></span>) reports { xml.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> html.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre><br>  You might see similar code in other JaCoCo articles, so I hope that most of it is understandable without explanation. <br><br>  Parts worthy of attention: <br><ul><li>  <code>classDirectories</code> - in <code>"excludes"</code> you can list templates for exclusion from the report;  it may be generated code (class <code>R</code> , code embedding dependencies, etc.) or anything else you want to ignore </li><li>  <code>reports</code> - allows HTML and / or XML reports, depending on whether they are needed for publication or for analysis, respectively. </li></ul><br>  That's all about <code>jacoco.gradle</code> , so here is the full contents of the file: <br><br><pre> <code class="hljs pgsql">apply plugin: <span class="hljs-string"><span class="hljs-string">'jacoco'</span></span> jacoco { toolVersion = "0.7.5.201505241946" } project.afterEvaluate { // Grab <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">types</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> product flavors def buildTypes = android.buildTypes.collect { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.name } def productFlavors = android.productFlavors.collect { flavor -&gt; flavor.name } // <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> product flavors defined, use empty <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!productFlavors) productFlavors.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>) productFlavors.<span class="hljs-keyword"><span class="hljs-keyword">each</span></span> { productFlavorName -&gt; buildTypes.<span class="hljs-keyword"><span class="hljs-keyword">each</span></span> { buildTypeName -&gt; def sourceName, sourcePath <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!productFlavorName) { sourceName = sourcePath = "${buildTypeName}" } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sourceName = "${productFlavorName}${buildTypeName.capitalize()}" sourcePath = "${productFlavorName}/${buildTypeName}" } def testTaskName = "test${sourceName.capitalize()}UnitTest" // <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> coverage task <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> form <span class="hljs-string"><span class="hljs-string">'testFlavorTypeCoverage'</span></span> depending <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">'testFlavorTypeUnitTest'</span></span> task "${testTaskName}Coverage" (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>:JacocoReport, dependsOn: "$testTaskName") { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = "Reporting" description = "Generate Jacoco coverage reports on the ${sourceName.capitalize()} build." classDirectories = fileTree( dir: "${project.buildDir}/intermediates/classes/${sourcePath}", excludes: [<span class="hljs-string"><span class="hljs-string">'**/R.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/R$*.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*$ViewInjector*.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*$ViewBinder*.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/BuildConfig.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/Manifest*.*'</span></span>] ) def coverageSourceDirs = [ "src/main/java", "src/$productFlavorName/java", "src/$buildTypeName/java" ] additionalSourceDirs = files(coverageSourceDirs) sourceDirectories = files(coverageSourceDirs) executionData = files("${project.buildDir}/jacoco/${testTaskName}.exec") reports { <span class="hljs-type"><span class="hljs-type">xml</span></span>.enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> html.enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } } } }</code> </pre><br>  Finally, you need to import this build script into your script in the <code>app</code> something like this: <br><br><pre> <code class="hljs cs">apply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">'../jacoco.gradle'</span></span></code> </pre><br>  (Note: This means that <code>jacoco.gradle</code> is located in the root directory of your project, as described above.) <br><br>  That's all!  You can ensure that tasks are created by running <code>gradle tasks</code> and looking for something like the following in the <code>"Reporting"</code> section: <br><br><pre> <code class="hljs pgsql">Reporting tasks <span class="hljs-comment"><span class="hljs-comment">--------------- testBlueDebugUnitTestCoverage - Generate Jacoco coverage reports on the BlueDebug build. testBlueReleaseUnitTestCoverage - Generate Jacoco coverage reports on the BlueRelease build. testRedDebugUnitTestCoverage - Generate Jacoco coverage reports on the RedDebug build. testRedReleaseUnitTestCoverage - Generate Jacoco coverage reports on the RedRelease build.</span></span></code> </pre><br>  To create a report, run <code>gradle testBlueDebugUnitTestCoverage</code> and you will find it in <code>"build/reports/jacoco/testBlueDebugUnitTestCoverage/"</code> . <br><br><h2>  Updates </h2><br><ul><li>  2015-08-23: Fixed jacoco.gradle script for Gradle plugin 1.3.0, where the test tasks are suffixed with "UnitTest". </li><li>  2015-10-01: Fixed task name suffixes in text. </li><li>  2015-10-28: Fixed build path changes for Android Android plugin. </li></ul><br><h2>  Source </h2><br>  <a href="https://github.com/mgouline/android-samples/tree/master/jacoco">JaCoCo example</a> (GitHub) </div><p>Source: <a href="https://habr.com/ru/post/280374/">https://habr.com/ru/post/280374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280360/index.html">Report from Moscow Python Meetup March 18</a></li>
<li><a href="../280362/index.html">Video reports from Zabbix Moscow Meetup 2016</a></li>
<li><a href="../280364/index.html">An exploit for vulnerabilities in Cisco UCS Manager: is the devil so scary?</a></li>
<li><a href="../280370/index.html">Tips, libraries and additional materials on CSS-animation</a></li>
<li><a href="../280372/index.html">Interactive video and what it eats</a></li>
<li><a href="../280376/index.html">In simple words: We deal with "cloud" services.</a></li>
<li><a href="../280378/index.html">man! (Go => D) .concurrency</a></li>
<li><a href="../280380/index.html">We solve the problem of interception and substitution of DNS queries. DNSCrypt in Yandex Browser</a></li>
<li><a href="../280382/index.html">Yii framework code parsing</a></li>
<li><a href="../280384/index.html">Million files and one laptop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>