<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programmer Archeology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last Saturday, I decided to hold a ‚Äúsubbotnik‚Äù and finally put things in order on the shelves and in the closets. 

 In the old boxes, among all sorts...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programmer Archeology</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e24/b36/002/e24b36002e514057901f2c524ec1d124.jpg"><br><br>  Last Saturday, I decided to hold a ‚Äúsubbotnik‚Äù and finally put things in order on the shelves and in the closets. <br><br>  In the old boxes, among all sorts of different equipment, different boards, the developer of whales and packs of old disks discovered several interesting instances of devices, just real artifacts of antiquity.  A whole story is connected with these artifacts, which I would like to tell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here is how it was.  In the far-distant year, we received an order for the development of firmware for the Cypress CY7C63723 microcircuit.  It was such a PS / 2-USB microcontroller.  Task: write the firmware for this chip.  But there was one nuance.  The chip is designed to convert the protocol from PS / 2 to USB, and it was necessary to connect two PS / 2 devices, that is, you need to connect a PS / 2 mouse and a PS / 2 keyboard using one such USB chip converter.  The chip would have to be installed on the Jetway motherboard (if memory serves). <br><br>  More precisely, it was even the case: this task was already done by some developer, but something didn‚Äôt work for him.  We gave him the source and said that we need to urgently fix and redo, but that worked.  In addition to the source code of our unfortunate predecessor, then we got this ... <a name="habracut"></a><br><br><img src="https://habrastorage.org/files/32c/ad5/e5f/32cad5e5f22a4ad1b6e3e70da3b15eb7.jpg"><br><br>  This is a prototype of the Two-PS / 2-to-USB converter, which you had to program.  In fact, this is only a mockup, the chip was then installed directly on the motherboard to give an extra mouse and keyboard.  It was assumed that this would be a motherboard for two users at the same time, a multi-user computer. <br><br><img src="https://habrastorage.org/files/737/e89/a7b/737e89a7b40c453593d189993ae23da1.jpg"><br><br>  Cypress CY7C63723 Chip Emulator!  Such a small microcircuit and such a large emulator.  Such are the technologies.  Since the chip was disposable, with a one-time firmware (OTP - One Time Programmable), it is impossible to simply and develop the firmware.  You can not immediately sew and try - it is too long and wasteful.  Therefore, the company Cypress supplied the developers with such strange devices - chip emulators.  I compiled the program, loaded it into the emulator of the microcircuit, the simulator of the microcircuit is inserted through the cable into the socket on the board of the future device - you watch how it works.  Now I'm not sure, but it seems there was even an in-circuit debugger of the processor. <br><br><img src="https://habrastorage.org/files/32d/a8e/525/32da8e52546c4fd1a4c487f7ce6c9d1a.jpg"><br><br>  Here is such a universal programmer.  To him were still a couple of dozens of clean Cypress chips, but where are they now? <br><br>  When I found these glands in old boxes, curiosity appeared.  Can I find the source of those programs?  How long has it been? <br><br>  It's all simple now.  I now have every new laptop has a hard drive substantially larger than the previous one.  It turns out that you buy a laptop and copy an entire old small disk onto its large disk.  The first laptop had 90 GB, the second 320 GB, and the last laptop 1 TB.  Again - now there are ‚Äúclouds‚Äù and GIT.  And then the archives were stored on CDs.  Sometimes they recorded several discs just in case, for sure. <br><br><img src="https://habrastorage.org/files/baf/93c/394/baf93c3949fc48948f2ecd66a706c530.jpg"><br><br>  Finding old programs on old disks is a real challenge.  But - found!  Dated 2003 - it was about 13 years ago.  Well, on occasion, my advice of the day: "Never sign discs with the phrase Current Versions." <br><br>  So ... We were in the team for this task were 2 people, we took with all the zeal, although we had no idea about USB or Cypress chips. <br><br>  To describe the essence of what is happening, I will tell you a little about the CY7C63723 chip.  In this microcontroller, there were: <br><br><ul><li>  14-bit pointer to the executable command PC (Program Counter); </li><li>  8-bit battery, A; </li><li>  8-bit index register, X; </li><li>  8th instruction stack pointer, PSP (Program Stack Pointer); </li><li>  8th data stack pointer, DSP (Data Stack Pointer); </li></ul><br>  And this is almost all ... well, of course, different ways of addressing - this is understandable.  You need to write, of course, in assembler.  Of course, inside the microcontroller there is still any peripheral that is traditional for microcontrollers: a timer, GPIO and interrupts from them, a USB function, and so on. <br><br>  This is me now, considering the old documentation for this chip (I found it on disks), I remember this project and am surprised at this miracle.  So that you fully feel the full power of the microcontroller, I will give a fragment of the list of commands: <br><br><blockquote>  NOP - 4 bars <br>  INC A - 4 bars <br>  INC X - 4 bars <br>  INC [EXPR] - 7 cycles <br>  INC [X + EXPR] - 8 cycles <br>  ADD A, EXPR - 4 bars <br>  ADD A, [EXPR] - 6 cycles <br>  ADD A, [X + EXPR] - 7 cycles <br>  ... <br></blockquote><br>  Despite the microcontroller's clock frequency of 12 MHz, in fact, it turned out to be far from fast - all the megahertz ate the clock-to-command. <br><br>  The most interesting thing is that we were able to quickly figure out how it should work, quickly fixed everything, flashed the first chips, tested it, and the keyboard and mouse work, the LEDs on the CAPS, NUM, LOCK keyboard work.  Hooray, everything is fine, everyone is happy and happy! <br><br>  But no.  After a week or two, the customer says it does not work.  We are trying to find out - nothing really can be understood.  There is an intermediary between us and the end customer.  That is, the German company orders us, and the Taiwan company orders them.  It is almost impossible to read emails from Taiwan.  They are written in ‚ÄúChinglish‚Äù - this is when a person thinks in Chinese, and writes in English - it is difficult to decipher.  In the end, we agreed that they will send us a program in which our PS / 2-USB converter does not work.  They say that in all programs it works, and specifically in this program it does not. <br><br>  Well, okay - trying to deflate their test program.  The year 2003, we still use a dial-up modem, the connection breaks all the time, the program is very hard to deflate.  With some kind of N-th attempt, we extort ... (drum roll) Doom2.  But what?  Why?  How so? <br><br>  It turns out everything is very simple: you need to often press the keyboard keys to go, run and jump, and simultaneously rotate and shoot with the mouse.  And we never did.  After all, we tried like all normal people: we tried the keyboard keys - the characters in the editor are typed, then we try the mouse - it drives.  Here is the same ... <br><br>  I had to completely revise the program of the microcontroller.  Now, with a detailed analysis, it became clear that with simultaneously flying symbols from both PS / 2 devices, it is extremely difficult to process the DATA and CLK signals on the two ports.  I will not give oscillograms of signals here, they can be easily found on the Internet, at least here <a href="https://marsohod.org/11-blog/56-ps2">marsohod.org/11-blog/56-ps2</a> .  The frequency of the CLK signal in PS / 2 can be up to 18KHz.  It seems to be a very low frequency, but if you count, it turns out not fun at all.  The ratio of PS / 2 CLK frequencies and the frequency of the microcontroller processor: 12000000/18000 = 666 (oh, horror).  With an average command length of 5 clocks, it turns out that no more than 130 microcontroller commands can be executed between two PS / 2 fronts of the clock.  And we have interrupts tuned to four signals of two PS / 2 ports: from DATA0, from CLK0, from DATA1, and from CLK1.  The worst case is when the fronts of some signals coincide randomly - the ports are asynchronous.  If two interrupts from different ports in a row, then it turns out that there are generally 60 cycles per interrupt ... <br><br>  In general, I had to literally take into account the duration of each team.  Let me give you a fragment of the assembler code of the interrupt handler; on many lines it costs how many clock cycles the command will take: <br><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">org</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>d00h snd_recv_tabl0: jmp recv_startbit0 jmp recv_bit0 jmp recv_bit1 jmp recv_bit2 jmp recv_bit3 jmp recv_bit4 jmp recv_bit5 jmp recv_bit6 jmp recv_bit7 jmp recv_parity0 jmp recv_stop0 jmp send_startbit0 jmp send_bit0 jmp send_bit1 jmp send_bit2 jmp send_bit3 jmp send_bit4 jmp send_bit5 jmp send_bit6 jmp send_bit7 jmp send_parity0 jmp send_stop0 jmp send_stop1 rise1: rise0: pop a reti capture_a_isr: ;here we service interrupts from ps2 port <span class="hljs-number"><span class="hljs-number">0</span></span> ;we must make it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> short <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> possible... push a ;[<span class="hljs-number"><span class="hljs-number">5</span></span>] iord port0 ;[<span class="hljs-number"><span class="hljs-number">5</span></span>] iord port0 ;[<span class="hljs-number"><span class="hljs-number">5</span></span>] rrc ;[<span class="hljs-number"><span class="hljs-number">4</span></span>] jc rise0 ;[<span class="hljs-number"><span class="hljs-number">4</span></span>] mov a,[status0] ;[<span class="hljs-number"><span class="hljs-number">5</span></span>] asl ;[<span class="hljs-number"><span class="hljs-number">4</span></span>] jacc snd_recv_tabl0 ;[<span class="hljs-number"><span class="hljs-number">7</span></span>+<span class="hljs-number"><span class="hljs-number">5</span></span>] - <span class="hljs-number"><span class="hljs-number">44</span></span> ticks ;<span class="hljs-comment"><span class="hljs-comment">------------------------------------------------------------------------------- recv_startbit0_: inc [status1] mov a,PS2_WD_TIMEOUT mov [ps2_wd_b],a pop a reti recv_bit0_: recv_bit1_: recv_bit2_: recv_bit3_: recv_bit4_: recv_bit5_: recv_bit6_: recv_bit7_: iord port1 rrc rrc ;now our strobed bit in flag C mov a,[sh_in_lo_reg_p1] rrc mov [sh_in_lo_reg_p1],a inc [status1] pop a reti recv_parity0_: inc [status1] pop a reti recv_stop0_: mov a,[flag_wait_fa_1] cmp a,1 jz filter_fa1 mov a,[sh_in_lo_reg_p1] ;[5] push x ;[5] mov x,[fifo_head_p1] ;[5] mov [x+fifo_p1],a ;[6] store our byte to fifo inc x ;[4] increment fifo head mov a,x ;[4] pop x ;[4] and a,00fh ;[4] fifo size is 16 byte? mov [fifo_head_p1],a ;[5] save new fifo ptr for future filter_fa1: mov a,0 ;[4] mov [status1],a ;[5] mov [flag_wait_fa_1],a mov [ps2_wd_b],a pop a ;[4] reti ;[8] - 63+44=107 ticks nop</span></span></code> </pre> <br>  Of course, many details disappear from memory, I don‚Äôt just remember many details.  I only know that the deeply reworked program has worked successfully even in Doom2.  This is what life-giving tallying does. <br><br>  And you know what?  Even now I was able to compile this old program of mine, just running the BAT file: <br><br><img src="https://habrastorage.org/files/70c/31c/62a/70c31c62a74a40bcbec3cf6309843b94.png"><br><br>  Interestingly, this story also had a sequel.  PS / 2 codes were converted to HID codes (the PS / 2 protocol itself was rather complicated, see <a href="https://marsohod.org/11-blog/57-ps2proto">marsohod.org/11-blog/57-ps2proto</a> ).  And when the customer is from a Southeast country, some of the keys there are not exactly like ours. <br><br><img src="https://habrastorage.org/files/cae/fd6/707/caefd6707bf8441aacd1b5ae6e095241.jpg"><br><br>  During the archaeological excavations in our office, I found a typical keyboard from those times - they sent it to us for testing.  There were other exotic options, but not all survived.  I remember there was a keyboard with additional keys katakana and hiragana - and what would it mean?  And the customer needs to do so that they work.  And how should they work?  What should happen when they are pressed? <br><br>  They did this: they took two identical computers and installed parallel on one PC - English windows 2000, and on the second PC - pure Japanese Windows 2000, all OSs were taken from MSDN subscriptions.  Two computers are needed to correctly answer questions in dialogs when installing Windows - we cannot read it and cannot translate as well.  Here is a parallel installation on two PCs somehow saved.  Later, the keyboard was connected to a PC with installed Japanese Windows and pressed these controversial keys trying to figure out what should happen when they were pressed.  That somehow solved the problem.  How long has it been ... <br><br>  So what happened: as a result, it was not possible to disassemble the shelves and put them in order.  On the contrary, I stirred up all the boxes and boxes in search of other artifacts that were valuable and interesting for an archaeologist ... So much interesting was found ... </div><p>Source: <a href="https://habr.com/ru/post/314756/">https://habr.com/ru/post/314756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314740/index.html">Atomic-tests and performance upgrading</a></li>
<li><a href="../314744/index.html">Translation: Anatomy of the Total War game engine, Part 1</a></li>
<li><a href="../314750/index.html">Dear Habr, I want you to better hear your usernames</a></li>
<li><a href="../314752/index.html">React'ive Panel'i</a></li>
<li><a href="../314754/index.html">9 million domain names are just numbers without letters</a></li>
<li><a href="../314758/index.html">Can a computer book remain relevant 30 years after writing?</a></li>
<li><a href="../314762/index.html">Early release or sustained?</a></li>
<li><a href="../314764/index.html">The basis of the system business - basic analytics</a></li>
<li><a href="../314766/index.html">Chrome extension hot reboot</a></li>
<li><a href="../314768/index.html">Interplanetary File System IPFS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>