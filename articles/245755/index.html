<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gradual increase in performance when applying vector permutation instructions from SSE to AVX3.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, the application requires the highest possible performance, and often it can help to achieve a transition to a new platform. And additional perf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gradual increase in performance when applying vector permutation instructions from SSE to AVX3.1</h1><div class="post__text post__text-html js-mediator-article">  Often, the application requires the highest possible performance, and often it can help to achieve a transition to a new platform.  And additional performance gains can be obtained not only due to architectural changes of the new platform, i.e.  increasing the frequency of the processor, memory bandwidth and other changes, but also through the use of new sets of processor commands.  This approach will be considered in this article on the example of vector instructions that appeared sequentially in Intel processors from SSE to the new AVX 3.1 instruction set, recently published in the corresponding specification on <a href="https://software.intel.com/en-us/blogs/2013/avx-512-instructions">the Intel company website</a> . <br><a name="habracut"></a><br>  The author of this article participates in the development of the <a href="https://software.intel.com/en-us/intel-ipp">Intel IPP</a> library, so this article discusses the performance gain using the example of one of the functions from this library.  I would like to hope that this article will be useful to the following categories of readers: <br><ul><li>  novice developers who want to get acquainted with a specific example of how using SIMD instructions can improve code performance; </li><li>  those who already have enough experience in using SIMD instructions and are interested in the new AVX3.1 instruction set for optimizing their applications. </li></ul><br>  In addition to these categories of readers, developers interested in optimizing their applications and wanting to minimize their costs of low-level optimization, this article can help to get acquainted closer with the IPP library. <br><br><h4>  The ippiSwapChannels_32f_C3C4R function </h4>  The IPP library contains optimized 32-bit and 64-bit versions for processors that support the SSSE3, SSE41, AVX, AVX2, AVX31 instruction sets.  Therefore, consider the possibilities of optimization using these data sets.  In general, IPP contains many functions for various data processing areas.  These functions implement both fairly difficult to understand mathematical algorithms, for example, Fourier transform, and algorithms that are not particularly difficult to understand.  It is this rather simple function <i>ippiSwapChannels_32f_C3C4R</i> that we will consider in this article, trying to consistently apply to it the sets of instructions from SSSE3 to AVX31. <br><br>  The API for this function is as follows. <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ippiSwapChannels_32f_C3C4R</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pSrc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> srcStep, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pDst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dstStep, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dstOrder[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val )</span></span></span></span></code> </pre> <br>  The function reads the original float image by the <i>pSrc</i> pointer in <i>srcStep increments</i> between rows and <i>width x height</i> , rearranges the channels in each pixel in accordance with the new <i>dstOrder</i> order <i>,</i> and records the resulting image by the <i>pDst</i> pointer.  The function can also write a user-specified fixed value <i>val</i> to the channel.  Duplication of channels in the output image is allowed.  The scheme of the function is shown in Figure 1. <br><img src="https://habrastorage.org/files/942/2d1/41e/9422d141e3464fed9d10447e3d937d5c.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  C code </h4>  The function code in C is fairly simple (see below).  In each iteration of the cycle, one pixel of the output image is formed; one of 3 possible actions can occur with each channel of the output pixel: <br><ul><li>  copy the pixel channel of the original image, if the index in <i>dstOrder is</i> less than 3; </li><li>  fit a fixed value val, if the index in <i>dstOrder</i> is 3; </li><li>  the old unmodified value is preserved if the index in <i>dstOrder is</i> greater than 3 </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> s, d, h, ord0 = dstOrder[<span class="hljs-number"><span class="hljs-number">0</span></span>], ord1 = dstOrder[<span class="hljs-number"><span class="hljs-number">1</span></span>], ord2 = dstOrder[<span class="hljs-number"><span class="hljs-number">2</span></span>], ord3 = dstOrder[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( s = <span class="hljs-number"><span class="hljs-number">0</span></span>, d = <span class="hljs-number"><span class="hljs-number">0</span></span>; d &lt; width*<span class="hljs-number"><span class="hljs-number">4</span></span>; s += <span class="hljs-number"><span class="hljs-number">3</span></span>, d += <span class="hljs-number"><span class="hljs-number">4</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord0 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d] = pSrc[s + ord0]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord0 == <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d] = val; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord1 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">1</span></span>] = pSrc[s + ord1]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord1 == <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">1</span></span>] = val; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord2 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">2</span></span>] = pSrc[s + ord2]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord2 == <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">2</span></span>] = val; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord3 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">3</span></span>] = pSrc[s + ord3]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ord3 == <span class="hljs-number"><span class="hljs-number">3</span></span> ) { pDst[d + <span class="hljs-number"><span class="hljs-number">3</span></span>] = val; } } pSrc = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)pSrc + srcStep); pDst = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)pDst + dstStep); }</code> </pre><br></div></div><br><h4>  First version of SIMD code using SSSE3 </h4>  And now, as planned, we will try to optimize this code using vector SIMD instructions up to AVX3.1.  We will use Intel Composer, and measure the performance of all code variants on the internal simulator of the server version of SkyLake, which supports the AVX31 - SKX set, since you need to evaluate the advantages of the new instructions without the influence of architectural changes.  For the compiler we also indicate the maximum possible level of optimization, the same for all variants of the code.  Measured in this way, the performance of the C code is taken as a certain arbitrary value <b>P = 1</b> . <br>  We hope that the reader is already familiar with the concept of vector registers, but if not, then you can <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">familiarize yourself with</a> and use the convenient <a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/">navigator intrinsikov</a> . <br>  So, let's see how it would be possible to vectorize, i.e.  rewrite the code for this function using SSE vector registers.  In accordance with the logic of the function, we need to rearrange the float elements within the vector register, so we need the appropriate instructions for rearranging the elements.  These instructions include the following instructions from the SSE kit: <br><pre> <code class="hljs markdown"> SHUFPS xmm1, xmm2/m128, imm8 UNPCKHPS xmm1, xmm2/m128 UNPCKLPS xmm1, xmm2/m128 <span class="hljs-strong"><span class="hljs-strong">__m128 _mm_shuffle_ps(__</span></span>m128 a, <span class="hljs-strong"><span class="hljs-strong">__m128 b, unsigned int mask). __</span></span>m128 <span class="hljs-emphasis"><span class="hljs-emphasis">_mm_</span></span>unpackhi<span class="hljs-emphasis"><span class="hljs-emphasis">_ps(_</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_m128, _</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_m128) _</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_m128 _</span></span>mm<span class="hljs-emphasis"><span class="hljs-emphasis">_unpacklo_</span></span>ps(<span class="hljs-strong"><span class="hljs-strong">__m128, __</span></span>m128)</code> </pre><br>  These instructions are very useful and they can also be used for our task, but the following problem arises.  The <i>SHUFPS</i> instruction has an immediate imm8 operand that forms a permutation of the elements.  The third parameter of this instruction is <i>imm8</i> - the value, i.e.  some constant.  If you try to use a variable in intrinsic, the compiler will generate an error.  And the <i>UNPCKHPS / UNPCKLPS instructions</i> alternate elements in registers in only one way.  <i>There are</i> quite a few possible permutations of the channels specified in <i>dstOrder</i> and, therefore, to implement all possible combinations, we would have to develop a code with a lot of branches and a different value of the <i>mask</i> parameter for every possible combination of channels.  This is a rather tedious task; moreover, today the initial SSE instruction set has been significantly expanded and the code can be made much simpler.  The generation closest to SSE, which contains a very useful instruction for our purposes, is called SSSE3.  And we are talking about instructions: <br><pre> <code class="cpp hljs"> PSHUFB xmm1, xmm2/m128 __m128i _mm_shuffle_epi8 (__m128i a, __m128i b)</code> </pre><br>  This instruction can be effectively used in a variety of algorithms, where several neighboring input elements are used to calculate a single output element.  This instruction rearranges the bytes of the receiver in a completely random order, and can also reset the byte when the high bit in the register is set to the mask, see Figure 2. <br><img src="https://habrastorage.org/files/834/be4/7cb/834be47cbb2448c7a72f99f1739d0b9d.jpg" alt="image"><br><br>  Despite the fact that the instruction swaps bytes, we can apply it to float data. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">int s, d, h, ord0 = dstOrder[0], ord1 = dstOrder[1], ord2 = dstOrder[2], ord3 = dstOrder[3]; __m128 xmm0, xmm1, xmm2, xmm3, xmm4, xmm5,xmm6, xmm7; __m128i xmm8 = _mm_set_epi8(4*ord3+3,4*ord3+2,4*ord3+1,4*ord3, 4*ord2+3,4*ord2+2,4*ord2+1,4*ord2, 4*ord1+3,4*ord1+2,4*ord1+1,4*ord1, 4*ord0+3,4*ord0+2,4*ord0+1,4*ord0); __m128i xmm9 = _mm_set_epi32(0,0,0,0);//unmodified channel mask __m128i xmm10 = _mm_set_epi32(0,0,0,0);//val if(ord3 &gt;= 3){ xmm8 = _mm_or_si128(xmm8, _mm_set_epi32(-1, 0, 0, 0)); if(ord3 &gt; 3){ xmm9 = _mm_or_si128(xmm9, _mm_set_epi32(-1, 0, 0, 0));} else { xmm10 = _mm_or_si128(xmm10, _mm_set_epi32(val, 0, 0, 0));}; } if(ord2 &gt;= 3){ xmm8 = _mm_or_si128(xmm8, _mm_set_epi32( 0,-1, 0, 0)); if(ord2 &gt; 3){ xmm9 = _mm_or_si128(xmm9, _mm_set_epi32( 0, -1, 0, 0));} else { xmm10 = _mm_or_si128(xmm10, _mm_set_epi32( 0, val,0, 0));} } if(ord1 &gt;=3){ xmm8 = _mm_or_si128(xmm8, _mm_set_epi32( 0, 0,-1, 0)); if(ord1 &gt; 3){xmm9 = _mm_or_si128(xmm9, _mm_set_epi32( 0, 0,-1, 0));} else {xmm10 = _mm_or_si128(xmm10, _mm_set_epi32( 0, 0,val, 0));} } if(ord0 &gt;= 3){ xmm8 = _mm_or_si128(xmm8, _mm_set_epi32( 0, 0, 0,-1)); if(ord0 &gt; 3){xmm9 = _mm_or_si128(xmm9, _mm_set_epi32( 0, 0, 0,-1));} else {xmm10 = _mm_or_si128(xmm10, _mm_set_epi32( 0, 0, 0,val));} } for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3*4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4*4</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd(pSrc+s</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">g0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">r0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss(pSrc+s+2</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd(pSrc+s</span></span></span></span><span class="xml"><span class="hljs-tag"> +</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss(pSrc+s+2+3);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd(pSrc+s</span></span></span></span><span class="xml"><span class="hljs-tag"> +</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm5</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss(pSrc+s+2+6);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm6</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd(pSrc+s</span></span></span></span><span class="xml"><span class="hljs-tag"> +</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm7</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss(pSrc+s+2+9);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd(xmm0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">g0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">r0</span></span></span></span><span class="xml"><span class="hljs-tag">    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd(xmm2,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd(xmm4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm5</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd(xmm6,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm7</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps(pDst+d+0);</span></span></span></span><span class="xml"><span class="hljs-tag"> //   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm5</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps(pDst+d+4);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm6</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps(pDst+d+8);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm7</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps(pDst+d+12);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_shuffle_epi8(xmm0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm8</span></span></span></span><span class="xml"><span class="hljs-tag">); //      </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_shuffle_epi8(xmm1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm8</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_shuffle_epi8(xmm2,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm8</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_shuffle_epi8(xmm3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm8</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_and_ps(xmm4,xmm9);</span></span></span></span><span class="xml"><span class="hljs-tag"> //     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dst</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm5</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_and_ps(xmm5,xmm9);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm6</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_and_ps(xmm6,xmm9);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm7</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_and_ps(xmm7,xmm9);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm0,xmm4);</span></span></span></span><span class="xml"><span class="hljs-tag"> //      </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm1,xmm5);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm2,xmm6);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm3,xmm7);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm0,xmm10);</span></span></span></span><span class="xml"><span class="hljs-tag"> //    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span></span><span class="xml"><span class="hljs-tag">  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm1,xmm10);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm2,xmm10);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm3,xmm10);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> , </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag">); //  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag">+ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag">+ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">12</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__m128</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd(pSrc+s</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss(pSrc+s+2);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd(xmm0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps(pDst+d);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_shuffle_epi8(xmm0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm8</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_and_ps(xmm4,xmm9);</span></span></span></span><span class="xml"><span class="hljs-tag"> //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm0,xmm4);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_or_ps(xmm0,xmm10);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(float*)((char*)pSrc</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">srcStep</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(float*)((char*)pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstStep</span></span></span></span><span class="xml"><span class="hljs-tag">); }</span></span></span></span></code> </pre><br></div></div><br>  As you can see, our SSSE3 code uses quite a few SIMD instructions, and the comment line explains why they are used.  The <i>_mm_unpacklo_pd</i> instructions <i>are</i> used to merge into one XMM register the values ‚Äã‚Äãread into different registers.  The instructions <i>_mm_and_ps</i> , <i>_mm_or_ps</i> are used to merge by mask with the unmodified channel and the <i>val</i> value.  We directly use the <i>_mm_shuffle_epi8</i> instruction to rearrange the elements.  We measure how much time it takes to execute and get <b>P = 0.4</b> .  Despite the fact that the code looks more cumbersome compared to the C code, the performance increase was approximately 2.5X.  And this is a pretty good result. <br><br><h4>  Second version of SIMD code using AVX </h4>  Today, top-of-the-line Intel processors have long supported at least the AVX instruction set.  Vector registers used in AVX instructions have a length of 256 bits and, accordingly, 2 times wider than 128 bit SSE registers.  However, AVX contains two significant limitations for us.  First, AVX contains 256-bit permutation instructions only for float and double data types and we cannot use the 256-bit analogue <i>_mm_shuffle_epi8</i> .  Secondly, after the release of the AVX instruction set, the so-called lane concept for vector instructions was introduced.  In this concept, one 256-bit AVX register is a bundle of two 128-bit registers, called the word lane.  Most 256-bit extensions of 128-bit horizontal-access instructions work only inside each lane.  Thus, often the AVX version of the code that already has the SSE version looks like it is shown in Figure.  3 <br><img src="https://habrastorage.org/files/79b/fd1/fd8/79bfd1fd81a24a239ccb4bdcba20b6b2.jpg" alt="image"><br>  Therefore, the AVX version of our code might look something like this: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"> int s, d, h, ord0 = dstOrder[0], ord1 = dstOrder[1], ord2 = dstOrder[2], ord3 = dstOrder[3]; __m256 ymm0, ymm1, ymm2, ymm3, ymm4, ymm5,ymm6, ymm7; __m128 xmm0, xmm1, xmm2,xmm3; __m256 ymm10= _mm256_setzero_ps();//val __m256i ymm8 = _mm256_set_epi32( dstOrder[3],dstOrder[2],dstOrder[1],dstOrder[0], dstOrder[3],dstOrder[2],dstOrder[1],dstOrder[0]); __m256 ymm9 = _mm256_setzero_ps(); __m256 ymm11 = _mm256_setzero_ps(); __m256i YMM_N[4], YMM_V[4]; YMM_N[0]= _mm256_set_m128(_mm_set_epi32( 0, 0, 0,-1), _mm_set_epi32( 0, 0, 0,-1)); YMM_N[1]= _mm256_set_m128(_mm_set_epi32( 0, 0,-1, 0), _mm_set_epi32( 0, 0,-1, 0)); YMM_N[2]= _mm256_set_m128(_mm_set_epi32( 0,-1, 0, 0), _mm_set_epi32( 0,-1, 0, 0)); YMM_N[3]= _mm256_set_m128(_mm_set_epi32(-1, 0, 0, 0), _mm_set_epi32(-1, 0, 0, 0)); YMM_V[0]= _mm256_set_m128(_mm_set_epi32( 0 , 0, 0,val), _mm_set_epi32( 0 , 0, 0,val)); YMM_V[1]= _mm256_set_m128(_mm_set_epi32( 0 , 0,val, 0), _mm_set_epi32( 0 , 0,val, 0)); YMM_V[2]= _mm256_set_m128(_mm_set_epi32( 0 ,val, 0, 0), _mm_set_epi32( 0 ,val, 0, 0)); YMM_V[3]= _mm256_set_m128(_mm_set_epi32(val, 0, 0, 0), _mm_set_epi32(val, 0, 0, 0)); //  for(s=0;s</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">4;s++){</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstOrder</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">] &gt;</span></span></span><span class="xml">= 3){ ymm9 = _mm256_or_ps(ymm9, YMM_N[s]); if(dstOrder[s] &gt; 3){ ymm11 = _mm256_or_si256(ymm11, YMM_N[s]);} //   else { ymm10 = _mm256_or_si256(ymm10, YMM_V[s]);}; //val  } } for( h = 0; h </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">(; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;(~</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">))*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3*2,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4*2</span></span></span></span><span class="xml"><span class="hljs-tag"> ) {//  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_loadu_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_sd</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag"> +</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_load_ss</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> +</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm_unpacklo_pd</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm3</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_set_m128</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xmm0</span></span></span></span><span class="xml"><span class="hljs-tag"> ); //    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">256</span></span></span></span><span class="xml"><span class="hljs-tag">  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_loadu_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag"> ); //   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_permutevar_ps(ymm0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm8</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_and_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm11</span></span></span></span><span class="xml"><span class="hljs-tag">); //    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_andnot_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm9</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> ); //     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span></span><span class="xml"><span class="hljs-tag">  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span></span><span class="xml"><span class="hljs-tag"> ); //    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm10</span></span></span></span><span class="xml"><span class="hljs-tag"> ); //  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span></span><span class="xml"><span class="hljs-tag">  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_mm256_storeu_ps</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span></span><span class="xml"><span class="hljs-tag">); } //   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(float</span></span></span></span><span class="xml"><span class="hljs-tag"> *)((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">char</span></span></span></span><span class="xml"><span class="hljs-tag">*)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">srcStep</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(float</span></span></span></span><span class="xml"><span class="hljs-tag"> *)((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">char</span></span></span></span><span class="xml"><span class="hljs-tag">*)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dstStep</span></span></span></span><span class="xml"><span class="hljs-tag">); }</span></span></span></span></code> </pre><br></div></div><br>  Naturally, the question may arise: why in our 256-bit AVX code is loading using 128-bit instructions?  The point is that the <i>VPERMPS</i> instruction in the string was used in our code <br>  <i>ymm0 = _mm256_permutevar_ps (ymm0, ymm8)</i> <br>  As already explained above, this instruction rearranges the elements within the lower and upper parts of the register (or, alternatively, lane) independently.  Therefore, despite the fact that 2 pixels lie in the memory side by side, we are forced to read them in such a way that they fall into different lane.  Notice how the ymm8 register-mask is formed; it contains exactly the same values ‚Äã‚Äãin the upper and lower part of the permutation.  The code is written in such a way that the number of iterations in the cycles is preserved and does not affect the final performance.  Measure performance: <b>P = 0.31</b> .  Thus, the increase in AVX code in relation to C amounted to 3.2X, while SSSE3 had 2.48X <br><br><h4>  Third version of SIMD code using AVX2 </h4>  The development of AVX was the AVX2 set.  The length of vector registers in it has not changed, but new instructions have appeared, which will help us to speed up the code.  In AVX2 appeared acrosslane permutation instructions <i>_mm256_permutevar8x32_ps</i> .  These instructions allow you to rearrange the elements within the 256-bit register in an arbitrary way, and our code could look like this. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs xml"> __m256i ymm8 = _mm256_set_epi32( dstOrder[3]+3,dstOrder[2]+3,dstOrder[1]+3,dstOrder[0]+3, dstOrder[3],dstOrder[2],dstOrder[1],dstOrder[0]); for(; d <span class="hljs-tag"><span class="hljs-tag">&lt; (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">&amp;(~</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">))*</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">3*2,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">4*2</span></span></span><span class="hljs-tag"> ) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_loadu_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_loadu_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag"> ); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_permutevar8x32_ps(ymm0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm8</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_and_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm11</span></span></span><span class="hljs-tag">); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_andnot_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm9</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inverse</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">join</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm10</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">join</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_mm256_storeu_ps</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">); }</span></span></code> </pre><br></div></div><br>  Notice that the permutation mask in the <i>ymm8</i> register has changed completely and is <i>pass</i> -through throughout the register, i.e.  indices in it refer to the whole 256 bit register in general. <br>  However, there is a problem with this code in how the <i>ymm0</i> register is <i>read</i> .  It loads the extra 2 float elements.  It‚Äôs wrong to do so, because reading abroad of an image can happen and the read instruction on the mask that appears in AVX2 will help us again <br>  <i>__m256i _mm256_maskload_epi32 (int const *, __m256i);</i> <br>  This instruction reads the necessary elements from memory and does not read anything superfluous, which prevents possible memory segmentation error.  Now our correct code will look like this. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs xml"> __m256i ld_mask = _mm256_set_epi32(0,0,-1,-1,-1,-1,-1,-1); for(; d <span class="hljs-tag"><span class="hljs-tag">&lt; (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">&amp;(~</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">))*</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">3*2,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">4*2</span></span></span><span class="hljs-tag"> ) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_maskload_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ld_mask</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_loadu_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag"> ); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_permutevar8x32_ps(ymm0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm8</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_and_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm11</span></span></span><span class="hljs-tag">); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_andnot_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm9</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inverse</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm4</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">join</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm10</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">join</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_mm256_storeu_ps</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">); }</span></span></code> </pre><br></div></div><br>  The performance of this code is <b>P = 0.286</b> .  The acceleration thus changed from k = 3.2X to k = 3.5X.  In addition to reading the mask, we can use and save the unmodified channel without modification, using the instruction <br>  <i>void _mm256_maskstore_ps (float *, __m256i, __m256);</i> <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs xml"> __m256 ymmNA = _mm256_set_epi32( 0,-1,-1,-1, 0,-1,-1,-1); for(; d <span class="hljs-tag"><span class="hljs-tag">&lt; (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">&amp;(~</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">))*</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">3*2,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag"> += </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">4*2</span></span></span><span class="hljs-tag"> ) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_maskload_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pSrc</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ld_mask</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_permutevar8x32_ps(ymm0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm8</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_andnot_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm9</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apply</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unmodified</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inverse</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">_mm256_or_ps</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm10</span></span></span><span class="hljs-tag"> ); //</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">join</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">val</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_mm256_maskstore_epi32</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pDst</span></span></span><span class="hljs-tag">+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">d</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymmNA</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ymm0</span></span></span><span class="hljs-tag">); }</span></span></code> </pre><br></div></div><br>  Please note that the 128-bit predecessor of this instruction <br>  <i>void _mm_maskmoveu_si128 (__ m128i, __m128i, char *)</i> <br>  saves the data using a non-temporal record, but in AVX versions <i>_mm256_maskstore_ps</i> and <i>_mm_maskstore_ps</i> it was decided to abandon this mechanism.  What is a non-temporal recording and how it is used in the IPP library will be discussed in one of the following articles.  We measure the performance and get a small increase, <b>P = 0.27</b> , k = 3.7X. <br><br><h4>  SIMD version with AVX512 </h4>  So, we turn to the most interesting part of our article - code optimization on AVX512. <br>  As the name suggests, the length of vector registers has doubled from 256 bits to 512. The lane concept has also been preserved.  The second innovation is that mask operations have become widespread and now affect most vector operations.  For this special mask registers were introduced.  Mask registers have their own data type <i>__mmask8</i> , <i>__mmask16</i> , <i>__mmask32</i> , <i>__mmask64</i> , but you can operate with them as integer data types, since they are also declared in the header file <i>zmmintrin.h</i> .  The use of masks makes the AVX512 cycle-processing feature quite minimalistic. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">int</span></span> s, d, h, ord0 = dstOrder[<span class="hljs-number"><span class="hljs-number">0</span></span>], ord1 = dstOrder[<span class="hljs-number"><span class="hljs-number">1</span></span>], ord2 = dstOrder[<span class="hljs-number"><span class="hljs-number">2</span></span>], ord3 = dstOrder[<span class="hljs-number"><span class="hljs-number">3</span></span>]; __mmask16 mskv; //mask <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> joing <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> val __mmask16 mska; //mask <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> unmodified channel __m512 z0,z1,z2,z3,z4,z5; __m512i zv = _mm512_set1_epi32(val); __m512i zi0 = _mm512_set_epi32(ord3+<span class="hljs-number"><span class="hljs-number">9</span></span>,ord2+<span class="hljs-number"><span class="hljs-number">9</span></span>,ord1+<span class="hljs-number"><span class="hljs-number">9</span></span>,ord0+<span class="hljs-number"><span class="hljs-number">9</span></span>, ord3+<span class="hljs-number"><span class="hljs-number">6</span></span>,ord2+<span class="hljs-number"><span class="hljs-number">6</span></span>,ord1+<span class="hljs-number"><span class="hljs-number">6</span></span>,ord0+<span class="hljs-number"><span class="hljs-number">6</span></span>, ord3+<span class="hljs-number"><span class="hljs-number">3</span></span>,ord2+<span class="hljs-number"><span class="hljs-number">3</span></span>,ord1+<span class="hljs-number"><span class="hljs-number">3</span></span>,ord0+<span class="hljs-number"><span class="hljs-number">3</span></span>, ord3+<span class="hljs-number"><span class="hljs-number">0</span></span>,ord2+<span class="hljs-number"><span class="hljs-number">0</span></span>,ord1+<span class="hljs-number"><span class="hljs-number">0</span></span>,ord0+<span class="hljs-number"><span class="hljs-number">0</span></span>); mska = mskv = <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dstOrder[i] == <span class="hljs-number"><span class="hljs-number">3</span></span>) { mskv ^= (<span class="hljs-number"><span class="hljs-number">0x1111</span></span>&lt;&lt;i); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dstOrder[i] &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { mska ^= (<span class="hljs-number"><span class="hljs-number">0x1111</span></span>&lt;&lt;i); } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( h = <span class="hljs-number"><span class="hljs-number">0</span></span>; h &lt; height; h++ ) { s = <span class="hljs-number"><span class="hljs-number">0</span></span>; d = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(; d &lt; ((width*<span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; (~<span class="hljs-number"><span class="hljs-number">15</span></span>)); s += <span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span>, d += <span class="hljs-number"><span class="hljs-number">4</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span> ) { z0 = _mm512_mask_loadu_ps(_mm512_setzero_ps(), <span class="hljs-number"><span class="hljs-number">0xFFF</span></span>,(<span class="hljs-type"><span class="hljs-type">float</span></span> *)(pSrc+s)); z0 = _mm512_mask_permutexvar_ps(zv,mskv,zi0, z0); _mm512_mask_storeu_ps(pDst+d, mska, z0); } pSrc = (<span class="hljs-type"><span class="hljs-type">float</span></span> *)((<span class="hljs-type"><span class="hljs-type">char</span></span>*)pSrc + srcStep); pDst = (<span class="hljs-type"><span class="hljs-type">float</span></span> *)((<span class="hljs-type"><span class="hljs-type">char</span></span> *)pDst + dstStep); }</code> </pre><br></div></div><br>  The number of intrinsics in one iteration of the cycle has been reduced to three, and each of them uses a mask.  First intrinsic <br>  <i>z0 = _mm512_mask_loadu_ps (_mm512_setzero_ps (), 0xFFF, (float *) (pSrc + s))</i> <br>  uses the mask 0xFFF to read from memory 4 RGB pixels or 12 floats, in binary form <i>0xFFF = 1111111111111111b</i> .  Next intrinsic <br>  <i>z0 = _mm512_mask_permutexvar_ps (zv, mskv, zi0, z0)</i> <br>  performs 2 functions at once: rearranges the input pixel channels and combines them according to the mask with the value <i>val</i> .  The <i>mskv</i> mask <i>is</i> formed before the start of the cycle and the mask bits are used as follows: the bit value equal to '1' means ‚Äúput the result of operations in the result register‚Äù, and the '0' - ‚Äúsave the value of the register that is specified before the mask‚Äù, in our case zv .  Third intrinsic <br>  <i>_mm512_mask_storeu_ps (pDst + d, mska, z0)</i> <br>  It stores the received 4 pixels in memory, while it does not write anything to the unmodified channel.  The performance of the code is <b>P = 0.183</b> , k = 5.44X. <br>  The reader can compare the SSSE3 code with the AVX512 code, which uses only 3 intrinsics.  It is the brevity of the avx512 code that inspired the author to write this article. <br><br>  Summary table of productivity growth. <br><img src="https://habrastorage.org/files/066/0c3/190/0660c31906554f6da31ffaeb0b040145.png"><br><br><h4>  Conclusion </h4>  Of course, the use of masks in this algorithm is quite obvious, but they can be used in other, more complex algorithms, and this will be another article. <br>  After reading this article, the reader can try to use SIMD code in their applications, and the reader, who already has this experience, can appreciate the advantages of crosslane permutation instructions and instructions with masks in new Intel processors that support the AVX512 instruction set. <br>  I would also like to note that this article presents an insignificant part of the optimization techniques used in the IPP library and allowing it to achieve its unique performance. <br>  The reader may try to use <a href="https://software.intel.com/en-us/intel-ipp">the IPP library</a> in his own application, freeing up the possibilities for solving his applied problems.  An additional effect of using IPP will be that after entering the market for processors with the AVX512 instruction set, the IPP library will already have a version of the most requested functions optimized for AVX512. </div><p>Source: <a href="https://habr.com/ru/post/245755/">https://habr.com/ru/post/245755/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245735/index.html">Search for the best sequence of viewing the list of 250 best movies using the Wolfram Language (Mathematica)</a></li>
<li><a href="../245737/index.html">Web Design Books</a></li>
<li><a href="../245739/index.html">Japanese startup attracted $ 90 million for advertising on the moon</a></li>
<li><a href="../245745/index.html">Composer. It is not safe to use packagist and a private source of packages at the same time.</a></li>
<li><a href="../245751/index.html">Course pixel art 6</a></li>
<li><a href="../245759/index.html">Google Chrome will mark HTTP sites as unsafe</a></li>
<li><a href="../245763/index.html">Some tips for speeding up Drupal</a></li>
<li><a href="../245765/index.html">Prelatement to the decade of Openbravo POS</a></li>
<li><a href="../245767/index.html">Expressive JavaScript: Project: Paint</a></li>
<li><a href="../245775/index.html">Expressive javascript: Node.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>