<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collected the user activity in WPF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, we talked about how you can log user actions in WinForms applications: It fell by itself, or koloboks lead the investigation . But what if y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collected the user activity in WPF</h1><div class="post__text post__text-html js-mediator-article">  Recently, we talked about how you can log user actions in WinForms applications: <a href="https://habrahabr.ru/company/devexpress/blog/342530/">It fell by itself, or koloboks lead the investigation</a> .  But what if you have WPF?  No problem, and WPF has life! <br><br> <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B5%25D0%25BD%25D0%25B7%25D0%25B5%25D0%25BB%25D1%258C_%25D0%25B8_%25D0%2593%25D1%2580%25D0%25B5%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C"><img src="https://habrastorage.org/webt/jv/zd/h_/jvzdh_ory6pzwf7okawfaql9jei.png"></a> <br><br>  In WPF, you will not need to hang any hooks and touch a terrible Winapi; we will not go outside WPF itself.  First, remember that we have <a href="https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/routed-events-overview">routed events</a> , and you can subscribe to them.  In principle, this is all we need to know in order to accomplish the task :) <br><a name="habracut"></a><br>  So what do we want to log?  Keyboard, mouse and focus changes.  For this, the UIElement class has the following events: <a href="https://msdn.microsoft.com/en-us/library/system.windows.uielement.previewmousedownevent(v%3Dvs.110).aspx">PreviewMouseDownEvent</a> , <a href="https://msdn.microsoft.com/en-us/library/system.windows.uielement.previewmouseupevent(v%3Dvs.110).aspx">PreviewMouseUpEvent</a> , <a href="https://msdn.microsoft.com/en-us/library/system.windows.uielement.previewkeydownevent(v%3Dvs.110).aspx">PreviewKeyDownEvent</a> , <a href="https://msdn.microsoft.com/en-us/library/system.windows.uielement.previewkeyupevent(v%3Dvs.110).aspx">PreviewKeyUpEvent</a> , <a href="https://msdn.microsoft.com/en-us/library/system.windows.uielement.previewtextinputevent(v%3Dvs.110).aspx">PreviewTextInputEvent</a> and <a href="https://msdn.microsoft.com/en-us/library/system.windows.input.keyboard.gotkeyboardfocus(v%3Dvs.110).aspx">Keyboard.GotKeyboardFocus</a> and <a href="https://msdn.microsoft.com/en-us/library/system.windows.input.keyboard.lostkeyboardfocus(v%3Dvs.110).aspx">Keyboard.LostKeyboardFocus</a> for focus.  Now we need to subscribe to them: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs">EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), UIElement.PreviewMouseDownEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MouseButtonEventHandler(MouseDown), <span class="hljs-literal"><span class="hljs-literal">true</span></span> );</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Subscribe to other events</b> <div class="spoiler_text"><pre> <code class="cs hljs">EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), UIElement.PreviewMouseUpEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MouseButtonEventHandler(MouseUp), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), UIElement.PreviewKeyDownEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyEventHandler(KeyDown), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), UIElement.PreviewKeyUpEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyEventHandler(KeyUp), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), UIElement.PreviewTextInputEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextCompositionEventHandler(TextInput), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), Keyboard.GotKeyboardFocusEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyboardFocusChangedEventHandler(OnKeyboardFocusChanged), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UIElement), Keyboard.LostKeyboardFocusEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyboardFocusChangedEventHandler(OnKeyboardFocusChanged), <span class="hljs-literal"><span class="hljs-literal">true</span></span> );</code> </pre></div></div><br>  Now the main thing is to write handlers of all these events, to collect data on them about which button was pressed, from whom, how many times ... fu, boredom.  Here, let's take a better look at the cat: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e43/260/49d/e4326049dbf005ac685341ef96fb0af8.jpg" alt="image"><br><br>  Well, if you really want to see the code, this can be done by opening the block below. <br><br><div class="spoiler">  <b class="spoiler_title">a lot of code</b> <div class="spoiler_text">  Let's start writing handlers for these events.  Let's start with the method that collects common information for all events: the name and type of the element that sent this event: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">Dictionary&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollectCommonProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FrameworkElement source</span></span></span><span class="hljs-function">)</span></span> { Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; properties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); properties[<span class="hljs-string"><span class="hljs-string">"Name"</span></span>] = source.Name; properties[<span class="hljs-string"><span class="hljs-string">"ClassName"</span></span>] = source.GetType().ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> properties; }</code> </pre><br>  The Name property appears in our FrameworkElement, so as a source, we accept an object of this type. <br><br>  Now we will process mouse events, in them we will collect information about which key was pressed and whether it was a double click or not: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MouseDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, MouseButtonEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement source = sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(source == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(source); LogMouse(properties, e, isUp: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MouseUp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, MouseButtonEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement source = sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(source == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(source); LogMouse(properties, e, isUp: <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogMouse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; properties, MouseButtonEventArgs e, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp</span></span></span><span class="hljs-function">)</span></span> { properties[<span class="hljs-string"><span class="hljs-string">"mouseButton"</span></span>] = e.ChangedButton.ToString(); properties[<span class="hljs-string"><span class="hljs-string">"ClickCount"</span></span>] = e.ClickCount.ToString(); Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.ClickCount == <span class="hljs-number"><span class="hljs-number">2</span></span>) { properties[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = <span class="hljs-string"><span class="hljs-string">"doubleClick"</span></span>; item.Event = BreadcrumbEvent.MouseDoubleClick; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(isUp) { properties[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = <span class="hljs-string"><span class="hljs-string">"up"</span></span>; item.Event = BreadcrumbEvent.MouseUp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { properties[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = <span class="hljs-string"><span class="hljs-string">"down"</span></span>; item.Event = BreadcrumbEvent.MouseDown; } item.CustomData = properties; AddBreadcrumb(item); }</code> </pre><br>  In keyboard events we will collect Key.  However, we don‚Äôt want to accidentally reduce the entered passwords, so I would like to understand where the input is going to replace the Key value with Key.Multiply in the case of a password input.  We can learn this using the <a href="https://msdn.microsoft.com/en-us/library/system.windows.automation.peers.automationpeer.ispassword(v%3Dvs.110).aspx">AutomationPeer.IsPassword</a> method.  And another nuance, it does not make sense to make such a replacement when you press the navigation keys, because they definitely can not be part of the password, but can be the starting point for any other actions.  For example, changing focus by pressing Tab.  The result is the following: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KeyDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, KeyEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement source = sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(source == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(source); LogKeyboard(properties, e.Key, isUp: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, isPassword: CheckPasswordElement(e.OriginalSource <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UIElement)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KeyUp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, KeyEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement source = sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(source == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(source); LogKeyboard(properties, e.Key, isUp: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, isPassword: CheckPasswordElement(e.OriginalSource <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UIElement)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogKeyboard</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; properties, Key key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isPassword</span></span></span><span class="hljs-function">)</span></span> { properties[<span class="hljs-string"><span class="hljs-string">"key"</span></span>] = GetKeyValue(key, isPassword).ToString(); properties[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = isUp ? <span class="hljs-string"><span class="hljs-string">"up"</span></span> : <span class="hljs-string"><span class="hljs-string">"down"</span></span>; Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = isUp ? BreadcrumbEvent.KeyUp : BreadcrumbEvent.KeyDown; item.CustomData = properties; AddBreadcrumb(item); } <span class="hljs-function"><span class="hljs-function">Key </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetKeyValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Key key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isPassword</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!isPassword) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(key) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Tab: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Left: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Right: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Up: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Down: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.PageUp: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.PageDown: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.LeftCtrl: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.RightCtrl: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.LeftShift: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.RightShift: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Enter: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.Home: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Key.End: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Key.Multiply; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckPasswordElement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UIElement targetElement</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(targetElement != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { AutomationPeer automationPeer = GetAutomationPeer(targetElement); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (automationPeer != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ? automationPeer.IsPassword() : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  Let's go to TextInput.  Here, in principle, everything is simple, we collect the entered text and do not forget about passwords: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TextInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, TextCompositionEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement source = sender <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(source == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(source); LogTextInput(properties, e, CheckPasswordElement(e.OriginalSource <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UIElement)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogTextInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; properties, TextCompositionEventArgs e, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isPassword</span></span></span><span class="hljs-function">)</span></span> { properties[<span class="hljs-string"><span class="hljs-string">"text"</span></span>] = isPassword ? <span class="hljs-string"><span class="hljs-string">"*"</span></span> : e.Text; properties[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = <span class="hljs-string"><span class="hljs-string">"press"</span></span>; Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = BreadcrumbEvent.KeyPress; item.CustomData = properties; AddBreadcrumb(item); }</code> </pre><br>  And finally, the focus remained: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnKeyboardFocusChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, KeyboardFocusChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { FrameworkElement oldFocus = e.OldFocus <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(oldFocus != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(oldFocus); LogFocus(properties, isGotFocus: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } FrameworkElement newFocus = e.NewFocus <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(newFocus != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(newFocus); LogFocus(properties, isGotFocus: <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogFocus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; properties, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isGotFocus</span></span></span><span class="hljs-function">)</span></span> { Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = isGotFocus ? BreadcrumbEvent.GotFocus : BreadcrumbEvent.LostFocus; item.CustomData = properties; AddBreadcrumb(item); }</code> </pre></div></div><br>  Handlers are ready, it's time to test.  Let's make a simple application for this, add Logify to it and go ahead: <br><br><img src="https://habrastorage.org/webt/8v/qg/-v/8vqg-vmou7tg1w8j9-p6r0vw_r8.png"><br><br>  Run it, enter q in the text field and drop the application by clicking on Throw Exception and see what we have gathered.  It turned out fear and horror, so put it under the spoiler.  If you just want to look at it, click below: <br><br><div class="spoiler">  <b class="spoiler_title">Very large log</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/oc/kc/9w/ockc9wleztdex2yixzf8qbtj-bs.png"></div></div><br>  Ehhh ... I think you thought something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/169/f28/5cb/169f285cbbc69cb976c6741579ee7fce.jpg" alt="image"><br><br>  I thought so :) <br><br>  Let's figure out what's wrong with us, and why such a messy of incomprehensible messages has turned out. <br><br>  The first thing my eyes cling to is a bunch of events that the focus is walking between two elements.  At the same time, the volume of these messages is almost half of the total volume of logs.  The fact is that the focus was actually changed once, but we receive a notification about this change from each element in the tree to which we are subscribed.  Well, we are not from a joke, we do not need to repeat several times.  Therefore, let's enter the test: <br><br><pre> <code class="cs hljs">IInputElement FocusedElement { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnKeyboardFocusChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, KeyboardFocusChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FocusedElement != e.NewFocus) { FrameworkElement oldFocus = FocusedElement <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(oldFocus != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(oldFocus); LogFocus(properties, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } FrameworkElement newFocus = e.NewFocus <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FrameworkElement; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(newFocus != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = CollectCommonProperties(newFocus); LogFocus(properties, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } FocusedElement = e.NewFocus; } }</code> </pre><br>  Let's see what happened: <br><br><img src="https://habrastorage.org/webt/uu/bu/td/uubutdndxztq8o1dxghko64hzhe.png"><br><br>  Here, much more beautiful :) <br><br>  Now we see that we have soooo many logs for the same event, as the routed events go through the tree of elements, and each of them notifies us.  We have a small tree of elements, and there is already plenty of porridge in the logs.  What will be on the real application?  Even afraid to think.  We obviously cannot discard all these logs, except the first or the last.  If you have a large enough visual tree, then it‚Äôs unlikely that you will be told something about the messages that were clicked in the Window, or in the TextBox, especially if there are no names for the elements.  But we are able to reduce this list so that it is easy to read and at the same time understand exactly where the event occurred. <br><br>  We have subscribed to events at UIElement, but, in fact, we can ignore messages from a large part of his heirs.  For example, we are hardly interested in a keystroke notification from a Border or TextBlock.  These elements for the most part do not take part in actions.  It seems to me that the golden mean will be to sign up for events at Control. <br><br><pre> <code class="cs hljs">EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), UIElement.PreviewMouseDownEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MouseButtonEventHandler(MouseDown), <span class="hljs-literal"><span class="hljs-literal">true</span></span> );</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Other events</b> <div class="spoiler_text"><pre> <code class="cs hljs">EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), UIElement.PreviewMouseUpEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MouseButtonEventHandler(MouseUp), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), UIElement.PreviewKeyDownEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyEventHandler(KeyDown), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), UIElement.PreviewKeyUpEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyEventHandler(KeyUp), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), UIElement.PreviewTextInputEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextCompositionEventHandler(TextInput), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), Keyboard.GotKeyboardFocusEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyboardFocusChangedEventHandler(OnKeyboardFocusChanged), <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); EventManager.RegisterClassHandler( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Control), Keyboard.LostKeyboardFocusEvent, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyboardFocusChangedEventHandler(OnKeyboardFocusChanged), <span class="hljs-literal"><span class="hljs-literal">true</span></span> );</code> </pre></div></div><br>  As a result, the log turned out to be much more readable, and, even with a large number of events, it is not terrible to watch it: <br><br><img src="https://habrastorage.org/webt/rf/ae/5o/rfae5oyeexxq3l0okbvlrpmdgmw.png"><br><br>  Of course, there is no limit to perfection, and we still have a few tricks on how to make this log even more readable.  This will be one of our next articles. </div><p>Source: <a href="https://habr.com/ru/post/343358/">https://habr.com/ru/post/343358/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343346/index.html">Distribution video. Ambush: nginx or php?</a></li>
<li><a href="../343348/index.html">3 Unusual Linux Networking Cases</a></li>
<li><a href="../343350/index.html">‚ÄúDo you want to be a system architect? There is only light and purity ... "</a></li>
<li><a href="../343352/index.html">How we did a huge amount of communication for a rather big security structure</a></li>
<li><a href="../343356/index.html">Interpolation polynomial on arbitrary functions</a></li>
<li><a href="../343362/index.html">Broadcast h264 video without transcoding and delay</a></li>
<li><a href="../343364/index.html">Simplest RESTful service on Kotlin and Spring boot</a></li>
<li><a href="../343366/index.html">UX-design: common misconceptions and myths</a></li>
<li><a href="../343368/index.html">Accelerate Ansible</a></li>
<li><a href="../343370/index.html">EPAM + universities: how we work with universities in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>