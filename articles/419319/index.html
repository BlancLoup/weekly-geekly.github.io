<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to run Istio using Kubernetes in production. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is Istio ? This is the so-called Service mesh, a technology that adds a layer of abstraction over the network. We intercept all or part of the tr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to run Istio using Kubernetes in production. Part 1</h1><div class="post__text post__text-html js-mediator-article">  What is <a href="https://istio.io/">Istio</a> ?  This is the so-called Service mesh, a technology that adds a layer of abstraction over the network.  We intercept all or part of the traffic in the cluster and perform a certain set of operations with it.  Which one?  For example, we do smart routing, or implement the circuit breaker approach, we can organize ‚Äúcanary deployment‚Äù, partially switching traffic to a new version of the service, and we can limit external interactions and monitor all hikes from the cluster to the external network.  It is possible to set policy rules to control hikes between different microservices.  Finally, we can get the entire map of interaction over the network and make a unified collection of metrics completely transparent to applications. <br><br>  About the mechanism of work can be read in the <a href="https://istio.io/docs/concepts/">official documentation</a> .  Istio is a really powerful tool that allows you to solve many problems and problems.  In this article I would like to answer the basic questions that usually arise at the beginning of working with Istio.  This will help you deal with it faster. <br><br><img src="https://habrastorage.org/webt/cg/g_/dm/cgg_dmyxbtcrlna9cjib_vzazdm.png"><br><a name="habracut"></a><br><h3>  Principle of operation </h3><br>  Istio consists of two main zones - the control plane and the data plane.  Control plane contains the main components that ensure the correct operation of the rest.  In the current version (1.0), the control plane has three main components: Pilot, Mixer, Citadel.  We will not consider Citadel, it is needed to generate certificates for mutual TLS operation between services.  Let's take a closer look at the device and purpose of the Pilot and Mixer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/bz/eb/pz/bzebpzcfxr7himr5du7j1cm18zg.png"><br><br>  Pilot is the main control component that propagates all the information that we have in the cluster - services, their endpoints and routing rules (for example, rules for Canary deployment or circuit breaker rules). <br><br>  Mixer is an optional component of the control plane, which provides the ability to collect metrics, logs, and any information about network interaction.  He also oversees the observance of Policy rules and the observance of rate limits. <br><br>  Data plane is implemented using sidecar proxy containers.  By default, the powerful <a href="https://www.envoyproxy.io/">proxy server envoy is used</a> .  It can be replaced with another implementation, for example nginx (nginmesh). <br><br>  In order for Istio to work completely transparently for applications, there is an automatic injecting system.  The latest implementation is suitable for versions Kubernetes 1.9+ (mutational admission webhook).  For Kubernetes versions 1.7, 1.8 it is possible to use Initializer. <br><br>  Sidecar containers are connected to Pilot using the GRPC protocol, which allows optimization of the pushing model of changes occurring in the cluster.  GRPC began to be used in Envoy since version 1.6, in Istio it is used from version 0.8 and is a pilot-agent - a wrapper on golang over envoy, which configures launch parameters. <br><br>  Pilot and Mixer are fully stateless components, all states are kept in memory.  The configuration for them is given in the form of Kubernetes Custom Resources, which are stored in etcd. <br>  The Istio-agent receives the Pilot address and opens the GRPC stream to it. <br><br>  As I said, Istio implements all the functionality completely transparent to applications.  Let's see how.  The algorithm is as follows: <br><br><ol><li>  Deploy new service version. </li><li>  Depending on the injecting approach of the sidecar container, the istio-init container and the istio-agent container (envoy) are added at the configuration application stage, or they can already be manually inserted into the Pod description of the Kubernetes entity. </li><li> The istio-init container is a script that applies the iptables rules for the submission.  There are two options for configuring traffic wrapping in an istio-agent container: use the redirect iptables rules, or <a href="">TPROXY</a> .  At the time of this writing, the default approach is to use the redirect rules.  In istio-init, it is possible to configure exactly which traffic to intercept and route to the istio-agent.  For example, in order to intercept all incoming and all outgoing traffic, you need to set the parameters <code>-i</code> and <code>-b</code> to <code>*</code> .  You can specify specific ports to intercept.  In order not to intercept a specific subnet, you can specify it using the <code>-x</code> flag. </li><li>  After execution of the init containers, the main ones are started, including the pilot-agent (envoy).  It connects to the already deployed Pilot GRPC and receives information on all existing services and routing policies in the cluster.  According to the data received, he configures clusters and writes them directly the endpoints of our applications in the Kubernetes cluster.  It is also necessary to note an important point: envoy dynamically configures listeners (pairs of IP, port), which begins to listen.  Therefore, when requests enter the pod, are redirected using redirect iptables rules to the sidecar, envoy can already successfully handle these connections and understand where to further proxy traffic.  Also at this stage the information is sent to the Mixer, which we will look at later, and the sending of the tracing span. </li></ol><br>  As a result, we get a whole network of envoy proxies, which we can configure from one point (Pilot).  All inbound and outbound requests go through envoy.  Moreover, only TCP traffic is intercepted.  This means that Kubernetes service IP is resolved using kube-dns via UDP without modification.  Then, after rezolv, the outgoing request is intercepted and processed by envoy, which already decides at which endpoint the request should be sent (or not, in the case of access policies or triggering the circuit breaker algorithm). <br><br>  With the Pilot figured out, now you need to understand how the Mixer works and why it is needed.  Read the official documentation on it <a href="https://istio.io/docs/concepts/policies-and-telemetry/overview/">here</a> . <br><br>  Mixer in its current form consists of two components: istio-telemetry, istio-policy (prior to version 0.8, this was one component of istio-mixer).  Both are the mixers, each of which is responsible for its own task.  Istio telemetry accepts GRPC from sidecar Report containers about who goes where and with what parameters.  Istio-policy accepts Check requests to verify that Policy is compliant.  Poilicy check is carried out, of course, not for each request, but is cached on the client (in the sidecar) for a certain time.  Report checks are sent by batch requests.  How to configure and which parameters need to be sent will see later. <br><br>  Mixer is supposed to be a highly available component that ensures uninterrupted work on the assembly and processing of telemetry data.  The system is ultimately obtained as a multi-level buffer.  Initially, data is buffered on the sidecar side of containers, then on the mixer side and then sent to so-called mixer backends.  As a result, if any of the system components fails, the buffer grows and after the system is restored, it crashes.  Mixer backend's are end points for sending telemetry data: statsd, newrelic, and so on.  You can write your backend, it's quite simple, and we will see how to do it. <br><br><img src="https://habrastorage.org/webt/pz/qy/a_/pzqya_uanc5lmnd1kdv8ddu-frc.png"><br><br>  To summarize, the scheme of working with istio-telemetry is as follows. <br><br><ol><li>  Service 1 sends a request to service 2. </li><li>  When leaving the service 1, the request is wrapped in its own sidecar. </li><li>  Sidecar envoy monitors the progress of the request to service 2 and prepares the necessary information. </li><li>  It then sends it to istio-telemetry using the Report request. </li><li>  Istio-telemetry determines whether this Report should be sent to the backend, to which data it should be sent. </li><li>  Istio-telemetry sends Report data to the backend if necessary. </li></ol><br>  Now let's see how to deploy in the Istio system, consisting only of the main components (Pilot and sidecar envoy). <br><br>  First, look at the basic configuration (mesh) that Pilot reads: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ConfigMap metadata: name: istio namespace: istio-system labels: app: istio service: istio data: mesh: |- #      tracing  (pilot  envoy'  ,     ) enableTracing: false #     mixer endpoint',  sidecar      #mixerCheckServer: istio-policy.istio-system:15004 #mixerReportServer: istio-telemetry.istio-system:15004 #   ,    envoy  Pilot (    envoy proxy) rdsRefreshDelay: 5s # default   envoy sidecar defaultConfig: #   rdsRefreshDelay discoveryRefreshDelay: 5s #    (     envoy) configPath: "/etc/istio/proxy" binaryPath: "/usr/local/bin/envoy" #    sidecar  (, ,      tracing span') serviceCluster: istio-proxy # ,    envoy  ,        drainDuration: 45s parentShutdownDuration: 1m0s #    REDIRECT  iptables.    TPROXY. #interceptionMode: REDIRECT # ,     admin   sidecar  (envoy) proxyAdminPort: 15000 # ,     trace'  zipkin  (     ,       ) zipkinAddress: tracing-collector.tracing:9411 # statsd     envoy  () # statsdUdpAddress: aggregator:8126 #    Mutual TLS controlPlaneAuthPolicy: NONE # ,     istio-pilot  ,     service discovery  sidecar  discoveryAddress: istio-pilot.istio-system:15007</code> </pre><br>  All the main components of the control (control plane) will be placed in the namespace istio-system in Kubernetes. <br><br>  The minimum we need to deploy only the Pilot.  To do this, we use <a href="">this configuration.</a> <br><br>  And manually configure the injecting sidecar of the container. <br><br>  Init container: <br><br><pre> <code class="plaintext hljs">initContainers: - name: istio-init args: - -p - "15001" - -u - "1337" - -m - REDIRECT - -i - '*' - -b - '*' - -d - "" image: istio/proxy_init:1.0.0 imagePullPolicy: IfNotPresent resources: limits: memory: 128Mi securityContext: capabilities: add: - NET_ADMIN</code> </pre><br>  And sidecar: <br><br><pre> <code class="plaintext hljs"> name: istio-proxy args: - "bash" - "-c" - | exec /usr/local/bin/pilot-agent proxy sidecar \ --configPath \ /etc/istio/proxy \ --binaryPath \ /usr/local/bin/envoy \ --serviceCluster \ service-name \ --drainDuration \ 45s \ --parentShutdownDuration \ 1m0s \ --discoveryAddress \ istio-pilot.istio-system:15007 \ --discoveryRefreshDelay \ 1s \ --connectTimeout \ 10s \ --proxyAdminPort \ "15000" \ --controlPlaneAuthPolicy \ NONE env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: INSTANCE_IP valueFrom: fieldRef: fieldPath: status.podIP - name: ISTIO_META_POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: ISTIO_META_INTERCEPTION_MODE value: REDIRECT image: istio/proxyv2:1.0.0 imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 128Mi limits: memory: 2048Mi securityContext: privileged: false readOnlyRootFilesystem: true runAsUser: 1337 volumeMounts: - mountPath: /etc/istio/proxy name: istio-envoy</code> </pre><br>  In order for everything to start successfully, you need to have ServiceAccount, ClusterRole, ClusterRoleBinding, CRD for Pilot, descriptions of which can be found <a href="https://github.com/istio/istio/tree/release-1.0/install/kubernetes/helm/istio/charts/pilot/templates">here</a> . <br><br>  As a result, the service into which we inject the sidecar with envoy should start successfully, get all the discovery from the pilot and process the requests. <br><br>  It is important to understand that all control plane components are stateless applications and can be horizontally scaled without problems.  All data is in etcd as custom descriptions of Kubernetes resources. <br><br>  Also, Istio (so far experimentally) has the ability to run outside the cluster and the ability to watch and fumble for service discovery between several Kubernetes clusters.  Read more about it <a href="https://istio.io/docs/setup/kubernetes/multicluster-install/">here</a> . <br><br>  In a multicluster installation, the following limitations should be taken into account: <br><br><ol><li>  Pod CIDR and Service CIDR must be unique across all clusters and must not intersect. </li><li>  All Pod CIDRs should be accessible from any Pod CIDR between clusters. </li><li>  All Kubernetes API servers must be accessible to each other. </li></ol><br>  This is the initial information that will help you get started with Istio.  However, there are still many pitfalls.  For example, the features of external traffic routing (out of the cluster), approaches to debugging sidecar's, profiling, setting up a mixer and writing a custom mixer backend, setting up a tracing mechanism and its work using envoy. <br>  All this we will consider in the following publications.  Ask your questions, I will try to highlight them. </div><p>Source: <a href="https://habr.com/ru/post/419319/">https://habr.com/ru/post/419319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419307/index.html">Roskomnadzor inquired about Facebook business connections</a></li>
<li><a href="../419309/index.html">Average color in javascript</a></li>
<li><a href="../419311/index.html">Industrial lamps from the domestic manufacturer Effest with a good color rendering index</a></li>
<li><a href="../419313/index.html">Buffett's testament or what financial consultants are silent about</a></li>
<li><a href="../419315/index.html">Engine life after the death of the rocket</a></li>
<li><a href="../419321/index.html">SamsPcbGuide Part 7: Tracing Signal Lines. Differential pairs</a></li>
<li><a href="../419323/index.html">Installing Kubernetes on Hetzner Cloud</a></li>
<li><a href="../419325/index.html">Relocate student to France</a></li>
<li><a href="../419327/index.html">Interface List Guide in MikroTik</a></li>
<li><a href="../419329/index.html">Digital events in Moscow from 6 to 12 August</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>