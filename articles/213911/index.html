<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>40G Ethernet performance with Intel ONS based switch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today a decent number of interfaces is available, each of which claims to be useful and necessary. Traditional Ethernet with 1G, 10G, 40G; InfiniBand ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>40G Ethernet performance with Intel ONS based switch</h1><div class="post__text post__text-html js-mediator-article"><img align="right" width="500" src="https://habrastorage.org/getpro/habr/post_images/7fc/edf/185/7fcedf1851220eb1fe61dfc1da0ab71b.png"><br>  Today a decent number of interfaces is available, each of which claims to be useful and necessary.  Traditional Ethernet with 1G, 10G, 40G;  InfiniBand FDR 56G and QDR 40G;  FibreChannel 8G, 16G, promised 32G. <br><br>  All promise happiness and talk about their utmost necessity and usefulness in everyday life.  How to deal with this, what to choose and where are the pitfalls? <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>How tested:</b> <br><br>  Traditional for all gigabits, which is in each server, 40G Ethernet, QDR and FDR InfiniBand, 10G did not take part.  Immediately it should be noted that we consider FC to be an outgoing interface, now convergence is in trend.  32G is not yet available, and 16G is out of the league of high-speed solutions. <br>  To determine the limits, tests were carried out to achieve minimum delays and maximum throughput, which is convenient to do with the help of HPC techniques, at the same time we tested the suitability of 40G Ethernet for HPC applications. <br><br>  Invaluable assistance was provided and conducted by field tests by colleagues from the <a href="http://compcenter.org/">Central Control Center</a> , to whom one switch based on Intel ONS was transferred for testing. <br><br>  By the way, the <a href="http://habrahabr.ru/company/etegro/blog/212639/">distribution of the switch</a> in the most interesting project continues. <br><br>  <b>Hardware:</b> <br><ul><li>  <a href="http://www.etegro.ru/configurator/network/eos410i">40G Ethernet Switch</a> </li><li>  Communication adapter Mellanox ConnectX-3 VPI adapter card;  single-port QSFP;  FDR IB (56Gb / s) and 40GigE;  PCIe3.0 x8 8GT / s </li><li>  Dual Processor with Intel¬Æ Xeon¬Æ E5-2680 v2 </li><li>  OFED-3.5 ( <a href="https://www.openfabrics.org/">drivers and low-level libraries</a> for Mellanox) </li><li>  <a href="http://www.mellanox.com/">ConnectX¬Æ EN 10 and 40 Gigabit Linux Driver</a> </li></ul><br>  <b>Software:</b> <br><ul><li>  Measurement of performance was performed using a synthetic test pingpong from the <a href="http://www.intel.com/">Intel MPI Benchmark v3.2.3</a> test suite <a href="http://www.intel.com/">.</a> </li><li>  The version of the MPI library used by <a href="http://compcenter.org/">S-MPI v1.1.1</a> is a clone of Open MPI. </li></ul><br><br>  In the process of preparation, the nuance of the Mellanox adapters was found out - they require a forced switch to Ethernet mode.  For some reason, the declared functionality of automatic detection of the type of connected network does not work, it can be corrected. <br><br>  To evaluate performance, we ‚Äútraditionally‚Äù look at the values ‚Äã‚Äãof latency during the transmission of 4-byte messages and of the bandwidth when transmitting a 4-MB message. <br><br>  <b>The beginning of experiences:</b> <br><br>  It is used for normal Ethernet mode.  In our terminology, a tcp factory was used.  That is, the MPI library uses the socket interface to transmit messages.  Driver, switch, and MPI configuration by default. <br><br>  The table on the left shows the results for 1G ethernet, on the right for 40G (with our switch).  We see ‚Äúdips‚Äù in the band for messages of length 256K-1M and the maximum result suitable for 10G Ethernet.  Obviously, you need to customize the software.  The delay, of course, is very high, but when passing through the standard TCP stack, you should not expect much.  We must pay tribute, three times better than 1G Ethernet. <br><br><table><tbody><tr><td><code>Mpirun ‚Äìn 2 ‚Äìdebug-mpi 4 ‚Äìhost host01,host02 ‚Äìnets tcp --mca btl_tcp_if_include eth0 IMB-MPI1 PingPong</code> </td> <td> <code>mpirun -n 2 -debug-mpi 4 -host host01,host02 -nets tcp --mca btl_tcp_if_include eth4 IMB-MPI1 PingPong</code> </td> </tr></tbody></table><br><br>  Clickable: <br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6da/1d9/13d/6da1d913d480cd41fbb9c04feb7e5dd7.jpg"></a> </div><br><br>  <b>We continue:</b> <br><br>  Update the driver.  We take the <a href="http://www.mellanox.com/page/products_dyn%3Fproduct_family%3D27">driver from the site Mellanox</a> . <br>  To reduce the ‚Äúdrawdown‚Äù in the 256K-1M range, increase the size of the buffers through the MPI settings: <br><br> <code>export S_MPI_BTL_TCP_SNDBUF=2097152 <br> export S_MPI_BTL_TCP_RCVBUF=2097152 <br> <br> mpirun -n 2 -debug-mpi 4 -host host1,host2 -nets tcp --mca btl_tcp_if_include eth4 IMB-MPI1 PingPong</code> <br> <br>  Clickable: <br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2a4/df1/214/2a4df1214beb44107d6ba653fddaf8f5.jpg"></a> </div><br><br>  As a result, an improvement of one and a half times and a decrease in failures, but still not enough, and even delays on small packets have grown. <br><br>  Of course, to improve the bandwidth when using high-speed Ethernet interfaces, it makes sense to use extra-long Ethernet frames (Jumbo frames).  We configure the switch and adapters to use MTU 9000, and we get a significantly higher bandwidth, which still remains at 20 Gbit / s. <br><br>  Clickable: <br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7fb/4ed/3e5/7fb4ed3e574c9445bf82d650827d588e.jpg"></a> </div><br><br>  The latency on small packets is growing again. <br>  Tried other parameters "twist", but did not receive any fundamental improvements.  In general, we decided that "we are not able to cook them." <br>  Which way to look? <br>  Of course, if you look for performance, you need to do this bypassing the TCP stack.  The obvious solution is to try RDMA technology. <br><br>  <b>The essence of technology:</b> <br><ul><li>  Delivering data directly to the user's environment, without switching the application context between kernel and user modes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f6/630/5df/8f66305df5e616b9304ecbdd7184d19a.jpg"><br><br></li><li>  Data from the adapter is placed immediately in the memory of the application, without intermediate buffers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a58/c81/99a/a58c8199afb80f194209c74b865be639.jpg"><br><br></li><li>  Network controllers handle the transport layer without involving the processor. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76d/ab0/51f/76dab051f4145c584e98c355ec3d14bb.jpg"><br><br></li></ul><br><br>  One of the consequences is a significant reduction in access latency. <br>  There are two competing standards, the Internet Wide Area RDMA Protocol (iWARP) and RDMA over Converged Ethernet (RoCE), their competition and the attempts of supporters to drown each other are worthy of a separate holivar and bulk material.  Pictures are for iWARP, but the essence is common. <br><br>  Mellanox adapters support RDMA over Converged Ethernet (RoCE), use OFED-3.5.2. <br>  As a result, got great numbers.  The delay is 1.9 Œºs and the band is 4613.88 MB / s (this is 92.2% of the peak!) When using Jumbo frames.  If the MTU size is left as default, the band will be lower, approximately 4300 MB / s. <br><br> <code>mpirun -n 2 -debug-mpi 4 -host host1,host2 --mca btl openib,self --mca btl_openib_cpc_include rdmacm IMB-MPI1</code> <br> <br>  Clickable: <br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/137/64b/3ba/13764b3baddadeffef58bb2edcbdff2b.jpg"></a> </div><br><br>  For the Pingpong test, the delay time can be improved up to 1.4 ¬µs; for this, the processes must be placed on the CPUs ‚Äúclose‚Äù to the network adapter.  What practical value does it have in real life?  Below is a small Ethernet vs InfiniBand comparison label.  In principle, this ‚Äútrick‚Äù can be applied to any interconnect, so the table below shows the range of values ‚Äã‚Äãfor some network factories. <br><br><table><tbody><tr><td></td><td>  1G Ethernet (TCP) </td><td>  40G Ethernet (TCP) </td><td>  40G Ethernet (RDMA) </td><td>  InfiniBand QDR </td><td>  InfiniBand FDR </td></tr><tr><td>  Latency, usec </td><td>  24.5 </td><td>  7.8 </td><td>  1.4-1.9 </td><td>  1.5 </td><td>  0.86-1.4 </td></tr><tr><td>  Bandwidth, Mbytes / s </td><td>  112 </td><td>  1126 </td><td>  4300-4613 </td><td>  3400 </td><td>  5300-6000 </td></tr></tbody></table><br><br>  The data for 40G and FDR float depending on the proximity of the cores on which the processes run to the cores responsible for the network adapter, for some reason this effect was almost invisible on QDR. <br>  40G Ethernet significantly outpaced IB QDR, but before IB FDR did not catch up in absolute figures, which is not surprising.  However, 40G Ethernet is leading in efficiency. <br>  What follows from this? <br>  The triumph of converged Ethernet technology! <br>  It is not for nothing that Microsoft is pushing hard for SMB Direct, which relies on RDMA, and RDMA support is also built into NFS. <br>  To work with block access, there are iSCSI offload technologies on network controllers and iSCSI Extensions for RDMA (iSER) protocol, aesthetes can try FCoE :-) <br><br>  When using such switches: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/303/e67/ff0/303e67ff095362b9cf5ae86cd81877e1.jpg"><br><br>  You can build a bunch of interesting high-performance solutions. <br>  For example, a software-configured storage system like the <a href="http://habrahabr.ru/company/etegro/blog/189520/">FS200 G3</a> with a 40G interface and a server farm with 10G adapters. <br>  With this approach, there is no need to build a dedicated network for data, significantly saving both money on the second set of switches and the time to deploy the solution, because the cables also need to be connected and installed twice as low. <br><br>  <b>Total:</b> <br><ol><li>  On Ethernet, you can build a high-performance network with ultra-low latency. </li><li>  The active use of modern controllers with RDMA support significantly improves the performance of the solution. </li><li>  Intel matrix with 400 ns cut-through delay level helps to get excellent results :-) </li></ol></div><p>Source: <a href="https://habr.com/ru/post/213911/">https://habr.com/ru/post/213911/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213899/index.html">Open source Wiren Board</a></li>
<li><a href="../213903/index.html">ASUS Transformer Book T100TA Review</a></li>
<li><a href="../213905/index.html">Samsung introduced a new flagship smartphone - GALAXY S5</a></li>
<li><a href="../213907/index.html">Tai'Dzen: the first steps (part 3)</a></li>
<li><a href="../213909/index.html">How to achieve results by managing the development process</a></li>
<li><a href="../213913/index.html">Problems of volume test tasks when choosing a job</a></li>
<li><a href="../213919/index.html">Twitter returns the @N account to its original owner.</a></li>
<li><a href="../213921/index.html">Portal 2 (beta) via steam to linux</a></li>
<li><a href="../213925/index.html">Selection of media and storage locations for archiving and backup of photo archives</a></li>
<li><a href="../213927/index.html">MegaFon launched 4G +</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>