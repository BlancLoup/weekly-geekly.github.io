<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calculate CRC32 strings in compile-time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="By its programmer nature, I really dislike nonoptimality and redundancy in code. And so, reading once again at work the source code of our project, ag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calculate CRC32 strings in compile-time</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/9db/0e3/d98/9db0e3d984cdeb50064e36a8526aaaa3.png">  By its programmer nature, I really dislike nonoptimality and redundancy in code.  And so, reading once again at work the source code of our project, again came across one feature in the way of translating product strings into different languages. <br><br>  Localization here is quite simple.  All strings requiring translation are wrapped in the <code>_TR()</code> macro: <br><pre> <code class="cpp hljs">wprintf(<span class="hljs-string"><span class="hljs-string">L"%s\n"</span></span>, _TR(<span class="hljs-string"><span class="hljs-string">"Some translating string"</span></span>));</code> </pre><br>  The macro returns the desired version of the text depending on the currently used language.  It is defined as follows: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _TR(x) g_Translator.Translate(x)</span></span></code> </pre><br>  Here, the global object <code>g_Translator</code> , which, in the <code>Translate()</code> function, counts crc32 from the specified line in runtime, searches in its xml-base for a translation with a matching checksum and returns it. <br><br>  I will not judge whether such a decision is justified, but it is time-tested and proved to be quite reliable.  And everything would be fine, but such a solution is not without flaws: in fact, the function does extra work - the checksums could be calculated once at the compilation stage, and later used ready-made numerical values.  It would also eliminate the need to store duplicate strings in the executable image, because they are already in the external xml file with translations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A little googling at the request of ‚Äúcompile-time crc32‚Äù I quickly realized that the task was not the most trivial, but I could not find any ready-made solutions. <br><a name="habracut"></a><br>  Using <a href="http://en.wikipedia.org/wiki/Template_metaprogramming">template metaprogramming</a> in its pure form, unfortunately, will not work here.  Any reference to the characters of the string used as a template parameter prevents the compiler from minimizing recursive calls to the template function.  For example, <a href="http://habrahabr.ru/post/38622/">this</a> article discusses creating only tables for crc32 calculations.  And from the fully standard-compliant solutions there was only one - <a href="http://arcticinteractive.com/2009/04/18/compile-time-string-hashing-boost-mpl/">Boost.MPL</a> .  Here it is proposed to use the following entry form: <br><pre> <code class="cpp hljs">meta::hash_cstring&lt; mpl::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&lt;<span class="hljs-string"><span class="hljs-string">'bunn'</span></span>,<span class="hljs-string"><span class="hljs-string">'ies'</span></span>&gt; &gt;::value;</code> </pre> <br>  Instead of using string literals, it is proposed to break the string into pieces and give it to individual template parameters.  But besides the bizarreness of the record used, in order to convert all 2450 lines of the project to this form, you would have to write an external code generator and teach the entire project team a new form of recording. <br>  Slipped on the forums also messages that in the new <a href="http://ru.wikipedia.org/wiki/C%252B%252B11">C ++ 11</a> this idea is implemented using the classic template metaprogramming and the keyword <code>constexpr</code> , but, unfortunately, it is not possible to simply transfer the project from a long pedigree to a new standard. <br><br>  There was another idea using a code generator.  It would be possible to make a pre-build event, on which to translate strings to this form: <br><pre> <code class="cpp hljs">_TR(<span class="hljs-number"><span class="hljs-number">0x12345678</span></span><span class="hljs-comment"><span class="hljs-comment">/*"Some hashing string"*/</span></span>);</code> </pre> <br>  But again, I wanted something universal ... I wanted such a magical <code>_TR()</code> , which would simply leave behind pure crc32 without any extra movements.  And then I started to reinvent my bike. <br><br><h4>  Attempt # 1.  Pure macros </h4><br>  At this stage, there was only one thought in my head: apart from templates, macros are computed before compilation - you need to use them! <br><br>  I created a new project in Visual Studio, setting the optimization settings to maximum inline and maximum speed.  I decided to analyze the success / failure of folding the lines to the hash in the well-known user-mode debugger <a href="http://ollydbg.de/">OllyDbg</a> , so I would like to see in the resulting exe only one small section per code and data without unnecessary garbage.  To do this, I disabled the C-runtime, which, together with several other receivers, allowed me to get an empty exe of only 2 KB in size. <br><br>  After several experiments, I gave the simplest implementation of the crc32 calculation for strings of no more than 3 characters: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Crc32Table[<span class="hljs-number"><span class="hljs-number">256</span></span>] = { <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x77073096</span></span>, <span class="hljs-number"><span class="hljs-number">0xEE0E612C</span></span>, <span class="hljs-number"><span class="hljs-number">0x990951BA</span></span>, <span class="hljs-number"><span class="hljs-number">0x076DC419</span></span>, <span class="hljs-number"><span class="hljs-number">0x706AF48F</span></span>, <span class="hljs-number"><span class="hljs-number">0xE963A535</span></span>, <span class="hljs-number"><span class="hljs-number">0x9E6495A3</span></span>, <span class="hljs-number"><span class="hljs-number">0x0EDB8832</span></span>, <span class="hljs-number"><span class="hljs-number">0x79DCB8A4</span></span>, <span class="hljs-number"><span class="hljs-number">0xE0D5E91E</span></span>, <span class="hljs-number"><span class="hljs-number">0x97D2D988</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* ... ,*/</span></span> <span class="hljs-number"><span class="hljs-number">0xB40BBE37</span></span>, <span class="hljs-number"><span class="hljs-number">0xC30C8EA1</span></span>, <span class="hljs-number"><span class="hljs-number">0x5A05DF1B</span></span>, <span class="hljs-number"><span class="hljs-number">0x2D02EF8D</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> N&gt; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> (&amp;array_length(T (&amp;)[N]))[N]; <span class="hljs-comment"><span class="hljs-comment">//       #define lengthof(x) (sizeof(array_length(x))) //    crc32 #define TR_CRC(crc,i,s) (crc &gt;&gt; 8)^Crc32Table[(crc^s[i])&amp;0xFF] //            #define TR_CRC_COND(crc,i,s) (i&lt;lengthof(s)-1 ? TR_CRC(crc,i,s):crc) //   CRC     ( 3 ) #define _TR(s) TR_CRC_COND(TR_CRC_COND(TR_CRC_COND(TR_CRC_COND(0xFFFFFFFF,0,s),1,s),2,s),3,s)^0xFFFFFFFF int main(int argc, char *argv[]) { //     ,    - DWORD, //             Olly Sleep(_TR("123")); }</span></span></code> </pre><br>  In the implementation of macros, the main problem is that we cannot expand the cycle of calculating crc for the required number of iterations along the length of the string, as in template metaprogramming.  A macro will always recount as many iterations as it should be laid initially.  For example, in the example above, the string "1" would still be calculated in 4 iterations (maximum 3 characters + '\ 0'), despite the fact that it has only one character length.  This is bypassed by a conditional operation that slips the value of crc from the previous iteration, if the string is already calculated to the last character. <br><br>  Running the resulting exe in the debugger, I saw the cherished <code>PUSH 884863D2</code> , the correctness of which calculation is easily confirmed by the <a href="http://www.codenet.ru/services/crc32/">first</a> online crc32 calculator. <br><br><img src="http://habrastorage.org/storage2/216/5b8/e1d/2165b8e1dbe715c8cd79989abe5b002a.png"><br><br>  It's time to see how much the compilation rate drops, if you spread the macro for the length of the line that allowed you to cover the requirements of the project.  The longest line in the translation database was a little shorter than 350 characters, so I wanted to lay at least the limit of 500 characters. <br><br>  Thus, I generated the macro body, in abbreviated form, which looked like this: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _TR(s) TR_CRC_COND(TR_CRC_COND(</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*...*/</span></span></span><span class="hljs-meta">TR_CRC_COND(TR_CRC_COND(0xFFFFFFFF,0,s),1,s),2,s),3,s)</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*...*/</span></span></span><span class="hljs-meta">,448,s),449,s)^0xFFFFFFFF</span></span></code> </pre><br>  But here I was disappointed when the compiler gave its cold: <i>"fatal error C1009: compiler limit: macros nested too deeply</i> . <i>"</i>  Empirically, we managed to find out that the nesting limit is somewhere in the region of 300. <br><br><h4>  Attempt # 2.  __Forceinline function </h4><br>  Then there were still several attempts to use inline functions instead of nested macros, but everything eventually slipped into either a similar error (I don‚Äôt remember exactly, but the compiler cursed too complicated grammar) or an excessively long compilation. <br><br>  After all the torment, I was almost ready to abandon this idea, but I decided to try to write one large <a href="http://msdn.microsoft.com/ru-ru/library/z8y1yy88.aspx">__forceinline</a> function with a bunch of consecutive calculations and line length checks (for some reason I was sure that <u>such a</u> compiler would never turn into a constant): <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,       #define CRC_STUB_(i) if (i&lt;N-1) { crc = (crc&gt;&gt;8) ^ Crc32Table[(crc^s[i])&amp;0xFF] } template &lt;int N&gt; static __forceinline DWORD CRC_ARR_CALC_(const char (&amp;s)[N]) { static const unsigned int Crc32Table[256] = { 0x00000000, 0x77073096, 0xEE0E612C, 0x990951BA, 0x076DC419, 0x706AF48F, 0xE963A535, 0x9E6495A3, 0x0EDB8832, 0x79DCB8A4, 0xE0D5E91E, 0x97D2D988, /* ... ,*/ 0xB40BBE37, 0xC30C8EA1, 0x5A05DF1B, 0x2D02EF8D }; DWORD crc = 0; CRC_STUB_(0);CRC_STUB_(1);CRC_STUB_(2);CRC_STUB_(3);CRC_STUB_(4);CRC_STUB_(5);CRC_STUB_(6);CRC_STUB_(7);CRC_STUB_(8);CRC_STUB_(9);CRC_STUB_(10);CRC_STUB_(11);CRC_STUB_(12);CRC_STUB_(13);CRC_STUB_(14);CRC_STUB_(15);CRC_STUB_(16);CRC_STUB_(17); /* ... */ CRC_STUB_(498);CRC_STUB_(499); return crc; }</span></span></code> </pre><br>  And it worked!  The compiler pretty quickly folded the whole code into one number, leaving neither the rows themselves nor even the <code>Crc32Table</code> table in the resulting binary.  To correctly compile such an implementation, only the / O2 switch is sufficient.  It only remained to add the overloaded version of the <code>g_Translator.Translate()</code> method with crc32 as a parameter, and the <code>g_Translator.Translate()</code> . <br><br>  After introducing the code into the project, the compilation of the release build became longer by 1-2 minutes, but the binary has become easier by 200 Kb, and now it doesn‚Äôt make the processors of users involved in unnecessary work, allowing their laptops to work on battery a little longer :) <br><br>  The full source for the test project can be found here: <a href="">7z</a> , <a href="">tar.gz</a> </div><p>Source: <a href="https://habr.com/ru/post/143975/">https://habr.com/ru/post/143975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143970/index.html">Fine (about language interaction)</a></li>
<li><a href="../143971/index.html">Android & iOS: Application Distribution Concepts and Security Issues</a></li>
<li><a href="../143972/index.html">We write the module for authorization in VK API</a></li>
<li><a href="../143973/index.html">Live broadcast from the conference DevCon'12: May 23-24 from 10:00 (Moscow time)</a></li>
<li><a href="../143974/index.html">Judge Alsup knows how to program and instructs Oracle attorney</a></li>
<li><a href="../143976/index.html">The practice of removing the IT department from a crisis</a></li>
<li><a href="../143978/index.html">Practical application of the piezoelectric effect for energy utilization</a></li>
<li><a href="../143979/index.html">Processing messages in RTOS on the example of FreeRTOS</a></li>
<li><a href="../143980/index.html">Time Machine: backup OS X Lion on Ubuntu 12.04 LTS server</a></li>
<li><a href="../143981/index.html">Graphic "bicycle" based on Turbo Vision (cases of bygone days)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>