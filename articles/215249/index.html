<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WPF: What to do when a property does not support binding</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 WPF is a great technology that, in spite of all its flaws, I love very much. However, it is often necessary to write not markup, but co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WPF: What to do when a property does not support binding</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  WPF is a great technology that, in spite of all its flaws, I love very much.  However, it is often necessary to write not markup, but code that helps the first one to work as it should.  I would like to avoid this and write pure XAML, but so far none of my applications are more complicated than simple ones without various helper (helpers) classes written in C #.  Fortunately, there are common cases where one helper can immediately solve a group of problems. <br><br>  The discussion below will deal with the binding in the usual properties of visual elements that are not dependency properties.  Regular means of WPF will not do this.  Everything else, we can not learn about the changes of this property, except by subscribing to a special event, which contradicts the <a href="http://ru.wikipedia.org/wiki/Model-View-ViewModel" title="Model-View-View-Model">MVVM</a> pattern.  Such events for each property can be their own.  The most common example is <em>PasswordBox</em> and its <em>Password</em> property.  So we can not do it: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PasswordBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{Binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">OtherProperty</span></span></span><span class="hljs-tag">} /&gt;</span></span></code> </pre> <br>  We will not go into details why the <em>PasswordBox</em> developers did not allow to bind to the password property.  We will think what can be done here. <br><a name="habracut"></a><br>  If you do not want to read my reasoning, then at the end of the article published the final code and a link to Github. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  We are determined with the method of implementation </h2><br>  So!  I would like such a decision to make it look like a usual binding, but with some additional parameters.  It is also a good idea to be able to do two-way binding.  To implement the above, the helper will need three input parameters: <br><ol><li>  Visual property </li><li>  Event reporting changes </li><li>  Data source for binding </li></ol><br>  For example, for <em>PasswordBox,</em> these will be respectively: the <em>Password</em> property, the <em>PasswordChanged</em> event, and the source <em>OtherProperty</em> . <br><br>  There are different ways to achieve what you want.  Let us dwell on the standard for such cases mechanism - behaviors. <br><br>  Behavior (behavior) is a class that adds additional functionality to the visual element.  There are two types of behavior: static and inherited from the class <em>Behavior &lt;T&gt;</em> .  A description of their differences is beyond the scope of the article.  I chose the second option, as having great potential. <br><br><h2>  Write the code </h2><br>  Add a link to the <em>System.Windows.Interactivity.dll</em> assembly.  This is part of the Expression Blend's SDK editor and is located in the Extensions section of the Visual Studio assembly selection window. <br><br>  Create a class that inherits from <em>Behavior &lt;T&gt;</em> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependecyPropertyBehavior</span></span> : <span class="hljs-title"><span class="hljs-title">Behavior</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DependencyObject</span></span>&gt; { }</code> </pre><br>  The generic type <em>DependencyObjec</em> t is selected as the most common.  After all, we are writing a universal class suitable for any element, and not just <em>PasswordBox</em> . <br><br>  Algorithm work will be brief.  To bind from property to source: <br><ol><li>  Subscribe to the event of changing the property of the visual element. </li><li>  In the handler, write the updated value to the source. </li></ol><br>  For backlinking: <br><ol><li>  Through binding, we determine the moment of change of the source value. </li><li>  Write the updated value to the property of the visual element. </li></ol><br>  For the above input parameters, we will create three properties: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Property { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UpdateEvent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty BindingProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DependecyPropertyBehavior), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FrameworkPropertyMetadata { BindsTwoWayByDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Binding { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue(BindingProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(BindingProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre><br><ul><li>  <em>Property</em> - the name of the property of the visual element that does not support binding; </li><li>  <em>UpdateEvent</em> - the name of the event that notifies that the value of our property changes; </li><li>  <em>Binding</em> - dependency property for binding to a data source.  Allows the use of a familiar binding mechanism. </li></ul><br>  In this case, the <em>Property</em> and <em>UpdateEvent properties</em> are normal, that's enough.  The <em>Binding</em> property, on the contrary, must be a dependency property, because it is here that the data source is connected. <br><br>  Now that we have all the input data, let's proceed to processing it in the overridden <em>OnAttached ()</em> method.  It is called when a behavior is attached to a visual element.  The latter can be accessed through the property of the <em>AssociatedObject</em> class.  In contrast, <em>OnDetaching ()</em> is called when detached. <br><br>  We need objects to work with the property of the visual element and the event through reflection.  The following shows how to receive and subscribe to an event, notifying you of changes in the property of a visual element. <br><br>  Further in the examples, I lowered various checks to <em>null</em> so as not to clog the attention.  In the final version of the class they are present. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Delegate _handler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventInfo _eventInfo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PropertyInfo _propertyInfo; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAttached</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Type elementType = AssociatedObject.GetType(); <span class="hljs-comment"><span class="hljs-comment">//     _propertyInfo = elementType.GetProperty(Property, BindingFlags.Instance | BindingFlags.Public); //  ,      _eventInfo = elementType.GetEvent(UpdateEvent); //       _handler = CreateDelegateForEvent(_eventInfo, EventFired); //  _eventInfo.AddEventHandler(AssociatedObject, _handler); } protected override void OnDetaching() { //  _eventInfo.RemoveEventHandler(AssociatedObject, _handler); }</span></span></code> </pre><br>  In the code above there is a method <em>CreateDelegateForEvent ()</em> .  It compiles the delegate object for the specified event at run time.  After all, we do not know in advance the signature of the event handler.  When compiled, the delegate places a call to the <em>action</em> method, which in our case is <em>EventFired ()</em> .  In it, we will perform the actions we need to update the value of the data source. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Delegate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDelegateForEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventInfo eventInfo, Action action</span></span></span><span class="hljs-function">)</span></span> { ParameterExpression[] parameters = eventInfo .EventHandlerType .GetMethod(<span class="hljs-string"><span class="hljs-string">"Invoke"</span></span>) .GetParameters() .Select(parameter =&gt; Expression.Parameter(parameter.ParameterType)) .ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Lambda( eventInfo.EventHandlerType, Expression.Call(Expression.Constant(action), <span class="hljs-string"><span class="hljs-string">"Invoke"</span></span>, Type.EmptyTypes), parameters ) .Compile(); }</code> </pre><br>  This operation is quite resource-intensive, but it is performed only once, with the connection behavior.  It can be optimized by sacrificing flexibility by assuming that events can only be <em>RoutedEvent</em> .  Then, instead of an expensive compilation, it is enough to subscribe to the event with the indication of the <em>EventFired ()</em> handler, having previously changed its signature to be compatible with <em>RoutedEventHandler</em> .  But we leave here the original version.  Premature optimization is evil. <br><br>  The <em>EventFired ()</em> method is extremely simple; it writes a new value to the data source: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EventFired</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Binding = _propertyInfo.GetValue(AssociatedObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre><br>  The only thing left is to change the value of the visual element property when the data source changes.  For this, the <em>OnPropertyChanged ()</em> override method is <em>suitable</em> , which reports changes to class dependency properties.  Since changing the data source also changes the <em>Binding</em> property, we only need to track its new values. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Property.Name != <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_propertyInfo.CanWrite) _propertyInfo.SetValue(AssociatedObject, e.NewValue, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPropertyChanged(e); }</code> </pre><br>  Everything seems to be fine.  We set a new value for the property of the visual element and ... get a <em>StackOverflowException</em> . <br><br>  The problem is that when a property changes, the automaton causes a notification event to which we are subscribed.  In the event, the source value changes, and when the source changes, the <em>Binding</em> property changes, which brings us back to the <em>OnPropertyChanged ()</em> method.  Recursion <br><br>  The simplest solution would be to add a comparison of the old and the new property values: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Property.Name != <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> oldValue = _propertyInfo.GetValue(AssociatedObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.Equals(e.NewValue)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_propertyInfo.CanWrite) _propertyInfo.SetValue(AssociatedObject, e.NewValue, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPropertyChanged(e); }</code> </pre><br>  Here we make the assumption that the type <em>Equals () is</em> implemented as it should and will not always return <em>false</em> . <br><br>  Our helper is ready! <br><br><h2>  Result </h2><br>  Usage example: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:local</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clr-namespace:DependecyPropertyBehaviorNamesapce"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:i</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/expression/2010/interactivity"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PasswordBox</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i:Interaction.Behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:DependecyPropertyBehavior</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UpdateEvent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PasswordChanged"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Property</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Text, ElementName=TestTextBox}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i:Interaction.Behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PasswordBox</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestTextBox"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In this case, the <em>TextBox</em> and <em>PasswordBox</em> will synchronously change values. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/961/1cf/14f/9611cf14f6f06627de8ca91274195662.png" width="299" height="74"><br><br><h2>  Conclusion </h2><br>  We have achieved the work of binding for the property of the visual element, which initially did not support it.  Binding works in both directions, and you can use a behavior class for any element without worrying about differences in the names of properties and events. <br><br>  I apologize in advance for inaccuracies in the text, my first article. <br>  As promised, the final code: <br><br><div class="spoiler">  <b class="spoiler_title">No null checks for quick reference.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq.Expressions; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Interactivity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Expression = System.Linq.Expressions.Expression; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DependecyPropertyBehaviorNamesapce</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependecyPropertyBehavior</span></span> : <span class="hljs-title"><span class="hljs-title">Behavior</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DependencyObject</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Delegate _handler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventInfo _eventInfo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PropertyInfo _propertyInfo; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty BindingProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DependecyPropertyBehavior), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FrameworkPropertyMetadata { BindsTwoWayByDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Binding { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue(BindingProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(BindingProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Property { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UpdateEvent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAttached</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Type elementType = AssociatedObject.GetType(); _propertyInfo = elementType.GetProperty(Property, BindingFlags.Instance | BindingFlags.Public); _eventInfo = elementType.GetEvent(UpdateEvent); _handler = CreateDelegateForEvent(_eventInfo, EventFired); _eventInfo.AddEventHandler(AssociatedObject, _handler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDetaching</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _eventInfo.RemoveEventHandler(AssociatedObject, _handler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Property.Name != <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> oldValue = _propertyInfo.GetValue(AssociatedObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.Equals(e.NewValue)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_propertyInfo.CanWrite) _propertyInfo.SetValue(AssociatedObject, e.NewValue, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPropertyChanged(e); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Delegate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDelegateForEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventInfo eventInfo, Action action</span></span></span><span class="hljs-function">)</span></span> { ParameterExpression[] parameters = eventInfo .EventHandlerType .GetMethod(<span class="hljs-string"><span class="hljs-string">"Invoke"</span></span>) .GetParameters() .Select(parameter =&gt; Expression.Parameter(parameter.ParameterType)) .ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Lambda( eventInfo.EventHandlerType, Expression.Call(Expression.Constant(action), <span class="hljs-string"><span class="hljs-string">"Invoke"</span></span>, Type.EmptyTypes), parameters ) .Compile(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EventFired</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Binding = _propertyInfo.GetValue(AssociatedObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The final version with all checks</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq.Expressions; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Interactivity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Expression = System.Linq.Expressions.Expression; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DependecyPropertyBehaviorNamesapce</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependecyPropertyBehavior</span></span> : <span class="hljs-title"><span class="hljs-title">Behavior</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DependencyObject</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Delegate _handler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventInfo _eventInfo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PropertyInfo _propertyInfo; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty BindingProperty = DependencyProperty.RegisterAttached( <span class="hljs-string"><span class="hljs-string">"Binding"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DependecyPropertyBehavior), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FrameworkPropertyMetadata { BindsTwoWayByDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Binding { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue(BindingProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(BindingProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Property { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UpdateEvent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAttached</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Type elementType = AssociatedObject.GetType(); <span class="hljs-comment"><span class="hljs-comment">// Getting property. if (Property == null) { PresentationTraceSources.DependencyPropertySource.TraceData( TraceEventType.Error, 1, "Target property not defined." ); return; } _propertyInfo = elementType.GetProperty(Property, BindingFlags.Instance | BindingFlags.Public); if (_propertyInfo == null) { PresentationTraceSources.DependencyPropertySource.TraceData( TraceEventType.Error, 2, string.Format("Property \"{0}\" not found.", Property) ); return; } // Getting event. if (UpdateEvent == null) return; _eventInfo = elementType.GetEvent(UpdateEvent); if (_eventInfo == null) { PresentationTraceSources.MarkupSource.TraceData( TraceEventType.Error, 3, string.Format("Event \"{0}\" not found.", UpdateEvent) ); return; } _handler = CreateDelegateForEvent(_eventInfo, EventFired); _eventInfo.AddEventHandler(AssociatedObject, _handler); } protected override void OnDetaching() { if (_eventInfo == null) return; if (_handler == null) return; _eventInfo.RemoveEventHandler(AssociatedObject, _handler); } protected override void OnPropertyChanged(DependencyPropertyChangedEventArgs e) { if (e.Property.Name != "Binding") return; if (AssociatedObject == null) return; if (_propertyInfo == null) return; object oldValue = _propertyInfo.GetValue(AssociatedObject, null); if (oldValue.Equals(e.NewValue)) return; if (_propertyInfo.CanWrite) _propertyInfo.SetValue(AssociatedObject, e.NewValue, null); base.OnPropertyChanged(e); } private static Delegate CreateDelegateForEvent(EventInfo eventInfo, Action action) { ParameterExpression[] parameters = eventInfo .EventHandlerType .GetMethod("Invoke") .GetParameters() .Select(parameter =&gt; Expression.Parameter(parameter.ParameterType)) .ToArray(); return Expression.Lambda( eventInfo.EventHandlerType, Expression.Call(Expression.Constant(action), "Invoke", Type.EmptyTypes), parameters ) .Compile(); } private void EventFired() { if (AssociatedObject == null) return; if (_propertyInfo == null) return; Binding = _propertyInfo.GetValue(AssociatedObject, null); } } }</span></span></code> </pre><br></div></div><br>  <a href="https://github.com/AndreyMikhailov/DependecyPropertyBehavior" title="Github">Github</a> </div><p>Source: <a href="https://habr.com/ru/post/215249/">https://habr.com/ru/post/215249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215239/index.html">IBOX - another ARM mini PC</a></li>
<li><a href="../215241/index.html">Miracle Machine: water wine</a></li>
<li><a href="../215243/index.html">VMware and KVM: OpenStack hypervisor race is gaining momentum</a></li>
<li><a href="../215245/index.html">InfoboxCloud cloud platform update: Jelastic 1.9.3</a></li>
<li><a href="../215247/index.html">As I accidentally discovered for myself an unlimited (!) Internet on a usb modem from mts, for a minimal fee</a></li>
<li><a href="../215251/index.html">Anti-stealth game Nothing To Hide</a></li>
<li><a href="../215253/index.html">Satoshi / Dorian Nakamoto received donations in the amount of 28 thousand dollars in compensation for the attention of journalists</a></li>
<li><a href="../215257/index.html">Vera Hospice Foundation launched its own mobile application</a></li>
<li><a href="../215259/index.html">Telecom operators and providers of Ukraine. Some statistics</a></li>
<li><a href="../215265/index.html">IOS 7.1 update with CarPlay</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>