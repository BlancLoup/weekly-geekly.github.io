<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Template factory of objects (once again, and in fifteen lines)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I am very new to C ++, I generally program solely for my own pleasure (and sometimes for several exotic platforms), I haven‚Äôt read theoretic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Template factory of objects (once again, and in fifteen lines)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/84a/b64/7cf/84ab647cfe645437d14c942dafa143dc.png" alt="image"><br><br>  Hello! <br><br>  I am very new to C ++, I generally program solely for my own pleasure (and sometimes for several exotic platforms), I haven‚Äôt read theoretical books, I actively use Google, Stack Overflow and intuition in the process of writing, and also adhere to the opinion that it‚Äôs impossible to know C ++. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I hope this removes some questions and prevents surprised looks.  :) <br><a name="habracut"></a><br>  Nevertheless, I once wrote (on the pros and with <a href="http://qt-project.org/">Qt</a> 'ohm) in my spare time in my free time, and then I thought that it would be nice to screw in some mechanism, which some people have turned out to be called a factory of objects.  And, as I understand it, there is a more general <a href="http://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">design pattern</a> , called an <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B0%25D0%25B1%25D1%2580%25D0%25B8%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%2528%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F%2529">abstract object factory</a> , the essence of which I did not catch, as well as a simpler abstraction, the essence of which is that the object knows about a number of class-identifier pairs, and then it can create instances of classes by their identifier (in the simplest case, this identifier is a string, but it may be convenient to use, for example, an enumeration).  When I more or less understood what I wanted (that is, the last one), I climbed to look for ready-made, beautiful solutions that would suit me, but, having raped almost all Google, surprisingly, I <i>did not find</i> one. <br><br>  As a result, having spent an inadmissible amount of time on such nonsense, I gathered from a heap of places (reaching the rest of Google) my unique and, I think, yet elegant small (really small ... I even doubt the need for a whole post ...) Bicycle, having managed to figure out a lot with what, including with template classes, template functions, specialization and even <a href="http://en.wikipedia.org/wiki/Variadic_template">variadic templates</a> and <a href="http://en.wikipedia.org/wiki/Variadic_function">functions</a> from <b>C ++ 11</b> . <br><br>  Make a reservation what exactly I want.  Firstly, of course, I read the article of the hatorsuber man <a href="https://habrahabr.ru/users/rtorsten/" class="user_link">rtorsten.</a> <a href="http://habr.ru/p/129202/">We</a> <a href="https://habrahabr.ru/users/rtorsten/" class="user_link">put</a> <a href="http://habr.ru/p/129202/">objects on the flow, the pattern of the factory of objects</a> , but the meaning of everything and everything doesn‚Äôt reach me so far, the implementation seems a bit overloaded, and I‚Äôm not I see.  You can say this post is an attempt to do roughly the same thing, but better.  Well, and secondly, what I wanted and what I achieved (it must have coincided :)): suppose we have the base class <code>Base</code> and two immediate heirs from it: <code>Derived1</code> and <code>Derived2</code> , the instances of which we want to create by the factory. <br><br>  The above is covered in that article, but I also want <ul><li>  create instances of classes with various constructor arguments; </li><li>  have one single factory implementation for any base class and any number and types of constructor arguments; </li><li>  do not need to modify classes in order to add them to the factory. </li></ul><br>  That is something like this: <pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;string&gt; #include "factory.h" using namespace std; class Animal{ public: Animal(bool isAlive,string name) : isAlive(isAlive),name(name){}; bool isAlive; string name; virtual string voice() const=0; }; class Dog : public Animal{ public: using Animal::Animal; string voice() const{ return this-&gt;isAlive? "Woof! I'm "+this-&gt;name+"\n": ""; } }; class Cat : public Animal{ public: using Animal::Animal; string voice() const{ return this-&gt;isAlive? "Meow, I'm "+this-&gt;name+"\n": ""; } }; int main(void){ GenericObjectFactory&lt;string,Animal,bool,string&gt; animalFactory; animalFactory.add&lt;Dog&gt;("man's friend"); animalFactory.add&lt;Cat&gt;("^_^"); Animal *dog1=animalFactory.get("man's friend")(true,"charlie"); Animal *dog2=animalFactory.get("man's friend")(false,"fido"); Animal *cat =animalFactory.get("^_^")(true,"begemoth"); cout &lt;&lt; dog1-&gt;voice() &lt;&lt; dog2-&gt;voice() &lt;&lt; cat -&gt;voice(); return 0; }</span></span></span></span></code> </pre>  Thus, the <code>animalFactory</code> factory is first created from the <code>animalFactory</code> template class, the first required parameter of which is <b>the key type</b> (in this example, a string, but it can also be handy to use something else, such as an integer value or an enumeration) of a <code>map</code> type, where the values ‚Äã‚Äãare the classes that will then need to be added to the factory so that it can create them;  as the second mandatory parameter - the <b>base class of</b> these classes (and they must be inherited from one class);  the remaining two parameters, which can be any number (including zero), are the types of the arguments of the class constructor created by the factory, in turn. <br><br>  Then you can add classes to the factory by calling the template member function <code>add</code> , specifying, as the first and only parameter, the class that the factory needs to register, and the first and only <i>argument</i> is the identifier of this class, in our case the string (defined the first parameter of the template class). <br><br>  Then the fun begins.  The member function <code>get</code> takes the id string as the first and only argument, and returns the so-called <i>instantiator of the class</i> found by this id.  Instantiator is such a function that will take a set of arguments (in the number and types specified in the factory specialization) and create an instance of the desired class, passing them to the constructor.  A kind of proxy, which is needed later I will explain why.  It is very similar to the fact that the constructor itself was returned.  :) It will return an instantiator with a pointer to the created object, but this pointer is of a type not of the inherited, but of the <i>base</i> class.  With a great desire, then you can <code>dynamic_cast</code> 'thread. <br><br>  By the way, nothing prevents to save the given instantiator somewhere: <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> catInstantiator=animalFactory.get(<span class="hljs-string"><span class="hljs-string">"^_^"</span></span>);</code> </pre>  , and already to create objects later, when it will be necessary: <pre> <code class="cpp hljs">Animal *cat=catInstantiator(<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"delayed cat"</span></span>); Animal *cat=catInstantiator(<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"dead delayed cat"</span></span>);</code> </pre>  :) <br>  But ok, in the end it was obvious.  It‚Äôs also obvious that I‚Äôm writing this note not to the young plusists, but to the newcomers, who for some reason wanted a factory for themselves.  :) <br><br><hr><br>  Let's look at the implementation of the factory.  I deliberately cut out everything without which it would not work, including any checks for the presence or absence of a class in a factory when creating or registering and similar logic and all other amenities (or rather, I was too lazy to transfer it from Qt to STL), no good it is not difficult to finish it.  But in general, I still think that the example code should be as simple and obvious as possible, without these undoubtedly inevitable diabolical details: it's easier to understand, and this is exactly what is needed now. <blockquote><ol><li>  <font color="#339900">#include &lt;map&gt;</font> </li><li></li><li>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> ID, <font color="#0000ff">class</font> Base, <font color="#0000ff">class</font> ... <font color="#007788">Args</font> <font color="#000080">&gt;</font> <font color="#0000ff">class</font> GenericObjectFactory <font color="#008000">{</font> </li><li>  <font color="#0000ff">private</font> <font color="#008080">:</font> </li><li>  <font color="#0000ff">typedef</font> Base <font color="#000040">*</font> <font color="#008000">(</font> <font color="#000040">*</font> fInstantiator <font color="#008000">)</font> <font color="#008000">(</font> Args ... <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> Derived <font color="#000080">&gt;</font> <font color="#0000ff">static</font> Base <font color="#000040">*</font> instantiator <font color="#008000">(</font> Args ... <font color="#007788">args</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">return</font> <font color="#0000dd">new</font> Derived <font color="#008000">(</font> args ... <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  std <font color="#008080">::</font> <font color="#007788">map</font> <font color="#000080">&lt;</font> ID, fInstantiator <font color="#000080">&gt;</font> classes <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">public</font> <font color="#008080">:</font> </li><li>  GenericObjectFactory <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> <font color="#008000">}</font> </li><li>  <font color="#0000ff">template</font> <font color="#000080">&lt;</font> <font color="#0000ff">class</font> Derived <font color="#000080">&gt;</font> <font color="#0000ff">void</font> add <font color="#008000">(</font> ID id <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  classes <font color="#008000">[</font> id <font color="#008000">]</font> <font color="#000080">=</font> <font color="#000040">&amp;</font> instantiator <font color="#000080">&lt;</font> Derived <font color="#000080">&gt;</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  fInstantiator get <font color="#008000">(</font> id id <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">return</font> classes <font color="#008000">[</font> id <font color="#008000">]</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  <font color="#008000">}</font> <font color="#008080">;</font> </li><li></li></ol></blockquote>  And that's it!  Isn't it elengant?  It seems to me that I exceeded the <a href="https://habrahabr.ru/users/rtorsten/" class="user_link">rtorsten</a> solution proposed in <a href="http://habr.ru/p/129202/">his article</a> at least three times. <br><br>  So what happens here: <ul><li>  <strong>First</strong> line: all you need is a <code>map</code> container.  In this case, take STL-evsky.  But the <code>QMap</code> also fits without problems. </li><li>  <strong>Third</strong> line: template definition.  About magic three points (variadic templates) can be read <a href="http://google.com/">in Google</a> , <a href="http://en.wikipedia.org/wiki/Variadic_template">on Wikipedia</a> , or even <a href="http://habr.ru/p/101430/">on Habr√©</a> (Respect to the FlexFerrum <a href="https://habrahabr.ru/users/flexferrum/" class="user_link">habrayuzer</a> ). </li><li>  <strong>Fifth</strong> : the definition of the <code>fInstantiator</code> type.  It is a <i>pointer to a function that returns a pointer to an object of type <code>Base</code> (a template parameter) and accepts arguments of types <code>Args ...</code> (also a template parameter, but there can be an arbitrary number, see variadic templates )</i> returned by the member function <code>get</code> (line 16 ). </li><li>  <strong>Sixth</strong> : just such a function, the same <code>instantiator</code> , about which we spoke, with the template.  This is necessary so that this function can be <i>specialized with the</i> <code>Derived</code> <i>class added to the factory</i> , which makes the template member function <code>void add&lt;class Derived&gt;</code> , and then <i>take it to the specialized function address (which only creates objects of this class) and place to the container</i> <code>std::map classes</code> as a value, where the key is an argument of the <code>void add&lt;class Derived&gt;</code> function <code>void add&lt;class Derived&gt;</code> type of <code>ID</code> (the first parameter of the factory template).  <code>instantiator</code> declared <code>static</code> for simplicity, but if you really need, you can use the so-called <a href="https://google.com/">member function pointers</a> . </li><li>  On the <strong>seventh</strong> line, the creation of an object actually takes place, and the constructor of this object is passed the arguments in the number and types specified in the factory specialization, and their <code>instantiator</code> , in fact, accepts their arguments.  Of course, in the same number and types, and of course, this is all known at compile time, and if none of the constructors of any of the classes added to the factory accepts arguments of these types, the compiler throws an error. </li><li>  <strong>The ninth</strong> line: the container in which the factory stores the classes added to it during execution.  The core of the factory.  The key, as we have said, is of the type specified by the first parameter of the template - everything is simple.  But the value is just that magic pointer to the template function.  After specialization (by any class inherited from <code>Base</code> ), the function has the same signature, that is, always (with any parameter of the template) takes the known and the same number and type of arguments, and always returns the value of the same known type - a pointer to an object of type <code>Base</code> .  That is, the original problem is solved!  :) </li><li>  <strong>The fourteenth</strong> line: the <code>add</code> function adds to <code>std::map classes</code> pair of <code>id</code> types <code>ID</code> (the first parameter of the class template) and the address of the static <code>instantiator</code> member function that was just specialized.  Already spoken. </li><li>  <strong>Seventeenth</strong> (well, I wanted to practice writing numerals) line: the <code>get</code> function returns a pointer to the <code>instantiator</code> desired class.  Please note that at the moment an object is not created, the user then does it himself using the issued <code>instantiator</code> .  This is exactly what I wanted to achieve. </li></ul><br>  Did I already say that I am new to <b>C ++</b> ?  :) So, it is quite possible that I lied in some places (or maybe only in some places I <i>did not</i> lie ...), but I can definitely say that it all works. <br><br>  Just take the last listing, insert it into the first one instead of <code>#include "factory.h"</code> and check the result in your favorite compiler, without forgetting to include support for the <b>C ++ 11</b> standard. <br><br>  PS In general, initially I wanted to leave my version of the factory with a comment on the first article, but for some reason I wrote a post ... in any case, I will be extremely happy to discuss, errors in drugs and ... do not hit hard.  :) <br><br>  PPS Oh!  I just wanted to send it, but I remembered that there is still <a href="http://ideone.com/">Ideone</a> !  Filled example there: <a href="http://ideone.com/5D5Fz1">you can admire</a> .  :) </div><p>Source: <a href="https://habr.com/ru/post/229993/">https://habr.com/ru/post/229993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229973/index.html">Books are not flat ...</a></li>
<li><a href="../229975/index.html">Real-time WebScada based on OPC UA and WebSocket technologies</a></li>
<li><a href="../229981/index.html">FedEx: part 2. We are leaving parcels for money: FedEx packaging lab</a></li>
<li><a href="../229985/index.html">Tao programming, part 1</a></li>
<li><a href="../229987/index.html">Building React reliable web applications: Part 3, testing with Jasmine</a></li>
<li><a href="../229997/index.html">Project Management Books</a></li>
<li><a href="../229999/index.html">Google Play Books in Ukraine</a></li>
<li><a href="../230001/index.html">Attracting investment in a startup - the book of Feld and Mendelssohn</a></li>
<li><a href="../230003/index.html">Syndrome of a step and a cut of attendance of Habr</a></li>
<li><a href="../230007/index.html">Hackathon @ JetBrains 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>