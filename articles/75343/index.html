<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make a handy utility for displaying laptop charging?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the fact that I saw a utility from IBM / Lenovo to show the laptop battery charge in an unusual place - in the taskbar / superbar,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make a handy utility for displaying laptop charging?</h1><div class="post__text post__text-html js-mediator-article">  It all started with the fact that I saw a utility from IBM / Lenovo to show the laptop battery charge in an unusual place - in the taskbar / superbar, but not as an icon, but as a panel (similar ones are used to control iTunes, WMP, Zune players): <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/038/92e/4d9/03892e4d99ef94303e5584c60eee974e.png"><br><br>  Because  I have laptops from another manufacturer, and I was too lazy to look for how to scratch this software from the manufacturer - I started looking for an analogue, and, to my great surprise, I did not find anything!  (if I'm wrong - show it with your nose, I will be very grateful!) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That is how I decided to write my decision.  We will write in C ++.  I wrote in Visual Studio 2010, you can use previous versions.  The main thing is the presence of the installed Windows SDK (installed separately from the studio, available for free, for example, you can download it <a href="http://www.microsoft.com/downloads/details.aspx%3Ffamilyid%3D71DEB800-C591-4F97-A900-BEA146E4FAE1%26displaylang%3Den">here</a> ) <br><br>  Here's what I got: <br><br><img src="http://pic.ipicture.ru/uploads/091116/hSZ5SqzZ3L.png" alt="My socket"><br><a name="habracut"></a><br>  Most of the time it took me to search the Internet for the name of the actual place where I wanted to cram the display of data.  It's called <b>DeskBand</b> , and best of all - the Windows SDK has an example of how it works!  (I have it at C: \ Program Files \ Microsoft SDKs \ Windows \ v7.0 \ Samples \ winui \ shell \ shellextensibility \ deskbands). <br><br>  Further, the case stood for small - it is necessary to find how to obtain information about the battery charge.  Search engine in combination with MSDN brought me to a useful function - RegisterPowerSettingNotification.  Its disadvantage is that it is supported only from Windows Vista, but this did not stop me, because  I wrote for myself and personally I already use Windows 7 everywhere. <br><br>  Here is its syntax: <br><br><blockquote><code><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> <font color="black">Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3811/s"></a> <a href="http://s-c.me/3811/h"></a> Copy Source | Copy HTML HPOWERNOTIFY WINAPI RegisterPowerSettingNotification( __in HANDLE hRecipient, __in LPCGUID PowerSettingGuid, __in DWORD Flags );</font></code> </li> <li></li></ol></blockquote><br><br>  This feature supports both work in services and in normal applications (which we will use). <br><br>  To start, I copied the example of working with DeskBand into a separate folder and began to edit it. <br><br>  I call it in the WM_CREATE event handler like this: <br><br><blockquote> <code><a href="http://s-c.me/3813/s"></a> <a href="http://s-c.me/3813/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  h1 = RegisterPowerSettingNotification (pDeskBand-&gt; m_hwnd, &amp; GUID_ACDC_POWER_SOURCE, DEVICE_NOTIFY_WINDOW_HANDLE); </li><li>  <font color="#0000ff">if</font> (h1 == <font color="#A31515">0</font> ) pDeskBand-&gt; CloseDW ( <font color="#A31515">1</font> ); </li><li></li><li>  h2 = RegisterPowerSettingNotification (pDeskBand-&gt; m_hwnd, &amp; GUID_BATTERY_PERCENTAGE_REMAINING, DEVICE_NOTIFY_WINDOW_HANDLE); </li><li>  <font color="#0000ff">if</font> (h2 == <font color="#A31515">0</font> ) </li><li>  { </li><li>  UnregisterPowerSettingNotification (h1); </li><li>  pDeskBand-&gt; CloseDW ( <font color="#A31515">1</font> ); </li><li>  } </li><li></li><li></li></ol></blockquote><br><br>  h1 and h2 are global (do not beat with your feet!) variables of type HPOWERNOTIFY, which is essentially the same HANDLE. <br>  So we signed up to receive cable insertion / removal events and changes in the remaining battery percentage.  You can also subscribe to change the power scheme using GUID_POWERSCHEME_PERSONALITY. <br>  By the way, do not forget to do UnregisterPowerSettingNotification for h1 and h2 in a destructor for example. <br><br>  I also started global (not kidneys only!) Variables for storing battery charge and charging status: <br><blockquote> <code><a href="http://s-c.me/3814/s"></a> <a href="http://s-c.me/3814/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  bool isOnBattery = <font color="#0000ff">false</font> ; </li><li>  <font color="#0000ff">int</font> charged = -1; </li><li></li></ol></blockquote><br><br>  And in the handler of the incoming WM_POWERBROADCAST event: <br><br><blockquote> <code><a href="http://s-c.me/3815/s"></a> <a href="http://s-c.me/3815/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  POWERBROADCAST_SETTING * pps = (POWERBROADCAST_SETTING *) lParam; </li><li>  <font color="#0000ff">if</font> ( <font color="#0000ff">sizeof</font> ( <font color="#0000ff">int</font> ) == pps-&gt; DataLength &amp;&amp; pps-&gt; PowerSetting == GUID_ACDC_POWER_SOURCE) </li><li>  { </li><li>  <font color="#0000ff">int</font> nPowerSrc = * ( <font color="#0000ff">int</font> *) (DWORD_PTR) pps-&gt; Data; </li><li>  isOnBattery = ( <font color="#A31515">0</font> ! = nPowerSrc); </li><li>  } </li><li>  <font color="#0000ff">else if</font> ( <font color="#0000ff">sizeof</font> ( <font color="#0000ff">int</font> ) == pps-&gt; DataLength &amp;&amp; pps-&gt; PowerSetting == GUID_BATTERY_PERCENTAGE_REMAINING) </li><li>  { </li><li>  charged = * ( <font color="#0000ff">int</font> *) (DWORD_PTR) pps-&gt; Data; </li><li>  } </li><li>  pDeskBand-&gt; OnPaint (NULL); </li><li></li></ol></blockquote><br><br>  What does this do?  When the WM_POWERBROADCAST event is received, a pointer to the POWERBROADCAST_SETTING structure is passed to lParam, which we get.  Because  this structure itself is also moderately perverted, then we are looking at which event this particular structure corresponds to. <br><br>  Further, if this is a charging connection event, then we see what happened.  0 is a battery, 1 is charging, 2 is UPS (I have never seen a subject lit up somewhere).  Well, save the result in the variable isOnBattery (true - if the battery, false - otherwise). <br><br>  If this event changes the% of the battery charge, then we keep the charge level for ourselves.  Next, call the redraw. <br><br>  First you need to decide what we will draw.  I was too lazy to look for beautiful pictures of batteries, so I decided to just print the text beautifully.  So first I form the line: <br><br><blockquote> <code><a href="http://s-c.me/3816/s"></a> <a href="http://s-c.me/3816/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  wchar_t * arr = (wchar_t *) malloc (1024);  // don't forget to do it later <font color="#0000ff">free</font> (arr); </li><li>  <font color="#0000ff">if</font> (charged&gt; = 0) </li><li>  _itow (charged, arr, 10); </li><li>  <font color="#0000ff">else</font> </li><li>  wcscpy (arr, L "?"); </li><li>  wcscat (arr, L "%"); </li><li>  <font color="#0000ff">if</font> (! isOnBattery) wcscat (arr, L "(+)"); </li><li></li></ol></blockquote><br><br>  Then I remember saying that I actually redraw ... <br><br><blockquote> <code><a href="http://s-c.me/3817/s"></a> <a href="http://s-c.me/3817/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  InvalidateRect (m_hwnd, &amp; rc, <font color="#0000ff">true</font> ); </li><li></li></ol></blockquote><br><br>  Further, two cases - included desktop composition or not.  Because  I do not use the old Windows theme and prefer Aero - then in the case of a disabled song I simply output the text: <br><br><blockquote> <code><a href="http://s-c.me/3818/s"></a> <a href="http://s-c.me/3818/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  SetBkColor (hdc, RGB (255, 255, 0)); </li><li>  GetTextExtentPointW (hdc, arr, wcslen (arr), &amp; <font color="#0000ff">size</font> ); </li><li>  TextOutW (hdc, (RECTWIDTH (rc) - <font color="#0000ff">size</font> .cx) / 2, (RECTHEIGHT (rc) - <font color="#0000ff">size</font> .cy) / 2, arr, wcslen (arr)); </li></ol></blockquote><br><br>  In the case of the included composition is a bit more complicated: <br><br><blockquote> <code><a href="http://s-c.me/3819/s"></a> <a href="http://s-c.me/3819/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  DTTOPTS dttOpts = { <font color="#0000ff">sizeof</font> (dttOpts)}; </li><li>  dttOpts.dwFlags = DTT_COMPOSITED |  DTT_TEXTCOLOR |  DTT_GLOWSIZE; </li><li>  <font color="#0000ff">int</font> red = <font color="#A31515">0</font> ; </li><li>  <font color="#0000ff">int</font> green = <font color="#A31515">0</font> ; </li><li>  <font color="#0000ff">if</font> (charged&gt; <font color="#A31515">0</font> ) </li><li>  { </li><li>  <font color="#0000ff">if</font> (charged&gt; <font color="#A31515">66</font> ) green = <font color="#A31515">255</font> ; </li><li>  <font color="#0000ff">else if</font> (charged&gt; <font color="#A31515">33</font> ) green = red = <font color="#A31515">255</font> ; </li><li>  <font color="#0000ff">else</font> red = <font color="#A31515">255</font> ; </li><li>  } </li><li>  dttOpts.crText = RGB (red, green, <font color="#A31515">0</font> ); </li><li>  dttOpts.iGlowSize = <font color="#A31515">10</font> ; </li><li></li><li>  DrawThemeTextEx (hTheme, hdcPaint, <font color="#A31515">0</font> , <font color="#A31515">0</font> , arr, - <font color="#A31515">1</font> , <font color="#A31515">0</font> , &amp; rcText, &amp; dttOpts); </li></ol></blockquote><br><br>  Actually, here I consider what color to draw charging (66-100% = green, 33-66% = yellow, 0-33% = red), and I draw, accordingly, the text. <br><br>  That's all.  You can build a project. <br>  I want to note that here I did not indicate the code that was in the example, only the one that was changed or added by me. <br>  After a successful build project, I got a dll-ku. <br><br>  From the experience of working with COM components and similar filth, I have executed the following command from the admin in the folder with the received DLL: <br> <code>regsvr32 DeskbandSDKSample.dll <br></code> <br><br>  Then I just turned on the corresponding panel through the context menu. <br><br>  That's all. <br><br>  Questions? </div><p>Source: <a href="https://habr.com/ru/post/75343/">https://habr.com/ru/post/75343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../75335/index.html">Spleen gave the go-ahead or how the waste with the nose remained</a></li>
<li><a href="../75336/index.html">QML - a new approach to building a GUI</a></li>
<li><a href="../75339/index.html">Full Text RSS</a></li>
<li><a href="../75340/index.html">Help with the choice of hosting</a></li>
<li><a href="../75342/index.html">A student of EF SPSU was convicted of hacking a faculty site - 2</a></li>
<li><a href="../75345/index.html">Thousands of logins and passwords from the accounts of the network "VKontakte" have come back to open access.</a></li>
<li><a href="../75346/index.html">We master ASP.NET MVC together. Introduction</a></li>
<li><a href="../75347/index.html">Evolution of the programmer</a></li>
<li><a href="../75349/index.html">Source Code Highlighting</a></li>
<li><a href="../75351/index.html">"Do not recommend" in the RSS for Habralenta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>