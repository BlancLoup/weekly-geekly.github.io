<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We wrote the most useful code in our life, but we threw it in the trash. Together with us</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I hung up a punching bag in my basement, stuck a stock photo of a typical manager on it and stuffed the speaker inside so that it would lose phrases t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We wrote the most useful code in our life, but we threw it in the trash. Together with us</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/va/e3/mo/vae3moqi-aj-wga-1pj1rqdujdo.jpeg"><br><br>  I hung up a punching bag in my basement, stuck a stock photo of a typical manager on it and stuffed the speaker inside so that it would lose phrases that make me angry.  For example, the pear says: ‚ÄúBusiness does not need your ideal code.  He needs to solve the problem so that the profit covers the costs.  If you need govnod for this, then there will be govnokod. ‚Äù  And I start to bludgeon. <br><br>  Recently, I added a note to the pear: ‚ÄúTypes are difficult and unnecessary.‚Äù  At this moment I hit so hard that my arm almost breaks.  Because that's enough for me.  A couple of months ago, I experienced one of the most egregious cases in my career. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My friend Anton asked me to help with the solution for one large-large corporation.  I agreed, and we climbed into the bottomless abyss of corporate absurdity, crunch, wars with incomprehensible colleagues and all kinds of injustice.  We can not say anything, so we will talk about types, so that such garbage would never be repeated. <br><a name="habracut"></a><br><h4>  one </h4><br>  <b>- ( <a href="https://habr.com/ru/users/rcanedu/" class="user_link">Anton rcanedu</a> )</b> I was assigned to develop an internal platform tool - a library for expressing software entities in the form of object-oriented models and for working uniformly with the services API.  That is, a tool for interacting with data that goes from the source to the display and back. <br><br>  In this way a huge number of formatting, conversions, calculations and conversions.  Huge structures, complex hierarchies, numerous connections with everything.  In such a web is very easy to get lost.  You see pieces of data and you do not know what can and cannot be done with them.  Spending a lot of time to figure it out.  This greatly delays the development.  The problem is solved only by a good description of the types. <br><br>  Due to the lack of appropriate typing in many solutions, it becomes more difficult to achieve the same program behavior at runtime and at compile time.  Types must give full confidence that everything is the same and will also occur during execution.  The same can give tests.  It is best to rely on both.  But if you choose between types and tests, types are much safer and cheaper. <br><br>  When you do the front, there are two sources of problems - the user and the backend.  With the user, everything is simple - there are many convenient libraries and frameworks abstracting from user I / O (react, angular, vue, and others). <br><br>  In interaction with backend another story.  Its types are numerous, and implementations - darkness.  One standard approach to the description of the data is not defined.  Because of this, they came up with crutches like ‚Äúnormalization of the data structure‚Äù, when all incoming data are reduced to a rigid structure, and if something goes wrong, exceptions start or work in abnormal mode.  This should speed up and simplify development, but in fact a lot of documentation, UML diagrams, feature descriptions are required. <br><br>  The architectural problem in the interaction of the client and server side arose because the frontend matured.  It became a full-fledged business, and not just a layout on top of the backend.  Previously, the interaction of the client and server was set only by the developers of the server side.  Now the fronts and backs are forced to negotiate and cooperate closely.  We need a tool that will allow us to structure work with the API of data source services, avoid losing the truth of data, and at the same time simplify further conversions.  This problem should be solved by the whole community. <br><br>  <b>- (Phil)</b> If you are a backender, you have plenty of adult solutions and data modeling practices for the application.  For example, in C # you figure the data model class.  You take a lib, any EntityFramework, lib delivers you the attributes with which you cover your models.  You tell Libe how to reach the base.  Then you use its interface for manipulating this data.  This thing is called ORM. <br><br>  In the frontend, we still have not decided how best to do it - we are looking for, trying, writing absurd articles, then refuting everything, starting anew and still will not come to a single solution. <br><br>  <b>- (Anton)</b> Everything that I wrote earlier had one big problem - narrow specialization.  Each time the library was developed from scratch and each time it was sharpened for one type of client-server interaction.  All this is due to the lack of suitable typing. <br><br>  I believe that without static typing it is difficult to imagine a universal library for working with API and domain expression.  There will be a lot of reflection in it, it will contain a huge amount of documentation, it will be overgrown with various applications indicating practices for a particular type.  This is not a simplification. <br><br>  A good universal tool of this kind should give a complete picture of the data in any slice in order to always know exactly how to work with this data, and why they are needed. <br><br>  <b>- (Phil)</b> Need lib, which will allow detailed description and management of each entity, obtaining data for this entity from different resources with different interfaces, from REST API and json-rpc to graphQL and NQL.  Which will allow to keep the expanding code base and structure in strictness and order.  Simple and intuitive to use.  At any time providing a complete and accurate description of the state of entities.  We want to abstract the modules of our users from the data layer as much as possible. <br><br>  First we looked at the existing one.  We did not like anything.  For some reason, all the libraries for working with data are made either on js, or with a bunch of any outside.  These any spoil everything.  They turn a blind eye to the developers, saying that such a library will not help you much, that you will not be able to navigate the types of your data, you will not be able to express their connections.  Everything gets worse when using multiple APIs of different types or it is heterogeneous. <br><br>  All of these libraries were not sufficiently protected by types.  Therefore, they create more problems than they solve.  It's easier not to use them, but to make your domain-specific solutions. <br><br>  Therefore, instead of the narrow-mindedness to which the task stood, we decided to do much more powerful and abstract - suitable for everything. And we incredibly believed that we were right, because it is only in this that truly good things are created. <br><br><hr><br><h4>  2 </h4><br>  <b>- (Anton)</b> As often happens, I waited for all types of access to be allowed into the company's repository.  And this can take several weeks.  In my case, it took only one.  At this time, based on my experience in creating similar libraries, I decomposed the task, estimated the time frame. <br><br>  The problem is that before, like everything, I made very narrowly specialized solutions.  The work on the universal tool attracted additional problems.  The type system was extremely complex, and neither I nor anyone else had any experience in designing this.  Worse, the developers around me didn‚Äôt imagine static typing at all. <br><br>  But I started doing what I thought was right.  I told the Daily what I was doing and why, but basically nobody understood me.  My questions to the team regarding the problem that had arisen always remained unanswered.  It was as if I did not exist.  A dude who does something very complex and incomprehensible. <br><br>  I understood that javaScript here will not work in any way.  I needed a YAP with a powerful typing model, excellent interaction with javaScript, which has a large community and a serious ecosystem. <br><br>  <b>- (Phil)</b> I waited a long time for the day when Anton understood the beauty of typeScript. <br><br>  <b>- (Anton)</b> But there are a number of problems in it that drive you crazy.  There is a typification, but the user still doesn‚Äôt have a perfect match between the execution of the program and the execution of the user.  At first, Typscript seems complicated.  He has to endure.  You always want to take and throw some object or any.  Gradually you go deep into the language, into its type system, and then the interesting begins to happen.  He becomes magical.  You can type everything at all. <br><br>  <b>- (Phil)</b> For the first time in our lives, we agreed on something and started. <br><br>  The first step - the user must describe the data scheme.  We pretend how it looks.  Something like this: <br><br><pre><code class="javascript">type CustomerSchema = { 
  id: number;
  name: string;
}
const Customer = new Model&lt;CustomerSchema&gt;(‚ÄòCustomer‚Äô);
</code></pre><br>
  ,    ,  .     id,     ,  ,   .<br>
     ,  .      ,        ,   -.   ,       ,    . <br>
<br>
,      .   ‚Äî   -   ,  .    ,      ,    .     :      ,    ,  .  .      :<br>
<br>
<pre><code class="javascript"> /**
   name: String
   String -   js -: StringConstructor
              
        
*/
const customerSchema = Schema.create({
  id: Number,
  name: String,
});
</code></pre><br>
    .    ,     ,    .   , Number  String   .     :     ,   . :<br>
<br>
<pre><code class="javascript">const customerSchema = Schema.create({
  id: 1,
  name: 2,
});
</code></pre><br>
     .     `Schema.create` ,      .  `if (!(property instanceof String)) throw new Error(¬´ , ¬ª)`.    . <br>
<br>
-,    , -,      .   ,       .   <abbr title=", , , , , , , - ‚Äî        ,       ."></abbr>   ,   ,        .<br>
<br>
    .         ,   Schema.create.<br>
<br>
 :<br>
<br>
<pre><code class="javascript">//      
type Map&lt;T&gt; = {
  [key: string]: T | Map&lt;T&gt;; 
};

/**
      ,
      ,
     .
*/
type NumberType = Template&lt;NumberConstructor, number, 'number'&gt;;
type StringType = Template&lt;StringConstructor, string, 'string'&gt;;
type SymbolType = Template&lt;SymbolConstructor, symbol, 'symbol'&gt;;
type BooleanType = Template&lt;BooleanConstructor, boolean, 'boolean'&gt;;
type DateType = Template&lt;DateConstructor, Date, 'date'&gt;;

interface ArrayType extends Array&lt;ExtractTypeValues&lt;Types&gt;&gt; {};

type Types = {
  Number: NumberType;
  String: StringType;
  Symbol: SymbolType;
  Boolean: BooleanType;
  Date: DateType;
  Array: ArrayType;
};
//    
type MapTypes= Map&lt;ApplyTemplate&lt;Types&gt;&gt;;
//     - 
type Declaration = ExtractInputTypes&lt;MapTypes&gt;;
interface Schema&lt;...&gt; {
 //   ,   .
 create: &lt;T extends Declaration&gt;(
    declaration: ConvertInstanceTypesToConstructorTypes&lt;T&gt;
  ) =&gt; Schema&lt;T&gt;;
};
</code></pre><br>
         ,        .      , ,   ,           ,    . <br>
<br>
<i>     ,          </i><br>
<br>
<pre><code class="javascript">type CustomerSchema = {
  id: number;
  name: string;
};
const customerSchema: CustomerSchema = Schema.create({
  id: Number,
  name: String,
});
</code></pre><br>
         . ,     ,       .<br>
<br>
          .      any.     ‚Äî    any,     100%,   ,    . <br>
<br>
   ,       ,    ,     .        .    `Schema.create`    .  99%      ,     .   ,    .   ‚Äî   !   ,    .<br>
<br>
 .    ,    ,     ,   .   .      :<br>
<br>
<pre><code class="javascript">const customerSchema = Schema.create({
 id: Number,
 name: String,
});

//   vscode  : id, name 
Schema.raw(customerSchema). 

//   
//    .
Schema.raw(customerSchema).id;

//        .
Schema.raw(customerSchema).neId;
</code></pre><br>
.             :<br>
<pre><code class="javascript">const customerSchema = Schema.create({
 id: Number,
 name: String,
});

if (true) {
  customerSchema.add({gender: String});
} 

//        ,
//      gender.
//  ,           
// .
Schema.raw(customerSchema).
</code></pre><br>
 ,      ,      ,      .        gender, ,       (,    ,   this  !).      -        .     ,        ,       .<br>
<br>
    ,     .      , ,     .    ,    .     .<br>
<br>
 :<br>
<br>
<pre><code class="javascript">const customerSchema = Schema.create({
 id: Number,
 name: String,
});

// customerSchema.add({gender: String});
//      ,    .
//  :
const customerWithGenderSchema = customerSchema.add({gender: String});

//   .
// :
Schema.raw(customerWithGenderSchema).
//  id, name, gender

// 
Schema.raw(customerSchema).
//  id, name
</code></pre><br>
    ,        ,    .    ,     .<br>
<br>
           :<br>
<br>
<pre><code class="javascript">const customerSchema = Schema.create({
 id: Number,
 name: String,
});

const repository = RepositoryManager.create(openApiDriver, { 
 // config
});
const Customer = Model.create(repository, customerSchema);

Customer.getAll().first().
//   ide  ,       id, name  gender.
//    ,   
Customer.getAll().first().age;
//   .    ,     , 
//   .
</code></pre><br>
   getAll   . <br>
 :<br>
<br>
<pre><code class="javascript">type MapSchemaToDriver&lt;S extends Schema, D extends Driver&gt; = 
  InferSchemaDeclaration&lt;S&gt; extends SchemaDeclaration
    ? InferDriverMethods&lt;D&gt; extends DriverTemplate&lt;IMRReader, IMRWriter&gt;
      ? Repository&lt;InferSchemaDeclaration&lt;S&gt;, InferDriverMethods&lt;D&gt;&gt;
      : never
    : never;

interface Repository&lt;D extends Driver, S extends Schema&gt; {
  get: &lt;T extends DSLTerm&gt;(dsl: ParseDSLTerm&lt;T&gt;) =&gt; MapSchemaToDriver&lt;S, D&gt; extends RepositoryTemplate ? ApplyDSLTerm&lt;MapSchemaToDriver&lt;S, D&gt;, T&gt; : Error&lt;‚Äôtype‚Äô, ‚ÄòType error‚Äô&gt;;
}
</code></pre><br>
 ,   : <br>
<br>
¬´,  B,      A,         ,   ,       ,      A.  . -     ¬ª. <br>
<br>
 .     .<br>
<br>
    ¬´¬ª  ,  ,             .    ,    .<br>
<br>
  .     ,          .   : <br>
<br>
¬´ ,       *--.*,      .  ,     id  . -     ,    ,    ¬ª.<br>
<br>
 .<br>
<br>
<hr><br>
<h4>2.5</h4><br>
   ,    ,  ,       .    .<br>
<br>
  ,      ‚Äî , ,    ,    .        .     ,     ,    .<br>
<br>
    ,        .        ,      ,     ,     ,     .          ,    ,      .<br>
<br>
<h3>   ODM   ORM ‚Äî  IMR (Isomorphic Model Representation) </h3><br>
 ,      ,  API    .  ,   .    ,    select-where ,    . <br>
<br>
  ‚Äî   ,       ,          . <br>
<br>
 .         .     .   ,   ,         ,  .  ,     ,         ,    ,   . <br>
<br>
   ,   ‚Äî      ,        ‚Äî   ,       -    . <br>
<br>
   .<br>
<br>
<hr><br>
<h4>3</h4><br>
<b>‚Äî ()</b>    ,   ,    .   ,  ,    ,   .     .     ,  ,   ,            . <br>
<br>
   -   ,    , ¬´     ¬ª.       ,     .        ,     ‚Äî    .     ,     , ,      <br>
<br>
 ,     .<br>
<br>
   . ,     ,   .   ,       ,   ,     .     .       .     ,      . ,     ,     ,   ,    .<br>
<br>
<b>‚Äî ()</b>      ,      ,   .     .    ,    ,     ,  . <br>
<br>
      ,   ,  .     .     ,   .<br>
 <br>
<b>‚Äî ()</b>    ,    .    ,        ,    .    .   ,           .       -   , , ,    ,      .<br>
<br>
     ,       -  .          ,        .   ,    .<br>
<br>
     , ,     .    ,       .      .<br>
<br>
<hr><br>
<h4>4</h4><br>
<b>‚Äî ()</b>    ,    ‚Äî  .   ! ?!      ,     ,     ,    ,  ,          ODM/ORM   - ,     .   ,      . ,         ,   ¬´-    , ¬ª.<br>
<br>
,    ,   .        .   ,  ,         .   . <br>
<br>
      ,   ,  -  ,  .    ‚Äî  ,    .<br>
<br>
       ,   .      -:<br>
<br>
<pre><code class="javascript">/*
     .
    ‚Äî .
       .
     
*/

import { View } from '@view';
import { Logger } from '@utils';

//   ‚Äî  ,    .
//         .
import { Robot } from '@domain/models';

// ,       
//   
function foo() {
 Robot.fetch({
   location: {
     area: 2,
     free: true,
     key: 'f49a6712', //    - compile-time checked
   }
 })
 .then(View.Grid.display)
 .catch(Logger.error);
}
</code></pre><br>
       ,     .    ,  ‚Äî    js/ts .       ,       . - -       ,       ,       ,    ‚Äî   Result .<br>
 <br>
           .       - Logger.Error,       .<br>
<br>
<pre><code class="javascript">/*
   :
       ,
         -  .
     - 
             .
     :
*/
import { Schema, Model } from 'imr';
import { Logger } from '@utils';
import { View } from '@view';
import { robotSchema } from '@domain/schemas';
import { batteryStationService } from '@domain/infrastructure/services/batteryStation';
import { Robot } from '@domain/models';
import { batteryNode } from '../services/nodeNames';

//       
// ,       ,       ,
//  ,        ¬´¬ª
const robotSchemaWithBattery =
  robotSchema
    .add('battery', Schema.union('li-ion', 'silicon'))
    .remove('speed');

// ,       
//     :
function foo(nodeName) {

 //   -:   -,      
 if (nodeName === batteryNode) {
   //   ,      
   const CustomerRobot = Model.create(robotSchemaWithBattery, batteryStationService);

   CustomerRobot
     //        .
     // , , 'li-notIon'  
     .fetch({ filter: { battery: 'li-ion' } })
    
     //   .
     //   ,      ,     ,   .
     //  ,      ,
     //      ,      .
     .then(View.Grid.display)
     .catch(Logger.error)

 } else {
   Robot
     .fetch()
     .then(View.Grid.display)
     .catch(Logger.error)
 }
}
</code></pre><br>
<hr><br>
<h4>5</h4><br>
<b>‚Äî ()</b>   ,   ,   ,   -  ,   .      ,  - ,   ,              . <br>
<br>
       .<br>
<br>
  ,  ,  ‚Äî  .    .      ,        ‚Äî    ,     ,   .       . ,    ,     ‚Äî    ,  .<br>
 <br>
        ,   :         .    .            . <br>
<br>
    ‚Äî        .       ,   .<br>
<blockquote>   : <a href="https://habr.com/ru/users/rcanedu/" class="user_link">rcanedu</a>, <a href="https://habr.com/ru/users/arttom/" class="user_link">arttom</a> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/454774/">https://habr.com/ru/post/454774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45476/index.html">My city.ru - a social network in an urban environment</a></li>
<li><a href="../454760/index.html">Intel Optane Memory M15 - faster than M10</a></li>
<li><a href="../454766/index.html">HBO, thank you for reminding me ... "Chernobyl first-aid kit" of a Belarusian pharmacist</a></li>
<li><a href="../45477/index.html">What kind of Internet startup students can come up with in one hour?</a></li>
<li><a href="../454770/index.html">Samsung Startup Membership - a new program for startups in Russia</a></li>
<li><a href="../454776/index.html">Freelance or office? Freelancer Answer</a></li>
<li><a href="../454778/index.html">The book "Machine learning: algorithms for business"</a></li>
<li><a href="../45478/index.html">In a galaxy far far away VTB24</a></li>
<li><a href="../454788/index.html">Weapons of a cautious investor: we consider the fair value of investment bonds</a></li>
<li><a href="../454790/index.html">Java Native Image: use test</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>