<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk. Integration with amoCRM, step-by-step guide</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the network, you can find instructions of different degrees of prescription and completeness of the information presented on the topic in the headl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk. Integration with amoCRM, step-by-step guide</h1><div class="post__text post__text-html js-mediator-article">  In the network, you can find instructions of different degrees of prescription and completeness of the information presented on the topic in the headline of the article, but even gathering them all together will require straight hands, a file and some patience to achieve the desired catharsis. <br><br><img src="https://habrastorage.org/files/144/746/d7c/144746d7c370456dbfb47c50a2007b3a.png"><br><br>  Here I will present my experience of connecting Asterisk to amoCRM in the form of step-by-step instructions, highlighting all the necessary nuances, ranging from obtaining an ssl certificate, setting up a web server and ending with a demonstration of the resulting bundle. <br><a name="habracut"></a><br>  * for the impatient, what will happen as a result of the executed manipulations see in <br>  <a href="https://habr.com/ru/post/325104/">end of article</a> <br><h3>  Introductory </h3><br>  On our test bench installed: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Debian OS <br><br><pre><code class="bash hljs">lsb_release -a No LSB modules are available. Distributor ID: Debian Description: Debian GNU/Linux 8.7 (jessie) Release: 8.7 Codename: jessie</code> </pre> <br></li><li>  IP PBX Asterisk <br><br><pre> <code class="bash hljs">*CLI&gt; core show version Asterisk 13.14.0 built by root @ asterisk.vistep.ru on a x86_64 running Linux on 2017-03-29 05:47:19 UTC</code> </pre> <br></li><li>  NGINX web server <br><br><pre> <code class="bash hljs">sudo nginx -v nginx version: nginx/1.10.3</code> </pre> <br></li><li>  PHP-FPM <br><br><pre> <code class="bash hljs">php5-fpm -v PHP 5.6.30-0+deb8u1 (fpm-fcgi) (built: Feb 8 2017 08:51:18) Copyright (c) 1997-2016 The PHP Group Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies with Zend OPcache v7.0.6-dev, Copyright (c) 1999-2016, by Zend Technologies</code> </pre> <br></li><li>  Test Domain Name <br><br><pre> <code class="bash hljs">tawny-owl:~$ dig +short asterisk.vistep.ru 138.201.164.52</code> </pre></li></ul><br><h3>  Get ssl certificate </h3><br>  In this guide, we will use a free certificate from Let's Encrypt. <br><br>  <i>Initially, I planned to use StartSSL and wrote step-by-step instructions for obtaining certificates there, but only after I noticed that no browser accepts their root certificates.</i> <br><br>  The procedure for obtaining it is quite trivial, but I still describe it in steps. <br><br><ol><li>  Go to the website <a href="https://letsencrypt.org/">letsencrypt.org</a> and click "Get Started" <br><br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f31/c20/275/f31c20275f7b46d5b5a4e6263534a778.png"><br></div></div><br></li><li>  Next we are interested in the section With Shell Access, in which we will find all the necessary instructions <br><br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d7e/a5e/937/d7ea5e937ac74acf84313334f4ad8011.png"><br></div></div></li><li>  Go to <a href="https://certbot.eff.org/">certbot.eff.org</a> and select our software. <br><br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/8bb/311/98c/8bb31198c9f64558bef8fc110ba0906f.png"><br></div></div></li><li>  Then follow the instructions and execute <br><br><div class="spoiler">  <b class="spoiler_title">several teams in kosnoli</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://ftp.debian.org/debian jessie-backports main"</span></span> &gt;&gt; /etc/apt/sources.list apt-get update apt-get install certbot -t jessie-backports</code> </pre><br></div></div></li><li>  Then you need to send a request for a certificate using the certbot utility. <br>  I went on the most primitive way: <br><br>  drove a team <br><br><pre> <code class="bash hljs">certbot certonly</code> </pre> <br>  and followed the steps of the wizard, where he indicated his email, the path to the webroot, the domain name, etc. <br><div class="spoiler">  <b class="spoiler_title">screenshots</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a08/649/962/a086499624aa4c07863e28187c84c166.png"><br><img src="https://habrastorage.org/files/7cc/4de/dab/7cc4dedabfea444da396eca43e3cc808.png"><br><img src="https://habrastorage.org/files/625/7eb/a96/6257eba9678e403eb227d8265dc23c32.png"><br><img src="https://habrastorage.org/files/e45/a6b/916/e45a6b9161ae48d9b6830342dac1166a.png"><br><img src="https://habrastorage.org/files/3a3/a53/a52/3a3a53a52392444aacf91234303da2c8.png"><br></div></div></li><li>  At the exit we see <br><br><div class="spoiler">  <b class="spoiler_title">cherished</b> <div class="spoiler_text"><pre> <code class="bash hljs">IMPORTANT NOTES: - Congratulations! Your certificate and chain have been saved at /etc/letsencrypt/live/asterisk.vistep.ru/fullchain.pem. Your cert will expire on 2017-06-27. To obtain a new or tweaked version of this certificate <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the future, simply run certbot again. To non-interactively renew *all* of your certificates, run <span class="hljs-string"><span class="hljs-string">"certbot renew"</span></span> - If you like Certbot, please consider supporting our work by: Donating to ISRG / Let<span class="hljs-string"><span class="hljs-string">'s Encrypt: https://letsencrypt.org/donate Donating to EFF: https://eff.org/donate-le</span></span></code> </pre></div></div></li><li>  Copy certificates to their locations <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cp /etc/letsencrypt/live/asterisk.vistep.ru/privkey.pem /etc/nginx/certs/vistep.ru.key cp /etc/letsencrypt/live/asterisk.vistep.ru/fullchain.pem /etc/nginx/certs/vistep.ru.pem</code> </pre></div></div></li></ol><br>  <i>As rightly noted in the comments, the lifetime of the received certificates is 3 months and they will need to be updated.</i>  <i>Take this into account!</i> <br><br><h3>  Web server setup </h3><br>  As stated in the introductory, we will use the NGINX web server. <br><br>  I will not begin to breed hollywar'ov and somehow motivate my choice, simply - we have NGINX and we will customize it. <br><br>  The basis of the config was the remarkable article by <a href="https://habrahabr.ru/users/dimasmirnov/" class="user_link">DimaSmirnov</a> <a href="https://habrahabr.ru/post/252821/">‚ÄúNginx and https.</a>  <a href="https://habrahabr.ru/post/252821/">We get class A + ‚Äù</a> , for which he, taking the opportunity, express my gratitude. <br><br>  So, the configuration file of the web server looks like this (some comments are given directly in the config): <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/asterisk.vistep.ru.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> asterisk.vistep.ru; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">138.201.164.52:80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> https://asterisk.vistep.ru<span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>? <span class="hljs-literal"><span class="hljs-literal">permanent</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/asterisk.vistep.ru.access.log; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/asterisk.vistep.ru.<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> asterisk.vistep.ru; <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">8.8.8.8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_stapling</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/nginx/certs/vistep.ru.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/nginx/certs/vistep.ru.key; <span class="hljs-attribute"><span class="hljs-attribute">ssl_dhparam</span></span> /etc/nginx/certs/dhparam.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_timeout</span></span> <span class="hljs-number"><span class="hljs-number">24h</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_cache</span></span> shared:SSL:<span class="hljs-number"><span class="hljs-number">2m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_protocols</span></span> TLSv1 TLSv1.<span class="hljs-number"><span class="hljs-number">1</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> kEECDH+AES128:kEECDH:kEDH:-3DES:kRSA+AES128:kEDH+3DES:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2; <span class="hljs-attribute"><span class="hljs-attribute">ssl_prefer_server_ciphers</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000;"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Security-Policy-Report-Only <span class="hljs-string"><span class="hljs-string">"default-src https:; script-src https: 'unsafe-eval' 'unsafe-inline'; style-src https: 'unsafe-inline'; img-src https: data:; font-src https: data:; report-uri /csp-report"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/asterisk; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.php index.html index.htm index.nginx-debian.html; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> records/ { <span class="hljs-attribute"><span class="hljs-attribute">autoindex</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">89.108.120.223</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">89.108.122.9</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">95.213.171.78</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">95.213.156.46</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">209.160.27.20</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">89.189.163.20</span></span>; <span class="hljs-comment"><span class="hljs-comment">#   -  amoCRM   ,   -  ,       ;)    - https://www.amocrm.ru/security/iplist.txt deny all; } location / { try_files $uri $uri/ =404; allow 89.108.120.223; allow 89.108.122.9; allow 95.213.171.78; allow 95.213.156.46; allow 209.160.27.20; allow 89.189.163.20; #   -  amoCRM   ,   -  ,       ;)    - https://www.amocrm.ru/security/iplist.txt deny all; } location ~ \.php$ { allow 89.108.120.223; allow 89.108.122.9; allow 95.213.171.78; allow 95.213.156.46; allow 209.160.27.20; allow 89.189.163.20; #   -  amoCRM   ,   -  ,       ;)    - https://www.amocrm.ru/security/iplist.txt deny all; fastcgi_pass unix:/var/run/php5-fpm.sock; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; fastcgi_buffers 16 16k; fastcgi_buffer_size 32k; } }</span></span></code> </pre><br></div></div><br>  In the folder / var / www / asterisk / (in my case) you need to create a symlink to the folder where the conversation recording files will be stored (I will tell about the recording of conversations below) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  cd / var / www / asterisk / <br>  ln -s / var / calls / records <br></div></div><br>  A few more words about certificates.  In addition to the vistep.ru.key and vistep.ru.pem already placed in their seats, we will also need dhparam.pem. <br><br><div class="spoiler">  <b class="spoiler_title">create it</b> <div class="spoiler_text"><pre> <code class="bash hljs">openssl dhparam -out /etc/nginx/certs/dhparam.pem 4096</code> </pre><br></div></div><br>  Behind this NGINX configuration, we‚Äôll finish and proceed to the Asterisk configuration. <br><br><h3>  IP PBX Asterisk configuration </h3><br>  In order for amoCRM to communicate with our Asterisk, manager.conf and http.conf you need to bring it to the form: <br><br><div class="spoiler">  <b class="spoiler_title">manager.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[general] enabled = yes port = 5038 bindaddr = 0.0.0.0 webenabled = yes httptimeout = 60 debug = on [amocrm] secret = JD3clEB8f4-_3ry84gJ deny = 0.0.0.0/0.0.0.0 permit = 127.0.0.1/255.255.255.0 <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> = cdr,reporting,originate write = reporting,originate</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">http.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[general] enabled=yes enablestatic=yes bindaddr=0.0.0.0 bindport=8088 prefix=asterisk</code> </pre><br></div></div><br>  Restart Asterisk and check if everything went up as we need <br><br><div class="spoiler">  <b class="spoiler_title">exhaust</b> <div class="spoiler_text"> <code>asterisk*CLI&gt; http show status <br> HTTP Server Status: <br> Prefix: /asterisk <br> Server: Asterisk/13.14.0 <br> Server Enabled and Bound to 0.0.0.0:8088 <br> <br> Enabled URI's: <br> /asterisk/httpstatus =&gt; Asterisk HTTP General Status <br> /asterisk/phoneprov/... =&gt; Asterisk HTTP Phone Provisioning Tool <br> /asterisk/amanager =&gt; HTML Manager Event Interface w/Digest authentication <br> /asterisk/arawman =&gt; Raw HTTP Manager Event Interface w/Digest authentication <br> /asterisk/manager =&gt; HTML Manager Event Interface <br> /asterisk/rawman =&gt; Raw HTTP Manager Event Interface <br> /asterisk/static/... =&gt; Asterisk HTTP Static Delivery <br> /asterisk/amxml =&gt; XML Manager Event Interface w/Digest authentication <br> /asterisk/mxml =&gt; XML Manager Event Interface <br> /asterisk/ari/... =&gt; Asterisk RESTful API <br> /asterisk/ws =&gt; Asterisk HTTP WebSocket <br> <br> Enabled Redirects: <br> None. <br> asterisk*CLI&gt; manager show settings <br> <br> Global Settings: <br> ---------------- <br> Manager (AMI): Yes <br> Web Manager (AMI/HTTP): Yes <br> TCP Bindaddress: 0.0.0.0:5038 <br> HTTP Timeout (minutes): 60 <br> TLS Enable: No <br> TLS Bindaddress: Disabled <br> TLS Certfile: asterisk.pem <br> TLS Privatekey: <br> TLS Cipher: <br> Allow multiple login: Yes <br> Display connects: Yes <br> Timestamp events: No <br> Channel vars: <br> Debug: Yes</code> <br> </div></div><br>  An example of a dialplan (I use ael, but I am sure that anyone can translate to lua or conf if desired): <br><br><div class="spoiler">  <b class="spoiler_title">extensions.ael</b> <div class="spoiler_text"><pre> <code class="bash hljs">globals { WAV=/var/calls; //   WAV MP3=/var/calls; //  mp3  RECORDING=1; // , 1 - . }; macro recording (calling,called) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RECORDING}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span>){ Set(fname=<span class="hljs-variable"><span class="hljs-variable">${UNIQUEID}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(${EPOCH}</span></span>,,%Y-%m-%d-%H_%M)}-<span class="hljs-variable"><span class="hljs-variable">${calling}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); Set(datedir=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(${EPOCH}</span></span>,,%Y/%m/%d)}); System(mkdir -p <span class="hljs-variable"><span class="hljs-variable">${WAV}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>); Set(monopt=nice -n 19 /usr/bin/lame -b 32 --silent <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${WAV}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${datedir}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.wav"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${MP3}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${datedir}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.mp3"</span></span> &amp;&amp; chmod o+r <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${MP3}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${datedir}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.*"</span></span>); Set(CDR(filename)=<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.mp3); Set(CDR(recordingfile)=<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.wav); Set(CDR(realdst)=<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); MixMonitor(<span class="hljs-variable"><span class="hljs-variable">${WAV}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.wav,b,<span class="hljs-variable"><span class="hljs-variable">${monopt}</span></span>); }; }; context dial_out { //    _[71]XX =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>,,tTr); Hangup(); } //    amoCRM! 100500 =&gt; { Set(DEFMAN=123); //     123 Set(TOEXT=<span class="hljs-variable"><span class="hljs-variable">${SHELL(wget -O - --quiet "https://vistepru.amocrm.ru/private/acceptors/asterisk_new/?redirect=Y&amp;number=${CALLERID(num)}</span></span>&amp;USER_LOGIN=ceo@vistep.ru&amp;USER_HASH=1dc1444b0d3172c1113ffea9078c575c<span class="hljs-string"><span class="hljs-string">")}); //     Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${TOEXT}</span></span></span><span class="hljs-string">,,tTr); //    //      ,      if ("</span></span><span class="hljs-variable"><span class="hljs-variable">${DIALSTSTUS}</span></span><span class="hljs-string"><span class="hljs-string">" != "</span></span>ANSWERED<span class="hljs-string"><span class="hljs-string">") { Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEFMAN}</span></span></span><span class="hljs-string">,,tTr); } HangUP(); } // end 100500 _XXXXXX =&gt; { NoOP(=== CALL FROM </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLERID(number)}</span></span></span><span class="hljs-string"> TO </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string"> ===); &amp;recording(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLERID(number)}</span></span></span><span class="hljs-string">,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">); Dial(SIP/83843</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">@multifon,180,tT); HangUP(); } // end of _XXXXXX _[78]XXXXXXXXXX =&gt; { NoOP(=== CALL TO </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string"> ===); &amp;recording(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLERID(number)}</span></span></span><span class="hljs-string">,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">); Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">@multifon,180,tT); HangUP(); }// end of _[78]XXXXXXXXXX _+7XXXXXXXXXX =&gt; { NoOP(=== CALL TO </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string"> ===); &amp;recording(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLERID(number)}</span></span></span><span class="hljs-string">,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">); Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">@multifon,180,tT); HangUP(); }// end of _+7XXXXXXXXXX //  ,   ,    _X. =&gt; { Hangup(); } } context default { //        _X. =&gt; { Hangup(); } }; context incoming { _[87]XXXXXXXXXX =&gt; { &amp;recording(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLERID(number)}</span></span></span><span class="hljs-string">,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">); Answer(); Set(CHANNEL(musicclass)=vistep.ru); Set(CUSTOMER_NAME=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SHELL(wget -O - --quiet "https://vistepru.amocrm.ru/private/acceptors/asterisk_new/?number=${CALLERID(num)}</span></span></span><span class="hljs-string">&amp;USER_LOGIN=ceo@vistep.ru&amp;USER_HASH=1dc1444b0d3172c1113ffea9078c575c"</span></span>|cut -d <span class="hljs-string"><span class="hljs-string">"|"</span></span> -f1)}); Set(CALLERID(name)=<span class="hljs-variable"><span class="hljs-variable">${CUSTOMER_NAME}</span></span>); Queue(queue_1,tT); NoOp(=== <span class="hljs-variable"><span class="hljs-variable">${HANGUPCAUSE}</span></span> ===); HangUP(); } }</code> </pre><br></div></div><br>  Important! <br><br>  In the context of incoming (as I called the context where I process incoming calls), in a single extension, there is such a line: <br><br><pre> <code class="bash hljs">Set(CUSTOMER_NAME=<span class="hljs-variable"><span class="hljs-variable">${SHELL(wget -O - --quiet "https://vistepru.amocrm.ru/private/acceptors/asterisk_new/?number=${CALLERID(num)}</span></span>&amp;USER_LOGIN=ceo@vistep.ru&amp;USER_HASH=1dc1444b0d3172c1113ffea9078c575c<span class="hljs-string"><span class="hljs-string">"|cut -d "</span></span>|<span class="hljs-string"><span class="hljs-string">" -f1)});</span></span></code> </pre> <br>  This team allows us to display on the phones of employees the full name of the calling customers, picking them up from amoCRM. <br><br>  Let us analyze the link from this command into components: <br><br><ol><li>  <a href="https://vistepru.amocrm.ru/private/acceptors/asterisk_new/">vistepru.amocrm.ru/private/acceptors/asterisk_new</a> ?  where instead of vistepru you should have your subdomain in amocrm </li><li>  USER_LOGIN=ceo@vistep.ru where your (admin's) should be specified instead of my email </li><li>  USER_HASH = 1dc1444b0d3172c1119593ffea9078c575c where instead of my API key (in the amoCRM interface ‚ÄúSettings‚Äù ‚Üí ‚ÄúAPI), specify your API key </li></ol><br>  Team work example <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/984/a86/13e/984a8613ecf4475c85a456ef0ac82b99.png"><br></div></div><br>  Now about the special extension 100500. Let me remind you that in the dialplan it looks like <br><br><div class="spoiler">  <b class="spoiler_title">So</b> <div class="spoiler_text"><pre> <code class="bash hljs">//    amoCRM! 100500 =&gt; { Set(DEFMAN=123); //     123 Set(TOEXT=<span class="hljs-variable"><span class="hljs-variable">${SHELL(wget -O - --quiet "https://vistepru.amocrm.ru/private/acceptors/asterisk_new/?redirect=Y&amp;number=${CALLERID(num)}</span></span>&amp;USER_LOGIN=ceo@vistep.ru&amp;USER_HASH=1dc1444b0d3172c1113ffea9078c575c<span class="hljs-string"><span class="hljs-string">")}); //     Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${TOEXT}</span></span></span><span class="hljs-string">,,tTr); //    //      ,      if ("</span></span><span class="hljs-variable"><span class="hljs-variable">${DIALSTSTUS}</span></span><span class="hljs-string"><span class="hljs-string">" != "</span></span>ANSWERED<span class="hljs-string"><span class="hljs-string">") { Dial(SIP/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEFMAN}</span></span></span><span class="hljs-string">,,tTr); } HangUP(); } // end 100500</span></span></code> </pre><br></div></div><br>  The link for wget is almost identical and the rules described above apply to it.  And he needed for the so-called.  ‚ÄúSmart call forwarding‚Äù, when the incoming call is forwarded by an employee to 100,500, and then Asterisk and amoCRM decide for themselves who to send it (read to the responsible manager or manager by default). <br><br>  Why is this useful, you ask?  Imagine the usual office situation: <br><br> <code>-     " " <br> -    , ,             : -   " "? (    !) <br> -     ,   <br> -            . <br></code> <br>  In conjunction with amoCRM, it will look like this: <br><br> <code>-     " " <br> -    , ,          100500 <br> - Asterisk  amoCRM      ,      <br> - PROFIT! <br></code> <br>  <i>For information, thanks to the guys from voxlink - <a href="https://voxlink.ru/kb/integraciya-s-crm/amocrm-asterisk/">voxlink.ru/kb/integraciya-s-crm/amocrm-asterisk</a></i> <br><br>  And yes, I completely forgot, if your Asterisk is not yet configured to maintain the database in MySQL, then in <a href="http://blog.vistep.ru/page/novyj-web-interfejs-statistiki-i-proslushivanija-vyzovov-dlja-ip-ats-asterisk">this article</a> you will find all the necessary instructions. <br><br>  Also, do not forget to add another field to the CDR label (you need to be able to listen to conversations on the client card in amoCRM) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  ALTER TABLE `cdr` ADD` recordingfile` VARCHAR (120) NOT NULL <br></div></div><br>  and execute a couple more commands <br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias recordingfile =&gt; recordingfile"</span></span> &gt;&gt; cdr_mysql.conf asterisk -rx <span class="hljs-string"><span class="hljs-string">'core restart now'</span></span></code> </pre><br></div></div><br><br><h3>  AmoCRM setup </h3><br>  At this point, we are waiting for the greatest number of rakes, so be careful. <br>  First of all, let's connect Asterisk in the amoCRM interface. <br><br>  To do this, go to "Settings" ‚Üí "Integration" ‚Üí we find there Asterisk and click "Install". <br>  We will see a description of the integration and a number of links to the guides, all this is boldly scrolling to the bottom to the input fields. <br><br>  Login - amocrm (from manager.conf) <br>  Password - JD3clEB8f4-_3ry84gJ (from manager.conf) <br>  The script path is _https: //asterisk.vistep.ru/amocrm.php <br><br>  As well as internal numbers of employees of your company. <br><br><div class="spoiler">  <b class="spoiler_title">screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/bd5/8af/70e/bd58af70e2ff49ba93b0108ce7ffd0d8.png"><br></div></div><br>  The next step is to configure the amocrm.php script. <br><br>  It can be downloaded from the link in the integration description, but I want to note that the one laid out here is fixed for a specific dialplan, or rather the specific context for dial_out call origination (line 99), in order to match the Asterisk settings on the stand.  Keep this in mind and change your context if it is different (this is necessary for making calls in a couple of clicks directly from amoCRM). <br><br><div class="spoiler">  <b class="spoiler_title">amocrm.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* amoCRM to asterisk integration. QSOFT LLC, All rights reserved. mailto: support</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@amocrm</span></span></span><span class="hljs-comment">.com. Date: 10.04.2012 rev: 102703 Cannot be redistributed without a written permission. _____ _____ __ __ / ____| __ \| \/ | __ _ _ __ ___ ___ | | | |__) | \ / | / _` | '_ ` _ \ / _ \| | | _ /| |\/| | | (_| | | | | | | (_) | |____| | \ \| | | |_ \__,_|_| |_| |_|\___/ \_____|_| \_\_| |_(_) */</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'log_errors'</span></span>,<span class="hljs-string"><span class="hljs-string">'On'</span></span>); ini_set(<span class="hljs-string"><span class="hljs-string">'error_log'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/log/php_errors.log'</span></span>); define(<span class="hljs-string"><span class="hljs-string">'AC_HOST'</span></span>,<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   AMI/AJAM define('AC_PORT',8088); //    (  8088) . http.conf Asterisk' define('AC_PREFIX','/asterisk/'); // . http.conf Asterisk' define('AC_TLS',false); define('AC_DB_CS','mysql:host=localhost;port=3306;dbname=asterisk'); //,   MySQL   Asterisk',     define('AC_DB_UNAME','asterisk_user'); //     define('AC_DB_UPASS','232wwQd293f_2edxse3e'); //   define('AC_TIMEOUT',0.75); define('AC_RECORD_PATH','https://asterisk.vistep.ru/records/%Y/%m/%d/#'); //,       define('AC_TIME_DELTA',7); // hours. Ex. GMT+4 = 4 $db_cs=AC_DB_CS; $db_u=!strlen(AC_DB_UNAME)?NULL:AC_DB_UNAME; $db_p=!strlen(AC_DB_UPASS)?NULL:AC_DB_UPASS; date_default_timezone_set('UTC'); if (AC_PORT&lt;1) die('Please, configure settings first!'); // die if not if (defined('AC_RECORD_PATH') AND !empty($_GET['GETFILE'])){ //get file. Do not check auth. (uniqueid is rather unique) $p=AC_RECORD_PATH; if (empty($p)) die('Error while getting file from asterisk'); try { $dbh = new PDO($db_cs, $db_u, $db_p); $sth = $dbh-&gt;prepare('SELECT calldate,recordingfile FROM cdr WHERE uniqueid= :uid'); $sth-&gt;bindValue(':uid',strval($_GET['GETFILE'])); $sth-&gt;execute(); $r = $sth-&gt;fetch(PDO::FETCH_ASSOC); if ($r===false OR empty($r['recordingfile'])) die('Error while getting file from asterisk'); $date=strtotime($r['calldate']); $replace=array(); $replace['#']=$r['recordingfile']; $dates=array('d','m','Y','y'); foreach ($dates as $d) $replace['%'.$d]=date($d,$date); // not a good idea! $p=str_replace(array_keys($replace),array_values($replace),$p); if (empty($_GET['noredirect'])) header('Location: '.$p); die($p); } catch (PDOException $e) { die('Error while getting file from asterisk'); } } // filter parameters from _GET foreach (array('login','secret','action') as $k){ if (empty($_GET['_'.$k])) die('NO_PARAMS'); $$k=strval($_GET['_'.$k]); } // trying to check accacess $loginArr=array( 'Action'=&gt;'Login', 'username'=&gt;$login, 'secret'=&gt;$secret, // 'Events'=&gt;'off', ); $resp=asterisk_req($loginArr,true); // problems? exiting if ($resp[0]['response']!=='Success') answer(array('status'=&gt;'error','data'=&gt;$resp[0])); //auth OK. Lets perform actions if ($action==='status'){ // list channels status $params=array( 'action'=&gt;'status'); $resp=asterisk_req($params); // report error of any if ($resp[0]['response']!=='Success') answer(array('status'=&gt;'error','data'=&gt;$resp[0])); // first an last chunks are useless unset($resp[end(array_keys($resp))],$resp[0]); // renumber keys for JSON $resp=array_values($resp); // report OK answer(array('status'=&gt;'ok','action'=&gt;$action,'data'=&gt;$resp)); }elseif ($action==='call'){ // originate a call $params=array( 'action'=&gt;'Originate', 'channel'=&gt;'SIP/'.intval($_GET['from']), 'Exten'=&gt;strval($_GET['to']), 'Context'=&gt;'dial_out', //was from-internal 'priority'=&gt;'2', 'Callerid'=&gt;'"'.strval($_GET['as']).'" &lt;'.intval($_GET['from']).'&gt;', 'Async'=&gt;'Yes', // Not Implemented: //'Callernumber'=&gt;'150', //'CallerIDName'=&gt;'155', ); $resp=asterisk_req($params,true); if ($resp[0]['response']!=='Success') answer(array('status'=&gt;'error','data'=&gt;$resp[0])); answer(array('status'=&gt;'ok','action'=&gt;$action,'data'=&gt;$resp[0])); } elseif ($action==='test_cdr'){ // test if DB connection params are OK. if (!class_exists('PDO')) answer(array('status'=&gt;'error','data'=&gt;'PDO_NOT_INSTALLED')); // we use PDO for accessing mySQL pgSQL sqlite within same algorythm try { $dbh = new PDO($db_cs, $db_u, $db_p); } catch (PDOException $e) { answer(array('status'=&gt;'error','data'=&gt;$e-&gt;getMessage())); } answer(array('status'=&gt;'ok','data'=&gt;'connection ok')); } elseif ($action==='cdr'){ // fetch call history try { $dbh = new PDO($db_cs, $db_u, $db_p); foreach (array('date_from','date_to') as $k){ $v=doubleval( (!empty($_GET[$k]))?intval($_GET[$k]):0 ); if ($v&lt;0) $v=time()-$v; $$k=$v; } if ($date_from&lt;time()-10*24*3600) $date_from=time()-7*24*3600; //retr. not more than 10d before $date_from=($date_from?$date_from+AC_TIME_DELTA*3600:0); //default 01-01-1970 $date_to =($date_to ?$date_to +AC_TIME_DELTA*3600:time()+AC_TIME_DELTA*3600);//default now() $sth = $dbh-&gt;prepare('SELECT calldate, src,dst,duration,billsec,uniqueid,recordingfile FROM cdr WHERE disposition=\'ANSWERED\' AND billsec&gt;=:minsec AND calldate&gt; :from AND calldate&lt; :to'); // BETWEEN is illegal on some bcknds header("X-REAL_DATE:" . gmdate('Ymd H:i:s',$date_from).'@'. gmdate('Ymd H:i:s',$date_to)); $sth-&gt;bindValue(':from', date('Ymd H:i:s',$date_from) ); $sth-&gt;bindValue(':to', date('Ymd H:i:s',$date_to)); $sth-&gt;bindValue(':minsec',!empty($_GET['minsec'])?$_GET['minsec']:5,PDO::PARAM_INT); $sth-&gt;execute(); //$sth-&gt;debugDumpParams(); var_dump($sth-&gt;errorInfo()); $r = $sth-&gt;fetchAll(PDO::FETCH_ASSOC); foreach ($r as $k=&gt;$v) $r[$k]['calldate']=date('Ymd H:i:s',strtotime($v['calldate'])-AC_TIME_DELTA*3600); answer(array('status'=&gt;'ok','data'=&gt;$r),true); } catch (PDOException $e) { answer(array('status'=&gt;'error','data'=&gt;$e-&gt;getMessage()),true); } } elseif ($action==='pop'){// fill test data. Maybe you will need it. Just comment line below. die(); $dbh = new PDO($db_cs, $db_u, $db_p); for ($i=0;$i&lt;(int)$_GET['n'];$i++){ $array=array( date('Ymd H:i:s',time()-rand(100,7*24*3600)), 'Auto &lt;150&gt;', 150,'791612345678','n/a','n/a','n/a','n/a','n/a',999, rand(7,999), 'ANSWERED',3,'',uniqid(),'','','' ); $str=array(); foreach ($array as $v) $str[]="'{$v}'"; $str=implode(', ',$str); $dbh-&gt;query("INSERT INTO cdr VALUES ({$str});"); } } /** MakeRequest to asterisk interfacees * @param $params -- array of req. params * @return array -- response */ function asterisk_req($params,$quick=false){ // lets decide if use AJAM or AMI return !defined('AC_PREFIX')?ami_req($params,$quick):ajam_req($params); } /** * Shudown function. Gently close the socket */ function asterisk_socket_shutdown(){ami_req(NULL);} /*** Make request with AMI * @param $params -- array of req. params * @param bool $quick -- if we need more than action result * @return array result of req */ function ami_req($params,$quick=false){ static $connection; if ($params===NULL and $connection!==NULL) { // close connection fclose($connection); return; } if ($connection===NULL){ $en=$es=''; $connection = fsockopen(AC_HOST, AC_PORT, $en, $es, 3); // trying to connect. Return an error on fail if ($connection) register_shutdown_function('asterisk_socket_shutdown'); else {$connection=NULL; return array(0=&gt;array('response'=&gt;'error','message'=&gt;'socket_err:'.$en.'/'.$es));} } // building req. $str=array(); foreach($params as $k=&gt;$v) $str[]="{$k}: {$v}"; $str[]=''; $str=implode("\r\n",$str); // writing fwrite($connection,$str."\r\n"); // Setting stream timeout $seconds=ceil(AC_TIMEOUT); $ms=round((AC_TIMEOUT-$seconds)*1000000); stream_set_timeout($connection,$seconds,$ms); // reading respomse and parsing it $str= ami_read($connection,$quick); $r=rawman_parse($str); //var_dump($r,$str); return $r; } /*** Reads data from coinnection * @param $connection -- active connection * @param bool $quick -- should we wait for timeout or return an answer after getting command status * @return string RAW response */ function ami_read($connection,$quick=false){ $str=''; do { $line = fgets($connection, 4096); $str .= $line; $info = stream_get_meta_data($connection); if ($quick and $line== "\r\n") break; }while ($info['timed_out'] == false ); return $str; } /*** Echo`s data * @param $array answer data * @param bool $no_callback shold we output as JSON or use callback function */ function answer($array,$no_callback=false){ header('Content-type: text/javascript;'); if (!$no_callback) echo "asterisk_cb(".json_encode($array).');'; else echo json_encode($array); die(); } /** Parse RAW response * @param $lines RAW response * @return array parsed response */ function rawman_parse($lines){ $lines=explode("\n",$lines); $messages=array(); $message=array(); foreach ($lines as $l){ $l=trim($l); if (empty($l) and count($message)&gt;0){ $messages[]= $message; $message=array(); continue;} if (empty($l)) continue; if (strpos($l,':')===false) continue; list($k,$v)=explode(':',$l); $k=strtolower(trim($k)); $v=trim($v); if (!isset( $message[$k])) $message[$k]=$v; elseif (!is_array( $message[$k])) $message[$k]=array( $message[$k],$v); else $message[$k][]=$v; } if (count($message)&gt;0) $messages[]= $message; return $messages; } /** Make request via AJAM * @param $params req. params * @return array parsed resp. */ function ajam_req($params){ static $cookie; // EveryRequest Ajam sends back a cookir, needed for auth handling if ($cookie===NULL) $cookie=''; // make req. and store cookie list($body,$cookie)= rq(AC_PREFIX.'rawman?'.http_build_query($params),$cookie); // parse an answer return rawman_parse($body); } /** make http req. to uri with cookie, parse resp and fetch a new cookie * @param $url * @param string $cookie * @return array ($body,$newcookie) */ function rq($url,$cookie=''){ // get RAW data $r=_rq($url,$cookie); // divide in 2 parts list($headersRaw,$body)=explode("\r\n\r\n",$r,2); // parse headers $headersRaw=explode("\r\n",$headersRaw); $headers=array(); foreach ($headersRaw as $h){ if (strpos($h,':')===false) continue; list($hname,$hv)=explode(":",$h,2); $headers[strtolower(trim($hname))]=trim($hv); } // fetch cookie if (!empty($headers['set-cookie'])){ $listcookies=explode(';',$headers['set-cookie']); foreach ($listcookies as $c){ list($k,$v)=explode('=',trim($c),2); if ($k=='mansession_id') $cookie=$v; } } return array($body,$cookie); } /** mare a request to URI and return RAW resp or false on fail * @param $url * @param $cookie * @return bool|string */ function _rq($url,$cookie){ $errno=$errstr=""; $fp = fsockopen(AC_HOST, AC_PORT, $errno, $errstr, 3); if (!$fp) return false; $out = "GET {$url} HTTP/1.1\r\n"; $out .= "Host: ".AC_HOST."\r\n"; if (!empty($cookie)) $out.="Cookie: mansession_id={$cookie}\r\n"; $out .= "Connection: Close\r\n\r\n"; fwrite($fp, $out); $r=''; while (!feof($fp)) $r.=fgets($fp); fclose($fp); return $r; }</span></span></code> </pre><br></div></div><br>  Note! <br><br>  My explanations to the parameters at the beginning of the script are given directly in the code. <br><br>  You can check the work of the script using the following links (note that I use my login / password and the path to the script, they should be different here): <br><br>  _https: //asterisk.vistep.ru/amocrm.php? _login = amocrm &amp; _secret = JD3clEB8f4-_3ry84gJ &amp; _action = test_cdr <br>  _https: //asterisk.vistep.ru/amocrm.php? _login = amocrm &amp; _secret = JD3clEB8f4-_3ry84gJ &amp; _action = status <br>  exhaust should be like on <br><br><div class="spoiler">  <b class="spoiler_title">screenshots</b> <div class="spoiler_text">  test_cdr <br><img src="https://habrastorage.org/files/692/c24/a2a/692c24a2a38b48fea3cca74ce86b3bd6.png"><br>  status <br><img src="https://habrastorage.org/files/171/3e2/546/1713e25460644a259a0d7066ba39b5ad.png"><br></div></div><br><h3>  Test the resulting bundle </h3><br><a name="Results"></a>  As a result of the settings made, we get the following features: <br><br><ul><li>  call display in amoCRM (if there is already a contact, the full name is displayed and you can go to the contact card, if not, create a new one-click) </li><li>  displaying the name of the contact from amoCRM on the phone during an incoming call </li><li>  the ability to make a call from the amoCRM interface in a couple of clicks </li><li>  forward the call to the responsible manager by transferring it to a special number </li></ul><br>  For the demonstration, the video format is best suited, so if you please: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/W7YI3u0ucQQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Conclusion </h3><br>  I hope this article I was able to completely close the issue of integration of amoCRM and Asterisk. <br>  If you have any questions, you are welcome in the comments. <br><br>  No account on Habr√©?  - My coordinates are profile, write, I will try to help. <br><br>  Asterisk is fun! <br>  Good luck to all! </div><p>Source: <a href="https://habr.com/ru/post/325104/">https://habr.com/ru/post/325104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325092/index.html">Several arguments against Dependency Injection and Inversion of Control</a></li>
<li><a href="../325094/index.html">‚ÄúPresent documents‚Äù or what will help to recognize a passport</a></li>
<li><a href="../325096/index.html">Kaggle: British satellite imagery. How we took the third place</a></li>
<li><a href="../325098/index.html">A new record in speech recognition: the error rate of the algorithm is reduced to 5.5%</a></li>
<li><a href="../325102/index.html">GTK3 applications in a browser with https and basic auth</a></li>
<li><a href="../325106/index.html">Vivaldi 1.8 - Immersion in history</a></li>
<li><a href="../325108/index.html">‚ÄúFifth Element‚Äù in R. Ecosystem. WYSIWYG Interface for Analysts</a></li>
<li><a href="../325110/index.html">We launch a simple blog on Wagtail CMS (Django) - part 3, final</a></li>
<li><a href="../325112/index.html">It's time to change: what will happen to working sites and why they are not the same</a></li>
<li><a href="../325114/index.html">The phenomenon of "Taobao villages"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>