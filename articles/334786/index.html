<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MMO from scratch. Part 2. Building functionality + Diamond Square algorithm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In the previous part we dealt with the basic architecture, network and messaging. Increase the functionality now. We make it possible to log in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MMO from scratch. Part 2. Building functionality + Diamond Square algorithm</h1><div class="post__text post__text-html js-mediator-article">  Hello!  In the previous part we dealt with the basic architecture, network and messaging.  Increase the functionality now.  We make it possible to log in by registering with a session id, which can be used in the future to manage the client during the game.  Next, we add a chat, in fact, everything works according to its principle: received a message - sent to the signatories.  Let's make it possible to create game rooms, where we will collect players and send them into battle.  Synchronize the movement of customers and finally check the shot on the test server.  There will be a lot of code, I continue the step by step description so that you can quickly figure it out and reproduce it for your needs.  For those who are not familiar with the first part, but want to bring something useful for themselves here and now, I added the implementation of the Diamond Square fractal landscape generation algorithm to the beginning.  Happy coding! <br><br>  <a href="https://habrahabr.ru/post/333788/">Part 1. The overall picture, the assembly of libraries, preparing the client and server for messaging</a> <br>  <a href="https://habrahabr.ru/post/334786/">Part 2. Building game functionality + Diamond Square algorithm</a> <br><br><img src="https://habrastorage.org/web/a46/b2b/467/a46b2b46748549079c512a693be39f90.jpg"><br><a name="habracut"></a><br><h3>  Diamond Square and Unreal Engine Algorithm </h3><br>  Diamond square gives one of the most realistic results.  The landscapes resulting from it, as a rule, are called fractal.  Different implementations of the algorithm are used in programs such as terragen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/4ac/b51/28e/4acb5128e4e24832b37b3c3bd8b53912.gif"><br><br>  The algorithm can be described in five steps: <br><ol><li>  Initialization of corner points.  Assigning heights to them by selecting random numbers. </li><li>  Finding the middle point, assigning it values, based on the average of the angular, plus a random number. </li><li>  Finding the middle points for diamonds marked with black dots (in this step, one point of each diamond goes beyond the array). </li><li>  For each square (there are 4 in this step), repeat step # 2. </li><li>  Repeat step number 3 for each diamond.  In rhombuses that have points on the edge of an array, one of the points goes outside the bounds of the array. </li></ol><br><img src="https://habrastorage.org/web/404/a3d/488/404a3d488fab41bd9af2e2afeb3586e2.png"><br><br>  You can find the implementation here: <br><br>  <a href="https://github.com/VadimDev/Unreal-Engine-diamond-square-algorithm">github.com/VadimDev/Unreal-Engine-diamond-square-algorithm</a> <br><br>  A few words about how I drew it in the engine.  One of the options was to create everything using DrawDebugLine, however, this does not work in a packed game, and besides, a timer with its lifetime is started for each line, which creates an additional load.  To draw lines or create Mesh at runtime, you need to create your UPrimitiveComponent, then in it a class derived from FPrimitiveSceneProxy, in which we override the GetDynamicMeshElements function (or DrawDynamicElements, if called and drawn once).  This function has access to FPrimitiveDrawInterface, which allows you to draw various primitives.  Override FPrimitiveSceneProxy * CreateSceneProxy () in UPrimitiveComponent and return from there an instance of the nested class derived from FPrimitiveSceneProxy.  To use a class, you need to create the BP of the actor and assign the component to it. <br><br>  <a href="https://habrahabr.ru/post/111538/">Algorithm "diamond-square" to build fractal landscapes</a> <br><br><h3>  For the cause!  Registration and Login </h3><br>  In the previous part we dealt with the network and messaging.  If there are difficulties or something does not converge, then look at the source of the project that you can get here: <br><br>  <a href="https://github.com/VadimDev/Spiky-Project">github.com/VadimDev/Spiky-Project</a> <br><br>  Let's start with the implementation of the interface and functionality, registration form and input.  To begin, create their view in the visual UMG editor. <br><br>  Create a folder Blueprints, in it Widgets.  As a basis, I always take HorizontalBox / VerticalBox, in which there can be a ScaleBox with different parameters.  As shown, this is the best option for auto-scaling for different screens.  The interface has a lot of attachments and in itself is quite complicated.  For tests, it is useful to have a temporary widget with a Canvas root, you can add a created widget to it and stretch it while watching for scaling. <br><br><img src="https://habrastorage.org/web/0b0/8a1/8e1/0b08a18e1f764387a8afd0c03b769592.PNG"><br><br>  We will not create widgets step by step.  You need <a href="">to take them and resources</a> to them from source codes and place in Widgets and ProjectResources. <br><br>  Now to the logic, we need to bind the interface to the code, we create a class inherited from UserWidget for each widget. <br><br>  <a href="https://wiki.unrealengine.com/Extend_UserWidget_for_UMG_Widgets">Extend UserWidget for UMG Widgets</a> <br>  <a href="https://docs.unrealengine.com/latest/INT/Programming/Slate/">docs.unrealengine.com/latest/INT/Programming/Slate</a> <br>  <a href="https://docs.unrealengine.com/latest/INT/Programming/Tutorials/UMG/">docs.unrealengine.com/latest/INT/Programming/Tutorials/UMG</a> <br><br>  Open Spiky_Server.Build.cs and add new modules necessary for working with UI: <br><br> <code>PrivateDependencyModuleNames.AddRange(new string[] { "UMG", "Slate", "SlateCore" }); <br></code> <br>  Create a UI folder and place the captions and the stub implementations there: <br><br><div class="spoiler">  <b class="spoiler_title">Login, login, server address setting widget and idle screen widget</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">LoginWidgets</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">LoginWidgets.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include &lt;string&gt; #include "LoginWidgets.generated.h" class UButton; class UTextBlock; class UEditableTextBox; UCLASS() class SPIKY_CLIENT_API ULoginWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; bool bMailOk = false; bool bPassOk = false; public: UButton* wSingUpButton = nullptr; UTextBlock* wInfoBlock = nullptr; UEditableTextBox* wMailTextBox = nullptr; UEditableTextBox* wPasswordTextBox = nullptr; UButton* wLoginButton = nullptr; UButton* wSettingsButton = nullptr; UFUNCTION() void SettingsButtonClicked(); UFUNCTION() void SingUpButtonClicked(); UFUNCTION() void LoginButtonClicked(); UFUNCTION() void OnMailTextChanged(const FText &amp; text); UFUNCTION() void OnPasswordTextChanged(const FText &amp; text); FTimerHandle MessageTimerHandle; void HideErrorMessage(); void ShowErrorMessage(FString msg); static std::string mail; static std::string password; };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">LoginWidgets.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "LoginWidgets.h" std::string ULoginWidgets::mail = ""; std::string ULoginWidgets::password = ""; void ULoginWidgets::NativeConstruct() { Super::NativeConstruct(); } void ULoginWidgets::LoginButtonClicked() { } void ULoginWidgets::SettingsButtonClicked() { } void ULoginWidgets::SingUpButtonClicked() { } void ULoginWidgets::HideErrorMessage() { } void ULoginWidgets::ShowErrorMessage(FString msg) { } void ULoginWidgets::OnMailTextChanged(const FText &amp; text) { } void ULoginWidgets::OnPasswordTextChanged(const FText &amp; text) { }</span></span></code> </pre><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">RegWidgets</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">RegWidgets.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "RegWidgets.generated.h" class UButton; class UImage; class UEditableTextBox; class UTextBlock; class UTexture2D; UCLASS() class SPIKY_CLIENT_API URegWidgets : public UUserWidget { GENERATED_BODY() URegWidgets(const FObjectInitializer&amp; ObjectInitializer); virtual void NativeConstruct() override; public: UButton* wReloadCaptchaButton = nullptr; UImage* wCaptchaImage = nullptr; UImage* wLoginImage = nullptr; UImage* wPassImage = nullptr; UImage* wMailImage = nullptr; UImage* wCaptchaCheckImage = nullptr; UTexture2D* accept_tex = nullptr; UTexture2D* denied_tex = nullptr; UTexture2D* empty_tex = nullptr; UEditableTextBox* wLoginTextBox = nullptr; UEditableTextBox* wPasswordTextBox = nullptr; UEditableTextBox* wMainTextBox = nullptr; UEditableTextBox* wCaptchaTextBox = nullptr; UTextBlock* wInfoBlock = nullptr; UButton* wShowTermsPrivacyButton = nullptr; UButton* wCloseButton = nullptr; UButton* wSingUpButton = nullptr; UFUNCTION() void SingUpButtonClicked(); UFUNCTION() void CloseButtonClicked(); UFUNCTION() void ShowTermPrivacyClicked(); UFUNCTION() void ReloadCaptchaClicked(); UFUNCTION() void OnLoginTextChanged(const FText &amp; text); UFUNCTION() void OnPasswordTextChanged(const FText &amp; text); UFUNCTION() void OnMailTextChanged(const FText &amp; text); UFUNCTION() void OnCaptchaTextChanged(const FText &amp; text); bool bLoginOk = false; bool bPassOk = false; bool bMailOk = false; bool bCaptchaOk = false; };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">RegWidgets.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "RegWidgets.h" URegWidgets::URegWidgets(const FObjectInitializer &amp; ObjectInitializer) : Super(ObjectInitializer) { } void URegWidgets::NativeConstruct() { Super::NativeConstruct(); } void URegWidgets::CloseButtonClicked() { } void URegWidgets::ShowTermPrivacyClicked() { } void URegWidgets::ReloadCaptchaClicked() { } void URegWidgets::OnLoginTextChanged(const FText &amp; text) { } void URegWidgets::OnPasswordTextChanged(const FText &amp; text) { } void URegWidgets::OnMailTextChanged(const FText &amp; text) { } void URegWidgets::OnCaptchaTextChanged(const FText &amp; text) { } void URegWidgets::SingUpButtonClicked() { }</span></span></code> </pre><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SetServerWidgets</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">SetServerWidgets.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "SetServerWidgets.generated.h" class UEditableTextBox; UCLASS() class SPIKY_CLIENT_API USetServerWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; UEditableTextBox* wAddressBox = nullptr; UEditableTextBox* wPortBox = nullptr; public: void SetAddress(); };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SetServerWidgets.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SetServerWidgets.h" #include "SocketObject.h" #include "Runtime/UMG/Public/Components/EditableTextBox.h" void USetServerWidgets::NativeConstruct() { Super::NativeConstruct(); wAddressBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("AddressBox"))); wPortBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("PortBox"))); // default value uint32 OutIP; USocketObject::tcp_address-&gt;GetIp(OutIP); //  ip   FString ip = FString::Printf(TEXT("%d.%d.%d.%d"), 0xff &amp; (OutIP &gt;&gt; 24), 0xff &amp; (OutIP &gt;&gt; 16), 0xff &amp; (OutIP &gt;&gt; 8), 0xff &amp; OutIP); wAddressBox-&gt;SetText(FText::FromString(ip)); wPortBox-&gt;SetText(FText::FromString(FString::FromInt(USocketObject::tcp_address-&gt;GetPort()))); } void USetServerWidgets::SetAddress() { uint32 OutIP; USocketObject::tcp_address-&gt;GetIp(OutIP); //  ip   FString oldIP = FString::Printf(TEXT("%d.%d.%d.%d"), 0xff &amp; (OutIP &gt;&gt; 24), 0xff &amp; (OutIP &gt;&gt; 16), 0xff &amp; (OutIP &gt;&gt; 8), 0xff &amp; OutIP); FString oldPort = FString::FromInt(USocketObject::tcp_address-&gt;GetPort()); //     FIPv4Address serverIP; FIPv4Address::Parse(wAddressBox-&gt;GetText().ToString(), serverIP); int32 serverPort = FCString::Atoi(*(wPortBox-&gt;GetText().ToString())); FString newIP = serverIP.ToString(); FString newPort = FString::FromInt(serverPort); GLog-&gt;Log(newIP + " " + newPort); //       if (!oldIP.Equals(*newIP, ESearchCase::IgnoreCase) || !oldPort.Equals(*newPort, ESearchCase::IgnoreCase)) { GLog-&gt;Log("Address change"); USocketObject::tcp_address-&gt;SetIp(serverIP.Value); USocketObject::tcp_address-&gt;SetPort(FCString::Atoi(*(wPortBox-&gt;GetText().ToString()))); USocketObject::Reconnect(); } }</span></span></code> </pre><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SSButtonWidgets</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">SSButtonWidgets.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "SSButtonWidgets.generated.h" class UButton; UCLASS() class SPIKY_CLIENT_API USSButtonWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; UButton* wSettingsButton = nullptr; UFUNCTION() void SettingsButtonClicked(); };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SSButtonWidgets.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SSButtonWidgets.h" #include "Runtime/UMG/Public/Components/Button.h" void USSButtonWidgets::NativeConstruct() { Super::NativeConstruct(); wSettingsButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("SettingsButton"))); wSettingsButton-&gt;OnClicked.AddDynamic(this, &amp;USSButtonWidgets::SettingsButtonClicked); } void USSButtonWidgets::SettingsButtonClicked() { }</span></span></code> </pre><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">WSWidgets</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">WSWidgets.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Spiky_Client.h" #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "Runtime/UMG/Public/Components/Image.h" #include "WSWidgets.generated.h" UCLASS() class SPIKY_CLIENT_API UWSWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: FTimerHandle MessageTimerHandle; bool once = true; UImage * wGear1 = nullptr; UImage * wGear2 = nullptr; FWidgetTransform transform1; FWidgetTransform transform2; void GearsAnim(); };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">WSWidgets.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "WSWidgets.h" #include "Runtime/Engine/Public/TimerManager.h" void UWSWidgets::NativeConstruct() { Super::NativeConstruct(); if (once) { once = false; GetWorld()-&gt;GetTimerManager().SetTimer(MessageTimerHandle, this, &amp;UWSWidgets::GearsAnim, 0.01f, true); } wGear1 = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("Gear1"))); wGear2 = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("Gear2"))); } void UWSWidgets::GearsAnim() { transform1.Angle += 1; wGear1-&gt;SetRenderTransform(transform1); transform2.Angle -= 1; wGear2-&gt;SetRenderTransform(transform2); }</span></span></code> </pre><br></div></div><br></div></div><br></div></div><br>  In the UMG editor, each widget can have a name through which it will be accessible from the code.  In the constructor, we find the widget by this name and initialize: <br><br><pre> <code class="cpp hljs">USetServerWidgets::NativeConstruct() wAddressBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT(<span class="hljs-string"><span class="hljs-string">"AddressBox"</span></span>))); wPortBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT(<span class="hljs-string"><span class="hljs-string">"PortBox"</span></span>)));</code> </pre><br>  In the SetServerWidgets widget we get a static address, return it to a normal view.  And fill them with the wAddressBox and wPortBox fields: <br><br><pre> <code class="cpp hljs">USetServerWidgets::SetAddress()       ,                      USocketObject::Reconnect()</code> </pre><br>  The SSButtonWidgets widget is the only function to show and hide SetServerWidgets always on top of everything else. <br><br>  To place widgets in layers, we need to create a WidgetsContainer with a single UCanvasPanel element: <br><br><div class="spoiler">  <b class="spoiler_title">Widgetcontainer</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "WidgetsContainer.generated.h" class UCanvasPanel; UCLASS() class SPIKY_CLIENT_API UWidgetsContainer : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UCanvasPanel * wCanvas = nullptr; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "WidgetsContainer.h" #include "Runtime/UMG/Public/Components/CanvasPanel.h" #include "CanvasPanelSlot.h" void UWidgetsContainer::NativeConstruct() { Super::NativeConstruct(); wCanvas = Cast&lt;UCanvasPanel&gt;(GetWidgetFromName(TEXT("Canvas"))); }</span></span></code> </pre><br></div></div><br>  Now open the Unreal Editor, open the WidgetContainer widget that has the default kenvas, assign it the name Canvas so that we can find it in the code (if not already assigned), assign the new parents to the created widgets, go from Designer to Graph, select Edit Class Settings and change the Parent Class to the corresponding name of the C ++ class. <br><br>  Let's start placing widgets, for this we use the previously created DifferentMix.  Add forward-looking ads, a constructor, a set of temporary links to the received instances, the GetWorld () function, through the DifferentMix instance we can also get a link to the current world, changing from GameMode to GameMode, the widgets themselves that are created based on the links, and their slots on Canvas <br><br><div class="spoiler">  <b class="spoiler_title">DifferentMix</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "CoreMinimal.h" #include "UObject/NoExportTypes.h" #include "DifferentMix.generated.h" class UWidgetsContainer; class UCanvasPanelSlot; class URegWidgets; class ULoginWidgets; class USSButtonWidgets; class USetServerWidgets; class UUserWidget; class UWSWidgets; /** * World singleton, stores references to widgets and rare functions */ UCLASS() class SPIKY_CLIENT_API UDifferentMix : public UObject { GENERATED_BODY() UDifferentMix(const FObjectInitializer&amp; ObjectInitializer); UWidgetsContainer* tmpWidgetContainerRef; URegWidgets* tmpRegistrationRef; ULoginWidgets* tmpLoginScreenRef; USSButtonWidgets* tmpServerSettingsButtonRef; USetServerWidgets* tmpServerSettingsRef; UUserWidget* tmpTermsPrivacyRef; UWSWidgets* tmpWaitingScreenRef; public: virtual class UWorld* GetWorld() const override; void Init(); UWidgetsContainer* wWidgetContainer; URegWidgets* wRegistration; ULoginWidgets* wLoginScreen; USSButtonWidgets* wServerSettingsButton; USetServerWidgets* wServerSettings; UUserWidget* wTermsPrivacy; UWSWidgets* wWaitingScreen; UCanvasPanelSlot* registrationSlot; UCanvasPanelSlot* loginScreenSlot; UCanvasPanelSlot* serverSettingsButtonsSlot; UCanvasPanelSlot* serverSettingsSlot; UCanvasPanelSlot* TermsPrivacySlot; UCanvasPanelSlot* waitingScreenSlot; };</span></span></code> </pre><br></div></div><br>  To create each widget we need access to the current game world, we will initialize DifferentMix to GameMode and save the reference to the world in GameInstance.  Add to SpikyGameInstance: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// .h static UWorld* world; void DifferentMixInit(UWorld* the_world); static UDifferentMix * DifferentMix;</span></span></code> </pre><br>  Create a DifferentMix object and add it to root, this will prevent its being destroyed by the garbage collector, we will call Init to create a set of widgets for us: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// .cpp UWorld* UClientGameInstance::world = nullptr; UDifferentMix * UClientGameInstance::DifferentMix = nullptr; void USpikyGameInstance::DifferentMixInit(UWorld* the_world) { GLog-&gt;Log("DifferentMixInit"); world = the_world; DifferentMix = NewObject&lt;UDifferentMix&gt;(UDifferentMix::StaticClass()); DifferentMix-&gt;AddToRoot(); DifferentMix-&gt;Init(); }</span></span></code> </pre><br>  Now we need a valid reference to the world, we can‚Äôt get it in SpikyGameInstance as it is an object independent of the current world, but the GameMode is perfect, we‚Äôll add DifferentMix initialization to ASpikyGameMode :: BeginPlay (): <br><br><pre> <code class="cpp hljs">USpikyGameInstance* gameInstance = Cast&lt;USpikyGameInstance&gt;(GetWorld()-&gt;GetGameInstance()); gameInstance-&gt;DifferentMixInit(GetWorld());</code> </pre><br>  Create widgets in UDifferentMix :: Init () and place them on the canvas slot: <br><br><pre> <code class="cpp hljs">wWidgetContainer = CreateWidget&lt;UWidgetsContainer&gt;(GetWorld(), tmpWidgetContainerRef-&gt;GetClass()); wWidgetContainer-&gt;AddToViewport(); wRegistration = CreateWidget&lt;URegWidgets&gt;(GetWorld(), tmpRegistrationRef-&gt;GetClass()); registrationSlot = Cast&lt;UCanvasPanelSlot(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wRegistration)); registrationSlot-&gt;SetZOrder(<span class="hljs-number"><span class="hljs-number">0</span></span>); registrationSlot-&gt;SetAnchors(FAnchors(<span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>)); registrationSlot-&gt;SetOffsets(FMargin(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); wRegistration-&gt;SetVisibility(ESlateVisibility::Hidden);</code> </pre><br>  We create widgets from links, add them to the canvas, stretch them, set the depth of SetZOrder, on top of which it should be and set the initial visibility. <br><br>  Any new widget in the project is added like this: <br><br><ol><li>  UMG interface and CPP parent are created; </li><li>  In DifferentMix, a preliminary declaration is declared: class URegWidgets; </li><li>  Link to widget URegWidgets * tmpRegistrationRef; </li><li>  The WRegWidgets widget itself * wRegistration; </li><li>  And the Canvas slot: UCanvasPanelSlot * registrationSlot; </li><li>  After in the constructor, initialize the link <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ConstructorHelpers::FClassFinder&lt;URegWidgets&gt; RegistrationWidgets(TEXT(<span class="hljs-string"><span class="hljs-string">"WidgetBlueprint'/Game/Blueprints/Widgets/Reg_W.Reg_W_C'"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RegistrationWidgets.Class != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { tmpRegistrationRef = RegistrationWidgets.Class-&gt;GetDefaultObject&lt;URegWidgets&gt;(); }</code> </pre><br></li><li>  Then in UDifferentMix :: Init () we create the widget and place it in the slot: <br><pre> <code class="cpp hljs">wRegistration = CreateWidget&lt;URegWidgets&gt;(GetWorld(), tmpRegistrationRef-&gt;GetClass()); registrationSlot = Cast&lt;UCanvasPanelSlot(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wRegistration)); registrationSlot-&gt;SetZOrder(<span class="hljs-number"><span class="hljs-number">0</span></span>); registrationSlot-&gt;SetAnchors(FAnchors(<span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>)); registrationSlot-&gt;SetOffsets(FMargin(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); wRegistration-&gt;SetVisibility(ESlateVisibility::Hidden);</code> </pre></li></ol><br>  When you start the game, we need to show the LoginScreen, for this we will add two new call features in DifferentMix: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HideAllWidgets</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowLoginScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowMouse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Current state of DifferentMix</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "CoreMinimal.h" #include "UObject/NoExportTypes.h" #include "DifferentMix.generated.h" class UWidgetsContainer; class UCanvasPanelSlot; class URegWidgets; class ULoginWidgets; class USSButtonWidgets; class USetServerWidgets; class UUserWidget; class UWSWidgets; /** * World singleton, stores references to widgets and rare functions */ UCLASS() class SPIKY_CLIENT_API UDifferentMix : public UObject { GENERATED_BODY() UDifferentMix(const FObjectInitializer&amp; ObjectInitializer); UWidgetsContainer* tmpWidgetContainerRef; URegWidgets* tmpRegistrationRef; ULoginWidgets* tmpLoginScreenRef; USSButtonWidgets* tmpServerSettingsButtonRef; USetServerWidgets* tmpServerSettingsRef; UUserWidget* tmpTermsPrivacyRef; UWSWidgets* tmpWaitingScreenRef; public: virtual class UWorld* GetWorld() const override; void Init(); UWidgetsContainer* wWidgetContainer; URegWidgets* wRegistration; ULoginWidgets* wLoginScreen; USSButtonWidgets* wServerSettingsButton; USetServerWidgets* wServerSettings; UUserWidget* wTermsPrivacy; UWSWidgets* wWaitingScreen; UCanvasPanelSlot* registrationSlot; UCanvasPanelSlot* loginScreenSlot; UCanvasPanelSlot* serverSettingsButtonsSlot; UCanvasPanelSlot* serverSettingsSlot; UCanvasPanelSlot* TermsPrivacySlot; UCanvasPanelSlot* waitingScreenSlot; void HideAllWidgets(); void ShowLoginScreen(); void ShowMouse(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "DifferentMix.h" #include "SpikyGameInstance.h" #include "WidgetsContainer.h" #include "RegWidgets.h" #include "LoginWidgets.h" #include "SSButtonWidgets.h" #include "SetServerWidgets.h" #include "WSWidgets.h" #include "Runtime/UMG/Public/Components/CanvasPanel.h" #include "CanvasPanelSlot.h" #include "Runtime/CoreUObject/Public/UObject/ConstructorHelpers.h" UDifferentMix::UDifferentMix(const FObjectInitializer&amp; ObjectInitializer) : Super(ObjectInitializer) { static ConstructorHelpers::FClassFinder&lt;UWidgetsContainer&gt; WidgetContainer(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/WidgetContainer.WidgetContainer_C'")); if (WidgetContainer.Class != NULL) { tmpWidgetContainerRef = WidgetContainer.Class-&gt;GetDefaultObject&lt;UWidgetsContainer&gt;(); } static ConstructorHelpers::FClassFinder&lt;URegWidgets&gt; RegistrationWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/Reg_W.Reg_W_C'")); if (RegistrationWidgets.Class != NULL) { tmpRegistrationRef = RegistrationWidgets.Class-&gt;GetDefaultObject&lt;URegWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;ULoginWidgets&gt; LoginWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/Login_W.Login_W_C'")); if (LoginWidgets.Class != NULL) { tmpLoginScreenRef = LoginWidgets.Class-&gt;GetDefaultObject&lt;ULoginWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;USSButtonWidgets&gt; SetServerButtonWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/SSButton_W.SSButton_W_C'")); if (SetServerButtonWidgets.Class != NULL) { tmpServerSettingsButtonRef = SetServerButtonWidgets.Class-&gt;GetDefaultObject&lt;USSButtonWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;USetServerWidgets&gt; ServerSettingsWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/SetServer_W.SetServer_W_C'")); if (ServerSettingsWidgets.Class != NULL) { tmpServerSettingsRef = ServerSettingsWidgets.Class-&gt;GetDefaultObject&lt;USetServerWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;UUserWidget&gt; TermsPrivacyWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/Terms_Privacy_W.Terms_Privacy_W_C'")); if (TermsPrivacyWidgets.Class != NULL) { tmpTermsPrivacyRef = TermsPrivacyWidgets.Class-&gt;GetDefaultObject&lt;UUserWidget&gt;(); } static ConstructorHelpers::FClassFinder&lt;UWSWidgets&gt; WaitingScreenWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/WS_W.WS_W_C'")); if (WaitingScreenWidgets.Class != NULL) { tmpWaitingScreenRef = WaitingScreenWidgets.Class-&gt;GetDefaultObject&lt;UWSWidgets&gt;(); } } class UWorld* UDifferentMix::GetWorld() const { return USpikyGameInstance::world; } void UDifferentMix::Init() { wWidgetContainer = CreateWidget&lt;UWidgetsContainer&gt;(GetWorld(), tmpWidgetContainerRef-&gt;GetClass()); wWidgetContainer-&gt;AddToViewport(); wRegistration = CreateWidget&lt;URegWidgets&gt;(GetWorld(), tmpRegistrationRef-&gt;GetClass()); registrationSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wRegistration)); registrationSlot-&gt;SetZOrder(0); registrationSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); registrationSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wRegistration-&gt;SetVisibility(ESlateVisibility::Hidden); wLoginScreen = CreateWidget&lt;ULoginWidgets&gt;(GetWorld(), tmpLoginScreenRef-&gt;GetClass()); loginScreenSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wLoginScreen)); loginScreenSlot-&gt;SetZOrder(0); loginScreenSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); loginScreenSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wLoginScreen-&gt;SetVisibility(ESlateVisibility::Hidden); wServerSettingsButton = CreateWidget&lt;USSButtonWidgets&gt;(GetWorld(), tmpServerSettingsButtonRef-&gt;GetClass()); serverSettingsButtonsSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wServerSettingsButton)); serverSettingsButtonsSlot-&gt;SetZOrder(3); serverSettingsButtonsSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); serverSettingsButtonsSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wServerSettingsButton-&gt;SetVisibility(ESlateVisibility::Hidden); wServerSettings = CreateWidget&lt;USetServerWidgets&gt;(GetWorld(), tmpServerSettingsRef-&gt;GetClass()); serverSettingsSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wServerSettings)); serverSettingsSlot-&gt;SetZOrder(1); serverSettingsSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); serverSettingsSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wServerSettings-&gt;SetVisibility(ESlateVisibility::Hidden); wTermsPrivacy = CreateWidget&lt;UUserWidget&gt;(GetWorld(), tmpTermsPrivacyRef-&gt;GetClass()); TermsPrivacySlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wTermsPrivacy)); TermsPrivacySlot-&gt;SetZOrder(1); TermsPrivacySlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); TermsPrivacySlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wTermsPrivacy-&gt;SetVisibility(ESlateVisibility::Hidden); wWaitingScreen = CreateWidget&lt;UWSWidgets&gt;(GetWorld(), tmpWaitingScreenRef-&gt;GetClass()); waitingScreenSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wWaitingScreen)); waitingScreenSlot-&gt;SetZOrder(1000); // max waitingScreenSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); waitingScreenSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wWaitingScreen-&gt;SetVisibility(ESlateVisibility::Hidden); } void UDifferentMix::HideAllWidgets() { for (size_t i = 0; i &lt; wWidgetContainer-&gt;wCanvas-&gt;GetChildrenCount(); i++) { wWidgetContainer-&gt;wCanvas-&gt;GetChildAt(i)-&gt;SetVisibility(ESlateVisibility::Hidden); } } void UDifferentMix::ShowLoginScreen() { HideAllWidgets(); wLoginScreen-&gt;SetVisibility(ESlateVisibility::Visible); wServerSettingsButton-&gt;SetVisibility(ESlateVisibility::SelfHitTestInvisible); } void UDifferentMix::ShowMouse() { // show mouse APlayerController* MyController = GetWorld()-&gt;GetFirstPlayerController(); MyController-&gt;bShowMouseCursor = true; MyController-&gt;bEnableClickEvents = true; MyController-&gt;bEnableMouseOverEvents = true; }</span></span></code> </pre> <br></div></div><br>  Add their call to SpikyGameMode: <br><br><pre> <code class="cpp hljs">USpikyGameInstance::DifferentMix-&gt;ShowLoginScreen(); USpikyGameInstance::DifferentMix-&gt;ShowMouse();</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Current SpikyGameMode Status</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SpikyGameMode.h" #include "SocketObject.h" #include "Runtime/Engine/Classes/Engine/World.h" #include "Protobufs/UtilityModels.pb.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" void ASpikyGameMode::BeginPlay() { Super::BeginPlay(); GLog-&gt;Log("AClientGameMode::BeginPlay()"); USpikyGameInstance* gameInstance = Cast&lt;USpikyGameInstance&gt;(GetWorld()-&gt;GetGameInstance()); gameInstance-&gt;DifferentMixInit(GetWorld()); EnableInput(GetWorld()-&gt;GetFirstPlayerController()); //InputComponent-&gt;BindAction("Q", IE_Pressed, this, &amp;ASpikyGameMode::TestSendUPDMessage); USpikyGameInstance::DifferentMix-&gt;ShowLoginScreen(); USpikyGameInstance::DifferentMix-&gt;ShowMouse(); } void ASpikyGameMode::EndPlay(const EEndPlayReason::Type EndPlayReason) { Super::EndPlay(EndPlayReason); GLog-&gt;Log("AClientGameMode::EndPlay()"); } void ASpikyGameMode::TestSendUPDMessage() { GLog-&gt;Log("send -&gt;&gt;&gt;"); std::shared_ptr&lt;Utility&gt; utility(new Utility); utility-&gt;set_alive(true); USocketObject::SendByUDP(utility.get()); }</span></span></code> </pre><br></div></div><br>  Compile and check what happened.  When you start the game, the login screen should appear. <br><br><div class="spoiler">  <b class="spoiler_title">Login and Login Screens</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/f17/484/473/f174844731c94e22a76ee8da91733277.PNG"><br><br><img src="https://habrastorage.org/web/c15/3e2/f78/c153e2f780c24a639d8cadaf34349302.PNG"><br></div></div><br>  Add a response to pressing the server address setting button: <br><br><div class="spoiler">  <b class="spoiler_title">SSButtonWidgets</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SSButtonWidgets.h" #include "Runtime/UMG/Public/Components/Button.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "SetServerWidgets.h" void USSButtonWidgets::NativeConstruct() { Super::NativeConstruct(); wSettingsButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("SettingsButton"))); wSettingsButton-&gt;OnClicked.AddDynamic(this, &amp;USSButtonWidgets::SettingsButtonClicked); } void USSButtonWidgets::SettingsButtonClicked() { if (USpikyGameInstance::DifferentMix-&gt;wServerSettings-&gt;GetVisibility() == ESlateVisibility::Hidden) { USpikyGameInstance::DifferentMix-&gt;wServerSettings-&gt;SetVisibility(ESlateVisibility::Visible); } else { USpikyGameInstance::DifferentMix-&gt;wServerSettings-&gt;SetAddress(); USpikyGameInstance::DifferentMix-&gt;wServerSettings-&gt;SetVisibility(ESlateVisibility::Hidden); } }</span></span></code> </pre><br></div></div><br>  Let's start implementing the registration, for this we need the OpenSSL capabilities.  This part is very important, since we will encrypt all the data in the game in the same way.  At the stage of entry, registration, we get encryption keys.  It works like this: we start typing, the form data is checked for the validity of the characters and then immediately sent to the server to check availability, the server looks for such a login in the database, and returns a validity or error code.  When a form is opened, the server sends a captcha, and it saves its value in the map &lt;time, value&gt; all captcha older than 60 seconds are deleted.  Entering captcha is checked with typing.  Checks are performed by a special InputChecking handler.  If all the fields are filled in correctly, then we send the login, meil, captcha to the server in unencrypted form.  On the server, we check the presence of required fields, then all the data again, only after that we generate the public key and send it to the client.  In our project, I use the Diffie-Hellman algorithm for key exchange.  Encryption is performed using the AES-128 algorithm.  The Diffie-Hellman algorithm allows two parties to obtain a shared secret key using an unprotected communication channel.  The principle of operation can be found here: <br><br>  <a href="https://habrahabr.ru/post/151599/">Diffie - Hellman Algorithm</a> <br><br>  But if in a nutshell: <br><br>  Bob chooses two public numbers (p, g) - for example 75, 2 <br>  Alice and Bob choose two secret numbers (a, b) - for example 3, 15 <br><br>  Alice - g ^ a mod p -&gt; 2 ^ 3 mod 75 = 8 (A) <br>  Bob - g ^ b mod p -&gt; 2 ^ 15 mod 75 = 68 (B) <br><br>  A and B are local secret keys. <br><br>  Calculates the secret secret key: <br><br>  Alice - B ^ a mod p, 68 ^ 3 mod 75 = 32 pk <br>  Bob - A ^ b mod p, 8 ^ 15 mod 75 = 32 pk <br><br> AES   -  ,      . <br><br>      -   AES  .     ,     ,       .    : <br><br> <a href="https://wiki.openssl.org/index.php/Diffie_Hellman">wiki.openssl.org/index.php/Diffie_Hellman</a> <br> <a href="https://wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption">wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption</a> <br><br>    Crypto  Utils.        Diffie-Hellman,  AES,   SHA256  /  Base64: <br><br><div class="spoiler"> <b class="spoiler_title">Cryptography</b> <div class="spoiler_text"><div class="spoiler"> <b class="spoiler_title">Crypto.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #pragma warning(disable:4996) #include "Runtime/CoreUObject/Public/UObject/Object.h" #include &lt;openssl/bn.h&gt; #include &lt;string&gt; #include &lt;google/protobuf/message.h&gt; #include "Crypto.generated.h" struct keys { char * p; char * g; char * pubKey; char * privKey; }; UCLASS() class SPIKY_CLIENT_API UCrypto : public UObject { GENERATED_BODY() public: // DiffieHellman static DH *get_dh(int size); // 512 or 1024 static keys Generate_KeysSet_DH(); static DH * client; static std::string Generate_SecretKey_DH(std::string str); // Base64 static size_t CalcDecodeLength(const char* b64input); static size_t Base64Decode(char* b64message, unsigned char** buffer, size_t* length); static std::string Base64Encode(char *decoded_bytes, size_t decoded_length); // Sha256 static std::string SHA256(const void *data, size_t data_len); // AES_ecb_128 static int AES_ECB_Encrypt(unsigned char *source, int source_len, unsigned char *key, unsigned char *cipher); static int AES_ECB_Decrypt(unsigned char *ciphertext, int ciphertext_len, unsigned char *key, unsigned char *plaintext); static std::string Encrypt(std::string source, std::string key); static std::string Decrypt(std::string cipher, std::string key); static std::string EncryptProto(google::protobuf::Message * message, std::string key); private: static void handleErrors(void); };</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">Crypto.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Crypto.h" #define _CRT_SECURE_NO_WARNINGS #pragma warning(disable:4267) // Base64, AES #include &lt;string&gt; #include &lt;assert.h&gt; #include &lt;openssl/bio.h&gt; #include &lt;openssl/evp.h&gt; #include &lt;openssl/buffer.h&gt; #include &lt;openssl/err.h&gt; // Sha256 #include &lt;sstream&gt; #include &lt;iomanip&gt; // DH #include &lt;openssl/crypto.h&gt; #include &lt;openssl/dh.h&gt; #include &lt;memory&gt; #include "Config.h" using namespace std; DH * UCrypto::get_dh(int size) { static unsigned char dh512_p[] = { 0xDA, 0x58, 0x3C, 0x16, 0xD9, 0x85, 0x22, 0x89, 0xD0, 0xE4, 0xAF, 0x75, 0x6F, 0x4C, 0xCA, 0x92, 0xDD, 0x4B, 0xE5, 0x33, 0xB8, 0x04, 0xFB, 0x0F, 0xED, 0x94, 0xEF, 0x9C, 0x8A, 0x44, 0x03, 0xED, 0x57, 0x46, 0x50, 0xD3, 0x69, 0x99, 0xDB, 0x29, 0xD7, 0x76, 0x27, 0x6B, 0xA2, 0xD3, 0xD4, 0x12, 0xE2, 0x18, 0xF4, 0xDD, 0x1E, 0x08, 0x4C, 0xF6, 0xD8, 0x00, 0x3E, 0x7C, 0x47, 0x74, 0xE8, 0x33 }; static unsigned char dh1024_p[] = { 0xF4, 0x88, 0xFD, 0x58, 0x4E, 0x49, 0xDB, 0xCD, 0x20, 0xB4, 0x9D, 0xE4, 0x91, 0x07, 0x36, 0x6B, 0x33, 0x6C, 0x38, 0x0D, 0x45, 0x1D, 0x0F, 0x7C, 0x88, 0xB3, 0x1C, 0x7C, 0x5B, 0x2D, 0x8E, 0xF6, 0xF3, 0xC9, 0x23, 0xC0, 0x43, 0xF0, 0xA5, 0x5B, 0x18, 0x8D, 0x8E, 0xBB, 0x55, 0x8C, 0xB8, 0x5D, 0x38, 0xD3, 0x34, 0xFD, 0x7C, 0x17, 0x57, 0x43, 0xA3, 0x1D, 0x18, 0x6C, 0xDE, 0x33, 0x21, 0x2C, 0xB5, 0x2A, 0xFF, 0x3C, 0xE1, 0xB1, 0x29, 0x40, 0x18, 0x11, 0x8D, 0x7C, 0x84, 0xA7, 0x0A, 0x72, 0xD6, 0x86, 0xC4, 0x03, 0x19, 0xC8, 0x07, 0x29, 0x7A, 0xCA, 0x95, 0x0C, 0xD9, 0x96, 0x9F, 0xAB, 0xD0, 0x0A, 0x50, 0x9B, 0x02, 0x46, 0xD3, 0x08, 0x3D, 0x66, 0xA4, 0x5D, 0x41, 0x9F, 0x9C, 0x7C, 0xBD, 0x89, 0x4B, 0x22, 0x19, 0x26, 0xBA, 0xAB, 0xA2, 0x5E, 0xC3, 0x55, 0xE9, 0x2F, 0x78, 0xC7 }; static unsigned char dh_g[] = { 0x02, }; DH *dh; if (size == 512) { if ((dh = DH_new()) == NULL) return(NULL); dh-&gt;p = BN_bin2bn(dh512_p, sizeof(dh512_p), NULL); dh-&gt;g = BN_bin2bn(dh_g, sizeof(dh_g), NULL); } else { if ((dh = DH_new()) == NULL) return(NULL); dh-&gt;p = BN_bin2bn(dh1024_p, sizeof(dh1024_p), NULL); dh-&gt;g = BN_bin2bn(dh_g, sizeof(dh_g), NULL); } if ((dh-&gt;p == NULL) || (dh-&gt;g == NULL)) { DH_free(dh); return(NULL); } return(dh); } //char * UOpenSSLCrypto::private_key_dh = ""; DH * UCrypto::client = get_dh(512); // DH_new(); // &lt;- use pregenegate P/G or generate manualy (cpu heavy task) keys UCrypto::Generate_KeysSet_DH() { //DH_generate_parameters_ex(client, 512, DH_GENERATOR_2, NULL); // generate P/G manualy // if you generate P/G manualy you also must send P/G to server DH_generate_key(client); keys keys_set; keys_set.p = BN_bn2dec(client-&gt;p); keys_set.g = BN_bn2dec(client-&gt;g); keys_set.pubKey = BN_bn2dec(client-&gt;pub_key); keys_set.privKey = BN_bn2dec(client-&gt;priv_key); return keys_set; } string UCrypto::Generate_SecretKey_DH(string str) { BIGNUM *pub_bob_key = BN_new(); BN_dec2bn(&amp;pub_bob_key, str.c_str()); unsigned char * dh_secret = (unsigned char*)OPENSSL_malloc(sizeof(unsigned char) * (DH_size(client))); DH_compute_key(dh_secret, pub_bob_key, client); return Base64Encode((char*)dh_secret, sizeof(unsigned char) * (DH_size(client))); } size_t UCrypto::CalcDecodeLength(const char* b64input) { //Calculates the length of a decoded string size_t len = strlen(b64input), padding = 0; if (b64input[len - 1] == '=' &amp;&amp; b64input[len - 2] == '=') //last two chars are = padding = 2; else if (b64input[len - 1] == '=') //last char is = padding = 1; return (len * 3) / 4 - padding; } size_t UCrypto::Base64Decode(char* b64message, unsigned char** buffer, size_t* length) { //Decodes a base64 encoded string BIO *bio, *b64; int decodeLen = CalcDecodeLength(b64message); *buffer = (unsigned char*)malloc(decodeLen + 1); (*buffer)[decodeLen] = '\0'; bio = BIO_new_mem_buf(b64message, -1); b64 = BIO_new(BIO_f_base64()); bio = BIO_push(b64, bio); BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL); //Do not use newlines to flush buffer *length = BIO_read(bio, *buffer, strlen(b64message)); assert(*length == decodeLen); //length should equal decodeLen, else something went horribly wrong BIO_free_all(bio); return (0); //success } string UCrypto::Base64Encode(char *decoded_bytes, size_t decoded_length) { int x; BIO *bioMem, *b64; BUF_MEM *bufPtr; b64 = BIO_new(BIO_f_base64()); BIO_set_flags(b64, BIO_FLAGS_BASE64_NO_NL); bioMem = BIO_new(BIO_s_mem()); b64 = BIO_push(b64, bioMem); BIO_write(b64, decoded_bytes, decoded_length); x = BIO_flush(b64); if (x &lt; 1) { BIO_free_all(b64); return NULL; } BIO_get_mem_ptr(b64, &amp;bufPtr); string buff(bufPtr-&gt;data, bufPtr-&gt;length); BIO_free_all(b64); return buff; } /* // USAGE EXAMPLE //Encode To Base64 char* base64EncodeOutput, *text = "Hello World"; char* inbase = OpenSSL_Base64::Base64Encode(text, strlen((char*)text)); cout &lt;&lt; inbase &lt;&lt; endl; //Decode From Base64 unsigned char* base64DecodeOutput; size_t test; OpenSSL_Base64::Base64Decode(inbase, &amp;base64DecodeOutput, &amp;test); cout &lt;&lt; base64DecodeOutput &lt;&lt; endl; */ string UCrypto::SHA256(const void * data, size_t data_len) { EVP_MD_CTX mdctx; unsigned char md_value[EVP_MAX_MD_SIZE]; unsigned int md_len; EVP_DigestInit(&amp;mdctx, EVP_sha256()); EVP_DigestUpdate(&amp;mdctx, data, (size_t)data_len); EVP_DigestFinal_ex(&amp;mdctx, md_value, &amp;md_len); EVP_MD_CTX_cleanup(&amp;mdctx); std::stringstream s; s.fill('0'); for (size_t i = 0; i &lt; md_len; ++i) s &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; (unsigned short)md_value[i]; return s.str(); } int UCrypto::AES_ECB_Encrypt(unsigned char * plaintext, int plaintext_len, unsigned char * key, unsigned char * ciphertext) { EVP_CIPHER_CTX *ctx; int len; int ciphertext_len; /* Create and initialise the context */ ctx = EVP_CIPHER_CTX_new(); if (!ctx) handleErrors(); /* Initialise the encryption operation. IMPORTANT - ensure you use a key size appropriate for your cipher * In this we are using 128 bit AES (ie a 128 bit key). */ if (1 != EVP_EncryptInit_ex(ctx, EVP_aes_128_ecb(), NULL, key, NULL)) handleErrors(); /* Provide the message to be encrypted, and obtain the encrypted output. * EVP_EncryptUpdate can be called multiple times if necessary */ if (1 != EVP_EncryptUpdate(ctx, ciphertext, &amp;len, plaintext, plaintext_len)) handleErrors(); ciphertext_len = len; /* Finalise the encryption. Further ciphertext bytes may be written at this stage. */ if (1 != EVP_EncryptFinal_ex(ctx, ciphertext + len, &amp;len)) handleErrors(); ciphertext_len += len; /* Clean up */ EVP_CIPHER_CTX_free(ctx); return ciphertext_len; } int UCrypto::AES_ECB_Decrypt(unsigned char * ciphertext, int ciphertext_len, unsigned char * key, unsigned char * plaintext) { EVP_CIPHER_CTX *ctx; int len; int plaintext_len; /* Create and initialise the context */ ctx = EVP_CIPHER_CTX_new(); if (!ctx) handleErrors(); if (1 != EVP_DecryptInit_ex(ctx, EVP_aes_128_ecb(), NULL, key, NULL)) handleErrors(); /* Provide the message to be decrypted, and obtain the plaintext output. * EVP_DecryptUpdate can be called multiple times if necessary */ if (1 != EVP_DecryptUpdate(ctx, plaintext, &amp;len, ciphertext, ciphertext_len)) handleErrors(); plaintext_len = len; /* Finalise the decryption. Further plaintext bytes may be written at this stage. */ if (1 != EVP_DecryptFinal_ex(ctx, plaintext + len, &amp;len)) handleErrors(); plaintext_len += len; /* Clean up */ EVP_CIPHER_CTX_free(ctx); return plaintext_len; } std::string UCrypto::Encrypt(string source, string key) { if (Config::bEnableCrypt) { string tmpkey = key.substr(0, 16); unsigned char * key_c = (unsigned char*)strcpy((char*)malloc(tmpkey.length() + 1), tmpkey.c_str()); auto cipher = make_unique&lt;unsigned char[]&gt;(source.length() * 2 + 8); unsigned char * source_c = (unsigned char*)source.c_str(); size_t cipherLen = AES_ECB_Encrypt(source_c, strlen((char*)source_c), key_c, cipher.get()); string cipher_str((char*)cipher.get(), cipherLen); free(key_c); return cipher_str; } else { return source; } } std::string UCrypto::Decrypt(std::string cipher, std::string key) { if (Config::bEnableCrypt) { string tmpkey = key.substr(0, 16); unsigned char * key_c = (unsigned char*)strcpy((char*)malloc(tmpkey.length() + 1), tmpkey.c_str()); auto source = make_unique&lt;unsigned char[]&gt;(cipher.length() * 2); unsigned char * cipher_c = (unsigned char*)cipher.c_str(); size_t decryptLen = AES_ECB_Decrypt(cipher_c, cipher.length(), key_c, source.get()); string decrypt_str((char*)source.get(), decryptLen); free(key_c); return decrypt_str; } else { return cipher; } } std::string UCrypto::EncryptProto(google::protobuf::Message * message, std::string key) { int size = message-&gt;ByteSize(); auto proto_arr = make_unique&lt;unsigned char[]&gt;(size); message-&gt;SerializeToArray(proto_arr.get(), size); if (Config::bEnableCrypt) { string tmpkey = key.substr(0, 16); unsigned char * key_c = (unsigned char*)strcpy((char*)malloc(tmpkey.length() + 1), tmpkey.c_str()); auto cipher = make_unique&lt;unsigned char[]&gt;(size * 2 + 8); unsigned char * source_c = (unsigned char*)proto_arr.get(); size_t cipherLen = AES_ECB_Encrypt(source_c, size, key_c, cipher.get()); string cipher_str((char*)cipher.get(), cipherLen); free(key_c); return cipher_str; } else { string cipher_str((char*)proto_arr.get(), size); return cipher_str; } } void UCrypto::handleErrors(void) { ERR_print_errors_fp(stderr); abort(); }</span></span></code> </pre><br></div></div><br></div></div><br>    Crypto? <br><br> <i>DiffieHellman</i> <br><br> <code>static DH *get_dh(int size);</code> <br> <br>  p  g       512  1024,   p/g,     (cpu heavy task),     . <br><br> <code>static keys Generate_KeysSet_DH();</code> <br> <br>     : p,g, private key, public key. <br><br> <code>static DH * client;</code> <br> <br>  DH. <br><br> <code>static std::string Generate_SecretKey_DH(std::string str);</code> <br> <br>         ,    Base64. <br><br> <i>Base64</i> <br><br> static size_t CalcDecodeLength(const char* b64input); <br><br>    . <br><br> <code>static size_t Base64Decode(char* b64message, unsigned char** buffer, size_t* length); <br> static std::string Base64Encode(char *decoded_bytes, size_t decoded_length);</code> <br> <br> / Base64. <br><br> <i>Sha256</i> <br><br> <code>static std::string SHA256(const void *data, size_t data_len);</code> <br> <br>  . <br><br> <i>AES_ecb_128</i> <br><br> <code>static int AES_ECB_Encrypt(unsigned char *source, int source_len, unsigned char *key, unsigned char *cipher); <br> static int AES_ECB_Decrypt(unsigned char *ciphertext, int ciphertext_len, unsigned char *key, unsigned char *plaintext); <br> static std::string Encrypt(std::string source, std::string key); <br> static std::string Decrypt(std::string cipher, std::string key); <br> static std::string EncryptProto(google::protobuf::Message * message, std::string key);</code> <br> <br>   ,   ,   16 . <br><br> <code>static void handleErrors(void);</code> <br> <br>  . <br><br>      if (Config::bEnableCrypt)        . <br><br>     ,     .      <br> <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/crypto/CryptoSpec.html">Java Cryptography Architecture</a> ,     : Appendix D: Sample Programs Diffie-Hellman Key Exchange between 2 Parties. <br><br>     ,      ,    javax.crypto.*; java.security.*; <br><br>   com.spiky.server.utils     Cryptography: <br><br><div class="spoiler"> <b class="spoiler_title">Cryptography.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.utils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.ServerMain; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.interfaces.DHPrivateKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.interfaces.DHPublicKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.DHParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.DHPublicKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.SecretKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigInteger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.spec.InvalidKeySpecException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Base64; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cryptography</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String secretKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String clientPublicKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String clientPrivateKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> KeyAgreement clientKeyAgree; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSecretKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> secretKey; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSecretKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String secretKey)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.secretKey = secretKey; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientPublicKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clientPublicKey; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DiffieHellman_createKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { DHParameterSpec dhSkipParamSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DHParameterSpec(P, G); <span class="hljs-comment"><span class="hljs-comment">// Alice creates her own DH key pair, using the DH parameters from above KeyPairGenerator aliceKpairGen = KeyPairGenerator.getInstance("DH"); aliceKpairGen.initialize(dhSkipParamSpec); KeyPair aliceKpair = aliceKpairGen.generateKeyPair(); DHPublicKey dhPub = (DHPublicKey)aliceKpair.getPublic(); clientPublicKey = String.valueOf(dhPub.getY()); DHPrivateKey dhPr = (DHPrivateKey)aliceKpair.getPrivate(); clientPrivateKey = String.valueOf(dhPr.getX()); // Alice creates and initializes her DH KeyAgreement object clientKeyAgree = KeyAgreement.getInstance("DH"); clientKeyAgree.init(aliceKpair.getPrivate()); } catch (InvalidAlgorithmParameterException | NoSuchAlgorithmException | InvalidKeyException e) { e.printStackTrace(); } } public String DiffieHellman_createSecretKey(String bobPublicKey) { try { DHPublicKeySpec dhPubKeySpecs = new DHPublicKeySpec(new BigInteger(bobPublicKey), P, G); KeyFactory kf = KeyFactory.getInstance("DH"); DHPublicKey bobPubKey = (DHPublicKey) kf.generatePublic(dhPubKeySpecs); clientKeyAgree.doPhase(bobPubKey, true); byte[] aliceSecret = clientKeyAgree.generateSecret(); byte[] encodedBytes = Base64.getEncoder().encode(aliceSecret); String source_key = new String(encodedBytes); return source_key.substring(0, 16); } catch (NoSuchAlgorithmException | InvalidKeySpecException | InvalidKeyException e) { e.printStackTrace(); } return null; } public byte[] Crypt(byte[] source, String key) { if(ServerMain.bEnableCrypto) { try { Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding"); SecretKeySpec skeySpec = new SecretKeySpec(key.getBytes(), "AES"); cipher.init(Cipher.ENCRYPT_MODE, skeySpec); return cipher.doFinal(source); } catch (InvalidKeyException | NoSuchPaddingException | NoSuchAlgorithmException | IllegalBlockSizeException | BadPaddingException e) { e.printStackTrace(); } } else { return source; } return null; } public byte[] Decrypt(byte[] cryptogram, String key) { //System.out.println("ServerMain.bEnableCrypto: " + ServerMain.bEnableCrypto); if(ServerMain.bEnableCrypto) { try { Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding"); SecretKeySpec skeySpec = new SecretKeySpec(key.getBytes(), "AES"); cipher.init(Cipher.DECRYPT_MODE, skeySpec); return cipher.doFinal(cryptogram); } catch (IllegalBlockSizeException | BadPaddingException | NoSuchPaddingException | NoSuchAlgorithmException | InvalidKeyException e) { e.printStackTrace(); } } else { return cryptogram; } return null; } // The 1024 bit Diffie-Hellman modulus values used by SKIP private static final byte dh1024_p[] = { (byte)0xF4, (byte)0x88, (byte)0xFD, (byte)0x58, (byte)0x4E, (byte)0x49, (byte)0xDB, (byte)0xCD, (byte)0x20, (byte)0xB4, (byte)0x9D, (byte)0xE4, (byte)0x91, (byte)0x07, (byte)0x36, (byte)0x6B, (byte)0x33, (byte)0x6C, (byte)0x38, (byte)0x0D, (byte)0x45, (byte)0x1D, (byte)0x0F, (byte)0x7C, (byte)0x88, (byte)0xB3, (byte)0x1C, (byte)0x7C, (byte)0x5B, (byte)0x2D, (byte)0x8E, (byte)0xF6, (byte)0xF3, (byte)0xC9, (byte)0x23, (byte)0xC0, (byte)0x43, (byte)0xF0, (byte)0xA5, (byte)0x5B, (byte)0x18, (byte)0x8D, (byte)0x8E, (byte)0xBB, (byte)0x55, (byte)0x8C, (byte)0xB8, (byte)0x5D, (byte)0x38, (byte)0xD3, (byte)0x34, (byte)0xFD, (byte)0x7C, (byte)0x17, (byte)0x57, (byte)0x43, (byte)0xA3, (byte)0x1D, (byte)0x18, (byte)0x6C, (byte)0xDE, (byte)0x33, (byte)0x21, (byte)0x2C, (byte)0xB5, (byte)0x2A, (byte)0xFF, (byte)0x3C, (byte)0xE1, (byte)0xB1, (byte)0x29, (byte)0x40, (byte)0x18, (byte)0x11, (byte)0x8D, (byte)0x7C, (byte)0x84, (byte)0xA7, (byte)0x0A, (byte)0x72, (byte)0xD6, (byte)0x86, (byte)0xC4, (byte)0x03, (byte)0x19, (byte)0xC8, (byte)0x07, (byte)0x29, (byte)0x7A, (byte)0xCA, (byte)0x95, (byte)0x0C, (byte)0xD9, (byte)0x96, (byte)0x9F, (byte)0xAB, (byte)0xD0, (byte)0x0A, (byte)0x50, (byte)0x9B, (byte)0x02, (byte)0x46, (byte)0xD3, (byte)0x08, (byte)0x3D, (byte)0x66, (byte)0xA4, (byte)0x5D, (byte)0x41, (byte)0x9F, (byte)0x9C, (byte)0x7C, (byte)0xBD, (byte)0x89, (byte)0x4B, (byte)0x22, (byte)0x19, (byte)0x26, (byte)0xBA, (byte)0xAB, (byte)0xA2, (byte)0x5E, (byte)0xC3, (byte)0x55, (byte)0xE9, (byte)0x2F, (byte)0x78, (byte)0xC7 }; private static final byte dh512_p[] = { (byte)0xDA, (byte)0x58, (byte)0x3C, (byte)0x16, (byte)0xD9, (byte)0x85, (byte)0x22, (byte)0x89, (byte)0xD0, (byte)0xE4, (byte)0xAF, (byte)0x75, (byte)0x6F, (byte)0x4C, (byte)0xCA, (byte)0x92, (byte)0xDD, (byte)0x4B, (byte)0xE5, (byte)0x33, (byte)0xB8, (byte)0x04, (byte)0xFB, (byte)0x0F, (byte)0xED, (byte)0x94, (byte)0xEF, (byte)0x9C, (byte)0x8A, (byte)0x44, (byte)0x03, (byte)0xED, (byte)0x57, (byte)0x46, (byte)0x50, (byte)0xD3, (byte)0x69, (byte)0x99, (byte)0xDB, (byte)0x29, (byte)0xD7, (byte)0x76, (byte)0x27, (byte)0x6B, (byte)0xA2, (byte)0xD3, (byte)0xD4, (byte)0x12, (byte)0xE2, (byte)0x18, (byte)0xF4, (byte)0xDD, (byte)0x1E, (byte)0x08, (byte)0x4C, (byte)0xF6, (byte)0xD8, (byte)0x00, (byte)0x3E, (byte)0x7C, (byte)0x47, (byte)0x74, (byte)0xE8, (byte)0x33 }; private static final BigInteger P = new BigInteger(1, dh512_p); private static final BigInteger G = BigInteger.valueOf(2); }</span></span></code> </pre><br></div></div><br>      ,       enableCrypt = true     ServerMain: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> bEnableCrypto = Boolean.parseBoolean(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"enableCrypt"</span></span>));</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In order to encrypt something, just select the cipher, set the operation mode, select the type of padding (if the source data is less than the block length) and get an array of encrypted bytes: </font></font><br><br><pre> <code class="java hljs">Cipher cipher = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/ECB/PKCS5Padding"</span></span>); SecretKeySpec skeySpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(key.getBytes(), <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); cipher.init(Cipher.ENCRYPT_MODE, skeySpec); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cipher.doFinal(source);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we also use the pre-generated values ‚Äã‚Äãof p, g. </font><font style="vertical-align: inherit;">Encryption on both sides is done! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's go back to the registration. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the start of the login set, I want its length to correspond to at least 3 characters, as well it can contain only English letters, numbers, underscores, and dashes. </font><font style="vertical-align: inherit;">Create a StringCleaner function in DifferentMix that will accept a string and characters allowed in it:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UDifferentMix::StringCleaner(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; source, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; availableSymbols) { source.erase(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::remove_if(source.begin(), source.end(), [&amp;availableSymbols](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ch) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (availableSymbols.find(ch) != <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>::npos) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } ), source.end()); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the NativeConstruct constructor, add links to the widgets and delegate events such as changing the text: </font></font><br><br><pre> <code class="cpp hljs">wLoginTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT(<span class="hljs-string"><span class="hljs-string">"LoginTextBox"</span></span>))); wLoginTextBox-&gt;OnTextChanged.AddDynamic(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;URegWidgets::OnLoginTextChanged);</code> </pre><br>       URegWidgets::URegWidgets,          . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; accept_ref(TEXT(<span class="hljs-string"><span class="hljs-string">"Texture2D'/Game/ProjectResources/Images/accept.accept'"</span></span>)); accept_tex = accept_ref.Object;</code> </pre><br>     : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> URegWidgets::OnLoginTextChanged(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FText &amp; text)   <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>  DifferentMix-&gt;StringCleaner()     (str.length() &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) SetBrushFromTexture(denied_tex) wInfoBlock-&gt;SetText(FText::FromString(<span class="hljs-string"><span class="hljs-string">"Error : Too short login"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; UMessageEncoder::Send(inputChecking)</code> </pre><br>    ‚Äî      .        RegLogModels,     : <br><br><ul><li> InputChecking ‚Äì   //     ,     . </li><li> Login ‚Äì   /    , -  . </li><li> Registration ‚Äì ,    : /// /   . </li><li> InitialState ‚Äì   ,    ,   , id      ,      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a message to URegWidgets :: OnLoginTextChanged and send it over the network: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;InputChecking&gt; inputChecking(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputChecking); inputChecking-&gt;set_mail(TCHAR_TO_UTF8(*text.ToString())); UMessageEncoder::Send(inputChecking.get(), <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other fields work in a similar way. </font><font style="vertical-align: inherit;">After clicking on the SingUp button, we check the validity flags of each of the fields (if a field is filled incorrectly, the flag signals this). </font><font style="vertical-align: inherit;">And if everything is correct, send the login, meil and captcha:</font></font><br><br><pre> <code class="cpp hljs">URegWidgets::SingUpButtonClicked() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bLoginOk &amp;&amp; bPassOk &amp;&amp; bMailOk &amp;&amp; bCaptchaOk) URegWidgets::CloseButtonClicked() USpikyGameInstance::DifferentMix-&gt;ShowLoginScreen();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To display the license, the Terms_Privacy_W widget is used, we will not create a parent for it, there is no logic here. </font><font style="vertical-align: inherit;">Add the ability to display in URegWidgets:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> URegWidgets::ShowTermPrivacyClicked() { USpikyGameInstance::DifferentMix-&gt;wTermsPrivacy-&gt;SetVisibility(ESlateVisibility::Visible); }</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current RegWidgets Status</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "RegWidgets.h" #include "Protobufs/RegLogModels.pb.h" #include "MessageEncoder.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "Runtime/CoreUObject/Public/UObject/ConstructorHelpers.h" #include "Runtime/Engine/Classes/Engine/Texture2D.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/Image.h" #include "Runtime/UMG/Public/Components/EditableTextBox.h" #include "Runtime/UMG/Public/Components/TextBlock.h" URegWidgets::URegWidgets(const FObjectInitializer &amp; ObjectInitializer) : Super(ObjectInitializer) { static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; accept_ref(TEXT("Texture2D'/Game/ProjectResources/Images/accept.accept'")); accept_tex = accept_ref.Object; static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; denied_ref(TEXT("Texture2D'/Game/ProjectResources/Images/denied.denied'")); denied_tex = denied_ref.Object; static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; empty_ref(TEXT("Texture2D'/Game/ProjectResources/Images/empty.empty'")); empty_tex = empty_ref.Object; } void URegWidgets::NativeConstruct() { Super::NativeConstruct(); wReloadCaptchaButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("ReloadCaptchaButton"))); wReloadCaptchaButton-&gt;OnClicked.AddDynamic(this, &amp;URegWidgets::ReloadCaptchaClicked); wCaptchaImage = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("CaptchaImage"))); wLoginTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("LoginTextBox"))); wLoginTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;URegWidgets::OnLoginTextChanged); wPasswordTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("PasswordTextBox"))); wPasswordTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;URegWidgets::OnPasswordTextChanged); wMainTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("MailTextBox"))); wMainTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;URegWidgets::OnMailTextChanged); wCaptchaTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("CaptchaTextBox"))); wCaptchaTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;URegWidgets::OnCaptchaTextChanged); wLoginImage = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("LoginImage"))); wPassImage = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("PasswordImage"))); wMailImage = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("MailImage"))); wCaptchaCheckImage = Cast&lt;UImage&gt;(GetWidgetFromName(TEXT("CaptchaCheckImage"))); wInfoBlock = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("InfoBlock"))); wShowTermsPrivacyButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("TermsPrivacy"))); wShowTermsPrivacyButton-&gt;OnClicked.AddDynamic(this, &amp;URegWidgets::ShowTermPrivacyClicked); wCloseButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("CloseButton"))); wCloseButton-&gt;OnClicked.AddDynamic(this, &amp;URegWidgets::CloseButtonClicked); wSingUpButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("SingUpButton"))); wSingUpButton-&gt;OnClicked.AddDynamic(this, &amp;URegWidgets::SingUpButtonClicked); } void URegWidgets::CloseButtonClicked() { USpikyGameInstance::DifferentMix-&gt;ShowLoginScreen(); } void URegWidgets::ShowTermPrivacyClicked() { USpikyGameInstance::DifferentMix-&gt;wTermsPrivacy-&gt;SetVisibility(ESlateVisibility::Visible); } void URegWidgets::ReloadCaptchaClicked() { std::shared_ptr&lt;InputChecking&gt; inputChecking(new InputChecking); inputChecking-&gt;set_getcaptcha(true); UMessageEncoder::Send(inputChecking.get(), false, true); wCaptchaTextBox-&gt;SetText(FText::FromString("")); bCaptchaOk = false; } void URegWidgets::OnLoginTextChanged(const FText &amp; text) { std::string str(TCHAR_TO_UTF8(*text.ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-"); wLoginTextBox-&gt;SetText(FText::FromString(str.c_str())); if (str.length() &lt; 3) { wLoginImage-&gt;SetBrushFromTexture(denied_tex); wInfoBlock-&gt;SetText(FText::FromString("Error : Too short login")); return; } wInfoBlock-&gt;SetText(FText::FromString(" ")); wLoginImage-&gt;SetBrushFromTexture(empty_tex); std::shared_ptr&lt;InputChecking&gt; inputChecking(new InputChecking); inputChecking-&gt;set_login(TCHAR_TO_UTF8(*text.ToString())); UMessageEncoder::Send(inputChecking.get(), false, true); } void URegWidgets::OnPasswordTextChanged(const FText &amp; text) { std::string str(TCHAR_TO_UTF8(*text.ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"); wPasswordTextBox-&gt;SetText(FText::FromString(str.c_str())); if (str.length() &lt; 4) { bPassOk = false; wPassImage-&gt;SetBrushFromTexture(denied_tex); wInfoBlock-&gt;SetText(FText::FromString("Error : Too short password")); return; } wInfoBlock-&gt;SetText(FText::FromString(" ")); wPassImage-&gt;SetBrushFromTexture(accept_tex); bPassOk = true; } void URegWidgets::OnMailTextChanged(const FText &amp; text) { std::string str(TCHAR_TO_UTF8(*text.ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@._-"); wMainTextBox-&gt;SetText(FText::FromString(str.c_str())); if (str.length() &lt; 4) { bMailOk = false; wMailImage-&gt;SetBrushFromTexture(denied_tex); wInfoBlock-&gt;SetText(FText::FromString("Error : Too short mail")); return; } wInfoBlock-&gt;SetText(FText::FromString(" ")); wMailImage-&gt;SetBrushFromTexture(empty_tex); std::shared_ptr&lt;InputChecking&gt; inputChecking(new InputChecking); inputChecking-&gt;set_mail(TCHAR_TO_UTF8(*text.ToString())); UMessageEncoder::Send(inputChecking.get(), false, true); } void URegWidgets::OnCaptchaTextChanged(const FText &amp; text) { std::string captcha_str(TCHAR_TO_UTF8(*wCaptchaTextBox-&gt;GetText().ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(captcha_str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"); wCaptchaTextBox-&gt;SetText(FText::FromString(captcha_str.c_str())); if (captcha_str.length() &lt; 5) { bCaptchaOk = false; wCaptchaCheckImage-&gt;SetBrushFromTexture(denied_tex); wInfoBlock-&gt;SetText(FText::FromString("Error : Too short captcha")); return; } wInfoBlock-&gt;SetText(FText::FromString(" ")); wCaptchaCheckImage-&gt;SetBrushFromTexture(empty_tex); std::shared_ptr&lt;InputChecking&gt; inputChecking(new InputChecking); inputChecking-&gt;set_captcha(captcha_str); UMessageEncoder::Send(inputChecking.get(), false, true); } void URegWidgets::SingUpButtonClicked() { if (bLoginOk &amp;&amp; bPassOk &amp;&amp; bMailOk &amp;&amp; bCaptchaOk) { USpikyGameInstance::DifferentMix-&gt;RunWaitingScreen(); std::shared_ptr&lt;Registration&gt; registration(new Registration); registration-&gt;set_login(TCHAR_TO_UTF8(*wLoginTextBox-&gt;GetText().ToString())); registration-&gt;set_mail(TCHAR_TO_UTF8(*wMainTextBox-&gt;GetText().ToString())); registration-&gt;set_captcha(TCHAR_TO_UTF8(*wCaptchaTextBox-&gt;GetText().ToString())); UMessageEncoder::Send(registration.get(), false, true); } else { wInfoBlock-&gt;SetText(FText::FromString("Error : Enter valid login/pass/mail/captcha")); } }</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/web/ca1/987/df7/ca1987df72834270bd2aadf8fed1f6a1.PNG"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The process of generating keys, registration may take some time, it would be nice to display a waiting screen during this process. </font><font style="vertical-align: inherit;">To do this, we use WSWidgets, which will receive two widgets with the image of hexes, and rotate them using the FWidgetTransform and a timer that calls GearsAnim () with a certain frequency:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UWSWidgets::GearsAnim() { transform1.Angle += <span class="hljs-number"><span class="hljs-number">1</span></span>; wGear1-&gt;SetRenderTransform(transform1); transform2.Angle -= <span class="hljs-number"><span class="hljs-number">1</span></span>; wGear2-&gt;SetRenderTransform(transform2); }</code> </pre><br>     DifferentMix: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunWaitingScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopWaitingScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UDifferentMix::RunWaitingScreen() { wWaitingScreen-&gt;SetVisibility(ESlateVisibility::Visible); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UDifferentMix::StopWaitingScreen() { wWaitingScreen-&gt;SetVisibility(ESlateVisibility::Hidden); }</code> </pre><br><img src="https://habrastorage.org/web/c9b/a8e/af9/c9ba8eaf9bd944bdb7d622f1127d7e52.PNG"><br><br>   URegWidgets::SingUpButtonClicked   ,    : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> URegWidgets::SingUpButtonClicked() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bLoginOk &amp;&amp; bPassOk &amp;&amp; bMailOk &amp;&amp; bCaptchaOk) USpikyGameInstance::DifferentMix-&gt;RunWaitingScreen();</code> </pre><br>  LoginWidgets   ,      ULoginWidgets::NativeConstruct(),         ,      : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ULoginWidgets::HideErrorMessage() { wInfoBlock-&gt;SetText(FText::FromString(<span class="hljs-string"><span class="hljs-string">" "</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ULoginWidgets::ShowErrorMessage(FString msg) { wInfoBlock-&gt;SetText(FText::FromString(*msg)); GetWorld()-&gt;GetTimerManager().ClearTimer(MessageTimerHandle); GetWorld()-&gt;GetTimerManager().SetTimer(MessageTimerHandle, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;ULoginWidgets::HideErrorMessage, <span class="hljs-number"><span class="hljs-number">1.2f</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); }</code> </pre><br>  ULoginWidgets::SingUpButtonClicked()     ,   ,   ,      : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (USocketObject::bIsConnection) { USpikyGameInstance::DifferentMix-&gt;ShowRegistrationScreen(); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;ReloadCaptchaClicked(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ShowErrorMessage(<span class="hljs-string"><span class="hljs-string">"No connection"</span></span>); }</code> </pre><br>  UDifferentMix::ShowRegistrationScreen(): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UDifferentMix::ShowRegistrationScreen() { HideAllWidgets(); wRegistration-&gt;SetVisibility(ESlateVisibility::Visible); }</code> </pre><br>   : <br><br><pre> <code class="cpp hljs">ULoginWidgets::LoginButtonClicked() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bMailOk &amp;&amp; bPassOk &amp;&amp; USocketObject::bIsConnection) RunWaitingScreen(); <span class="hljs-comment"><span class="hljs-comment">//    keys_set = UCrypto::Generate_KeysSet_DH(); //    std::shared_ptr&lt;Login&gt; login_proto(new Login); //    login_proto-&gt;set_publickey(keys_set.pubKey); UMessageEncoder::Send(login_proto.get(), false, true);</span></span></code> </pre><br><br>      ,   LoginWidgets: <br><br><div class="spoiler"> <b class="spoiler_title">LoginWidgets</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include &lt;string&gt; #include "LoginWidgets.generated.h" class UButton; class UTextBlock; class UEditableTextBox; UCLASS() class SPIKY_CLIENT_API ULoginWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; bool bMailOk = false; bool bPassOk = false; public: UButton* wSingUpButton = nullptr; UTextBlock* wInfoBlock = nullptr; UEditableTextBox* wMailTextBox = nullptr; UEditableTextBox* wPasswordTextBox = nullptr; UButton* wLoginButton = nullptr; UButton* wSettingsButton = nullptr; UFUNCTION() void SettingsButtonClicked(); UFUNCTION() void SingUpButtonClicked(); UFUNCTION() void LoginButtonClicked(); UFUNCTION() void OnMailTextChanged(const FText &amp; text); UFUNCTION() void OnPasswordTextChanged(const FText &amp; text); FTimerHandle MessageTimerHandle; void HideErrorMessage(); void ShowErrorMessage(FString msg); static std::string mail; static std::string password; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "LoginWidgets.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "Runtime/UMG/Public/Components/EditableTextBox.h" #include "Runtime/Engine/Public/TimerManager.h" #include "SocketObject.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "RegWidgets.h" #include "Crypto.h" #include "Protobufs/RegLogModels.pb.h" #include "SetServerWidgets.h" #include "MessageEncoder.h" std::string ULoginWidgets::mail = ""; std::string ULoginWidgets::password = ""; void ULoginWidgets::NativeConstruct() { Super::NativeConstruct(); wSingUpButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("SingUpButton"))); wSingUpButton-&gt;OnClicked.AddDynamic(this, &amp;ULoginWidgets::SingUpButtonClicked); wLoginButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("LoginButton"))); wLoginButton-&gt;OnClicked.AddDynamic(this, &amp;ULoginWidgets::LoginButtonClicked); wInfoBlock = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("InfoBlock"))); wMailTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("MailBox"))); wMailTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;ULoginWidgets::OnMailTextChanged); wPasswordTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("PasswordBox"))); wPasswordTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;ULoginWidgets::OnPasswordTextChanged); } void ULoginWidgets::LoginButtonClicked() { if (bMailOk &amp;&amp; bPassOk &amp;&amp; USocketObject::bIsConnection) { GLog-&gt;Log("ULoginWidgets::LoginButtonClicked()"); USpikyGameInstance::DifferentMix-&gt;RunWaitingScreen(); keys keys_set = UCrypto::Generate_KeysSet_DH(); std::shared_ptr&lt;Login&gt; login_proto(new Login); login_proto-&gt;set_publickey(keys_set.pubKey); UMessageEncoder::Send(login_proto.get(), false, true); } else { if (!USocketObject::bIsConnection) { ShowErrorMessage("No connection"); } else if (!bMailOk &amp;&amp; !bPassOk) { ShowErrorMessage("Incorrect mail and password"); } else if (!bMailOk) { ShowErrorMessage("Incorrect mail"); } else if (!bPassOk) { ShowErrorMessage("Incorrect password"); } } } void ULoginWidgets::SettingsButtonClicked() { USpikyGameInstance::DifferentMix-&gt;wServerSettings-&gt;SetVisibility(ESlateVisibility::Visible); } void ULoginWidgets::SingUpButtonClicked() { if (USocketObject::bIsConnection) { USpikyGameInstance::DifferentMix-&gt;ShowRegistrationScreen(); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;ReloadCaptchaClicked(); } else { ShowErrorMessage("No connection"); } } void ULoginWidgets::HideErrorMessage() { wInfoBlock-&gt;SetText(FText::FromString(" ")); } void ULoginWidgets::ShowErrorMessage(FString msg) { wInfoBlock-&gt;SetText(FText::FromString(*msg)); GetWorld()-&gt;GetTimerManager().ClearTimer(MessageTimerHandle); GetWorld()-&gt;GetTimerManager().SetTimer(MessageTimerHandle, this, &amp;ULoginWidgets::HideErrorMessage, 1.2f, false); } void ULoginWidgets::OnMailTextChanged(const FText &amp; text) { std::string str(TCHAR_TO_UTF8(*text.ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@._-"); wMailTextBox-&gt;SetText(FText::FromString(str.c_str())); if (str.length() &lt; 4) { bMailOk = false; ShowErrorMessage("Too short mail"); return; } HideErrorMessage(); bMailOk = true; mail = str; } void ULoginWidgets::OnPasswordTextChanged(const FText &amp; text) { std::string str(TCHAR_TO_UTF8(*text.ToString())); USpikyGameInstance::DifferentMix-&gt;StringCleaner(str, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"); wPasswordTextBox-&gt;SetText(FText::FromString(str.c_str())); if (str.length() &lt; 4) { bPassOk = false; ShowErrorMessage("Too short password"); return; } HideErrorMessage(); bPassOk = true; password = str; }</span></span></code> </pre><br></div></div><br>    .   <a href="https://github.com/pusuo/patchca"> Patchca</a>    .    ,    .   ,      CryptogramWrapper,    Wrapper,   : <br><br><pre> <code class="hljs pgsql">message CryptogramWrapper { bytes registration = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message <span class="hljs-keyword"><span class="hljs-keyword">Wrapper</span></span> { Registration registration = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre><br>    DecryptHandler,   ,        , -    ,      ,      (   ): <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper, List&lt;Object&gt; list)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ init(ctx); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasCryptogramWrapper()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(registration_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRegistration().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Registration registration = RegistrationLoginModels.Registration.parseFrom(original); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper.getCryptogramWrapper().hasField(login_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getLogin().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Login login = RegistrationLoginModels.Login.parseFrom(original); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(mainMenu_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getMainMenu().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); MainMenuModels.MainMenu mainMenu = MainMenuModels.MainMenu.parseFrom(original); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(room_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRoom().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); GameRoomModels.Room room = GameRoomModels.Room.parseFrom(original); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(gameModels_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getGameModels().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); GameModels.GameData gameData = GameModels.GameData.parseFrom(original); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasInputChecking()) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasRegistration()) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasLogin()) { } }</code> </pre><br>         .      findFieldByName: <br><br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.google.protobuf.Descriptors.FieldDescriptor registration_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName(<span class="hljs-string"><span class="hljs-string">"registration"</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(registration_cw)) { }</code> </pre><br>      Utils   Descriptors.     ,    ,   Logics      InputChecking. <br><br>        MySQL     Hibernate.    Maven: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>mysql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>mysql-connector-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.1.38<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.hibernate<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>hibernate-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>[4.2.6,4.2.9]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>   Utils  SessionUtil,          : <br><br><pre> <code class="java hljs">Query query = session.createQuery(<span class="hljs-string"><span class="hljs-string">"SELECT login FROM UserModel WHERE login = :str "</span></span>);</code> </pre><br><div class="spoiler"> <b class="spoiler_title">SessionUtil</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.utils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.SessionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.cfg.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.service.ServiceRegistry; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.service.ServiceRegistryBuilder; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionUtil</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SessionFactory factory; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SessionUtil</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Configuration configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(); configuration.configure(); ServiceRegistryBuilder srBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceRegistryBuilder(); srBuilder.applySettings(configuration.getProperties()); ServiceRegistry serviceRegistry = srBuilder.buildServiceRegistry(); factory = configuration.buildSessionFactory(serviceRegistry); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Session </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getInstance().factory.openSession(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SessionUtil </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionUtil(); } }</code> </pre><br></div></div><br>   ,        ,   dbmodels     UserModel: <br><br><div class="spoiler"> <b class="spoiler_title">UserModel</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.dbmodels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.*; <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> String login; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> String hash; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> String mail; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> login; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String login)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.login = login; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hash; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setHashPass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String hash)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hash = hash; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mail; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mail = mail; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"login: \""</span></span> + login + <span class="hljs-string"><span class="hljs-string">"\"\nmail: \""</span></span> + mail + <span class="hljs-string"><span class="hljs-string">"\"\nhash: \""</span></span> + hash + <span class="hljs-string"><span class="hljs-string">"\""</span></span>; } }</code> </pre><br></div></div><br>     hibernate.cfg.xml  resources: <br><br><div class="spoiler"> <b class="spoiler_title">hibernate.cfg.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE hibernate-configuration PUBLIC "-//Hibernate/Hibernate Configuration DTD 3.0//EN" "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hibernate-configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">session-factory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Database connection settings --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.connection.driver_class"</span></span></span><span class="hljs-tag">&gt;</span></span>com.mysql.jdbc.Driver<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.connection.username"</span></span></span><span class="hljs-tag">&gt;</span></span>root<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.connection.password"</span></span></span><span class="hljs-tag">&gt;</span></span>root<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.connection.url"</span></span></span><span class="hljs-tag">&gt;</span></span>jdbc:mysql://localhost:3306/game_db<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- SQL dialect --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.dialect"</span></span></span><span class="hljs-tag">&gt;</span></span>org.hibernate.dialect.MySQL5InnoDBDialect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- set up connection pool c3p0 for use --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c3p0.max_size"</span></span></span><span class="hljs-tag">&gt;</span></span>10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Echo all executed SQL to stdout --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"show_sql"</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- update the database schema on startup --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.hbm2ddl.auto"</span></span></span><span class="hljs-tag">&gt;</span></span>update<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mapping</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.spiky.server.dbmodels.UserModel"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mapping</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">session-factory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hibernate-configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>      MySQL Workbench       . <br><br>   InputChecking,        .     ,         ,     ,    Netty  AttributeKey. <br><br> <a href="https://netty.io/4.0/api/io/netty/util/AttributeKey.html">netty.io/4.0/api/io/netty/util/AttributeKey.html</a> <br> <a href="https://stackoverflow.com/questions/29596677/replacement-for-attributekey">stackoverflow.com/questions/29596677/replacement-for-attributekey</a> <br> <a href="https://stackoverflow.com/questions/25932352/using-channel-attributes-in-different-context-handlers">stackoverflow.com/questions/25932352/using-channel-attributes-in-different-context-handlers</a> <br><br>  ServerMain : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;String&gt; SECRETKEY = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"secret_key"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;String&gt; CHANNEL_OWNER = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"channel_owner"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;Session&gt; HIBER_SESSION = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"hiber_session"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;Transaction&gt; HIBER_TRANSACTION = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"hiber_transaction"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;Cryptography&gt; CRYPTOGRAPHY = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"hiber_cryptography"</span></span>);</code> </pre><br>  DecryptHandler  ,  Init()   ,    : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Session session = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionUtil().getSession(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Transaction transaction = session.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Cryptography cryptography = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cryptography(); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> bInit = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!bInit) { bInit = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; ctx.channel().attr(HIBER_SESSION).set(session); ctx.channel().attr(HIBER_TRANSACTION).set(transaction); ctx.channel().attr(CRYPTOGRAPHY).set(cryptography); } }</code> </pre><br>  -  ,   ServerMain     : <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Map&lt;Long,String&gt; captchaBank = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;());</code> </pre><br>        ,  : <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*     60  */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">captchaCleaner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lifetime = <span class="hljs-number"><span class="hljs-number">60000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">10000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      10  synchronized (captchaBank) { captchaBank.entrySet().removeIf(e-&gt; System.currentTimeMillis() - e.getKey() &gt; lifetime); } } catch (InterruptedException e) { e.printStackTrace(); } } }).start(); } /*   captchaCleaner() */ public static void main(String[] args) { new Thread(ServerMain::run_tcp).start(); //new Thread(ServerMain::run_udp).start(); captchaCleaner(); }</span></span></code> </pre><br>       Registration        ,      .  getCaptcha().    patchca  , ,        : <br><br><pre> <code class="java hljs">RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setCaptchaData(ByteString.copyFrom(captchaBytes)) .build();</code> </pre><br><div class="spoiler"> <b class="spoiler_title">Registration</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.RegistrationLoginModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.background.SingleColorBackgroundFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.color.SingleColorFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.filter.predefined.CurvesRippleFilterFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.service.ConfigurableCaptchaService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.utils.encoder.EncoderHelper; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.ByteArrayOutputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.captchaBank; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Registration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MessageModels.<span class="hljs-function"><span class="hljs-function">Wrapper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCaptcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ConfigurableCaptchaService cs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurableCaptchaService(); cs.setBackgroundFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SingleColorBackgroundFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Color(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>))); cs.setColorFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SingleColorFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Color(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>))); cs.setFilterFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurvesRippleFilterFactory(cs.getColorFactory())); cs.setHeight(<span class="hljs-number"><span class="hljs-number">100</span></span>); cs.setWidth(<span class="hljs-number"><span class="hljs-number">250</span></span>); ByteArrayOutputStream bos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); captchaBank.put(System.currentTimeMillis(), EncoderHelper.getChallangeAndWriteImage(cs, <span class="hljs-string"><span class="hljs-string">"png"</span></span>, bos)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] captchaBytes = bos.toByteArray(); bos.close(); RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setCaptchaData(ByteString.copyFrom(captchaBytes)) .build(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br></div></div><br>    InputChecking,   ,   ,     check()   : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(type.equals(<span class="hljs-string"><span class="hljs-string">"login"</span></span>)) Query query = session.createQuery(<span class="hljs-string"><span class="hljs-string">"SELECT login FROM UserModel WHERE login = :str "</span></span>); List users = query.setParameter(<span class="hljs-string"><span class="hljs-string">"str"</span></span>, data).list();</code> </pre><br>         ,         : <br><br><pre> <code class="java hljs">RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setLoginCheckStatus(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-comment"><span class="hljs-comment">// no valid .build();</span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title">InputChecking</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.RegistrationLoginModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Query; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.HIBER_SESSION; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.captchaBank; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputChecking</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InputChecking</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper)</span></span></span><span class="hljs-function"> </span></span>{ Session session = ctx.channel().attr(HIBER_SESSION).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getInputChecking().hasField(getCaptcha_ich)) { ctx.writeAndFlush(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration().getCaptcha()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getInputChecking().hasField(login_ich)) { ctx.writeAndFlush(check(session, wrapper.getInputChecking().getLogin(), <span class="hljs-string"><span class="hljs-string">"login"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getInputChecking().hasField(mail_ich)) { ctx.writeAndFlush(check(session, wrapper.getInputChecking().getMail(), <span class="hljs-string"><span class="hljs-string">"mail"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getInputChecking().hasField(captcha_ich)) { ctx.writeAndFlush(check(session, wrapper.getInputChecking().getCaptcha(), <span class="hljs-string"><span class="hljs-string">"captcha"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MessageModels.<span class="hljs-function"><span class="hljs-function">Wrapper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Session session, String data, String type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(type.equals(<span class="hljs-string"><span class="hljs-string">"login"</span></span>)) { Query query = session.createQuery(<span class="hljs-string"><span class="hljs-string">"SELECT login FROM UserModel WHERE login = :str "</span></span>); List users = query.setParameter(<span class="hljs-string"><span class="hljs-string">"str"</span></span>, data).list(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!users.isEmpty()) { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setLoginCheckStatus(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-comment"><span class="hljs-comment">// no valid .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } else { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setLoginCheckStatus(true) // valid .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } } else if (type.equals("mail")) { Query query = session.createQuery("SELECT mail FROM UserModel WHERE mail = :str "); List mails = query.setParameter("str", data).list(); if(!mails.isEmpty()) { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setMailCheckStatus(false) .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } else { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setMailCheckStatus(true) .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } } else if (type.equals("captcha")) { boolean challengeFind = false; synchronized (captchaBank) { for (Map.Entry&lt;Long, String&gt; entry : captchaBank.entrySet()) if (entry.getValue().equals(data)) challengeFind = true; if (challengeFind) { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setCaptchaCheckStatus(true) .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } else { RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setCaptchaCheckStatus(false) .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } } } return null; } }</span></span></code> </pre><br></div></div><br>   ,          .    DifferentMix: <br><br><div class="spoiler"> <b class="spoiler_title">UTexture2D* CreateTexture(const std::string raw, bool alpha);</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// .h class UTexture2D; UTexture2D* CreateTexture(const std::string raw, bool alpha); ... // .cpp #include "Runtime/ImageWrapper/Public/Interfaces/IImageWrapperModule.h" #include "Runtime/Core/Public/Modules/ModuleManager.h" #include "Runtime/Engine/Classes/Engine/Texture2D.h" UTexture2D* UDifferentMix::CreateTexture(const std::string raw, bool alpha) { int32 num = raw.length(); const uint8_t * byte_array = reinterpret_cast&lt;const uint8_t*&gt;(raw.c_str()); if (num != 0) { IImageWrapperModule&amp; ImageWrapperModule = FModuleManager::LoadModuleChecked&lt;IImageWrapperModule&gt;(FName(TEXT("ImageWrapper"))); // Note: PNG format. Other formats are supported IImageWrapperPtr ImageWrapper = ImageWrapperModule.CreateImageWrapper(EImageFormat::PNG); if (ImageWrapper.IsValid() &amp;&amp; ImageWrapper-&gt;SetCompressed(byte_array, num)) { const TArray&lt;uint8&gt;* UncompressedBGRA = nullptr; TArray&lt;uint8&gt; UncompressedRGBA; if (ImageWrapper-&gt;GetRaw(ERGBFormat::BGRA, 8, UncompressedBGRA)) { // Create the UTexture for rendering UncompressedRGBA.AddZeroed(UncompressedBGRA-&gt;Num()); for (int i = 0; UncompressedBGRA-&gt;Num() &gt; i; i += 4) { UncompressedRGBA[i] = (*UncompressedBGRA)[i + 2]; UncompressedRGBA[i + 1] = (*UncompressedBGRA)[i + 1]; UncompressedRGBA[i + 2] = (*UncompressedBGRA)[i]; UncompressedRGBA[i + 3] = (*UncompressedBGRA)[i + 3]; if (alpha) { if ((UncompressedRGBA[i] + UncompressedRGBA[i + 1] + UncompressedRGBA[i + 2]) &lt; 3) { UncompressedRGBA[i + 3] = 0; } } } UTexture2D* MyTexture = UTexture2D::CreateTransient(ImageWrapper-&gt;GetWidth(), ImageWrapper-&gt;GetHeight(), PF_R8G8B8A8); // Fill in the source data from the file uint8* TextureData = (uint8*)MyTexture-&gt;PlatformData-&gt;Mips[0].BulkData.Lock(LOCK_READ_WRITE); FMemory::Memcpy(TextureData, UncompressedRGBA.GetData(), UncompressedRGBA.Num()); MyTexture-&gt;PlatformData-&gt;Mips[0].BulkData.Unlock(); // Update the rendering resource from data. MyTexture-&gt;UpdateResource(); return MyTexture; } } } return nullptr; }</span></span></code> </pre><br></div></div><br>         .Build.cs ‚Äì ImageWrapper.   InputChecking  Handlers/Logics: <br><br><div class="spoiler"> <b class="spoiler_title">InputChecking</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include "InputChecking.generated.h" class InputChecking; UCLASS() class SPIKY_CLIENT_API UInputChecking : public UObject { GENERATED_BODY() public: void Handler(const InputChecking inputChecking); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "InputChecking.h" #include "Descriptors.h" #include "Runtime/Engine/Classes/Engine/Texture2D.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "RegWidgets.h" #include "Runtime/UMG/Public/Components/Image.h" #include "Protobufs/RegLogModels.pb.h" void UInputChecking::Handler(const InputChecking inputChecking) { if (inputChecking.GetReflection()-&gt;HasField(inputChecking, Descriptors::captchaDataField_ich)) { UTexture2D * tex = USpikyGameInstance::DifferentMix-&gt;CreateTexture(inputChecking.captchadata(), true); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wCaptchaImage-&gt;SetBrushFromTexture(tex); } else if (inputChecking.GetReflection()-&gt;HasField(inputChecking, Descriptors::loginCheckStatus_ich)) { if (inputChecking.logincheckstatus()) { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wLoginImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;accept_tex); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;bLoginOk = true; } else { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wLoginImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;denied_tex); } } else if (inputChecking.GetReflection()-&gt;HasField(inputChecking, Descriptors::mailCheckStatus_ich)) { if (inputChecking.mailcheckstatus()) { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wMailImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;accept_tex); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;bMailOk = true; } else { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wMailImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;denied_tex); } } else if (inputChecking.GetReflection()-&gt;HasField(inputChecking, Descriptors::captchaCheckStatus_ich)) { if (inputChecking.captchacheckstatus()) { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wCaptchaCheckImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;accept_tex); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;bCaptchaOk = true; } else { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;bCaptchaOk = false; USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wCaptchaCheckImage-&gt;SetBrushFromTexture(USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;denied_tex); } } }</span></span></code> </pre><br></div></div><br>                   : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputChecking.GetReflection()-&gt;HasField(inputChecking, Descriptors::captchaDataField_ich)) { <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br>    DecryptHandler   InputChecking: <br><br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasInputChecking()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputChecking(ctx, wrapper); } ...</code> </pre><br>  EncryptHandler   : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EncryptHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageToMessageEncoder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageModels</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wrapper</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper, List&lt;Object&gt; list)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   ,   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!wrapper.hasCryptogramWrapper()) { ctx.writeAndFlush(wrapper); } <span class="hljs-comment"><span class="hljs-comment">//   else if(cryptogramWrapper.hasField(registration_cw)) { byte[] cryptogram = cryptography.Crypt(cryptogramWrapper.getRegistration().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setRegistration(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } } }</span></span></code> </pre><br>        EncryptHandler,     : <br><br><div class="spoiler"> <b class="spoiler_title">EncryptHandler</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.handlers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.handler.codec.MessageToMessageEncoder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.CRYPTOGRAPHY; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EncryptHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageToMessageEncoder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageModels</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wrapper</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper, List&lt;Object&gt; list)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Cryptography cryptography = ctx.channel().attr(CRYPTOGRAPHY).get(); MessageModels.CryptogramWrapper cryptogramWrapper = wrapper.getCryptogramWrapper(); String secretKey = cryptography.getSecretKey(); <span class="hljs-comment"><span class="hljs-comment">/*   ,   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!wrapper.hasCryptogramWrapper()) { ctx.writeAndFlush(wrapper); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cryptogramWrapper.hasField(registration_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getRegistration().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setRegistration(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cryptogramWrapper.hasField(login_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getLogin().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setLogin(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cryptogramWrapper.hasField(initialState_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getInitialState().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setInitialState(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cryptogramWrapper.hasField(mainMenu_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getMainMenu().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setMainMenu(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cryptogramWrapper.hasField(room_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getRoom().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setRoom(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cryptogramWrapper.hasField(gameModels_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = cryptography.Crypt(cryptogramWrapper.getGameModels().toByteArray(), secretKey); cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder().clear() .setGameModels(ByteString.copyFrom(cryptogram)).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } } }</code> </pre><br></div></div><br>    ServerInitializer  : <br><br><pre> <code class="java hljs">pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EncryptHandler());</code> </pre><br>       MessageEncoder    : <br><br><div class="spoiler"> <b class="spoiler_title">MessageEncoder</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MessageEncoder.h" #include "SocketObject.h" #include "Protobufs/MessageModels.pb.h" #include &lt;google/protobuf/io/zero_copy_stream_impl_lite.h&gt; #include &lt;google/protobuf/io/coded_stream.h&gt; #include "Crypto.h" #include "SpikyGameInstance.h" #include "Protobufs/MainMenuModels.pb.h" #include "Protobufs/GameRoomModels.pb.h" #include "Protobufs/GameModels.pb.h " bool UMessageEncoder::Send(google::protobuf::Message * message, bool bCrypt, bool bTCP) { Wrapper wrapper; std::shared_ptr&lt;CryptogramWrapper&gt; cw(new CryptogramWrapper); //     if (bCrypt) { if (message-&gt;GetTypeName() == "Registration") { Registration * mes = static_cast&lt;Registration*&gt;(message); std::string cipher = UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey); cw-&gt;set_registration(cipher); wrapper.set_allocated_cryptogramwrapper(cw.get()); } else if (message-&gt;GetTypeName() == "Login") { Login * mes = static_cast&lt;Login*&gt;(message); std::string cipher = UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey); cw-&gt;set_login(cipher); wrapper.set_allocated_cryptogramwrapper(cw.get()); } else if (message-&gt;GetTypeName() == "MainMenu") { MainMenu * mes = static_cast&lt;MainMenu*&gt;(message); std::string cipher = UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey); cw-&gt;set_mainmenu(cipher); wrapper.set_allocated_cryptogramwrapper(cw.get()); } else if (message-&gt;GetTypeName() == "Room") { Room * mes = static_cast&lt;Room*&gt;(message); std::string cipher = UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey); cw-&gt;set_room(cipher); wrapper.set_allocated_cryptogramwrapper(cw.get()); } else if (message-&gt;GetTypeName() == "GameData") { GameData * mes = static_cast&lt;GameData*&gt;(message); std::string cipher = UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey); cw-&gt;set_gamemodels(cipher); wrapper.set_allocated_cryptogramwrapper(cw.get()); } } else { if (message-&gt;GetTypeName() == "Utility") { Utility * mes = static_cast&lt;Utility*&gt;(message); wrapper.set_allocated_utility(mes); } else if (message-&gt;GetTypeName() == "InputChecking") { InputChecking * mes = static_cast&lt;InputChecking*&gt;(message); wrapper.set_allocated_inputchecking(mes); } else if (message-&gt;GetTypeName() == "Registration") { Registration * mes = static_cast&lt;Registration*&gt;(message); wrapper.set_allocated_registration(mes); } else if (message-&gt;GetTypeName() == "Login") { Login * mes = static_cast&lt;Login*&gt;(message); wrapper.set_allocated_login(mes); } } size_t size = wrapper.ByteSize() + 5; // include size, varint32 never takes more than 5 bytes uint8_t * buffer = new uint8_t[size]; google::protobuf::io::ArrayOutputStream arr(buffer, size); google::protobuf::io::CodedOutputStream output(&amp;arr); //       buffer output.WriteVarint32(wrapper.ByteSize()); wrapper.SerializeToCodedStream(&amp;output); //     utility if (wrapper.has_utility()) { wrapper.release_utility(); } else if (wrapper.has_inputchecking()) { wrapper.release_inputchecking(); } else if (wrapper.has_registration()) { wrapper.release_registration(); } else if (wrapper.has_login()) { wrapper.release_login(); } else if (wrapper.has_cryptogramwrapper()) { wrapper.release_cryptogramwrapper(); } int32 bytesSent = 0; bool sentState = false; if (bTCP) { //send by tcp sentState = USocketObject::tcp_socket-&gt;Send(buffer, output.ByteCount(), bytesSent); } else { //send by udp sentState = USocketObject::udp_socket-&gt;SendTo(buffer, output.ByteCount(), bytesSent, *USocketObject::udp_address); } delete[] buffer; return sentState; }</span></span></code> </pre><br></div></div><br>  MessageDecoder        : <br><br><div class="spoiler"> <b class="spoiler_title">MessageDecoder</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MessageDecoder.h" #include "Protobufs/MessageModels.pb.h" #include "Crypto.h" #include "Descriptors.h" #include "SpikyGameInstance.h" #include "Protobufs/MainMenuModels.pb.h" #include "Protobufs/GameRoomModels.pb.h" void UMessageDecoder::SendProtoToDecoder(Wrapper * wrapper) { if (wrapper-&gt;has_inputchecking()) { } else if (wrapper-&gt;has_registration()) { } else if (wrapper-&gt;has_login()) { } else if (wrapper-&gt;has_cryptogramwrapper()) { if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::registration_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().registration(), USpikyGameInstance::secretKey); Registration registration; registration.ParseFromArray(source.c_str(), source.length()); } else if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::login_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().login(), USpikyGameInstance::secretKey); Login login; login.ParseFromArray(source.c_str(), source.length()); } else if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::initialState_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().initialstate(), USpikyGameInstance::secretKey); InitialState is; is.ParseFromArray(source.c_str(), source.length()); } else if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::mainMenu_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().mainmenu(), USpikyGameInstance::secretKey); MainMenu mainMenu; mainMenu.ParseFromArray(source.c_str(), source.length()); } else if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::room_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().room(), USpikyGameInstance::secretKey); Room room; room.ParseFromArray(source.c_str(), source.length()); } else if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::gameModels_cw)) { std::string source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().gamemodels(), USpikyGameInstance::secretKey); GameData gameData; gameData.ParseFromArray(source.c_str(), source.length()); } } }</span></span></code> </pre><br></div></div><br>       InputChecking: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;has_inputchecking()) { UInputChecking * inputChecking = NewObject&lt;UInputChecking&gt;(UInputChecking::StaticClass()); inputChecking-&gt;Handler(wrapper-&gt;inputchecking()); }</code> </pre><br>   ,  .   , Vadim  VaDiM   ,      ,     . <br><br><img src="https://habrastorage.org/web/d31/24e/2f4/d3124e2f43474fc7906452a76f2fd56d.PNG"><br><br>     ,    Logics     Registration  Login: <br><br><div class="spoiler"> <b class="spoiler_title">Registration</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include "Registration.generated.h" class Registration; UCLASS() class SPIKY_CLIENT_API URegistration : public UObject { GENERATED_BODY() public: void Handler(Registration registration); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Registration.h" #include "Protobufs/RegLogModels.pb.h" #include "Descriptors.h" #include "Crypto.h" #include "MessageEncoder.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "RegWidgets.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "Runtime/UMG/Public/Components/EditableTextBox.h" void URegistration::Handler(Registration registration) { if (registration.GetReflection()-&gt;HasField(registration, Descriptors::publicKey_reg)) { // create public, private key keys keys_set = UCrypto::Generate_KeysSet_DH(); std::shared_ptr&lt;Registration&gt; reg(new Registration); reg-&gt;set_publickey(keys_set.pubKey); UMessageEncoder::Send(reg.get(), false, true); // send public key to server USpikyGameInstance::secretKey = UCrypto::Generate_SecretKey_DH(registration.publickey()); } else if (registration.GetReflection()-&gt;HasField(registration, Descriptors::stateCode_reg)) { if (registration.statecode() == 0) // error while registration { USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wInfoBlock-&gt;SetText(FText::FromString("Unknown error try to enter everything again")); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wLoginTextBox-&gt;SetText(FText::FromString("")); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wPasswordTextBox-&gt;SetText(FText::FromString("")); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wMainTextBox-&gt;SetText(FText::FromString("")); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wCaptchaTextBox-&gt;SetText(FText::FromString("")); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;ReloadCaptchaClicked(); USpikyGameInstance::DifferentMix-&gt;StopWaitingScreen(); } else if (registration.statecode() == 1) // successful secret key generation { GLog-&gt;Log("Successful secret key generation"); std::shared_ptr&lt;Registration&gt; reg(new Registration); reg-&gt;set_login(TCHAR_TO_UTF8(*USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wLoginTextBox-&gt;GetText().ToString())); std::string hash_str = TCHAR_TO_UTF8(*USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wPasswordTextBox-&gt;GetText().ToString()); reg-&gt;set_hash(UCrypto::SHA256(&amp;hash_str, hash_str.length())); reg-&gt;set_mail(TCHAR_TO_UTF8(*USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wMainTextBox-&gt;GetText().ToString())); UMessageEncoder::Send(reg.get(), true, true); } } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Login</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include "Login.generated.h" class Login; UCLASS() class SPIKY_CLIENT_API ULogin : public UObject { GENERATED_BODY() public: void Handler(Login login); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Login.h" #include "Protobufs/RegLogModels.pb.h" #include "SpikyGameInstance.h" #include "LoginWidgets.h" #include "Descriptors.h" #include "Crypto.h" #include "MessageEncoder.h" #include "DifferentMix.h" #include "Runtime/UMG/Public/Components/TextBlock.h" void ULogin::Handler(Login login) { if (login.GetReflection()-&gt;HasField(login, Descriptors::publicKey_log)) { USpikyGameInstance::secretKey = UCrypto::Generate_SecretKey_DH(login.publickey()); std::shared_ptr&lt;Login&gt; login_proto(new Login); login_proto-&gt;set_mail(ULoginWidgets::mail); login_proto-&gt;set_hash(UCrypto::SHA256(&amp;ULoginWidgets::password, ULoginWidgets::password.length())); UMessageEncoder::Send(login_proto.get(), true, true); } if (login.GetReflection()-&gt;HasField(login, Descriptors::stateCode_log)) { USpikyGameInstance::DifferentMix-&gt;StopWaitingScreen(); USpikyGameInstance::DifferentMix-&gt;wLoginScreen-&gt;wInfoBlock-&gt;SetText(FText::FromString("Incorrect login or password")); GLog-&gt;Log(FString("Session ID: NULL")); GLog-&gt;Log(FString("Login: NULL")); } }</span></span></code> </pre><br></div></div><br>  SpikyGameInstance     ,        : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//.h static std::string secretKey; static std::string sessionId; static std::string userLogin; //.cpp std::string USpikyGameInstance::secretKey = ""; std::string USpikyGameInstance::sessionId = ""; std::string USpikyGameInstance::userLogin = "";</span></span></code> </pre><br>       Registration   Login: <br><br><div class="spoiler"> <b class="spoiler_title">Registration</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.dbmodels.UserModel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.RegistrationLoginModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Query; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Transaction; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.background.SingleColorBackgroundFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.color.SingleColorFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.filter.predefined.CurvesRippleFilterFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.service.ConfigurableCaptchaService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.patchca.utils.encoder.EncoderHelper; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.ByteArrayOutputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Registration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Registration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Registration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, RegistrationLoginModels.Registration registration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(registration.hasField(publicKey_reg)) { Cryptography cryptography = ctx.channel().attr(CRYPTOGRAPHY).get(); ctx.channel().attr(SECRETKEY).set(cryptography.DiffieHellman_createSecretKey(registration.getPublicKey())); cryptography.setSecretKey(ctx.channel().attr(SECRETKEY).get()); System.out.println(<span class="hljs-string"><span class="hljs-string">"secret key: "</span></span> + ctx.channel().attr(SECRETKEY).get()); <span class="hljs-comment"><span class="hljs-comment">// todo registration = RegistrationLoginModels.Registration.newBuilder().clear().setStateCode(1).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setRegistration(registration).build()); } else if(!registration.hasField(login_reg) || !registration.hasField(mail_reg) || !registration.hasField(captcha_reg)) { //     registration = RegistrationLoginModels.Registration.newBuilder() .clear() .setStateCode(0) //    .build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setRegistration(registration).build()); } else { //     ctx.writeAndFlush(checkAll(ctx, registration)); } } private MessageModels.Wrapper checkAll(ChannelHandlerContext ctx, RegistrationLoginModels.Registration registration) { Session session = ctx.channel().attr(HIBER_SESSION).get(); Query query = session.createQuery("SELECT login, mail FROM UserModel WHERE login = :login OR mail = :mail "); query.setParameter("login", registration.getLogin()); query.setParameter("mail", registration.getMail()); java.util.List&lt;String[]&gt; userdata = query.list(); boolean challengeFind = false; synchronized (captchaBank) { for (Map.Entry&lt;Long, String&gt; entry : captchaBank.entrySet()) if (entry.getValue().equals(registration.getCaptcha())) challengeFind = true; } if(!userdata.isEmpty() || !challengeFind) { if(!userdata.isEmpty()) System.out.println("!userdata.isEmpty()"); if(!challengeFind) System.out.println("!challengeFind"); registration = RegistrationLoginModels.Registration.newBuilder().clear().setStateCode(0).build(); return MessageModels.Wrapper.newBuilder().setRegistration(registration).build(); } else { System.out.println("Registration initialization, send public key.."); Cryptography cryptography = ctx.channel().attr(CRYPTOGRAPHY).get(); cryptography.DiffieHellman_createKeys(); registration = RegistrationLoginModels.Registration.newBuilder().clear().setPublicKey(cryptography.getClientPublicKey()).build(); return MessageModels.Wrapper.newBuilder().setRegistration(registration).build(); } } public MessageModels.Wrapper getCaptcha() { try { ConfigurableCaptchaService cs = new ConfigurableCaptchaService(); cs.setBackgroundFactory(new SingleColorBackgroundFactory(new Color(0, 0, 0))); cs.setColorFactory(new SingleColorFactory(new Color(255, 255, 255))); cs.setFilterFactory(new CurvesRippleFilterFactory(cs.getColorFactory())); cs.setHeight(100); cs.setWidth(250); ByteArrayOutputStream bos = new ByteArrayOutputStream(); captchaBank.put(System.currentTimeMillis(), EncoderHelper.getChallangeAndWriteImage(cs, "png", bos)); byte[] captchaBytes = bos.toByteArray(); bos.close(); RegistrationLoginModels.InputChecking inputChecking = RegistrationLoginModels.InputChecking.newBuilder() .setCaptchaData(ByteString.copyFrom(captchaBytes)) .build(); return MessageModels.Wrapper.newBuilder().setInputChecking(inputChecking).build(); } catch (IOException e) { e.printStackTrace(); } return null; } public void saveUser(ChannelHandlerContext ctx, RegistrationLoginModels.Registration registration) { UserModel user = new UserModel(); user.setLogin(registration.getLogin()); user.setHashPass(registration.getHash()); user.setMail(registration.getMail()); Session session = ctx.channel().attr(HIBER_SESSION).get(); Transaction transaction = ctx.channel().attr(HIBER_TRANSACTION).get(); session.save(user); transaction.commit(); RegistrationLoginModels.InitialState.Builder initialState = RegistrationLoginModels.InitialState.newBuilder() .setSessionId(ctx.channel().id().asShortText()) .setLogin(user.getLogin()); ctx.channel().attr(CHANNEL_OWNER).set(user.getLogin()); /* *//*      *//* roomListUpdateSubscribers.add(ctx.channel()); *//*      *//* for (Map.Entry&lt;String,GameRoom&gt; pair : gameRooms.entrySet()) { *//*          *//* if(!pair.getValue().getGameState()) { GameRoomModels.CreateRoom room = GameRoomModels.CreateRoom.newBuilder() .setRoomName(pair.getValue().getRoomName()) .setMapName(pair.getValue().getMapName()) .setCreator(pair.getValue().getCreator()) .setGameTime(pair.getValue().getGameTime() + " minutes") .setMaxPlayers(pair.getValue().getMaxPlayers() + " players") .build(); initialState.addCreateRoom(room); } } */ MessageModels.CryptogramWrapper cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder() .setInitialState(ByteString.copyFrom(initialState.build().toByteArray())).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Login</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.dbmodels.UserModel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.RegistrationLoginModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Query; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.publicKey_log; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Login</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, RegistrationLoginModels.Login login)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(login.hasField(publicKey_log)) { Cryptography cryptography = ctx.channel().attr(CRYPTOGRAPHY).get(); cryptography.DiffieHellman_createKeys(); ctx.channel().attr(SECRETKEY).set(cryptography.DiffieHellman_createSecretKey(login.getPublicKey())); cryptography.setSecretKey(ctx.channel().attr(SECRETKEY).get()); System.out.println(<span class="hljs-string"><span class="hljs-string">"secret key: "</span></span> + ctx.channel().attr(SECRETKEY).get()); <span class="hljs-comment"><span class="hljs-comment">// todo login = RegistrationLoginModels.Login.newBuilder().clear().setPublicKey(cryptography.getClientPublicKey()).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setLogin(login).build()); } } public void hasUser(ChannelHandlerContext ctx, RegistrationLoginModels.Login login) { Session session = ctx.channel().attr(HIBER_SESSION).get(); Query query = session.createSQLQuery("SELECT * FROM UserModel WHERE mail = :mail AND hash = :hash").addEntity(UserModel.class); query.setParameter("mail", login.getMail()); query.setParameter("hash", login.getHash()); List&lt;UserModel&gt; user = query.list(); if(!user.isEmpty()) { ctx.channel().attr(CHANNEL_OWNER).set(user.get(0).getLogin()); /*      */ //roomListUpdateSubscribers.add(ctx.channel()); RegistrationLoginModels.InitialState.Builder initialState = RegistrationLoginModels.InitialState.newBuilder() .setSessionId(ctx.channel().id().asShortText()) .setLogin(user.get(0).getLogin()); /* *//*      *//* for (Map.Entry&lt;String,GameRoom&gt; pair : gameRooms.entrySet()) { *//*          *//* if(!pair.getValue().getGameState()) { GameRoomModels.CreateRoom room = GameRoomModels.CreateRoom.newBuilder() .setRoomName(pair.getValue().getRoomName()) .setMapName(pair.getValue().getMapName()) .setCreator(pair.getValue().getCreator()) .setGameTime(pair.getValue().getGameTime() + " minutes") .setMaxPlayers(pair.getValue().getMaxPlayers() + " players") .build(); initialState.addCreateRoom(room); } } */ MessageModels.CryptogramWrapper cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder() .setInitialState(ByteString.copyFrom(initialState.build().toByteArray())).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } else { RegistrationLoginModels.Login log = RegistrationLoginModels.Login.newBuilder().setStateCode(0).build(); MessageModels.CryptogramWrapper cryptogramWrapper = MessageModels.CryptogramWrapper.newBuilder() .setLogin(ByteString.copyFrom(log.toByteArray())).build(); ctx.writeAndFlush(MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cryptogramWrapper).build()); } } }</span></span></code> </pre><br></div></div><br>   DecryptHandler     : <br><br><div class="spoiler"> <b class="spoiler_title">DecryptHandler/decode</b> <div class="spoiler_text"><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasCryptogramWrapper()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(registration_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRegistration().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Registration registration = RegistrationLoginModels.Registration.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration().saveUser(ctx, registration); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper.getCryptogramWrapper().hasField(login_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getLogin().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Login login = RegistrationLoginModels.Login.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Login().hasUser(ctx, login); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasInputChecking()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputChecking(ctx, wrapper); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasRegistration()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration(ctx, wrapper.getRegistration()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasLogin()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Login(ctx, wrapper.getLogin()); }</code> </pre><br></div></div><br>  : <br><br><div class="spoiler"> <b class="spoiler_title">UMessageDecoder::SendProtoToDecoder</b> <div class="spoiler_text"><pre> <code class="cpp hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;has_inputchecking()) { UInputChecking * inputChecking = NewObject&lt;UInputChecking&gt;(UInputChecking::StaticClass()); inputChecking-&gt;Handler(wrapper-&gt;inputchecking()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;has_registration()) { URegistration * registration = NewObject&lt;URegistration&gt;(URegistration::StaticClass()); registration-&gt;Handler(wrapper-&gt;registration()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;has_login()) { ULogin * login = NewObject&lt;ULogin&gt;(ULogin::StaticClass()); login-&gt;Handler(wrapper-&gt;login()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;has_cryptogramwrapper()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::registration_cw)) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().registration(), USpikyGameInstance::secretKey); Registration registration; registration.ParseFromArray(source.c_str(), source.length()); URegistration * reg = NewObject&lt;URegistration&gt;(URegistration::StaticClass()); reg-&gt;Handler(registration); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::login_cw)) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> source = UCrypto::Decrypt(wrapper-&gt;cryptogramwrapper().login(), USpikyGameInstance::secretKey); Login login; login.ParseFromArray(source.c_str(), source.length()); ULogin * <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> = NewObject&lt;ULogin&gt;(ULogin::StaticClass()); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-&gt;Handler(login); } }</code> </pre><br></div></div><br>    . <br><br><h4>  check in </h4><br>        ‚Äî  ,  <code>ReloadCaptchaClicked()</code> ,      InputChecking   <code>inputChecking-&gt;set_getcaptcha(true)</code> ,     <code>UMessageEncoder::Send(message, bCrypt, bTCP)</code> ,    ,   InputChecking  ,   Wrapper    TCP <code>USocketObject::tcp_socket-&gt;Send(...)</code> . <br><br>            DecryptHandler decode.    ,  ,     InputChecking(ctx, wrapper)   ,          .                    Registration.     InputChecking <code>Registration().getCaptcha()</code> .             <code>Map&lt;Long,String&gt; captchaBank</code> ,        ,    .       ServerMain ‚Äî captchaCleaner()   . <br><br>      <code>FTCPSocketListeningTh::Run()</code>          <code>UMessageDecoder::SendProtoToDecoder</code> .        <code>UInputChecking::Handler,</code>     ¬´ ¬ª <code>HasField(inputChecking, Descriptors::captchaDataField_ich)</code> ,         : <br><br><pre> <code class="cpp hljs">UTexture2D* tex= USpikyGameInstance::DifferentMix-&gt;CreateTexture(inputChecking.captchadata(),<span class="hljs-literal"><span class="hljs-literal">true</span></span>); USpikyGameInstance::DifferentMix-&gt;wRegistration-&gt;wCaptchaImage-&gt;SetBrushFromTexture(tex);</code> </pre><br>         ,    ,   ,      -  .       ,       ,      . <br><br>        SingUpButtonClicked(),    <code>USpikyGameInstance::DifferentMix-&gt;RunWaitingScreen()</code> ,   Registration   Login, Mail, Captcha    .  ,     Registration,     ,      checkAll().   HIBER_SESSION         .   CRYPTOGRAPHY     DiffieHellman/createKeys()   . <br><br>   ,    <code>URegistration::Handler</code>       .     <code>USpikyGameInstance::secretKey</code> .        Registration    <code>if(registration.hasField(publicKey_reg))</code>       ,    <code>ctx.channel().attr(SECRETKEY)</code> .      ,   ,     .     Registration,   ,        <code>UCrypto::SHA256</code> .   <code>UMessageEncoder::Send</code>        <code>UCrypto::EncryptProto(mes, USpikyGameInstance::secretKey)</code> .    CryptogramWrapper,      Wrapper,     .    Registration  <code>saveUser(...)</code>           . <br><br><h4>  Login </h4><br>     ,      ,    <code>LoginButtonClicked()</code>    <code>DifferentMix-&gt;RunWaitingScreen()</code> ,       .         .    ,         .              . <br><br><h3>       </h3><br>             .     , ,       . <br><br><img src="https://habrastorage.org/web/da9/33c/bc0/da933cbc08c3434f9d3a9ad1801df7ec.PNG"><br><br>        : <br><br> MainMenu_W ‚Äì   ; <br> ChatMain_W ‚Äì    ,   MainMenu; <br> CreateRoom_W ‚Äì     ; <br><br><div class="spoiler"> <b class="spoiler_title">MainMenuWidgets</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "MainMenuWidgets.generated.h" class UTextBlock; class UButton; class UScrollBox; class URoomListUnit; UCLASS() class SPIKY_CLIENT_API UMainMenuWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UButton* wOpenChatButton = nullptr; UTextBlock* wPlayerName = nullptr; UTextBlock* wInfoBlock = nullptr; UButton* wCreateRoomButton = nullptr; UFUNCTION() void OpenChatButtonClicked(); UFUNCTION() void CreateRoomButtonClicked(); FTimerHandle MessageTimerHandle; void HideErrorMessage(); void ShowErrorMessage(FString msg); UScrollBox * wRoomsScrollBox = nullptr; bool bChatOpen = false; bool bCreateRoomOpen = false; void AddRoom(URoomListUnit* room); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MainMenuWidgets.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "Runtime/UMG/Public/Components/ScrollBox.h" #include "Runtime/Engine/Public/TimerManager.h" void UMainMenuWidgets::NativeConstruct() { Super::NativeConstruct(); wOpenChatButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("OpenChatButton"))); wOpenChatButton-&gt;OnClicked.AddDynamic(this, &amp;UMainMenuWidgets::OpenChatButtonClicked); wCreateRoomButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("CreateRoomButton"))); wCreateRoomButton-&gt;OnClicked.AddDynamic(this, &amp;UMainMenuWidgets::CreateRoomButtonClicked); wPlayerName = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("PlayerName"))); wInfoBlock = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("InfoBox"))); wRoomsScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("RoomsScrollBox"))); } void UMainMenuWidgets::OpenChatButtonClicked() { } void UMainMenuWidgets::CreateRoomButtonClicked() { } void UMainMenuWidgets::AddRoom(URoomListUnit* room) { } void UMainMenuWidgets::HideErrorMessage() { wInfoBlock-&gt;SetText(FText::FromString(" ")); } void UMainMenuWidgets::ShowErrorMessage(FString msg) { wInfoBlock-&gt;SetText(FText::FromString(*msg)); GetWorld()-&gt;GetTimerManager().ClearTimer(MessageTimerHandle); GetWorld()-&gt;GetTimerManager().SetTimer(MessageTimerHandle, this, &amp;UMainMenuWidgets::HideErrorMessage, 2.f, false); }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">MainMenuChatWidgets</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "MainMenuChatWidgets.generated.h" class Chat; class UButton; class UScrollBox; class UMultiLineEditableTextBox; class URichText; UCLASS() class SPIKY_CLIENT_API UMainMenuChatWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UButton* wEnterButton = nullptr; UFUNCTION() void EnterButtonClicked(); UScrollBox * wChatScrollBox = nullptr; UMultiLineEditableTextBox* wChatTextBox = nullptr; void NewMessage(URichText* richText); void ScrollToEnd(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MainMenuChatWidgets.h" #include "Runtime/UMG/Public/Components/ScrollBox.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/MultiLineEditableTextBox.h" void UMainMenuChatWidgets::NativeConstruct() { Super::NativeConstruct(); wEnterButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("EnterButton"))); wEnterButton-&gt;OnClicked.AddDynamic(this, &amp;UMainMenuChatWidgets::EnterButtonClicked); wChatScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("ChatScrollBox"))); wChatTextBox = Cast&lt;UMultiLineEditableTextBox&gt;(GetWidgetFromName(TEXT("ChatTextBox"))); } void UMainMenuChatWidgets::EnterButtonClicked() { } void UMainMenuChatWidgets::NewMessage(URichText* richText) { } void UMainMenuChatWidgets::ScrollToEnd() { }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">CreateRoom</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "CreateRoomWidgets.generated.h" class UEditableTextBox; class UButton; class UComboBoxString; UCLASS() class SPIKY_CLIENT_API UCreateRoomWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UEditableTextBox* wRoomNameTextBox = nullptr; UComboBoxString* wMapComboBox = nullptr; UComboBoxString* wGameTimeComboBox = nullptr; UComboBoxString* wPlayersNumberComboBox = nullptr; UButton* wCreateRoomButton = nullptr; UFUNCTION() void CreateRoomButtonClicked(); UFUNCTION() void OnRoomNameTextChanged(const FText &amp; text); bool bRoomNameOk = false; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "CreateRoomWidgets.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/EditableTextBox.h" #include "Runtime/UMG/Public/Components/ComboBoxString.h" void UCreateRoomWidgets::NativeConstruct() { Super::NativeConstruct(); wCreateRoomButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("CreateRoomButton"))); wCreateRoomButton-&gt;OnClicked.AddDynamic(this, &amp;UCreateRoomWidgets::CreateRoomButtonClicked); wRoomNameTextBox = Cast&lt;UEditableTextBox&gt;(GetWidgetFromName(TEXT("RoomName"))); wRoomNameTextBox-&gt;OnTextChanged.AddDynamic(this, &amp;UCreateRoomWidgets::OnRoomNameTextChanged); wMapComboBox = Cast&lt;UComboBoxString&gt;(GetWidgetFromName(TEXT("MapComboBox"))); wGameTimeComboBox = Cast&lt;UComboBoxString&gt;(GetWidgetFromName(TEXT("TimeComboBox"))); wPlayersNumberComboBox = Cast&lt;UComboBoxString&gt;(GetWidgetFromName(TEXT("PNComboBox"))); } void UCreateRoomWidgets::CreateRoomButtonClicked() { } void UCreateRoomWidgets::OnRoomNameTextChanged(const FText &amp; text) { }</span></span></code> </pre><br></div></div><br>        .     DifferentMix: <br><br><div class="spoiler"> <b class="spoiler_title">   DifferentMix</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//.h class UMainMenuWidgets; class UMainMenuChatWidgets; class UCreateRoomWidgets; UMainMenuWidgets* tmpMainMenuRef; UMainMenuChatWidgets* tmpMainMenuChatRef; UCreateRoomWidgets* tmpCreateRoomRef; UMainMenuWidgets* wMainMenuWidgets; UMainMenuChatWidgets* wMainMenuChatWidgets; UCreateRoomWidgets* wCreateRoomWidgets; UCanvasPanelSlot* mainMenuSlot; UCanvasPanelSlot* mainMenuChatSlot; UCanvasPanelSlot* createRoomSlot; void ShowMainMenuScreen(); //.cpp #include "MainMenuWidgets.h" #include "MainMenuChatWidgets.h" #include "CreateRoomWidgets.h" UDifferentMix::UDifferentMix(const FObjectInitializer&amp; ObjectInitializer) : Super(ObjectInitializer) { static ConstructorHelpers::FClassFinder&lt;UMainMenuWidgets&gt; MainMenuWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/MainMenu_W.MainMenu_W_C'")); if (MainMenuWidgets.Class != NULL) { tmpMainMenuRef = MainMenuWidgets.Class-&gt;GetDefaultObject&lt;UMainMenuWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;UMainMenuChatWidgets&gt; chatMainMenuWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/ChatMain_W.ChatMain_W_C'")); if (chatMainMenuWidgets.Class != NULL) { tmpMainMenuChatRef = chatMainMenuWidgets.Class-&gt;GetDefaultObject&lt;UMainMenuChatWidgets&gt;(); } static ConstructorHelpers::FClassFinder&lt;UCreateRoomWidgets&gt; createRoomWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/CreateRoom_W.CreateRoom_W_C'")); if (createRoomWidgets.Class != NULL) { tmpCreateRoomRef = createRoomWidgets.Class-&gt;GetDefaultObject&lt;UCreateRoomWidgets&gt;(); } } void UDifferentMix::Init() { wMainMenuWidgets = CreateWidget&lt;UMainMenuWidgets&gt;(GetWorld(), tmpMainMenuRef-&gt;GetClass()); mainMenuSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wMainMenuWidgets)); mainMenuSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); mainMenuSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); wMainMenuChatWidgets = CreateWidget&lt;UMainMenuChatWidgets&gt;(GetWorld(), tmpMainMenuChatRef-&gt;GetClass()); mainMenuChatSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wMainMenuChatWidgets)); mainMenuChatSlot-&gt;SetZOrder(10); mainMenuChatSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); mainMenuChatSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wMainMenuChatWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); wCreateRoomWidgets = CreateWidget&lt;UCreateRoomWidgets&gt;(GetWorld(), tmpCreateRoomRef-&gt;GetClass()); createRoomSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wCreateRoomWidgets)); createRoomSlot-&gt;SetZOrder(1); createRoomSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); createRoomSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } void UDifferentMix::ShowMainMenuScreen() { HideAllWidgets(); wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Visible); }</span></span></code> </pre><br></div></div><br>  ,            .      ,           id.     Logics  InitialState,      ,      , ,   ,   ,   .     id    ,          . <br><br>    UMessageDecoder     : <br><br><pre> <code class="cpp hljs">UInitialState * initialState = NewObject&lt;UInitialState&gt;(UInitialState::StaticClass()); initialState-&gt;Handler(is);</code> </pre> <br>   ,     ,      --   .   ,       ,     ,  ‚Äî  ,  ,     .    100    CircularArrayList  ArrayList,       . <br><br>    UMainMenuWidgets::OpenChatButtonClicked(),       -   : <br><br><div class="spoiler"> <b class="spoiler_title">UMainMenuWidgets::OpenChatButtonClicked()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Protobufs/MainMenuModels.pb.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SpikyGameInstance.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DifferentMix.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MainMenuChatWidgets.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MessageEncoder.h"</span></span></span><span class="hljs-meta"> void UMainMenuWidgets::OpenChatButtonClicked() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!bChatOpen) { bChatOpen = true; USpikyGameInstance::DifferentMix-&gt;wMainMenuChatWidgets-&gt;SetVisibility(ESlateVisibility::SelfHitTestInvisible); std::shared_ptr</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Chat&gt; chat(new Chat); chat-&gt;set_subscribe(true); std::shared_ptr&lt;MainMenu&gt; mainMenu(new MainMenu); mainMenu-&gt;set_allocated_chat(chat.get()); UMessageEncoder::Send(mainMenu.get(), true, true); mainMenu-&gt;release_chat(); } else { bChatOpen = false; USpikyGameInstance::DifferentMix-&gt;wMainMenuChatWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wMainMenuChatWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); std::shared_ptr&lt;Chat&gt; chat(new Chat); chat-&gt;set_subscribe(false); std::shared_ptr&lt;MainMenu&gt; mainMenu(new MainMenu); mainMenu-&gt;set_allocated_chat(chat.get()); UMessageEncoder::Send(mainMenu.get(), true, true); mainMenu-&gt;release_chat(); } }</span></span></span></span></code> </pre><br></div></div><br>       ,   MainMenu  : <br><br><div class="spoiler"> <b class="spoiler_title">MainMenu</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include "MainMenu.generated.h" class MainMenu; UCLASS() class SPIKY_CLIENT_API UMainMenu : public UObject { GENERATED_BODY() public: void Handler(MainMenu mainMenu); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MainMenu.h" #include "Protobufs/MainMenuModels.pb.h" #include "Descriptors.h" void UMainMenu::Handler(MainMenu mainMenu) { }</span></span></code> </pre><br></div></div><br>        ,  MainMenu  ,     DecryptHandler: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(mainMenu_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getMainMenu().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); MainMenuModels.MainMenu mainMenu = MainMenuModels.MainMenu.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainMenu(ctx, mainMenu); }</code> </pre><br>       MainMenuChat,    : <br><br><div class="spoiler"> <b class="spoiler_title">MainMenuChat</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainMenu</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainMenu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MainMenuModels.MainMenu mainMenu)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mainMenu.hasField(chat_mm)) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainMenuChat(ctx, mainMenu.getChat()); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainMenuChat</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainMenuChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MainMenuModels.Chat chat)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br></div></div><br>       ,     ,         ,   .    Utils: <br><br><div class="spoiler"> <b class="spoiler_title">CircularArrayList</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.utils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CircularArrayList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayList&lt;E&gt; list; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxSize; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CircularArrayList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;E&gt; (size); maxSize = size; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list.size(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E objectToAdd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list.size () &gt; maxSize) { list.remove(<span class="hljs-number"><span class="hljs-number">0</span></span>); list.add(objectToAdd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { list.add(objectToAdd); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> E </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list.get(i); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String str = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (E element : list) str+= <span class="hljs-string"><span class="hljs-string">"["</span></span> + element + <span class="hljs-string"><span class="hljs-string">"]"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } }</code> </pre><br></div></div><br>   ArrayList,                   .   MainMenuChat: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ChannelGroup recipients = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE); <span class="hljs-comment"><span class="hljs-comment">/*   100  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List&lt;MainMenuModels.Chat&gt; syncMessageList = Collections.synchronizedList(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CircularArrayList&lt;MainMenuModels.Chat&gt;(<span class="hljs-number"><span class="hljs-number">100</span></span>));</code> </pre><br> Recipients ‚Äì     Netty,       , ,      . MainMenuChat   : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(chat.hasField(subscribe_chat)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(chat.getSubscribe()) <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> recipients.add(ctx.channel());    <span class="hljs-number"><span class="hljs-number">100</span></span>     recipients.remove(ctx.channel()); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>                <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> recipients.writeAndFlush(wrapper);</code> </pre><br>     UMainMenu::Handler: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mainMenu.GetReflection()-&gt;HasField(mainMenu, Descriptors::chat_mm)) { UChats * chats = NewObject&lt;UChats&gt;(UChats::StaticClass()); chats-&gt;Handler(mainMenu.chat(), <span class="hljs-string"><span class="hljs-string">"mainmenu"</span></span>); }</code> </pre><br>   ,  ,              ,   . <br><br><img src="https://habrastorage.org/web/130/f18/768/130f18768c9f4716830502df1e95e122.PNG"><br><br>      .        RoomManager ‚Äì // , /,         . GameRoom ‚Äì     , , ,   .    CreateRoomWidgets           ,    , ,     . <br><br>      CreateRoom,    Room,  ,    Wrapper. <br><br>    UMainMenuWidgets::CreateRoomButtonClicked(): <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CreateRoomWidgets.h"</span></span></span><span class="hljs-meta"> ... void UMainMenuWidgets::CreateRoomButtonClicked() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!bCreateRoomOpen) { bCreateRoomOpen = true; USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::SelfHitTestInvisible); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { bCreateRoomOpen = false; USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } }</span></span></code> </pre><br><br><img src="https://habrastorage.org/web/dbc/40d/0de/dbc40d0de55045aea538a9f9a71b6125.PNG"><br><br>    DecryptHandler/decode,       RoomManager: <br><br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(room_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRoom().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); GameRoomModels.Room room = GameRoomModels.Room.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RoomManager(ctx, room); } ...</code> </pre><br>         GameRoom,    Logics: <br><br><div class="spoiler"> <b class="spoiler_title">GameRoom</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include &lt;string&gt; #include "GameRoom.generated.h" class Room; class CreateRoom; class URoomListUnit; class RoomsListUpdate; class SubscribeRoom; class RoomUpdate; UCLASS() class SPIKY_CLIENT_API UGameRoom : public UObject { GENERATED_BODY() public: void Handler(Room room); static URoomListUnit* NewRoom(CreateRoom room); static std::string roomCreator; static std::string roomName; void DeleteRoom(RoomsListUpdate room); void DeleteRoom(std::string name); void Subscribe(SubscribeRoom subscribe); void UpdateRoom(RoomUpdate update); void StartGame(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "GameRoom.h" #include "Descriptors.h" #include "Protobufs/GameRoomModels.pb.h" std::string UGameRoom::roomCreator = ""; std::string UGameRoom::roomName = ""; void UGameRoom::Handler(Room room) { if (room.has_createroom()) { } else if (room.has_roomslistupdate()) { } else if (room.has_subscriberoom()) { } else if (room.has_roomupdate()) { } } void UGameRoom::Subscribe(SubscribeRoom subscribe) { } void UGameRoom::UpdateRoom(RoomUpdate update) { } URoomListUnit* UGameRoom::NewRoom(CreateRoom room) { return nullptr; } void UGameRoom::DeleteRoom(RoomsListUpdate update) { } void UGameRoom::DeleteRoom(std::string name) { } void UGameRoom::StartGame() { }</span></span></code> </pre><br></div></div><br> ,              RoomManager,       if(room.hasCreateRoom())      createRoom(ctx, room.getCreateRoom()); <br><br>     ,          (       )    ,           .   ServerMain: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AttributeKey&lt;String&gt; ROOM_OWNER = AttributeKey.valueOf(<span class="hljs-string"><span class="hljs-string">"room_owner"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ChannelGroup roomListUpdateSubscribers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Map&lt;String,GameRoom&gt; gameRooms = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;());</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open GameRoom, an instance of this class stores the name of the creator, the name of the map, the name of the room, the time of the game, the number of players, the session id of the creator, the state of the game ‚Äî that is, the game is running or not; players. </font><font style="vertical-align: inherit;">Command lists and chat:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoom</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MainMenuModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.CircularArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.Channel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.group.ChannelGroup; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.group.DefaultChannelGroup; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.util.concurrent.GlobalEventExecutor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.CHANNEL_OWNER; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameRoom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String creator; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mapName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String roomName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> gameTime; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxPlayers; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String creatorSessionId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> gameState = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Map&lt;String,Channel&gt; players = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;()); Map&lt;String,Channel&gt; team1 = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;()); Map&lt;String,Channel&gt; team2 = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;()); Map&lt;String,Channel&gt; undistributed = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;()); <span class="hljs-comment"><span class="hljs-comment">//Map&lt;String,PlayerState&gt; playersState = Collections.synchronizedMap(new HashMap&lt;&gt;()); /*      */ ChannelGroup recipients = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); /*   100  */ List&lt;MainMenuModels.Chat&gt; syncMessageList = Collections.synchronizedList(new CircularArrayList&lt;MainMenuModels.Chat&gt;(100)); GameRoom(ChannelHandlerContext ctx, GameRoomModels.CreateRoom roomDescribe) { creator = ctx.channel().attr(CHANNEL_OWNER).get(); /*      ,        id  */ creatorSessionId = ctx.channel().id().asShortText(); roomName = roomDescribe.getRoomName(); mapName = roomDescribe.getMapName(); if(Objects.equals(roomDescribe.getGameTime(), "5 minutes")) { gameTime = 5; } else if(Objects.equals(roomDescribe.getGameTime(), "10 minutes")) { gameTime = 10; } else if(Objects.equals(roomDescribe.getGameTime(), "15 minutes")) { gameTime = 15; } else if(Objects.equals(roomDescribe.getGameTime(), "20 minutes")) { gameTime = 20; } maxPlayers = Integer.parseInt(roomDescribe.getMaxPlayers()); addPlayer(ctx, creator); } void addPlayer(ChannelHandlerContext ctx, String player) { if(players.size() &lt; maxPlayers) { /*      */ players.put(player, ctx.channel()); /*     */ undistributed.put(player, ctx.channel()); /*    */ recipients.add(ctx.channel()); } } public String getCreator() { return creator; } public void setCreator(String creator) { this.creator = creator; } public String getMapName() { return mapName; } public void setMapName(String mapName) { this.mapName = mapName; } public String getRoomName() { return roomName; } public void setRoomName(String roomName) { this.roomName = roomName; } public int getGameTime() { return gameTime; } public void setGameTime(int gameTime) { this.gameTime = gameTime; } public int getMaxPlayers() { return maxPlayers; } public void setMaxPlayers(int maxPlayers) { this.maxPlayers = maxPlayers; } public String getCreatorSessionId() { return creatorSessionId; } public void setCreatorSessionId(String creatorSessionId) { this.creatorSessionId = creatorSessionId; } public boolean getGameState() { return gameState; } public void setGameState(boolean gameState) { this.gameState = gameState; } }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roommanager</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasCreateRoom()) { createRoom(ctx, room.getCreateRoom()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.CreateRoom createRoom)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> GameRoom gameRoom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameRoom(ctx, createRoom); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRooms.containsKey(gameRoom.getCreator())) { gameRooms.put(gameRoom.getCreator(), gameRoom); ctx.channel().attr(ROOM_OWNER).set(ctx.channel().attr(CHANNEL_OWNER).get()); createRoom = createRoom.toBuilder().setRoomName(gameRoom.getRoomName()).setCreator(gameRoom.getCreator()).build(); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setCreateRoom(createRoom).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> roomListUpdateSubscribers.writeAndFlush(wrapper); } } }</code> </pre><br></div></div><br> <code>createRoom(ChannelHandlerContext ctx, GameRoomModels.CreateRoom createRoom)</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creates a new room based on incoming data. </font><font style="vertical-align: inherit;">Checks for the presence of a room with the owner, if the player has already created one room, he can not create a second one at a time. </font><font style="vertical-align: inherit;">Return the room data to the client and update the list of rooms for everyone (type of response is CreateRoom). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the client, the message goes to UGameRoom :: Handler:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.has_createroom()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;AddRoom(NewRoom(room.createroom())); <span class="hljs-comment"><span class="hljs-comment">//      ,         if (room.createroom().creator() == USpikyGameInstance::userLogin) { roomCreator = room.createroom().creator(); roomName = room.createroom().roomname(); USpikyGameInstance::DifferentMix-&gt;ShowGameRoom(); } }</span></span></code> </pre><br>        .         .              UButton      ,           : <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;SubscribeRoom&gt; subscribe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SubscribeRoom); subscribe-&gt;set_subscribe(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); subscribe-&gt;set_roomname(TCHAR_TO_UTF8(*textBlock-&gt;GetText().ToString()));</code> </pre><br>   RoomListUnit  UI: <br><br><div class="spoiler"> <b class="spoiler_title">RoomListUnit</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Runtime/UMG/Public/Components/Button.h" #include "RoomListUnit.generated.h" DECLARE_DYNAMIC_MULTICAST_DELEGATE(FClickDelegate); UCLASS() class SPIKY_CLIENT_API URoomListUnit: public UButton { GENERATED_BODY() public: URoomListUnit(); UPROPERTY() FClickDelegate click; UFUNCTION() void OnClick(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "RoomListUnit.h" #include "Protobufs/GameRoomModels.pb.h" #include "Runtime/UMG/Public/Components/HorizontalBox.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "MessageEncoder.h" URoomListUnit::URoomListUnit() { OnClicked.AddDynamic(this, &amp;URoomListUnit::OnClick); } void URoomListUnit::OnClick() { std::shared_ptr&lt;Room&gt; room(new Room); UHorizontalBox* horBox = Cast&lt;UHorizontalBox&gt;(GetChildAt(0)); UTextBlock* textBlock = Cast&lt;UTextBlock&gt;(horBox-&gt;GetChildAt(0)); std::shared_ptr&lt;SubscribeRoom&gt; subscribe(new SubscribeRoom); subscribe-&gt;set_subscribe(true); subscribe-&gt;set_roomname(TCHAR_TO_UTF8(*textBlock-&gt;GetText().ToString())); room-&gt;set_allocated_subscriberoom(subscribe.get()); UMessageEncoder::Send(room.get(), true, true); room-&gt;release_subscriberoom(); }</span></span></code> </pre><br></div></div><br>  UMainMenuWidgets::AddRoom(URoomListUnit* room): <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/ScrollBoxSlot.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RoomListUnit.h"</span></span></span><span class="hljs-meta"> void UMainMenuWidgets::AddRoom(URoomListUnit* room) { UScrollBoxSlot* gameRoomSlot = Cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UScrollBoxSlot&gt;(wRoomsScrollBox-&gt;AddChild(room)); gameRoomSlot-&gt;SetHorizontalAlignment(HAlign_Fill); } URoomListUnit* UGameRoom::NewRoom(CreateRoom room)   ,              </span></span></span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title">UGameRoom::NewRoom</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/HorizontalBox.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/HorizontalBoxSlot.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/TextBlock.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/ButtonSlot.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/ScrollBox.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RoomListUnit.h"</span></span></span><span class="hljs-meta"> URoomListUnit* UGameRoom::NewRoom(CreateRoom room) { URoomListUnit* button = NewObject</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;URoomListUnit&gt;(URoomListUnit::StaticClass()); UHorizontalBox* horBox = NewObject&lt;UHorizontalBox&gt;(UHorizontalBox::StaticClass()); UTextBlock* wRoomName = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wMapName = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wCreator = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wGameTime = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wMaxPlayers = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); wRoomName-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.roomname().c_str())))); wMapName-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.mapname().c_str())))); wCreator-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.creator().c_str())))); wGameTime-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.gametime().c_str())))); wMaxPlayers-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.maxplayers().c_str())))); UHorizontalBoxSlot* roomNameSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wRoomName)); UHorizontalBoxSlot* mapNameSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wMapName)); UHorizontalBoxSlot* creatorSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wCreator)); UHorizontalBoxSlot* gameTimeSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wGameTime)); UHorizontalBoxSlot* maxPlayersSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wMaxPlayers)); roomNameSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); roomNameSlot-&gt;SetHorizontalAlignment(HAlign_Center); mapNameSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); mapNameSlot-&gt;SetHorizontalAlignment(HAlign_Center); creatorSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); creatorSlot-&gt;SetHorizontalAlignment(HAlign_Center); gameTimeSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); gameTimeSlot-&gt;SetHorizontalAlignment(HAlign_Center); maxPlayersSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); maxPlayersSlot-&gt;SetHorizontalAlignment(HAlign_Center); UButtonSlot* buttonSlot = Cast&lt;UButtonSlot&gt;(button-&gt;AddChild(horBox)); buttonSlot-&gt;SetHorizontalAlignment(HAlign_Fill); buttonSlot-&gt;SetVerticalAlignment(VAlign_Fill); return button; }</span></span></span></span></code> </pre><br></div></div><br>      ,   ,        ,      . <br>  Login        : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!user.isEmpty()) ctx.channel().attr(CHANNEL_OWNER).set(user.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getLogin()); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> roomListUpdateSubscribers.add(ctx.channel());</code> </pre><br>          : <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;String,GameRoom&gt; pair : gameRooms.entrySet()) { <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!pair.getValue().getGameState()) { GameRoomModels.CreateRoom room = GameRoomModels.CreateRoom.newBuilder() .setRoomName(pair.getValue().getRoomName()) .setMapName(pair.getValue().getMapName()) .setCreator(pair.getValue().getCreator()) .setGameTime(pair.getValue().getGameTime() + <span class="hljs-string"><span class="hljs-string">" minutes"</span></span>) .setMaxPlayers(pair.getValue().getMaxPlayers() + <span class="hljs-string"><span class="hljs-string">" players"</span></span>) .build(); initialState.addCreateRoom(room); } }</code> </pre><br>    Registration: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, RegistrationLoginModels.Registration registration)</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ ctx.channel().attr(CHANNEL_OWNER).set(user.getLogin()); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> roomListUpdateSubscribers.add(ctx.channel()); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;String,GameRoom&gt; pair : gameRooms.entrySet()) { ‚Ä¶ }</code> </pre><br>   .          ,       .         ,      .             .           ,   . <br><br><img src="https://habrastorage.org/web/a7d/5b7/551/a7d5b7551f90429085df58a4e2968a5b.PNG"><br><br><img src="https://habrastorage.org/web/c1c/82c/4b6/c1c82c4b65e4408f9dc3df8099221ffd.PNG"><br><br>        ,   ,       DiffrentMix     : <br><br><div class="spoiler">  <b class="spoiler_title">Changes</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//.h void ShowGameRoom(); UTexture2D* EmptyImage = nullptr; UTexture2D* GreenImage = nullptr; //.cpp //   static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; EmptyImageRef(TEXT("Texture2D'/Game/ProjectResources/Images/empty.empty'")); EmptyImage = EmptyImageRef.Object; static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; GreenImageRef(TEXT("Texture2D'/Game/ProjectResources/Images/G.G'")); GreenImage = GreenImageRef.Object; void UDifferentMix::ShowGameRoom() { HideAllWidgets(); //  ,   wMainMenuChatWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); wMainMenuWidgets-&gt;bChatOpen = false; wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Visible); wGameRoomWidgets-&gt;wToFirstTeamButton-&gt;SetVisibility(ESlateVisibility::Visible); wGameRoomWidgets-&gt;wToSecondTeamButton-&gt;SetVisibility(ESlateVisibility::Visible); wGameRoomWidgets-&gt;wToUndistributedTeamButton-&gt;SetVisibility(ESlateVisibility::Visible); wGameRoomWidgets-&gt;wStartButton-&gt;SetVisibility(ESlateVisibility::Visible); wGameRoomWidgets-&gt;AddPlayer(USpikyGameInstance::userLogin.c_str(), "undistributed"); }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add the source code of the widget, to start the list item, the custom button UGameRoomUserUnit. </font><font style="vertical-align: inherit;">Here we bind the event of pressing the button, change its style and add the player to the list of selected ones, with which we will later move through the lists:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoomUserUnit</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Components/Button.h" #include &lt;vector&gt; #include "GameRoomUserUnit.generated.h" DECLARE_DYNAMIC_MULTICAST_DELEGATE(FClickDelegateGameRoom); UCLASS() class SPIKY_CLIENT_API UGameRoomUserUnit: public UButton { GENERATED_BODY() public: UGameRoomUserUnit(); UPROPERTY() FClickDelegateGameRoom click; UFUNCTION() void OnClick(); bool bSelect = false; static std::vector&lt;std::pair&lt;FString, FString&gt;&gt; select_players; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "GameRoomUserUnit.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include &lt;algorithm&gt; #include "GameRoom.h" std::vector&lt;std::pair&lt;FString, FString&gt;&gt; UGameRoomUserUnit::select_players; UGameRoomUserUnit::UGameRoomUserUnit() { OnClicked.AddDynamic(this, &amp;UGameRoomUserUnit::OnClick); } void UGameRoomUserUnit::OnClick() { //        if (UGameRoom::roomCreator != USpikyGameInstance::userLogin) return; UTextBlock* textBlock = Cast&lt;UTextBlock&gt;(GetChildAt(0)); FSlateBrush greenBackgroundImage; greenBackgroundImage.SetResourceObject((UObject*)(USpikyGameInstance::DifferentMix-&gt;GreenImage)); FSlateBrush emptyBackgroundImage; emptyBackgroundImage.SetResourceObject((UObject*)(USpikyGameInstance::DifferentMix-&gt;EmptyImage)); FString player_name = textBlock-&gt;GetText().ToString();; FString team_name = GetParent()-&gt;GetName(); std::pair&lt;FString, FString&gt; item = std::make_pair(player_name, team_name); if (!bSelect) { bSelect = true; WidgetStyle.Pressed = greenBackgroundImage; WidgetStyle.Hovered = greenBackgroundImage; WidgetStyle.Normal = greenBackgroundImage; select_players.push_back(item); } else { bSelect = false; WidgetStyle.Pressed = emptyBackgroundImage; WidgetStyle.Hovered = emptyBackgroundImage; WidgetStyle.Normal = emptyBackgroundImage; auto it = std::find(select_players.begin(), select_players.end(), item); if (it == select_players.end()) { // not in vector } else { auto index = std::distance(select_players.begin(), it); select_players.erase(select_players.begin() + index); } } GLog-&gt;Log(FString::FromInt(select_players.size())); }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoomWidgets</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "GameRoomWidgets.generated.h" class UScrollBox; class UButton; class UMultiLineEditableTextBox; class URichText; UCLASS() class SPIKY_CLIENT_API UGameRoomWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UScrollBox* wUndistributedTeamScrollBox = nullptr; UScrollBox* wFirstTeamScrollBox = nullptr; UScrollBox* wSecondTeamScrollBox = nullptr; UButton* wToFirstTeamButton = nullptr; UButton* wToSecondTeamButton = nullptr; UButton* wToUndistributedTeamButton = nullptr; UButton* wStartButton = nullptr; UButton* wGameInfoButton = nullptr; UButton* wCloseButton = nullptr; UButton* wEnterButton = nullptr; UScrollBox * wChatScrollBox = nullptr; UMultiLineEditableTextBox* wChatTextBox = nullptr; UFUNCTION() void StartButtonClicked(); UFUNCTION() void GameInfoButtonClicked(); UFUNCTION() void ToFirstTeamClicked(); UFUNCTION() void ToSecondTeamClicked(); UFUNCTION() void ToUndistributedClicked(); UFUNCTION() void CloseButtonClicked(); UFUNCTION() void EnterButtonClicked(); void NewMessage(URichText* richText); void ScrollToEnd(); void AddPlayer(FString player, FString team); void RemovePlayer(FString player, FString team); void RemoveAddPlayer(FString player, FString sourceTeam, FString targetTeam); void TeamSelector(FString team); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "GameRoomWidgets.h" #include "Runtime/UMG/Public/Components/ScrollBox.h" #include "Runtime/UMG/Public/Components/ScrollBoxSlot.h" #include "Runtime/UMG/Public/Components/Button.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "Runtime/UMG/Public/Components/MultiLineEditableTextBox.h" #include "GameRoomUserUnit.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "Protobufs/GameRoomModels.pb.h" #include "GameRoom.h" #include "MessageEncoder.h" #include "MainMenuWidgets.h" #include "CreateRoomWidgets.h" #include "RichText.h" #include "Runtime/Engine/Public/TimerManager.h" void UGameRoomWidgets::NativeConstruct() { Super::NativeConstruct(); wFirstTeamScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("team1"))); wSecondTeamScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("team2"))); wUndistributedTeamScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("undistributed"))); wToFirstTeamButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("ToFTButton"))); wToFirstTeamButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::ToFirstTeamClicked); wToSecondTeamButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("ToSTButton"))); wToSecondTeamButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::ToSecondTeamClicked); wToUndistributedTeamButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("ToUndistributedButton"))); wToUndistributedTeamButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::ToUndistributedClicked); wCloseButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("CloseButton"))); wCloseButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::CloseButtonClicked); wEnterButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("EnterButton"))); wEnterButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::EnterButtonClicked); wChatScrollBox = Cast&lt;UScrollBox&gt;(GetWidgetFromName(TEXT("ChatScrollBox"))); wChatTextBox = Cast&lt;UMultiLineEditableTextBox&gt;(GetWidgetFromName(TEXT("ChatTextBox"))); wStartButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("StartButton"))); wStartButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::StartButtonClicked); wGameInfoButton = Cast&lt;UButton&gt;(GetWidgetFromName(TEXT("GameInfoButton"))); wGameInfoButton-&gt;OnClicked.AddDynamic(this, &amp;UGameRoomWidgets::GameInfoButtonClicked); } void UGameRoomWidgets::AddPlayer(FString player, FString team) { UGameRoomUserUnit* button = NewObject&lt;UGameRoomUserUnit&gt;(this, UGameRoomUserUnit::StaticClass()); UTextBlock* textBlock = NewObject&lt;UTextBlock&gt;(this, UTextBlock::StaticClass()); textBlock-&gt;SetText(FText::FromString(player)); button-&gt;AddChild(textBlock); FSlateBrush emptyBackgroundImage; emptyBackgroundImage.SetResourceObject((UObject*)(USpikyGameInstance::DifferentMix-&gt;EmptyImage)); button-&gt;WidgetStyle.Normal = emptyBackgroundImage; button-&gt;WidgetStyle.Hovered = emptyBackgroundImage; button-&gt;WidgetStyle.Pressed = emptyBackgroundImage; UScrollBoxSlot* buttonSlot = nullptr; if (team == "team1") { buttonSlot = Cast&lt;UScrollBoxSlot&gt;(wFirstTeamScrollBox-&gt;AddChild(button)); } else if (team == "team2") { buttonSlot = Cast&lt;UScrollBoxSlot&gt;(wSecondTeamScrollBox-&gt;AddChild(button)); } else if (team == "undistributed") { buttonSlot = Cast&lt;UScrollBoxSlot&gt;(wUndistributedTeamScrollBox-&gt;AddChild(button)); } buttonSlot-&gt;SetHorizontalAlignment(HAlign_Fill); } void UGameRoomWidgets::RemovePlayer(FString player, FString team) { UScrollBox* targetScrollBox = nullptr; if (team == "team1") { targetScrollBox = wFirstTeamScrollBox; } else if (team == "team2") { targetScrollBox = wSecondTeamScrollBox; } else if (team == "undistributed") { targetScrollBox = wUndistributedTeamScrollBox; } for (size_t i = 0; i &lt; targetScrollBox-&gt;GetChildrenCount(); i++) { UGameRoomUserUnit* button = Cast&lt;UGameRoomUserUnit&gt;(targetScrollBox-&gt;GetChildAt(i)); UTextBlock* textBlock = Cast&lt;UTextBlock&gt;(button-&gt;GetChildAt(0)); if (textBlock-&gt;GetText().ToString() == player) targetScrollBox-&gt;RemoveChildAt(i); } //     ,   auto it = UGameRoomUserUnit::select_players.begin(); //       while (it != UGameRoomUserUnit::select_players.end()) { if (it-&gt;first == player) { it = UGameRoomUserUnit::select_players.erase(it); } else { ++it; } GLog-&gt;Log(FString::FromInt(UGameRoomUserUnit::select_players.size())); } } void UGameRoomWidgets::RemoveAddPlayer(FString player, FString sourceTeam, FString targetTeam) { //    ,      UScrollBox * targetScrollBox = nullptr; if (targetTeam == "team1") targetScrollBox = wFirstTeamScrollBox; if (targetTeam == "team2") targetScrollBox = wSecondTeamScrollBox; if (targetTeam == "undistributed") targetScrollBox = wUndistributedTeamScrollBox; for (size_t i = 0; i &lt; targetScrollBox-&gt;GetChildrenCount(); i++) { UGameRoomUserUnit * entity = Cast&lt;UGameRoomUserUnit&gt;(targetScrollBox-&gt;GetChildAt(i)); FString str = Cast&lt;UTextBlock&gt;(entity-&gt;GetChildAt(0))-&gt;GetText().ToString(); for (auto const&amp; e : UGameRoomUserUnit::select_players) if (str == e.first) entity-&gt;OnClick(); } if (targetTeam == "team1" &amp;&amp; sourceTeam != targetTeam) { RemovePlayer(player, sourceTeam); AddPlayer(player, targetTeam); } if (targetTeam == "team2" &amp;&amp; sourceTeam != targetTeam) { RemovePlayer(player, sourceTeam); AddPlayer(player, targetTeam); } if (targetTeam == "undistributed" &amp;&amp; sourceTeam != targetTeam) { RemovePlayer(player, sourceTeam); AddPlayer(player, targetTeam); } //     ,   auto it = UGameRoomUserUnit::select_players.begin(); while (it != UGameRoomUserUnit::select_players.end()) { if (it-&gt;first == player) { it = UGameRoomUserUnit::select_players.erase(it); } else { ++it; } GLog-&gt;Log(FString::FromInt(UGameRoomUserUnit::select_players.size())); } } void UGameRoomWidgets::TeamSelector(FString team) { std::string targetTeam = TCHAR_TO_UTF8(*team); //      std::shared_ptr&lt;RoomDescribe&gt; roomDescribe(new RoomDescribe); for (auto s : UGameRoomUserUnit::select_players) { if (s.second == "undistributed") { TeamPlayer* teamPlayer = roomDescribe-&gt;add_undistributed(); teamPlayer-&gt;set_player_name(TCHAR_TO_UTF8(*s.first)); } else if (s.second == "team1") { TeamPlayer* teamPlayer = roomDescribe-&gt;add_team1(); teamPlayer-&gt;set_player_name(TCHAR_TO_UTF8(*s.first)); } else if (s.second == "team2") { TeamPlayer* teamPlayer = roomDescribe-&gt;add_team2(); teamPlayer-&gt;set_player_name(TCHAR_TO_UTF8(*s.first)); } } std::shared_ptr&lt;RoomUpdate&gt; roomUpdate(new RoomUpdate); roomUpdate-&gt;set_allocated_roomdescribe(roomDescribe.get()); roomUpdate-&gt;set_targetteam(targetTeam); roomUpdate-&gt;set_roomname(UGameRoom::roomName); std::shared_ptr&lt;Room&gt; room(new Room); room-&gt;set_allocated_roomupdate(roomUpdate.get()); UMessageEncoder::Send(room.get(), true, true); room-&gt;release_roomupdate(); roomUpdate-&gt;release_roomdescribe(); } void UGameRoomWidgets::StartButtonClicked() { std::shared_ptr&lt;Room&gt; room(new Room); room-&gt;set_startgame(true); room-&gt;set_roomname(UGameRoom::roomName); UMessageEncoder::Send(room.get(), true, true); } void UGameRoomWidgets::GameInfoButtonClicked() { // TODO } void UGameRoomWidgets::ToFirstTeamClicked() { TeamSelector("team1"); } void UGameRoomWidgets::ToUndistributedClicked() { TeamSelector("undistributed"); } void UGameRoomWidgets::ToSecondTeamClicked() { TeamSelector("team2"); } void UGameRoomWidgets::CloseButtonClicked() { if (UGameRoom::roomCreator != USpikyGameInstance::userLogin) { //       wFirstTeamScrollBox-&gt;ClearChildren(); wSecondTeamScrollBox-&gt;ClearChildren(); wUndistributedTeamScrollBox-&gt;ClearChildren(); wChatScrollBox-&gt;ClearChildren(); //      USpikyGameInstance::DifferentMix-&gt;ShowMainMenuScreen(); //    std::shared_ptr&lt;SubscribeRoom&gt; unsubscribe(new SubscribeRoom); unsubscribe-&gt;set_subscribe(false); unsubscribe-&gt;set_roomname(UGameRoom::roomName); std::shared_ptr&lt;Room&gt; room(new Room); room-&gt;set_allocated_subscriberoom(unsubscribe.get()); UMessageEncoder::Send(room.get(), true, true); room-&gt;release_subscriberoom(); } else { std::shared_ptr&lt;RoomsListUpdate&gt; update(new RoomsListUpdate); update-&gt;set_deleteroom(true); std::shared_ptr&lt;Room&gt; room(new Room); room-&gt;set_allocated_roomslistupdate(update.get()); UMessageEncoder::Send(room.get(), true, true); room-&gt;release_roomslistupdate(); } } void UGameRoomWidgets::EnterButtonClicked() { if (wChatTextBox-&gt;GetText().ToString() == "") return; std::shared_ptr&lt;Room&gt; room(new Room); std::shared_ptr&lt;RoomUpdate&gt; roomUpdate(new RoomUpdate); std::shared_ptr&lt;RoomDescribe&gt; roomDescribe(new RoomDescribe); std::shared_ptr&lt;Chat&gt; chat(new Chat); chat-&gt;set_text(TCHAR_TO_UTF8(*wChatTextBox-&gt;GetText().ToString())); wChatTextBox-&gt;SetText(FText::FromString("")); roomDescribe-&gt;set_allocated_chat(chat.get()); roomUpdate-&gt;set_allocated_roomdescribe(roomDescribe.get()); roomUpdate-&gt;set_roomname(UGameRoom::roomName); room-&gt;set_allocated_roomupdate(roomUpdate.get()); UMessageEncoder::Send(room.get(), true, true); room-&gt;release_roomupdate(); roomUpdate-&gt;release_roomdescribe(); roomDescribe-&gt;release_chat(); } void UGameRoomWidgets::NewMessage(URichText* richText) { UScrollBoxSlot* richTextSlot = Cast&lt;UScrollBoxSlot&gt;(wChatScrollBox-&gt;AddChild(richText)); richTextSlot-&gt;SetPadding(FMargin(10, 5, 10, 5)); wChatScrollBox-&gt;ScrollToEnd(); FTimerHandle timerHandle; GetWorld()-&gt;GetTimerManager().SetTimer(timerHandle, this, &amp;UGameRoomWidgets::ScrollToEnd, .01f, false); } void UGameRoomWidgets::ScrollToEnd() { wChatScrollBox-&gt;ScrollToEnd(); }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is no widget that could perform moving lists in Unreal, you have to create your own, here is a description of each function: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::NativeConstruct()      <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::AddPlayer(FString player, FString team)            <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::RemovePlayer(FString player, FString team)     <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::RemoveAddPlayer(FString player, FString sourceTeam, FString targetTeam)           <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::TeamSelector(FString team)          RoomDescribe,        <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::StartButtonClicked()                    <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::CloseButtonClicked()                            <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::EnterButtonClicked()     <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::NewMessage(URichText* richText)      <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::ScrollToEnd()     </code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now add a new widget to DifferentMix: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoomWidgets in DifferentMix</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs">.h <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UGameRoomWidgets</span></span></span><span class="hljs-class">;</span></span> UGameRoomWidgets* tmpGameRoomRef; UGameRoomWidgets* wGameRoomWidgets; .cpp <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"GameRoomWidgets.h"</span></span></span><span class="hljs-meta"> ... static ConstructorHelpers::FClassFinder</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UGameRoomWidgets&gt; gameRoomWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/GameRoom_W.GameRoom_W_C'")); if (gameRoomWidgets.Class != NULL) { tmpGameRoomRef = gameRoomWidgets.Class-&gt;GetDefaultObject&lt;UGameRoomWidgets&gt;(); } ... wGameRoomWidgets = CreateWidget&lt;UGameRoomWidgets&gt;(GetWorld(), tmpGameRoomRef-&gt;GetClass()); gameRoomSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wGameRoomWidgets)); gameRoomSlot-&gt;SetZOrder(1); gameRoomSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); gameRoomSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden);</span></span></span></span></code> </pre><br></div></div><br>   GameRoom  GameRoomWidgets  .  UGameRoom::Handler()  USpikyGameInstance::DifferentMix-&gt;ShowGameRoom();            .        ,   .    UGameRoomWidgets::CloseButtonClicked()  : <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;RoomsListUpdate&gt; update(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RoomsListUpdate); update-&gt;set_deleteroom(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>    RoomManager : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomsListUpdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomsListUpdate().hasField(deleteRoom_room)) { deleteRoom(ctx); } }</code> </pre><br>  deleteRoom(ChannelHandlerContext ctx),      ,       ,          .          ,   RoomManager: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearRoomData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function">     -   ,             ,                       </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomUnsubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function">           ,    </span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title">RoomManager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Objects; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.deleteRoom_room; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasCreateRoom()) { createRoom(ctx, room.getCreateRoom()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomsListUpdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomsListUpdate().hasField(deleteRoom_room)) { deleteRoom(ctx); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.CreateRoom createRoom)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> GameRoom gameRoom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameRoom(ctx, createRoom); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRooms.containsKey(gameRoom.getCreator())) { gameRooms.put(gameRoom.getCreator(), gameRoom); ctx.channel().attr(ROOM_OWNER).set(ctx.channel().attr(CHANNEL_OWNER).get()); createRoom = createRoom.toBuilder().setRoomName(gameRoom.getRoomName()).setCreator(gameRoom.getCreator()).build(); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setCreateRoom(createRoom).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRooms.containsKey(channel_owner)) { GameRoom gameRoom = gameRooms.get(channel_owner); <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.getGameState()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> gameRooms.remove(channel_owner); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setRoomOwner(gameRoom.getCreator()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearRoomData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ String player = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRooms.containsKey(player)) { GameRoom gameRoom = gameRooms.get(player); System.out.println(gameRoom.getRoomName()); <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRoom.getGameState()) { gameRooms.remove(player); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setDeleteRoom(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).setRoomName(gameRoom.getRoomName()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-comment"><span class="hljs-comment">/*  ,            */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRooms.get(owner).players.containsKey(player)) { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRooms.get(owner).getGameState()) { GameRoom gameRoom = gameRooms.get(owner); GameRoomModels.SubscribeRoom.Builder subscribe = GameRoomModels.SubscribeRoom.newBuilder() .setRoomName(gameRoom.getRoomName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team1.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"team1"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRoom.team2.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"team2"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRoom.undistributed.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"undistributed"</span></span>); } GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe.build()).build(); roomUnsubscribe(ctx, room); } } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomUnsubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRooms.get(owner).getRoomName(), room.getSubscribeRoom().getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String player = ctx.channel().attr(CHANNEL_OWNER).get(); String team = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRoom.getGameState()) { gameRoom.players.remove(player); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team1.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"team1"</span></span>; gameRoom.team1.remove(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team2.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"team2"</span></span>; gameRoom.team2.remove(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.undistributed.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"undistributed"</span></span>; gameRoom.undistributed.remove(player); } GameRoomModels.SubscribeRoom subscribe = room.getSubscribeRoom().toBuilder().setPlayer(player).setTeam(team).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); System.out.println(out); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } }</code> </pre><br></div></div><br>      , Netty     ,     IdleStateHandler(30, 0, 0),    timeout   ,   ,   ,    .          30   ,      . <br><br>     ServerInitializer,   : <br><br><div class="spoiler"> <b class="spoiler_title">ServerInitializer</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketChannel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChannel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SocketChannel ch)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ChannelPipeline pipeline = ch.pipeline(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">//pipeline.addLast(new LoggingHandler(LogLevel.INFO)); /*   */ // Decoders protobuf pipeline.addLast(new ProtobufVarint32FrameDecoder()); pipeline.addLast(new ProtobufDecoder(MessageModels.Wrapper.getDefaultInstance())); /*   */ // Encoder protobuf pipeline.addLast(new ProtobufVarint32LengthFieldPrepender()); pipeline.addLast(new ProtobufEncoder()); /* The connection is closed when there is no inbound traffic for N seconds */ pipeline.addLast(new IdleStateHandler(30, 0, 0)); /*    */ pipeline.addLast(new EncryptHandler()); /*    */ pipeline.addLast(new DecryptHandler()); } }</span></span></code> </pre><br></div></div><br>       DecryptHandler: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearPlayerData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function">     . </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exceptionCaught</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception   </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelUnregistered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception   </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userEventTriggered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception -   -        30 </span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title"> DecryptHandler</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.handlers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MainMenuModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.RegistrationLoginModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.tcp.logics.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.utils.SessionUtil; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.handler.codec.MessageToMessageDecoder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.handler.timeout.IdleState; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.handler.timeout.IdleStateEvent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Session; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.hibernate.Transaction; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.CRYPTOGRAPHY; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.HIBER_SESSION; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.HIBER_TRANSACTION; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.tcp.logics.RoomManager.clearRoomData; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecryptHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageToMessageDecoder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageModels</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wrapper</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Session session = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionUtil().getSession(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Transaction transaction = session.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Cryptography cryptography = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cryptography(); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> bInit = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!bInit) { bInit = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; ctx.channel().attr(HIBER_SESSION).set(session); ctx.channel().attr(HIBER_TRANSACTION).set(transaction); ctx.channel().attr(CRYPTOGRAPHY).set(cryptography); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper, List&lt;Object&gt; list)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ init(ctx); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasCryptogramWrapper()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(registration_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRegistration().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Registration registration = RegistrationLoginModels.Registration.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration().saveUser(ctx, registration); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper.getCryptogramWrapper().hasField(login_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getLogin().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegistrationLoginModels.Login login = RegistrationLoginModels.Login.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Login().hasUser(ctx, login); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(mainMenu_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getMainMenu().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); MainMenuModels.MainMenu mainMenu = MainMenuModels.MainMenu.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainMenu(ctx, mainMenu); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(room_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRoom().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); GameRoomModels.Room room = GameRoomModels.Room.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RoomManager(ctx, room); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasInputChecking()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputChecking(ctx, wrapper); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasRegistration()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration(ctx, wrapper.getRegistration()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasLogin()) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Login(ctx, wrapper.getLogin()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearPlayerData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(session.isOpen()) session.close(); clearRoomData(ctx); ctx.close(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exceptionCaught</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ cause.printStackTrace(); clearPlayerData(ctx); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelUnregistered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.channelUnregistered(ctx); System.out.println(<span class="hljs-string"><span class="hljs-string">"Close connection id: "</span></span> + ctx.channel().id().asShortText() + <span class="hljs-string"><span class="hljs-string">" cause ChannelUnregistered"</span></span>); clearPlayerData(ctx); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userEventTriggered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (evt <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> IdleStateEvent) { IdleStateEvent e = (IdleStateEvent) evt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.state() == IdleState.READER_IDLE) { System.out.println(<span class="hljs-string"><span class="hljs-string">"Close connection id: "</span></span> + ctx.channel().id().asShortText() + <span class="hljs-string"><span class="hljs-string">" cause READER_IDLE"</span></span>); clearPlayerData(ctx); } } } }</code> </pre><br></div></div><br>          : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoom::DeleteRoom(RoomsListUpdate update)               <span class="hljs-comment"><span class="hljs-comment">/* -      ,       ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoom::DeleteRoom(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name)                                     </code> </pre><br><div class="spoiler"> <b class="spoiler_title">UGameRoom::DeleteRoom</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"GameRoomWidgets.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"GameRoomUserUnit.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CreateRoomWidgets.h"</span></span></span><span class="hljs-meta"> void UGameRoom::DeleteRoom(RoomsListUpdate update) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     for (size_t i = 0; i &lt; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildrenCount(); i++) { URoomListUnit* listUnit = Cast&lt;URoomListUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildAt(i)); UHorizontalBox* horBox = Cast&lt;UHorizontalBox&gt;(listUnit-&gt;GetChildAt(0)); UTextBlock* wCreatorName = Cast&lt;UTextBlock&gt;(horBox-&gt;GetChildAt(2)); if (wCreatorName-&gt;GetText().ToString() == update.roomowner().c_str()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;RemoveChildAt(i); } } //           if (roomCreator == update.roomowner().c_str()) { //       USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); UGameRoomUserUnit::select_players.clear(); roomCreator = ""; roomName = ""; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Visible); USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } } void UGameRoom::DeleteRoom(std::string name) { //     for (size_t i = 0; i &lt; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildrenCount(); i++) { URoomListUnit* listUnit = Cast&lt;URoomListUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildAt(i)); UHorizontalBox* horBox = Cast&lt;UHorizontalBox&gt;(listUnit-&gt;GetChildAt(0)); UTextBlock* wCreatorName = Cast&lt;UTextBlock&gt;(horBox-&gt;GetChildAt(2)); if (wCreatorName-&gt;GetText().ToString() == name.c_str()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;RemoveChildAt(i); } } //       if (roomCreator == name) { //         for (size_t j = 0; j &lt; USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;GetChildrenCount(); j++) { UGameRoomUserUnit * entity = Cast&lt;UGameRoomUserUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;GetChildAt(j)); FString playerName = Cast&lt;UTextBlock&gt;(entity-&gt;GetChildAt(0))-&gt;GetText().ToString(); //           if (playerName == USpikyGameInstance::userLogin.c_str() &amp;&amp; playerName != roomCreator.c_str()) { //       USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); UGameRoomUserUnit::select_players.clear(); roomCreator = ""; roomName = ""; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Visible); USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } } } }</span></span></span></span></code> </pre><br></div></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoom::Handler(Room room) { ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.has_roomslistupdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!room.startgame()) { <span class="hljs-comment"><span class="hljs-comment">//    ,      DeleteRoom(room.roomslistupdate()); } else { DeleteRoom(room.roomslistupdate().roomowner()); } } }</span></span></code> </pre><br>      ,     ,     .         UGameRoomWidgets::CloseButtonClicked(). <br><br>  URoomListUnit::OnClick()        .    .  RoomManager     : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasSubscribeRoom()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getSubscribeRoom().getSubscribe()) { roomSubscribe(ctx, room); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { roomUnsubscribe(ctx, room); } }</code> </pre><br>   : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function">                    ,               ,  ,          </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx, gameRoom , player)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoom gameRoom, String player)</span></span></span><span class="hljs-function">         ,          ChannelMatchers.isNot </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/*    */</span></span></span><span class="hljs-function"> gameRoom.recipients.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeAndFlush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(wrapper, ChannelMatchers.isNot(ctx.channel()</span></span></span><span class="hljs-function">))</span></span>;</code> </pre><br>       : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomUpdate()) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomUpdate().getRoomDescribe().hasChat()) { <span class="hljs-comment"><span class="hljs-comment">//chatHandler(ctx, room.getRoomUpdate()); } else { updateRoom(ctx, room.getRoomUpdate()); } }</span></span></code> </pre><br>   : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.RoomUpdate roomUpdate)</span></span></span><span class="hljs-function">    ,   ,    </span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title">RoomManager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MainMenuModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.Channel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.group.ChannelMatchers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Objects; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.deleteRoom_room; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasCreateRoom()) { createRoom(ctx, room.getCreateRoom()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomsListUpdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomsListUpdate().hasField(deleteRoom_room)) { deleteRoom(ctx); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasSubscribeRoom()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getSubscribeRoom().getSubscribe()) { roomSubscribe(ctx, room); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { roomUnsubscribe(ctx, room); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomUpdate()) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomUpdate().getRoomDescribe().hasChat()) { <span class="hljs-comment"><span class="hljs-comment">//chatHandler(ctx, room.getRoomUpdate()); } else { updateRoom(ctx, room.getRoomUpdate()); } } } private void createRoom(ChannelHandlerContext ctx, GameRoomModels.CreateRoom createRoom) { /*        */ GameRoom gameRoom = new GameRoom(ctx, createRoom); /*       */ if(!gameRooms.containsKey(gameRoom.getCreator())) { gameRooms.put(gameRoom.getCreator(), gameRoom); ctx.channel().attr(ROOM_OWNER).set(ctx.channel().attr(CHANNEL_OWNER).get()); createRoom = createRoom.toBuilder().setRoomName(gameRoom.getRoomName()).setCreator(gameRoom.getCreator()).build(); /*     */ GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setCreateRoom(createRoom).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); /*      */ roomListUpdateSubscribers.writeAndFlush(wrapper); } } public static void deleteRoom(ChannelHandlerContext ctx) { /*      */ String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); if(gameRooms.containsKey(channel_owner)) { GameRoom gameRoom = gameRooms.get(channel_owner); /*        */ if(gameRoom.getGameState()) return; /*     */ gameRooms.remove(channel_owner); /*     */ GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setRoomOwner(gameRoom.getCreator()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } public static void clearRoomData(ChannelHandlerContext ctx) { String player = ctx.channel().attr(CHANNEL_OWNER).get(); if(gameRooms.containsKey(player)) { GameRoom gameRoom = gameRooms.get(player); System.out.println(gameRoom.getRoomName()); /*    ,     */ if(!gameRoom.getGameState()) { gameRooms.remove(player); /*     */ GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setDeleteRoom(true).setRoomOwner(gameRoom.getCreator()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } /*  ,            */ else { for(String owner : gameRooms.keySet()) { if (gameRooms.get(owner).players.containsKey(player)) { /*      */ if(!gameRooms.get(owner).getGameState()) { GameRoom gameRoom = gameRooms.get(owner); GameRoomModels.SubscribeRoom.Builder subscribe = GameRoomModels.SubscribeRoom.newBuilder() .setRoomName(gameRoom.getRoomName()); if(gameRoom.team1.containsKey(player)) { subscribe.setTeam("team1"); } else if (gameRoom.team2.containsKey(player)) { subscribe.setTeam("team2"); } else if (gameRoom.undistributed.containsKey(player)) { subscribe.setTeam("undistributed"); } GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe.build()).build(); roomUnsubscribe(ctx, room); } } } } } private void roomSubscribe(ChannelHandlerContext ctx, GameRoomModels.Room room) { /*   */ for(String owner : gameRooms.keySet()) { if(Objects.equals(gameRooms.get(owner).getRoomName(), room.getSubscribeRoom().getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); /*       */ if(gameRoom.players.size() &gt; gameRoom.getMaxPlayers()) { GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setStateCode(1).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); return; } String player = ctx.channel().attr(CHANNEL_OWNER).get(); /* ,         */ if(!gameRoom.players.containsKey(player)) { gameRoom.addPlayer(ctx, player); } else { GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setStateCode(2).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); return; } /*       */ GameRoomModels.RoomDescribe.Builder builder = GameRoomModels.RoomDescribe.newBuilder(); for (String p : gameRoom.undistributed.keySet()) { GameRoomModels.TeamPlayer undistributed = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addUndistributed(undistributed); } for (String p : gameRoom.team1.keySet()) { GameRoomModels.TeamPlayer team1 = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addTeam1(team1); } for (String p : gameRoom.team2.keySet()) { GameRoomModels.TeamPlayer team2 = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addTeam2(team2); } GameRoomModels.RoomDescribe roomDescribe = builder.setRoomName(gameRoom.getRoomName()) .setMapName(gameRoom.getMapName()) .setGameTime(gameRoom.getGameTime() + " minutes") .setMaxPlayers(gameRoom.getMaxPlayers() + " players") .setCreator(gameRoom.getCreator()) .build(); MainMenuModels.Chat.Builder chatBuilder = MainMenuModels.Chat.newBuilder(); /*    100  */ for (int i = 0; i &lt; gameRoom.syncMessageList.size(); i++) { MainMenuModels.ChatMessage message = MainMenuModels.ChatMessage.newBuilder() .setTime(gameRoom.syncMessageList.get(i).getTime()) .setName(gameRoom.syncMessageList.get(i).getName()) .setText(gameRoom.syncMessageList.get(i).getText()) .build(); chatBuilder.addMessages(message); } roomDescribe = roomDescribe.toBuilder().setChat(chatBuilder.build()).build(); System.out.println(roomDescribe); GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setRoomDescribe(roomDescribe).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); /*      */ updateRoom(ctx, gameRoom , player); ctx.channel().attr(ROOM_OWNER).set(gameRoom.getCreator()); } } } private void updateRoom(ChannelHandlerContext ctx, GameRoomModels.RoomUpdate roomUpdate) { /*   */ for(String owner : gameRooms.keySet()) { if (Objects.equals(gameRooms.get(owner).getRoomName(), roomUpdate.getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); /*        */ if(Objects.equals(channel_owner, gameRoom.getCreator())) { GameRoomModels.RoomDescribe roomDescribe = roomUpdate.getRoomDescribe(); Map&lt;String,Channel&gt; list = new HashMap&lt;&gt;(); /*     */ for (GameRoomModels.TeamPlayer p : roomDescribe.getTeam1List()) { list.put(p.getPlayerName(), gameRoom.team1.get(p.getPlayerName())); gameRoom.team1.remove(p.getPlayerName()); } for (GameRoomModels.TeamPlayer p : roomDescribe.getTeam2List()) { list.put(p.getPlayerName(), gameRoom.team2.get(p.getPlayerName())); gameRoom.team2.remove(p.getPlayerName()); } for (GameRoomModels.TeamPlayer p : roomDescribe.getUndistributedList()) { list.put(p.getPlayerName(), gameRoom.undistributed.get(p.getPlayerName())); gameRoom.undistributed.remove(p.getPlayerName()); } /*    */ if(Objects.equals(roomUpdate.getTargetTeam(), "team1")) { gameRoom.team1.putAll(list); } else if(Objects.equals(roomUpdate.getTargetTeam(), "team2")) { gameRoom.team2.putAll(list); } else if(Objects.equals(roomUpdate.getTargetTeam(), "undistributed")) { gameRoom.undistributed.putAll(list); } /*     */ GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setRoomUpdate(roomUpdate).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } private void updateRoom(ChannelHandlerContext ctx, GameRoom gameRoom, String player) { /*          */ GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setPlayer(player).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); /*    */ gameRoom.recipients.writeAndFlush(wrapper, ChannelMatchers.isNot(ctx.channel())); } private static void roomUnsubscribe(ChannelHandlerContext ctx, GameRoomModels.Room room) { /*   */ for(String owner : gameRooms.keySet()) { if (Objects.equals(gameRooms.get(owner).getRoomName(), room.getSubscribeRoom().getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String player = ctx.channel().attr(CHANNEL_OWNER).get(); String team = ""; /*           */ if(!gameRoom.getGameState()) { gameRoom.players.remove(player); if(gameRoom.team1.containsKey(player)) { team = "team1"; gameRoom.team1.remove(player); } else if(gameRoom.team2.containsKey(player)) { team = "team2"; gameRoom.team2.remove(player); } else if(gameRoom.undistributed.containsKey(player)) { team = "undistributed"; gameRoom.undistributed.remove(player); } GameRoomModels.SubscribeRoom subscribe = room.getSubscribeRoom().toBuilder().setPlayer(player).setTeam(team).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); System.out.println(out); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } }</span></span></code> </pre><br></div></div><br>    UGameRoom::Handler(Room room): <br><br><pre> <code class="cpp hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.has_subscriberoom()) { Subscribe(room.subscriberoom()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.has_roomupdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.roomupdate().roomdescribe().GetReflection()-&gt;HasField(room.roomupdate().roomdescribe(), Descriptors::chat_room)) { <span class="hljs-comment"><span class="hljs-comment">//UChats * chats = NewObject&lt;UChats&gt;(UChats::StaticClass()); //chats-&gt;Handler(room.roomupdate().roomdescribe().chat(), "gameroom"); } else { UpdateRoom(room.roomupdate()); } }</span></span></code> </pre><br>  void UGameRoom::Subscribe(SubscribeRoom subscribe),     ,   ,       .         . <br> UGameRoom::UpdateRoom(RoomUpdate update),     - ,   -. <br><br>    ,   .    RoomManager  chatHandler(ctx, room.getRoomUpdate());    chatHandler(): <br><br><div class="spoiler"> <b class="spoiler_title">RoomManager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameRoomModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MainMenuModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.Channel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.group.ChannelMatchers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Objects; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.deleteRoom_room; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoomManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasCreateRoom()) { createRoom(ctx, room.getCreateRoom()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomsListUpdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomsListUpdate().hasField(deleteRoom_room)) { deleteRoom(ctx); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasSubscribeRoom()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getSubscribeRoom().getSubscribe()) { roomSubscribe(ctx, room); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { roomUnsubscribe(ctx, room); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasRoomUpdate()) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.getRoomUpdate().getRoomDescribe().hasChat()) { chatHandler(ctx, room.getRoomUpdate()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { updateRoom(ctx, room.getRoomUpdate()); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.CreateRoom createRoom)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> GameRoom gameRoom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameRoom(ctx, createRoom); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRooms.containsKey(gameRoom.getCreator())) { gameRooms.put(gameRoom.getCreator(), gameRoom); ctx.channel().attr(ROOM_OWNER).set(ctx.channel().attr(CHANNEL_OWNER).get()); createRoom = createRoom.toBuilder().setRoomName(gameRoom.getRoomName()).setCreator(gameRoom.getCreator()).build(); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setCreateRoom(createRoom).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRooms.containsKey(channel_owner)) { GameRoom gameRoom = gameRooms.get(channel_owner); <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.getGameState()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> gameRooms.remove(channel_owner); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setRoomOwner(gameRoom.getCreator()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearRoomData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx)</span></span></span><span class="hljs-function"> </span></span>{ String player = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRooms.containsKey(player)) { GameRoom gameRoom = gameRooms.get(player); System.out.println(gameRoom.getRoomName()); <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRoom.getGameState()) { gameRooms.remove(player); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.RoomsListUpdate update = GameRoomModels.RoomsListUpdate.newBuilder().setDeleteRoom(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).setRoomName(gameRoom.getRoomName()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomsListUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); roomListUpdateSubscribers.writeAndFlush(wrapper); } } <span class="hljs-comment"><span class="hljs-comment">/*  ,            */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRooms.get(owner).players.containsKey(player)) { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRooms.get(owner).getGameState()) { GameRoom gameRoom = gameRooms.get(owner); GameRoomModels.SubscribeRoom.Builder subscribe = GameRoomModels.SubscribeRoom.newBuilder() .setRoomName(gameRoom.getRoomName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team1.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"team1"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRoom.team2.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"team2"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRoom.undistributed.containsKey(player)) { subscribe.setTeam(<span class="hljs-string"><span class="hljs-string">"undistributed"</span></span>); } GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe.build()).build(); roomUnsubscribe(ctx, room); } } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Objects.equals(gameRooms.get(owner).getRoomName(), room.getSubscribeRoom().getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.players.size() &gt; gameRoom.getMaxPlayers()) { GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setStateCode(<span class="hljs-number"><span class="hljs-number">1</span></span>).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } String player = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-comment"><span class="hljs-comment">/* ,         */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRoom.players.containsKey(player)) { gameRoom.addPlayer(ctx, player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setStateCode(<span class="hljs-number"><span class="hljs-number">2</span></span>).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> GameRoomModels.RoomDescribe.Builder builder = GameRoomModels.RoomDescribe.newBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String p : gameRoom.undistributed.keySet()) { GameRoomModels.TeamPlayer undistributed = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addUndistributed(undistributed); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String p : gameRoom.team1.keySet()) { GameRoomModels.TeamPlayer team1 = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addTeam1(team1); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String p : gameRoom.team2.keySet()) { GameRoomModels.TeamPlayer team2 = GameRoomModels.TeamPlayer.newBuilder() .setPlayerName(p).build(); builder.addTeam2(team2); } GameRoomModels.RoomDescribe roomDescribe = builder.setRoomName(gameRoom.getRoomName()) .setMapName(gameRoom.getMapName()) .setGameTime(gameRoom.getGameTime() + <span class="hljs-string"><span class="hljs-string">" minutes"</span></span>) .setMaxPlayers(gameRoom.getMaxPlayers() + <span class="hljs-string"><span class="hljs-string">" players"</span></span>) .setCreator(gameRoom.getCreator()) .build(); MainMenuModels.Chat.Builder chatBuilder = MainMenuModels.Chat.newBuilder(); <span class="hljs-comment"><span class="hljs-comment">/*    100  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; gameRoom.syncMessageList.size(); i++) { MainMenuModels.ChatMessage message = MainMenuModels.ChatMessage.newBuilder() .setTime(gameRoom.syncMessageList.get(i).getTime()) .setName(gameRoom.syncMessageList.get(i).getName()) .setText(gameRoom.syncMessageList.get(i).getText()) .build(); chatBuilder.addMessages(message); } roomDescribe = roomDescribe.toBuilder().setChat(chatBuilder.build()).build(); System.out.println(roomDescribe); GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setRoomDescribe(roomDescribe).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> updateRoom(ctx, gameRoom , player); ctx.channel().attr(ROOM_OWNER).set(gameRoom.getCreator()); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.RoomUpdate roomUpdate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRooms.get(owner).getRoomName(), roomUpdate.getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Objects.equals(channel_owner, gameRoom.getCreator())) { GameRoomModels.RoomDescribe roomDescribe = roomUpdate.getRoomDescribe(); Map&lt;String,Channel&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GameRoomModels.TeamPlayer p : roomDescribe.getTeam1List()) { list.put(p.getPlayerName(), gameRoom.team1.get(p.getPlayerName())); gameRoom.team1.remove(p.getPlayerName()); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GameRoomModels.TeamPlayer p : roomDescribe.getTeam2List()) { list.put(p.getPlayerName(), gameRoom.team2.get(p.getPlayerName())); gameRoom.team2.remove(p.getPlayerName()); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GameRoomModels.TeamPlayer p : roomDescribe.getUndistributedList()) { list.put(p.getPlayerName(), gameRoom.undistributed.get(p.getPlayerName())); gameRoom.undistributed.remove(p.getPlayerName()); } <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Objects.equals(roomUpdate.getTargetTeam(), <span class="hljs-string"><span class="hljs-string">"team1"</span></span>)) { gameRoom.team1.putAll(list); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Objects.equals(roomUpdate.getTargetTeam(), <span class="hljs-string"><span class="hljs-string">"team2"</span></span>)) { gameRoom.team2.putAll(list); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Objects.equals(roomUpdate.getTargetTeam(), <span class="hljs-string"><span class="hljs-string">"undistributed"</span></span>)) { gameRoom.undistributed.putAll(list); } <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setRoomUpdate(roomUpdate).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoom gameRoom, String player)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> GameRoomModels.SubscribeRoom subscribe = GameRoomModels.SubscribeRoom.newBuilder().setPlayer(player).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> gameRoom.recipients.writeAndFlush(wrapper, ChannelMatchers.isNot(ctx.channel())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomUnsubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.Room room)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRooms.get(owner).getRoomName(), room.getSubscribeRoom().getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String player = ctx.channel().attr(CHANNEL_OWNER).get(); String team = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gameRoom.getGameState()) { gameRoom.players.remove(player); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team1.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"team1"</span></span>; gameRoom.team1.remove(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team2.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"team2"</span></span>; gameRoom.team2.remove(player); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.undistributed.containsKey(player)) { team = <span class="hljs-string"><span class="hljs-string">"undistributed"</span></span>; gameRoom.undistributed.remove(player); } GameRoomModels.SubscribeRoom subscribe = room.getSubscribeRoom().toBuilder().setPlayer(player).setTeam(team).build(); GameRoomModels.Room out = GameRoomModels.Room.newBuilder().setSubscribeRoom(subscribe).build(); System.out.println(out); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(out.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chatHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameRoomModels.RoomUpdate roomUpdate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRooms.get(owner).getRoomName(), roomUpdate.getRoomName())) { GameRoom gameRoom = gameRooms.get(owner); String channel_owner = ctx.channel().attr(CHANNEL_OWNER).get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameRoom.players.containsKey(channel_owner)) { Calendar c = Calendar.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ms = c.get(Calendar.HOUR_OF_DAY) * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> + c.get(Calendar.MINUTE) * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> + c.get(Calendar.SECOND) * <span class="hljs-number"><span class="hljs-number">1000</span></span>; MainMenuModels.Chat chat = roomUpdate.getRoomDescribe().getChat(); String str = chat.getText(); chat = MainMenuModels.Chat.newBuilder().clear() .setName(ctx.channel().attr(CHANNEL_OWNER).get()) .setText(str) .setTime(ms) .build(); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> gameRoom.syncMessageList.add(chat); GameRoomModels.RoomUpdate update = GameRoomModels.RoomUpdate.newBuilder().setRoomDescribe( GameRoomModels.RoomDescribe.newBuilder().setChat(chat).build()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setRoomUpdate(update).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } } } } }</code> </pre><br></div></div><br>     UGameRoom::Handler: <br><br><pre> <code class="cpp hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.has_roomupdate()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (room.roomupdate().roomdescribe().GetReflection()-&gt;HasField(room.roomupdate().roomdescribe(), Descriptors::chat_room)) { UChats * chats = NewObject&lt;UChats&gt;(UChats::StaticClass()); chats-&gt;Handler(room.roomupdate().roomdescribe().chat(), <span class="hljs-string"><span class="hljs-string">"gameroom"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { UpdateRoom(room.roomupdate()); } }</code> </pre><br>  UChats::Handler     type == ¬´gameroom¬ª,          : <br><br><div class="spoiler"> <b class="spoiler_title">GameRoom</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "GameRoom.h" #include "Descriptors.h" #include "Protobufs/GameRoomModels.pb.h" #include "SpikyGameInstance.h" #include "DifferentMix.h" #include "MainMenuWidgets.h" #include "Runtime/UMG/Public/Components/HorizontalBox.h" #include "Runtime/UMG/Public/Components/HorizontalBoxSlot.h" #include "Runtime/UMG/Public/Components/TextBlock.h" #include "Runtime/UMG/Public/Components/ButtonSlot.h" #include "Runtime/UMG/Public/Components/ScrollBox.h" #include "RoomListUnit.h" #include "GameRoomWidgets.h" #include "GameRoomUserUnit.h" #include "CreateRoomWidgets.h" std::string UGameRoom::roomCreator = ""; std::string UGameRoom::roomName = ""; void UGameRoom::Handler(Room room) { if (room.has_createroom()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;AddRoom(NewRoom(room.createroom())); //      ,         if (room.createroom().creator() == USpikyGameInstance::userLogin) { roomCreator = room.createroom().creator(); roomName = room.createroom().roomname(); USpikyGameInstance::DifferentMix-&gt;ShowGameRoom(); } } else if (room.has_roomslistupdate()) { if (!room.startgame()) { //    ,      DeleteRoom(room.roomslistupdate()); } else { DeleteRoom(room.roomslistupdate().roomowner()); } } else if (room.has_subscriberoom()) { Subscribe(room.subscriberoom()); } else if (room.has_roomupdate()) { if (room.roomupdate().roomdescribe().GetReflection()-&gt;HasField(room.roomupdate().roomdescribe(), Descriptors::chat_room)) { UChats * chats = NewObject&lt;UChats&gt;(UChats::StaticClass()); chats-&gt;Handler(room.roomupdate().roomdescribe().chat(), "gameroom"); } else { UpdateRoom(room.roomupdate()); } } } void UGameRoom::Subscribe(SubscribeRoom subscribe) { if (subscribe.statecode() == 1) { GLog-&gt;Log("The room is full"); } else if (subscribe.statecode() == 2) { GLog-&gt;Log("The player is already in the room"); } else if (subscribe.has_roomdescribe()) { //    roomCreator = subscribe.roomdescribe().creator(); roomName = subscribe.roomdescribe().roomname(); //      USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); for (TeamPlayer e : subscribe.roomdescribe().team1()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;AddPlayer(e.player_name().c_str(), "team1"); } for (TeamPlayer e : subscribe.roomdescribe().team2()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;AddPlayer(e.player_name().c_str(), "team2"); } for (TeamPlayer e : subscribe.roomdescribe().undistributed()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;AddPlayer(e.player_name().c_str(), "undistributed"); } UChats * chats = NewObject&lt;UChats&gt;(UChats::StaticClass()); chats-&gt;Handler(subscribe.roomdescribe().chat(), "gameroom"); //   USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wMainMenuChatWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;bChatOpen = false; USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Visible); //     USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wToFirstTeamButton-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wToSecondTeamButton-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wToUndistributedTeamButton-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wStartButton-&gt;SetVisibility(ESlateVisibility::Hidden); } else if (subscribe.GetReflection()-&gt;HasField(subscribe, Descriptors::player_sub) &amp;&amp; !subscribe.GetReflection()-&gt;HasField(subscribe, Descriptors::player_team)) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;AddPlayer(subscribe.player().c_str(), "undistributed"); } else if (!subscribe.subscribe()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;RemovePlayer(subscribe.player().c_str(), subscribe.team().c_str()); if (USpikyGameInstance::userLogin == subscribe.player()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); //  USpikyGameInstance::DifferentMix-&gt;ShowMainMenuScreen(); } } } void UGameRoom::UpdateRoom(RoomUpdate update) { for (TeamPlayer e : update.roomdescribe().team1()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;RemoveAddPlayer(e.player_name().c_str(), "team1", update.targetteam().c_str()); } for (TeamPlayer e : update.roomdescribe().team2()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;RemoveAddPlayer(e.player_name().c_str(), "team2", update.targetteam().c_str()); } for (TeamPlayer e : update.roomdescribe().undistributed()) { USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;RemoveAddPlayer(e.player_name().c_str(), "undistributed", update.targetteam().c_str()); } } URoomListUnit* UGameRoom::NewRoom(CreateRoom room) { URoomListUnit* button = NewObject&lt;URoomListUnit&gt;(URoomListUnit::StaticClass()); UHorizontalBox* horBox = NewObject&lt;UHorizontalBox&gt;(UHorizontalBox::StaticClass()); UTextBlock* wRoomName = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wMapName = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wCreator = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wGameTime = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); UTextBlock* wMaxPlayers = NewObject&lt;UTextBlock&gt;(UTextBlock::StaticClass()); wRoomName-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.roomname().c_str())))); wMapName-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.mapname().c_str())))); wCreator-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.creator().c_str())))); wGameTime-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.gametime().c_str())))); wMaxPlayers-&gt;SetText(FText::FromString(TCHAR_TO_UTF8(*FString(room.maxplayers().c_str())))); UHorizontalBoxSlot* roomNameSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wRoomName)); UHorizontalBoxSlot* mapNameSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wMapName)); UHorizontalBoxSlot* creatorSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wCreator)); UHorizontalBoxSlot* gameTimeSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wGameTime)); UHorizontalBoxSlot* maxPlayersSlot = Cast&lt;UHorizontalBoxSlot&gt;(horBox-&gt;AddChild(wMaxPlayers)); roomNameSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); roomNameSlot-&gt;SetHorizontalAlignment(HAlign_Center); mapNameSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); mapNameSlot-&gt;SetHorizontalAlignment(HAlign_Center); creatorSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); creatorSlot-&gt;SetHorizontalAlignment(HAlign_Center); gameTimeSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); gameTimeSlot-&gt;SetHorizontalAlignment(HAlign_Center); maxPlayersSlot-&gt;SetSize(FSlateChildSize(ESlateSizeRule::Fill)); maxPlayersSlot-&gt;SetHorizontalAlignment(HAlign_Center); UButtonSlot* buttonSlot = Cast&lt;UButtonSlot&gt;(button-&gt;AddChild(horBox)); buttonSlot-&gt;SetHorizontalAlignment(HAlign_Fill); buttonSlot-&gt;SetVerticalAlignment(VAlign_Fill); return button; } void UGameRoom::DeleteRoom(RoomsListUpdate update) { //     for (size_t i = 0; i &lt; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildrenCount(); i++) { URoomListUnit* listUnit = Cast&lt;URoomListUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildAt(i)); UHorizontalBox* horBox = Cast&lt;UHorizontalBox&gt;(listUnit-&gt;GetChildAt(0)); UTextBlock* wCreatorName = Cast&lt;UTextBlock&gt;(horBox-&gt;GetChildAt(2)); if (wCreatorName-&gt;GetText().ToString() == update.roomowner().c_str()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;RemoveChildAt(i); } } //           if (roomCreator == update.roomowner().c_str()) { //       USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); UGameRoomUserUnit::select_players.clear(); roomCreator = ""; roomName = ""; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Visible); USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } } void UGameRoom::DeleteRoom(std::string name) { //     for (size_t i = 0; i &lt; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildrenCount(); i++) { URoomListUnit* listUnit = Cast&lt;URoomListUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;GetChildAt(i)); UHorizontalBox* horBox = Cast&lt;UHorizontalBox&gt;(listUnit-&gt;GetChildAt(0)); UTextBlock* wCreatorName = Cast&lt;UTextBlock&gt;(horBox-&gt;GetChildAt(2)); if (wCreatorName-&gt;GetText().ToString() == name.c_str()) { USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;wRoomsScrollBox-&gt;RemoveChildAt(i); } } //       if (roomCreator == name) { //         for (size_t j = 0; j &lt; USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;GetChildrenCount(); j++) { UGameRoomUserUnit * entity = Cast&lt;UGameRoomUserUnit&gt;(USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;GetChildAt(j)); FString playerName = Cast&lt;UTextBlock&gt;(entity-&gt;GetChildAt(0))-&gt;GetText().ToString(); //           if (playerName == USpikyGameInstance::userLogin.c_str() &amp;&amp; playerName != roomCreator.c_str()) { //       USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wFirstTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wSecondTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wUndistributedTeamScrollBox-&gt;ClearChildren(); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;wChatScrollBox-&gt;ClearChildren(); UGameRoomUserUnit::select_players.clear(); roomCreator = ""; roomName = ""; USpikyGameInstance::DifferentMix-&gt;wMainMenuWidgets-&gt;SetVisibility(ESlateVisibility::Visible); USpikyGameInstance::DifferentMix-&gt;wCreateRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); USpikyGameInstance::DifferentMix-&gt;wGameRoomWidgets-&gt;SetVisibility(ESlateVisibility::Hidden); } } } } void UGameRoom::StartGame() { }</span></span></code> </pre><br></div></div><br> !        windows x64,       .     ,  Play: <br><br><img src="https://habrastorage.org/web/e2f/262/79e/e2f26279e483448eb793ab6c8c8aaf96.PNG"><br><br>     ,        <br> /WindowsNoEditor/Spiky_Client/Saved/Config/WindowsNoEditor ‚Äî GameUserSettings.ini   : <br><br><div class="spoiler"> <b class="spoiler_title">GameUserSettings.ini</b> <div class="spoiler_text"><pre> <code class="xml hljs">[/Script/Engine.GameUserSettings] bUseVSync=False ResolutionSizeX=683 ResolutionSizeY=384 LastUserConfirmedResolutionSizeX=1280 LastUserConfirmedResolutionSizeY=1024 WindowPosX=-1 WindowPosY=-1 bUseDesktopResolutionForFullscreen=False FullscreenMode=2 LastConfirmedFullscreenMode=2 Version=5</code> </pre><br></div></div><br>     ,   ,    ,      , ,    ,        . <br><br>      .        ,               ,     . <br><br>   Pawns      MechActor: <br><br><div class="spoiler"> <b class="spoiler_title">MechActor</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "GameFramework/Actor.h" #include "MechActor.generated.h" UCLASS() class SPIKY_CLIENT_API AMechActor : public AActor { GENERATED_BODY() public: AMechActor(const FObjectInitializer&amp; ObjectInitializer); UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = MeshComponent) UStaticMeshComponent* MeshComponent; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MechActor.h" #include "Runtime/Engine/Classes/GameFramework/RotatingMovementComponent.h" #include "Runtime/Engine/Classes/Components/StaticMeshComponent.h" AMechActor::AMechActor(const FObjectInitializer&amp; ObjectInitializer) : Super(ObjectInitializer) { MeshComponent = ObjectInitializer.CreateDefaultSubobject&lt;UStaticMeshComponent&gt;(this, TEXT("Mesh")); MeshComponent-&gt;SetMobility(EComponentMobility::Movable); RootComponent = MeshComponent; URotatingMovementComponent* RotatingMovement = ObjectInitializer.CreateDefaultSubobject&lt;URotatingMovementComponent&gt;(this, TEXT("RotatingMovement")); RotatingMovement-&gt;RotationRate = FRotator(0, 80, 0); // speed RotatingMovement-&gt;PivotTranslation = FVector(0, 0, 0); // point RotatingMovement-&gt;SetUpdatedComponent(GetRootComponent()); }</span></span></code> </pre><br></div></div><br><pre> <code class="cpp hljs">URotatingMovementComponent* RotatingMovement = ObjectInitializer.CreateDefaultSubobject&lt;URotatingMovementComponent&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,TEXT(<span class="hljs-string"><span class="hljs-string">"RotatingMovement"</span></span>)); RotatingMovement-&gt;RotationRate = FRotator(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// speed RotatingMovement-&gt;PivotTranslation = FVector(0, 0, 0); // point RotatingMovement-&gt;SetUpdatedComponent(GetRootComponent());</span></span></code> </pre><br>          MeshComponent  RootComponent      . Unreal Engine      ,       ‚Äì UrotatingMovementComponent,               . <br><br>     BP         MeshComponent. <br> Blueprints/Pawns  MechActor_BP.    scale x,y = 10,    DirectionalLight.  CameraActor,      Auto Player Activation   Player 0.       .        . <br><br><img src="https://habrastorage.org/web/ae2/766/32f/ae276632fa1749e4b6ad135e01772043.jpg"><br><br><h2>      </h2><br>     ,    ,   ,           . <br><br>              .       20   . <br><br>   ,         , -  ,            ,               . <br><br>      ,   .       ,   ,    ,     .        ,            . <br><br>      start game   .         : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameRoomWidgets::StartButtonClicked() { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Room&gt; room(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Room); room-&gt;set_startgame(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); room-&gt;set_roomname(UGameRoom::roomName); UMessageEncoder::Send(room.get(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>    RoomManager      : <br><br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(room.hasField(startGame_room)) { startGame(ctx, room.getRoomName()); } ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, String roomName)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre><br>            ,       PlayerState: <br><br><div class="spoiler"> <b class="spoiler_title">PlayerState</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.NavigableMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TreeMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String team; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> NavigableMap&lt;Long,Position&gt; positionByTime = Collections.synchronizedNavigableMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastUpdateTime; PlayerState() { startCleaner(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Position</span></span></span><span class="hljs-class"> </span></span>{ Location location; Rotation rotation; Position(Location location, Rotation rotation) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.location = location; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rotation = rotation; } } <span class="hljs-comment"><span class="hljs-comment">/*      ! */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startCleaner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lifetime = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(positionByTime.size() &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; lastUpdateTime = positionByTime.lastEntry().getKey(); Thread.sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    5   ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(positionByTime.lastEntry().getKey() == lastUpdateTime) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ms = System.currentTimeMillis(); lastUpdateTime = ms; Position old_pos = positionByTime.lastEntry().getValue(); positionByTime.clear(); positionByTime.put(ms, old_pos); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { positionByTime.entrySet().removeIf(e -&gt; System.currentTimeMillis() - e.getKey() &gt; lifetime); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } } }).start(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, y, z; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Location</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.z = z; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getZ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> z; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setZ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.z = z; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rotation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pitch, roll, yaw; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rotation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pitch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> roll, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yaw)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pitch = pitch; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.roll = roll; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yaw = yaw; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPitch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pitch; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPitch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pitch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pitch = pitch; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> roll; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRoll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> roll)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.roll = roll; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getYaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> yaw; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setYaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yaw)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yaw = yaw; } } Map.<span class="hljs-function"><span class="hljs-function">Entry&lt;Long, Position&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> positionByTime.lastEntry(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time, Position position)</span></span></span><span class="hljs-function"> </span></span>{ positionByTime.put(time, position); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map.<span class="hljs-function"><span class="hljs-function">Entry&lt;Long, Position&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClosestMs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ms)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// todo  ,    2  return positionByTime.lowerEntry(ms); } public String getTeam() { return team; } public void setTeam(String team) { this.team = team; } }</span></span></code> </pre><br></div></div><br>           ,      .     Position, Location  Rotation. Position     : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String team; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> NavigableMap&lt;Long,Position&gt; positionByTime = Collections.synchronizedNavigableMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastUpdateTime;</code> </pre><br>   NavigableMap      , NavigableMap        (lowerEntry()), lastUpdateTime ‚Äì     ,       ,        ,    ,       ,       ,   ,     ‚Äî ,           .              .  GameRoom  playersState,      : <br><br><pre> <code class="java hljs">Map&lt;String,PlayerState&gt; playersState = Collections.synchronizedMap(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;());</code> </pre><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, String roomName)</span></span></span><span class="hljs-function">                                     ,    ‚Äì    </span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title">private void startGame(ChannelHandlerContext ctx, String roomName)</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, String roomName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(String owner : gameRooms.keySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRooms.get(owner).getRoomName(), roomName)) { GameRoom gameRoom = gameRooms.get(owner); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.equals(gameRoom.getCreator(), ctx.channel().attr(CHANNEL_OWNER).get())) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.getGameState()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     ,       */</span></span> gameRoom.setGameState(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); GameRoomModels.RoomsListUpdate roomsListUpdate = GameRoomModels.RoomsListUpdate.newBuilder().setRoomOwner(gameRoom.getCreator()).build(); GameRoomModels.Room room = GameRoomModels.Room.newBuilder().setStartGame(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).setRoomsListUpdate(roomsListUpdate).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setRoom(ByteString.copyFrom(room.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> roomListUpdateSubscribers.writeAndFlush(wrapper); <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String p : gameRoom.undistributed.keySet()) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Objects.equals(gameRoom.getCreator(), p)) { gameRoom.players.remove(p); gameRoom.recipients.remove(gameRoom.undistributed.get(p)); } } gameRoom.undistributed.clear(); <span class="hljs-comment"><span class="hljs-comment">/*        , ,    */</span></span> GameModels.GameInitialState initialState = GameModels.GameInitialState.newBuilder().setStartGame(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build(); Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : gameRoom.players.keySet()) { String team = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team1.containsKey(name)) { team = <span class="hljs-string"><span class="hljs-string">"team1"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameRoom.team2.containsKey(name)) { team = <span class="hljs-string"><span class="hljs-string">"team2"</span></span>; } PlayerState playerState = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlayerState(); playerState.setTeam(team); GameModels.Player playerProto = GameModels.Player.newBuilder().build(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> randomX = rand.nextInt((<span class="hljs-number"><span class="hljs-number">2000</span></span> - (-<span class="hljs-number"><span class="hljs-number">2000</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + (-<span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> randomY = rand.nextInt((<span class="hljs-number"><span class="hljs-number">2000</span></span> - (-<span class="hljs-number"><span class="hljs-number">2000</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + (-<span class="hljs-number"><span class="hljs-number">2000</span></span>); PlayerState.Location l = playerState.new Location(randomX, randomY, <span class="hljs-number"><span class="hljs-number">0</span></span>); PlayerState.Rotation r = playerState.new Rotation(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); playerState.addPosition(System.currentTimeMillis(), playerState.new Position(l, r)); gameRoom.playersState.put(name, playerState); GameModels.PlayerPosition.Location loc = GameModels.PlayerPosition.Location.newBuilder() .setX(playerState.getLastPosition().getValue().location.getX()) .setY(playerState.getLastPosition().getValue().location.getY()) .setZ(playerState.getLastPosition().getValue().location.getZ()) .build(); GameModels.PlayerPosition.Rotation rot = GameModels.PlayerPosition.Rotation.newBuilder() .setPitch(playerState.getLastPosition().getValue().rotation.getPitch()) .setYaw(playerState.getLastPosition().getValue().rotation.getYaw()) .setRoll(playerState.getLastPosition().getValue().rotation.getRoll()) .build(); GameModels.PlayerPosition playerPosition = GameModels.PlayerPosition.newBuilder().setLoc(loc).setRot(rot).build(); <span class="hljs-comment"><span class="hljs-comment">/*  ,  ,  (  ) */</span></span> playerProto = playerProto.toBuilder().setPlayerName(name).setTeam(playerState.getTeam()).setPlayerPosition(playerPosition).build(); initialState = initialState.toBuilder().addPlayer(playerProto).build(); } GameModels.GameData gameData = GameModels.GameData.newBuilder().setGameInitialState(initialState).build(); MessageModels.CryptogramWrapper cw2 = MessageModels.CryptogramWrapper.newBuilder().setGameModels(ByteString.copyFrom(gameData.toByteArray())).build(); MessageModels.Wrapper wrapper2 = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw2).build(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Channel c : gameRoom.players.values()) c.writeAndFlush(wrapper2); } } } }</code> </pre><br></div></div><br>  ,  Character  <code>ATPSCharacter : public ACharacter</code> .  ,     : <br><br><div class="spoiler"> <b class="spoiler_title">ATPSCharacter</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "GameFramework/Character.h" #include "TPSCharacter.generated.h" UCLASS() class SPIKY_CLIENT_API ATPSCharacter : public ACharacter { GENERATED_BODY() public: ATPSCharacter(); protected: virtual void BeginPlay() override; public: virtual void Tick(float DeltaTime) override; virtual void SetupPlayerInputComponent(class UInputComponent* PlayerInputComponent) override; UFUNCTION() void MoveForward(float Val); UFUNCTION() void MoveRight(float Val); void Fire(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "TPSCharacter.h" #include "GameFramework/CharacterMovementComponent.h" #include "Runtime/Engine/Classes/Components/InputComponent.h" #include "Runtime/Engine/Classes/GameFramework/Controller.h" #include "Runtime/Engine/Classes/GameFramework/PlayerController.h" #include "Runtime/Engine/Classes/Kismet/KismetSystemLibrary.h" #include "Protobufs/GameModels.pb.h" #include "MessageEncoder.h" ATPSCharacter::ATPSCharacter() { PrimaryActorTick.bCanEverTick = true; } void ATPSCharacter::BeginPlay() { Super::BeginPlay(); } void ATPSCharacter::Tick(float DeltaTime) { Super::Tick(DeltaTime); } void ATPSCharacter::SetupPlayerInputComponent(UInputComponent* PlayerInputComponent) { Super::SetupPlayerInputComponent(PlayerInputComponent); PlayerInputComponent-&gt;BindAxis("MoveForward", this, &amp;ATPSCharacter::MoveForward); PlayerInputComponent-&gt;BindAxis("MoveRight", this, &amp;ATPSCharacter::MoveRight); PlayerInputComponent-&gt;BindAxis("Turn", this, &amp;ATPSCharacter::AddControllerYawInput); PlayerInputComponent-&gt;BindAxis("LookUp", this, &amp;ATPSCharacter::AddControllerPitchInput); PlayerInputComponent-&gt;BindAction("Fire", IE_Pressed, this, &amp;ATPSCharacter::Fire); } void ATPSCharacter::MoveForward(float Value) { if ((Controller != NULL) &amp;&amp; (Value != 0.0f)) { // find out which way is forward FRotator Rotation = Controller-&gt;GetControlRotation(); // Limit pitch when walking or falling if (GetCharacterMovement()-&gt;IsMovingOnGround() || GetCharacterMovement()-&gt;IsFalling()) { Rotation.Pitch = 0.0f; } // add movement in that direction const FVector Direction = FRotationMatrix(Rotation).GetScaledAxis(EAxis::X); AddMovementInput(Direction, Value); } } void ATPSCharacter::MoveRight(float Value) { if ((Controller != NULL) &amp;&amp; (Value != 0.0f)) { // find out which way is right const FRotator Rotation = Controller-&gt;GetControlRotation(); const FVector Direction = FRotationMatrix(Rotation).GetScaledAxis(EAxis::Y); // add movement in that direction AddMovementInput(Direction, Value); } } void ATPSCharacter::Fire() { GLog-&gt;Log("FIRE"); APlayerController* controller = Cast&lt;APlayerController&gt;(GetController()); FVector start = controller-&gt;PlayerCameraManager-&gt;GetCameraLocation(); FVector end = start + controller-&gt;PlayerCameraManager-&gt;GetActorForwardVector() * 512; FCollisionQueryParams TraceParams(FName(TEXT("Trace"))); TraceParams.bTraceComplex = true; FHitResult HitData(ForceInit); //Trace! GetWorld()-&gt;LineTraceSingleByChannel(HitData, start, end, ECC_Pawn, TraceParams); FVector startZ = FVector(start.X, start.Y, start.Z - 10); FVector endZ = FVector(end.X, end.Y, end.Z + 10); UKismetSystemLibrary::DrawDebugLine(this, startZ, endZ, FColor(255, 0, 0), 3.f, 1.f); std::shared_ptr&lt;Shot&gt; shot(new Shot); std::shared_ptr&lt;Shot::Start&gt; shotStart(new Shot::Start); std::shared_ptr&lt;Shot::End&gt; shotEnd(new Shot::End); shotStart-&gt;set_x(start.X); shotStart-&gt;set_y(start.Y); shotStart-&gt;set_z(start.Z); shotEnd-&gt;set_x(end.X); shotEnd-&gt;set_y(end.Y); shotEnd-&gt;set_z(end.Z); shot-&gt;set_allocated_start(shotStart.get()); shot-&gt;set_allocated_end(shotEnd.get()); if (IsValid(HitData.GetActor())) if (HitData.GetActor()-&gt;Tags.Num() &gt; 0) shot-&gt;set_requestto(TCHAR_TO_UTF8(*HitData.GetActor()-&gt;Tags.Top().ToString())); shot-&gt;set_timestamp(USpikyGameInstance::DifferentMix-&gt;GetMS()); std::shared_ptr&lt;GameData&gt; gameData(new GameData); gameData-&gt;set_allocated_shot(shot.get()); //    ,    ,      UMessageEncoder::Send(gameData.get(), true, true); gameData-&gt;release_shot(); shot-&gt;release_end(); shot-&gt;release_start(); }</span></span></code> </pre><br></div></div><br> <code>ATPSCharacter::Fire()</code> ‚Äî   ,   ,    <code>UKismetSystemLibrary::DrawDebugLine</code>       <code>LineTraceSingleByChannel</code> .            ,  ,     . <br><br>        Unreal.  DifferentMix: <br><br><pre> <code class="cpp hljs">... <span class="hljs-function"><span class="hljs-function">int64 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... int64 UDifferentMix::GetMS() { FDateTime now = FDateTime::UtcNow(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> now.ToUnixTimestamp() * <span class="hljs-number"><span class="hljs-number">1000</span></span> + now.GetMillisecond(); }</code> </pre><br>        GameProcess      : <br><br><div class="spoiler"> <b class="spoiler_title">GameProcess</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/CoreUObject/Public/UObject/Object.h" #include &lt;vector&gt; #include "GameProcess.generated.h" class GameData; class PlayerPosition; UCLASS() class SPIKY_CLIENT_API UGameProcess : public UObject { GENERATED_BODY() public: void Handler(GameData gData); static GameData gameData; void UpdatePositions(PlayerPosition playerPosition); static std::vector&lt;int64&gt; pings; void ComputePing(GameData gData); void ComputeShot(GameData gData); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "GameProcess.h" #include "Protobufs/GameModels.pb.h" GameData UGameProcess::gameData; std::vector&lt;int64&gt; UGameProcess::pings; void UGameProcess::Handler(GameData gData) { } void UGameProcess::ComputeShot(GameData gData) { } void UGameProcess::UpdatePositions(PlayerPosition playerPosition) { } void UGameProcess::ComputePing(GameData gData) { }</span></span></code> </pre><br></div></div><br>   ,   GameMode,  MapGameMode: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AMapGameMode::BeginPlay()            . AActor* AMapGameMode::ChoosePlayerStart_Implementation(AController* Player)   <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AMapGameMode::SendLocation()   ,         <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AMapGameMode::SendPing()  Ping <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AMapGameMode::ComputeFrameRate()  FPS</code> </pre><br>     ,   .   Blueprints/Pawns <br> TPSCharacter_BP.   TPSCharacter  GenericMale.     ProjectSettings-&gt;Input: <br><br><img src="https://habrastorage.org/web/12b/730/944/12b73094497e4af4ab2fcf37bb81d0b8.PNG"><br><br>    TPSCharacter_BP   Use Pawn Control Rotation,      : <br><br><img src="https://habrastorage.org/web/7be/6c2/3b4/7be6c23b4da24ee58f3bbecc37cf3d29.PNG"><br><br><img src="https://habrastorage.org/web/2f9/ebe/1f3/2f9ebe1f394b4e8898024f0d4046f28f.PNG"><br><br>   GameMode    : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ConstructorHelpers::FClassFinder&lt;ATPSCharacter&gt; PlayerPawnObject(TEXT(<span class="hljs-string"><span class="hljs-string">"Blueprint'/Game/Blueprints/Pawns/TPSCharacter_BP.TPSCharacter_BP_C'"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PlayerPawnObject.Class != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { pawnObject = PlayerPawnObject.Class-&gt;GetDefaultObject&lt;ATPSCharacter&gt;(); }</code> </pre><br><div class="spoiler"> <b class="spoiler_title">MapGameMode</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "GameFramework/GameModeBase.h" #include "MapGameMode.generated.h" class ATPSCharacter; UCLASS() class SPIKY_CLIENT_API AMapGameMode : public AGameModeBase { GENERATED_BODY() AMapGameMode(const FObjectInitializer&amp; ObjectInitializer); virtual void BeginPlay() override; virtual void EndPlay(const EEndPlayReason::Type EndPlayReason) override; virtual void Tick(float DeltaTime) override; ATPSCharacter* pawnObject; virtual AActor* ChoosePlayerStart_Implementation(AController* Player) override; FTimerHandle UpdateLocationTimerHandle; void SendLocation(); FVector old_position, position; FRotator old_rotation, rotation; FTimerHandle PingTimerHandle; void SendPing(); FTimerHandle FPSTimerHandle; void ComputeFrameRate(); int32 fps = 0; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MapGameMode.h" #include "SpikyGameInstance.h" #include "Runtime/Engine/Classes/Engine/World.h" #include "TPSCharacter.h" #include "Protobufs/GameModels.pb.h" #include "GameProcess.h" #include "DifferentMix.h" #include "MessageEncoder.h" AMapGameMode::AMapGameMode(const FObjectInitializer&amp; ObjectInitializer) : Super(ObjectInitializer) { PrimaryActorTick.bCanEverTick = true; } void AMapGameMode::BeginPlay() { Super::BeginPlay(); GLog-&gt;Log("AMapGameMode::BeginPlay()"); USpikyGameInstance* gameInstance = Cast&lt;USpikyGameInstance&gt;(GetWorld()-&gt;GetGameInstance()); gameInstance-&gt;DifferentMixInit(GetWorld()); //       for (::Player p : UGameProcess::gameData.gameinitialstate().player()) { if (p.player_name() != USpikyGameInstance::userLogin) { FVector pos = FVector(p.playerposition().loc().x(), p.playerposition().loc().y(), p.playerposition().loc().z()); auto character = GetWorld()-&gt;SpawnActor&lt;ATPSCharacter&gt;(pawnObject-&gt;GetClass(), FTransform(pos)); character-&gt;Tags.Add(p.player_name().c_str()); } } } void AMapGameMode::EndPlay(const EEndPlayReason::Type EndPlayReason) { Super::EndPlay(EndPlayReason); } void AMapGameMode::Tick(float DeltaTime) { Super::Tick(DeltaTime); } AActor* AMapGameMode::ChoosePlayerStart_Implementation(AController* Player) { FVector pos; for (::Player p : UGameProcess::gameData.gameinitialstate().player()) { if (p.player_name() == USpikyGameInstance::userLogin) { pos = FVector(p.playerposition().loc().x(), p.playerposition().loc().y(), p.playerposition().loc().z()); } } ATPSCharacter* playerCharacter = GetWorld()-&gt;SpawnActor&lt;ATPSCharacter&gt;(pawnObject-&gt;GetClass(), FTransform(pos)); GetWorld()-&gt;GetFirstPlayerController()-&gt;Possess(playerCharacter); playerCharacter-&gt;Tags.Add(USpikyGameInstance::userLogin.c_str()); return playerCharacter; } void AMapGameMode::SendLocation() { ATPSCharacter* character = Cast&lt;ATPSCharacter&gt;(GetWorld()-&gt;GetFirstPlayerController()-&gt;GetCharacter()); position = character-&gt;GetActorLocation(); rotation = character-&gt;GetActorRotation(); //       if (position.Equals(old_position) &amp;&amp; rotation.Equals(old_rotation)) return; old_position = position; old_rotation = rotation; std::shared_ptr&lt;PlayerPosition&gt; playerPosition(new PlayerPosition); std::shared_ptr&lt;PlayerPosition::Location&gt; playerLocation(new PlayerPosition::Location); std::shared_ptr&lt;PlayerPosition::Rotation&gt; playerRotation(new PlayerPosition::Rotation); playerLocation-&gt;set_x(position.X); playerLocation-&gt;set_y(position.Y); playerLocation-&gt;set_z(position.Z); playerRotation-&gt;set_pitch(rotation.Pitch); playerRotation-&gt;set_roll(rotation.Roll); playerRotation-&gt;set_yaw(rotation.Yaw); playerPosition-&gt;set_allocated_loc(playerLocation.get()); playerPosition-&gt;set_allocated_rot(playerRotation.get()); playerPosition-&gt;set_timestamp(USpikyGameInstance::DifferentMix-&gt;GetMS()); std::shared_ptr&lt;GameData&gt; gameData(new GameData); gameData-&gt;set_allocated_playerposition(playerPosition.get()); UMessageEncoder::Send(gameData.get(), true, true); gameData-&gt;release_playerposition(); playerPosition-&gt;release_rot(); playerPosition-&gt;release_loc(); } void AMapGameMode::SendPing() { } void AMapGameMode::ComputeFrameRate() { }</span></span></code> </pre><br></div></div><br>        Map1 (    Github). <br><br>  UGameProcess::Handler: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameProcess::Handler(GameData gData) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gData.has_gameinitialstate()) { gameData = gData; UGameplayStatics::OpenLevel(USpikyGameInstance::DifferentMix-&gt;GetWorld(), <span class="hljs-string"><span class="hljs-string">"Map1"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"game= Spiky_Client.MapGameMode"</span></span>); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If a signal is received, we open Map1 with the installed MapGameMode, which performs logic on placement by starting positions, initializing the interface and sending movement data to the server. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think we will need a sight, for this we will add a HUD which will place the texture of the sight in the center. </font><font style="vertical-align: inherit;">Add the SpikyHUD class to the Public / Private root:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spikyhud</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "GameFramework/HUD.h" #include "Runtime/Engine/Classes/Engine/Texture2D.h" #include "SpikyHUD.generated.h" UCLASS() class SPIKY_CLIENT_API ASpikyHUD : public AHUD { GENERATED_BODY() ASpikyHUD(); private: /** Crosshair asset pointer */ UTexture2D* CrosshairTex; virtual void DrawHUD() override; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SpikyHUD.h" #include "Runtime/CoreUObject/Public/UObject/ConstructorHelpers.h" #include "Runtime/Engine/Classes/Engine/Canvas.h" ASpikyHUD::ASpikyHUD() { // Set the crosshair texture static ConstructorHelpers::FObjectFinder&lt;UTexture2D&gt; CrosshairTexObj(TEXT("Texture2D'/Game/ProjectResources/Images/crosshair.crosshair'")); CrosshairTex = CrosshairTexObj.Object; } void ASpikyHUD::DrawHUD() { Super::DrawHUD(); // Draw very simple crosshair // find center of the Canvas const FVector2D Center(Canvas-&gt;ClipX * 0.5f, Canvas-&gt;ClipY * 0.5f); // offset by half the texture's dimensions so that the center of the texture aligns with the center of the Canvas const FVector2D CrosshairDrawPosition((Center.X - (CrosshairTex-&gt;GetSurfaceWidth() * 0.5)), (Center.Y - (CrosshairTex-&gt;GetSurfaceHeight() * 0.5f))); // draw the crosshair FCanvasTileItem TileItem(CrosshairDrawPosition, CrosshairTex-&gt;Resource, FLinearColor::White); TileItem.BlendMode = SE_BLEND_Translucent; Canvas-&gt;DrawItem(TileItem); }</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update SpikyGameMode in the constructor: </font></font><br><br><pre> <code class="cpp hljs">HUDClass = ASpikyHUD::StaticClass();</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will collect and test in order to add another Map1 map to the assembly; we need to point the path to it: </font></font><br><br><img src="https://habrastorage.org/web/9d8/181/27c/9d818127c70840bfaf1496c690cdef33.PNG"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After starting the game, the player sees the placed players more often in the air, their position is not updated, we place them a little higher so that there are no overlaps. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add a sync move and shots. </font><font style="vertical-align: inherit;">In SpikyGameMode, create a timer that sends information about the player‚Äôs location 20 times per second:</font></font><br><br><div class="spoiler"> <b class="spoiler_title">  SpikyGameMode</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//.h FTimerHandle UpdateLocationTimerHandle; void SendLocation(); FVector old_position, position; FRotator old_rotation, rotation; //.cpp void AMapGameMode::BeginPlay() { //   30      /10 .1 /20 .05 / 30 .03 GetWorld()-&gt;GetTimerManager().SetTimer(UpdateLocationTimerHandle, this, &amp;AMapGameMode::SendLocation, .05f, true); } void AMapGameMode::EndPlay(const EEndPlayReason::Type EndPlayReason) { Super::EndPlay(EndPlayReason); GetWorld()-&gt;GetTimerManager().ClearAllTimersForObject(this); } //        -  void AMapGameMode::SendLocation() {...}</span></span></code> </pre><br></div></div><br>  UGameProcess::Handler      : <br><br><pre> <code class="cpp hljs">... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/CoreUObject/Public/UObject/UObjectIterator.h"</span></span></span><span class="hljs-meta"> ... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (gData.has_playerposition()) { UpdatePositions(gData.playerposition()); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (gData.has_shot()) { ComputeShot(gData); } void UGameProcess::ComputeShot(GameData gData)   ,   void UGameProcess::UpdatePositions(PlayerPosition playerPosition)   - ,     ,  </span></span></code> </pre><br>    GameState: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameModels.PlayerPosition playerPosition)</span></span></span><span class="hljs-function">       </span></span></code> </pre><br>     ,  ,    ,     ,    ,  ,   ,       : <br><br><div class="spoiler"> <b class="spoiler_title">GameState</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp.logics; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.protobuf.ByteString; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.group.ChannelMatchers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.CHANNEL_OWNER; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.ROOM_OWNER; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.ServerMain.gameRooms; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.spiky.server.utils.Descriptors.requestTo_shot_gd; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameModels.GameData gameData)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameData.hasPlayerPosition()) { updatePosition(ctx, gameData.getPlayerPosition()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameData.hasShot()) { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> GameRoom gameRoom = gameRooms.get(ctx.channel().attr(ROOM_OWNER).get()); <span class="hljs-comment"><span class="hljs-comment">/*       ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameData.getShot().hasField(requestTo_shot_gd)) { gameData = gameData.toBuilder().setShot(gameData.getShot().toBuilder().clearTimeStamp().build()).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setGameModels(ByteString.copyFrom(gameData.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper, ChannelMatchers.isNot(ctx.channel())); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, GameModels.PlayerPosition playerPosition)</span></span></span><span class="hljs-function"> </span></span>{ GameRoom gameRoom = gameRooms.get(ctx.channel().attr(ROOM_OWNER).get()); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> PlayerState state = gameRoom.playersState.get(ctx.channel().attr(CHANNEL_OWNER).get()); PlayerState.Location l = state.new Location(playerPosition.getLoc().getX(), playerPosition.getLoc().getY(), playerPosition.getLoc().getZ()); PlayerState.Rotation r = state.new Rotation(playerPosition.getRot().getPitch(), playerPosition.getRot().getYaw(), playerPosition.getRot().getRoll()); state.addPosition(playerPosition.getTimeStamp(), state.new Position(l, r)); <span class="hljs-comment"><span class="hljs-comment">//System.out.println(playerPosition.getTimeStamp()); /*   */ playerPosition = playerPosition.toBuilder().setPlayerName(ctx.channel().attr(CHANNEL_OWNER).get()).build(); GameModels.GameData gameData = GameModels.GameData.newBuilder().setPlayerPosition(playerPosition).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setGameModels(ByteString.copyFrom(gameData.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper, ChannelMatchers.isNot(ctx.channel())); } }</span></span></code> </pre><br></div></div><br>  .       ,    ping  fps.       : <br><br><div class="spoiler"> <b class="spoiler_title">PingFpsWidgets</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/UMG/Public/Blueprint/UserWidget.h" #include "PingFpsWidgets.generated.h" class UTextBlock; UCLASS() class SPIKY_CLIENT_API UPingFpsWidgets : public UUserWidget { GENERATED_BODY() virtual void NativeConstruct() override; public: UTextBlock* wFps = nullptr; UTextBlock* wPing = nullptr; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "PingFpsWidgets.h" #include "Runtime/UMG/Public/Components/TextBlock.h" void UPingFpsWidgets::NativeConstruct() { Super::NativeConstruct(); wFps = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("fps"))); wPing = Cast&lt;UTextBlock&gt;(GetWidgetFromName(TEXT("ping"))); }</span></span></code> </pre><br></div></div><br>        DifferentMix: <br><br><div class="spoiler"> <b class="spoiler_title"> PingFpsWidgets  DifferentMix</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//.h class UPingFpsWidgets; UPingFpsWidgets* tmpPingFpsRef; UPingFpsWidgets* wPingFpsWidgets; UCanvasPanelSlot* pingFpsSlot; .cpp #include "PingFpsWidgets.h" ... static ConstructorHelpers::FClassFinder&lt;UPingFpsWidgets&gt; pingFpsWidgets(TEXT("WidgetBlueprint'/Game/Blueprints/Widgets/PingFPS_W.PingFPS_W_C'")); if (pingFpsWidgets.Class != NULL) { tmpPingFpsRef = pingFpsWidgets.Class-&gt;GetDefaultObject&lt;UPingFpsWidgets&gt;(); } ... wPingFpsWidgets = CreateWidget&lt;UPingFpsWidgets&gt;(GetWorld(), tmpPingFpsRef-&gt;GetClass()); pingFpsSlot = Cast&lt;UCanvasPanelSlot&gt;(wWidgetContainer-&gt;wCanvas-&gt;AddChild(wPingFpsWidgets)); pingFpsSlot-&gt;SetZOrder(10); pingFpsSlot-&gt;SetAnchors(FAnchors(0.f, 0.f, 1.f, 1.f)); pingFpsSlot-&gt;SetOffsets(FMargin(0, 0, 0, 0)); wPingFpsWidgets-&gt;SetVisibility(ESlateVisibility::Hidden);</span></span></code> </pre><br></div></div><br>    AMapGameMode::BeginPlay(): <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"PingFpsWidgets.h"</span></span></span><span class="hljs-meta"> ... gameInstance-&gt;DifferentMix-&gt;wPingFpsWidgets-&gt;SetVisibility(ESlateVisibility::Visible); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//          GetWorld()-&gt;GetTimerManager().SetTimer(PingTimerHandle, this, &amp;AMapGameMode::SendPing, .25f, true); //  frame rate (fps) GetWorld()-&gt;GetTimerManager().SetTimer(FPSTimerHandle, this, &amp;AMapGameMode::ComputeFrameRate, 1.f, true);</span></span></span></span></code> </pre><br>     ,             : <br><br><pre> <code class="cpp hljs">... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Runtime/UMG/Public/Components/TextBlock.h"</span></span></span><span class="hljs-meta"> ... void AMapGameMode::Tick(float DeltaTime) { Super::Tick(DeltaTime); fps++; } void AMapGameMode::SendPing() { std::shared_ptr</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Ping&gt; ping(new Ping); ping-&gt;set_time(USpikyGameInstance::DifferentMix-&gt;GetMS()); std::shared_ptr&lt;GameData&gt; gameData(new GameData); gameData-&gt;set_allocated_ping(ping.get()); UMessageEncoder::Send(gameData.get(), true, true); gameData-&gt;release_ping(); } void AMapGameMode::ComputeFrameRate() { USpikyGameInstance::DifferentMix-&gt;wPingFpsWidgets-&gt;wFps-&gt;SetText(FText::FromString(FString::FromInt(fps) + " FPS")); fps = 0; }</span></span></span></span></code> </pre><br>      .  UGameProcess::Handler   : <br><br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gData.has_ping()) { ComputePing(gData); } ...</code> </pre><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameProcess::ComputePing(GameData gData)  <span class="hljs-number"><span class="hljs-number">5</span></span> ,  , </code> </pre><br><div class="spoiler"> <b class="spoiler_title">void UGameProcess::ComputePing(GameData gData)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UGameProcess::ComputePing(GameData gData) { int64 ping = USpikyGameInstance::DifferentMix-&gt;GetMS() - gData.ping().time(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pings.size() &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) { pings.push_back(ping); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { int64 avr_ping = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int64 p : pings) { avr_ping += p; } avr_ping /= <span class="hljs-number"><span class="hljs-number">5</span></span>; pings.clear(); FString str = <span class="hljs-string"><span class="hljs-string">"Ping: "</span></span> + FString::FromInt(avr_ping) + <span class="hljs-string"><span class="hljs-string">" ms"</span></span>; USpikyGameInstance::DifferentMix-&gt;wPingFpsWidgets-&gt;wPing-&gt;SetText(FText::FromString(str)); } }</code> </pre><br></div></div><br>  GameState  : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameData.hasPing()) { MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setGameModels(ByteString.copyFrom(gameData.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); ctx.writeAndFlush(wrapper); }</code> </pre><br>      ! <br><br>      .   :       ,              ,    ‚Äî       .    ,    . <br><br>       java socket'. <br><br>   Unreal  VerificationServer.         ,    MessageDecoder-MessageEncoder, protobuf     .    tcp     VerificationServerConnection,        : <br><br><div class="spoiler"> <b class="spoiler_title">VerificationServerConnection</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.GameModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.tcp.logics.GameState; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.ServerSocket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.Socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerificationServerConnection</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OutputStream socketWriter; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VerificationServerConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> verificationServerPort)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ServerSocket serverSocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServerSocket(verificationServerPort); Socket activeSocket = serverSocket.accept(); InputStream socketReader = activeSocket.getInputStream(); socketWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataOutputStream(activeSocket.getOutputStream()); <span class="hljs-comment"><span class="hljs-comment">//  new Thread(() -&gt; { try { while (true) { byte[] messageByte = new byte[1024]; socketReader.read(messageByte); ByteArrayInputStream input = new ByteArrayInputStream(messageByte); GameModels.GameData gameData = GameModels.GameData.parseDelimitedFrom(input); new GameState(gameData); } } catch (IOException e) { e.printStackTrace(); } }).start(); } catch (IOException e) { e.printStackTrace(); } } public void SendToVerificationServer(GameModels.GameData gameData) { try { ByteArrayOutputStream output = new ByteArrayOutputStream(1024); gameData.writeDelimitedTo(output); byte sendData[] = output.toByteArray(); socketWriter.write(sendData); } catch (IOException e) { e.printStackTrace(); } } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a new constructor to GameState: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GameModels.GameData gameData)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gameData.hasShot()) { System.out.println(gameData); GameRoom gameRoom = gameRooms.get(gameData.getShot().getRoomOwner()); gameData = gameData.toBuilder().setShot(gameData.getShot().toBuilder() .clearTimeStamp() .clearPlayerPosition() .clearRoomOwner().build() ).build(); MessageModels.CryptogramWrapper cw = MessageModels.CryptogramWrapper.newBuilder().setGameModels(ByteString.copyFrom(gameData.toByteArray())).build(); MessageModels.Wrapper wrapper = MessageModels.Wrapper.newBuilder().setCryptogramWrapper(cw).build(); gameRoom.recipients.writeAndFlush(wrapper); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This data comes after checking on the verification server. </font><font style="vertical-align: inherit;">Add the port of the verification server to the configuration file:</font></font><br><br><pre> <code class="java hljs">verificationServerPort = <span class="hljs-number"><span class="hljs-number">7682</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And read it in ServerMain: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> verificationServerPort = Integer.valueOf(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"verificationServerPort"</span></span>));</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Run the server connection: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> VerificationServerConnection verificationServerConnection; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(ServerMain::run_tcp).start(); <span class="hljs-comment"><span class="hljs-comment">//new Thread(ServerMain::run_udp).start(); captchaCleaner(); verificationServerConnection = new VerificationServerConnection(verificationServerPort); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update the condition in GameState, if a tag has arrived (each player has a tag with a name, if without a tag, then you just need to show everyone the shot), the player thinks he‚Äôs hit, we send it to the test: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> Map.Entry&lt;Long, PlayerState.Position&gt; pos = state.getClosestMs(gameData.getShot().getTimeStamp()); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ServerMain.verificationServerConnection.SendToVerificationServer(gd);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On the server, right in the decoder, we check: </font></font><br><br><pre> <code class="java hljs">UMessageDecoder::SendProtoToDecoder(GameData* gameData)         -         ,      ,        </code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we can update the status of the player at all. </font><font style="vertical-align: inherit;">I did not do this, but only returned the result of the check. </font><font style="vertical-align: inherit;">This is how the hit verification process on the test server looks like:</font></font><br><br><img src="https://habrastorage.org/web/7e0/957/a37/7e0957a37b7d4b96b1262270c70fcf79.jpg"><br><br>  That's all.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hope the material was helpful. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interesting articles on the topic and literature </font></font></h3><br>     : <br> <a href="https://habrahabr.ru/post/309384/">     MechWarrior Online</a> <br><br>      DOOM III: <br> <a href="http://mrelusive.com/publications/papers/The-DOOM-III-Network-Architecture.pdf">The DOOM III Network Architecture</a> <br><br>   Valve: <br> <a href="https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking:ru">Source Multiplayer Networking</a> <br><br><img src="https://habrastorage.org/web/285/a3b/d0b/285a3bd0b3dc4a2d8bf6c571589103b2.jpg"></div><p>Source: <a href="https://habr.com/ru/post/334786/">https://habr.com/ru/post/334786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334774/index.html">Simple initial authorization using iptables</a></li>
<li><a href="../334776/index.html">Laravel - an ecosystem, not just a PHP framework</a></li>
<li><a href="../334778/index.html">Basics of computer networks. Subject number 8. Link Aggregation Protocol: Etherchannel</a></li>
<li><a href="../334780/index.html">Register for the webinar "How to safely and profitably protect the company from unknown threats and cryptographers"</a></li>
<li><a href="../334782/index.html">As another large courier company, the personal data of its customers handed out</a></li>
<li><a href="../334788/index.html">Offshore and foreign trade transactions: advantages and pitfalls</a></li>
<li><a href="../334790/index.html">As I made the fastest resize of images. Part 3, fixed-point numbers</a></li>
<li><a href="../334792/index.html">Microsoft did not isolate Windows Defender in the sandbox, so I did</a></li>
<li><a href="../334794/index.html">Bluetooth mesh - network architecture and security</a></li>
<li><a href="../334796/index.html">How Android works, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>