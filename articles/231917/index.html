<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Secure Deployment of ElasticSearch Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the successful transition from MongoDB full-text search to ElasticSearch, we managed to launch several new services running on Elastic, an exten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Secure Deployment of ElasticSearch Server</h1><div class="post__text post__text-html js-mediator-article">  After the successful <a href="http://habrahabr.ru/company/likeastore/blog/223109/">transition</a> from MongoDB full-text search to ElasticSearch, we managed to launch several new services running on Elastic, an <a href="http://habrahabr.ru/company/likeastore/blog/222515/">extension</a> for the browser and, in general, I was extremely pleased with the migration. <br><br>  But in a barrel of honey, there was one fly in the ointment - about a month after the configuration and successful work, LogEntries / NewRelic unanimously shouted that the search server was not responding.  After login to Digital Ocean's low-board, I saw a letter from the support that the server was suspended due to large outgoing UDP traffic, which most likely indicated that the server was compromised. <br><a name="habracut"></a><br>  <a href="https://www.digitalocean.com/%3Frefcode%3Dde56d081b272">DigitalOcean</a> provided a link to <a href="https://www.digitalocean.com/community/questions/my-droplet-has-been-compromised-and-is-sending-an-outgoing-flood-or-ddos-what-do-i-do">instructions</a> on what to do in this case.  But the most interesting thing was in the comments, almost everyone who suffered from attacks in recent times had a deployed ElasticSeach cluster with an open 9200 port.  The attackers took advantage of Java and ES vulnerabilities, got access to the server and turned it into an integral part of some bot-network. <br><br>  I had to restore the server from scratch, but this time I will not be so naive, the server will be reliably protected.  I will describe my setup using Node.js, <a href="https://github.com/progrium/dokku">Dokku</a> / <a href="https://www.docker.com/">Docker</a> , SSL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Why is that? </h4><br>  Despite the power of ElasticSearch, it does not provide any internal means of protection and authorization, you need to do everything yourself.  <a href="https://www.found.no/foundation/elasticsearch-security/">There</a> is a good article on this topic. <br><br>  Malefactors (most likely) use the vulnerability of dynamic elastic scripts, so if they are not used (as in my case) they are recommended to be disabled. <br><br>  And finally, open port 9200 is like a bait, it needs to be closed. <br><br><h4>  What will be the plan? </h4><br>  My plan was to raise the ‚Äúclean‚Äù Digital Ocean droplet, deploy the Elastic Search inside the Docker container (even if the instance is compromised, all you need to do is restart the container), close 9200/9300 to access it from the outside and send all traffic to the elastic through the Node.js proxy server, with a simple authorization model, through the ‚Äúshared secret‚Äù. <br><br><h4>  Raise a new droplet </h4><br>  <a href="https://www.digitalocean.com/%3Frefcode%3Dde56d081b272">DigitalOcean</a> provides a pre-prepared image with Dokku / Docker on board on Ubuntu 14, so it makes sense to select it immediately.  As usual, lifting a new car takes a couple of tens of seconds and we are ready to go. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/796/67d/64e/79667d64e77b5f20c46ac212b5602103.png" alt="image"><br><br><h4>  Deploy ElasticSearch in a container </h4><br>  The first thing we need is a Docker image with ElasticSearch.  Despite the fact that there are several plug-ins for Dokku, I decided to go through self-installation, so it seemed to me to be easier with the configuration. <br><br>  The image for Elastic is already ready and there are good <a href="https://registry.hub.docker.com/u/dockerfile/elasticsearch/">instructions</a> for its use. <br><br><pre><code class="bash hljs">$ docker pull docker pull dockerfile/elasticsearch</code> </pre> <br>  Once the image is loaded, we need to prepare a volume that will be external to the running container (even if the container stops and is restarted, the data will be stored on the host file system). <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> / $ mkdir elastic</code> </pre><br>  In this folder, we will create a configuration file, elasticsearch.yml.  In my case, it is very simple, I have a cluster from one machine, so all the default settings satisfy me.  But, as mentioned above, it is necessary to disable dynamic scripts. <br><br><pre> <code class="bash hljs">$ nano elasticsearch.yml</code> </pre><br>  Which will consist of only one line, <br><br><pre> <code class="bash hljs">script.disable_dynamic: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br>  After that, you can start the server.  I created a simple script, for configuration and debug time, you may need to restart several times, <br><br><pre> <code class="bash hljs">docker run --name elastic -d -p 127.0.0.1:9200:9200 -p 127.0.0.1:9300:9300 -v /elastic:/data dockerfile/elasticsearch /elasticsearch/bin/elasticsearch -Des.config=/data/elasticsearch.yml</code> </pre><br>  Pay attention to, <code>-p 127.0.0.1:9200:9200</code> , here we ‚Äúbind‚Äù using <code>9200</code> only from <code>localhost</code> .  I spent a few hours trying to configure <code>iptables</code> and close 9200/9300 ports to no avail.  Thanks to the help of <a href="https://twitter.com/darkproger">@darkproger</a> and <a href="https://twitter.com/kkdoo">@kkdoo,</a> everything worked as it should. <br><br>  <code>-v /elastic:/data</code> will map the volume of the <code>/data</code> container to the local <code>/elastic</code> . <br><br><h4>  Proxy Node.js server </h4><br>  Now you need to start the proxy server Node.js, which will serve traffic from / to <a href="http://localhost/">localhost</a> : 9200 to the outside world, safely.  I made a small project based on <a href="http-proxy">http-proxy</a> , called <a href="https://github.com/likeastore/elastic-proxy">elastic-proxy</a> , it is very simple and may well be reused in other projects. <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/likeastore/elastic-proxy $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> elastic-proxy</code> </pre><br>  Server code itself <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpProxy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http-proxy'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logger = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./source/utils/logger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = process.env.PORT || <span class="hljs-number"><span class="hljs-number">3010</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> proxy = httpProxy.createProxyServer(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parseAccessToken = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = url.parse(req.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).query; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> referer = url.parse(req.headers.referer || <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).query; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.access_token || referer.access_token; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> accessToken = parseAccessToken(req); logger.info(<span class="hljs-string"><span class="hljs-string">'request: '</span></span> + req.url + <span class="hljs-string"><span class="hljs-string">' accessToken: '</span></span> + accessToken + <span class="hljs-string"><span class="hljs-string">' referer: '</span></span> + req.headers.referer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!accessToken || accessToken !== config.accessToken) { res.statusCode = <span class="hljs-number"><span class="hljs-number">401</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.end(<span class="hljs-string"><span class="hljs-string">'Missing access_token query parameter'</span></span>); } proxy.web(req, res, {<span class="hljs-attr"><span class="hljs-attr">target</span></span>: config.target}); }); server.listen(port, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">'Likeastore Elastic-Proxy started at: '</span></span> + port); });</code> </pre><br>  It proxies all requests and ‚Äúskips‚Äù only those that specify the access_token as a request parameter.  access_token is <a href="">configured</a> on the server via the environment variable <code>PROXY_ACCESS_TOKEN</code> . <br><br>  Since the server is already <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-dokku-one-click-digitalocean-image-to-deploy-a-python-flask-app">configured</a> for Dokku, then all that remains to be done is to push the sources and Dokku will deploy the new service. <br><br><pre> <code class="bash hljs">$ git push master production</code> </pre><br>  After deployment, go to the server and configure the access token, <br><br><pre> <code class="bash hljs">$ dokku config proxy <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PROXY_ACCESS_TOKEN=<span class="hljs-string"><span class="hljs-string">"your_secret_value"</span></span></code> </pre><br>  I also wanted everything to go through SSL, with Dokku this is very easy to achieve, <code>server.key</code> <code>server.crt</code> and <code>server.key</code> to <code>/home/dokku/proxy/tls</code> . <br><br>  Restart the proxy to apply the latest changes, make sure that everything is OK by clicking on the link <a href="https://search.likeastore.com/">https://search.likeastore.com</a> - if everything is good, it will issue: <br><br><pre> <code class="bash hljs">Missing access_token query parameter</code> </pre><br><h4>  We connect containers Proxy and ElasticSeach </h4><br>  We need to connect the two containers among themselves, the first with the Node.js proxy, the second with ElasticSearch itself.  I really liked <a href="https://github.com/rlaneve/dokku-link">dokku-link</a> plugin, which does just what you need.  Install it <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/lib/dokku/plugins $ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/rlaneve/dokku-link</code> </pre><br>  And after installation, we associate the proxy with the elastic, <br><br><pre> <code class="bash hljs">$ dokku link proxy elastic</code> </pre><br>  After that, the proxy will need to restart again.  If everything is good, then follow the link <code><a href="https://proxy.yourserver.com/%3Faccess_token%3Dyour_secret_value"></a> proxy.yourserver.com?access_token=your_secret_value,</code>  <code><a href="https://proxy.yourserver.com/%3Faccess_token%3Dyour_secret_value"></a> proxy.yourserver.com?access_token=your_secret_value,</code> we will see the response from ElasticSearch, <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Tundra"</span></span>, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: <span class="hljs-string"><span class="hljs-string">"1.2.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">build_hash</span></span>: <span class="hljs-string"><span class="hljs-string">"6c95b759f9e7ef0f8e17f77d850da43ce8a4b364"</span></span>, <span class="hljs-attr"><span class="hljs-attr">build_timestamp</span></span>: <span class="hljs-string"><span class="hljs-string">"2014-06-03T15:02:52Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">build_snapshot</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">lucene_version</span></span>: <span class="hljs-string"><span class="hljs-string">"4.8"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">tagline</span></span>: <span class="hljs-string"><span class="hljs-string">"You Know, for Search"</span></span> }</code> </pre><br><h4>  We adjust the client </h4><br>  It remains to configure the client so that it sends an access_token to all requests to the server.  For the Node.js application, it looks like this, <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = elasticsearch.Client({ <span class="hljs-attr"><span class="hljs-attr">host</span></span>: { <span class="hljs-attr"><span class="hljs-attr">protocol</span></span>: <span class="hljs-string"><span class="hljs-string">'https'</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">'search.likeastore.com'</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">query</span></span>: { <span class="hljs-attr"><span class="hljs-attr">access_token</span></span>: process.env.ELASTIC_ACCESS_TOKEN } }, <span class="hljs-attr"><span class="hljs-attr">requestTimeout</span></span>: <span class="hljs-number"><span class="hljs-number">5000</span></span> });</code> </pre><br>  Now you can restart the application, make sure everything works as it should ... and exhale. <br><br><h4>  Afterword </h4><br>  This setup worked (and works now) for <a href="https://likeastore.com/">Likeastore</a> perfectly well.  However, over time, I saw some kind of overhead of this approach.  Most likely, you can get rid of the proxy server, and configure nginx with <code>basic-authorization</code> , from <code>upstream</code> to the docker, also with SSL support. <br><br>  Also, good ideas will probably keep Elastic in a private network, and all requests to it should be done through the application API.  This may not be very convenient from a development point of view, but it is more reliable from a security point of view. <br><br>  Shl.  This is a retelling in Russian of my post from a personal <a href="http://beletsky.net/">blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/231917/">https://habr.com/ru/post/231917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231897/index.html">Is HTML a programming language?</a></li>
<li><a href="../231901/index.html">Distant work: when you scare children</a></li>
<li><a href="../231909/index.html">RailsClub Moscow 2014</a></li>
<li><a href="../231911/index.html">5 ways to keep call center customers</a></li>
<li><a href="../231915/index.html">MediaTek and LTE: first results</a></li>
<li><a href="../231919/index.html">Announced by Nokia Lumia 530</a></li>
<li><a href="../231921/index.html">Sweater: Finally on the App Store</a></li>
<li><a href="../231923/index.html">Creating audio plug-ins, part 15</a></li>
<li><a href="../231925/index.html">Games for science</a></li>
<li><a href="../231929/index.html">Ultra Efficient Text Processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>