<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>At the request of workers: Dual ISP on cisco routers without BGP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A typical task, which nevertheless continues to raise a lot of questions. 

 I will try to briefly describe the essence of technology and pitfalls. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>At the request of workers: Dual ISP on cisco routers without BGP</h1><div class="post__text post__text-html js-mediator-article">  A typical task, which nevertheless continues to raise a lot of questions. <br><br>  I will try to briefly describe the essence of technology and pitfalls. <br><br>  So, let us have one cisco border router with one internal port (g0 / 0) and two external (f0 / 0, f0 / 1) ports.  There is a connection to two providers, each of which has its own pool of addresses Pool (ISP1) and Pool (ISP2) (these are some networks belonging to a particular provider).  Let, for simplicity, the addresses of the f0 / 0 and f0 / 1 interfaces from the same pools.  And the addresses of the gateways from the same pools (Gate (ISP1) and Gate (ISP2), respectively). <br>  Since we do not have the opportunity to raise BGP, then we must prescribe a default route for each of the providers.  And here comes the first question: what problem do we want to solve?  Redundancy or simultaneous work with two providers? <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Reservation.</b> <br><br>  In this topology, only one provider is working at a time.  That is, we must organize the ISP1 provider check and if it is alive, walk through it, and if it is ‚Äúdead‚Äù, then switch to the ISP2 backup provider.  There is a pitfall: NAT.  We can write several translation rules, but we need to somehow indicate that when we exit through ISP1 we use Pool (ISP1), and when we exit through ISP2, we use Pool (ISP2), otherwise the router will always use the translation that was first written in the configuration.  It is clear that if you go through ISP2, and the source addresses are from Pool (ISP1), then at best we will get asymmetric routing, at worst, the packages will not get anywhere, for example, because providers fulfill the requirement to use RFC2827 filtering, which means Receive packets with source addresses from outside your network. <br>  So, we have 2 subtasks: checking the provider (route) for "liveliness" and address translation with regard to the output interface. <br><br><h5>  Check for "liveliness." </h5><br>  Cisco routers have a great technology called SLA.  With it, you can not only ping a certain address, but also check the liveliness of certain services (ftp-connect, tcp-connect) or a parameter of the communication channel (icmp-jitter, udp-jitter).  Here we consider the easiest and most common way - ping a specific host.  For simplicity, we will ping the Gateway Provider Gateway (ISPX) address.  If you need to ping another address, you must explicitly register the route to this address through a specific provider, which we check. <br><br><pre> !  Set the parameters of "pingalis"
 ip sla {#}
   icmp-echo {ip} [source-interface {int}]
 !
 !  We start pingovalku
 ip sla schedule {#} start now life forever
 !
 !  We set up a ‚Äúswitch‚Äù (track) on which the route will depend
 track {#} ip sla {#} reachability
 !
 !  Customize the default route with tracking
 ip route 0.0.0.0 0.0.0.0 {next-hop} track {#}
</pre><br><br>  Note: in old IOS, the command to bind track to sla is so <br><br><pre> track {#} rtr {sla #} reachability
</pre><br>  If the host is pinged, the track will be in the UP state and the route will be in the routing table.  BUT <br>  if the ping disappears, then after a configured period of time (by default 3 * 10 seconds) track <br>  will change the state to DOWN and the route will be deleted until the track changes again <br>  state. <br><br>  Example: <br><pre> ip sla 1
   icmp-echo Gate (ISP1)
 ip sla schedule 1 start now life forever
 track 11 ip sla 1 reachability
 ip route 0.0.0.0 0.0.0.0 Gate (ISP1) track 11
</pre><br>  ISP2 can not be checked, so as not to create excess service traffic to the channel, because  we have it spare and can be expensive (satellite channel, for example, or dial-up channel, paid for the time of work).  We will write the route to the second provider with a larger administrative distance and thus make it work only if the main one disappears. <br><br><h5>  <b>Setting the address translation rules based on the outgoing interface.</b> </h5><br><br>  Here, in fact, there are also 2 tasks: dynamic translation and static translation of addresses.  The first we need to go outside, and the second - for the announcement of services.  In this and in another case, we will need a construction called the route-map (we will need to create one by route-map for each provider) <br><br><pre> !  Create a route-map
 route-map ISPX permit {#}
   !  Specify the criterion for entering this paragraph of the route-map  
   match interface {outgoing interface}
</pre><br><br>  There is a subtle point: when you specify the word interface, the hint is written <br><br><pre>   interface match first hop interface of route
</pre><br>  Those.  generally speaking, it is not clear what the parameter is.  Plus, depending on what is written on the interface itself, this criterion can mean both the incoming interface and the outgoing one!  And it depends on what is written in the ip nat command on the interface: <br><br>  ip nat inside - criterion will mean the incoming interface <br>  ip nat outside - criterion will mean outgoing interface <br><br>  Next, we need an address pool from each provider. <br><br><pre>   ip nat pool PoolX {start-ip (ISPX)} {end-ip (ISPX)}
</pre><br>  And you can already write the rules of NAT for each provider <br><br><pre>   ip nat inside source route-map ISPX poolX overload
</pre><br>  overload - a keyword meaning to use PAT (Port Address Translation, translation based on the source port) <br>  If you need to add static broadcasts, then we do almost the same (let the server reserve the Srv address (ISPX) from each provider, and the local address at the server - Srv (LAN).) <br><br><pre>   ip nat inside source static Srv (ISPX) Srv (LAN) route-map ISPX
</pre><br><br>  ____________ <br>  UPD ATTENTION: TOP UPPER! <br>  Must be <br><pre>   ip nat inside source static Srv (LAN) Srv (ISPX) route-map ISPX </pre><br>  ____________ <br><br>  In this case, of course, you need to take care that both addresses (Srv (ISP1) and Srv (ISP2)) on the DNS servers are registered and point to the same name. <br><br>  So we got: <br><br><pre> ! 
 !  interfaces
 int g0 / 0
   ip address [LAN]
   ip nat inside
 !
 int f0 / 0
   ip address Address (ISP1)
   ip nat outside
 !
 int f0 / 1
   ip address Address (ISP2)
   ip nat outside
 !
 !  Routing
 ip sla 1
   icmp-echo Gate (ISP1)
 ip sla schedule 1 start now life forever
 track 11 ip sla 1 reachability
 ip route 0.0.0.0 0.0.0.0 Gate (ISP1) track 11
 ip route 0.0.0.0 0.0.0.0 Gate (ISP2) 50
 !
 !  NAT pools
 ip nat pool POOL1 {start-ip (ISP1)} {end-ip (ISP1)}
 ip nat pool POOL2 {start-ip (ISP2)} {end-ip (ISP2)}
 !
 !  route-map for NATa
 route-map ISP1 permit 10
   match interface f0 / 0
 !
 route-map ISP2 permit 10
   match interface f0 / 1
 !
 !  NATa rules
 ip nat inside source route-map ISP1 POOL1 overload
 ip nat inside source route-map ISP2 POOL2 overload
 ip nat inside source static Srv (LAN) Srv (ISP1) route-map ISP1
 ip nat inside source static Srv (LAN) Srv (ISP2) route-map ISP2
</pre><br><br>  <b>Simultaneous use of two providers</b> <br><br>  If in the first case everything is clear and unambiguous, then in the case of simultaneous use of two providers, problems arise. <br><br>  Is this topic interesting?  What thoughts and problems are there? <br>  Write: compile with your thoughts and post if you want. </div><p>Source: <a href="https://habr.com/ru/post/80555/">https://habr.com/ru/post/80555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80546/index.html">MVC 2: Strongly Typed Html Helper</a></li>
<li><a href="../80549/index.html">Online and helpful quotes</a></li>
<li><a href="../80550/index.html">MTS-Ukraine and the quality of communication</a></li>
<li><a href="../80553/index.html">"Pokatushki on the dirt" - video review Colin McRae Dirt 2</a></li>
<li><a href="../80554/index.html">Cairo shell is now open source</a></li>
<li><a href="../80556/index.html">Moving to Agave</a></li>
<li><a href="../80559/index.html">Give smart advice!</a></li>
<li><a href="../80560/index.html">Babushkofony without warranty</a></li>
<li><a href="../80561/index.html">CES 2010: Intel has opened a store for atom-based devices</a></li>
<li><a href="../80562/index.html">CES 2010: Sanyo Unveils Eneloop Hybrid Electric Bike</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>