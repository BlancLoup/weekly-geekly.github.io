<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Adventures of the Elusive Malvari, Part IV: DDE and the Word Document Fields</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is part of the Fileless Malware series. All other parts of the series: 



- The Adventures of the Elusive Malvar, Part I 
- The Adventur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Adventures of the Elusive Malvari, Part IV: DDE and the Word Document Fields</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zn/w7/ji/znw7ji_p5zvifvliksiuceqjll0.png"><br><br>  This article is part of the Fileless Malware series.  All other parts of the series: <br><br><ul><li>  <a href="https://habr.com/ru/company/varonis/blog/456440/">The Adventures of the Elusive Malvar, Part I</a> </li><li>  <a href="https://habr.com/ru/company/varonis/blog/458010/">The Adventures of the Elusive Malvar, Part II: Secretive VBA Scripts</a> </li><li>  <a href="https://habr.com/ru/company/varonis/blog/459506/">The Adventures of the Elusive Malvari, Part III: Intricate VBA Scripts for Laughter and Profit</a> </li><li>  The Adventures of the Elusive Malvari, Part IV: DDE and the fields of the Word document (we are here) </li></ul><br>  In this article, I was going to dive into an even more complex multi-step script without a file attack with a pin in the system.  But then I came across an incredibly simple attack without a code - no Word or Excel macros are required!  And this much more effectively proves my initial hypothesis underlying this series of articles: to overcome the external perimeter of any organization is quite an easy task. <br><a name="habracut"></a><br>  The first attack, which I will describe, exploits a Microsoft Word vulnerability that is based on an <strong>obsolete <a href="">Dynamic Data Exchange Protocol</a> (DDE)</strong> .  It has already been <a href="https://www.bleepingcomputer.com/news/microsoft/microsoft-disables-dde-feature-in-word-to-prevent-further-malware-attacks/">fixed</a> .  The second exploits a more general vulnerability in Microsoft COM and object transfer capabilities. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Back to the future with DDE </h2><br>  Does anyone else remember DDE?  Probably a few.  It was one of the first <strong>interprocess communication protocols that allowed applications and devices to transfer data</strong> . <br><br>  I myself am a little familiar with it, because earlier I checked and tested the telecom equipment.  At that time, DDE allowed, for example, to transfer a caller ID to call center operators in a CRM application that eventually opened a customer card.  To do this, you had to connect an RS-232 cable between the phone and the computer.  Those were the days! <br><br>  As it turned out, Microsoft Word still <a href="https://msdn.microsoft.com/en-us/library/ff533431(v%3Doffice.12).aspx">supports</a> DDE. <br><br>  What makes this attack effective without code is that you can access the DDE protocol <i>directly</i> from the automatic fields of a Word document (I take off my hat to SensePost for <a href="https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/">researching and publishing</a> about it). <br><br>  <strong>Field codes</strong> are another ancient MS Word function that allows you to add dynamic text and a little programming to the document.  The most obvious example is the ‚Äúpage number‚Äù field, which can be inserted into the footer using the {PAGE \ * MERGEFORMAT} value.  This allows you to automatically generate page numbers. <br><br><img src="https://habrastorage.org/webt/wu/ov/ns/wuovnsvhhei65psga4ongzkfwuc.jpeg"><br>  <font color="#999999"><i>Hint: you can find the Field menu item in the Insert section.</i></font> <br><br>  I remember that when I first discovered this feature in Word, I was amazed.  And until the patch disconnected it, Word maintained the DDE field parameter setting.  The idea was that DDE would allow Word to communicate with the application directly, so that it could then transfer the output of the program to a document.  It was a very young technology at that time - supporting data exchange with external applications.  Later it was developed in the COM technology, which we will also consider below. <br><br>  As a result, the hackers realized that this DDE application could be a command shell, which, of course, launches PowerShell, and from there the hackers can do whatever they want. <br>  The screenshot below shows how I used this secretive technique: a small PowerShell script (hereinafter - PS) from the DDE field loads another PS script that launches the second phase of the attack. <br><br><img src="https://habrastorage.org/webt/p6/17/2j/p6172jjjmcko74uq-klljtznybs.jpeg"><br>  <font color="#999999"><i>Thanks to Windows for the pop-up warning that the built-in DDEAUTO field secretly tries to launch the shell.</i></font> <br><br>  The preferred method of exploiting the vulnerability is to use a variant with the DDEAUTO field, which automatically runs the script <i>when opening</i> a Word document. <br>  Let's think about what can be done about it. <br><br>  As a novice hacker, you can, for example, send a phishing email, pretending that you are from the FTS, and embed the DDEAUTO field with the PS script for the first stage (the dropper is essentially).  And you do not even need to do any real coding of macros, etc., as I did in the <a href="https://habr.com/ru/company/varonis/blog/459506/">previous article.</a> <br>  The victim opens your document, the embedded script is activated, and the hacker is inside the computer.  In my case, the remote PS script only prints a message, but it can also easily run the PS Empire client, which will provide remote access to the shell. <br>  And before the victim has time to say at least something, hackers will be the richest teenagers in the village. <br><br><img src="https://habrastorage.org/webt/s2/hr/o3/s2hro3e7lhftosp6nrtdj1cjsge.jpeg"><br>  <font color="#999999"><i>The shell was run without any coding.</i></font>  <font color="#999999"><i>Even a child can do it!</i></font> <br><br><h2>  DDE and fields </h2><br>  Later, Microsoft still turned off DDE in Word, but before that the company stated that this feature was simply misused.  Their unwillingness to change something is understandable.  From my own experience, I myself witnessed such an example that updating the fields when opening a document was turned on, but the Word macros were turned off by the IT service (but with the notification shown).  By the way, you can find the corresponding parameters in the Word settings section. <br><br>  However, even if the field update is enabled, Microsoft Word also notifies the user when the field requests access to remote data, as is the case with DDE above.  Microsoft is really warning you. <br><br>  But most likely, users will still miss this warning and activate the update fields in Word.  This is one of the rare opportunities to thank Microsoft for disabling the dangerous feature of DDE. <br><br>  How hard is it to find a non-patched Windows system today? <br><br>  For this test, I used AWS Workspaces to access the virtual desktop.  So I got a non-patched MS Office virtual machine, which allowed me to insert the DDEAUTO field.  I have no doubt that in the same way you can find other companies that have not yet installed the necessary security patches. <br><br><h2>  Mystery items </h2><br>  Even if you installed this patch, there are other security holes in MS Office that allow hackers to do something very similar to what we did with Word.  In the next scenario, we will learn how to <strong>use Excel as bait for a phishing attack without writing code.</strong> <br><br>  To understand this scenario, let's recall the Microsoft <i>Component Object Model</i> , or abbreviated as <i>COM (Component Object Model)</i> . <br><br>  COM has existed since the 1990s, and is defined as a ‚Äúlanguage-neutral object-oriented component model‚Äù based on remote RPC procedure calls.  For a general understanding of COM terminology, read <a href="https://stackoverflow.com/questions/514598/what-is-the-difference-between-com-and-ole">this post</a> on StackOverflow. <br><br>  By and large, you can present a COM application as an Excel or Word executable file, or some other binary executable. <br><br>  It turns out that a COM application can also run a <i>script</i> ‚Äî JavaScript or VBScript.  Technically, this is called a <strong>scriptlet</strong> .  You may have encountered the .ct extension for files in Windows - this is the official extension for scripts.  In fact, they are the script code enclosed in an XML wrapper: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?XML version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">progid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{BBBB4444-0000-0000-0000-0000FAADACDC}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remotable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"JScript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> &lt;![CDATA[ var r = new ActiveXObject("WScript.Shell").Run("cmd /k powershell -c Write-Host You have been scripted!"); ]]&gt; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Hackers and pentesters discovered that there are separate utilities and applications in Windows that accept COM objects and, accordingly, scriptlets too. <br><br>  I can pass the scriptlet to a Windows utility written on VBS, known as pubprn.  It is located in the depths of C: \ Windows \ system32 \ Printing_Admin_Scripts.  By the way, there are other Windows utilities that take objects as parameters.  To begin, consider this example. <br><br><img src="https://habrastorage.org/webt/yk/ed/ne/ykedneaau8q1rs8n_jizxmiwzp4.jpeg"><br>  <font color="#999999"><i>It is quite natural that the shell can be run even from a print script.</i></font>  <font color="#999999"><i>Go, Microsoft!</i></font> <br><br>  As a test, I created a simple remote scriptlet that launches a shell and prints a funny message ‚ÄúYou have just been scripted!‚Äù.  Essentially, pubprn creates an instance of a scriptlet object, allowing VBScript code to run a shell.  This method provides clear advantages for hackers who want to quietly penetrate and hide in your system. <br><br>  In the next post I will explain how COM scriptlets can be used by hackers using Excel spreadsheets. <br><br>  To you as homework - watch <a href="http://www.irongeek.com/i.php%3Fpage%3Dvideos/derbycon6/522-establishing-a-foothold-with-javascript-casey-smith">this video</a> from Derbycon 2016, which explains exactly how hackers used scriptlets.  And also read <a href="https://enigma0x3.net/2017/08/03/wsh-injection-a-case-study/">this article</a> about scriptlets and some moniker. </div><p>Source: <a href="https://habr.com/ru/post/460521/">https://habr.com/ru/post/460521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460511/index.html">PHP-FPM setup: use pm static for maximum performance</a></li>
<li><a href="../460513/index.html">Flutter 1.7 - what's new in the release of July 10, 2019</a></li>
<li><a href="../460515/index.html">How close are we really to the emergence of robility?</a></li>
<li><a href="../460517/index.html">How to detect attacks on Windows infrastructure: we study the tools of hackers</a></li>
<li><a href="../46052/index.html">Widget Yandex.Clock for the New Year</a></li>
<li><a href="../460523/index.html">Announcement of mitap, smoothly turning into BeerPHP drinkcap (in Moscow and online)</a></li>
<li><a href="../460525/index.html">Welcome to DINS IT EVENING in July: QA and JS</a></li>
<li><a href="../460527/index.html">Solution of the task with pwnable.kr 06 - random and 09 - mistake</a></li>
<li><a href="../46053/index.html">Video about telephony and VoIP</a></li>
<li><a href="../460531/index.html">Curious perversions from the IT world - 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>