<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Examining database changes through checksums</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The study of the state of the database greatly helps in exploratory testing. And the tester himself can find a bug that may surprise the most experien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Examining database changes through checksums</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/06f/496/ec7/06f496ec76266fa8077196e42ee4e119.png" align="right" alt="Picture Magnifier. Examining database changes through checksums">  The study of the state of the database greatly helps in exploratory testing.  And the tester himself can find a bug that may surprise the most experienced programmers. <br><br>  A very significant part of the application I'm working on is Database running under SQL Server and Oracle.  Over the 10 years of the application itself, the number of tables has grown to 210 only in the standard package, each user has overloaded with triggers, a lot of stored procedures and functions have been written. <br><br>  But for me it is only important what changes in the data provoke my manipulations with the user interface. <a name="habracut"></a>  And the algorithm of my actions on system research is as follows: <br><ol><li>  Determine which tables were touched during user interface manipulations. </li><li>  Investigate data changes by creating separate SQL scripts </li><li>  Write knowledge of changes and dependencies in the database </li></ol><br>  This article is devoted to a very simple implementation of the first paragraph, tracking the modified tables.  Examples of implementation will be sharpened for SQL Server, but considering that similar functionality exists in any known relational DBMS - this approach can be applied to Oracle, MySQL, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Implementing the calculation of table checksums using SQL Server </h5><br>  Here we need two queries: <br>  First, in order to get a list of full names (schema name + table name) of all tables in the database: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'['</span></span> + sys.schemas.name + <span class="hljs-string"><span class="hljs-string">'].['</span></span> + sys.Tables.name + <span class="hljs-string"><span class="hljs-string">']'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TABLEFULLNAME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.Tables <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.schemas <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sys.Tables.schema_id = sys.schemas.schema_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> sys.schemas.name, sys.Tables.name</code> </pre> <br>  Using <a href="http://nerddinner.codeplex.com/">the NerdDinner base as an example</a> , we get the following result: <br> <code>[dbo].[Dinners] <br> [dbo].[RSVP] <br></code> <br><br>  The second query will calculate the checksum, in this case for the table [dbo]. [Dinners] <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM_AGG</span></span>(BINARY_CHECKSUM(*)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Dinners] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK)</code> </pre><br>  Result: <br> <code>1828475971</code> <br> <br>  This is the checksum of the current state of the table.  When deleting, adding, changing new data - it will change.  And this is what we need. <br><br>  But, really now, after getting the list of tables in the first query, it is necessary to substitute each in the second hands?  - Yes!  But not with your hands.  For this, I had a Perl script written.  But, in this article I want to do without the use of programming languages. <br><br>  In order to generate the necessary substitutions using SQL tools, it is necessary to execute the following query, which will generate the code of another query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT ''['</span></span> + sys.schemas.name + <span class="hljs-string"><span class="hljs-string">'].['</span></span> + sys.Tables.name + <span class="hljs-string"><span class="hljs-string">']'' AS TABLENAME, CHECKSUM_AGG(BINARY_CHECKSUM(*)) AS CHECKSUM FROM ['</span></span> + sys.schemas.name + <span class="hljs-string"><span class="hljs-string">'].['</span></span> + sys.Tables.name + <span class="hljs-string"><span class="hljs-string">'] WITH (NOLOCK) UNION'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SCRIPT <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.Tables <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.schemas <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sys.Tables.schema_id = sys.schemas.schema_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> sys.schemas.name, sys.Tables.name</code> </pre><br>  And in the case of NerdDinner, we get the following result: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'[dbo].[Dinners]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TABLENAME, <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM_AGG</span></span>(BINARY_CHECKSUM(*)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Dinners] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'[dbo].[RSVP]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TABLENAME, <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM_AGG</span></span>(BINARY_CHECKSUM(*)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[RSVP] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK) &lt;s&gt;<span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span>&lt;/s&gt;</code> </pre><br>  Now delete the last ‚ÄúUNION‚Äù, and run the generated query, as a result it will show the following: <br> <code>[dbo].[Dinners] 1828475971 <br> [dbo].[RSVP] 4096 <br></code> <br><br><h5>  Automate tracking of table changes using a .bat file </h5><br>  Now let's create a simple bat file that runs the checksum calculation and outputs only the names of the changed tables to the console. <br><br>  What we need: <br><ol><li>  <a href="http://gnuwin32.sourceforge.net/packages/diffutils.htm">Download the diff.exe command, the following</a> files are needed: diff.exe, libiconv2.dll, libintl3.dll </li><li>  Make sure that the SQL Server Management Command Utility (sqlcmd.exe) is installed and available (installed with SQL Server). </li><li>  The script for calculating checksums for each table that we generated in the previous section.  Save it to a file as " <i>database_checksums.sql</i> " </li></ol><br>  Now let's create a file <i><b>getchanges.bat</b></i> , which, with each press of Enter, will display a list of changed tables: <br><br><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> SQL_SERVER_HOST=dz\SQL2008 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> SQL_USER=admin <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> SQL_USER_PASSWORD=admin <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> SQL_DATABASE=NerdDinner <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> CHECKSUM_SCRIPT=database_checksums.sql <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Clenup <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. &gt; left.txt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. &gt; right.txt :HOME sqlcmd.exe -U <span class="hljs-variable"><span class="hljs-variable">%SQL_USER%</span></span> -P <span class="hljs-variable"><span class="hljs-variable">%SQL_USER_PASSWORD%</span></span> -S <span class="hljs-variable"><span class="hljs-variable">%SQL_SERVER_HOST%</span></span> -d <span class="hljs-variable"><span class="hljs-variable">%SQL_DATABASE%</span></span> -i <span class="hljs-variable"><span class="hljs-variable">%CHECKSUM_SCRIPT%</span></span> -o left.txt diff.exe --side-by-side --suppress-common-lines left.txt right.txt &gt; diff-result.txt <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> diff-result.txt <span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> left.txt right.txt /y &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pause</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> HOME</code> </pre><br><br>  Video demonstration of the script: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/lbIgMwiekjk%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgijinDNet3EDts8l9gritYxXDMCQ" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Conclusion </h5><br>  In my work, I very often use this approach in research testing an application.  For example, without having to understand the pile of code in C ++, C # and stored procedures, which lies between my click on the user interface and changing the state of the database, I keep the situation under control and very quickly find and track the data I need. <br>  In some situations, by monitoring the base, and relying on the previous knowledge gained, I managed to find bugs that were not visible through the user interface of the application, but strongly distorted the data in the generated reports. <br><br>  For more convenience, I wrote the Sql Change Scanner utility, which allows you to monitor changes through a more convenient interface. <br>  For more information about the utility, you can read from the following post: <br>  <a href="http://blog.zhariy.com/2012/07/sql-change-scanner-sql-server.html">Sql Change Scanner - utility for tracking changes in SQL Server tables</a> <br>  You can download the program on Github: <br>  <a href="https://github.com/dzhariy/SqlChangeScanner/downloads">https://github.com/dzhariy/SqlChangeScanner/downloads</a> <br><br>  <i>Enjoy your reverse engineering,</i> <i><br></i>  <i>Dmitry Zhariy</i> </div><p>Source: <a href="https://habr.com/ru/post/149431/">https://habr.com/ru/post/149431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149424/index.html">Biometric identification by the pattern of the veins of the palm (mini How To)</a></li>
<li><a href="../149426/index.html">Kohana, Image Preview - it‚Äôs just</a></li>
<li><a href="../149427/index.html">Backdoor in your Java application</a></li>
<li><a href="../149428/index.html">Microsoft and New York Police will experience a crime tracking system</a></li>
<li><a href="../149430/index.html">Things I didn't know about WebKit inspector</a></li>
<li><a href="../149433/index.html">Casio Protrek PRG-240-1ER watch</a></li>
<li><a href="../149435/index.html">Creating a modular structure using inversion control</a></li>
<li><a href="../149436/index.html">Bookmarks in Media Player Classic Home Cinema</a></li>
<li><a href="../149437/index.html">Apple offered Samsung to buy a patent license for $ 30 for a smartphone</a></li>
<li><a href="../149438/index.html">Samsung launches EMMC Pro Class 1500 memory modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>