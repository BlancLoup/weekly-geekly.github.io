<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering of the binary format using the Korg SNG files as an example. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article I described the line of reasoning when parsing an unknown binary data format. Using Synalaze It !, Hex-editor, I showed how you ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering of the binary format using the Korg SNG files as an example. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ja/rn/d3/jarnd3grsgftxg_bdcm3uztkgqa.jpeg"><br><br>  In the <a href="https://habr.com/en/post/442580/">last article</a> I described the line of reasoning when parsing an unknown binary data format.  Using Synalaze It !, Hex-editor, I showed how you can parse the header of a binary file and select the main data blocks.  Since, in the case of the SNG format, these blocks form a hierarchical structure, I managed to use recursion in grammar to automatically construct their tree representation in a form understandable to man. <br><br>  In this article I will describe a similar approach, which I used to analyze the musical data directly.  Using the built-in capabilities of the Hex editor, I will create a prototype of the data converter into the common and simple Midi format.  We will have to face a number of pitfalls and break our head over the simple at first glance task of converting time samples.  Finally, I will explain how you can use the results and grammar of a binary file to generate part of the code of a future converter. <br><a name="habracut"></a><br><h3>  Parsing music data </h3><br>  So, it's time to figure out how to store music data in .SNG files.  In part, I mentioned this in the last article.  The documentation of the synthesizer states that the SNG file can contain up to 128 ‚Äúsongs‚Äù, each of which consists of 16 tracks and one master track (for recording global events and changing master effects).  Unlike the Midi format, where music events simply follow each other from a specific time delta, the SNG format contains musical measures. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A beat is a kind of container for a sequence of notes.  The dimension of the beat is indicated in musical notation.  For example, 4/4 - means that the beat contains 4 beats, each of which is equal to a quarter note in duration.  Simply speaking, such a beat will contain 4 quarter notes or 2 half, or 8 eighths. <br><br><div class="spoiler">  <b class="spoiler_title">Here's what it looks like in a musical score.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/n4/wj/_p/n4wj_p6rc6oisguqdvevylxkvwq.jpeg"><br></div></div><br>  The clock in the SNG file is used to edit the tracks in the built-in sequencer of the synthesizer.  Using the menu, you can delete, add and duplicate beats anywhere in the track.  You can also loop cycles or change their dimensions.  Finally, you can simply start recording a track from any measure. <br><br>  Let's try to see how all this is stored in a binary file.  A common container for "songs" is the SGS1 block.  The data for each song is stored in SDT1 blocks: <br><br><img src="https://habrastorage.org/webt/ea/ho/ry/eahory6upy5olir7c73xeovijzw.jpeg"><br><br>  The SPR1 and BMT1 blocks store general song settings (tempo, metronome settings) and individual track settings (patches, effects, arpeggiator parameters, etc.).  We are also interested in the TRK1 block - namely, it contains musical events.  But you need to go down a couple more levels of hierarchy - to the block MTK1 <br><br><img src="https://habrastorage.org/webt/ct/5a/aw/ct5aawrhbvnj-kn0zhjfd-kx3mw.jpeg"><br><br>  Finally, we found our tracks - these are the MTE1 blocks.  Let's try to write on the synthesizer an empty track of short duration and another one a little longer - in order to understand how the information about the beats is stored in binary form. <br><br><img src="https://habrastorage.org/webt/8d/hu/5o/8dhu5o0ckd5wurxpmo8ytxhdbrw.jpeg"><br><br>  It seems that the clocks are stored as eight-byte structures.  Add a couple of notes: <br><br><img src="https://habrastorage.org/webt/74/5k/pt/745kptmagdau8lsfocc_3ont0eo.jpeg"><br><br>  So, we can assume that all events are stored in the same form.  The beginning of the MTE block contains as yet unknown information, then to the end goes the sequence of eight-byte structures.  Open the grammar editor and create an <b>event</b> structure with a size of 8 bytes. <br><br>  Add the <b>mte1Chunk</b> structure that inherits the <b>childChunk</b> , and place the reference to the <b>event</b> in the <b>data</b> structure.  We point out that <b>event</b> can be repeated an unlimited number of times.  Next, by experiment, find out the size and purpose of several bytes before the beginning of the stream of events of the track.  I got the following: <br><br><img src="https://habrastorage.org/webt/io/0w/r2/io0wr2spxxs72fiugspwggiwhxm.jpeg"><br><br>  The beginning of the MTE1 block stores the number of track events, its number and, presumably, the dimension of the event.  After applying grammar, the block began to look like this: <br><br><img src="https://habrastorage.org/webt/54/oy/no/54oynoxzskhkbpeiah2t8q24-xc.jpeg"><br><br>  We turn to the flow of events.  After analyzing several files with different sequences of notes, the following picture appears: <br><table><tbody><tr><th>  # </th><th>  Type of </th><th>  Binary representation </th></tr><tr><td>  one </td><td>  Tact1 </td><td>  01 00 00 ... </td></tr><tr><td>  2 </td><td>  Note </td><td>  09 00 3C ... </td></tr><tr><td>  3 </td><td>  Note </td><td>  09 00 3C ... </td></tr><tr><td>  four </td><td>  Note </td><td>  09 00 3C ... </td></tr><tr><td>  five </td><td>  Tact2 </td><td>  01 C3 90 ... </td></tr><tr><td>  6 </td><td>  Note </td><td>  09 00 3C ... </td></tr><tr><td>  7 </td><td>  The end of the track </td><td>  03 88 70 ... </td></tr></tbody></table><br>  It looks like the first byte encodes the type of event.  Add a <b>type</b> field to the <b>event</b> structure.  Create two more structures that inherit <b>event</b> : <b>measure</b> and <b>note</b> .  We indicate the corresponding Fixed Values ‚Äã‚Äãfor each of them.  And finally, add links to these structures in the <b>data</b> of the <b>mte1Chunk</b> block. <br><br><img src="https://habrastorage.org/webt/cf/5v/fs/cf5vfsm3dvikxrx2jh_4ecndqgo.jpeg"><br><br>  Apply the changes: <br><br><img src="https://habrastorage.org/webt/7a/7c/dj/7a7cdjzfvfykdxjmluljiesnvug.jpeg"><br><br>  Well, we are well advanced.  It remains to understand how the height and the force of pressing a note are coded, as well as the time shift of each event relative to the others.  Try again to compare our files with the result of the export in midi, made through the menu of the synthesizer.  This time, we are specifically interested in the events of pressing the notes. <br><br><img src="https://habrastorage.org/webt/fy/er/vm/fyervmjneufot7ulybx6arkhbck.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">The same events in the SNG file</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/nh/iu/9w/nhiu9wa4j6ouumqt1nwlvaaovzc.jpeg"><br></div></div><br>  Fine!  It seems that the height and the force of pressing the notes are encoded in the same way as in the midi format with just a couple of bytes.  Add the appropriate fields to the grammar. <br><br>  With a temporary shift, unfortunately everything is not so simple. <br><br><h3>  Deal with duration and delta </h3><br>  In midi format, NoteOn and NoteOff events are separate.  The duration of the note is determined by the delta time between these events.  In the case of the SNG format, where there is no analogue of the NoteOff event, the duration and time delta values ‚Äã‚Äãshould be stored in the same structure. <br><br>  To find out exactly how they are stored, I recorded several sequences of notes of different lengths on the synthesizer. <br><br><img src="https://habrastorage.org/webt/uc/yr/wd/ucyrwd2fwiioyq94azfo6hfe06k.jpeg"><br><br>  Obviously, the data we need is in the last 4 bytes of the event structure.  With the naked eye, the patterns are not visible, so select the bytes of interest in the editor and use the Data Panel tool. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8c/yw/oo/8cywoo-f4el0lejlf3u3frfb_lg.jpeg"><br></div></div><br>  Apparently, both the duration of the note and the time shift are encoded by a pair of bytes (UInt16).  At the same time, the reverse byte order is Little Endian.  Comparing a sufficient amount of data, I found out that the time delta here is not calculated from the previous event as in midi, but from the start of the clock.  If the note ends in the next bar, then in the current one its length will be 0x7fff, and in the next one it will be repeated with the same delta 0x7fff and the length counted relative to the start of the new bar.  Appropriately if a note sounds a few bars, then in each intermediate, both the duration and the delta will be equal to 0x7fff. <br><br><div class="spoiler">  <b class="spoiler_title">Small scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/0c/el/-z/0cel-zqshc6m7xjqqmfjfvcmptq.jpeg"><br>  <i>The units of time delta / duration count in the cells.</i>  <i>Note 1 sounds normal, and note 2 continues to sound in the 2nd and 3rd bars.</i> <br></div></div><br>  In my opinion, it all looks a bit crutch.  On the other hand, in musical notation, notes continuously sounding a few beats are denoted similarly with the help of legato. <br><br>  In which "parrots" do we have the duration?  As in midi, ticks are used here.  From the documentation it is known that the duration of one share is 480 ticks.  At a pace of 100 beats per minute and a dimension of 4/4, the duration of a quarter note will be (60/100) = 0.6 seconds.  Accordingly, the duration of one tick 0.6 / 480 = 0.00125 seconds.  A standard 4/4 beat will last 4 * 480 = 1920 ticks or 2.4 seconds at a rate of 100 beats / min. <br><br>  All this will be useful to us in the future.  For now, add the duration and delta to our <b>note</b> structure.  Also, we note that in the structure of a clock there is a field that stores the number of events.  Another field contains the serial number of the measure - add them to the <b>measure</b> structure. <br><br><img src="https://habrastorage.org/webt/4r/9_/zp/4r9_zpnbd3rtnnxmsqbppjl-e2g.jpeg"><br><br><h3>  Prototype Converter </h3><br>  Now we have enough information to try to convert the data.  Hex-editor Synalaze It in the pro version allows you to write scripts in python or lua.  When creating a script, you need to decide what we want to work with: the grammar itself, with individual files on the disk, or somehow process parsed data.  Unfortunately, each of the templates has some limitations.  The program provides a number of classes and methods for work, but not all of them are accessible from all templates.  Perhaps this is a lack of documentation, but I did not find how you can load the grammar for a list of files, parse them and use the resulting structures to export data. <br><br>  Therefore, we will create a script to work with the result of parsing the current file.  This pattern implements three methods: init, terminate, and processResult.  The latter is called automatically and recursively passes through all the structures and data obtained during the parsing. <br><br>  We use the Python MIDI toolkit (https://github.com/vishnubob/python-midi) to write the converted data to midi.  Since we are implementing the Proof of Concept, we will not convert the durations of notes and deltas.  Instead, we set fixed values.  Notes with a duration of 0x7fff or with a similar delta while just discard. <br><br>  The capabilities of the built-in script editor are very limited, so all the code will have to be placed in one file. <br><br>  <a href="https://gist.github.com/bkotov/71d7dfafebfe775616c4bd17d6ddfe7b">gist.github.com/bkotov/71d7dfafebfe775616c4bd17d6ddfe7b</a> <br><br>  So, we will try to convert the file and hear what we got. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://w.soundcloud.com/player/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Hmm ... And it turned out pretty interesting.  The first thing that occurred to me when I tried to formulate what it looked like was structureless music.  I will try to give a definition: <br><br>  <i>Structureless music is a musical work with a reduced structure, built on harmony.</i>  <i>The duration of the notes and the intervals between the notes are abolished or reduced to the same values.</i> <br><br>  A sort of harmonious noise.  Let it be pearlescent (by analogy with white, blue, red, pink, etc.), like no one has taken this combination yet. <br><br>  Perhaps we should try to teach the neural network on my data, perhaps the result will be interesting. <br><br><h3>  Warming up mind </h3><br>  This is all great, but the main task is still not solved.  We need to convert the duration of the notes into NoteOff events, and the temporal displacement of the event relative to the start of the clock to the time delta between neighboring events.  I will try to formulate the conditions of the problem more formally. <br><br><div class="spoiler">  <b class="spoiler_title">Task</b> <div class="spoiler_text"><code>     : <br> 1 <br> 1 <br> 2 <br> 3 <br> ... <br> N <br> 2 <br> ... <br> N <br> 1 <br> ... <br>  <br> <br>      <br> : 1 <br> : 1920 <br> : Int <br> : Int <br> <br>     <br> : 9 <br> : 0-127 <br> : 0-127 <br> : 0-1920  0xFF <br> : 0-1920  0xFF <br> <br>      ,    ,         0xFF,       =0xFF        .        ,       .           =  = 0xFF. <br> <br>     . <br> <br>           midi.    : <br> <br> : <br> : 9 <br> : 0-127 <br> : 0-127 <br> : Int <br> <br> : <br> : 8 <br> : 0-127 <br> : 0-127 <br> : Int</code> <br> </div></div><br>  The task is a bit simplified.  In a real SNG file, each clock cycle can have a different dimension.  In addition to the Note On / Off events, other events will also occur in the stream, such as pressing a sustain pedal or changing the pitch with a pitchBend. <br><br>  I will give my solution to this problem in the next article (if it will be). <br><br><h3>  Current totals </h3><br>  Since the solution with the script does not scale to an arbitrary number of files, I decided to write a console converter in Swift.  If I wrote a two-way converter, then the created grammar structures would be useful to me in the code.  You can export them to C structures or any other language using the same script functionality built into Synalize It!  A file with an example of such an export is created automatically when you select the Grammar template. <br><br><img src="https://habrastorage.org/webt/-a/31/jc/-a31jcds25l8lgblqad9bm3hu1q.jpeg"><br><br>  Currently, the converter is 99% complete (in the form that suits me in terms of functionality).  I plan to put the code and grammar on github. <br><br>  An example for which everything was started <a href="https://soundcloud.com/boris-kotov-606562257/draft1-do-not-listen">can be heard here</a> . <br><br>  <a href="https://youtu.be/RQo8FjSEfu8%3Ft%3D238">How this fragment sounds in the finished form.</a> </div><p>Source: <a href="https://habr.com/ru/post/442740/">https://habr.com/ru/post/442740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442724/index.html">The film "Office Space" 20 years: how he changed our jobs</a></li>
<li><a href="../442726/index.html">MIT's cheetah robot can do back flips and run fast</a></li>
<li><a href="../442730/index.html">Microsoft: Russia is ahead of the US and Europe in the implementation of artificial intelligence</a></li>
<li><a href="../442736/index.html">6 board games for upgrading English</a></li>
<li><a href="../442738/index.html">Profiling and tracing with perf</a></li>
<li><a href="../442742/index.html">Laptop Compaq LTE 5000, part two and a half - bonus</a></li>
<li><a href="../442744/index.html">RIPE decision and its consequences on the elimination of two Russian LIRs (Netup, gcxc.net)</a></li>
<li><a href="../442746/index.html">Fool app for Windows Store</a></li>
<li><a href="../442748/index.html">The point: the top 10 reports of Heisenbug 2018 Moscow</a></li>
<li><a href="../442750/index.html">Virtual Djinn on March 8 - or how to surprise your female employees on the very spring day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>