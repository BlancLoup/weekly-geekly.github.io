<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My protected container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing a project in C ++, it became necessary to create a secure container. Rather, cross-platform at the source code level classes that supp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My protected container</h1><div class="post__text post__text-html js-mediator-article">  When developing a project in C ++, it became necessary to create a secure container.  Rather, cross-platform at the source code level classes that support secure storage of information from several bytes to gigabytes, which makes it necessary to support streaming encryption / decryption. <br>  Having no alternative to hire a professional cryptographer at this stage, he started building a bicycle. <br>  This article is written for an open discussion of the proposed solutions by people close to cryptography, as well as for those who will pass this way from scratch, as saving their time and effort. <br><a name="habracut"></a><br>  In the course of studying and analyzing information, OpenSSL was chosen (excellent speed judging by comparison with other libraries, had no difficulties when included in the project, cross-platform), as well as the AES (Rijndael) encryption algorithm with the key 128, 192, 256 to choose from recognized (by the relevant committee you know who) the modern encryption standard. <br><br>  The very first question is a cryptographically resistant (pseudo) random number generator and its installation (siding).  Only it is suitable for generating, for example, a crypto-resistant key.  The generator algorithm, quite logical, is taken from OpenSSL, but with the seeding the question is more complicated.  POSIX systems that have / dev / * random remove me from responsibility for the random seed.  As for Windows, in OpenSSL you can take a set of messages to the window (better) and the contents of the screen (worse).  Despite this, I did not really like the solution with messages in the window, since these are unnecessary problems for the user.  I stopped at a copy of the screen, plus my five cents.  They consisted in the fact that I use Windows to generate a unique GUID, so in the seed I add a crocodile from GetTickCount () XOR before the copy of the screen, XOR System time XOR GUID with small shifts and transformations. <br>  By the way, in a real test on Windows XP SP2 x64, the OpenSSL generator stated that it is already sufficiently cached by default.  Why - I do not know, but as a potential alternative, a solution has been proposed (and is activated on systems where additional seeding is required). <br><br>  Go ahead.  Assuming that the key itself is stored separately, thus the container must contain all the necessary information for decryption.  In the case of AES in streaming (cbc) mode, it is necessary to store the initial initialization vector (iv0), as well as the exact data length, since the algorithm works with blocks of 16 bytes (128 bits). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As for the storage of the initial vector, there is a standard <a href="http://www.ietf.org/rfc/rfc3394.txt">RFC 3394</a> , however, upon careful study, it turned out that it uses the constant value of the initial initialization vector.  At the same time, in the book ‚ÄúAn introduction to cryptography‚Äù it is clearly written that in no case should the initial vector be constant ( <a href="http://books.google.ru/books%3Fid%3DVje8TRcLlycC%26pg%3DPA123%26lpg%3DPA123%26ots%3DrD5LfPH31s%26dq%3Dchoosing%2Bcryptography%2Binitialization%2Bvector">here</a> ).  Therefore, I abandoned this algorithm in favor of creating an initialization vector with a cryptographically stable random number generator, which of course is worse than initialization with an additional random sequence, but much better than a constant vector. <br><br>  The length of the initial vector is 16 bytes, equal to the length of the data block. <br><br>  Let's go to the title.  To make the header length multiple of 16 bytes (AES block size), we recall the length of the vector 16 bytes, then all the additional data is better fit into the other 16 bytes.  8 bytes took up size (aha, big data).  The remaining 8 bytes, I gave a magic number, with some probability guaranteeing that the key is chosen correctly.  And here I also tried to get away from the pre-prepared magic number (M).  My idea is the following: I take a pre-prepared 4-byte constant number.  I generate two persistent random 4-byte A1 and A2.  In this case, I leave the first number as it is, and change the second with the condition that <br><h5>  A1 + A2 '= M </h5><br>  Then <br><h5>  A2 '= A2 + D </h5><br>  and <br><h5>  D = M - (A1 + A2) </h5><br><br>  At the same time, to determine the correctness of the password, I decrypt the first 16-byte header block, take the first two dwords, summarize and see what happened.  The probability of coincidence of values ‚Äã‚Äãis small, but finite.  In my case, this is quite acceptable (if the key is incorrect, then it is already the problem of the attacker that he received false-decrypted data). <br><br>  Aligning the size of data by 16-bytes I do the most trivial, by adding to the end of the desired number of random bytes, which also create a cryptographically resistant generator OpenSSL. <br><br>  Thus, I get rid of the constant numbers in the source data and (as shown above) the constant initialization vector. <br>  Next thing is the technique: the 48-byte header I encode AES in block mode (ecb), then the data blocks are encrypted in stream mode (cbc). <br><br><img src="http://pic.ipicture.ru/uploads/090916/uNMsd4AVno.png" alt="image"><br><br>  PS What could be improved: <br>  + make more random the initial seed in Windows (and POSIX?) <br>  + create an initial initialization vector using a sid, not a generator <br>  + Perhaps it would be better to encrypt the header in the same streaming mode as part of the data. <br>  + make more reliable key validation <br>  + ...? </div><p>Source: <a href="https://habr.com/ru/post/69829/">https://habr.com/ru/post/69829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69822/index.html">A little more about captcha</a></li>
<li><a href="../69823/index.html">Athlon II X4: the cheapest quad</a></li>
<li><a href="../69824/index.html">Commenting code and life expectancy</a></li>
<li><a href="../69825/index.html">Imitation of static variables in JavaSctipt</a></li>
<li><a href="../69828/index.html">Russian language vs. IT</a></li>
<li><a href="../69833/index.html">The winner of TechCrunch50 2009 was the project RedBeacon</a></li>
<li><a href="../69836/index.html">Ukrainian scientists first "photographed" the atom</a></li>
<li><a href="../69838/index.html">CKEditor file manager</a></li>
<li><a href="../69843/index.html">Russian HyperVideo now works in Flash</a></li>
<li><a href="../69844/index.html">Free game for drivers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>