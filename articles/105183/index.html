<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The simplest backup of FreeBSD configs with sending an archive to mail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a small local network, a NAS was installed under FreeBSD and, of course, in the end, the question arose of backing up its configuration in case of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The simplest backup of FreeBSD configs with sending an archive to mail</h1><div class="post__text post__text-html js-mediator-article">  For a small local network, a NAS was installed under FreeBSD and, of course, in the end, the question arose of backing up its configuration in case of a system crash.  I didn‚Äôt want to wind up anything cumbersome, especially since the recovery rate in which case is not yet critical.  Therefore, it was decided to write a simple scriptbook for themselves, every night adding the necessary files to the archive.  And the mail server was chosen as the external storage.  I want to share this script with you. <br><br>  I will make a reservation right away.  To whom this method is not suitable: <br><ul><li>  avid paranoids </li><li>  wishing on day X to restore server uptime in half an hour </li><li>  anyone archive size will exceed 25 MB.  (in the case of <a href="http://mail.google.com/support/bin/answer.py%3Fanswer%3D8770">gmail</a> ) </li></ul>  The post is focused on the same beginners, as well as me.  Described everything as possible in as much detail as possible. <br><a name="habracut"></a><br>  So, we have a Network Access Server on FreeBSD, also acting as a Web server for a couple of sites and one forum. <br>  In my case, the MySQL database is backed up, the entire contents of the folders / etc, / usr / local / etc (so as not to rewrite the path to each config separately), the kernel configuration, cron and the directory with the sites. <br><br>  Let's start with the most difficult.  MySQL database dump is done using standard <a href="http://www.mysql.ru/docs/man/mysqldump.html">mysqldump utility</a> .  Especially for it we will create a new sql-user ‚Äúbackup‚Äù, having a minimum of privileges sufficient for our idea.  I set the following: SELECT, FILE, SHOW DATABASES, LOCK TABLES, SHOW VIEW.  The process of creating a user will not be described in view of the variety of options, and if I try to answer all the questions in the comments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Dump the database to the /var/tmp/all.sql file with the command: <br><br><pre><code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/mysqldump --opt -Aau backup -p__BACKUP &gt; /var/tmp/all.sql</code> </pre> <br>  In principle, everything should turn out the first time.  Further - easier. <br>  Yes, avid Linux users do not want me, but I chose RAR as an archiver, because for the sake of reliability, I also wanted to protect the resulting archive, and tar doesn‚Äôt know how to do it on the fly. <br>  Installing RAR is trivial: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/archivers/rar make install clean</code> </pre> <br>  After a successful installation, we read the manual, select the necessary keys, specify the paths to the files and folders through a space and check the operation. <br>  In my case, the team <br><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/rar a -ow -inul -p__ /var/tmp/server_backup.rar /var/tmp/all.sql /usr/src/sys/i386/conf/kernel /var/cron/tabs /etc /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/www/data</code> </pre> <br>  created archive /var/tmp/server_backup.rar, containing all the listed files and directories.  Note that if you specify paths to directories with a slash at the end, then subdirectories will not be archived, but only files from the root of the specified folder! <br><br>  Next, re-encode the resulting archive into a clear postal form and send it to the mail with the subject ‚Äúserver backup‚Äù <br><br><pre> <code class="bash hljs">/usr/bin/uuencode <span class="hljs-string"><span class="hljs-string">'/var/tmp/server_backup.rar'</span></span> server_backup.rar | mail -s <span class="hljs-string"><span class="hljs-string">'server backup'</span></span> <span class="hljs-string"><span class="hljs-string">'@gmail.com'</span></span></code> </pre> <br>  Naturally, sending by mail can be replaced by merging backups to FTP or ... anywhere - depending on what is available :) <br>  After successful sending, we will delete our archives. <br><br><pre> <code class="bash hljs">rm /var/tmp/server_backup.rar rm /var/tmp/all.sql</code> </pre> <br>  And finally, the entire assembly script looks like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /usr/local/bin/mysqldump --opt -Aau backup -p__BACKUP &gt; /var/tmp/all.sql /usr/local/bin/rar a -ow -inul -p__ /var/tmp/server_backup.rar /var/tmp/all.sql /usr/src/sys/i386/conf/kernel /var/cron/tabs /etc /usr/local/etc /usr/local/www/data /usr/bin/uuencode '/var/tmp/server_backup.rar' server_backup.rar | mail -s 'server backup' '@gmail.com' rm /var/tmp/server_backup.rar rm /var/tmp/all.sql</span></span></code> </pre> <br>  We save it in any way known to us, such as /home/%username%/backup.sh (% username% is your name in the system) and grant the necessary rights <br><br><pre> <code class="bash hljs">chmod 750 /home/%username%/backup.sh</code> </pre> <br>  After that, the script can be run and make sure it works.  If something goes wrong, the entries in / val / log / messages and / var / log / maillog <br><br>  It remains to add the task of running the script in <a href="http://www.google.ru/search%3Fhl%3Dru%26lr%3D%26rlz%3D1C1GGLS_ruRU351RU351%26newwindow%3D1%26defl%3Dru%26q%3Ddefine:Crontab%26ei%3Dqa4FS9SSB4LymwOz_9iyCg%26sa%3DX%26oi%3Dglossary_definition%26ct%3Dtitle%26ved%3D0CAcQkAE">cron</a> .  Run <code>crontab -e</code> and, with <a href="http://ru.wikipedia.org/wiki/Vi">vi</a> , enter the string <br><br><pre> <code class="bash hljs">1 4 * * * /home/%username%/backup.sh</code> </pre> <br>  do not forget to press Enter at the end (there should be an empty line at the very end of the file). <br>  To switch to edit mode in Vi, you must press <code>i</code> .  To exit with saving the file <code>Esc</code> and <code>:wq</code> <br>  With this recording, the script will be executed every night at 4 o'clock 1 minute.  View all crontab entries <br><br><pre> <code class="bash hljs">crontab -l</code> </pre> <br>  I also want to draw attention to the fact that the names of files and directories in the archive are not encrypted!  Opening an archive, for example, in WinRAR, you can browse all the folders and their contents (the directory structure is preserved), but you cannot open files without entering a password. <br><br>  Actually, everything.  There is no limit to perfection, so I‚Äôm happy to hear all the suggestions, wishes and especially criticism. <br>  Good luck and let the archive do not come to you;) <br>  via <a href="http://dobryj.ru/freebsd-backup-to-email">dobryj.ru</a> </div><p>Source: <a href="https://habr.com/ru/post/105183/">https://habr.com/ru/post/105183/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../105172/index.html">Competition for Rubistov</a></li>
<li><a href="../105176/index.html">Widgets for third-party sites</a></li>
<li><a href="../105178/index.html">UI development practice</a></li>
<li><a href="../105181/index.html">How does the most successful startup incubator in the world work?</a></li>
<li><a href="../105182/index.html">Twitter has overtaken myspace</a></li>
<li><a href="../105184/index.html">CMS NetCat - Sorting objects in the table</a></li>
<li><a href="../105185/index.html">Lexiconer - vocabulary replenishment program</a></li>
<li><a href="../105190/index.html">JS1k contest results</a></li>
<li><a href="../105191/index.html">ORM review for Qt</a></li>
<li><a href="../105194/index.html">We are pleased to introduce you to the project "One House"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>