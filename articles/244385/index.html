<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik. Failover. Load balancing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I got the need to figure out how to do failover or load balancing, having two or more channels to the world, I found many articles and instructio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik. Failover. Load balancing</h1><div class="post__text post__text-html js-mediator-article">  When I got the need to figure out how to do failover or load balancing, having two or more channels to the world, I found many articles and instructions that described the working configurations.  But almost nowhere did he find an explanation of how everything works, and descriptions of the differences between different options.  I want to correct this injustice and collect the simplest options for building failover and load balancing configurations in one article. <br><br>  So, we have a router that connects our local network and two channels to the Internet (main ISP1 and backup ISP2). <br><br>  Let's look at what we can do: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Immediately I will warn you: despite the fact that in this article I will describe everything for mikrotik, I will not touch on the topic of scripts</i> <br><a name="habracut"></a><br><h2>  <b>Failover</b> </h2><br><img src="https://habrastorage.org/files/c45/eb1/641/c45eb1641a7c4d959cbf9770d2cfdd60.png" alt="image"><br><br>  We have a backup channel to which traffic can be sent if the main one fails.  But how to make mikrotik understand that the channel fell? <br><br><h4>  The simplest reservation channels </h4><br>  The simplest <i>failover</i> can be configured using the route priority (distance from mikrotik / cisco, metric to linux / windows), as well as the gateway availability check mechanism ‚Äî check-gateway. <br><br>  In the configuration below, all default Internet traffic goes through 10.100.1.254 (ISP1).  But as soon as the address 10.100.1.254 becomes unavailable (and the route through it is inactive) - the traffic will go through 10.200.1.254 (ISP2). <br><br><div class="spoiler">  <b class="spoiler_title">configuration: the simplest failover</b> <div class="spoiler_text"><pre><code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat ###    ### #  <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway    /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">check-gateway = ping for mikrotik is processed as follows:</b> <div class="spoiler_text">  Periodically (every 10 seconds) the gateway is checked by sending an ICMP packet (ping) to it.  A lost package is considered if it has not returned within 10 seconds.  After two lost packets, the gateway is considered inaccessible.  After receiving a response from the gateway, it becomes available and the lost packet counter is reset. </div></div><br><br><h4>  Provide failover with deeper channel analysis </h4><br>  In the last example, everything is fine, except for the situation when the provider's gateway is visible and pinged, but there is no Internet behind it.  It would help us a lot if we could decide on the viability of the provider, pinging not the gateway itself, but something behind it. <br><br>  I know two options for solving this engineering problem.  The first and most common is to use scripts, but since in this article we don‚Äôt touch the scripts, we‚Äôll dwell on the second.  It implies the use of the <i>scope</i> parameter is not entirely correct, but it will help us to probe the provider's channel deeper than before the gateway. <br>  The principle is simple: <br>  Instead of the traditional default gateway = provider's gateway, we will tell the router that the default gateway is some of the always- <i>accessible nodes</i> (for example, 8.8.8.8 or 8.8.4.4) and it is in turn accessible through the provider's gateway. <br><br><div class="spoiler">  <b class="spoiler_title">configuration: failover with deeper channel analysis</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat ### failover c    ### #   scope      <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>  <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> #  <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping</code> </pre><br></div></div><br>  Now let's look at what happens in a little more detail: <br>  The trick is that the provider gateway does not know that 8.8.8.8 or 8.8.4.4 is a router and will send traffic in the usual way. <br>  Our mikrotik believes that by default all Internet traffic needs to be sent to 8.8.8.8, which is not directly visible, but available through 10.100.1.254.  And if the ping to 8.8.8.8 disappears (I remind you that our path to it is strictly indicated through the gateway from ISP1), then mikrotik will start sending all Internet traffic to 8.8.4.4, or rather to the recursively defined 10.200.1.254 (ISP2). <br><br>  <i>But a couple of times I had a situation when the Internet works through the provider's gateway, but there is no specific node or network.</i>  <i>In such cases, the method described above does not really help, and to ensure uninterrupted operation, I had to check the availability of the node using scripts.</i>  <i>By the way, if anyone knows the filer's solution to one external host without using scripts and dynamic routing protocols, share the recipe.</i> <br><br><h2>  <b>Load balancing</b> </h2><br>  Now let's look at another scheme: <br><br><img src="https://habrastorage.org/files/cdc/095/b68/cdc095b68181428e8310af718340881b.png" alt="image"><br><br>  In it, the second second channel is no longer reserve, but equivalent.  Why not use both channels at the same time, thus increasing throughput? <br><br><h3>  We start to customize load balancing </h3><br>  <i>The first rule of Load Balancing</i> is to monitor connections: to reply to an incoming connection from the same address to which it arrived.  For outgoing connections - send packets only through the address with which the connection was established. <br><br>  <i>The second thing that is also important to understand</i> is the need to separate the concepts of incoming and outgoing traffic.  The fact is that for outgoing traffic the router can decide which way it will go, and incoming traffic for it as ‚ÄúSchr√∂dinger traffic‚Äù.  While it is not there, our mikrotik does not know which interface it will come through, and when it came, it‚Äôs already too late to change the interface. <br><br>  <i>Third</i> , channel balancing is not a reservation.  These are two separate functions. <br><br><div class="spoiler">  <b class="spoiler_title">By the way, why do we deal with connections and not packets when dividing traffic?</b> <div class="spoiler_text">  Read how the TCP protocol works.  In short, the task of the TCP protocol is not only to throw a packet at the receiver, but also to control how it received it.  This is done using the connection setup, within which, in fact, the data packets are transmitted - along with the service information.  If you operate with packets and forget about connections, then there are situations when a remote host, after establishing a connection with one address, simply discards some of the packets that came from the second, the ‚Äúwrong‚Äù address. <br></div></div><br><br><h4>  Getting ready to accept "Schr√∂dinger traffic" </h4><br>  So, with any channel balancing option, we first need to prepare for accepting incoming traffic and teach mikrotik to respond to incoming connections to the same channel from which they came.  Using connection marking and subsequent marking of routes for them, we, in fact, make several routing tables, separate for each external address. <br><br><div class="spoiler">  <b class="spoiler_title">initial configuration for load balancing with two external IP addresses</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat #        : /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 #      ,   ,   -   . /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP1 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP2 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping</code> </pre><br></div></div><br>  Thus, mikrotik will conduct each packet of the labeled connection according to the corresponding routing table and external addresses (10.100.1.1, 10.200.1.1) will be accessible from the outside without confusion in the channels and routes. <br><br><h3>  We divide the outgoing traffic </h3><br>  To distribute outgoing traffic across interfaces, we just need to hang the appropriate route mark for the connection.  The difficulty is that you need to decide on which connection to hang the ISP1 tag, and on which ISP2. <br><br>  There are several options for the separation of compounds into groups: <br><br><h4>  1) We divide outgoing traffic, screwing the brand tightly </h4><br>  Rules balancing traffic, we can write hard: <br>  For example, we want to configure the HTTP protocols (80 port), HTTPS (443 port), POP (110 port), SMTP (25 port) via ISP1, which are important for us, and all other traffic through the second provider: <br><br><div class="spoiler">  <b class="spoiler_title">channel balanced configuration according to strict rules</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat #        : /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 #      ,   ,   -   . /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP1 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP2 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #failover        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 #      <span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">25</span></span>  ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=prerouting action=mark-routing <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark="lan_out_ISP1" passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">25</span></span> protocol=tcp #     ISP2: /ip firewall <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=prerouting action=mark-routing <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark="lan_out_ISP2" passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      LAN   : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #failover        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2</code> </pre><br></div></div><br><br><h4>  2) We divide outgoing traffic, choosing every Nth connection </h4><br>  We can divide the compounds in order.  The first to the left, the second - to the right.  It's simple. <br><br><div class="spoiler">  <b class="spoiler_title">configuration with channel balancing on the N-th connection:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat #        : /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 #      ,   ,   -   . /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP1 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP2 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway         : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #         ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP1 nth=<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> #     ISP2 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP2 nth=<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      LAN   : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #failover        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2</code> </pre><br></div></div><br><br><h4>  3) We divide outgoing traffic using PCC (per connection classifier) </h4><br>  PCC approaches the traffic division a bit more complicated.  It divides traffic into groups based on TCP header data (src-address, dst-address, src-port, dst-port). <br><br><div class="spoiler">  <b class="spoiler_title">PPC channel balanced configuration:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat #        : /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 #      ,   ,   -   . /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP1 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP2 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #failover        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 # PPC       .    /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP1 per-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-classifier=src-address-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-port:<span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP2 per-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-classifier=src-address-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-port:<span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      LAN   : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #failover        /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP1 /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">2</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=lan_out_ISP2</code> </pre><br></div></div><br><br><h4>  We divide outbound traffic using ECMP (equal cost multipath routing) </h4><br>  In my opinion, the easiest and most delicious way to separate traffic: <br><br><div class="spoiler">  <b class="spoiler_title">channel balanced configuration via ECMP</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#   : /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP1 /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=ISP2 #    /ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> interface=LAN #   NAT       /ip firewall nat <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=masquerade chain=srcnat #        : /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 #      ,   ,   -   . /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP1 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-routing chain=output <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=cin_ISP2 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=rout_ISP2 passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway      : /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=rout_ISP2 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping #      /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=mixed # ECMP       /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>,<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> routing-mark=mixed</code> </pre><br></div></div><br>  Mikrotik will divide traffic by gateway itself using the round-robin algorithm. <br><br>  By the way, in version 6. RouterOS mikrotik broke the check-gateway in ECMP, so use the construction <br>  <i>/ ip route add gateway = 10.100.1.254,10.200.1.254 check-gateway = ping is</i> possible and logical, but completely useless. <br>  To mark non-live routes in ECMP, you need to create additional routes that use each of the gateways separately.  With the included check-gateway, of course.  Marking a route inactive, mikrotik does it for everyone. <br><br><h4>  And the last important note about the speed of the channels. </h4><br>  Take 2 unequal channels, for example, 100 Mbps and 50 Mbps.  We balance them via Nth, PCC or ECMP.  What total bandwidth we get? <br><br>  In fact, somewhere around 100 Mbps (the weakest channel X times). <br>  This happens because mikrotik has no idea about the bandwidth of the channels, it does not measure it.  It simply divides the traffic into relatively equal groups. <br><br>  You can overcome this nuance by properly designing outbound traffic groups, taking into account the capacity of the channels. <br><br><div class="spoiler">  <b class="spoiler_title">for example</b> <div class="spoiler_text">  in ECMP, this can be done by specifying a faster gateway several times, thereby increasing the frequency of its use. <br><pre> <code class="hljs cs">/ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>,<span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>,<span class="hljs-number"><span class="hljs-number">10.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span></code> </pre><br><br>  In the PCC, unequal groups can also be made: <br><br><pre> <code class="hljs pgsql">/ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP1 per-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-classifier=src-address-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-port:<span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP1 per-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-classifier=src-address-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-port:<span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> src-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=mark-routing chain=prerouting <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=lan_out_ISP2 per-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-classifier=src-address-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-port:<span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br></div></div><br><br>  Thanks for attention. <br><br>  Good luck in setting up trouble-free routing systems. </div><p>Source: <a href="https://habr.com/ru/post/244385/">https://habr.com/ru/post/244385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244373/index.html">Raising the ‚Äúvirtualka‚Äù chroot with ubuntu to build packages</a></li>
<li><a href="../244375/index.html">IBM invites to the IBM SolutionsConnect 2014 conference</a></li>
<li><a href="../244379/index.html">Interview with Rudi Hein: bestseller developer shares the secrets of the success of their applications</a></li>
<li><a href="../244381/index.html">The first experience in game development. Errors and conclusions</a></li>
<li><a href="../244383/index.html">IPv6 at gunpoint</a></li>
<li><a href="../244387/index.html">We introduce material design</a></li>
<li><a href="../244389/index.html">Flash Drive OneDrive - portable version for OneDrive</a></li>
<li><a href="../244391/index.html">Prepare a sleigh in the summer: Check your readiness for holiday sales (before customers do this)</a></li>
<li><a href="../244395/index.html">Samsung EYECAN + - mouse for people with disabilities</a></li>
<li><a href="../244397/index.html">Monetization of Oculus Rift and Leap motion in quests in reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>