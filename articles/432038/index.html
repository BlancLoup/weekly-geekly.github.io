<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On-click fame, or how to excite the robot and ... the rest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, overheard conversation took place at the facade of a far-distant store : 


NB: - ?  
 GURU : - ¬´¬ª . .    .   ,  ... 
 


 NB: - , ? ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On-click fame, or how to excite the robot and ... the rest</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/px/hq/po/pxhqpot6x9sqphxahh2fzhk4pz8.png"><br><br>  A long time ago, overheard conversation took place <strike>at the facade of a far-distant store</strike> : <br><blockquote><pre><code class="plaintext hljs">NB: -         ?</code> </pre> <br> <code><b>GURU</b> : -    ¬´¬ª      . . <b> </b>   <b></b> .  <b> </b> ,         <b></b> ...</code> <br> <br><pre> <code class="plaintext hljs">NB: -      ,     ?</code> </pre> <br> <code><b>GURU</b> : -    <strong>google</strong>   <b>yandex</b>  ,    .    <b></b>       .    ,      .</code> <br> <br><pre> <code class="plaintext hljs">NB: -       ?</code> </pre> <br> <code><b>GURU</b> : - ?‚Ä¶   <strong></strong> ...</code> <br> </blockquote>  <b>NB</b> stopped asking, apparently fearing to annoy a clearly more experienced interlocutor. <br>  <b>GURU</b> rolled his eyes, as if emphasizing the exhaustion of the topic about the proxy and was silent ... <br><a name="habracut"></a><br>  Of course, <strong>GURU</strong> knew that a search query (for example by the word: proxy) would very soon lead <strong>NB</strong> to get the desired list ‚Äúaddress: port‚Äù.  But after the first experiments, <strong>NB</strong> , just as quickly, will understand: <br><br><ul><li>  Not all addresses on his list are working; </li><li>  Not all proxies are equally good; </li><li>  "Click" site through a proxy manually - a task that requires considerable will; </li><li>  "Not correct" proxy will harm the situation, because  site may be suspected scripts giants in cheat. </li></ul><hr><br>  In this article I will talk about how the improvised (and most importantly universal) means <br>  (without the use of specific proprietary software, such as <strong>ZennoPoster</strong> , etc ...) <br>  build an automated tool for obtaining a list of "really suitable" proxies and using them to organize (automated) visits to the promoted <br>  site using a <strong>Chrome browser</strong> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Following the instructions, you will get a ready-made tool that will allow you to: <br><br><ul><li>  "Click" -at (visit) the target site fully automatically, without fear of compromise; </li><li>  fully emulate user behavior; </li><li>  organize all visits on a schedule (scenario); </li><li>  do all of the above in the number of times needed to advance. </li></ul><br>  And although all my work (along with the research) took a week, you will not need two days to build such a tool, having basic knowledge of the <strong>command line</strong> , <b>PHP</b> and <b>JavaScript</b> . <br><hr><br>  However, before you scroll through the <a href="https://habr.com/ru/post/432038/">following diagram</a> , I will say a few words about why and for whom this material was prepared. <br><br>  The material will be useful if you want to understand how structures (? Or constructors?) Are arranged with which you can build an application relatively quickly, which is easily and inexpensively adaptable to changing loads.  If you are interested in the possibility of building an application based on the service bus ( <abbr title="Enterprise service bus">ESB</abbr> ). <br><br>  The text will be useful if you wanted to get acquainted with the use of <strong>Docker</strong> for <b>instantly</b> building systems.  Or, if you are just interested in <strong>Selenium Server</strong> and the nuances of receiving content / display of HTTPx activity. <br><blockquote>  For "use immediately", it is not worth reading it thoughtfully.  Code for sure. </blockquote><div class="spoiler">  <b class="spoiler_title">Immediately proceed to setting up the finished tool.</b>  <b class="spoiler_title">Setup takes less than 20 minutes.</b> <div class="spoiler_text">  The instruction assumes that you have 2 machines with Ubuntu 18.04 installed. <br>  One for infrastructure ( <b>docker</b> ), the other for process control ( <b>process</b> ). <br><br>  It is assumed that the following packages are already installed on <b>docker</b> : <br><blockquote>  <i>git, docker, docker-compose</i> </blockquote><br>  It is assumed that the following packages are already installed on the <b>process</b> : <br><blockquote>  <i>git, php-common, php-cli, php-curl, php-zip, php-memcached, composer</i> </blockquote>  If you have any questions at this place, I suggest that you spend 15 minutes reading all the material in full. <br><br>  <strong>docker</strong> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    root-. # ,     TCP-: # 11300, 11211, 4444, 5930, 8080, 8081, 8082, 8083 #        # " root-"    git clone \ https://oauth2:YRGzV8Ktx2ztoZg_oZZL@git.ituse.ru/deploy/esb-infrastructure.git cd esb-infrastructure docker-compose up --build -d #      3     #   . #       web-.</span></span></code> </pre><br>  <strong>process</strong> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      . #      process-   , #     -  php- git clone \ https://oauth2:YRGzV8Ktx2ztoZg_oZZL@git.ituse.ru/deploy/clicker-noserver.git cd clicker-noserver composer update #  .       "XXXXXXXX" mv app/settings.php.dist app/settings.php #   . gnome-terminal \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php curl"' \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php timezone"' \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php whoer"' #  . ,     , #  : - log/list.proxy php app/src/Utils/givethejob.php ./log/list.proxy</span></span></code> </pre><br>  Wait, watching what is happening through the web-panel (http: // ip-address-docker-machines: 8080). <br>  The result will be available in the <i>located</i> queue. <br></div></div><a name="scheme"></a><br><h2>  Crushing and planning </h2><br><img src="https://habrastorage.org/webt/6e/1w/nc/6e1wnczv0tchzm_sq9pey6avk2o.png"><br><br>  The diagram above describes the sequence of process steps, the expected result for each step, and the resources that will be required to create each of the parts (details: <a href="https://habr.com/ru/post/432038/">Task 2</a> , <a href="https://habr.com/ru/post/432038/">Task 3</a> , <a href="https://habr.com/ru/post/432038/">Task 4,5,6</a> ). <br><br>  In my case, everything happens on two <strong>Ubuntu 18.04</strong> machines.  One of them controls the process.  On the other, several Docker containers of infrastructure are running. <br><br><blockquote><h4>  Excuses and failures </h4><br>  All package code consists of three parts. <br>  One of them is not mine (I note that this is a neat and beautiful code).  The source of this code is <a href="https://packagist.org/" title="packagist.org">packagist.org</a> . <br><br>  I wrote another one myself, tried to make it understandable and devoted about a week to this part of the code. <br><br>  The rest is ‚Äúa difficult historical legacy.‚Äù  This part of the code has been created for quite a long time.  Including in that period when I still did not have a great knack for programming. <br><br>  This is exactly the reason for the location of the repositories on my <strong>GitLab</strong> and the packages on my <strong>Satis</strong> .  For publication on <a href="https://github.com/loandbeholdru" title="GitHub.com">GitHub.com</a> and <a href="https://packagist.org/users/loandbeholdru/packages/" title="packagist.org">packagist.org,</a> this code will require processing and more thorough documentation. <br><br>  All parts of the code are open for unlimited use.  Repositories and packages will be available "forever." <br><br>  However, when re-publishing the code, I will be grateful for you to post a link to me or to this article. <br></blockquote><br><h2>  A bit about architecture </h2><br>  The approach that was used to create our tool is to write (or use a ready-made) utility to solve each specific task.  Moreover, each utility, regardless of the problem being solved, has two properties common to all: <br><br><ul><li>  the utility can be run independently of the rest from the command line with parameters containing the task; </li><li>  The utility can return the execution result to stdout (if configured in a certain way). </li></ul><br>  A solution made according to this principle allows changing the number of running task handlers (workers) for each of the process steps.  A different number of workers for each step will result in ‚Äú0‚Äù idle time of the next steps due to the processing time of the tasks of the previous steps. <br><br>  The time spent on obtaining the unit of the result of the process (in our case, it is a verified proxy) depends on external factors (the number of invalid proxies, the response time of the external resource, etc.). <br><br>  By changing the number of workers for each of the process steps, we transform this dependence into dependence on the number of launched workers (that is, dependence on the computing and channel capacities involved). <br><br>  To synchronize the work of individual independent parts, it is convenient to use the messaging queue server as a single data bus.  It will allow you to accumulate the results of completed steps in a queue and give them to the ‚Äúnext step‚Äù utility at the right time as input. <br><br><h3>  Messaging queue.  MQ and ESB </h3><br>  We will use <a href="https://habr.com/company/shopozzcom/blog/240483/" title="Great review article">beanstalkd</a> as the lower level ( <abbr title="Message queue">MQ</abbr> ).  Small, light, not requiring configuration, available in the deb-package and in the Docker-container, imperceptible worker.  The logical level ( <abbr title="Enterprise service bus">ESB</abbr> ) will implement the code in <strong>PHP</strong> . <br><br>  Two classes will be used for implementation.  <b>esbTask</b> and <b>nextStepWorker</b> . <br><br>  <b>esbTask</b> <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">esbTask</span></span></span><span class="hljs-class"> //   ,     </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// immutable-; // "" (   ESB-),  payload //    //     "" .... }</span></span></code> </pre><br>  An instance of this class serves to ‚Äúaddress‚Äù <abbr title="Payload">paylod</abbr> 'a through the steps of the process.  The concept of <abbr title="Enterprise service bus">ESB</abbr> applied several principles / patterns.  Two of them should pay attention separately: <br><br><ul><li>  About the path (sequence of steps) of the process, at each time point of the process implementation, <br>  no one knows other than the envelope being sent; <br></li><li>  Each envelope has three possible directions of outcome: <br><ul><li>  the next step of the process (normal continuation); </li><li>  stop pitch (stop target - selected by the next step, if there is no point in continuing the process / stop-situation); <br></li><li>  Error step (target of emergency termination - is selected by the next step, in case of a worker error). <br></li></ul><br></li></ul><div class="spoiler">  <b class="spoiler_title">In the queue, the object is represented in json, hidden here ...</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// json- esbTask { //    (   esbTask) "_type":"App\\\\rebean\\\\payloads\\\\ESBtaskQueue", //  "task":"task:queue@XXX.XXX.XXX.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">11300", //    () "replyto":[ "othertask1:nextqueue1@yyy.XXX.XXX.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">11300", "othertask2:nextqueue2", "othertask3:nextqueue3", ], //    () "onerror":[ "error:errorsstep@zzz.XXX.XXX.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">11300", "error:errorsstep1", "error:errorsstep2", "error:errorsstep3" ], //     () "onstop":[ "stop:stopstep@kkk.XXX.XXX.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">11300", "stop:stopstep1", "stop:stopstep2", "stop:stopstep3" ], //   "payload":{ .... }, //   ... () "till":[ .... ], //     ... () //        // -  (LINUX-TimeStamp) "since":[ 1540073089.8833, ], // -     "points":1, //  .     "groupid":"" }</span></span></code> </pre><br></div></div><br>  <b>nextStepWorker</b> <br><br>  Each message in the queue is processed by the worker who is responsible for it.  The following feature set is implemented for this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nextStepWorker</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">workerConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       //     esbTask //    () //    MQ- (beanstalkd) //     (Memcached) //     (MySQL) // : -  (  - ); -    stop-; -      (log, event, mq) .... }</span></span></code> </pre><br>  On the basis of this class, workers are implemented for each of the stages of the process.  The whole routine of processing, addressing and sending to the next queue in the route, the class takes over. <br><br>  The solution to each of the tasks is to ensure that: <br><br><ol><li>  Get esbTask and run the worker; </li><li>  Implement the logic, saving the results in payload; </li><li>  Complete the execution of the worker (emergency or normal - it does not matter). </li></ol><br>  If the steps are completed, the result will go to the queue with the appropriate name and the next worker will begin processing. <br><a name="subj2"></a><br><h2>  Do it once.  Check availability </h2><br>  In fact, creating a worker for solving any of the tasks is an implementation of a single method.  An example (simplified) implementation of a worker who performs Task <a href="https://habr.com/ru/post/432038/">2 is</a> as follows: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Process/worker/curlChecker.php .... class curlChecker extends nextStepWorker { const PROXY_INFO = 'https://api.ipfy.me?format=json&amp;geo=true'; const PROXY_TIMEOUT = '40'; const COMMAND = "curl -m %s -Lx http://%s:%s '%s'"; public function logic() { //    .  ..   payload extract($this-&gt;context()); //  defaults    payload  $curltimeout = $curltimeout ?? self::PROXY_TIMEOUT; $curlchecker = $curlchecker ?? self::PROXY_INFO; //     $line = sprintf( static::COMMAND, $curltimeout, $host, $port, $curlchecker ); exec($line, $info); //      // ( ,  stop-) $info = arrays::valid_json(implode('', info)); if (empty($info)) throw new \Exception("Bad proxy: $host:$port!", static::STATUS_STOP); //    payload $this-&gt;enrich(['info']) -&gt;sets(compact('info')); } }</span></span></code> </pre><br>  A few lines of code and everything is done and ‚Äúseconded‚Äù to the next stage. <br><a name="subj3"></a><br><h2>  Determine TimeZone.  TimeZoneDB and what is it for ... </h2><br>  In-depth testing of incoming requests includes matching the time of the browser window with the time in which the IP address-source-request exists. <br><br>  To avoid suspicion from the side of counters, we need to know the local proxy time. <br><br>  To find out the time, take the latitude and longitude from the results of the previous step of the process and get data about the time zone in which our future instance of the browser window will work.  These data will provide us with <a href="https://clck.ru/Emsr3" title="timezonedb.com">professionals in the field of time</a> . <br><br>  A simplified worker for solving this task ( <a href="https://habr.com/ru/post/432038/">Problem 3</a> ) will be completely similar to the <a href="https://habr.com/ru/post/432038/">previous one</a> .  The only difference is in the request URL.  You can find the full version in the file: <br><blockquote>  // app / src / Process / worker / timeZone.php </blockquote><br><h2>  Little about infrastructure </h2><br>  In addition to the described <strong>beanstalkd</strong> , our tool will need: <br><br><ul><li>  <strong>Memcached</strong> - for caching tasks; </li><li>  <strong>Selenium Server</strong> - it is convenient to run <strong>Selenium Web Driver</strong> in a separate container and you can monitor the process via <strong>VNC</strong> ; </li><li>  Panels for monitoring <strong>beanstald</strong> , <strong>memcached</strong> and <strong>vnc</strong> . </li></ul><br>  Docker is very convenient for quick deployment of all this ( <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" title="Official Docker Documentation">How to install on Ubuntu</a> ). <br><br><div class="spoiler">  <b class="spoiler_title">And the "orchestrator" for him is docker-compose (commands for installation) ...</b> <div class="spoiler_text"><pre> <code class="bash hljs">sudo apt-get -y update sudo apt-get -y install docker-compose</code> </pre><br></div></div><br>  These tools allow you to run already configured and configured (by someone earlier) server / processes in separate ‚Äúcontainers‚Äù of the parent OS.  For details, I recommend to refer to <a href="https://habr.com/post/310460/" title="Good Docker article">this</a> or to <a href="https://habr.com/post/277699/" title="Another Good Docker Article">this</a> article. <br><br>  So‚Ä¶ <br><br>  To start the infrastructure, you need several commands in the console: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    docker- #     (   ) #    sudo -s git clone \ https://oauth2:YRGzV8Ktx2ztoZg_oZZL@git.ituse.ru/deploy/esb-infrastructure.git \ panels cd panels docker-compose up --build -d #   .</span></span></code> </pre><br>  As a result of successful execution of the command on the machine with the address XXX.XXX.XXX.XXX, <br>  You will receive the following set of services: <br><blockquote>  - XXX.XXX.XXX.XXX:11300 - <strong>beanstalkd</strong> <br>  - XXX.XXX.XXX.XXX:11211 - <strong>Memcached</strong> <br>  - XXX.XXX.XXX.XXX:4444 - <strong>Selenium Server</strong> <br>  - XXX.XXX.XXX.XXX:5930 - <b>VNC</b> -server to control what is happening in <b>Chrome</b> <br>  - XXX.XXX.XXX.XXX:8081 - Web panel for communication with <strong>Memcached</strong> (admin: pass) <br>  - XXX.XXX.XXX.XXX:8082 - A web panel to communicate with <strong>beanstalkd</strong> <br>  - XXX.XXX.XXX.XXX:8083 - Web panel for communication with <strong>VNC</strong> (password: secret) <br>  - XXX.XXX.XXX.XXX:8080 - Shared web panel <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">"See if everything is in place", "get into the console to the container", "stop the infrastructure" can be commands in the spoiler.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    docker-, #    ..../panels/ #    docker-compose ps # Name Command State Ports # ------------------------------------------------------------------------------------------------------------------------ # beanstalkd /usr/bin/beanstalkd Up 0.0.0.0:11300-&gt;11300/tcp # chrome start-cron Up 0.0.0.0:4444-&gt;4444/tcp, 0.0.0.0:5930-&gt;5900/tcp # memcached docker-entrypoint.sh memcached Up 0.0.0.0:11211-&gt;11211/tcp # nginx docker-php-entrypoint /sta ... Up 0.0.0.0:8443-&gt;443/tcp, 0.0.0.0:8080-&gt;80/tcp, # 0.0.0.0:8082-&gt;8082/tcp, 0.0.0.0:8083-&gt;8083/tcp, 9000/tcp # vnc /usr/bin/supervisord -c /e ... Up 0.0.0.0:8081-&gt;8081/tcp #       chrome docker exec -ti chrome /bin/bash #       docker-compose stop &amp;&amp; docker rm $(docker ps -a -q)</span></span></code> </pre></div></div><a name="subjs"></a><br><h2>  Tasks 4,5,6 - we unite in one utility </h2><br>  Looking in detail at the fragmentation of the tasks ( <a href="https://habr.com/ru/post/432038/">scheme above</a> ), it is easy to verify that only one of the remaining tasks ( <a href="https://habr.com/ru/post/432038/">task 6</a> ) depends on an external resource.  Performing tasks with ‚Äúconditionally guaranteed‚Äù execution time (not dependent on uncontrollable factors), we will not receive additional advantages to the speed of the whole process.  In this regard, these tasks ( <a href="https://habr.com/ru/post/432038/">4,5,6</a> ) were merged into one worker.  The worker file is called: <br><blockquote>  // app / src / Process / worker / whoerChecker.php </blockquote><br><h3>  Make settings for Chrome.  Plugins </h3><br>  <strong>Chrome is</strong> flexibly configured using plugins. <br><br>  The plugin for <strong>Chrome</strong> is an archive that contains a file <i>manifest.json</i> .  He describes the plugin.  The archive also contains a set of <b>JavaScript, html, css and other</b> files required by the plugin ( <a href="https://developer.chrome.com/extensions/manifest" title="Official Chrome Documentation">details</a> ). <br><br>  In our case, one of the <b>JavaScript</b> files will be executed in the context of the <strong>Chrome</strong> working window and all the necessary settings will take effect. <br><br>  We just need to take the plug-in template and substitute the necessary data in the right places (interaction protocol, address and port, or Timezone) for the proxy server under test. <br><br>  The code snippet that makes the archive: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Chrome/proxyHelper.php .... class proxyHelper extends sshDocker{ .... // $name -  - // $files - [ ... '   -' =&gt; '', ...] protected function buildPlugin(string $name, array $files) { $this-&gt;last = "$this-&gt;cache/$name"; if (!file_exists("$this-&gt;last")) { $zip = new \ZipArchive(); $zip-&gt;open("$this-&gt;last", \ZipArchive::CREATE | \ZipArchive::OVERWRITE); foreach ($files as $n =&gt; $data) { $zip-&gt;addFromString(basename($n), $data); } $zip-&gt;close(); } $this-&gt;all[] = $this-&gt;last; $this-&gt;all = array_unique($this-&gt;all); return $this; } .... }</span></span></code> </pre><br>  The template for the plugin that configures the proxy was found <a href="https://clck.ru/Emsqk" title="plugin repository to install proxy in Chrome">in the piggy bank of the results of work of people who love their profession</a> , changed in part of the protocol, and added to the repository. <br><br><h3>  Window time change </h3><br>  To change the global time of the running instance of Chrome, we need to replace <i>window.Date</i> with a class with the same functionality, but acting in the correct time zone. <br><br>  I am very grateful <a href="https://clck.ru/Emsqm" title="plugin repository for changing window time in Chrome">for the work of Sampo Juustila</a> .  The script was made for automated testing of <abbr title="User interface">UI</abbr> , but after a small refinement was applied. <br><br>  There is a nuance to which I want to draw your attention.  It is related to the execution context of the scripts described in <i>manifest.json</i> . <br><br>  The whole secret is that the global context (the one in which the main script of the plug-in is launched and the settings, for example, connected with the network) is isolated from the context of the tab into which the page is loaded. <br><br>  Empirically, it was found that the impact on the class prototype in a global context did not change it in the tab.  However, by registering the script in the already loaded page and executing it before the rest, the task was solved. <br><br>  The solution is represented by the following code snippet: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/chromePlugins/timeShift/content.js //     var s = document.createElement('script'); //        s.src = chrome.extension.getURL('timeshift.js'); //      (document.head || document.documentElement).appendChild(s);</span></span></code> </pre><br><h3>  Proxy settings </h3><br><div class="spoiler">  <b class="spoiler_title">Setting up a proxy in Chrome is so simple that I will hide the js code in the spoiler</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/chromePlugins/proxy/background.js var config = { mode: "fixed_servers", rules: { singleProxy: { scheme: "%scheme", host: "%proxy_host", port: parseInt(%proxy_port) }, bypassList: ["foobar.com"] } }; chrome.proxy.settings.set({value: config, scope: "regular"}, function () { }); function callbackFn(details) { return { authCredentials: { username: "%username", password: "%password" } }; } chrome.webRequest.onAuthRequired.addListener( callbackFn, {urls: ["&amp;gtall_urls&amp;lt"]}, ['blocking'] );</span></span></code> </pre><br></div></div><br><h3>  Chrome Plugins Path </h3><br><div class="spoiler">  <b class="spoiler_title">All plug-ins are named according to the scheme and stored in a temporary folder of the machine controlling the process.</b> <div class="spoiler_text"><blockquote>  // naming scheme for proxy plugin: <br>  proxy- [address] - [port] - [protocol]&gt;. zip <br>  timeshift - ["-" | ""] - [shift_in_minute_ot_GMT] .zip </blockquote></div></div><br>  Next, we need to install these plugins into the docker container that runs on the machine responsible for the infrastructure. <br><br>  We will do this with ssh.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this, I met </font></font><a href="https://packagist.org/packages/phpseclib/phpseclib" title="Packpist.org phpseclib package"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">phpseclib</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (even though I later regretted it). </font><font style="vertical-align: inherit;">Fascinated by the unusual behavior of the library, I spent the day studying it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ssh console client here will work better and will work faster, but the work has already been done. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the low level (working with SFTP and SSH) the base class is responsible (below). </font><font style="vertical-align: inherit;">Replacing this class will allow </font></font><a href="https://github.com/phpseclib/phpseclib" title="Phpseclib repository"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">phpseclib</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font><font style="vertical-align: inherit;">be replaced </font><a href="https://github.com/phpseclib/phpseclib" title=" phpseclib"><font style="vertical-align: inherit;">with</font></a><font style="vertical-align: inherit;"> a console client.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Chrome/sshDocker.php //    (DOCKER_HOST, DOCKER_USER, DOCKER_PASS) //   : app/settings.php //      .... class sshDocker { .... //  .     docker //    .         // : app/techs.php const EXEC_DOCKER = DOCKER_BIN_PATH . "/docker exec -i %s %s"; .... //     sudo    (  ),  DOCKER_USER -  protected function sudo(string $command, string $expect = '.*'){...} //     Docker-,      //       -    self::EXEC_DOCKER protected function execDocker(string $command, string $expect){...} .... }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Generated from the base sshDocker and already known to us proxyHelper class not only produces plugins, but also puts them into the temporary folder of the infrastructure container. </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Chrome/proxyHelper.php .... class proxyHelper extends sshDocker { .... public static function new(string $docker, $plugins) { return (new self($docker, $plugins)) -&gt;setupPlugins(); } .... }</span></span></code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Run Chome with settings </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch a customized </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help us </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium Server is a frame-work created by the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FaceBook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> team </font><font style="vertical-align: inherit;">specifically for testing WEB-interfaces. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Framework allows a developer to programmatically emulate any user action in a browser window (using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firefox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium Server is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adapted for use with many languages ‚Äã‚Äãand is the de facto standard tool for writing test scripts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The best way to get a fresh release for use in a project:</font></font><br><br><pre> <code class="bash hljs">composer require facebook/webdriver</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The traditional configuration of the main instance of a Selenium Server object (RemoteWebDriver) seemed to me verbose.</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// URL- $url = "https://example.com/books/196/empire-v-povest-o-nastoyashem-sverhcheloveke"; // URL,     (Selenium Server) $server = 'http://' . DOCKER_HOST . '/wd/hub'; //   ,      $options = new ChromeOptions(); $options-&gt;addArguments(array( '--disable-notifications' )); //    - $capabilities = DesiredCapabilities::chrome(); $capabilities-&gt;setCapability(ChromeOptions::CAPABILITY, $options); //        5000     URL $driver = RemoteWebDriver::create($server, $capabilities, 5000); $page = $driver-&gt;get($url);</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And therefore, I have a little reduced all this, having optimized configuration for my needs: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Process/worker/whoerChecker.php .... class whoerChecker extends nextStepWorker { //    : app/settings.php // URL Selenium Server const SELENIUM_SERVER = CHVM; //  - const DOCKER_NAME = DOCKER_NAME; .... public function config() .... //        : // $driver = RemoteWebDriver::create($server, $capabilities, 5000); $chrome = Chrome::driver( static::SELENIUM_SERVER, Chrome::capabilities(static::DOCKER_NAME, $plugins), 5000 ); .... } ....</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The eye immediately clings to $ plugins. </font><font style="vertical-align: inherit;">$ plugins is a data structure that is responsible for configuring plugins. </font><font style="vertical-align: inherit;">For each directory and for replacing placeholders in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> files of the plugin.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The structure is described in the app / plugs.php file and is part of the global app / settings.php options.</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/plugs.php const PLUGS = [ 'timeshift' =&gt; [ 'path' =&gt; PROJECTPATH . '/app/chromePlugins/timeShift', 'files' =&gt; ['manifest.json', 'timeshift.js', 'content.js'], 'fields' =&gt; ['%addsminutes' =&gt; 'timeshift'] ], 'proxy' =&gt; [ 'path' =&gt; PROJECTPATH . '/app/chromePlugins/proxy', 'files' =&gt; ['manifest.json', 'background.js'], 'fields' =&gt; [ '%proxy_host' =&gt; 'host', '%proxy_port' =&gt; 'port', '%scheme' =&gt; 'scheme', '%username' =&gt; 'user', '%password' =&gt; 'pass' ] ] ];</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parsing a page with </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium WebDriver</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is very simple.</font></font><br><br><pre> <code class="php hljs">.... $url = <span class="hljs-string"><span class="hljs-string">'https://__/_-_'</span></span>; $page = $chrome-&gt;get($url); .... <span class="hljs-comment"><span class="hljs-comment">//   xPath-   $xpath = '/html[1]/body[1]/div[1]/div[1]/div[1]/div[2]/div[1]/div[1]/div[1]/div[1]/strong[1]'; $element = page-&gt;findElement(WebDriverBy::xpath($xpath)); .... //   $text = $element-&gt;getText(); // HTML- $html = $element-&gt;&gt;getAttribute('innerHTML'); ....</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I already wrote, all these actions are implemented by the third-step utility ( </font></font><a href="https://habr.com/ru/post/432038/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task 4,5,6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // app / src / Process / worker / whoerChecker.php </font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finishing the description of working with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I want to draw your attention to the fact that when using this technology on an industrial scale (1000 - 3000 page openings), there are often situations when a session with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ends incorrectly. The window is abandoned. And such windows can accumulate a lot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are several ways to combat the ‚Äúbrooches‚Äù. Work "ate" 2 days. The most effective was </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cron</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Its proper installation and configuration in the Docker container has become a separate task, carefully and very thoroughly described by </font></font><a href="https://habr.com/users/renskiy/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renskiy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://habr.com/company/redmadrobot/blog/305364/" title="An article on how to properly use cron inside a docker container"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in an article devoted ONLY TO THIS TOPIC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (which I was surprised by).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatic reassembly of the original Docker-image and the installation of several scripts for closing brooches and clearing unused plug-ins is described in the docker-compose.yml, </font></font><a href="https://companion.xalatov.com/repo/habr-clicker-noserver" title="Detailed description of the installation of clicker and docker-infrastructure from the repository"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">infrastructure repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The frequency of cleaning is set in the killcron file of the same repository.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Webrtc </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that we have already set the correct time, and the traffic of our browser goes through a proxy, we can still be detected. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the time difference (browser and IP address), there are two more sources of deanonymization of "sitting at the proxy". </font><font style="vertical-align: inherit;">These are flash and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> technologies embedded in the browser. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> disabled </font><font style="vertical-align: inherit;">in our browser </font><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is not. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The reason for the two possibilities of failure is the same - the ubiquitous and nimble </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> packets. </font><font style="vertical-align: inherit;">For </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> these are two ports: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3478</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">19302</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To stop the exodus of the ‚Äúscouts‚Äù from the ‚Äúchrome‚Äù container, the iptables rule is applied on the host machine with the infrastructure containers:</font></font><br><br><pre> <code class="bash hljs">iptables -t raw -I PREROUTING -p udp -m multiport --dports 3478,19302 -j DROP</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This task is implemented by the same proxyHelper. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The remaining workers </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To successfully achieve the goal - the implementation of a "click" on the target site via an anonymous proxy, we need another worker. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be a truncated version of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoerChecker</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I think to do it yourself, using all that is written, is not difficult. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result of the work of the whole process, which falls into the queue </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">located</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , contains data on the ‚Äúdegree‚Äù of anonymity of each proxy server that passes the address verification. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When ‚Äúplaying‚Äù against counters, the main thing is to remember about anonymity and not to get carried away with robotic visits. </font><font style="vertical-align: inherit;">Observance of the principle ‚Äúdo not get carried away with clicks‚Äù is ensured by the possibility of organizing actions on a schedule, which is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">embodied</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><i><font style="vertical-align: inherit;">esbTask</font></i><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">since the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field of </font><font style="vertical-align: inherit;">our </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> envelope).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you try and do everything neatly, then the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yandex-metric of the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> target site will be similar to the figure below.</font></font><br><br><img src="https://habrastorage.org/webt/es/wn/kk/eswnkk5esmtcunc6xvpn90ndefw.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to put everything together </font></font></h2><br>  So, given: <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilities that are able to accept "as input" (as a command line argument) </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esbTask</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> json-string view and execute some logic, and send the results to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beanstalkd</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">message queue ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), based on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beanstalkd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linux machine (Process machine); </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With this "given", usually, I use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libevent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">React PHP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All this, complemented by several tools, allows you to manage the number (within specified limits) of instances of handlers for each stage of the process automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, given the size of the article and the specifics of the topic, I will be happy to describe all this in a separate article. </font><font style="vertical-align: inherit;">This article is a " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noserver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">technology </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Future material is " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><blockquote><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The date of its publication is connected with your interest, Dear Reader.</font></font></b> <div class="spoiler_text"><blockquote>      .      , ,‚Ä¶ . ,  ,    ,   ,     ,         . <br><br>   <b>habr</b>   ,     . , ,          . <br><br>        .     ,        " <b>server</b> ",       <b>README.md</b>         <a href="https://companion.xalatov.com/repo/habr-clicker-noserver" title="   clicker  docker-  "> </a> . </blockquote></div></div></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noserver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", one instance will process one queue (one stage of the process). </font><font style="vertical-align: inherit;">This approach </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can only annoy the spirits</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I use when debugging workers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depending on the required processing speed, you can start as many copies as you want ‚Äúmanually‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It may look like this:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Process/noserver/singleProcess.php //   ,    //   include __DIR__ . '/../../../settings.php'; use App\ESB\pipeNcacheService; use App\arrayNstring\queueDSN; use App\arrayNstring\timeSpent; use App\arrayNstring\progressString; //    $path = __DIR__ . '/../worker'; //   $queues = array_keys(WORKERS); $queue = $argv[1] ?? end($queues); $queue = strtolower($queue); if (!in_array($queue, $queues)) die("php $argv[0] &lt;queue_name&gt;" . PHP_EOL); //  - $progress = new progressString("Listenning... Idle: ", 40, 20); // ,      $stopwatch = timeSpent::start(); //    beanstalkd- list($worker, $task) = WORKERS[$queue]; $procid = ['procid' =&gt; posix_getpid()]; //   beanstalkd  Memcached, //     ( ) $dsn = new queueDSN($task, $queue, ...QUEUE_SERVER); //     ESB- $pnc = new pipeNcacheService($dsn); $pipe = $pnc-&gt;getPipe(); echo "Start listener for queue: $queue." . PHP_EOL; echo "Press Ctrl-C to stop listener." . PHP_EOL; //      //       while (true) { try { $job = $pipe-&gt;watch($queue) -&gt;reserve(1); $now = new DateTime(); $opts = json_encode($pipe-&gt;getPayload($job) + $procid); $pipe-&gt;delete($job); echo PHP_EOL . "Task recived at: " . $now-&gt;format('H:i:s') . " Starting worker: $worker. "; $stopwatch = timeSpent::start(); exec("php $path/$worker $opts", $out); echo "Finished. Time spent: $stopwatch" . PHP_EOL; $stopwatch = timeSpent::start(); } catch (Throwable $exception) { echo $progress($stopwatch('%I:%S', null, $now)); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The strange start of the worker is striking ... Despite the fact that each of the workers is a PHP object, I used </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exec (...)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done in order to save time, not to create separate workers for " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noserver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " or not to change the worker for launch purposes in the " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">mode </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A few words about configuration and deployment </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration Constants </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The configuration of your instance is the file </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / settings.php</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It should be created by you immediately after the repository is cloned. </font><font style="vertical-align: inherit;">To do this, rename the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / settings.php.dist</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All constants are described inside. </font></font><br><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / settings.php</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , among other things, connects files with other constants.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / queues.php</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains the names of queues and tasks </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / plugs.php</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains a description of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plugin </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / techs.php</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains calculated constants</font></font><br></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilities </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the convenience of processing the results of the process and the placement of tasks there are several utilities. </font><font style="vertical-align: inherit;">Utilities run from the command line. </font><font style="vertical-align: inherit;">Equipped with argument descriptions. </font><font style="vertical-align: inherit;">Located: </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / src / Utils</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> backup.php - saves queues to a file</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    clear.php - cleans the queues</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    exporter.php - exports from a file with a saved queue </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     pairs address: port</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    givethejob.php - places tasks for the process </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     (source - file with the address: port).</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     may exclude some addresses from the list</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    restore.php - restores the saved queue </font></font></pre></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fine-tuning workers </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When using written workers, it may be convenient to use the following configuration options: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/src/Process/worker/curlChecker.php .... $worker = new curlChecker( [ //    curlChecker::WORKER =&gt; 'curlchecker', //  beanstalkd curlChecker::PIPE_HOSTPORT =&gt; implode(':', QUEUE_SERVER), //  Memcached curlChecker::CACHE_HOSTPORT =&gt; implode(':', MEMCACHED), // ,    . //    -   curlChecker::DB_SCRIPT =&gt; __DIR__ . '/../../../confdb.php', // ,       // (        -) curlChecker::INFO_START =&gt; CURL_START, // ,        // (        -) curlChecker::INFO_END =&gt; CURL_END, //  ,     //    //        curlChecker::INFO_ADDS_END =&gt; ['host', 'port'] ], ['setupworker', 'config', 'logic'] ); ....</span></span></code> </pre><br><a name="deploy"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deployment </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The instruction assumes that you have 2 machines with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu 18.04</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installed </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One for infrastructure ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), the other for process control ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker</font></font></b> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    root-. # ,     TCP-: # 11300, 11211, 4444, 5930, 8080, 8081, 8082, 8083 #   . sudo -s apt -y update apt -y install git snap snap install docker apt -y install docker-compose # C       # " root-"    cd ~ git clone \ https://oauth2:YRGzV8Ktx2ztoZg_oZZL@git.ituse.ru/deploy/esb-infrastructure.git cd esb-infrastructure docker-compose up --build -d #      3     #   . #       web-.</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process</font></font></b> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      . #   . sudo apt -y update sudo apt -y install git php-common php-cli php-curl php-zip php-memcached composer # C     process-   , #     -  php- cd /var/www git clone \ https://oauth2:YRGzV8Ktx2ztoZg_oZZL@git.ituse.ru/deploy/clicker-noserver.git cd clicker-noserver composer update #  .       "XXXXXXXX" mv app/settings.php.dist app/settings.php #   . gnome-terminal \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php curl"' \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php timezone"' \ --tab -e 'bash -c "php app/src/Process/noserver/singleProcess.php whoer"' #  . ,     , #  : - log/list.proxy php app/src/Utils/givethejob.php ./log/list.proxy</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wait, watching what is happening through the web-panel (http: // ip-address-docker-machines: 8080). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result will be available in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">located</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> queue </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And in conclusion </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surprisingly, writing and editing this article took longer than writing the code itself. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In my opinion, everything could be the other way around (and the difference in time could be several times greater) if it were not for the two ideologies: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Message Queue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enterprise Service Bus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will be very happy if you will find the presented approach to writing applications useful, the load on different parts of which is not clear at the design stage.</font></font><br><br>  Thank. </div><p>Source: <a href="https://habr.com/ru/post/432038/">https://habr.com/ru/post/432038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432024/index.html">Gradle 5.0 - what's new</a></li>
<li><a href="../432030/index.html">The path to the contactless lie detector, or How to arrange a hackathon at maximum speed</a></li>
<li><a href="../432032/index.html">We finish the nailed Google search box</a></li>
<li><a href="../432034/index.html">The book "Electricity step by step" by Rudolph Svoren</a></li>
<li><a href="../432036/index.html">Live: Frontend Infrastructure</a></li>
<li><a href="../432040/index.html">Validators + Aspects: customize validation</a></li>
<li><a href="../432042/index.html">Yandex opens the Cloud. New Platform Architecture</a></li>
<li><a href="../432046/index.html">Graali competition Telecom Data Cup. The hottest to come</a></li>
<li><a href="../432050/index.html">Welcome to the Waves Blockchain Hackathon</a></li>
<li><a href="../432052/index.html">‚ÄúYou are a cool developer, go and ask for more money‚Äù - we will tell managers how the world works</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>