<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moderately Universal Control Device on Raspberry Pi + stratum1 NTP server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 $ (any picture with accordion) 

 Disclaimer: I'm aware that there are already 1000 + 1 implementations of stratum1 NTP servers on RasPi. Min...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moderately Universal Control Device on Raspberry Pi + stratum1 NTP server</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br>  <i>$ (any picture with accordion)</i> <br><br>  Disclaimer: I'm aware that there are already 1000 + 1 implementations of stratum1 NTP servers on RasPi.  Mine will be a thousand.  But still, I really want to tell about it, especially since the result is a device that (a) can be mounted in a rack, (b) performs slightly more tasks than just an NTP server, (c) required some labor, which can be rated by the public <br><a name="habracut"></a><br>  So, the task was set (by myself) as follows: I want to ... <br><ul><li>  some device could be an NTP server, even in the absence of communication with the Internet; </li><li>  the same device could act as a terminal server or as a device for collecting data from a UPS via USB; </li><li>  the same device could be mounted in a standard 19 "rack; </li><li>  the same device had a wired connection to the ethernet network (speed is not critical - all the same, the console ports are configured at 9600); </li><li>  the same device could measure temperature in a rack. </li></ul><br>  I want to emphasize that the minimum price criterion is not set, spare parts were purchased on the basis of some kind of empirical price acceptability. <br><br>  Since by profession I (I don‚Äôt even know how to formulate it more precisely) is somewhat far from the development of electronics, but very close to building systems on Linux, my choice fell on Raspberry Pi (well, plus I already had experience building such a device on RasPi only chips were slightly less, and wretchedness - a little more).  The following components were purchased: <br><ul><li>  Raspberry Pi Model B + itself (RasPi2 is an overhead resource, and more expensive); </li><li>  MeanWell PS-05-5 ‚Äúpower supply unit‚Äù (I checked earlier that 1A is enough to power the whole simple circuit); </li><li>  Adafruit GPS module on board (not bare, because I am still learning how to solder, not up to SMD and BGA); </li><li>  Adafruit RTC-module on the board, based on DS1307 (it‚Äôs not a good NTP server to reset the clock every time it is rebooted); </li><li>  Perma-proto HAT for RasPi by Adafruit; </li><li>  16x2 character LCD-display (there was no monochrome, I had to take it with RGB backlighting, in the end it came in handy); </li><li>  I2C GPIO Expander for display; </li><li>  digital temperature sensors DS18B20; </li><li>  19 "1U plastic case; </li><li>  all sorts to taste. </li></ul><br>  It was decided to connect everything to RasPi as follows: <br><ul><li>  GPS module - via UART (console with / dev / ttyAMA0 was removed); </li><li>  RTC module - according to I2C; </li><li>  display (via GPIO-expander) - according to I2C; </li><li>  temperature sensors - 1-Wire (obviously); </li><li>  all the rest is free GPIO to taste. </li></ul><br>  To output temperature sensors outward, I used the DB9 connector - I need 3 sensors, each with 3 legs.  The sensors themselves are connected with a regular telephone 4-wire cable. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The result was a good gizmo! <br><br>  Front view (off): <br><br><img src="https://habrastorage.org/files/31c/ca4/b50/31cca4b504cf4a648bda5691aebe2d1a.jpg" alt="image"><br><br>  The case was cut with a Dremel, I think, any model will do.  I used an abrasive cutting disc for rough cutting of holes (so what that plastic melts), I used a 180-grit sandpaper for finishing. I also tried to use a thin grinding peak, but it ‚Äúgrinds‚Äù round holes in soft plastic without wanting gently round the corners.  Disc skin is much better and can even be used for accurate cutting (of course, cutting them as a cutting disc does not work).  Well, I also received Dremel from spacers 6 mm high, spacers 3 mm high, but I think this is not a special trick. <br><br>  Front view (included): <br><br><img src="https://habrastorage.org/files/76f/014/d8c/76f014d8cb15402e89d9cc042151b24d.jpg" alt="image"><br><br>  The yellow LED on the right blinks differently depending on whether the GPS module sees satellites or not (the LED is placed on the output of the FIX module) <br><br>  Inside view: <br><br><img src="https://hsto.org/files/4c6/59b/358/4c659b358f8140ec96620740aa81bfc6.jpg" alt="image"><br><br>  Bottom left is the RTC module, top right is the GPS module, top left is the RasPi itself, in the center is the ‚Äúpower supply‚Äù.  The base is made of an acrylic plate wrapped in a non-conductive anti-static bag. <br><br>  I have written so far a little python script to check that everything works.  Library for working with GPIO-extender took <a href="https://github.com/PDKK/RpiLcdBackpack">here</a> .  The backlight of the screen is controlled by 3 pins, one of them under the control of a GPIO expander, the other two I brought to separate GPIOs on the RasPi.  For example, the light blue screen: <br><br><img src="https://hsto.org/files/b79/1e1/a28/b791e1a28d354ebc8c656475ddd08dc1.jpg" alt="image"><br><br>  The screen displays the time, date and temperature from one of the temperature sensors. <br><br>  But the yellow screen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/50f/0fd/362/50f0fd3620626d98d4edc81860f82d46.jpg" alt="image"><br><br>  The orange button, as is clear from the switching scheme, is normally closed and, when pressed, interrupts the power supply (reset, in short).  But what will happen if you press the blue button: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a5/81f/10c/6a581f10c0b01a8d0dd3095cafeb3eb4.jpg" alt="image"><br><br>  With the blue button, I gave a little blunder.  First, it is normally closed, about which I successfully forgot.  As a result, we have to catch the appearance of a falling front, and not an ascending one.  And secondly, these buttons, as it turned out, rattle terribly.  Fortunately, in the rpi.GPIO library this is already provided for and you can set the time during which the callback function will not be called. <br><br>  I had to tinker a bit with ntpd and rebuild it from source, because the distribution package from Raspbian does not support the PPS source, which is not serious for a cool stratum1 ntp server.  Well, at the same time I collected gpsd with JSON protocol support, although there is no sense in it - only the delay grows, through SHM it turns out (obviously) to drive the data much faster.  In any case, the device requires a street or very close to the street located antenna, otherwise jitter grows to indecent values ‚Äã‚Äãand use GPS as a time source becomes impossible.  PPS is supported by a module from Raspbian pps-gpio. <br><br>  Temperature sensors are also supported by the standard w1-therm module.  After it is loaded in / sys / bus / w1 / devices, directories with the id of each sensor appear.  Each directory has a file w1_slave, reading from which gives us a temperature reading.  Beauty. <br><br>  Out of the box, the device is able to perform the functions of an NTP server and a remote terminal.  RasPi is fairly stable, does not fall suddenly and for no reason, which allows it to be used for HLO-control and data collection from UPSs.  To work with the screen, button and temperature sensors in the plans, roll a small application that will report this data to Zabbix, or provide Zabbix with the ability to read this data.  From crazy ideas, you can dynamically update records with geographic location in the DNS, if someone needs it. <br><br>  Purely theoretically, instead of 3 temperature sensors, you can connect any other 1-Wire devices, if the switching circuit suits them.  Unfortunately, there is only one 1-Wire bus on the RasPi, so all three sensors sit on the same pin, which makes it impossible to simply extend the functionality.  However, you can always solder 3 wiring inside and get a slightly different device. <br><br>  Here is such a thing.  Scold. </div><p>Source: <a href="https://habr.com/ru/post/255179/">https://habr.com/ru/post/255179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255173/index.html">R as a price monitoring tool</a></li>
<li><a href="../255175/index.html">Intel¬Æ Parallel Studio XE 2016 Beta - what's new?</a></li>
<li><a href="../255177/index.html">CentOS 7 (1503) is already available. What is new and how to upgrade</a></li>
<li><a href="../255181/index.html">Comparative analysis of iOS-mail: Google Inbox, myMail and Yandeks.Pochta</a></li>
<li><a href="../255183/index.html">Two-factor authentication for corporate web services</a></li>
<li><a href="../255185/index.html">Servers of large registrar NIC.UA are withdrawn</a></li>
<li><a href="../255187/index.html">How to change font name</a></li>
<li><a href="../255189/index.html">The global importance of English, German, Russian, Chinese and other languages ‚Äã‚Äãon the Internet (Data Mining)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>