<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dr. Tariff (tariffs and balance): How I began to help people save on mobile costs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I will tell you how Dr. Tarif was created. This is an assistant who analyzes the statistics of your conversations and selects the ideal tariff p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dr. Tariff (tariffs and balance): How I began to help people save on mobile costs</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b6f/323/840/b6f3238409ff818badab20a06f995287.jpg"><br><br>  Today I will tell you how Dr. Tarif was created.  This is an assistant who analyzes the statistics of your conversations and selects the ideal tariff plan.  Once launched, the application will examine in detail the history of your conversations and other costs to tell if you can spend less.  For one week, we were on our own in the TOP-10 free applications under the heading "Finance". <br><a name="habracut"></a><br><br><h4>  Idea </h4><br>  It all started from the morning when I woke up and, looking at the negative balance in the account, I realized that over the last week I had spent about 1,000 rubles talking.  ‚ÄúSomehow too famously‚Äù - I thought, and decided it was time to switch to a new tariff.  Before that, I had to select the tariff twice on the sites of operators.  Despite the mathematical turn of mind, I had to figure out for quite a long time what tariff to switch to.  At this point, I had a question - why not an application that could do it for me and, besides, to bring all the analytics about conversations in the form of infographics. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I asked a friend to sketch the first interface design: <br><br><img src="https://habrastorage.org/storage2/ff1/ecc/deb/ff1eccdeb53181f4febf36bbe3d713b0.jpg"><img src="https://habrastorage.org/storage2/cca/2d7/df8/cca2d7df841a54ba21d08ec0d0c6eabf.jpg"><img src="https://habrastorage.org/storage2/345/9e7/ef5/3459e7ef5042a85bde7fa5519534b3ab.jpg"><img src="https://habrastorage.org/storage2/161/870/765/1618707652225691300ad39d7b16c878.jpg"><img src="https://habrastorage.org/storage2/fce/8db/c70/fce8dbc704a26d09730b5c213defef88.jpg"><br><br>  I‚Äôve already twice died Nokia N8, and I chose between iOS and Android.  On one side, simplicity and sophisticated design, on the other - widgets, a larger set of functions and many free applications.  I preferred Android and was not mistaken.  This is the only mobile operating system that gives full access to user data, which means it will be possible to implement all the planned functionality. <br><br><h4>  Research </h4><br>  It took a lot of time to learn how to implement all my ideas.  For example, there were 4 options for determining the region of the user.  First of all, we wanted to read this information from the SIM card, but only the operator and the country are sewn into them (and even then not always).  The second was based on GPS data, but we did not find a complete map of the breakdown of the RF by region.  And the location at a particular point in time is not directly related to the region of the SIM card, and, therefore, to the rates for communication.  The third option is to use GSM cellular identifiers or Wi-Fi towers.  It turned out that a complete base does not exist and they constantly ‚Äúmigrate‚Äù. <br><br>  There was a fourth way - to determine the region by phone code (the first N digits after +79), which is uniquely associated with the region and the operator.  But for this it was necessary to somehow contrive to determine the subscriber's phone number.  A separate task was to find all the requests and exact answers of mobile operators in various regions.  And here we were waiting for new surprises: Megaphone, for example, is divided into 7 branches, each of which has its own system of requests / responses.  The blessing though * 100 # works across all Russia.  In MTS * 100 # calls on some devices cascades of incoming SMS with balance, it turned out that # 100 # solves the problem. <br><br>  It soon became clear that we need to learn how to read the pop-up USSD responses of operators to work with Beeline and Tele2.  A quick overview of this task showed that there is no API for this function.  And on the official developer forum, this question remains open for 4 years. <br><br>  We have already decided to cut this part, but our new Android developer, Dmitry, still found a way to solve this problem (the well-known way drew <a href="http://commandus.com/blog/%3Fp%3D58">from here</a> ; unfortunately, not very reliable, but for lack of a better alternative, we had to use it).  Later it turned out that competing apps with MobileFox and USSD checker balance widgets use the same method, only in violation of Google‚Äôs recommendations, they set the highest possible priority 2147483647 (instead of the recommended 1000).  Because of this, our application with reading USSD always flew past the ticket office. <br><br>  It was funny with priorities at all - the same competitors put a similar priority on receiving SMS, and everything would be fine if they didn‚Äôt manually add them to the incoming ones and didn‚Äôt interrupt the alert.  In this regard, the parts of users continuously fell SMS in the incoming after each action. <br><br>  And often there was a chain effect: the SMS request was sent, the SMS was added to the inbox, bypassing our application, the application detected a new incoming SMS and re-sent the request.  Fortunately, we started with testing on the beta version of the application :) <br><br><img src="https://habrastorage.org/storage2/142/2ea/8a6/1422ea8a635f771524d072176db7fdcc.jpg"><br><br><h4>  Tariff Optimizer </h4><br>  What we are really proud of is the tariff optimizer.  It seems to you that you speak little and pay a lot?  The idea was to just one click to separate the user from the most favorable tariff for him.  But behind this click there is a big hard work. <br><br>  To calculate the cost of an outgoing call or SMS, you need to know which region and operator is with the other party.  If the subscriber is in another region, not in where he is registered, he will pay for roaming, but for you the cost will remain the same.  Phone number is enough to calculate the cost of a call / SMS on almost all rates.  The exception is made by tariffs, where the price for calls to subscribers with a specific tariff plan is specified separately. <br><br>  Information about the cost of calls / SMS is compiled manually for each tariff, based on the description from the sites of operators, and is stored in a text file.  Further, it is translated into a suitable form for calculations. <br><br>  To preserve the anonymity of the number of calls / SMS sent in a truncated form.  To begin with, 5 digits were cut off and this worked in most cases.  A more detailed analysis showed that some calls are not so determined and information about the operator or region is contained in the last digits, so the protocol has been changed, and now the last 3 digits are truncated. <br><br>  Once, analyzing the logs, I noticed that one client had changed the phone model to some little-known one, and the manufacturer remained unchanged (Samsung).  The subscriber's identification occurred according to the MD5 hash value from his IMEI (international mobile equipment identifier), and since it is unique, the data is tied to a strictly one device. <br><br>  So I thought ... But it turned out that this is not quite so.  Maintaining the uniqueness of IMEI rests on the shoulders of manufacturers, and at the state level is controlled only for certified devices.  In Europe or the US, this is closely monitored.  In Russia there is a huge market of so-called gray devices, which are intended for another country and are imported illegally.  The reason for this is simple: you do not have to pay a fee, as a result of which the cost of the apparatus decreases by several thousand. <br><br>  As a result, it is quite possible the simultaneous existence of several devices with one IMEI.  A collision was detected when there were less than 1000 users in the database, so the problem is quite relevant.  Both devices (GT-I9003, SHV-E150S) were made by Samsung, but the first model is international, and the second is designed for the Asian market.  It seems that Samsung just decided to save the allocated numbers and creates devices with the same IMEI for different countries. <br><br>  The problem was solved by changing the identifier to the MD5 value from the IMEI + device model.  Let's hope that the manufacturers will not release the same model with the same IMEI. <br><br>  The server is written in Python.  The first time worked under Windows 7 on a home computer.  When writing a multiprocessor (remember GIL) server, there was a problem with passing a socket to another process due to operating system limitations.  Now the server is running on a separate server running Ubuntu.  The database uses PostgreSQL. <br><br>  Some interesting facts: <br><ul><li>  calculation of costs for all tariffs in the region takes from 0.5 to 1.5 seconds depending on the number of calls / SMS; </li><li>  the longest conversation lasted 6.5 hours; </li><li>  One subscriber stored more than 8700 SMS in the phone. </li></ul><br><img src="https://habrastorage.org/storage2/027/a5e/bb7/027a5ebb7bb6de67f2b6da23479ed4ff.jpg"><br><br><h4>  Other application features </h4><br>  A nice addition to Dr.  Tariff are graphics.  You will find out who you are most talking with and who you are most communicating by SMS.  Call MTS or Beeline often.  All charts can be customized "by yourself", as well as select the period for which statistics will be displayed. <br><br><img src="https://habrastorage.org/storage2/585/4d9/a2a/5854d9a2a71510307291156ebaa82cac.jpg"><br><br><img src="https://habrastorage.org/storage2/ae5/299/241/ae529924168600c568fea2a99592b07e.jpg"><br><br><img src="https://habrastorage.org/storage2/e9d/65f/851/e9d65f8511d4f0e44671db0fb08cbe06.jpg"><br><br>  In addition, you will have flexible widgets with current balance and cost statistics. <br>  Now, with each call, Dr. Tariff will inform you about the operator and the region.  In the settings you can change the location of the window, or disable this feature.  Trifle, but nice: <br><img src="https://habrastorage.org/storage2/d61/6be/7bc/d616be7bce18f4f0c11abeb80b90ca22.jpg"><br><br>  Now we are actively collecting feedback and we are already working on redesigning the application taking Android standards into account. According to numerous requests from iPhone users, an application for iOS is planned to be released (if successful with Android).  Due to the closeness of the operating system, data can only be obtained from a personal account, which will lead to some difficulties, but this is true due to the lack of alternatives. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/91RO86HYhDU%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700191,15700253&amp;usg=ALkJrhiiO0oSSWs0cvKTuVc842USr8YI0w" frameborder="0" allowfullscreen=""></iframe><br><br>  Until May 31, we decided to make the application free.  Download on <a href="https://play.google.com/store/apps/details%3Fid%3Dru.bandicoot.dr.tariff">Google Play</a> . <br> <a href="http://qrcoder.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/3cd/d78/11b/3cdd7811bde8bed53b69ab3b99cf7322.gif" width="90" height="90" title="QR code"></a> <br>  Who does not work downloading from Google Play can try to download from the <a href="http://store.yandex.ru/">Yandex Store</a> or. Apk file with <a href="http://4pda.ru/forum/index.php%3Fshowtopic%3D458013">w3bsit3-dns.com</a> . <br><br>  If you like the app, or you want to help the development project, join our group and tell your friends and friends about it: <br>  <a href="http://vk.com/DrTariff">vk.com/DrTariff</a> <br>  <a href="http://facebook.com/groups/DrTariff/">facebook.com/groups/DrTariff/</a> <br>  <a href="http://twitter.com/DrTariff">twitter.com/DrTariff</a> <br>  <a href="http://drtariff.com/">drtariff.com</a> <br><br>  <b>PS</b> In the near future we want to prepare an infographic on which tariffs the <s>users spend least effectively on the</s> most efficient operators earn money - is it interesting? </div><p>Source: <a href="https://habr.com/ru/post/179559/">https://habr.com/ru/post/179559/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179539/index.html">Game Boy Pocket: quick review + giblets</a></li>
<li><a href="../179541/index.html">Remove the starry sky with Emgu CV</a></li>
<li><a href="../179543/index.html">How to drop Windows with six lines of code</a></li>
<li><a href="../179547/index.html">How are you looking for freelance orders on exchanges?</a></li>
<li><a href="../179553/index.html">How I bought a 42-inch LCD TV: the experience of choice and operation</a></li>
<li><a href="../179561/index.html">I am writing a toy OS (about mutex implementation)</a></li>
<li><a href="../179569/index.html">Gmail + GDrive = now 15 gigabytes free</a></li>
<li><a href="../179573/index.html">The second phase of the Intel¬Æ Perceptual Computing Challenge has started.</a></li>
<li><a href="../179575/index.html">Now all developers can respond to reviews on Google Play</a></li>
<li><a href="../179579/index.html">Igor Ashmanov on iForum-2013. Information sovereignty, modern reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>