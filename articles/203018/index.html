<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video generation by mathematical function on FPGA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In this article I want to talk about my experience in studying development on FPGAs and to introduce my project - a video generator using a f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video generation by mathematical function on FPGA</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  In this article I want to talk about my experience in studying development on FPGAs and to introduce my project - a video generator using a formula. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90c/46a/e98/90c46ae9880318ea3fd94affa6a8d8a7.jpg"><br><br><h4>  Purpose of the post </h4><br>  I am a C ++ programmer, professionally engaged in the development and maintenance of system software.  About two years ago, I had a desire to diversify my experience by studying circuit design, more precisely programming an FPGA using the Verilog language.  Next, I will tell you what came of it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Objective </h4><br>  To direct the computational power of the FPGA to the needs of generative art: to generate real-time streaming video using a complex formula in high resolution, with a high frame rate.  <a href="http://countercomplex.blogspot.ru/2011/12/ibniz-hardcore-audiovisual-virtual.html">IBNIZ</a> , a formula description language for generating a demo, developed by comrade <a href="http://www.blogger.com/profile/06927455242083569579">viznut</a> as a virtual platform for the demoscene, was chosen as a frontend.  Previously, I implemented on the FPGA, on the platform " <a href="http://marsohod.org/index.php/projects/plata1/184-jukebox">Mars Rover</a> ", <a href="http://countercomplex.blogspot.ru/2011/10/algorithmic-symphonies-from-one-line-of.html">his other find</a> . <br><a name="habracut"></a><br><h4>  Theory </h4><br><h5>  Circuit design and programming </h5><br>  In my opinion, circuit design for a programmer is an interesting adjacent area for development.  The description of the equipment, on the one hand, is in many ways similar to the writing of the program, which facilitates entry, and on the other hand, defines a completely different way to solve the applied problem, gives the engineer new possibilities and experience.  Usually we write a program that runs sequentially, line by line.  It is instructive to try to write a program, all parts of which work simultaneously. <br><br>  So, this is interesting, but let's think about expediency.  How to choose a task that will be justified on the FPGA?  First, in some cases, the circuit design is more elegant and reliable software.  For example, I programmed a sumo-bot on a microcontroller, made him a simple voice - a speaker hangs on one of the conclusions, the signal on it changes with a sound frequency.  Everything is simple - a cycle, inside switching and delay.  But the robot stopped for a while.  To work at the same time, you need multitasking, you need to write a dispatcher, with increasing complexity turning into a <a href="http://habrahabr.ru/post/148805/">real-time OS</a> .  In the decision on the FPGA, it is not necessary to divide the resource of the central calculator, the subsystem of the control of the speaker will remove some volume of the FPGAs and will not interfere with anyone further. <br><br>  Secondly, a specialized circuit can have a lot more performance than a software solution.  For a pixel-by-pixel processing of the 1280x1024 @ 60Hz video stream, it will be necessary to process 80 million in real time.  there are not enough points per second, even on a powerful processor, the circuit design will give possibilities where it is richer (with certain limitations on the algorithm, the processing must be stereotypical, branching is undesirable). <br><br><h5>  Hdl </h5><br>  For programming FPGAs, you can use special languages ‚Äã‚Äãsuch as Verilog and VHDL.  In my opinion, they are much more convenient than the schematic editor, but people who are used to high-level programming are disappointed.  My experience concerns (System) Verilog, but as far as I know, VHDL differs little.  The scheme is described at the level of register transfers <a href="http://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B5%25D0%25BD%25D1%258C%2520%25D1%2580%25D0%25B5%25D0%25B3%25D0%25B8%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B2%25D1%258B%25D1%2585%2520%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0%25D1%2587">(RTL)</a> , which seems to be natural, but the description is divided into two parts: the combinational circuit and synchronous logic.  Here, for example, there is a cycle operator, I describe the division by a bar and I find that the combinational part cannot be described inside the loop body, only the synchronous one.  There are macros, the macro language of the veralog is a S-shny preprocessor with the accuracy of replacing '#' with '' '.  Well, the module can have numeric parameters (compile time), and that's probably all the means of generalized programming on our weapons. <br><br><h5>  RTL, synchronous circuits </h5><br>  In most cases, the developers of electronic circuits are limited to synchronous circuits.  This means that there is a common clock signal (clock, clock), and the description is divided into a set of registers and combinational circuit, which determines how the register value on the next clock depends on the register value on the previous one.  The combination scheme does not have its own state.  Minus - some restriction of freedom, for example, I met a description of the implementation of a random number generator using an asynchronous scheme.  In general, the architecture of the FPGA is designed to work only with synchronous circuits, and such fundamentally asynchronous modules like the PLL (PLL) are implemented as separate hardware blocks. <br><br>  The PLL allows you to create several ‚Äúclocks‚Äù, for example, to separate the computational module from the video adapter, so that each has its own frequency.  As I understand it, asynchronous circuits refer to circuitry approximately as programmers to self-modifying code. <br><br>  The frequency at which the scheme can work depends mainly on the scheme itself, but the type of FPGA, its ‚Äúclass of skrosti‚Äù plays a role.  The meaning is approximately the same - in one clock cycle the signal must have time to run along the longest path of your circuit and switch the target register.  When I exceeded the frequency for the solution being described, characteristic snot appeared on the screen. <br><br><h4>  Iron </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/777/1c7/fbd/7771c7fbd9bfc36c9bab38888b82abc8.jpg"><br><br>  The project is prepared for four debugging boards, <a href="http://www.terasic.com.tw/en">Terasic</a> DE0, Terasic DE2-115, Terasic DE0-nano with LTM display instead of VGA, and also <a href="http://marsohod.org/">Mars Rover</a> II.  Terasic has excellent hardware, software is not so rosy.  Documentation and samples are examples, but they are not always enough.  For example, having already learned how to flash the FPGA directly, I killed the day by pushing the same firmware into the configuration memory (eeprom) (so that this firmware would load when the board was turned on).  Another problem is that in Russia they are difficult to find at a reasonable price, and Taiwanese are not sent by regular mail.  The Mars Rover II has a poorer functional, but it‚Äôs much better with descriptions and support; in the articles from their website I often found a solution to my next difficulties.  My first debug motherboard was the first Mars Rover, it is weaker in terms of its capabilities, but also easier to master above mentioned ones, to try the very thing. <br><br><h4>  Tools </h4><br>  Since I used ALTERA-based debugging boards, QUARTUS, a free web edition, was used as the development environment.  QUARTUS leaves an ambiguous impression.  The main complaint is very unintuitive and poorly documented, no tutorials.  At the same time, it performs its duties as an integrated development environment.  This is a typical situation when working with FPGAs ‚Äî it works, but the convenience (including ease of development) is at the last place, enthusiasts are not usually expected here. <br><br><h4>  Implementation </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/e2b/398/8d9/e2b3988d923f2edabded3bc7e5b76c7c.jpg"><br><br>  So, we generate video on function.  ibniz, or rather its ‚Äúlinear‚Äù subset will serve as a specification.  The advantage is that, firstly, you can borrow a few ready-made demos, and secondly, you can compare the result of the work with the <a href="http://pelulamu.net/ibniz/">reference software implementation,</a> which is very valuable, since debugging the scheme is much more complicated than debugging the program. <br><br>  The work was mainly divided into two parts, the infrastructure that prepares the data and displays the result on the display and on the core that implements the individual elementary functions of ibniz. <br><br>  The main component of the infrastructure is the VGA adapter.  The usual approach is to use the frame buffer (s) that involves external memory in the project (there is little internal memory).  This would complicate the project and make it impossible to use memory for anything else.  Therefore, the core works synchronously with VGA, the color of the pixel is calculated and it is immediately drawn. <br><br>  Disadvantages: <br>  VGA frequency is imposed on the core <br>  While the VGA fulfills the ‚Äúinvisible pieces of the screen,‚Äù the core is idle. <br>  Hard real time, it is necessary to give another pixel for each clock, save there, then to spend it will not work. <br>  The ibniz commands of direct writing to the frame buffer are not realizable, as well as transition operators. <br><br>  Benefits: <br>  Ease of implementation <br>  You can use the width of the channel, which the memory would not have pulled. <br>  Memory is stored for something else (sharing a resource would hardly be possible here). <br>  Low latency, there is little confusion from it, but with the signal from the camera comes out beautifully, but this is another project. <br>  Tru 60Hz video pleases the eye. <br><br><h5>  Core </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/c56/f31/6c8/c56f316c8c4f1cc3d19db8fa096c03d0.jpg"><br><br>  The core of the project consists of mathematical functions - sin, atan2, log, sqrt, as well as division;  implemented them myself, using digit-to-digital algorithms ( <a href="http://ru.wikipedia.org/wiki/CORDIC">CORDIC</a> ), the benefit was the experience of software implementation.  These are iterative algorithms, the number of iterations is proportional to the length of the arguments.  My iteration is done per clock, that is, from receiving arguments at the input to output of the result, the number of ticks equal to the digit capacity of numbers passes, for ibniz it is 32. How to try it with the need to count a point per clock?  With the help of <a href="http://ru.wikipedia.org/wiki/%25D0%2592%25D1%258B%25D1%2587%25D0%25B8%25D1%2581%25D0%25BB%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9%2520%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B2%25D0%25B5%25D0%25B9%25D0%25B5%25D1%2580">conveying</a> , the computing unit consists of 32 (hardware) stages.  There is a delay, and for the sequence of blocks the delay accumulates.  It is easy to fight with it, but I left it for clarity, as a result, the image is shifted to the right, and along the left edge you can see an artifact strip, the width of which corresponds to the total depth of the conveyor of a specific example. <br><br><h4>  Beautiful </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/57e/5f5/dfd/57e5f5dfdd9fcc7ce38547b0789613bc.jpg"><br><br>  About generative art on Habr√© already wrote <a href="http://habrahabr.ru/post/171805/">for example here</a> , further my 5kop.  When you start to generate computer pictures, at first you strive for the unusual, - paradoxical forms, bright inks to acidity.  However, such ‚Äúworks‚Äù quickly get bored.  An interesting thing is that in order to increase diversity, you have to impose restrictions.  A ‚Äúrandom‚Äù picture looks flat, but you can add a sense of volume by pulling it onto some form.  In the Jupiter demo, an intermediate picture-texture is superimposed on the sphere.  To do this, simply convert the coordinates from Cartesian to spherical as well, as described in <a href="http://habrahabr.ru/post/180245/">this article</a> .  The sense of volume is enhanced by lighting, as well as movement, see a demo with four circles-spheres. <br><br><h4>  Total </h4><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/oh1_MzuFtdU%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700253&amp;usg=ALkJrhiKzLz2yXlcaicE1GS7TKvEYKI4wg" frameborder="0" allowfullscreen=""></iframe><br>  So, is it worth a programmer to climb into the circuitry?  Only under the condition of serious intentions, it is necessary to at least know exactly the goal, since this is an energy-intensive matter, which is caused by working at a low level, by less sophisticated development tools and a less obvious logic of the program.  On the other side of the scale - new opportunities and experiences.  I am quite satisfied with my experience, besides the project described, I also made <a href="http://www.marsohod.org/index.php/projects/plata1/184-jukebox">a procedural music generator</a> , a <a href="http://www.marsohod.org/index.php/projects/marsohod2/229-midi-sync">MIDI synthesizer</a> , a signal filter from a video camera. <br>  Now I have a much more serious project at the stage of thinking over and writing a software model, a non-Neumann computer based on <a href="http://ru.wikibooks.org/wiki/%25CA%25EE%25EC%25E1%25E8%25ED%25E0%25F2%25EE%25F0%25FB_%2597_%25FD%25F2%25EE_%25EF%25F0%25EE%25F1%25F2%25EE!">combinatorial logic</a> .  The main idea is that a dynamic tree of a functional program lives on a static large regular graph wired into iron, and the branches of the tree evolve whenever possible simultaneously.  The nodes are as simple as possible, they can only use combinators;  integers only in the form of Church numerals.  The advantage should be the mass execution of simple symbolic operations in a pure functional style.  Maybe something like a regular expression parsing or logical inference.  Of course, in the overwhelming majority of practical problems, traditional architecture cannot be overtaken, but if suddenly there is at least one suitable area, you see, we will reach silicon.  Well, or at least the architecture will appear with <a href="http://www.madore.org/~david/programs/unlambda/">unlambda</a> as an assembly language: <br><br>  `` `s``s``sii`ki <br>  `k. *` `s``s`ks <br>  `` s`k`s`ks``s``s`ks``s`k`s`kr``s`k`sikk <br>  `k``s`ksk </div><p>Source: <a href="https://habr.com/ru/post/203018/">https://habr.com/ru/post/203018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203006/index.html">Google released a preliminary version of the Glass Development Kit</a></li>
<li><a href="../203008/index.html">ServerView Operations Manager - Fujitsu Unified Server Management Point</a></li>
<li><a href="../203010/index.html">Furious bulls: how Wall Street became dependent on "high-speed" trades. Part 3</a></li>
<li><a href="../203012/index.html">My experience setting up apache x64 under windows 8.1 x64</a></li>
<li><a href="../203014/index.html">Introduction to Android NDK</a></li>
<li><a href="../203020/index.html">Application of pattern recognition theory in the advertising environment</a></li>
<li><a href="../203024/index.html">Tiny gadget container in 30 lines on pure JS</a></li>
<li><a href="../203026/index.html">What Java 8 prepares for us</a></li>
<li><a href="../203028/index.html">Organization of content filtering in educational institutions</a></li>
<li><a href="../203030/index.html">Why we do not like to make changes to our layouts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>