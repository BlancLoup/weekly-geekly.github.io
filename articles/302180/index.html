<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to the DLMS / COSEM stack for the MS Instruments MSP430 family of Texas Instruments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the DLMS / COSEM protocol has been actively used in metering devices (electricity, heat, water, gas meters) domestically produced. Almost ev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to the DLMS / COSEM stack for the MS Instruments MSP430 family of Texas Instruments</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ae6/fec/312/ae6fec3123e04662887d470f7f15ccf3.png"><br><br>  Recently, the DLMS / COSEM protocol has been actively used in metering devices (electricity, heat, water, gas meters) domestically produced.  Almost every company specializing in the production of microcontrollers has a certified DLMS / COSEM stack, using which you can reduce the cost and development time of the metering device that supports this protocol.  This article focuses on the DLMS / COSEM stack for the MS Instruments MSP430 microcontroller from Texas Instruments. <br><a name="habracut"></a><br>  The TI DLMS / COSEM stack has the following features: <br><br><ul><li>  All COSEM interface classes are supported. </li><li>  Three levels of association are supported: open access (no security), low security (low security) and high security (high security).  Access to the metering device in high-security mode is performed using 4-step authentication based on the AES128 algorithm. </li><li>  Only LN (long name) addressing is supported. </li><li>  One, two, and four byte addressing is supported. </li><li>  The following services are supported: GET, SET, GET WITH BLOCK, SET WITH BLOCK, ACTION, as well as selective access for objects of the Profile Generic class. </li><li>  The required memory size for storing the stack is 24 KB. </li><li>  The required amount of RAM is 1.8kB. </li></ul><br>  In order to "feel" the stack, we need: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Development environment IAR Embedded Workbench for MSP430; </li><li>  DLMS / COSEM client, take the free open source <a href="http://www.gurux.fi/Download">DLMSDirector</a> from the company Gurux; </li><li>  Evaluation Board EVM430-F6779; </li><li>  MSP-FET430UIF debugger / programmer. </li></ol><br><h4>  Download and unpack </h4><br>  The DLMS / COSEM stack is available at ( <a href="http://www.ti.com/tool/dlmsobj-eval">http://www.ti.com/tool/dlmsobj-eval</a> ), you must have a TI account to download it.  The stack itself is packaged in a distribution called <i>DLMS-4.0.6-windows-installer</i> .  After its installation, the installation folder will contain the ‚ÄúDLMS_Object‚Äù zip folder in which the stack files are located. <br><br>  The library consists of the following files: <br><br><ul><li>  <i>iec62056_demo.c</i> : In this file, the entire periphery of the microcontroller and the HDLC state machine are initialized; </li><li>  <i>uart_comms.c</i> : Configuration file for the UART module; </li><li>  <i>iec62056_link.r43</i> : HDLC and MAC levels are implemented in this file; </li><li>  <i>server_msgs.r43</i> : The application layer COSEM is implemented in this file; </li><li>  <i>config.c</i> : Main configuration file.  In this file, you can delete or add parameters for the list of objects (object list); </li><li>  <i>app_server_msgs.c</i> : Functions are written in this file to extract data from memory and provide it to the DLMS library; </li><li>  <i>config.h</i> : Macros and function prototypes for the config.c file; </li><li>  <i>cosem.h</i> : Definitions of all constants used in the COSEM application layer; </li><li>  <i>iec_62056_link.h</i> : Macros and function prototypes for the HDLC level; </li></ul><br>  All these files are already collected in the project under the name dlms_obj.eww. <br><br><h4>  Launch of the project </h4><br>  In this section, we will launch a demo project and see how COSEM objects are represented.  To do this, open the <i>dlms_obj.eww</i> file in IAR for MSP430 and select the required microcontroller, in our case this is MSP430F67791. <br><br><img src="https://habrastorage.org/files/137/e81/292/137e81292b5143d4a12f6c862a6bf868.png"><br><br>  We collect the project and we program the controller.  Open the DLMSDirector program and add a new device with the following parameters: <br><br><img src="https://habrastorage.org/files/024/b4c/523/024b4c5237d04e4fb7b50a4fc32a3d3e.png"><br><br>  Press the "OK" button.  Then in the ‚ÄúDevices‚Äù tree we select our device, click the ‚ÄúConnect‚Äù button and ... we get this error: <br><br><img src="https://habrastorage.org/files/e8f/2de/24d/e8f2de24d87641cca2243819d5ef2933.png"><br><br>  It is easily <i>fixed</i> , we open the <i>uart_comms.c</i> file of the <i>dlms_obj.eww</i> project and in line 132 we see that when configuring the UART a ‚Äútypo‚Äù was made: <br><br><img src="https://habrastorage.org/files/3ea/e51/c48/3eae51c485314dd4baf880ec69471374.png"><br><br>  The correct line should be: <br><br><pre><code class="cpp hljs">P3SEL0 |=(BIT0|BIT1);</code> </pre> <br>  After the correction, the connection with the metering device is successfully established, with the result that the ‚ÄúRead‚Äù button becomes available, and in the status line we see ‚ÄúReady‚Äù: <br><br><img src="https://habrastorage.org/files/565/c30/812/565c30812071457382ff89e80a7eab8e.png"><br><br>  To download information from the metering device, press the ‚ÄúRead‚Äù button.  This process is not fast, so you have to wait a bit.  As a result, we get a tree from COSEM objects: <br><br><img src="https://habrastorage.org/files/2e4/aba/8da/2e4aba8da9824f40bc91a17b6e366083.png"><br><br>  In this stack, in open access, by default, five objects are displayed: <br><br><ul><li>  0.0.1.0.0.255 - displays the current time in the meter; </li><li>  0.0.40.0.0.255 - displays information about the current association; </li><li>  0.0.40.0.1.255 - displays information about the association number 1; </li><li>  0.0.41.0.0.255 - displays the so-called SAP destination; </li><li>  0.0.42.0.0.255 - displays the logical name of the device, in fact - the serial number of the counter. </li></ul><br>  For example, information about the current time in the metering device is as follows: <br><br><img src="https://habrastorage.org/files/eae/e4e/2bd/eaee4e2bda644cbb9208425f66136f7a.png"><br><br>  We can not only find out the time, but also get information about the time zone, the source of clocking, the date and time of daylight saving time and back, and in high secrecy mode, it is possible to set these parameters. <br><br>  To access the metering device in low privacy mode, you must use the following settings (The default password is 00000000): <br><br><img src="https://habrastorage.org/files/57a/9b0/895/57a9b0895fc14cccb1dd7ba201e01e32.png"><br><br>  In this mode, many more COSEM objects are available: <br><br><img src="https://habrastorage.org/files/48f/917/742/48f917742b2e4264a4399c96e49a6520.png"><br><br><h4>  Adding a new COSEM object </h4><br>  To add a new object, open the file <i>config.c of the</i> project <i>dlms_obj.eww</i> , find the structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object_desc_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object_list</span></span></span><span class="hljs-class">[]</span></span></code> </pre><br>  and add the following line to it: <br><br><pre> <code class="cpp hljs">{ASSOC_PC_MR_US, CLASS_ID_DATA, <span class="hljs-number"><span class="hljs-number">0</span></span>, { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>}, <span class="hljs-number"><span class="hljs-number">2</span></span>, Obj_Meter_Sr_No, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>}</code> </pre><br>  Where: <br><br><ul><li>  ASSOC_PC_MR_US - determines the visibility of the object, in this case the object will be visible both in open access mode, and in access mode with a low level of secrecy and in access mode with a high level of secrecy; </li><li>  CLASS_ID_DATA - identifier of the interface class, in this case the object belongs to the class Data; </li><li>  0 - class version (0); </li><li>  {0, 0, 96, 1, 0, 255} is the logical name of the object; </li><li>  2 - the number of attributes (2); </li><li>  Obj_Meter_Sr_No - pointer to attribute list; </li><li>  0 - the number of methods (0); </li><li>  NULL - pointer to the list of methods (no methods). </li></ul><br>  Then we create a structure with a list of attributes in the same file: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute_desc_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Obj_Meter_Sr_No</span></span></span><span class="hljs-class">[] = {</span></span> {<span class="hljs-number"><span class="hljs-number">1</span></span>, ACCESS_PCR__MRR__USR_, TAG_OCTET_STRING, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *) object_list[<span class="hljs-number"><span class="hljs-number">11</span></span>].instance_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>}, {<span class="hljs-number"><span class="hljs-number">2</span></span>, ACCESS_PCR__MRR__USR_, TAG_OCTET_STRING, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *) Meter_Sr_No, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>}, };</code> </pre><br>  Where: <br><br><ul><li>  The first parameter is the attribute number; </li><li>  The second parameter is access rights; </li><li>  The third parameter is the attribute data type; </li><li>  The fourth parameter is a pointer to the data; </li><li>  The fifth parameter is the callback function.  This function is called when data needs to be taken, for example, from an EEPROM of memory.  More information can be obtained from the user manual. </li></ul><br>  In our case, the object does not have a callback function, and a byte string is used as the data type. <br><br>  <i>Meter_Sr_No</i> points to the following structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> Meter_Sr_No[] = { <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>,<span class="hljs-string"><span class="hljs-string">'B'</span></span>,<span class="hljs-string"><span class="hljs-string">'C'</span></span>,<span class="hljs-string"><span class="hljs-string">'D'</span></span>,<span class="hljs-string"><span class="hljs-string">'1'</span></span>,<span class="hljs-string"><span class="hljs-string">'2'</span></span>,<span class="hljs-string"><span class="hljs-string">'3'</span></span>,<span class="hljs-string"><span class="hljs-string">'4'</span></span> };</code> </pre><br>  That's all the procedures for creating a new object.  Result: <br><br><img src="https://habrastorage.org/files/5c5/275/5f0/5c52755f016a4b8eb5bb11f54afaa097.png"><br><br><h4>  Conclusion </h4><br>  This article does not provide a complete description of the DLMS / COSEM library for the MSP430 microcontroller family, since it is difficult to do this without highlighting the main points of the protocol itself.  However, those who need such descriptions can familiarize themselves with it by downloading it from the TI website ( <a href="http://www.ti.com/tool/dlmsobj-eval">http://www.ti.com/tool/dlmsobj-eval</a> ). </div><p>Source: <a href="https://habr.com/ru/post/302180/">https://habr.com/ru/post/302180/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302170/index.html">Stack Trace in C ++ or cycling, level ‚ÄúBydlokod‚Äù</a></li>
<li><a href="../302172/index.html">Hosting provider RUVDS joins ISIC student discount program partners</a></li>
<li><a href="../302174/index.html">Cloud computing economics</a></li>
<li><a href="../302176/index.html">FileChangesWatcher</a></li>
<li><a href="../302178/index.html">Fiery number system, or why 1 + 10 = 100</a></li>
<li><a href="../302186/index.html">Introduction to sequels and macros on Scheme</a></li>
<li><a href="../302188/index.html">DevConf :: JavaScript - support your favorite JS framework</a></li>
<li><a href="../302192/index.html">Workshops to identify requirements for IT-projects: how and why to carry them out?</a></li>
<li><a href="../302194/index.html">Smart Transport: New Information Security Challenges</a></li>
<li><a href="../302196/index.html">Lasers for Guidance and Geodesy: Innovations from ITMO University</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>