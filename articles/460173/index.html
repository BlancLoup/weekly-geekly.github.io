<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development for Docker. Local environment. Part 2 - Nginx + PHP + MySql + phpMyAdmin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Consider an example of a sweep of the local environment consisting of a bundle of Nginx + PHP + MySql + phpMyAdmin. This bundle is very popular and ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development for Docker. Local environment. Part 2 - Nginx + PHP + MySql + phpMyAdmin</h1><div class="post__text post__text-html js-mediator-article">  Consider an example of a sweep of the local environment consisting of a bundle of Nginx + PHP + MySql + phpMyAdmin.  This bundle is very popular and can satisfy a number of standard needs of an ordinary developer. <br><br>  As in the last post, the emphasis will be shifted towards the docker-compose utility than the docker in its pure form. <br><br>  So let's go! <br><a name="habracut"></a><br>  Let's start with the docker-compose.yml, which is located in a separate proxy folder: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">docker-compose.yml for nginx-proxy</b> <div class="spoiler_text"><pre><code class="plaintext hljs">version: '3.0' services: proxy: image: jwilder/nginx-proxy ports: - 80:80 volumes: - /var/run/docker.sock:/tmp/docker.sock:ro networks: - proxy networks: proxy: driver: bridge</code> </pre> <br></div></div><br>  The presented file describes the configuration for creating a single container with the <b>proxy</b> name based on the <b>image: jwilder / nginx-proxy</b> and creating a network with the same name.  The <b>networks</b> directive indicates which networks the container is connected to, in this example, it is our proxy network. <br><br>  When creating a network, the driver: bridge directive could not be specified.  The bridge driver is the default driver.  This container will communicate over the network with other containers. <br><br>  The jwilder / nginx-proxy image is basic and taken, and the <a href="https://hub.docker.com/r/jwilder/nginx-proxy">Docker Hub</a> also contains a rather extensive and detailed description of its use.  The principle of operation of nginx-proxy is quite simple, it gains access to information about running containers through a forked docker socket, analyzes the presence of an environment variable named VIRTUAL_HOST, and redirects requests from the specified host to a container that has this environment variable set. <br><br>  We launch the proxy by the well-known docker-compose up -d command and observe the following output: <br><br><pre> <code class="plaintext hljs">Creating network "proxy_proxy" with driver "bridge" Creating proxy_proxy_1 ... done</code> </pre><br>  This conclusion informs us that at the beginning the network was created proxy_proxy, and then the container proxy_proxy_1 was created.  The network name was obtained from the name of the folder in which the docker-compose.yml file was located, I have this proxy and the network name of the same name. <br><br>  If we enter the <b>docker network ls command</b> , we will see a list of the docker‚Äôs networks on our system and one of them should be proxy_proxy. <br><br>  The name of the container is built on the same principle as the name of the folder plus the name of the service and a number that allows containers with similar names not to be duplicated.  Through the directive <a href="https://docs.docker.com/compose/compose-file/">container_name,</a> you can set the name of the container explicitly, but I think this is a rather useless function.  More will be discussed in the following posts. <br><br>  Create a second docker-compose.yml with the following content: <br><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml for other services</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: '3.0' services: nginx: image: nginx environment: - VIRTUAL_HOST=site.local depends_on: - php volumes: - ./docker/nginx/conf.d/default.nginx:/etc/nginx/conf.d/default.conf - ./html/:/var/www/html/ networks: - frontend - backend php: build: context: ./docker/php volumes: - ./docker/php/php.ini:/usr/local/etc/php/php.ini - ./html/:/var/www/html/ networks: - backend mysql: image: mysql:5.7 volumes: - ./docker/mysql/data:/var/lib/mysql environment: MYSQL_ROOT_PASSWORD: root networks: - backend phpmyadmin: image: phpmyadmin/phpmyadmin:latest environment: - VIRTUAL_HOST=phpmyadmin.local - PMA_HOST=mysql - PMA_USER=root - PMA_PASSWORD=root networks: - frontend - backend networks: frontend: external: name: proxy_proxy backend:</code> </pre><br></div></div><br>  What is here announced? <br><br>  Listed four services: nginx, php, mysql and phpmyadmin.  And two networks.  One proxy network, named frontend, is declared as an external network and a new internal network backend.  The driver for it is not specified, as it was written earlier, the default driver of the bridge type will be used. <br><br><h4>  nginx </h4><br>  Here it should be all clear.  Use the base image with the docker hub.  The environment variable is needed for the proxy to work and tells it at what address the container should be accessible.  The option depends_on indicates the dependency of this container on the php container.  This means that the php container will be launched ahead, and after it, the dependent nginx container will be launched.  Next, we forward the configuration for our nginx.  It will be slightly lower and mount the folder with html.  We also note that the container has access to two networks at once.  It must communicate with both the proxy from the frontend network and php from the backend network.  In principle, it would be possible to cram all the containers into one network of the frontend, but I adhere that this separation is more correct. <br><br><div class="spoiler">  <b class="spoiler_title">default.nginx</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name_in_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/host.access.log main; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html/; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> /index.php<span class="hljs-variable"><span class="hljs-variable">$is_args</span></span><span class="hljs-variable"><span class="hljs-variable">$args</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_split_path_info</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> php:<span class="hljs-number"><span class="hljs-number">9000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> PATH_INFO <span class="hljs-variable"><span class="hljs-variable">$fastcgi_path_info</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ /\.ht</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; } }</code> </pre><br></div></div><br>  default.nginx is the config for nginx, which is forwarded to the container.  The key point here is the directive <b>fastcgi_pass php: 9000</b> .  It sets the address of the FastCGI server.  The address can be specified as a domain name or IP address, and a port. <br><br>  <b>php: 9000</b> - the service name is the address of the FastCGI server.  Nginx addressing php will receive the IP address of the container in which php works.  Port 9000 is a standard port, it is declared when creating the base container.  This port is available for nginx over the network, but is not available on the host machine, since it was not forwarded. <br><br><h4>  php </h4><br>  It is unusual that the image is not specified.  Instead, it builds its own image directly from the compose file.  The context directive points to the folder where the Dockerfile is located. <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="php hljs">FROM php:<span class="hljs-number"><span class="hljs-number">7.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>-fpm RUN apt-get update &amp;&amp; apt-get install -y \ libzip-dev \ zip \ &amp;&amp; docker-php-ext-configure zip --with-libzip \ &amp;&amp; docker-php-ext-install zip \ &amp;&amp; docker-php-ext-install mysqli COPY --from=composer:latest /usr/bin/composer /usr/bin/composer WORKDIR /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html</code> </pre><br></div></div><br>  The Dockerfile states that the base php image is used for the build: 7.3.2-fpm, then the commands are run to install the php extensions.  Next, the composer is copied from another base image and the working directory for the project is set.  More questions about the assembly will consider in other posts. <br><br>  Also inside the container, the php.ini file and the html folder with our project are forwarded. <br><br>  Note that php is on the backend network and, for example, a proxy can no longer access it. <br><br><h4>  mysql </h4><br>  It takes a basic mysql image with a tag 5.7, which is responsible for the version of mysql.  The folder ./docker/mysql/data is used to store the database files (you don‚Äôt even need to create it, you‚Äôll need to create it yourself at startup).  And through variable environments, a password is set for the root user, also root. <br><br>  The base is in the backend network, which allows it to keep in touch with php.  The basic image uses the standard port 3306. It is available on the docker‚Äôs network for php, but is not available on the host machine.  If you perform probros for this port, you can connect to it for example from the same PHPSTORM.  But if the phpmyadmin interface is enough for you, then this can be done. <br><br><h4>  phpmyadmin </h4><br>  The official image of phpmyadmin.  In environment variables, VIRTUAL_HOST is used to interact with the proxy, similar to nginx.  PMA_USER and PMA_PASSWORD access to the database.  And PMA_HOST host database itself.  But this is not localhost, as usual, but mysql.  Those.  connection to the database is available by the name of its service, i.e.  mysql.  The phpmyadmin container can connect to the database, as it has a connection to the frontend network. <br><br>  We start the services with the usual command: docker-compose -d. <br><br>  We see the following conclusion: <br><br><div class="spoiler">  <b class="spoiler_title">Starting services</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Creating network "lesson2_backend" with the default driver Building php Step 1/4 : FROM php:7.3.2-fpm ---&gt; 9343626a0f09 Step 2/4 : RUN apt-get update &amp;&amp; apt-get install -y libzip-dev zip &amp;&amp; docker-php-ext-configure zip --with-libzip &amp;&amp; docker-php-ext-install zip &amp;&amp; docker-php-ext-install mysqli ---&gt; Using cache ---&gt; 5e4687b5381f Step 3/4 : COPY --from=composer:latest /usr/bin/composer /usr/bin/composer ---&gt; Using cache ---&gt; 81b9c665be08 Step 4/4 : WORKDIR /var/www/html ---&gt; Using cache ---&gt; 3fe8397e92e6 Successfully built 3fe8397e92e6 Successfully tagged lesson2_php:latest Pulling mysql (mysql:5.7)... 5.7: Pulling from library/mysql fc7181108d40: Already exists 787a24c80112: Already exists a08cb039d3cd: Already exists 4f7d35eb5394: Already exists 5aa21f895d95: Already exists a742e211b7a2: Already exists 0163805ad937: Already exists 62d0ebcbfc71: Pull complete 559856d01c93: Pull complete c849d5f46e83: Pull complete f114c210789a: Pull complete Digest: sha256:c3594c6528b31c6222ba426d836600abd45f554d078ef661d3c882604c70ad0a Status: Downloaded newer image for mysql:5.7 Creating lesson2_php_1 ... done Creating lesson2_mysql_1 ... done Creating lesson2_phpmyadmin_1 ... done Creating lesson2_nginx_1 ... done</code> </pre><br></div></div><br>  We see that at the beginning there is a creation of a network lesson2_backend, then the assembly of the php image, then it can download images that are not yet in the system (pull) and actually launch the described services. <br><br>  The final touch to make it work is to add to hosts or domains site.local and phpmyadmin.local. <br><br>  The contents of index.php can be as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//phpinfo(); $link = mysqli_connect('mysql', 'root', 'root'); if (!$link) { die(' : ' . mysqli_error()); } echo ' '; mysqli_close($link);</span></span></code> </pre><br></div></div><br>  Here we check the correctness of the connection of the php extension - mysqli, which was added when building the Dockerfile. <br><br>  And note that to communicate with the container, the service name is used - mysql. <br><br>  The structure of the whole project is the following: <br><br><div class="spoiler">  <b class="spoiler_title">Project structure</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">habr/lesson2$ tree . ‚îú‚îÄ‚îÄ docker ‚îÇ ‚îú‚îÄ‚îÄ mysql ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ data ‚îÇ ‚îú‚îÄ‚îÄ nginx ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ conf.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ default.nginx ‚îÇ ‚îî‚îÄ‚îÄ php ‚îÇ ‚îú‚îÄ‚îÄ Dockerfile ‚îÇ ‚îî‚îÄ‚îÄ php.ini ‚îú‚îÄ‚îÄ docker-compose.yml ‚îú‚îÄ‚îÄ html ‚îÇ ‚îî‚îÄ‚îÄ index.php ‚îî‚îÄ‚îÄ proxy ‚îî‚îÄ‚îÄ docker-compose.yml</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/460173/">https://habr.com/ru/post/460173/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460159/index.html">Method of monitoring the current state of Russian highways with users' smartphones</a></li>
<li><a href="../460161/index.html">FusionPBX and ACL</a></li>
<li><a href="../460163/index.html">It seemed</a></li>
<li><a href="../460165/index.html">Background: quantum cryptography on the fingers</a></li>
<li><a href="../460169/index.html">A Guide to R recently, the most cited non-academic publication in academic papers</a></li>
<li><a href="../460175/index.html">Semiotics in marketing: what does it mean for your brand</a></li>
<li><a href="../460177/index.html">Wireless water leak sensor on nRF52832, DIY project</a></li>
<li><a href="../460179/index.html">LEAN + AGILE = AGILEAN or assemble the whole in parts</a></li>
<li><a href="../46018/index.html">Crisis vacancies</a></li>
<li><a href="../460181/index.html">Improve your JavaScript knowledge by parsing source code.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>