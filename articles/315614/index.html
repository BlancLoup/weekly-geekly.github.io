<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL: a couple of tricks in SELECT queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author: Yuri Tsyganenko, Senior QA 

 Testing of new functions is often carried out on data taken from an already functioning system. In this case, te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL: a couple of tricks in SELECT queries</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/09e/f4a/c9e/09ef4ac9e59f43a998ad78ab1aa55fa9.png"><br>  <i>Author: Yuri Tsyganenko, Senior QA</i> <br><br>  Testing of new functions is often carried out on data taken from an already functioning system.  In this case, testers sometimes have to build queries for tricky cases.  For example, you need to test the new functionality of an online store, and the intervals between purchases play a role.  We have access to data from a working version - you can download them to a test stand and test the operation of a new version of the product.  (NB !: of course, when dealing with ‚Äúlive‚Äù data, you need to exclude private information from them and ensure that users are interested in login). <br><br>  To select user accounts that we are interested in, we need to compare the maximum intervals between purchases from different users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The tester is required to build a SQL query that issues N users who have the longest intervals between order dates. <br><br>  Similar tasks and their analysis - under the cut. <br><a name="habracut"></a><br>  It is about finding a sequence of records / intervals using standard SQL tools.  Aggregate functions process all the data falling into the condition of the sample, and therefore it is impossible to do with them. <br><br>  As an example, take the weather sensor, periodically issuing a state of "clear" or "overcast" and the force of the wind.  Consider the tasks: <br><br>  1. The first part of the data is displayed in the 'Weather' table, which includes the fields: <br><br>  ‚Ä¢ time // Contains the measurement time; <br>  ‚Ä¢ clear // Contains an assessment of the purity of the sky: let 0 be overcast;  1 is clear. <br><br>  We need a request that issues several (say, three or less) longest periods (intervals) with clear weather.  In other words, a pair of records with clear weather, between which there will be no periods of dense clouds.  The uniformity of measurements is not implied. <br><br>  That is, the task is reduced to finding a set of three or less Period_1 ... Period_N values ‚Äã‚Äãin descending order. <br><br><img src="https://habrastorage.org/files/4c3/cbd/9a9/4c3cbd9a97324ae483dfdbcfd0b016a6.jpg"><br><br>  2. In the framework of the second task, we have a table similar to the first 'Wind' table, which includes records of the wind force at particular points in time.  It has two fields: <br><br>  ‚Ä¢ Time <br>  ‚Ä¢ Speed <br><br>  It is required to find all the ‚Äúlocal maxima‚Äù of the velocity ‚Äî that is, the instants of time and velocity values, in comparison with which the preceding and subsequent (in time) records have a lower velocity. <br><br><img src="https://habrastorage.org/files/c86/fdf/10f/c86fdf10f9204433aed85aa5942808c1.png"><br><br>  On the graph, local maxima correspond to 3, 10, 14, 17. For simplicity, we will not consider the boundary point 19. <br><br>  I suppose it is clear that the ‚Äúdirect‚Äù use of aggregate functions is indispensable: you need to state in some way that the points follow in succession.  To solve both problems, we use the tricks: <br><br>  1. Implicit Join a table with the same one: in the FROM field, separate the records and our table (for example, FROM Weather w1, Weather w2), separated by commas. <br><br>  Just in case: when selecting SELECT w1. *, W2. * FROM Weather w1, Weather w2;  All pairs of records will be displayed, including pairs that match and reverse in the reverse order.  That is, with 10 entries in the table will be 100. <br><br>  2. The exists () function, inside which we write a subquery. <br><br>  Both of these techniques are shown in the free SQL course (video): <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-vid-table_variables_and_set_operators/">here</a> and <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-vid-subqueries_in_from_and_select/">here</a> . <br><br>  A crude solution to the first problem: select all pairs of records with bad weather, between which all records with good weather, and not less than 1 (that is, there are no bad pods in the intermediate records): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (w2.time - w1.time) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Weather w1, Weather w2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> w2.time &gt; w1.time <span class="hljs-comment"><span class="hljs-comment">#     AND w2.clear=0 #      AND w1.clear=0 #      AND exists ( #   SELECT * FROM Weather wg WHERE wg.clear = 1 #    AND wg.time &gt; w1.time #      AND wg.time &lt; w2.time #   ) AND not exists ( #   SELECT * FROM Weather w3 WHERE w3.clear=0 #    AND w3.time&gt;w1.time #      AND w3.time&lt;w2.time #   ) Order by duration DESC LIMIT 3;</span></span></code> </pre> <br>  Nuances: in different DBMS you may need: <br><br>  ‚Ä¢ conversions for the timestamp type so that w1.time and w2.time can be subtracted; <br>  ‚Ä¢ limit on the number of output lines - limit or top. <br><br>  Problems with this solution: <br><br>  ‚Ä¢ Observation period boundaries: if all the records in the table are only with fair weather, we will not receive a response.  As, however, we will not receive clear weather periods at the beginning and end of observations; <br>  ‚Ä¢ The answer does not contain accurate data on the first and final recording with good weather. <br>  Strictly speaking, such a solution does not meet the condition of the problem (‚Äúa pair of records with clear weather, between which there is no other ...‚Äù). <br><br>  Both problems are treated by the same methods. <br><br>  We perfect the solution: we are looking for pairs of records with good weather, between which there are no records with bad weather.  And so that the first entry in the pair would not have a previous entry with good weather (i.e., it would be a entry that starts a clear period).  Accordingly, the second entry in the pair should not have a subsequent entry with good weather (i.e., the recording would close the clear period). <br><br>  I suppose enough query ideas. <br><br>  Solution of the second problem: we are looking for triples of consecutive records in which the wind speed at the midpoint is greater than in each of the neighboring ones.  The neighborhood is checked by the exists function as in the first task: not exists (...).  The order of the points is checked by comparing the time values. <br><br>  This concludes the article and once again recommends the <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/">Stanford course</a> ! <br><br>  Enjoy! </div><p>Source: <a href="https://habr.com/ru/post/315614/">https://habr.com/ru/post/315614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315602/index.html">Founder's advice. As an online service of Egor Egereva transforms the event-market of Russia</a></li>
<li><a href="../315604/index.html">How we did the interactive quest for RailsClub</a></li>
<li><a href="../315606/index.html">C ++ 17 and C ++ 2a: news from the ISO meeting in Issaqua</a></li>
<li><a href="../315608/index.html">CSP bypass using Google Chrome extensions</a></li>
<li><a href="../315610/index.html">Security Week 46: OAuth 2.0 bypass, low-voltage ICMP DDoS, iOS privacy and loxcreen bypass</a></li>
<li><a href="../315616/index.html">Briefly and simply about the difficult - tariffing in "8-800"</a></li>
<li><a href="../315618/index.html">Connect Akuvox IP phones to Avaya PBX without a SIP license</a></li>
<li><a href="../315620/index.html">Headman and Neighbors</a></li>
<li><a href="../315622/index.html">Comparing objects by value - 5: Structure Equality Problematic</a></li>
<li><a href="../315624/index.html">Without TK: how do developers get involved in this</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>