<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeRTOS + STM32F4 C ++ for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! It has been a long time since I last programmed under AVR and now I decided to recall such an undoubtedly interesting and fascinating area o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeRTOS + STM32F4 C ++ for Linux</h1><div class="post__text post__text-html js-mediator-article"> Good day!  It has been a long time since I last programmed under AVR and now I decided to recall such an undoubtedly interesting and fascinating area of ‚Äã‚Äãdevelopment - development for microcontrollers.  The ARM STM32 was chosen as the platform, and in order not to waste time on trifles, the Cortex-M4 was immediately launched.  STM32F4DISCOVERY debug board with STM32F407 on board.  A megabyte of flash and 128 kb of memory makes it possible not to bother much about saving resources and writing in C ++. <br><br>  So, the task: to learn from scratch to blink LEDs under the STM32 in FreeRTOS, but it is fashionable to do it - in C ++, and not on pure C. <br><a name="habracut"></a><br>  The implication is that you are already working with Eclipse, know how to add add-ons to it, and know in general terms how Linux works. <br><br>  After reading a bunch of manuals, hautushek and other information on the Internet, I put everything and ... nothing happened, did not work, did not compile, and if compiled, it would not start on a piece of iron.  In the end, all the same, everything turned out, and, since I am not a fan of the rake, I decided to write this post. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Tulchain</b> <br><br>  Installing and setting up the development environment took me two days.  Therefore, I will give a set that really worked for me and will describe in detail the problems I encountered: <br>  - <a href="http://www.eclipse.org/downloads/index.php">Eclipse Kepler</a> (for C / C ++) <br>  - GCC <br>  - texane / stlink <br><br>  The trouble was with GCC for arm-none-eabi.  There are a lot of variants of the toolchain, I tried two and really earned both.  However, there is still a slight difference between them: <br>  - GNU Arm toochain can be found <a href="https://launchpad.net/gcc-arm-embedded">here.</a> <br>  - Mentor Graphics CodeSourcery EABI can be taken <a href="http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/request%3Fid%3De023fac2-e611-476b-a702-90eabb2aeca8%26downloadlite%3Dscblite2012%26fmpath%3D/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/form">here</a> , will be asked to enter their data, send a link to download by mail .. <br><br>  By the way, at first I installed arm-linux-gnueabi from my Linux distro.  It‚Äôs not worth it, it‚Äôs not suitable for our purposes, but if Linux is on your ARM, then yes, it‚Äôs the most. <br><br>  So, we put the compiler wherever we want, but we will definitely write the path to it in the user's PATH.  How to do it - depends on the operating system with which you work.  I threw this pair of tulcheins into / opt and made a symlink / opt / arm-toolchain - as it were, by default. <br><br>  <b>Programmer</b> <br><br>  Next, we clone <a href="https://github.com/texane/stlink">stlink</a> from Github in any convenient way.  Going as usual: <br><br> <code><a href="https://github.com/texane/stlink"></a> # git clone github.com/texane/stlink</code> <br> <code># cd stlink</code> <br> <code># ./automake</code> <br> <code># ./configure --prefix=/usr/bin</code> <br> <br>  Do not forget about libusb-dev, it was not installed in my Debian Wheezy.  If there is not enough of any other, we put them as it is done in your system. <br><br>  <b>Development environment</b> <br><br>  Further, the most interesting for me is setting the clip for the development.  I did not succeed in setting up the project so that everything compiles and runs on pure Eclipse.  Therefore, you can put useful plugins.  However, after a certain degree of clarity of settings has been achieved - you can dig deeper and customize the project for yourself without plug-ins. <br><br>  There are enough different plugins for ARM development, here are a couple: <br>  - GNU Arm Eclipse can be found <a href="http://sourceforge.net/projects/gnuarmeclipse/">here.</a> <br>  - Zylin CDT is <a href="http://opensource.zylin.com/embeddedcdt.html">here</a> <br><br>  For both there are update sites, plug-ins are installed in a standard way for a clip from a menu.  We put both. <br><br>  Next, create a C ++ project in Eclipse, choose what it will be under ARM (ARM Cross GCC tulchein), then choose the tulchein type depending on which compiler you chose: CodeSourcery or ARM GCC.  In general, plugins support all sorts of different sets of compilers - you can play around with them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e8/4f7/6a1/1e84f76a1c76ed6db6318c3758b4bc4d.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd4/ddf/b47/fd4ddfb479ce311e4a67d939fdb5e6a2.png"><br><br>  There is one problem here - I did not find libnosys.a in CodeSourcery.  I had to take it from the GNU Arm GCC.  In general, the flight is normal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c8a/51a/0b2/c8a51a0b29f7dc9cb11daa52ec027bce.png"><br><br>  <b>findings</b> <br><br>  Now, a small digression about what problems the plugin solves.  You will have to deal with this if you customize the project for yourself and you are a beginner.  For me it was all a discovery, because  I never wrote firmware before. <br><br>  - there is no libc on the controller.  Firmware is compiled statically. <br>  - and there is no operating system (it will be built into the project), no bootloader - the program will start running immediately after switching on. <br><br>  The plugin solves a handful of tasks - it provides us with the necessary CMSIS and Standard Perepherials in the project we have just created.  These libraries are needed to work with the controller's periphery. <br><br>  You can, of course, fasten libopencm3 instead of the libraries provided by the manufacturer, but this is a topic for a separate article. <br><br>  The pgagin also provides a linker scripts set.  Honestly, I ran into them for the first time.  The linker script describes the structure of the binary file, the section, the entry point, and much more.  Collecting all this piece by hand manually is dreary and uninteresting, while the project has not even started on a piece of iron, but then what is the scope for studying. <br><br>  Plugin is configured from the project properties, in fact, in the project they store their settings. <br><br>  <b>Configuring the debugger</b> <br><br>  In general, this piece can be done at the very end, but the fact that debugging has worked is already a sign that everything is set up.  Therefore, we will do it in advance. <br><br>  Naturally, GDB is used as a debugger.  Configure the GDB server application, which will be the utility from texane / stlink. <br><br>  Go to the External Tools and add the toolkit.  It will need to be run every time if we need debugging, with the board connected.  The utility will upload a debug image and serve as a server.  The key -m just tells it not to fall off every time the connection with the debugger is interrupted, which is very convenient in my opinion. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/575/60d/888/57560d8883e1e923e4779175130378b1.png"><br><br>  Next, create a debug target.  Everything is simple, we take a tulchein debugger, specify port 4242 - this is the default GDB server port. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9d4/1ea/9fd/9d41ea9fd5f0e50f3b04d307a78955f8.png"><br><br>  We start the debugging server, we connect to the target - it will assemble the project, flood the binary into the piece of hardware and launch it.  You can debug. <br><br>  <b>FreeRTOS</b> <br><br>  Since everything that is necessary for the project to be able to be assembled at all is given to us by the plug-in (which, by the way, created even the flashing template with a LED), you can take to assemble it and fill it with a piece of iron.  If the LED blinks and everything works, we begin to integrate the OS. <br><br>  The structure of the project created by the plugin will have the libs directory, where CMSIS, StdPeriph and others are already located.  That's where we throw FreeRTOS.  Further, in order for the operating system to work, you need to configure it.  Manuals (including official ones) for setting up FreeRTOS on the Internet with a shaft, therefore I will not describe it here.  In short, do the following: <br><br>  1) create FreeRTOSConfig.h and put it to RTOS headers <br>  2) take from the portable port for our piece of iron and put the port files along with the rest of the RTOS sources. <br>  3) find the source manager RTOS memory manager, for example, heap_2.c and put it there too. <br><br>  By the way, in the config from RTOS you need to specify the real clock processor, the same one that was specified when creating the project.  I have this 168000000. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configCPU_CLOCK_HZ ( ( unsigned long ) 168000000 ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configTICK_RATE_HZ ( ( portTickType ) 1000 )</span></span></code> </pre><br><br>  And also add this: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> vPortSVCHandler SVC_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> xPortPendSVHandler PendSV_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> vPortSVCHandler SVC_Handler #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> xPortSysTickHandler SysTick_Handler</span></span></code> </pre><br><br>  And enable vTaskDelay as it will be used for waiting between the blinks of the LED: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INCLUDE_vTaskDelay 1</span></span></code> </pre><br><br>  Do not forget to set the path to our FreeRTOS in the project settings: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/143/cad/d45/143cadd451c33740f9c98519e3160901.png"><br><br>  In general, there are many different settings in the project, from which the compiler, assembler and linker parameters are formed.  You can play, see what will happen;) <br><br>  The minimum is configured, now you can try to collect.  If something is forgotten, it will simply not be collected or it will not work. <br><br>  <b>And now <s>dancing</s> app!</b> <br><br>  We will write the application in C ++, and we will move from pure C to C ++.  I have not written in these languages ‚Äã‚Äãfor a long time, so do not judge strictly. <br><br>  Project on <a href="https://github.com/futurelink/stm32/tree/master/stm32test">githaba</a> . <br><br>  With Tasks, there is one nuance with which I, while switching to C ++, have suffered a little: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Application::attach(Task *task) { FNMETHOD impl = &amp;Task::impl; pdTASK_CODE proc = ((pdTASK_CODE)(task-&gt;*impl)); xTaskCreate( proc, (<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *) <span class="hljs-string"><span class="hljs-string">"test"</span></span>, configMINIMAL_STACK_SIZE, task, <span class="hljs-number"><span class="hljs-number">2</span></span>, (xTaskHandle *) <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br><br>  The first parameter is a pointer to the method in which the task is implemented.  The fourth parameter in xTaskCreate is a pointer to an instance of the Task class.  It is necessary to pass a pointer to an instance, otherwise the implementation method will not have access to the Task class variables - in this case, the pin LED and the delay. <br><br>  But everything else is simple.  Have a nice day and successful builds.  Questions welcome! <br><br>  PS And what kind of environment under Linux for this purpose do you use?  ;) <br><br>  PPS We must understand that this post is not written by a system programmer and is designed to help high-level comrades who want to enter the world of firmware development.  Therefore, the assembler guru please do not be angry ^ - ^ </div><p>Source: <a href="https://habr.com/ru/post/211578/">https://habr.com/ru/post/211578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211568/index.html">Freedom from habits. Myth or fiction?</a></li>
<li><a href="../211570/index.html">IBM improves graphene transistors</a></li>
<li><a href="../211572/index.html">We set up our own SMTP server on the Jelastic platform in the InfoboxCloud cloud</a></li>
<li><a href="../211574/index.html">Modifying UEFI BIOS, Part One: Introduction to UEFITool</a></li>
<li><a href="../211576/index.html">Creating the game on your eyes - part 3: Screwing the scripting language to Unity (UniLua)</a></li>
<li><a href="../211580/index.html">What exactly do I hate for some individual marketers - or as an IT pros go shopping</a></li>
<li><a href="../211582/index.html">Results of CES 2014: Samsung AV News</a></li>
<li><a href="../211584/index.html">Dr.Web for licensed content</a></li>
<li><a href="../211588/index.html">Live webcast ALM Summit</a></li>
<li><a href="../211590/index.html">Repeatable, another way to render lists</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>