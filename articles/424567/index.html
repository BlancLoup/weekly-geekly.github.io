<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience blocking online advertising in the company's local network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habrovchane! Having received from the management the task of blocking advertisements on Internet sites for employees, I decided to approach the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience blocking online advertising in the company's local network</h1><div class="post__text post__text-html js-mediator-article">  Hello, habrovchane!  Having received from the management the task of blocking advertisements on Internet sites for employees, I decided to approach the process creatively: to figure out how this or that advertisement is technically broadcast, what methods of blocking exist, their pros and cons.  I also cite as an example the implementation of blocking at the gateway level using Traffic Inspector Next Generation, as well as using the ad blocking option in Kaspersky Internet Security (hereafter KIS) and AdBlock and Adblock Plus browser applications for this purpose.  The article will be interesting to sysadmins and other specialists working with local networks. <br><br><img src="https://habrastorage.org/webt/_g/p1/zz/_gp1zz7zaaxbn7tvaj-jfgmeqdw.png"><br><a name="habracut"></a><br><br>  Why block ads, in my opinion, is clear: to increase the speed of loading pages and the consumption of traffic, to combat plugin-container memory consuming, and spyware scripts that monitor user actions.  And most importantly, why management has raised this issue at all, is a distraction: advertising shifts the employee‚Äôs attention from the task being carried out to a tempting offer, often specially tailored for it by clever algorithms.  By the way, every two years the number of computers with blocked advertising in the world <a href="https://www.economist.com/business/2015/06/04/block-shock">triples</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, in a nutshell, how can you <b>block ads</b> . <br><br>  Firstly, there are applications for browsers that use dozens of different algorithms and schemes for each type of content and even for some separately taken platforms (Facebook, for example).  The most popular cutters are AdBlock and Adblock Plus (hereinafter referred to as ADP).  In my opinion, ADP is more effective of them, but sometimes useful content gets under its powerful skating rink (at the end).  For me, the lack of all such solutions is that they are put on each computer and, moreover, on each browser.  When you have hundreds of computers in LAN, it becomes a problem. <br><br>  Secondly, many antivirus programs (for example, we use Kaspersky) have an in-built ad blocking option.  The advantage of this method is that once you use an antivirus, you don‚Äôt need to add anything to your computer - just activate the function in the menu.  But since this function is not the main one, it works worse than the applications that were specially sharpened for this business. <br><br>  Thirdly, advertising can be cut by a <a href="https://www.smart-soft.ru/products/ting/">network gateway</a> .  Blocking occurs by redirecting HTTP requests from advertising sites to the address 0.0.0.0.  For me, a huge plus is that the lock works immediately for the entire local network.  The main drawback - you need to monitor the relevance of the database of advertising addresses and, if necessary, add them manually.  The second drawback is that only one blocking mechanism is used - via HTTP requests, and yet not all types of ads use them. <br><br>  Looking ahead, I will say that in my LAN I use all three methods - they complement each other well.  Details - at the end of the article, and now let's see what <b>types of advertising are</b> . <br><br>  SEO and all sorts of emails there are not interesting to us now.  We are interested in advertising, which is broadcast along with useful content.  By this principle, I broke it into the following types: <br><br>  1. <b>Embedded ad units of</b> such services as the Yandex Advertising Network and Google.Adsense. <br><br>  These are text, text-graphic modules and simply banners that are placed by the owners of the sites for earnings.  In my opinion, this is the most harmful type of advertising, because it: a) often mimics useful content and mixes with it to increase clickability;  b) shows the user what he is most likely to be interested in (we all know about big data, behavioral factors, etc., etc.);  c) shows that the user (in our case, the employee) is not needed at the moment, that is, distracts from work. <br><br>  Take a few resources with this type of advertising: <br><br>  1.1.  <a href="https://sharpologist.com/2018/08/whats-menthol-shaving-stuff.html">sharpologist.com/2018/08/whats-menthol-shaving-stuff.html</a> <br>  The Google banner was neatly cut out with KIS tools - the layout did not suffer, no voids were formed: <br><br><img src="https://habrastorage.org/webt/bh/9c/rb/bh9crb5yvzo3c6qcwohczzsg-am.png"><br><br>  1.2.  There are also blocks that use user requests, which he entered earlier in a search engine (for example, on <a href="https://zmoe.ru/">zmoe.ru</a> ): <br><br><img src="https://habrastorage.org/webt/kt/lv/ku/ktlvkuue_ziu0_5tznnudh-gw08.png"><br><br>  1.3.  <a href="https://www.bestfree.ru/">www.bestfree.ru</a> is a great example of a re-optimized SEO site, expectedly filled to capacity with advertising.  Red boxes are marked with ad units (see picture on the left).  All of them were blocked (see right): <br><br><img src="https://habrastorage.org/webt/n5/sf/vy/n5sfvy19ryxdbj3xc3t-jv3bn9o.png"><br><br><img src="https://habrastorage.org/webt/s_/rp/8i/s_rp8ieaoaz_aus2gsy6oudgbua.png"><br><br><img src="https://habrastorage.org/webt/d6/wo/v_/d6wov_hraqf75ltdijohklncxcw.png"><br><br>  1.4.  A bad example of ad blocking is Mail.ru mail.  On the inbox page, the Yandex Advertising System manifests itself twice: in the information bar above the list of letters and the ad unit on the left.  Not a single insert was blocked by any of the methods used by me: <br><br><img src="https://habrastorage.org/webt/cj/gd/mt/cjgdmtbo6lfjzjlu517p2ifzj1y.png"><br><br>  2. <b>Banner exchange, teaser, RTB-networks</b> such as Rotaban, advmaker.net, Marketgid, etc. <br>  They can‚Äôt show personalized ads like Google or Yandex, but take on their intrusiveness. <br><br>  2.1.  The banner banner on adindex.ru (Adriver advertising network) was cut out by the AdBlock browser application: <br><br><img src="https://habrastorage.org/webt/lt/oa/ke/ltoakewcmb5zr69rehsut0sbzti.png"><br><br>  Note that AdBlock cuts out the whole div and iframe, so that even a white rectangle does not remain. <br><br>  2.2.  Here is an example of another AdIndex network block that mimics content that was also coolly cut out by a browser plugin: <br><br><img src="https://habrastorage.org/webt/a_/gu/uy/a_guuyimlqgmgcrhx2nlr5w6yc8.png"><br><br>  3. <b>Popup windows</b> <br><br>  The most perplexing advertising format, especially when a pop-up window prevents you from entering the site or closes some of the content.  From the sites with pop-ups, I did not find anything decent for the test, so I used treshovy megashara.com.  Browser applications coped with the task perfectly.  But with the network gateway is not so simple.  On the one hand, ‚Äúmegashara‚Äù sends HTTP requests by which pop-ups can theoretically be blocked, but, on the other hand, it constantly gives out mirrors with different URLs, so in practice it is impossible to do this.  And if pop-up windows work through JavaScript, then at the gateway level it‚Äôs generally unrealistic to block them.  (However, megashara.com is completely blocked in my lokalka.) <br><br>  4. <b>Affiliate programs</b> <br><br>  Usually they are distributed by large online stores and lead generation services.  For example, if you are the owner of a portal about books, then you can use the Labyrinth affiliate program and place their code on your website - the online store will pay you money from each transition.  For example, entered the site <a href="http://marketopedia.ru/">marketopedia.ru</a> .  This is what the partner module looks like: <br><br><img src="https://habrastorage.org/webt/al/eg/l6/alegl6js26r7xsy9ns7vzgtpb4q.png"><br><br>  Such a seemingly simple thing couldn‚Äôt be overcome with anything because this farm is working in JavaScript.  However, this type of affiliate program is quite rare and, as a rule, looks non-aggressive - you can give up on it. <br><br>  But the affiliate program from Amazon at sharpologist.com was successfully blocked by browser applications: <br><br><img src="https://habrastorage.org/webt/zq/z_/oa/zqz_oamvosnmm5i1oa14scginy0.png"><br><br>  5. Advertising on YouTube. <br><br>  First of all, these are clips that anticipate watching the main video, clips that interrupt viewing, and advertisements that pop up over the video. <br><br>  I took the <a href="https://www.youtube.com/watch%3Fv%3DWOs84XQ0xT0">first video that</a> I <a href="https://www.youtube.com/watch%3Fv%3DWOs84XQ0xT0">got</a> - an advertising video first popped up: <br><br><img src="https://habrastorage.org/webt/6k/rm/fn/6krmfnouuboevpvy21dsvlw3ss4.png"><br><br>  The promotional video was going to be broadcast for a full minute;  it's good that you could skip it in 10 seconds.  Then I saw the full stuffing: both a banner and embedded commercials: <br><br><img src="https://habrastorage.org/webt/lv/qm/dw/lvqmdwjvs-3vbxtmyavh3nxoino.png"><br><br>  I run ADP - and voila, this is nothing: <br><br><img src="https://habrastorage.org/webt/i6/ip/nq/i6ipnqqdjhh3sgwmbtgxrfivlqy.png"><br><br>  6. <b>Embedded banners</b> <br><br>  From the point of view of blocking, this is the most difficult case, because the blocker, in fact, needs to ban the picture.  How among all the pictures on the page to find exactly advertising, without affecting the rest?  In browser applications there is an analysis of their sizes, because banners, as a rule, have standard sizes.  Obviously, this method will not work if the banner of non-standard proportions. <br><br>  6.1.  For a start, I took cnews.ru, that's how it is with him: <br><br><img src="https://habrastorage.org/webt/nc/85/ks/nc85ksdkzlgctcsr2kqt5r3encq.png"><br><br>  As you can see, AdBlock has successfully cut all the banners, including advertising cnews.ru :) <br><br>  6.2.  A less successful example is the affiliate banner on the website lezvie.info: <br><br><img src="https://habrastorage.org/webt/js/7z/oi/js7zoinefdq4qm3_6fcuwbcmjvy.png"><br><br>  It was not blocked by any of our filter.  See the code: <br><br><img src="https://habrastorage.org/webt/io/8v/v_/io8vv_7dqxczvvw0hb0xckicj0a.png"><br><br>  Sizes 300x416 - this is a non-standard format (in any case, it‚Äôs not in the list of <a href="https://support.google.com/adsense/answer/6002621%3Fvisit_id%3D636718272484556748-2133721257%26rd%3D1">standard Google.Adsense sizes</a> ), so the banner predictably remained in its place. <br><br>  7. <b>Contextual advertising in search</b> <br><br>  In my opinion, this is the most innocuous type of advertising that I would not block at all.  If a person is looking for something in a search engine and relevant ads are shown to him, there is nothing wrong with that.  On the contrary, they help to find what you need, especially if the requests are commercial. <br>  For the sake of interest, I looked whether contextual ads are blocking browser applications: <br><br><img src="https://habrastorage.org/webt/hs/yr/ri/hsyrri_lzjujgicvsfvx0xkl7pa.png"><br><br>  As you can see, ads and banners have been blocked, but there are suggestions from Yandex.Market. <br><br>  8. <b>Advertising in social networks</b> <br><br>  I will not develop this topic in this article, because I consider (and the management agrees with me) that social networks should be blocked at all in the workplace. <br><br>  <b>What is the best blocking?</b> <br><br>  The most effective way was to block the browser application, and ADP proved to be better than AdBlock.  But there are three points that confuse me greatly. <br><br>  <b>ADP Problem # 1</b> Cuts everything, including useful content.  Take, for example, the site vedomosti.ru - it has not only purely advertising, but also semi-advertising banners with announcements of events that may be useful to the reader.  And there are completely harmless banner links.  Everything is cut to zero. <br><br><img src="https://habrastorage.org/webt/cu/ow/j8/cuowj8z3rzjt2zpv-oeb3dwtxdy.png"><br><br>  The ADP icon in the browser header shows how many banners were cut out on the plugin on this page, just what is the use of it?  The feeling of not seeing something important, blocked by mistake, does not leave. <br><br>  <b>ADP Problem # 2</b> Faced sites that ask to disable ad blocking before showing content.  And these are not some sludge resources, but sites like forbes.com.  WordPress even has the Block Adblock plugin, which blocks content for those who use Edblock. <br><br><img src="https://habrastorage.org/webt/jj/e-/9f/jje-9fvynyf3yk0wvcctmvjbnno.png"><br><br>  Of course, there is no such problem with the gateway blocker. <br><br>  <b>ADP Problem 3</b> Plug-ins must be installed on each computer and on each browser.  And it is not enough to install - then you will have to run for each request: someone has blocked something useful, someone does not open the site.  Do I need it? <br><br>  <b>Antivirus blocking</b> works worse than ADP, but better than the redirection of HTTP requests at the gateway level.  There is nothing more to say here. <br><br>  <b>Blocking by the network gateway</b> , as I have already said, occurs due to redirection of requests directed to advertising sites to the address 0.0.0.0.  I used the <a href="https://www.smart-soft.ru/products/ting/">Traffic Inspector Next Generation S100</a> piece of hardware running on OPNsense. <br><br>  I will describe in a nutshell how I set up the lock (instructions <a href="http://www.smart-soft.ru/support/documentation/handbook/ting/adblock.html">here &gt;&gt;</a> ).  Using ssh, I went to the hardware and installed the curl package (https://curl.haxx.se/) with the command: pkg install curl. <br><br><img src="https://habrastorage.org/webt/ct/05/er/ct05erry1ut93z4dex2v-i4mt48.png"><br><br>  Then I ran the script to initialize the list of blocked web resources <b>update-hosts.sh</b> .  After forming the list, I launched the Unbound DNS function for Traffic Inspector Next Generation, selected ‚ÄúServices‚Äù -&gt; ‚ÄúUnbound DNS‚Äù -&gt; ‚ÄúGeneral Settings‚Äù in the web interface.  Enabled DNS resolver, DNS forwarding, DHCP registration.  In the user settings indicated the file list of blocked web resources /var/unbound/ad-blacklist.conf.  Saved settings.  Now the piece of iron has become a DNS server. <br><br><img src="https://habrastorage.org/webt/fv/f6/kt/fvf6ktlyqnltpsfk9xq7kyx3jno.png"><br><br>  Then I installed a new DNS server as a DHCP server: ‚ÄúServices‚Äù -&gt; ‚ÄúDHCP v4‚Äù -&gt; ‚ÄúLAN‚Äù -&gt; ‚ÄúEnable DHCP server on the LAN interface‚Äù.  On the users' computers, DHCP servers must be specified by Traffic Inspector Next Generation, then the piece of hardware will automatically be registered as a DNS server: <br><br><img src="https://habrastorage.org/webt/l6/r0/qu/l6r0qunzrb85jd2cpauecb2bkzq.png"><br><br>  Now, in the case of redirection to pages with advertising, it is blocked. <br>  The list of blocked resources by default is downloaded from the <a href="http://winhelp2002.mvps.org/hosts.txt">http://winhelp2002.mvps.org/hosts.txt</a> file.  But to this list I have a lot of questions.  For example, why in it, by default, there are no addresses that use Yandex and Google in their advertising networks?  This means that the most annoying type of advertising (see point 1) will not be blocked.  I had to prescribe them manually.  In order to add a new address for blocking, you need to add the address in the following file format: server: local-data: ‚Äú&lt;address of the resource being blocked&gt; A 0.0.0.0‚Äù and restart the Unbound DNS service. <br><br>  <b>Instead of a resume</b> <br><br>  My recipe for blocking ads on the local network is simple: <br><br>  1. Activate the lock at the gateway level. <br><br>  2. We add Yandex and Google advertising networks to blockable addresses (or make sure they are there), as well as other addresses you want. <br><br>  3. We inform employees that they can install an ad blocker on an individual request, and install it for those who really need it. <br><br>  4. We block at the gateway level social networks, job search sites and other non-targeted resources, and then the problem of blocking ads on them will disappear by itself :) <br><br>  PS As I wrote above, the list of blocked HTTP requests in Traffic Inspector Next Generation <a href="http://winhelp2002.mvps.org/hosts.txt">comes</a> from the file <a href="http://winhelp2002.mvps.org/hosts.txt">winhelp2002.mvps.org/hosts.txt</a> , but this list is not as complete as it could be.  If among the readers will be prosharennyh specialists who know where to get more relevant lists (especially taking into account the specifics of the Runet), please write in the comments.  If there are such lists, I will register them in the script.  By the way, technical support informed me that OPNsense is discussing the addition of a special plug-in to manage such lists, but for now this is not in production. </div><p>Source: <a href="https://habr.com/ru/post/424567/">https://habr.com/ru/post/424567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424557/index.html">Node.js Part 8 Tutorial: HTTP and WebSocket Protocols</a></li>
<li><a href="../424559/index.html">Big Data resistance 1 or elusive Joe. Internet anonymity, anti-detection, anti-tracking for anti-you and anti-us</a></li>
<li><a href="../424561/index.html">Russian program to create a global satellite Internet network may lose a single investor</a></li>
<li><a href="../424563/index.html">Beeline sends details of conversations to strangers</a></li>
<li><a href="../424565/index.html">Review: 3D scanning of real estate premises</a></li>
<li><a href="../424569/index.html">Hiring programmers. Tips from the programmer</a></li>
<li><a href="../424571/index.html">Corporate Das Experiment</a></li>
<li><a href="../424573/index.html">Life and death of mitochondria</a></li>
<li><a href="../424575/index.html">Fast resize dzhipegov on the video card</a></li>
<li><a href="../424577/index.html">JUG.EKB: we integrate with the help of Java developers ‚Äômeaps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>