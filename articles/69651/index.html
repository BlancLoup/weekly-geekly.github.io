<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the Google Analytics API to build site visit statistics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working on one of the ‚Äúpatronized‚Äù sites, it became necessary to build a kind of internal statistics system for visiting the site‚Äôs pages. Google...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the Google Analytics API to build site visit statistics</h1><div class="post__text post__text-html js-mediator-article">  When working on one of the ‚Äúpatronized‚Äù sites, it became necessary to build a kind of internal statistics system for visiting the site‚Äôs pages.  Google Analytics came to the rescue, or rather Google Analytics API. <br><a name="habracut"></a><br><br>  Actually, the task was as follows: <br><ul><li>  there is a leased dedicated server with a small supply of resources, a self-written (inherited) CMS, implemented using PHP and MySQL, ‚Äúnot very much‚Äù optimized for high loads </li><li>  it is necessary to build the correspondence of the document id =&gt; number of unique views of the document per day </li><li>  keep statistics also for week, month, year </li></ul><br><br>  Immediately it should be noted that for a long time the ‚Äúbuilt-in‚Äù mechanism of counting and storing these statistics was used, which was periodically copied, optimized, added, transferred and so on ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The result was the decision to use as a repository statistics of third-party services (the final version was a hybrid with a buffer table in the database).  After some deliberation, it was decided to use Analytics through the API. <br><br>  In order not to reinvent the wheel, I decided to use <a href="http://code.google.com/p/gapi-google-analytics-php-interface/">this library</a> to access Analytics data. <br><br>  Further, let the URL of all pages for which statistics are needed is unified - <a href="http://www.site.ru/%25id%25.html">www.site.ru/%id%.html</a> , where id is a strictly integer parameter.  If necessary, replacing one regexp this requirement is easily bypassed. <br><br>  For example, let all materials for which statistics are needed are in the same table art (id, name, ...) in the database and the id of this table matches the id in the URL. <br><br>  Next, create a buffer table for storing statistics for yourself: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> `art_stat` ( <br> `art_id` <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `day_stat` <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> , <br> `week_stat` <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> , <br> `month_stat` <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> , <br> `year_stat` <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> , <br> <font color="#0000ff">UNIQUE</font> ( <br> `art_id` <br> ) <br> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Further, I provide the code itself with minimal comments. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <br> set_time_limit(0); <br> <br> require_once <font color="#A31515">'start.php'</font> ; <font color="#008000">//     </font> <br> <br> require_once <font color="#A31515">'gapi.class.php'</font> ; <font color="#008000">//  </font> <br> <br> <font color="#008000">//      -   </font> <br> define( <font color="#A31515">'ga_email'</font> , <font color="#A31515">'...'</font> ); <br> define( <font color="#A31515">'ga_password'</font> , <font color="#A31515">'...'</font> ); <br> define( <font color="#A31515">'ga_profile_id'</font> , <font color="#A31515">'...'</font> ); <br> <br> <font color="#008000">//   </font> <br> <font color="#008000">//   ,     </font> <br> <font color="#008000">// d -  </font> <br> <font color="#008000">// w -  </font> <br> <font color="#008000">// m -  </font> <br> <font color="#008000">// y -  </font> <br> set_stat( <font color="#A31515">'d'</font> ); <br> <br> function set_stat( $time_limiter = <font color="#A31515">'d'</font> ) { <br> <br> <font color="#0000ff">switch</font> ( $time_limiter ) { <br> <font color="#0000ff">case</font> <font color="#A31515">'d'</font> : <br> <font color="#008000">// Day</font> <br> $start_stamp = mktime( date( <font color="#A31515">"H"</font> ), date( <font color="#A31515">"i"</font> ), date( <font color="#A31515">"s"</font> ), date( <font color="#A31515">"n"</font> ), date( <font color="#A31515">"j"</font> )-1, date( <font color="#A31515">"Y"</font> ) ); <br> $field = <font color="#A31515">'day_stat'</font> ; <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">case</font> <font color="#A31515">'w'</font> : <br> <font color="#008000">// Week</font> <br> $start_stamp = mktime( date( <font color="#A31515">"H"</font> ), date( <font color="#A31515">"i"</font> ), date( <font color="#A31515">"s"</font> ), date( <font color="#A31515">"n"</font> ), date( <font color="#A31515">"j"</font> )-7, date( <font color="#A31515">"Y"</font> ) ); <br> $field = <font color="#A31515">'week_stat'</font> ; <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">case</font> <font color="#A31515">'m'</font> : <br> <font color="#008000">// Month</font> <br> $start_stamp = mktime( date( <font color="#A31515">"H"</font> ), date( <font color="#A31515">"i"</font> ), date( <font color="#A31515">"s"</font> ), date( <font color="#A31515">"n"</font> )-1, date( <font color="#A31515">"j"</font> ), date( <font color="#A31515">"Y"</font> ) ); <br> $field = <font color="#A31515">'month_stat'</font> ; <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">case</font> <font color="#A31515">'y'</font> : <br> <font color="#008000">// Year</font> <br> $start_stamp = mktime( date( <font color="#A31515">"H"</font> ), date( <font color="#A31515">"i"</font> ), date( <font color="#A31515">"s"</font> ), date( <font color="#A31515">"n"</font> ), date( <font color="#A31515">"j"</font> ), date( <font color="#A31515">"Y"</font> )-1 ); <br> $field = <font color="#A31515">'year_stat'</font> ; <br> <font color="#0000ff">break</font> ; <br> <br> } <font color="#008000">// End switch</font> <br> <br> $end_date = date( <font color="#A31515">'Ym-d'</font> ); <br> $start_date = date( <font color="#A31515">'Ym-d'</font> , $start_stamp ); <br> <br> echo <font color="#A31515">"From "</font> . $start_date . <font color="#A31515">" to "</font> . $end_date . <font color="#A31515">"&lt;br&gt;"</font> ; <br> <br> $ga = <font color="#0000ff">new</font> gapi(ga_email,ga_password); <font color="#008000">//      </font> <br> <br> $start_index = 1; <br> $max_results = 500; <br> <br> $filter = <font color="#0000ff">null</font> ; <font color="#008000">//  .   ,     ,     </font> <br> <br> <font color="#008000">//    GA</font> <br> <font color="#0000ff">while</font> ( $ga-&gt;requestReportData(ga_profile_id, array( <font color="#A31515">'pagePath'</font> ), array( <font color="#A31515">'pageviews'</font> , <font color="#A31515">'uniquePageviews'</font> ), array( <font color="#A31515">'-Pageviews'</font> ), $filter, $start_date, $end_date, $start_index, $max_results) ) { <br> <br> $request = $ga-&gt;getResults(); <br> <font color="#0000ff">foreach</font> ( $request <font color="#0000ff">as</font> $page ) { <br> <font color="#0000ff">if</font> ( preg_match( <font color="#A31515">"/^\/(\d+)\.html$/is"</font> , $page, $matches ) ) { <font color="#008000">//        URL</font> <br> <br> $art_id = $matches[1]; <font color="#008000">//    ,  ID  URL    ID  </font> <br> <br> <font color="#008000">//   </font> <br> mysql_query( <font color="#A31515">"UPDATE art_stat <br> SET "</font> . $field . <font color="#A31515">" = "</font> . $page-&gt;getuniquePageviews() . <font color="#A31515">" <br> WHERE art_id = "</font> . $art_id <br> ); <br> <br> <font color="#0000ff">if</font> ( mysql_affected_rows() == 0 ) { <br> mysql_query( <font color="#A31515">"INSERT INTO art_stat ( art_id, "</font> . $field . <font color="#A31515">" ) <br> VALUES ( "</font> . $art_id . <font color="#A31515">", "</font> . $page-&gt;getuniquePageviews() . <font color="#A31515">" )"</font> <br> ); <br> } <font color="#008000">// End if</font> <br> <br> } <font color="#008000">// End if</font> <br> <br> } <font color="#008000">// End foreach</font> <br> <br> $start_index += $max_results; <br> <br> } <font color="#008000">// End while</font> <br> <br> } <font color="#008000">// End function set_stat</font> <br> <br> require_once <font color="#A31515">'end.php'</font> ; <font color="#008000">//     </font> <br> <br> ?&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We hang the script on crowns, having previously prepared it, and we obtain regularly updated statistics on the materials on our website. <br><br>  Finally, I will give an example of a request to get the most popular for the week. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> a.id, a.name, s.week_stat <font color="#0000ff">AS</font> cnt <br> <font color="#0000ff">FROM</font> art a <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> art_stat s <font color="#0000ff">ON</font> ( s.art_id = a.id ) <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> cnt DESC</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Also in this way, you can try to assess the decrease / increase in user interest in specific materials of the site and other related parameters. <br><br>  <b>PS</b> This is the first post, so please do not judge strictly </div><p>Source: <a href="https://habr.com/ru/post/69651/">https://habr.com/ru/post/69651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69642/index.html">Solve the problem using one bit of memory 2: we take into account the interference</a></li>
<li><a href="../69643/index.html">category tree in its own way (webasyst shop-script)</a></li>
<li><a href="../69644/index.html">Debugging .Net Framework Source Code in MS VS 2008 and More</a></li>
<li><a href="../69647/index.html">Explay CMS 3.1</a></li>
<li><a href="../69650/index.html">Interesting task: we increase the stability (robustness) of applications (part 2)</a></li>
<li><a href="../69652/index.html">Google launched site statistics</a></li>
<li><a href="../69653/index.html">Windows 7 and USB modem HUAWEI E1550</a></li>
<li><a href="../69654/index.html">Coffee'n'Code in Kharkov: First meeting</a></li>
<li><a href="../69655/index.html">Glow in the night sky. Riddle explained</a></li>
<li><a href="../69657/index.html">Wearing a netbook in your pocket (like a phone): troublesome wonder or useful everyday life?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>