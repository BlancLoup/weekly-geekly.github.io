<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of one DDOS attack on the router and Juniper routing engine protection methods</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, I often have to deal with DDOS on the server, but some time ago I encountered another attack, for which I was not ready. The attack was made ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of one DDOS attack on the router and Juniper routing engine protection methods</h1><div class="post__text post__text-html js-mediator-article">  On duty, I often have to deal with DDOS on the server, but some time ago I encountered another attack, for which I was not ready.  The attack was made on the Juniper MX80 router supporting BGP sessions and performing the announcement of the data center subnets.  The purpose of the attackers was a web resource located on one of our servers, but as a result of the attack, the entire data center remained without communication with the outside world.  Details of the attack, as well as tests and methods of dealing with such attacks under the cut. <a name="habracut"></a><br><br><h4>  Attack history </h4><br>  Historically, the router blocked all UDP traffic flying into our network.  The first wave of the attack (at 17:22) was just UDP traffic, the schedule for unicast packets from the uplink router: <br><img src="https://habrastorage.org/getpro/habr/post_images/2fe/b17/5cd/2feb175cd4c39fa5f06ea0f7ef9f8604.jpg" alt="image"><br>  and a graph of unicast packets from the port of the switch connected to the router: <br><img src="https://habrastorage.org/getpro/habr/post_images/864/0fb/1ac/8640fb1acd76f979a2c12e5c071af7b6.jpg" alt="image"><br>  demonstrate that all traffic is donkey on the filter of the router.  The flow of unicast packets on the uplink of the router increased by 400 thousand and the attack on UDP packets continued until 17:33.  Then the attackers changed the strategy and added UDP attack to the attack with TCP SYN packets on the attacked server as well as on the router itself.  As you can see from the graph, the router became so bad that it stopped sending SNMP to zabbix.  After the SYN wave, BGP sessions with peers began to fall off the ports of the router (we use three uplinks from each of which we get full view on ipv4 and on ipv6), tragic entries appeared in the logs: <br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">Jun</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> ROUTER rpd[<span class="hljs-number"><span class="hljs-number">1408</span></span>]: bgp_hold_timeout:<span class="hljs-number"><span class="hljs-number">4035</span></span>: NOTIFICATION sent to ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>): code <span class="hljs-number"><span class="hljs-number">4</span></span> (Hold Timer Expired Error), Reason: holdtime expired for ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>), socket buffer sndcc: <span class="hljs-number"><span class="hljs-number">19</span></span> rcvcc: <span class="hljs-number"><span class="hljs-number">0</span></span> TCP state: <span class="hljs-number"><span class="hljs-number">4</span></span>, snd_una: <span class="hljs-number"><span class="hljs-number">1200215741</span></span> snd_nxt: <span class="hljs-number"><span class="hljs-number">1200215760</span></span> snd_wnd: <span class="hljs-number"><span class="hljs-number">15358</span></span> rcv_nxt: <span class="hljs-number"><span class="hljs-number">4074908977</span></span> rcv_adv: <span class="hljs-number"><span class="hljs-number">4074925361</span></span>, hold timer out <span class="hljs-number"><span class="hljs-number">90s</span></span>, hold timer remain <span class="hljs-number"><span class="hljs-number">0s</span></span> Jun <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span> ROUTER rpd[<span class="hljs-number"><span class="hljs-number">1408</span></span>]: bgp_hold_timeout:<span class="hljs-number"><span class="hljs-number">4035</span></span>: NOTIFICATION sent to ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>): code <span class="hljs-number"><span class="hljs-number">4</span></span> (Hold Timer Expired Error), Reason: holdtime expired for ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>), socket buffer sndcc: <span class="hljs-number"><span class="hljs-number">38</span></span> rcvcc: <span class="hljs-number"><span class="hljs-number">0</span></span> TCP state: <span class="hljs-number"><span class="hljs-number">4</span></span>, snd_una: <span class="hljs-number"><span class="hljs-number">244521089</span></span> snd_nxt: <span class="hljs-number"><span class="hljs-number">244521108</span></span> snd_wnd: <span class="hljs-number"><span class="hljs-number">16251</span></span> rcv_nxt: <span class="hljs-number"><span class="hljs-number">3829118827</span></span> rcv_adv: <span class="hljs-number"><span class="hljs-number">3829135211</span></span>, hold timer out <span class="hljs-number"><span class="hljs-number">90s</span></span>, hold timer remain <span class="hljs-number"><span class="hljs-number">0s</span></span> Jun <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> ROUTER rpd[<span class="hljs-number"><span class="hljs-number">1408</span></span>]: bgp_hold_timeout:<span class="hljs-number"><span class="hljs-number">4035</span></span>: NOTIFICATION sent to ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>): code <span class="hljs-number"><span class="hljs-number">4</span></span> (Hold Timer Expired Error), Reason: holdtime expired for ip.ip.ip.ip (External AS <span class="hljs-number"><span class="hljs-number">1111</span></span>), socket buffer sndcc: <span class="hljs-number"><span class="hljs-number">19</span></span> rcvcc: <span class="hljs-number"><span class="hljs-number">0</span></span> TCP state: <span class="hljs-number"><span class="hljs-number">4</span></span>, snd_una: <span class="hljs-number"><span class="hljs-number">1840501056</span></span> snd_nxt: <span class="hljs-number"><span class="hljs-number">1840501075</span></span> snd_wnd: <span class="hljs-number"><span class="hljs-number">16384</span></span> rcv_nxt: <span class="hljs-number"><span class="hljs-number">1457490093</span></span> rcv_adv: <span class="hljs-number"><span class="hljs-number">1457506477</span></span>, hold timer out <span class="hljs-number"><span class="hljs-number">90s</span></span>, hold timer remain <span class="hljs-number"><span class="hljs-number">0s</span></span></code> </pre> <br>  As it was found out later, after the attack, the TCP SYN wave increased the load on the routing engine of the router and then all BGP sessions fell and the router could not restore its work on its own.  The attack on the router lasted several minutes, but due to the additional load, the router could not process the full view from three uplinks and the sessions were torn again.  It was only possible to restore the work by alternately raising all BGP sessions.  A further attack went on the server itself. <br><br><h4>  Test stand and replay attack </h4><br>  As the target of the attack, the Juniper MX80 was used with the same firmware version as on the combat router.  A server with a 10Gb card and an ubuntu server + quagga installed on it was used as an attacker.  The traffic generator was a script calling the hping3 utility.  To check the harmful effects of traffic spikes, the script generated traffic with temporary gaps: 30 seconds attack - 2 seconds no attack.  Also, for the purity of the experiment, the BGP session between the router and the server was raised.  In the configuration of the combat router installed at that time, the BGP and SSH ports were open on all interfaces / addresses of the router and were not filtered.  A similar configuration was transferred to the bench router. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first stage of testing was the attack of TCP SYN on BGP (179) port of the router.  Ip address of the source coincided with the address of the peer in the config.  IP address spoofing was not excluded, since our uplinks did not include uPRF.  Session has been set.  From quagga side: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">BGP</span></span> router identifier <span class="hljs-number"><span class="hljs-number">9.4.8.2</span></span>, local AS number <span class="hljs-number"><span class="hljs-number">9123</span></span> RIB entries <span class="hljs-number"><span class="hljs-number">3</span></span>, using <span class="hljs-number"><span class="hljs-number">288</span></span> bytes of memory Peers <span class="hljs-number"><span class="hljs-number">1</span></span>, using <span class="hljs-number"><span class="hljs-number">4560</span></span> bytes of memory Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd <span class="hljs-number"><span class="hljs-number">9.4.8.1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1234</span></span> <span class="hljs-number"><span class="hljs-number">1633</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Total number of neighbors <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Juniper side: <br><pre> <code class="nginx hljs">user@MX80&gt; <span class="hljs-attribute"><span class="hljs-attribute">show</span></span> bgp summary Groups: <span class="hljs-number"><span class="hljs-number">1</span></span> Peers: <span class="hljs-number"><span class="hljs-number">1</span></span> Down peers: <span class="hljs-number"><span class="hljs-number">0</span></span> Table Tot Paths Act Paths Suppressed History Damp State Pending inet.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Peer AS InPkt OutPkt OutQ Flaps Last Up/Dwn State|<span class="hljs-comment"><span class="hljs-comment">#Active/Received/Accepted/Damped... 9.4.8.2 4567 155 201 0 111 59:14 1/2/2/0 0/0/0/0</span></span></code> </pre><br>  After the start of the attack (13:52) ~ 1.2 Mpps of traffic flies to the router: <br><img src="https://habrastorage.org/getpro/habr/post_images/f1b/bb1/85e/f1bbb185e4f529c5a1e4b4f1fc601c95.jpg" alt="image"><br>  or 380Mbps: <br><img src="https://habrastorage.org/getpro/habr/post_images/69d/dc6/e87/69ddc6e87af0a44cc44569069d60a6c3.jpg" alt="image"><br>  The load on the CPU RE and CPU FE of the router increases: <br><img src="https://habrastorage.org/getpro/habr/post_images/cfd/3bf/bc7/cfd3bfbc7e7f978eaa7575e65df81a6d.jpg" alt="image"><br>  After a timeout (90 sec), the BGP session drops and does not rise again: <br><blockquote>  Jul 4 13:54:01 MX80 rpd [1407]: bgp_hold_timeout: 4035: NOTIFICATION sent to 9.4.8.2 (External AS 4567): code 4 (Hold Timer Expired Error), Reason: holdtime expired for 9.4.8.2 (External AS 4567 ), socket buffer sndcc: 38 rcvcc: 0 TCP state: 4, snd_una: 3523671294 snd_nxt: 3523671313 snd_wnd: 114 rcv_nxt: 1556791630 rcv_adv: 1556808014, hold delay out 90s, hold timer 0 0 </blockquote><br>  The router is busy processing incoming TCP SYN on the BGP port and cannot establish a session.  There are many packages on the port: <br><blockquote>  user @ MX80&gt; <b>monitor traffic interface ge-1/0/0 count 20</b> <br>  13: 55: 39.219155 In IP 9.4.8.2.2097&gt; 9.4.8.1.bgp: S 1443462200: 1443462200 (0) win 512 <br>  13: 55: 39.219169 In IP 9.4.8.2.27095&gt; 9.4.8.1.bgp: S 295677290: 295677290 (0) win 512 <br>  13: 55: 39.219177 In IP 9.4.8.2.30114&gt; 9.4.8.1.bgp: S 380995480: 380995480 (0) win 512 <br>  13: 55: 39.219184 In IP 9.4.8.2.57280&gt; 9.4.8.1.bgp: S 814209218: 814209218 (0) win 512 <br>  13: 55: 39.219192 In IP 9.4.8.2.2731&gt; 9.4.8.1.bgp: S 131350916: 131350916 (0) win 512 <br>  13: 55: 39.219199 In IP 9.4.8.2.2261&gt; 9.4.8.1.bgp: S 2145330024: 2145330024 (0) win 512 <br>  13: 55: 39.219206 In IP 9.4.8.2.z39.50&gt; 9.4.8.1.bgp: S 1238175350: 1238175350 (0) win 512 <br>  13: 55: 39.219213 In IP 9.4.8.2.2098&gt; 9.4.8.1.bgp: S 1378645261: 1378645261 (0) win 512 <br>  13: 55: 39.219220 In IP 9.4.8.2.30115&gt; 9.4.8.1.bgp: S 1925718835: 1925718835 (0) win 512 <br>  13: 55: 39.219227 In IP 9.4.8.2.27096&gt; 9.4.8.1.bgp: S 286229321: 286229321 (0) win 512 <br>  13: 55: 39.219235 In IP 9.4.8.2.2732&gt; 9.4.8.1.bgp: S 1469740166: 1469740166 (0) win 512 <br>  13: 55: 39.219242 In IP 9.4.8.2.57281&gt; 9.4.8.1.bgp: S 1179645542: 1179645542 (0) win 512 <br>  13: 55: 39.219254 In IP 9.4.8.2.2262&gt; 9.4.8.1.bgp: S 1507663512: 1507663512 (0) win 512 <br>  13: 55: 39.219262 In IP 9.4.8.2.914c / g&gt; 9.4.8.1.bgp: S 1219404184: 1219404184 (0) win 512 <br>  13: 55: 39.219269 In IP 9.4.8.2.2099&gt; 9.4.8.1.bgp: S 577616492: 577616492 (0) win 512 <br>  13: 55: 39.219276 In IP 9.4.8.2.267&gt; 9.4.8.1.bgp: S 1257310851: 1257310851 (0) win 512 <br>  13: 55: 39.219283 In IP 9.4.8.2.27153&gt; 9.4.8.1.bgp: S 1965427542: 1965427542 (0) win 512 <br>  13: 55: 39.219291 In IP 9.4.8.2.30172&gt; 9.4.8.1.bgp: S 1446880235: 1446880235 (0) win 512 <br>  13: 55: 39.219297 In IP 9.4.8.2.57338&gt; 9.4.8.1.bgp: S 206377149: 206377149 (0) win 512 <br>  13: 55: 39.219305 In IP 9.4.8.2.2789&gt; 9.4.8.1.bgp: S 838483872: 838483872 (0) win 512 </blockquote><br>  The second stage of testing was the attack of TCP SYN on BGP (179) port of the router.  The source Ip address was chosen randomly and did not match the address of the peer specified in the router config.  This attack had the same effect on the router.  In order not to stretch the article with monotonous conclusions of the logs, I will give only the load graph <br><img src="https://habrastorage.org/getpro/habr/post_images/723/f67/d7e/723f67d7e0b95a3eba8902699f5d6f1a.jpg" alt="image"><br>  The graph clearly shows the start of the attack.  The BGP session also fell and was unable to recover. <br><br><h4>  The concept of building protection RE router </h4><br>  The feature of Juniper equipment is the separation of tasks between the routing engine (RE) and the packet forwarding engine (PFE).  PFE processes the entire flow of passing traffic by filtering and routing it according to a pre-established pattern.  RE handles the processing of direct calls to the router (traceroute, ping, ssh), packet processing for service services (BGP, NTP, DNS, SNMP) and generates traffic filtering and routing schemes for the PFE router. <br><br>  The basic idea of ‚Äã‚Äãprotecting a router is to filter all traffic destined for an RE.  Creating a filter will allow transferring the load created by the DDOS attack from the CPU RE to the CPU PFE of the router, which will enable the RE to process only real packets and not waste processor time on other traffic.  To build protection, you must determine what we are filtering.  The scheme for writing filters for IPv4 was taken from the book <a href="http://www.juniper.net/us/en/community/junos/training-certification/day-one/fundamentals-series/securing-routing-engine/">Douglas Hanks Jr.</a>  <a href="http://www.juniper.net/us/en/community/junos/training-certification/day-one/fundamentals-series/securing-routing-engine/">- Day One Book: Securing the Routing Engine on M, MX and T series</a> .  In my case, the following scheme was on the router: <br><br>  By IPv4 protocol <br><ul><li>  BGP - we filter packets by source and destination ip, source ip can be any of the bgp neighbor list.  We only allow tcp established connections, that is, the fltr will discard all SYNs arriving at this port, and the BGP session will start only from us (BGP neighbor uplink works in passive mode). </li><li>  TACACS + - filter packets by source and destination ip, source ip can only be from the internal network.  We limit the bandwidth to 1Mb / s. </li><li>  SNMP - filter packets by source and destination ip, source ip can be any of the list of snmp-clients in the config. </li><li>  SSH - we filter packets by destination ip, source ip can be any, as there is a need for emergency access to the device from any network.  We limit the bandwidth to 5Mb / s. </li><li>  NTP - we filter packets by source and destination ip, source ip can be any of the ntp servers config list.  We limit the bandwidth to 1Mb / s (the threshold was later reduced to 512Kb / s). </li><li>  DNS - filter packets by source and destination ip, source ip can be any of the dns servers config list.  We limit the bandwidth to 1Mb / s. </li><li>  ICMP - filter packets, skip only to addresses belonging to the router.  We limit the bandwidth to 5Mb / s (the threshold was later reduced to 1Mb / s). </li><li>  TRACEROUTE - we filter packets, we only pass packets with TTL equal to 1 and only to addresses belonging to the router.  We limit the bandwidth to 1Mb / s. </li></ul><br>  Under the IPv6 protocol, in my case, the filters were superimposed only on BGP, NTP, ICMP, DNS and traceroute.  The only difference is in ICMP traffic filtering, since IPv6 uses ICMP for business purposes.  The remaining protocols did not use IPv6 addressing. <br><br><h4>  Writing configuration </h4><br>  For writing filters in juniper there is a handy tool - prefix-list, which allows you to dynamically compile lists of ip addresses / subnets for substitution in filters.  For example, to create a list of ipv4 BGP neighbors specified in the config, the following structure is used: <br><pre> <code class="javascript hljs">prefix-list BGP-neighbors-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"protocols bgp group &lt;*&gt; neighbor &lt;*.*&gt;"</span></span>; }</code> </pre> <br>  List result: <br><blockquote>  <b>show configuration policy-options prefix-list BGP-neighbors-v4 |</b>  <b>display inheritance</b> <br>  ## <br>  ## apply-path was expanded to: <br>  ## 1.1.1.1/32; <br>  ## 2.2.2.2/32; <br>  ## 3.3.3.3/32; <br>  ## <br>  apply-path "protocols bgp group &lt;*&gt; neighbor &lt;*. *&gt;"; </blockquote><br>  We compile dynamic lists of prefixes for all filters: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   ipv4   BGP */</span></span> prefix-list BGP-neighbors-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"protocols bgp group &lt;*&gt; neighbor &lt;*.*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv6   BGP */</span></span> prefix-list BGP-neighbors-v6 { apply-path <span class="hljs-string"><span class="hljs-string">"protocols bgp group &lt;*&gt; neighbor &lt;*:*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv4  NTP */</span></span> prefix-list NTP-servers-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"system ntp server &lt;*.*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv6  NTP */</span></span> prefix-list NTP-servers-v6 { apply-path <span class="hljs-string"><span class="hljs-string">"system ntp server &lt;*:*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv4    */</span></span> prefix-list LOCALS-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"interfaces &lt;*&gt; unit &lt;*&gt; family inet address &lt;*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv6    */</span></span> prefix-list LOCALS-v6 { apply-path <span class="hljs-string"><span class="hljs-string">"interfaces &lt;*&gt; unit &lt;*&gt; family inet6 address &lt;*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv4  SNMP  */</span></span> prefix-list SNMP-clients { apply-path <span class="hljs-string"><span class="hljs-string">"snmp client-list &lt;*&gt; &lt;*&gt;"</span></span>; } prefix-list SNMP-community-clients { apply-path <span class="hljs-string"><span class="hljs-string">"snmp community &lt;*&gt; clients &lt;*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*    TACACS+ */</span></span> prefix-list TACPLUS-servers { apply-path <span class="hljs-string"><span class="hljs-string">"system tacplus-server &lt;*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> prefix-list INTERNAL-locals { <span class="hljs-comment"><span class="hljs-comment">/*      -    */</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*      ,    SSH */</span></span> prefix-list MGMT-locals { apply-path <span class="hljs-string"><span class="hljs-string">"interfaces fxp0 unit 0 family inet address &lt;*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> prefix-list rfc1918 { <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Loopback */</span></span> prefix-list localhost-v6 { ::<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">128</span></span>; } prefix-list localhost-v4 { <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv4   BGP */</span></span> prefix-list BGP-locals-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"protocols bgp group &lt;*&gt; neighbor &lt;*.*&gt; local-address &lt;*.*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv6   BGP */</span></span> prefix-list BGP-locals-v6 { apply-path <span class="hljs-string"><span class="hljs-string">"protocols bgp group &lt;*&gt; neighbor &lt;*:*&gt; local-address &lt;*:*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv4  DNS */</span></span> prefix-list DNS-servers-v4 { apply-path <span class="hljs-string"><span class="hljs-string">"system name-server &lt;*.*&gt;"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   ipv6  DNS */</span></span> prefix-list DNS-servers-v6 { apply-path <span class="hljs-string"><span class="hljs-string">"system name-server &lt;*:*&gt;"</span></span>; }</code> </pre><br>  We make polisry to limit bandwidth: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   1Mb */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m { apply-flags omit; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding { bandwidth-limit <span class="hljs-number"><span class="hljs-number">1</span></span>m; burst-size-limit <span class="hljs-number"><span class="hljs-number">625</span></span>k; } <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> then discard; } <span class="hljs-comment"><span class="hljs-comment">/*   5Mb */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-5</span></span>m { apply-flags omit; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding { bandwidth-limit <span class="hljs-number"><span class="hljs-number">5</span></span>m; burst-size-limit <span class="hljs-number"><span class="hljs-number">625</span></span>k; } <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> then discard; } <span class="hljs-comment"><span class="hljs-comment">/*   512Kb */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-512</span></span>k { apply-flags omit; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding { bandwidth-limit <span class="hljs-number"><span class="hljs-number">512</span></span>k; burst-size-limit <span class="hljs-number"><span class="hljs-number">25</span></span>k; } <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> then discard; }</code> </pre><br>  Below, under ‚Äúcopy and paste‚Äù, the configuration of the filters of the final protection variant (the thresholds for the throughput of NTP and ICMP traffic were reduced, the reasons for lowering the thresholds are described in detail in the testing section).  Configure ipv4 filters: <br><div class="spoiler">  <b class="spoiler_title">IPv4 filter</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*  BGP  */</span></span> filter accept-bgp { interface-specific; term accept-bgp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { BGP-neighbors-v4; } destination-prefix-list { BGP-locals-v4; } <span class="hljs-comment"><span class="hljs-comment">/*    .     . */</span></span> tcp-established; protocol tcp; port bgp; } then { count accept-bgp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  SSH  */</span></span> filter accept-ssh { apply-flags omit; term accept-ssh { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { MGMT-locals; } protocol tcp; destination-port ssh; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-5</span></span>m; count accept-ssh; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  SNMP  */</span></span> filter accept-snmp { apply-flags omit; term accept-snmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { SNMP-clients; SNMP-community-clients; } destination-prefix-list { <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> INTERNAL-locals; } protocol udp; destination-port [ snmp snmptrap ]; } then { count accept-snmp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  ICMP  */</span></span> filter accept-icmp { apply-flags omit; <span class="hljs-comment"><span class="hljs-comment">/*    ICMP */</span></span> term discard-icmp-fragments { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { is-fragment; protocol icmp; } then { count discard-icmp-fragments; discard; } } term accept-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol icmp; icmp-type [ echo-reply echo-request time-exceeded unreachable source-quench router-advertisement parameter-problem ]; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-icmp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  traceroute  */</span></span> filter accept-traceroute { apply-flags omit; term accept-traceroute-udp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v4; } protocol udp; <span class="hljs-comment"><span class="hljs-comment">/*   TTL = 1 */</span></span> ttl <span class="hljs-number"><span class="hljs-number">1</span></span>; destination-port <span class="hljs-number"><span class="hljs-number">33434</span></span><span class="hljs-number"><span class="hljs-number">-33450</span></span>; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-traceroute-udp; accept; } } term accept-traceroute-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v4; } protocol icmp; <span class="hljs-comment"><span class="hljs-comment">/*   TTL = 1 */</span></span> ttl <span class="hljs-number"><span class="hljs-number">1</span></span>; icmp-type [ echo-request timestamp time-exceeded ]; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-traceroute-icmp; accept; } } term accept-traceroute-tcp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v4; } protocol tcp; <span class="hljs-comment"><span class="hljs-comment">/*   TTL = 1 */</span></span> ttl <span class="hljs-number"><span class="hljs-number">1</span></span>; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-traceroute-tcp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  DNS  */</span></span> filter accept-dns { apply-flags omit; term accept-dns { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { DNS-servers-v4; } destination-prefix-list { LOCALS-v4; } protocol udp; source-port <span class="hljs-number"><span class="hljs-number">53</span></span>; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-dns; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> filter discard-all { apply-flags omit; term discard-ip-options { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { ip-options any; } then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-ip-options; log; discard; } } term discard-TTL_1-unknown { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { ttl <span class="hljs-number"><span class="hljs-number">1</span></span>; } then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-TTL_1-unknown; log; discard; } } term discard-tcp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol tcp; } then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-tcp; log; discard; } } term discard-udp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol udp; } then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-udp; log; discard; } } term discard-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v4; } protocol icmp; } then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-icmp; log; discard; } } term discard-unknown { then { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> count discard-unknown; log; discard; } } } <span class="hljs-comment"><span class="hljs-comment">/*  TACACS+  */</span></span> filter accept-tacacs { apply-flags omit; term accept-tacacs { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { TACPLUS-servers; } destination-prefix-list { INTERNAL-locals; } protocol [ tcp udp ]; source-port [ tacacs tacacs-ds ]; tcp-established; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-tacacs; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  NTP  */</span></span> filter accept-ntp { apply-flags omit; term accept-ntp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { NTP-servers-v4; localhost-v4; } destination-prefix-list { localhost-v4; LOCALS-v4; } protocol udp; destination-port ntp; } then { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> policer management<span class="hljs-number"><span class="hljs-number">-512</span></span>k; count accept-ntp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*            */</span></span> filter accept-common-services { term protect-TRACEROUTE { filter accept-traceroute; } term protect-ICMP { filter accept-icmp; } term protect-SSH { filter accept-ssh; } term protect-SNMP { filter accept-snmp; } term protect-NTP { filter accept-ntp; } term protect-DNS { filter accept-dns; } term protect-TACACS { filter accept-tacacs; } }</code> </pre></div></div><br>  Similar filter for ipv6: <br><div class="spoiler">  <b class="spoiler_title">IPv6 filter</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*  BGP  */</span></span> filter accept-v6-bgp { interface-specific; term accept-v6-bgp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { BGP-neighbors-v6; } destination-prefix-list { BGP-locals-v6; } tcp-established; next-header tcp; port bgp; } then { count accept-v6-bgp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  ICMP  */</span></span> filter accept-v6-icmp { apply-flags omit; term accept-v6-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { next-header icmp6; <span class="hljs-comment"><span class="hljs-comment">/*     ,   ipv6  icmp */</span></span> icmp-type [ echo-reply echo-request time-exceeded router-advertisement parameter-problem destination-unreachable packet-too-big router-solicit neighbor-solicit neighbor-advertisement redirect ]; } then { policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-v6-icmp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  traceroute  */</span></span> filter accept-v6-traceroute { apply-flags omit; term accept-v6-traceroute-udp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v6; } next-header udp; destination-port <span class="hljs-number"><span class="hljs-number">33434</span></span><span class="hljs-number"><span class="hljs-number">-33450</span></span>; hop-limit <span class="hljs-number"><span class="hljs-number">1</span></span>; } then { policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-v6-traceroute-udp; accept; } } term accept-v6-traceroute-tcp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v6; } next-header tcp; hop-limit <span class="hljs-number"><span class="hljs-number">1</span></span>; } then { policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-v6-traceroute-tcp; accept; } } term accept-v6-traceroute-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v6; } next-header icmp6; icmp-type [ echo-reply echo-request router-advertisement parameter-problem destination-unreachable packet-too-big router-solicit neighbor-solicit neighbor-advertisement redirect ]; hop-limit <span class="hljs-number"><span class="hljs-number">1</span></span>; } then { policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-v6-traceroute-icmp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  DNS  */</span></span> filter accept-v6-dns { apply-flags omit; term accept-v6-dns { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { DNS-servers-v6; } destination-prefix-list { LOCALS-v6; } next-header udp; source-port <span class="hljs-number"><span class="hljs-number">53</span></span>; } then { policer management<span class="hljs-number"><span class="hljs-number">-1</span></span>m; count accept-v6-dns; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*  NTP  */</span></span> filter accept-v6-ntp { apply-flags omit; term accept-v6-ntp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { source-prefix-list { NTP-servers-v6; localhost-v6; } destination-prefix-list { localhost-v6; LOCALS-v6; } next-header udp; destination-port ntp; } then { policer management<span class="hljs-number"><span class="hljs-number">-512</span></span>k; count accept-v6-ntp; accept; } } } <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> filter discard-v6-all { apply-flags omit; term discard-v6-tcp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { next-header tcp; } then { count discard-v6-tcp; log; discard; } } term discard-v6-udp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { next-header udp; } then { count discard-v6-udp; log; discard; } } term discard-v6-icmp { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { destination-prefix-list { LOCALS-v6; } next-header icmp6; } then { count discard-v6-icmp; log; discard; } } term discard-v6-unknown { then { count discard-v6-unknown; log; discard; } } } <span class="hljs-comment"><span class="hljs-comment">/*            */</span></span> filter accept-v6-common-services { term protect-TRACEROUTE { filter accept-v6-traceroute; } term protect-ICMP { filter accept-v6-icmp; } term protect-NTP { filter accept-v6-ntp; } term protect-DNS { filter accept-v6-dns; } }</code> </pre></div></div><br>  Next, you need to apply filters on the service interface lo0.0.  In JunOS, this interface is used to transfer data between the PFE and RE.  The configuration will be as follows: <br><pre> <code class="javascript hljs">lo0 { unit <span class="hljs-number"><span class="hljs-number">0</span></span> { family inet { filter { input-list [ accept-bgp accept-common-services discard-all ]; } } family inet6 { filter { input-list [ accept-v6-bgp accept-v6-common-services discard-v6-all ]; } } } }</code> </pre><br>  The order of specifying filters in the input-list interface is very important.  Each package will be checked for validity passing through the filters specified in the input-list from left to right. <br><br><h4>  Filter Testing </h4><br>  After applying the filters, conducted a series of tests on the same stand.  After each test, the firewall counters were cleared.  Normal (no attack) load on the router is visible on the charts at 11:06 - 11:08.  Pps chart for the entire test period: <br><img src="https://habrastorage.org/getpro/habr/post_images/dae/bdf/dd3/daebdfdd32ddf259c6cd0a8d9c3fe3b9.jpg" alt="image"><br>  CPU graph for the entire test period: <br><img src="https://habrastorage.org/getpro/habr/post_images/185/26a/54b/18526a54b298f2bc252a24e740d1b9fa.jpg" alt="image"><br><br>  The first test was carried out to test icmp with a traffic threshold of 5 Mb / s (on charts 10:21 - 10:24).  The filter counters and the graph show traffic bandwidth limitations, but even this stream was enough to increase the load, so the threshold was reduced to 1 Mb / s.  Counters: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">47225584</span></span> <span class="hljs-number"><span class="hljs-number">1686628</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">152</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">174681</span></span> <span class="hljs-number"><span class="hljs-number">2306</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">38952</span></span> <span class="hljs-number"><span class="hljs-number">702</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">841</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">780</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">18743</span></span> <span class="hljs-number"><span class="hljs-number">133</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">933705892</span></span> <span class="hljs-number"><span class="hljs-number">33346639</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Repeated icmp flood test with a 1Mb / s traffic threshold (on charts 10:24 - 10:27).  The load on the RE router dropped from 19% to 10%, the load on the PFE to 30%.  Counters: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">6461448</span></span> <span class="hljs-number"><span class="hljs-number">230766</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">113433</span></span> <span class="hljs-number"><span class="hljs-number">1497</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">33780</span></span> <span class="hljs-number"><span class="hljs-number">609</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">12394</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">665335496</span></span> <span class="hljs-number"><span class="hljs-number">23761982</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Next, a flood test was performed on the BGP port of the router from an outsider (not included in the config) ip address (on the charts 10:29 - 10:36).  As can be seen from the counters, the entire flood settled on the RE discard-tcp filter and only increased the load on the PFE.  The load on the RE has not changed.  Counters: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">824</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">560615</span></span> <span class="hljs-number"><span class="hljs-number">7401</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">33972</span></span> <span class="hljs-number"><span class="hljs-number">585</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1088</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">12250785600</span></span> <span class="hljs-number"><span class="hljs-number">306269640</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">63533</span></span> <span class="hljs-number"><span class="hljs-number">441</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  session does not fall: <br><pre> <code class="nginx hljs">user@MX80<span class="hljs-comment"><span class="hljs-comment"># run show bgp summary Groups: 1 Peers: 1 Down peers: 0 Table Tot Paths Act Paths Suppressed History Damp State Pending inet.0 2 1 0 0 0 0 Peer AS InPkt OutPkt OutQ Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped... 9.4.8.2 4567 21 22 0 76 8:49 1/2/2/0 0/0/0/0</span></span></code> </pre><br>  The fourth test was a flooding test (on charts 10:41 - 10:46) UDP per NTP port (in the filter settings, the interaction on this port is limited to the servers specified in the router config).  According to the schedule, the load rises only on the PFE router up to 28%.  Counters: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">329059</span></span> <span class="hljs-number"><span class="hljs-number">4344</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">22000</span></span> <span class="hljs-number"><span class="hljs-number">388</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">615</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1938171670</span></span> <span class="hljs-number"><span class="hljs-number">69219329</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Fifth, a flood test was conducted (on charts 10:41 - 11:04) UDP to the NTP port with IP spoofing.  The load on the RE increased by 12%, the load on the PFE increased to 22%.  From the counters it is clear that the flood rests on the 1Mb / s threshold, but this is enough to increase the load on the RE.  The traffic threshold was eventually reduced to 512Kb / s.  Counters: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">34796804</span></span> <span class="hljs-number"><span class="hljs-number">1242743</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">630617</span></span> <span class="hljs-number"><span class="hljs-number">8324</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">20568</span></span> <span class="hljs-number"><span class="hljs-number">366</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1159</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">53365</span></span> <span class="hljs-number"><span class="hljs-number">409</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">3717958468</span></span> <span class="hljs-number"><span class="hljs-number">132784231</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>    (   11:29 ‚Äî 11:34) UDP   NTP  IP spoofing,     512/.  : <br><img src="https://habrastorage.org/getpro/habr/post_images/5e1/e1f/378/5e1e1f3787daf94e01f8d41dd2d41f92.jpg" alt="image"><br> : <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">21066260</span></span> <span class="hljs-number"><span class="hljs-number">752363</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">744161</span></span> <span class="hljs-number"><span class="hljs-number">9823</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">19772</span></span> <span class="hljs-number"><span class="hljs-number">347</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1353</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">82745</span></span> <span class="hljs-number"><span class="hljs-number">602</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">512k</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">4197080384</span></span> <span class="hljs-number"><span class="hljs-number">149895728</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br><h4>  Conclusion </h4><br>       ,   DDOS ,    RE.              .     MX80: <br><pre> <code class="nginx hljs">Filter: lo0.0-<span class="hljs-attribute"><span class="hljs-attribute">i</span></span> Counters: Name Bytes Packets accept-v6-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">31091878</span></span> <span class="hljs-number"><span class="hljs-number">176809</span></span> accept-v6-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1831144</span></span> <span class="hljs-number"><span class="hljs-number">26705</span></span> accept-v6-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-v6-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> accept-v6-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">48488</span></span> <span class="hljs-number"><span class="hljs-number">684</span></span> accept-v6-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-v6-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-v6-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-v6-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-v6-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-v6-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-v6-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-v6-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-v6-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">512k</span></span>-accept-v6-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Filter: lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i Counters: Name Bytes Packets accept-bgp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">135948400</span></span> <span class="hljs-number"><span class="hljs-number">698272</span></span> accept-dns-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">374</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">121304849</span></span> <span class="hljs-number"><span class="hljs-number">1437305</span></span> accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">87780</span></span> <span class="hljs-number"><span class="hljs-number">1155</span></span> accept-snmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">1265470648</span></span> <span class="hljs-number"><span class="hljs-number">12094967</span></span> accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">2550011</span></span> <span class="hljs-number"><span class="hljs-number">30897</span></span> accept-tacacs-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">702450</span></span> <span class="hljs-number"><span class="hljs-number">11657</span></span> accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">28824</span></span> <span class="hljs-number"><span class="hljs-number">636</span></span> accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">75378</span></span> <span class="hljs-number"><span class="hljs-number">1361</span></span> accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">47328</span></span> <span class="hljs-number"><span class="hljs-number">1479</span></span> discard-TTL_1-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">27790</span></span> <span class="hljs-number"><span class="hljs-number">798</span></span> discard-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">26400</span></span> <span class="hljs-number"><span class="hljs-number">472</span></span> discard-icmp-fragments-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> discard-ip-options-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">35680</span></span> <span class="hljs-number"><span class="hljs-number">1115</span></span> discard-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">73399674</span></span> <span class="hljs-number"><span class="hljs-number">1572144</span></span> discard-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">126386306</span></span> <span class="hljs-number"><span class="hljs-number">694603</span></span> discard-unknown-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Policers: Name Bytes Packets management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-dns-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">38012</span></span> <span class="hljs-number"><span class="hljs-number">731</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-tacacs-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-icmp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-tcp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">1m</span></span>-accept-traceroute-udp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">512k</span></span>-accept-ntp-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> management-<span class="hljs-number"><span class="hljs-number">5m</span></span>-accept-ssh-lo0.<span class="hljs-number"><span class="hljs-number">0</span></span>-i <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>    ‚Äú‚Äù     discard. <br><br>        . </div><p>Source: <a href="https://habr.com/ru/post/186566/">https://habr.com/ru/post/186566/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186552/index.html">The digest of news from the world of mobile development for the last week ‚Ññ20 (July 8 - 14, 2013)</a></li>
<li><a href="../186554/index.html">I, the pirate (chapters 3-5)</a></li>
<li><a href="../186558/index.html">Astrid Task Manager closes. Comparison of alternatives</a></li>
<li><a href="../186560/index.html">Viewing images from the L15 format of the Electro-L satellite</a></li>
<li><a href="../186564/index.html">Index the sky</a></li>
<li><a href="../186568/index.html">Automatic notification of changes in the status of postal parcels via SMS</a></li>
<li><a href="../18657/index.html">PlentyOfFish makes $ 10 million per year</a></li>
<li><a href="../186570/index.html">Using ncurses in PHP</a></li>
<li><a href="../186572/index.html">A simple technique for building product filters using MongoDb and MapReduce</a></li>
<li><a href="../186574/index.html">About coffee and about the Web, or why PHP is a bicycle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>