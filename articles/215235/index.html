<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LUA in nginx: a slightly intelligent firewall</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a continuation of the use of lua in nginx . 

 Caching in memory was discussed there, and here lua will be used to filter incoming reques...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LUA in nginx: a slightly intelligent firewall</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/dec/a7d/146/deca7d146accb628876bb6d464bf66d1.png" align="right"><br>  This post is a <a href="http://habrahabr.ru/post/215237/">continuation of the use of lua in nginx</a> . <br><br>  Caching in memory was discussed there, and here lua will be used to filter incoming requests as a sort of firewall on an nginx balancer.  <a href="http://habrahabr.ru/company/2gis/blog/199504/">Something similar was at 2GIS</a> .  We have our own bike :) In which we share the dynamics and statics, we try to take into account NAT and the white list.  And, of course, you can always screw up specific logic, which will not work when using ready-made modules. <br>  This scheme is now calm and relaxed (almost no effect on the use of cpu) processes about 1200 requests / sec.  Limit values ‚Äã‚Äãwere not tested.  Perhaps fortunately :) <br><a name="habracut"></a><br><br>  I want to process all incoming requests immediately upon admission, and not on the fact of a line in access_log (which I suppose is turned off for the same statics).  Not a question, hang the handler globally for the entire http: <br><pre><code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> lua/req.conf; } <span class="hljs-comment"><span class="hljs-comment">#  lua/req.conf #      ( ,      LRU ) lua_shared_dict req_limit 1024m; #      (   ,    ) lua_shared_dict ban_list 128m; #  .   ,     geo $lua_req_whitelist { default 0; 12.34.56.78/24 1; } #  init_by_lua ' --      lua_req_priv_key = "secretpassphrase" --    lua_req_cookie_name = "reqcookiename" --      lua_req_ban_log = "/path/to/log/file" --     ( ) --     lua_req_d_one = 42 --    URI lua_req_d_mul = 84 --    URI lua_req_s_one = 100 --    URI lua_req_s_mul = 200 --    URI lua_req_d_ip = 200 --    IP lua_req_s_ip = 400 --    IP --   10  lua_req_ban_ttl = 600 --  math.randomseed(math.floor(ngx.now()*1000)) '; #   ,   access    access_by_lua_file /path/to/nginx/lua/req.lua;</span></span></code> </pre> <br>  Now all requests coming to nginx will go through our req.lua script. <br>  At the same time, we have two tables req_limit and ban_list for storing the query history and the list of those already banned, respectively (more details below). <br>  And for the implementation of whitelist over IP, the geo nginx module was used instead of bicycles, putting down the value of the variable lua_req_whitelist, which is used like this: <br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ngx.var.lua_req_whitelist ~= <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">-- IP    ,   end</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To check the statics / dynamics (request by file on disk / backend server) we do a simple check on the name of the requested file (here you can complicate the implementation, adjusting to your business logic): <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string.endswith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(haystack, needle)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (needle == <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (needle == <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>(haystack, -<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(needle))) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">path_is_static</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> exts = {<span class="hljs-string"><span class="hljs-string">'js'</span></span>, <span class="hljs-string"><span class="hljs-string">'css'</span></span>, <span class="hljs-string"><span class="hljs-string">'png'</span></span>, <span class="hljs-string"><span class="hljs-string">'jpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'jpeg'</span></span>, <span class="hljs-string"><span class="hljs-string">'gif'</span></span>, <span class="hljs-string"><span class="hljs-string">'xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'ico'</span></span>, <span class="hljs-string"><span class="hljs-string">'swf'</span></span>} <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">lower</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _,ext <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ipairs</span></span>(exts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>:endswith(ext) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> uri_path = ngx.var.request_uri <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ngx.var.is_args == <span class="hljs-string"><span class="hljs-string">'?'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> uri_path = uri_path:<span class="hljs-built_in"><span class="hljs-built_in">gsub</span></span>(<span class="hljs-string"><span class="hljs-string">'^([^?]+)\\?.*$'</span></span>, <span class="hljs-string"><span class="hljs-string">'%1'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> is_static = path_is_static(uri_path)</code> </pre><br><br>  For at least some NAT processing, in addition to IP clients, their UserAgent is also taken into account and a special cookie is affixed.  All three elements in general constitute the user ID.  If a villain hollows the server, ignoring the transmitted cookie, then in the worst case its IP / subnet will simply be banned.  At the same time, those users from this subnet who have already received a cookie before will work quietly further (except for the case of a ban by IP).  The solution is not perfect, but still better than counting half the country / mobile operator as a single user. <br>  Generation and verification of cookies: <br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen_cookie_rand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">2147483647</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen_cookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prefix, rnd)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ngx.encode_base64( <span class="hljs-comment"><span class="hljs-comment">--       IP    UserAgent,     ngx.sha1_bin(ngx.today() .. prefix .. lua_req_priv_key .. rnd) ) end local uri = ngx.var.request_uri --  URI local host = ngx.var.http_host --      (   nginx   ) local ip = ngx.var.remote_addr local user_agent = ngx.var.http_user_agent or '' if user_agent:len() &gt; 0 then user_agent = ngx.encode_base64(ngx.sha1_bin(user_agent)) end local key_prefix = ip .. ':' .. user_agent --    local user_cookie = ngx.unescape_uri(ngx.var['cookie_' .. lua_req_cookie_name]) or '' local rnd = gen_cookie_rand() local p = user_cookie:find('_') if p then rnd = user_cookie:sub(p+1) user_cookie = user_cookie:sub(1, p-1) end local control_cookie = gen_cookie(key_prefix, rnd) if user_cookie ~= control_cookie then user_cookie = '' rnd = gen_cookie_rand() control_cookie = gen_cookie(key_prefix, rnd) end key_prefix = key_prefix .. ':' .. user_cookie ngx.header['Set-Cookie'] = string.format('%s=%s; path=/; expires=%s', lua_req_cookie_name, ngx.escape_uri(control_cookie .. '_' .. rnd), ngx.cookie_time(ngx.time()+24*3600) )</span></span></code> </pre><br>  Now the key_prefix contains the identifier of the client whose request we are processing.  If this client is already banned, then no further processing is necessary: <br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ban_key = key_prefix..<span class="hljs-string"><span class="hljs-string">':ban'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ban_list:get(ban_key) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ban_list:get(ip..<span class="hljs-string"><span class="hljs-string">':ban'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">--          IP return ngx.exit(ngx.HTTP_FORBIDDEN) end</span></span></code> </pre><br>  They got the key, they checked the ban, now you can calculate if this query does not exceed which of the limits: <br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--   :   URI    URI local limits = { [false] = { [false] = lua_req_d_mul, --    URI [true] = lua_req_d_one, --    URI }, [true] = { [false] = lua_req_s_mul, --    URI [true] = lua_req_s_one, --    URI } } for _,one_path in ipairs({true, false}) do local limit = limits[is_static][one_path] local key = {key_prefix} --        if is_static then table.insert(key, 'S') else table.insert(key, 'D') end --          (  API   ) if one_path then table.insert(key, host..uri) end --    "12.34.56.78:useragentsha1base64:cookiesha1base64:S:site.com/path/to/file" key = table.concat(key, ':') local exhaust = check_limit_exhaust(key, limit, ban_ttl) if exhaust then return ngx.exit(ngx.HTTP_FORBIDDEN) end end</span></span></code> </pre><br>  We check 4 versions of the counters: static / dynamics, one way / according to different ones.  Direct checks are performed in check_limit_exhaust (): <br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_limit_exhaust</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key, limit, cnt_ttl)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> key_ts = key..<span class="hljs-string"><span class="hljs-string">':ts'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> cnt, _ = req_limit:incr(key, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--   ,     --        if cnt == nil then if req_limit:add(key, 1, cnt_ttl) then req_limit:set(key_ts, ngx.now(), cnt_ttl) end return false end --     (    ) if cnt &lt;= limit then return false end --     (  ), --              local key_lock = key..':lock' local key_lock_ttl = 0.5 local ts local try_until = ngx.now() + key_lock_ttl local locked while true do locked = req_limit:add(key_lock, 1, key_lock_ttl) cnt = req_limit:get(key) ts = req_limit:get(key_ts) if locked or (try_until &lt; ngx.now()) then break end ngx.sleep(0.01) end --            - , ,  . --      IP  blacklist --       if (not locked) and ((not cnt) or (not ts)) then return true, 'lock_failed' end --    ( )   local ts_diff = math.max(0.001, ngx.now() - ts) --      local cnt_norm = math.floor(cnt / ts_diff) --        if cnt_norm &lt;= limit then --  ts  cnt (    set'  -        ) req_limit:set(key, cnt_norm, cnt_ttl) req_limit:set(key_ts, ngx.now() - 1, cnt_ttl) --  ;  blacklist  ;    if locked then req_limit:delete(key_lock) end return false end --  . ,  ,    req_limit:delete(key) req_limit:delete(key_ts) if locked then req_limit:delete(key_lock) end return true, cnt_norm end</span></span></code> </pre><br>  In addition to the direct ban on lua_req_ban_ttl seconds, you can implement persistent storage, and at the same time screw logging and forwarding banned by IP in iptables / analogs.  This is already off the topic of the post. <br><br>  All this, of course, is only an example, not a copy-paste silver bullet.  Moreover, the given numbers of limits are indicated from the ceiling. <br><br>  <i>The image in the cap is taken <a href="http://kaspersky.proguide.vn/kinh-nghiem-thu-thuat/tu-bao-ve-khi-dung-wi-fi-cong-cong/">from here</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/215235/">https://habr.com/ru/post/215235/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215223/index.html">Stanford University developed a paper microscope worth less than a dollar</a></li>
<li><a href="../215225/index.html">Break me down completely (ZeroNightsCrackme, Part 2)</a></li>
<li><a href="../215227/index.html">Simple monitoring of server load in real time with a web interface</a></li>
<li><a href="../215229/index.html">‚ÄúStolen‚Äù money found on MtGox accounts</a></li>
<li><a href="../215233/index.html">DDOS of any site using Google Spreadsheet</a></li>
<li><a href="../215237/index.html">LUA in nginx: hot cache in memory</a></li>
<li><a href="../215239/index.html">IBOX - another ARM mini PC</a></li>
<li><a href="../215241/index.html">Miracle Machine: water wine</a></li>
<li><a href="../215243/index.html">VMware and KVM: OpenStack hypervisor race is gaining momentum</a></li>
<li><a href="../215245/index.html">InfoboxCloud cloud platform update: Jelastic 1.9.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>