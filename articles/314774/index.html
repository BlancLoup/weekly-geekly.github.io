<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The remote proxy class is not (very) painful</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(Dynamic dispatch to the rescue) 




 After several articles about MapReduce, we found it necessary to once again step aside and talk about the infra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The remote proxy class is not (very) painful</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="http://fineartamerica.com/featured/fish-out-of-watermelon-joan-pollak.html"><img src="https://habrastorage.org/files/64a/daf/a37/64adafa377a448dd935211953e4dc47c.jpg" align="left" width="176" height="300" alt="Fish Out Of Watermelon by Joan Pollak"></a> </p><h3>  (Dynamic dispatch to the rescue) </h3><p></p><br><p>  <em>After several articles about <strong>MapReduce,</strong> we found it necessary to once again step aside and talk about the infrastructure that will help facilitate the construction of the MapReduce solution.</em>  <em>We are still talking about <strong>InterSystems Cach√©</strong> , and, still, we are trying to build a <strong>MapReduce</strong> system based on the available materials in the system.</em> </p><br><p>  At a certain stage of writing the system, such as <strong>MapReduce</strong> , there is the task of conveniently calling remote methods and procedures (for example, sending control messages from the controller to the side of the controlled nodes).  In the Cach√© environment, there are several simple, but not very convenient methods to achieve this goal, whereas I would like to get <em>just a convenient one</em> . </p><br><a name="habracut"></a><br><p>  I want to take a simple and consistent code, here and there calling the methods of an object or class, and with a magic wave of the hand to make it work with methods already removed.  Of course, the degree of "remoteness" may be different, for example, we can simply call methods in another process of the same node, the essence will not change much - we need to get a convenient way to marshal the calls "to the other side" outside the current process, working in the <a href="">current area</a> . </p><br><p>  After several false starts, the author suddenly realized that in Cach√© ObjectScript there is a very simple mechanism that allows you to hide all the low-level details under a convenient, high-level shell - this is the <em>mechanism of dynamic dispatching of methods and properties</em> . </p><br><p> If you look back (far) back, you can see that since Cach√© 5.2 (and this is just a minute since 2007) there are several predefined methods in the base class <a href=""><code>%RegisteredObject</code></a> inherited by every object in the system that are called when trying to call an unknown during compilation method or property (at the moment these methods have moved to the <a href=""><code>%Library.SystemBase</code></a> interface, but this has not changed much). </p><br><table><thead><tr><th>  Name </th><th>  Value </th></tr></thead><tbody><tr><td> <code>Method %DispatchMethod (Method As %String, Args...)</code> </td> <td>  Calling an unknown method or accessing an unknown multidimensional property (their syntax is identical) </td></tr><tr><td> <code>ClassMethod %DispatchClassMethod (Class As %String, Method As %String, Args...)</code> </td> <td>  Calling an unknown class method for a given class </td></tr><tr><td> <code>Method %DispatchGetProperty (Property As %String)</code> </td> <td>  Reading unknown property </td></tr><tr><td> <code>Method %DispatchSetProperty (Property As %String, Val)</code> </td> <td>  Writing to an unknown property </td></tr><tr><td> <code>Method %DispatchSetMultidimProperty (Property As %String, Val, Subs...)</code> </td> <td>  Writing to an unknown multi-dimensional property ( <em>not used in this case, will be part of another story</em> ) </td></tr><tr><td> <code>Method %DispatchGetModified (Property As %String)</code> </td> <td>  Access to the "modified" flag for an unknown property ( <em>also not used in this story</em> ) </td></tr><tr><td> <code>Method %DispatchSetModified (Property As %String, Val)</code> </td> <td>  Addition to the method above - writing to the "modified" flag for an unknown property ( <em>not used in this story</em> ) </td></tr></tbody></table><br><p>  For the simplicity of the experiment, we will use only functions responsible for invoking unknown methods and scalar properties.  In the product environment, at a certain stage you may need to override all or most of the methods described, incl.  Be carefull. </p><br><h2 id="snachala-poprosche---protokoliruyuschiy-obekt-proksi">  At first easier - logging proxy object </h2><br><p>  Recall that from the time of the ‚ÄúKing of Peas‚Äù in the standard library CACHELIB there were standard methods and classes for working with the projection of JavaScript objects in XEN - <a href=""><code>%ZEN.proxyObject</code></a> , it allowed to manipulate dynamic properties even in the times when there was no work on the document base DocumentDB (do not ask) and moreover there was no native support for JSON objects in the Cach√© core environment. </p><br><p>  Let's try to create, for priming, a simple, <em>logging all calls, proxy object</em> ?  Where we wrap all calls through dynamic dispatching with preservation of the protocol about each event that occurred.  [Very similar to mocking in other language environments.] <br>  [[How does this translate into Russian?  "weeping"?]] </p><br><p>  As an example, take the strongly simplified class <code>Sample.SimplePerson</code> (by a strange coincidence, it is very similar to <code>Sample.Person</code> from the SAMPLES area in the standard package: wink:) </p><br><pre> <code class="hljs kotlin">DEVLATEST:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> p = ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(Sample.SimplePerson).%OpenId(<span class="hljs-number"><span class="hljs-number">2</span></span>) DEVLATEST:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:MAPREDUCE&gt;zw p p=&lt;OBJECT REFERENCE&gt;[<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-meta"><span class="hljs-meta">@Sample</span></span>.SimplePerson] +----------------- general information --------------- | oref value: <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sample.SimplePerson | %%OID: $lb</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"2"</span></span>,<span class="hljs-string"><span class="hljs-string">"Sample.SimplePerson"</span></span>) | reference count: <span class="hljs-number"><span class="hljs-number">2</span></span> +----------------- attribute values ------------------ | %Concurrency = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;Set&gt; | Age = <span class="hljs-number"><span class="hljs-number">9</span></span> | Contacts = <span class="hljs-number"><span class="hljs-number">23</span></span> | Name = <span class="hljs-string"><span class="hljs-string">"Waal,Nataliya Q."</span></span> +-----------------------------------------------------</code> </pre> <br><p>  Those.  we have a persistent class - with 3 simple properties: Age, Contacts and Name.  Wrap access to all properties of this class and call all its methods in its class <code>Sample.LoggingProxy</code> , and we will log every such call or access to a property ... somewhere. </p><br><pre> <code class="hljs smalltalk">///    : <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">LoggingProxy</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span> { ///      <span class="hljs-type"><span class="hljs-type">Parameter</span></span> <span class="hljs-type"><span class="hljs-type">LoggingGlobal</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-comment"><span class="hljs-comment">"^Sample.LoggingProxy"</span></span>; ///      <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span>; ///         <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">Log</span></span>(<span class="hljs-type"><span class="hljs-type">Value</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> gloRef = ..<span class="hljs-symbol"><span class="hljs-symbol">#LoggingGlobal</span></span> set @gloRef@(<span class="hljs-string"><span class="hljs-string">$s</span></span>equence(@gloRef)) = <span class="hljs-type"><span class="hljs-type">Value</span></span> } ///        <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">LogArgs</span></span>(prefix <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> as %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">$g</span></span>et(prefix) _ <span class="hljs-comment"><span class="hljs-comment">": "</span></span> _ <span class="hljs-string"><span class="hljs-string">$g</span></span>et(args(<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> i as %<span class="hljs-type"><span class="hljs-type">Integer</span></span> for i=<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$g</span></span>et(args) { set <span class="hljs-type"><span class="hljs-type">S</span></span> = <span class="hljs-type"><span class="hljs-type">S_</span></span><span class="hljs-comment"><span class="hljs-comment">","</span></span>_args(i) } do ..<span class="hljs-type"><span class="hljs-type">Log</span></span>(<span class="hljs-type"><span class="hljs-type">S</span></span>) } ///       %<span class="hljs-type"><span class="hljs-type">ID</span></span> <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> %<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(className <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, %<span class="hljs-type"><span class="hljs-type">ID</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">LoggingProxy</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> wrapper = ..%<span class="hljs-type"><span class="hljs-type">New</span></span>() set wrapper.<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> = <span class="hljs-string"><span class="hljs-string">$c</span></span>lassmethod(className, <span class="hljs-comment"><span class="hljs-comment">"%OpenId"</span></span>, %<span class="hljs-type"><span class="hljs-type">ID</span></span>) return wrapper } ///          <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchMethod</span></span>(methodName <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) { do ..<span class="hljs-type"><span class="hljs-type">LogArgs</span></span>(methodName, args...) return <span class="hljs-string"><span class="hljs-string">$m</span></span>ethod(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, methodName, args...) } ///          <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchGetProperty</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> <span class="hljs-type"><span class="hljs-type">Value</span></span> as %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">$p</span></span>roperty(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, <span class="hljs-type"><span class="hljs-type">Property</span></span>) do ..<span class="hljs-type"><span class="hljs-type">LogArgs</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span>) return <span class="hljs-type"><span class="hljs-type">Value</span></span> } ///          /// log arguments and then dispatch dynamically property access to the proxy object <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchSetProperty</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { do ..<span class="hljs-type"><span class="hljs-type">LogArgs</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span>) set <span class="hljs-string"><span class="hljs-string">$p</span></span>roperty(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, <span class="hljs-type"><span class="hljs-type">Property</span></span>) = <span class="hljs-type"><span class="hljs-type">Value</span></span> } }</code> </pre> <br><ol><li><p>  The <code>#LoggingGlobal</code> class <code>#LoggingGlobal</code> sets the name of the global where we will store the log (in this case, the global named <code>^Sample.LogginGlobal</code> ); </p><br></li><li><p>  There are two simple methods <code>Log(Arg)</code> and <code>LogArgs(prefix, args...)</code> that write the protocol to the global specified by the property above; </p><br></li><li><p>  <code>%DispatchMethod</code> , <code>%DispatchGetProperty</code> and <code>%DispatchSetProperty</code> process the corresponding scripts with calls to an unknown method or property call.  They log each access case via <code>LogArgs</code> , and then directly call the method or property of the object from the link <code>..%OpenedObject</code> ; </p><br></li><li>  Also, there is set the method of "class factory" <code>%CreateInstance</code> , which opens an instance of the specified class by its ID <code>%ID</code> .  The created object is "wrapped" in the <code>Sample.LogginProxy</code> object, the link to which is returned from this class method. </li></ol><br><img src="https://habrastorage.org/files/8c7/131/6bb/8c71316bb51547fc90ecd308eee28b21.png"><br><p>  No shamanism, nothing special, but in these 70 lines of Cach√© ObjectScript we tried to show a pattern of calling a method / property with a <em>side effect</em> (a more useful example of such a pattern will be shown below). </p><br><p>  Let's see how our ‚Äúlogging proxy object‚Äù behaves: </p><br><pre> <code class="hljs markdown">DEVLATEST:15:25:11:MAPREDUCE&gt;set w = ## class(Sample.LoggingProxy).%CreateInstance("Sample.SimplePerson", 2) DEVLATEST:15:25:32:MAPREDUCE&gt;zw w w=<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">OBJECT</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">REFERENCE</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>[<span class="hljs-string"><span class="hljs-string">1@Sample.LoggingProxy</span></span>] +----------------- general information --------------- | oref value: 1 | class name: Sample.LoggingProxy | reference count: 2 +----------------- attribute values ------------------ | (none) +----------------- swizzled references --------------- | i%OpenedObject = "" | r%OpenedObject = [<span class="hljs-string"><span class="hljs-string">2@Sample.SimplePerson</span></span>](<span class="hljs-link"><span class="hljs-link">mailto:2@MR.Sample.AgeAverage.Person</span></span>) +----------------------------------------------------- DEVLATEST:15:25:34:MAPREDUCE&gt;w w.Age 9 DEVLATEST:15:25:41:MAPREDUCE&gt;w w.Contacts 23 DEVLATEST:15:25:49:MAPREDUCE&gt;w w.Name Waal,Nataliya Q. DEVLATEST:15:26:16:MAPREDUCE&gt;zw ^Sample.LoggingProxy ^Sample.LoggingProxy=4 ^Sample.LoggingProxy(1)="Age: 9" ^Sample.LoggingProxy(2)="Contacts: 23" ^Sample.LoggingProxy(3)="Name: Waal,Nataliya Q."</code> </pre> <br><p>  We obtained the state of the instance of the <code>Sample.SimplePerson</code> class accessible through a proxy, and the logging results stored in the global when accessing the properties of the proxy object.  All as expected. </p><br><h2 id="proksi-udalennogo-obekta">  Remote object proxy </h2><br><p>  The attentive reader still has to remember why we are here - we need all these exercises to implement a simple proxy object that displays an object on a remote cluster node.  In fact, the class with the relevant functionality in Cach√© is <a href=""><code>%Net.RemoteConnection</code></a> .  What could be wrong with him? </p><br><p>  <em>Much</em> (and the fact that the class is officially marked as "deprecated" is not on the list of our complaints, we have questions of a different kind). </p><br><p>  As many know, the <a href=""><code>%Net.RemoteConnection</code></a> class uses c-binding to call remote Cach√© methods, which, in turn, are a wrapper over <a href="">cpp-binding</a> .  If you know the address of the system, the area with which you want to work, and know the username and password, then you have everything to remotely call a method in this area of ‚Äã‚Äãthis node.  The problem with this API from <code>%Net.RemoteConnection</code> is that it is very cumbersome and verbose: </p><br><pre> <code class="hljs mel">Class MR.Sample.TestRemoteConnection Extends %RegisteredObject { ClassMethod TestMethod(Arg As %String) As %String { <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $zu(<span class="hljs-number"><span class="hljs-number">5</span></span>)_<span class="hljs-string"><span class="hljs-string">"^"</span></span>_##class(%SYS.System).GetInstanceName()_<span class="hljs-string"><span class="hljs-string">"^"</span></span>_ $i(^MR.Sample.TestRemoteConnectionD) } ClassMethod TestLocal() { #dim connection As %Net.RemoteConnection = ##class(%Net.RemoteConnection).%New() #dim status As %Status = connection.Connect(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$zu(<span class="hljs-number"><span class="hljs-number">5</span></span>),^%SYS(<span class="hljs-string"><span class="hljs-string">"SSPort"</span></span>),<span class="hljs-string"><span class="hljs-string">"_SYSTEM"</span></span>,<span class="hljs-string"><span class="hljs-string">"SYS"</span></span>) set status = connection.ResetArguments() set status = connection.AddArgument(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/*by ref*/</span></span>, $$$cbindStringId) #dim rVal As %String = <span class="hljs-string"><span class="hljs-string">""</span></span> set status = connection.InvokeClassMethod(..%ClassName(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"TestMethod"</span></span>, .rVal, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">/*has return*/</span></span>, $$$cbindStringId) zw rVal <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> connection.Disconnect() } ... }</code> </pre> <br><p>  After creating the connection, and before calling the class method, you have to take care of passing the argument list starting with the <code>ResetArguments</code> call, and then passing each following argument through the <code>AddArgument</code> call, not forgetting a bunch of unclear, low-level parameters describing the argument (for example, its type in cpp-binding nomenclature, argument type, input or output, and more). </p><br><p>  Also, personally, I was very frustrated that it was impossible to simply return the value after calling the remote method (since the return value of the <code>InvokeClassMethod</code> is just a status code, and to simply return the scalar value from the function, you yourself had to take care of the appropriate type argument when passing a long list of parameters). </p><br><p>  <em>I'm too old for such wordy and long preliminary games!</em> </p><br><p>  <em>Ideally, I wanted to get a short and simple method of passing parameters to a remote function running on another machine or in another area.</em> </p><br><p>  Remember in Cach√© ObjectScript there is a method for passing a variable number of parameters through an array of <code>args...</code> in the function arguments?  Why not search for such a mechanism to hide all these dirty details of the low-level interface, leaving us just the name and the list of arguments?  And so that the engine did everything by itself (having guessed the type of the transmitted data, for example)? </p><br><pre> <code class="hljs smalltalk">///      %<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span> { <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> [<span class="hljs-type"><span class="hljs-type">Internal</span></span> ]; <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">LastStatus</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> [<span class="hljs-type"><span class="hljs-type">InitialExpression</span></span> = {<span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K}]; <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">OnNew</span></span>() <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> { set ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> = #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(%<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>).%<span class="hljs-type"><span class="hljs-type">New</span></span>() return <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K } ///     <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(className <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> instanceProxy <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> = #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span>).%<span class="hljs-type"><span class="hljs-type">New</span></span>(<span class="hljs-string"><span class="hljs-string">$t</span></span>his) return instanceProxy.%<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(className) } ///       %<span class="hljs-type"><span class="hljs-type">ID</span></span> <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">OpenObjectId</span></span>(className <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Id</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> instanceProxy <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> = #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span>).%<span class="hljs-type"><span class="hljs-type">New</span></span>(<span class="hljs-string"><span class="hljs-string">$t</span></span>his) return instanceProxy.%<span class="hljs-type"><span class="hljs-type">OpenObjectId</span></span>(className, <span class="hljs-type"><span class="hljs-type">Id</span></span>) } ///       /// { <span class="hljs-comment"><span class="hljs-comment">"IP"</span></span>: <span class="hljs-type"><span class="hljs-type">IP</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Namespace"</span></span> : <span class="hljs-type"><span class="hljs-type">Namespace</span></span>, ... } <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">Connect</span></span>(<span class="hljs-type"><span class="hljs-type">Config</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Object</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sIP <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sNamespace <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">Namespace</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sPort <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">Port</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sUsername <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">Username</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sPassword <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">Password</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sClientIP <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">ClientIP</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> sClientPort <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">Config</span></span>.<span class="hljs-type"><span class="hljs-type">ClientPort</span></span> if sIP = <span class="hljs-comment"><span class="hljs-comment">""</span></span> { set sIP = <span class="hljs-comment"><span class="hljs-comment">"127.0.0.1"</span></span> } if sPort = <span class="hljs-comment"><span class="hljs-comment">""</span></span> { set sPort = ^%<span class="hljs-type"><span class="hljs-type">SYS</span></span>(<span class="hljs-comment"><span class="hljs-comment">"SSPort"</span></span>) } set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>.<span class="hljs-type"><span class="hljs-type">Connect</span></span>(sIP, sNamespace, sPort, sUsername, sPassword, sClientIP, sClientPort) return <span class="hljs-string"><span class="hljs-string">$t</span></span>his } <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">ApparentlyClassName</span></span>(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-type"><span class="hljs-type">ClassName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-type"><span class="hljs-type">MethodName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span> [<span class="hljs-type"><span class="hljs-type">Internal</span></span> ] { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> returnValue <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> if <span class="hljs-string"><span class="hljs-string">$l</span></span>ength(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"::"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> { set <span class="hljs-type"><span class="hljs-type">ClassName</span></span> = <span class="hljs-string"><span class="hljs-string">$p</span></span>iece(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"::"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) set <span class="hljs-type"><span class="hljs-type">MethodName</span></span> = <span class="hljs-string"><span class="hljs-string">$p</span></span>iece(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"::"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, *) return <span class="hljs-number"><span class="hljs-number">1</span></span> } elseif <span class="hljs-string"><span class="hljs-string">$l</span></span>ength(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"'"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> { set <span class="hljs-type"><span class="hljs-type">ClassName</span></span> = <span class="hljs-string"><span class="hljs-string">$p</span></span>iece(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"'"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) set <span class="hljs-type"><span class="hljs-type">MethodName</span></span> = <span class="hljs-string"><span class="hljs-string">$p</span></span>iece(<span class="hljs-type"><span class="hljs-type">CompoundName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"'"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, *) return <span class="hljs-number"><span class="hljs-number">1</span></span> } return <span class="hljs-number"><span class="hljs-number">0</span></span> } ///    ()   <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchMethod</span></span>(methodName <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> className as %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> if ..<span class="hljs-type"><span class="hljs-type">ApparentlyClassName</span></span>(methodName, .className, .methodName) { return ..<span class="hljs-type"><span class="hljs-type">InvokeClassMethod</span></span>(className, methodName, args...) } return <span class="hljs-number"><span class="hljs-number">1</span></span> } ///         <span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">InvokeClassMethod</span></span>(<span class="hljs-type"><span class="hljs-type">ClassName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">MethodName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> returnValue = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> i as %<span class="hljs-type"><span class="hljs-type">Integer</span></span> do ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>.<span class="hljs-type"><span class="hljs-type">ResetArguments</span></span>() for i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$g</span></span>et(args) { set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>.<span class="hljs-type"><span class="hljs-type">AddArgument</span></span>(args(i), <span class="hljs-number"><span class="hljs-number">0</span></span>) } set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>.<span class="hljs-type"><span class="hljs-type">InvokeClassMethod</span></span>(<span class="hljs-type"><span class="hljs-type">ClassName</span></span>, <span class="hljs-type"><span class="hljs-type">MethodName</span></span>, .returnValue, <span class="hljs-string"><span class="hljs-string">$q</span></span>uit) return returnValue } }</code> </pre> <br><img src="https://habrastorage.org/files/967/593/504/967593504d2645a3b873007542ab9e62.png"><br><p>  When designing this interface, we introduced several fashionable idioms that were supposed to simplify the interaction interface, reduce the size of the code to be written, and, if possible, increase the stability of the interface. </p><br><p>  The first such simplification that we tried to make to the interface is to use the <em>configurator object</em> to pass <em>named arguments</em> into the function instead of a long list.  Cach√© ObjectScript does not have (yet) a built-in way to pass <a href="http://perldesignpatterns.com/%3FNamedArguments"><em>named arguments</em></a> , and if, for example, you only need to pass the last two arguments from a long list of function parameters, then you need to carefully count the commas of parameters that you are not interested in and pass at the end what you want.  Frankly, a very fragile design. </p><br><p>  On the other hand, more recently, ObjectScript has built-in support for JSON objects that can be created on the fly, inside the expression <code>{}</code> .  We can follow Perl‚Äôs example, try to reuse such dynamically created objects (in the case of Perl, it was a hash) to pass the named arguments to the function.  The dynamic object configurator can contain only those value keys that interest us. </p><br><pre> <code class="hljs mel">DEVLATEST:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:MAPREDUCE&gt;set w = ##class(Sample.RemoteProxy).%New().%Connect({<span class="hljs-string"><span class="hljs-string">"Namespace"</span></span>:<span class="hljs-string"><span class="hljs-string">"SAMPLES"</span></span>, <span class="hljs-string"><span class="hljs-string">"Username"</span></span>:<span class="hljs-string"><span class="hljs-string">"_SYSTEM"</span></span>, <span class="hljs-string"><span class="hljs-string">"Password"</span></span>:<span class="hljs-string"><span class="hljs-string">"SYS"</span></span>}) DEVLATEST:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:MAPREDUCE&gt;zw w w=&lt;OBJECT REFERENCE&gt;[<span class="hljs-number"><span class="hljs-number">1</span></span>@Sample.RemoteProxy] +----------------- general information --------------- | oref value: <span class="hljs-number"><span class="hljs-number">1</span></span> | class name: Sample.RemoteProxy | <span class="hljs-keyword"><span class="hljs-keyword">reference</span></span> count: <span class="hljs-number"><span class="hljs-number">2</span></span> +----------------- attribute values ------------------ | LastStatus = <span class="hljs-number"><span class="hljs-number">1</span></span> +----------------- swizzled references --------------- | i%Config = <span class="hljs-string"><span class="hljs-string">""</span></span> | r%Config = <span class="hljs-string"><span class="hljs-string">""</span></span> | i%RemoteConnection = <span class="hljs-string"><span class="hljs-string">""</span></span> | r%RemoteConnection = <span class="hljs-number"><span class="hljs-number">2</span></span>@%Net.RemoteConnection +-----------------------------------------------------</code> </pre> <br><blockquote>  Yes, I agree, the construction is still not as transparent as it was in Perl, because  there are still additional curly braces framing the object, but this is already the way in the right direction </blockquote><p>  The second modern idiom introduced in this example is call cascading.  Where it was only possible, we returned from the methods a link to the current <code>%this</code> object, which made it possible to call several methods of the same class as a cascade. </p><br><p>  We write less code - we sleep better. </p><br><h3 id="problema-vyzova-metoda-klassa">  The problem of calling class method </h3><br><p>  The wrapper object we created, encapsulating the functionality of <code>Net.RemoteConnection</code> , in its current state cannot do much that we want.  If there is no place to store the context of the object being created ... (Not yet, We will solve this problem later, in another class) The only thing we can try to do now, at the current level of abstraction and with the current shell design, is to simplify the method of calling class methods called without reference to the object instance. </p><br><p>  We can try to redefine <code>%DispatchClassMethod</code> , but in our case this will not help much - we want to write a <em>generalized</em> proxy class that would work for <em>any</em> remote class.  In the case of a simple 1: 1 ratio, when a certain specialized shell on our side corresponds to a certain class on that side, this approach with redefining <code>%DispatchClassMethod</code> works quite well, but ... not for a generic class. </p><br><blockquote>  In general, we will need to come up with something else, but, preferably, still, simple, that would work with any connection and any target class. </blockquote><p>  We will give our rather elegant solution to this problem below, but for now let's step aside and see what can be used in Cach√© as an identifier for a method or property.  Not everyone knows (I, at least, found out about this a couple of years ago) that the names of identifiers in ObjectScript can consist not only of Latin letters and numbers, but also of any "alphabet characters" specified by the current locale (for example, not only Latin letters A -Za-z and Arabic numerals 0-9, but also Cyrillic letters A-Ya-i, <em>with the Russian locale installed</em> ).  [ <a href="http://stackoverflow.com/questions/35452352/what-characters-are-usable-in-a-variable-name-in-objectscript-on-a-unicode-ins/35492721">this problem was discussed in passing in this discussion on StackOverflow</a> ] Moreover, if you continue to be perverted, you can insert any emoji characters as a separator in the identifier name <em>if you create and activate a locale</em> where emoji would be considered literal characters in the current language.  In general, it still seems that any trick sensitive to the installed locale will not fly very far and is not suitable as a generalized solution, t.ch.  let's stop. </p><br><p>  ... On the other hand, the idea of ‚Äã‚Äãusing a certain separator character inside the name of a method (class) seems quite reasonable and promising.  We could hide the delimiter processing inside the <code>%DispatchMethod</code> special implementation, where we would separate the class name from the method name, and accordingly transfer control to the desired class method, hiding all implementation details. </p><br><p>  So, perhaps, we will. </p><br><p>  Returning to the syntax of valid method names, an even less well-known fact is that you can write anything you want into a class method if you put such a name inside double quotes "".  Combining the name ‚Äúquoting‚Äù and a special delimiter for the class name, I could, for example, call the <code>LogicalToDisplay</code> class method from the <code>Cinema.Duration</code> class using the following, at first glance, unusual syntax: </p><br><pre> <code class="hljs pgsql">DEVLATEST:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> w = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(Sample.RemoteProxy).%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>().%<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>({"Namespace":"SAMPLES", "Username":"_SYSTEM", "Password":"SYS"}) DEVLATEST:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> w."Cinema.Duration::LogicalToDisplay"(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>h20m</code> </pre> <br><blockquote>  <em>It looks a bit strange, but extremely simple and compact, is not it?</em> </blockquote><p>  Special name processing and delimiter recognition takes place in the <code>ApparentlyClassName</code> function, where we look for special characters as a separator between <em>the class name</em> and <em>the class method</em> name ‚Äî such delimiters were "::" (double colon like in C ++) or "" "(single quotation mark as in Ada or original Perl (e). </p><br><p>  Note that you should not try to display something on the screen with this remote class method - the entire output of the output will be lost (ignored), since  The cpp-binding protocol does not intercept the output to the screen, and does not return it back to the caller. </p><br><p>  <em>The cpp-binding protocol returns scalar data, not side effects</em> . </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">DEVLATEST</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:16</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:47</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:MAPREDUCE</span></span>&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">w</span></span>."<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Person</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::PrintPersons"(1)</span></span></code> </pre><br><h3 id="proksi-udalennyh-obektov">  Remote proxy objects </h3><br><p>  So far, we have not done a lot of useful things in the <code>Sample.RemoteProxy</code> code above: we just created the connection and forwarded calls to the class methods. </p><br><p>  If you need to create remote instances of classes, or, as expected, open objects by their% ID, then you can use the services of our other shell class <code>%Sample.RemoteProxy.Object</code> . </p><br><pre> <code class="hljs smalltalk"><span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span> { ///         <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Binary</span></span>; <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">Owner</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span> [ <span class="hljs-type"><span class="hljs-type">Internal</span></span> ]; <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">LastStatus</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> [ <span class="hljs-type"><span class="hljs-type">InitialExpression</span></span> = {<span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K}, <span class="hljs-type"><span class="hljs-type">Internal</span></span> ]; <span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>() <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> [ <span class="hljs-type"><span class="hljs-type">CodeMode</span></span> = expression ] { ..<span class="hljs-type"><span class="hljs-type">Owner</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span> } <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">OnNew</span></span>(owner <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> { set ..<span class="hljs-type"><span class="hljs-type">Owner</span></span> = owner return <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K } ///      <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(className <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> pObject <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>().<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(className, .pObject) set ..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> if <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$I</span></span>SOK(..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span>) { set ..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> = pObject } return <span class="hljs-string"><span class="hljs-string">$t</span></span>his } ///       %<span class="hljs-type"><span class="hljs-type">ID</span></span> <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">OpenObjectId</span></span>(className <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Id</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> <span class="hljs-type"><span class="hljs-type">Sample</span></span>.<span class="hljs-type"><span class="hljs-type">RemoteProxy</span></span>.<span class="hljs-type"><span class="hljs-type">Object</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> pObject <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">RegisteredObject</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>().<span class="hljs-type"><span class="hljs-type">OpenObjectId</span></span>(className, <span class="hljs-type"><span class="hljs-type">Id</span></span>, .pObject) set ..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> if <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$I</span></span>SOK(..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span>) { set ..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span> = pObject } return <span class="hljs-string"><span class="hljs-string">$t</span></span>his } ///        <span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-type"><span class="hljs-type">MethodName</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) [ <span class="hljs-type"><span class="hljs-type">Internal</span></span> ] { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> returnValue = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> i as %<span class="hljs-type"><span class="hljs-type">Integer</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> remoteConnection = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>() do remoteConnection.<span class="hljs-type"><span class="hljs-type">ResetArguments</span></span>() for i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$g</span></span>et(args) { set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = remoteConnection.<span class="hljs-type"><span class="hljs-type">AddArgument</span></span>(args(i), <span class="hljs-number"><span class="hljs-number">0</span></span>) } set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = remoteConnection.<span class="hljs-type"><span class="hljs-type">InvokeInstanceMethod</span></span>(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, <span class="hljs-type"><span class="hljs-type">MethodName</span></span>, .returnValue, <span class="hljs-string"><span class="hljs-string">$q</span></span>uit) return returnValue } ///    ()   <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchMethod</span></span>(methodName <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, args...) { //do ..<span class="hljs-type"><span class="hljs-type">LogArgs</span></span>(methodName, args...) return ..<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(methodName, args...) } ///       <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchGetProperty</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> value = <span class="hljs-comment"><span class="hljs-comment">""</span></span> set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>().<span class="hljs-type"><span class="hljs-type">GetProperty</span></span>(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, <span class="hljs-type"><span class="hljs-type">Property</span></span>, .value) return value } ///        <span class="hljs-type"><span class="hljs-type">Method</span></span> %<span class="hljs-type"><span class="hljs-type">DispatchSetProperty</span></span>(<span class="hljs-type"><span class="hljs-type">Property</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> { set ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> = ..<span class="hljs-type"><span class="hljs-type">RemoteConnection</span></span>().<span class="hljs-type"><span class="hljs-type">SetProperty</span></span>(..<span class="hljs-type"><span class="hljs-type">OpenedObject</span></span>, <span class="hljs-type"><span class="hljs-type">Property</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span>) return ..<span class="hljs-type"><span class="hljs-type">LastStatus</span></span> } }</code> </pre> <br><img src="https://habrastorage.org/files/b5c/214/e99/b5c214e9901046abaea42d867529af20.png"><br><p>  ,              <code>Sample.RemoteProxy</code> ,      cpp-binding (   <code>%Net.RemoteConnection</code> ).         <code>Sample.RemoteProxy.Object</code> ,       <code>..Owner</code>  <code>Sample.RemoteProxy</code>       .          ( <code>%OnNew</code> ). </p><br><p>    ()   <code>InvokeMethod</code> ,        ,      <code>%Net.RemoteConnection</code>     (, ..        <code>%Net.RemoteConnection</code>   <code>ResetArguments</code>      ,  ,  <code>AddArgument</code>    ,      <code>%NetRemoteConnection::InvokeInstanceMethod</code>    " ") </p><br><pre> <code class="hljs pgsql">DEVLATEST:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> w = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(Sample.RemoteProxy).%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>().%<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>({"Namespace":"SAMPLES", "Username":"_SYSTEM", "Password":"SYS"}) ‚Ä¶ DEVLATEST:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> p = w.%OpenObjectId("Sample.Person",<span class="hljs-number"><span class="hljs-number">1</span></span>) DEVLATEST:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> p.Name Quince,Maria B. DEVLATEST:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> p.SSN <span class="hljs-number"><span class="hljs-number">369</span></span><span class="hljs-number"><span class="hljs-number">-27</span></span><span class="hljs-number"><span class="hljs-number">-1697</span></span> DEVLATEST:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:MAPREDUCE&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> p.Addition(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>            "SAMPLES",    <code>Sample.Person</code>   1,    (Name, SSN)    (Addition). </p><br><blockquote>  ,        ,      ,   ,   ,       . </blockquote><br><h3 id="vmesto-zaklyucheniya">  Instead of conclusion </h3><br><p> ,    ,      (    ,        , ,  ,          <em>   </em> ,           . ,   ,      . </p><br><p>        MapReduce    ... </p><br><p>  ,  ,   <a href="https://gist.github.com/tsafin/02bb6b5967cbdd1176618cb645445770">gist</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314774/">https://habr.com/ru/post/314774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314764/index.html">The basis of the system business - basic analytics</a></li>
<li><a href="../314766/index.html">Chrome extension hot reboot</a></li>
<li><a href="../314768/index.html">Interplanetary File System IPFS</a></li>
<li><a href="../314770/index.html">Configuring the internal navigation system using the tools Aruba</a></li>
<li><a href="../314772/index.html">3CX v15 VPS replaces the multi-tenant version of 3CX Phone System 14</a></li>
<li><a href="../314776/index.html">Know the competitor in person: how we conducted a competitive analysis</a></li>
<li><a href="../314778/index.html">NetApp ONTAP & ESXi 6.x tuning</a></li>
<li><a href="../314780/index.html">We use generics in RAD Studio Delphi. Create a library of sorting lists of similar objects</a></li>
<li><a href="../314782/index.html">TrickBot - a new spam attack on the company</a></li>
<li><a href="../314784/index.html">Oracle database audit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>