<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Pumping" notepad.exe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is your association with the F5 key? Updating the page in the browser? Copying a file from one directory to another? Running an application from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Pumping" notepad.exe</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/281/859/209/281859209908f1c75298c64c838c3bf3.png" alt="image"><br><br>  What is your association with the F5 key?  Updating the page in the browser?  Copying a file from one directory to another?  Running an application from Visual Studio?  But the authors of notepad.exe approached this issue in a rather original way - pressing the F5 key adds the current date and time to the place where the cursor is pointing at at that moment.  Everything would be cool if notepad.exe were such a popular and quite natural for most text editors feature, as re-reading the contents of the current file, which, it would seem, should be assigned to F5 / Ctrl-R or some other standard hot key <br><br>  We can wait while it is being implemented by Microsoft, choose another text editor (this is not the only restriction on the functionality of the standard notepad.exe) or ... Pick up the disassembler, debugger and editor of PE files. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How was the process, and what came of it, read under the cut (carefully, a <b>lot of screenshots</b> ).  Before reading this article, I also <b>strongly</b> recommend that you review the <a href="http://habrahabr.ru/users/nikitatrophimov/topics/">previous ones</a> . <br><a name="habracut"></a><br>  In order not to deal with the same inconvenience that we encountered in the <a href="http://habrahabr.ru/post/261233/">previous article</a> , let's turn off the use of <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR first</a> .  According to the wiki, ASLR (Address space layout randomization) is a technology that makes it possible to randomly change the location of important structures in the address space of the process, namely, the image of the executable file, loadable libraries, heaps and stacks.  It was because of her last time restarting the application and led to a change in addresses already found by us.  If you are using Windows XP or an older OS, you can easily skip what is described in the next few paragraphs, because ASLR was not yet at that time. <br><br>  You can disable the use of ASLR globally (to do this, add / edit the value of the ‚ÄúMoveImages‚Äù option stored in the registry at ‚ÄúHKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ Memory Management‚Äù to make it zero) and locally i.e.  for a particular executable file.  The latter option looks more attractive, especially if we are not talking about a virtual machine, but about a real system, so let's dwell on it. <br><br>  Copy notepad.exe to any directory other than "% WINDIR% \ System32", download, unzip and launch <a href="http://sourceforge.net/projects/pe-tools/">PE Tools</a> , press Alt-1 and select notepad.exe that was previously copied: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/78d/b16/4e8/78db164e8aa21150cf4a4669093c9fde.png" alt="image"><br><br>  Click on the ‚ÄúOptional Header‚Äù button and look at the DLL Flags field, which in our case is 0x8140: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e6/287/efa/9e6287efa3137262583a6090ddf8390c.png" alt="image"><br><br>  The value in this field is the result of performing the ‚ÄúOR‚Äù bit operation for the constants listed in the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680339(v%3Dvs.85).aspx">official</a> MSDN <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680339(v%3Dvs.85).aspx">documentation</a> .  It is easy to see that our binary has the following characteristics: <br><br><blockquote>  IMAGE_DLLCHARACTERISTICS_TERMINAL_SERVER_AWARE <br>  0x8000 <br>  The image is terminal server aware <br><br>  IMAGE_DLLCHARACTERISTICS_NX_COMPAT <br>  0x0100 <br>  The image is compatible with data execution prevention (DEP) <br><br>  IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE <br>  0x0040 <br>  The DLL can be relocated at load time </blockquote><br>  Notice the last meaning?  Well, that's exactly what interests us.  Change 0x8140 to 0x8100, click "Ok" in both windows and start debugging. <br><br>  What stages can conditionally divide our notepad.exe patching? <br><br><ul><li>  Search for the address where the path to the current file is stored </li><li>  Finding the procedure for reading the contents of a file </li><li>  Finding the code responsible for handling the F5 key press </li><li>  Actually, writing the patch itself </li></ul><br>  Open notepad.exe in <a href="http://www.ollydbg.de/">OllyDbg</a> and proceed to the first stage. <br><br>  You can approach the search for the address where the path to the current file is stored from several sides at once.  You can, for example, find a procedure that deals with opening a file (most likely, if successful, it saves the path to the file to some address), or you can look at the implementation of the file saving algorithm (obviously, he should know either the handle of the current file or way to him).  I propose to stay on the second version. <br><br>  Hoping that the file opens again every time it‚Äôs saved, we set breakpoints on the calls to the WinAPI <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v%3Dvs.85).aspx">CreateFileW</a> function: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/798/7dc/7c7/7987dc7c798f1c39de0201bd7886463b.png" alt="image"><br><br>  Press Ctrl-S, select the file name (in my case it is ‚ÄúC: \ helper.txt‚Äù) and stop at the following place: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bdd/096/56f/bdd09656f1219f3d3743babbf05d6c98.png" alt="image"><br><br>  Let's see where and with what arguments we were called: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e1/9af/aca/5e19afacae2d58d4e8158a7477563ee0.png" alt="image"><br><br>  If you look at what the address passed as the second argument indicates (the right-click on the line with this argument -&gt; Follow address in stack), then we will see exactly our path: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a2/3a1/a46/9a23a1a461bb47886d06824158a5ead0.png" alt="image"><br><br>  Let's look at the code before the call of the procedure we are examining in order to understand where this address came from and how we got it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffc/8ab/2c1/ffc8ab2c1b842d41c4b424fe6905ca04.png" alt="image"><br><br>  As you can see, the address where the path to the file is stored is contained in <b>EBP-8</b> .  Let's press Ctrl-S again and see where we go this time (after all, now the program already knows the path to the file, which can change the way the application works): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/87f/8ae/ca5/87f8aeca5a197434a333bd1988675816.png" alt="image"><br><br>  So, we ended up on the same breack as before, but called us from another place: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/7bf/ab3/a987bfab36496c6b184db031b96456e3.png" alt="image"><br><br>  This time the address containing the path to the file is stored in the <b>EBX</b> register.  Since the beginning of the current case block (note the comment with several instructions before the allocated space), the value of this register does not change, which means that you need to look for the original address somewhere before.  We look at which instructions refer to the beginning of this case block (left-click at <b>0x01004D5D</b> -&gt; Ctrl-R): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f4/e0a/0f8/9f4e0a0f82914e283fb6e113690dd5e1.png" alt="image"><br><br>  Once such a call is only one, we jump onto it by pressing the Enter key and immediately see where this address appears in <b>EBX</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/614/ea4/d67/614ea4d675e551fc3e292670a077739d.png" alt="image"><br><br>  So, we realized that at the address <b>0x0100CAE0</b> the path to the current file is stored.  What's next?  And then we must find the procedure responsible for reading the contents of the file. <br><br>  Obviously, it will also call <b>CreateFileW</b> (instead, we could intercept the call to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms646927(v%3Dvs.85).aspx">GetOpenFileName</a> function, but it is not in the list of intermodule calls ‚Äî apparently, the Common Item Dialog API, which is recommended on MSDN, is used instead).  Press Ctrl-O, select any file (I chose the same one) and, not having time to double-click with the mouse, find ourselves on the breakpoint at <b>0x01006E8C</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76c/842/1e7/76c8421e7d135b4690d76b160a24e5a7.png" alt="image"><br><br>  We do the same thing several times before removing this breakpoint and hoping for the rest.  And the truth is, after the bryak was removed to the address specified earlier, we were still able to double-click on the file of interest to us, as a result of which the breakpoint worked in a completely different place: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c90/25f/658/c9025f6580186f80446cd8b831af7eff.png" alt="image"><br><br>  So, our task is to find out how and exactly which procedure should be called in order to successfully re-read the file of interest to us.  We put bryak on the address from which we were called <br><br><img src="https://habrastorage.org/getpro/habr/post_images/624/33e/892/62433e892ae8d3602893622d502bffc0.png" alt="image"><br><br>  , press F9, and ... It immediately works!  Nothing, press F9 again, try to transfer the focus to the notepad.exe window and see that the bryak works again.  Yes, what is it!  Let's look at the beginning of the procedure that this CALL calls: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d0f/4c9/dfa/d0f4c9dfa62fd88eebd798dbe35e0c11.png" alt="image"><br><br>  Pay attention to the only comment - judging by the number of processed values ‚Äã‚Äãand what we observe in practice, this procedure is used to respond to any action performed by the user, be it transferring the focus note.exe file to the window or opening a file.  Apparently, after pressing Ctrl-O, the program does not perform any <b>CALL</b> , but only moves to the corresponding case block using the conditional branch operation.  Let's remove this breakpoint, try again to open the file and find the one closest to the breakpoint that is in place of the call to <b>CreateFileW</b> , the instruction to which there is a call in the code.  She was the instruction at the address <b>0x01004DF5</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/48d/ce7/e54/48dce7e5413c84f9abae70fb33873cee.png" alt="image"><br><br>  We put bryaki on both appeals, perform the same actions and find ourselves here: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71c/5d5/075/71c5d5075a3e8746fb06f505d8634f47.png" alt="image"><br><br>  Put the bryak on the beginning of this case, again open the same file and try to understand what is happening here: <br><br><pre><code class="hljs 1c">;     EDI <span class="hljs-number"><span class="hljs-number">01003</span></span>ECC &gt; \<span class="hljs-number"><span class="hljs-number">33</span></span>FF XOR EDI,EDI ; Case <span class="hljs-number"><span class="hljs-number">2</span></span> of switch <span class="hljs-number"><span class="hljs-number">01001824</span></span> ;        ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  ,         <span class="hljs-type"><span class="hljs-type"></span></span> <span class="hljs-number"><span class="hljs-number">01003</span></span>ECE . <span class="hljs-number"><span class="hljs-number">57</span></span> PUSH EDI <span class="hljs-number"><span class="hljs-number">01003</span></span>ECF . E8 <span class="hljs-number"><span class="hljs-number">90</span></span>D7FFFF CALL notepad.<span class="hljs-number"><span class="hljs-number">01001664</span></span> ;    ; EAX == <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  /    Save / Don't Save, EAX == 0,     Cancel <span class="hljs-number"><span class="hljs-number">0100</span></span>3ED4 . 85C0 TEST EAX,EAX ;   Cancel,      ,    case <span class="hljs-number"><span class="hljs-number">0100</span></span>3ED6 .^ 0F84 8ED9FFFF JE notepad.<span class="hljs-number"><span class="hljs-number">010018</span></span>6A ;     0x100C00C  EAX    EBP-10 <span class="hljs-number"><span class="hljs-number">0100</span></span>3EDC . A1 0CC<span class="hljs-number"><span class="hljs-number">0000</span></span>1 MOV EAX,DWORD PTR DS:[100C00C] <span class="hljs-number"><span class="hljs-number">0100</span></span>3EE1 . <span class="hljs-number"><span class="hljs-number">8945</span></span> F0 MOV DWORD PTR SS:[EBP-10],EAX ;          <span class="hljs-number"><span class="hljs-number">0100</span></span>3EE4 . 8D45 F8 LEA EAX,DWORD PTR SS:[EBP-8] <span class="hljs-number"><span class="hljs-number">0100</span></span>3EE7 . 50 PUSH EAX ; /Arg2 <span class="hljs-number"><span class="hljs-number">0100</span></span>3EE8 . FF75 F4 PUSH DWORD PTR SS:[EBP-C] ; |Arg1 <span class="hljs-number"><span class="hljs-number">0100</span></span>3EEB . E8 <span class="hljs-number"><span class="hljs-number">31000000</span></span> CALL notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>3F21 ; \notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>3F21 ;       EBP-8       ; EAX == 0     0x<span class="hljs-number"><span class="hljs-number">800704</span></span>C7     Cancel <span class="hljs-number"><span class="hljs-number">0100</span></span>3EF0 . 8BF0 MOV ESI,EAX <span class="hljs-number"><span class="hljs-number">0100</span></span>3EF2 . 3BF7 CMP ESI,EDI ;        <span class="hljs-number"><span class="hljs-number">0100</span></span>3EF4 . 0F8D FB0E<span class="hljs-number"><span class="hljs-number">0000</span></span> JGE notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>4DF5 <span class="hljs-number"><span class="hljs-number">0100</span></span>3EFA . 81FE C<span class="hljs-number"><span class="hljs-number">704078</span></span>0 CMP ESI,<span class="hljs-number"><span class="hljs-number">800704</span></span>C7 <span class="hljs-number"><span class="hljs-number">0100</span></span>3F00 . 0F85 DC0E<span class="hljs-number"><span class="hljs-number">0000</span></span> JNZ notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>4DE2 <span class="hljs-number"><span class="hljs-number">0100</span></span>3F06 &gt; 3BF7 CMP ESI,EDI <span class="hljs-number"><span class="hljs-number">0100</span></span>3F08 . 0F8D E70E<span class="hljs-number"><span class="hljs-number">0000</span></span> JGE notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>4DF5 <span class="hljs-number"><span class="hljs-number">0100</span></span>3F0E &gt; 8B45 F0 MOV EAX,DWORD PTR SS:[EBP-10] <span class="hljs-number"><span class="hljs-number">0100</span></span>3F11 . A3 0CC<span class="hljs-number"><span class="hljs-number">0000</span></span>1 MOV DWORD PTR DS:[100C00C],EAX <span class="hljs-number"><span class="hljs-number">0100</span></span>3F16 . 56 PUSH ESI <span class="hljs-number"><span class="hljs-number">0100</span></span>3F17 .^ E9 A2FCFFFF JMP notepad.<span class="hljs-number"><span class="hljs-number">0100</span></span>3BBE</code> </pre> <br>  Now let's see which registers and addresses are used by the code at <b>0x01004DF5</b> , in order to understand what kind of ‚Äúenvironment‚Äù is necessary for its correct operation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d0/67d/3c0/8d067d3c07b4c371741cd6d35bd4acf7.png" alt="image"><br><br>  Of course, this code refers to <b>EBP-8</b> , which, as you remember, stores the path to the file being opened.  In addition, the value of the <b>EDI</b> register is also important to it, which is used as arguments for the <b>hTemplateFile</b> and <b>pSecurity parameters</b> .  The first we can get from the address <b>0x0100CAE0</b> , and in the designated parameters, you can simply pass a zero. <br><br>  Now let's find the code responsible for handling the F5 key presses.  To do this, I propose to put a breakpoint on calls to functions that are responsible for obtaining the current time.  The most popular of them are <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724390(v%3Dvs.85).aspx">GetSystemTime</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724338(v%3Dvs.85).aspx">GetLocalTime</a> .  The first one is not in the list of intermodular calls, but the second one is called from two places at once: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ee/21d/d18/2ee21dd18388d46e27989fab89ed4d03.png" alt="image"><br><br>  We put bryaki, press F5 and find ourselves here: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/134/684/df0/134684df01971a975d71bb3e60041d6a.png" alt="image"><br><br>  We jump into the place of calling the current procedure and get almost to the very beginning of another case block, which, obviously, is responsible for handling the F5 key: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e2f/5fb/faf/e2f5fbfaff67765c2adfe18e955ae52f.png" alt="image"><br><br>  Fine.  We are looking for a place for our code cave and write (of course, addresses may vary): <br><br><pre> <code class="hljs css">0100<span class="hljs-selector-tag"><span class="hljs-selector-tag">BEB3</span></span> 33<span class="hljs-selector-tag"><span class="hljs-selector-tag">FF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XOR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EDI</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">EDI</span></span> 0100<span class="hljs-selector-tag"><span class="hljs-selector-tag">BEB5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C745</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">F8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">E0CA0</span></span>&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">MOV</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[EBP-8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">notepad</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0100CAE0</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">UNICODE</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">helper</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.txt</span></span>" 0100<span class="hljs-selector-tag"><span class="hljs-selector-tag">BEBC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">CC00001</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MOV</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[100C00C]</span></span> 0100<span class="hljs-selector-tag"><span class="hljs-selector-tag">BEC1</span></span> 8945 <span class="hljs-selector-tag"><span class="hljs-selector-tag">F0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MOV</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[EBP-10]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> 0100<span class="hljs-selector-tag"><span class="hljs-selector-tag">BEC4</span></span> ^ <span class="hljs-selector-tag"><span class="hljs-selector-tag">E9</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">C8FFFFF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">notepad</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.01004DF5</span></span></code> </pre><br>  We insert at the address <b>0x0100447B</b> jump to our code cave: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aea/dfc/de3/aeadfcde3203988d7b81ae79728b39f1.png" alt="image"><br><br>  Press F9, press F5 again and see the following picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b6/d05/f03/7b6d05f035e35b342db055cfa1416e31.png" alt="image"><br><br>  As you can see, we fell somewhere in the depths of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680722(v%3Dvs.85).aspx">CoTaskMemFree</a> function.  Pay attention to the argument passed to this function - yes, yes, this is the address of our string with the path to the file.  Therefore, the memory for it must be allocated using <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms692727(v%3Dvs.85).aspx">CoTaskMemAlloc</a> .  The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb759924(v%3Dvs.85).aspx">SHStrDup</a> function, which creates a duplicate of the string passed to it, can help us with this, allocating memory for it with the help of <b>CoTaskMemAlloc</b> . <br><br>  Restart notepad.exe and look for the address of the <b>SHStrDupW</b> function in IAT.  To do this, we look at the call of any other WinAPI function in the module: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d1/3a2/2ba/7d13a22baa0ef10a380f0109dba3a451.png" alt="image"><br><br>  Consequently, the address of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms645489(v%3Dvs.85).aspx">GetDlgItemTextW</a> function in IAT is <b>0x010012A4</b> .  Jump on it and look for our <b>SHStrDupW</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2fd/574/77e/2fd57477ec5fd0bb80cfde4c398f2faa.png" alt="image"><br><br>  It turns out that its call can be issued in the form of a <b>CALL DWORD PTR DS</b> instruction <b>: [010013B4]</b> .  Then we write the following code (error checking is omitted): <br><br><pre> <code class="hljs vbscript"><span class="hljs-number"><span class="hljs-number">0100</span></span>BFA5 . <span class="hljs-number"><span class="hljs-number">33</span></span>FF <span class="hljs-keyword"><span class="hljs-keyword">XOR</span></span> EDI,EDI <span class="hljs-number"><span class="hljs-number">0100</span></span>BFA7 . <span class="hljs-number"><span class="hljs-number">8</span></span>D45 F8 LEA EAX,DWORD PTR SS:[EBP<span class="hljs-number"><span class="hljs-number">-8</span></span>] <span class="hljs-number"><span class="hljs-number">0100</span></span>BFAA . <span class="hljs-number"><span class="hljs-number">50</span></span> PUSH EAX ; /pTarget <span class="hljs-number"><span class="hljs-number">0100</span></span>BFAB . <span class="hljs-number"><span class="hljs-number">68</span></span> E0CA0001 PUSH notepad<span class="hljs-number"><span class="hljs-number">.0100</span></span>CAE0 ; |Source = <span class="hljs-string"><span class="hljs-string">"C:\helper.txt"</span></span> <span class="hljs-number"><span class="hljs-number">0100</span></span>BFB0 . FF15 B4130001 <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> DWORD PTR DS:[&lt;&amp;SHLWAPI.SHStrDupW&gt;] ; \SHStrDupW <span class="hljs-number"><span class="hljs-number">0100</span></span>BFB6 . A1 <span class="hljs-number"><span class="hljs-number">0</span></span>CC00001 MOV EAX,DWORD PTR DS:[<span class="hljs-number"><span class="hljs-number">100</span></span>C00C] <span class="hljs-number"><span class="hljs-number">0100</span></span>BFBB . <span class="hljs-number"><span class="hljs-number">8945</span></span> F0 MOV DWORD PTR SS:[EBP<span class="hljs-number"><span class="hljs-number">-10</span></span>],EAX <span class="hljs-number"><span class="hljs-number">0100</span></span>BFBE .^ E9 <span class="hljs-number"><span class="hljs-number">328</span></span>EFFFF JMP notepad<span class="hljs-number"><span class="hljs-number">.01004</span></span>DF5</code> </pre><br>  Open our file ‚ÄúC: \ helper.txt‚Äù, make sure that it is empty, edit and save it in another copy of notepad.exe, press F5 in the version we are debugging, and ... The file is updated! <br><br>  Let's save our changes to the executable file.  Make a right-click on the window CPU -&gt; Copy to executable -&gt; All modifications -&gt; Copy all and see: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/618/763/c93/618763c9382a7a2a621884439df7175a.png" alt="image"><br><br>  It turns out that we got out of the physical boundaries of the executable file.  Let's take a look at the boundaries of sections in PE Tools (button "Sections") <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d31/4f8/ef1/d314f8ef1e11f76917ae13c028d94d72.png" alt="image"><br><br>  and put our code cave in some other place.  To get the upper ‚Äúborder‚Äù of the area for the ‚Äúpainless‚Äù patch, we need to fold the Virtual Offset of the .text section, where we are going to put our patch, its Raw Size and Image Base, i.e.  Virtual Offset ( <b>0x00001000</b> ) + Raw Size ( <b>0x0000A800</b> ) + Image Base ( <b>0x01000000</b> ) = <b>0x0100B800</b> .  Place it, for example, at <b>0x0100B6CF</b> and try to save the changes again (right-click on the CPU window -&gt; Copy to executable -&gt; All modifications -&gt; Copy all -&gt; right-click in the window that appears -&gt; Save file). <br><br>  We check the resulting executable file for performance and make sure that everything behaves as expected. <br><br><h3>  Afterword </h3><br>  The purpose of this article is to once again demonstrate the possibility of adding your own functionality to existing programs, while not having the source codes.  Now go back to your vims / emacs / Notepad ++ / etc, but remember - if you encounter a bug or pay attention to the absence of any functionality in the editor with a closed code, now you know what to do. <br><br>  Thank you for your attention, and again I hope that the article was useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/261507/">https://habr.com/ru/post/261507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261487/index.html">Big data and big questions</a></li>
<li><a href="../261489/index.html">New courses on Hexlet: React, Ansible and others</a></li>
<li><a href="../261491/index.html">Kingpin: schoolchildren translate a book about hackers</a></li>
<li><a href="../261493/index.html">Controversial, but relevant design principles</a></li>
<li><a href="../261497/index.html">200 million checks per month or architecture and statistics of the CloudStats.me service</a></li>
<li><a href="../261509/index.html">Creating a scalable distributed application from scratch</a></li>
<li><a href="../261511/index.html">PSD parser or how to parse a Photoshop file in Java</a></li>
<li><a href="../261515/index.html">AllJoyn and Windows 10 - we make our devices speak the same language</a></li>
<li><a href="../261517/index.html">Does XMPP suck?</a></li>
<li><a href="../261519/index.html">Acronis Backup Russia - First Look</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>