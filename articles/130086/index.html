<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP sample development case using TDD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post provides a tutorial example of developing a PHP class that makes a request to the Twitter API in order to fetch user statuses by its nicknam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP sample development case using TDD</h1><div class="post__text post__text-html js-mediator-article">  This post provides a tutorial example of developing a PHP class that makes a request to the Twitter API in order to fetch user statuses by its nickname.  In addition, the Twitter class caches the received data using another PHP class that performs simple data caching in files. <br><br>  The purpose of the post is to consolidate their own knowledge, obtained as a result of reading some books, articles, as well as the opportunity to receive comments from experienced TDD practitioners, indicating gross errors in the development process or in tests. <br><br><a name="habracut"></a><br><h4>  Setting the task and requirements </h4><br>  So, it is required to develop through testing a class in the PHP language, which is able to make requests to the Twitter API and return the data received in response.  It is also necessary to provide that the Twitter object may use (or may not use) the caching object.  The caching object must store data in a predefined directory with a predetermined lifetime. <br>  Since the development of training, we agree that the data on the status will be returned raw, in JSON format. <br>  Testing should be done using the PHPUnit framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let us proceed to the description of the requirements for each class, on the basis of which tests will be compiled. <br><br>  FileCache caching class: <br><ol><li>  The class must implement the CacheInterface interface. </li><li>  It should be possible to set the directory where cached data will be saved. </li><li>  It should be possible to set the cache lifetime. </li><li>  If you try to select non-existent data, it must return false. </li></ol><br>  I will give some explanations.  Since there can be a lot of caching opportunities, you need to pre-declare an interface for each such class, in this case CacheInterface.  The remaining requirements are understandable, in my opinion. <br><br>  Twitter class: <br><ol><li>  The object must call the HTTP client method with the correct URL. </li><li>  The object must cache its data if there is such a possibility (if the caching object is specified). </li></ol><br>  The HTTP client should be a third-party object, since it should not be tied to the Twitter class, so it should simply return the data received at the passed URL.  Since the HTTP client is dependent on external factors, and I still do not know how to test such objects, this class will be developed primitive without the use of testing. <br><br><h4>  We start to develop </h4><br>  Let's start development with the FileCache class, write the first test: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFileCacheClassShouldImplementCacheInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $fileCache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileCache(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertInstanceOf(<span class="hljs-string"><span class="hljs-string">'CacheInterface'</span></span>, $fileCache); }</code> </pre> <br>  The test is quite simple, and it starts successfully after the interface description: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CacheInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id, $data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; }</code> </pre> <br>  ... and after the initial description of the FileCache class: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileCache</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CacheInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id, $data)</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  To implement the further two tests, it is necessary to program the fixture preparation methods, namely the creation and clearing of the directory with the cache files: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileCacheTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $cacheDir = <span class="hljs-string"><span class="hljs-string">'./cache_data'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//Create cache dir if (file_exists($this-&gt;cacheDir)) { $this-&gt;_removeCacheDir(); } mkdir($this-&gt;cacheDir); } public function tearDown() { //remove cache dir $this-&gt;_removeCacheDir(); } protected function _removeCacheDir() { $dir = opendir($this-&gt;cacheDir); if ($dir) { while ($file = readdir($dir)) { if ($file != '.' &amp;&amp; $file != '..') { unlink($this-&gt;cacheDir . '/' . $file); } } } closedir($dir); rmdir($this-&gt;cacheDir); } }</span></span></code> </pre> <br>  And tests: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSettingCacheDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $beforeFilesCount = count(scandir(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir)); $fileCache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileCache(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir); $fileCache-&gt;save(<span class="hljs-string"><span class="hljs-string">'data_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>); $afterFilesCount = count(scandir(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertTrue($afterFilesCount &gt; $beforeFilesCount); }</code> </pre> <br>  This test checks whether the cache file actually appeared in the directory that was specified when the FileCache object was created. <br><br>  To make the test work successfully, I made minimal changes to the FileCache class: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileCache</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CacheInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $cacheDir; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $cacheDir */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cacheDir = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'.'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir = $cacheDir; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id, $data)</span></span></span><span class="hljs-function"> </span></span>{ $filename = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $id . <span class="hljs-string"><span class="hljs-string">'.dat'</span></span>; $f = fopen($filename, <span class="hljs-string"><span class="hljs-string">'w'</span></span>); fwrite($f, serialize($data)); fclose($f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre><br>  The following test that implements a cache lifetime check: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSettingCacheLifetime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $lifetime = <span class="hljs-number"><span class="hljs-number">2</span></span>; $cacheData = <span class="hljs-string"><span class="hljs-string">'data'</span></span>; $cacheId = <span class="hljs-string"><span class="hljs-string">'expires'</span></span>; $fileCache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileCache(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir, $lifetime); $fileCache-&gt;save($cacheId, $cacheData); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals($cacheData, $fileCache-&gt;load($cacheId)); sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertFalse($fileCache-&gt;load($cacheId)); }</code> </pre> <br>  The test checks the availability of cache data before and after its ‚Äúswelling‚Äù.  The implementation of this test in my opinion is unacceptable when developing a larger project, since the sleep (3) operator delays the test for 3 seconds.  The most suitable option is to manually change the file access time. <br><br>  Add a class cache lifetime assignment to the class constructor: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $cacheDir * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $lifetime */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cacheDir = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'.'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $lifetime = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3600</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir = $cacheDir; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lifetime = $lifetime; }</code> </pre> <br>  And add the load method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $filename = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $id . <span class="hljs-string"><span class="hljs-string">'.dat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time() - fileatime($filename) &gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lifetime) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unserialize(file_get_contents($filename)); }</code> </pre><br>  At this stage, it is already possible to refactor code in order to remove duplication of code in the FileCache class, namely, the creation of the file name in the load and save methods.  To do this, add the private method _createFilename.  This piece of code has already been tested, so you can not be afraid that the closed method will be untested (source: <a href="http://blog.byndyu.ru/">blog.byndyu.ru</a> , I don‚Äôt remember the exact post, but all articles are equally useful and interesting). <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_createFilename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $id . <span class="hljs-string"><span class="hljs-string">'.dat'</span></span>; }</code> </pre> <br>  Last test: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadShouldReturnFalseOnNonexistId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $fileCache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileCache(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheDir); $fileCache-&gt;save(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertFalse($fileCache-&gt;load(<span class="hljs-string"><span class="hljs-string">'non_exist'</span></span>)); }</code> </pre> <br>  In order for the test to work, you just need to add a piece of code to the load method: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $filename = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_createFilename($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($filename)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time() - fileatime($filename) &gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lifetime) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unserialize(file_get_contents($filename)); }</code> </pre> <br>  So, all the tests for the FileCache class work, you can proceed to implement the Twitter class. <br><br><h4>  We develop further </h4><br><br>  We start by writing a test for the first requirement: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testTwitterShouldCallHttpClientWithCorrectUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $httpClient = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMock(<span class="hljs-string"><span class="hljs-string">'HttpClientInterface'</span></span>); $nickname = <span class="hljs-string"><span class="hljs-string">'test_nick'</span></span>; $twitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Twitter($httpClient); $httpClient -&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'get'</span></span>) -&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo(<span class="hljs-string"><span class="hljs-string">'http://api.twitter.com/1/statuses/user_timeline.json?screen_name='</span></span> . $nickname)); $twitter-&gt;getStatuses($nickname); }</code> </pre> <br>  This test will verify that the URL that will be used to fetch data from the Twitter API is passed correctly to the Http client object.  Since the tests should be independent, I use the mock object to simulate the Http client.  I describe which method should be called from the mock object, how many times and with what parameters.  Read more about this in the documentation for PHPUnit. <br>  I will immediately give you another test that tests the second requirement for the Twitter class: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testTwitterShouldLoadDataFromCacheIfIsPossible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $cache = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMock(<span class="hljs-string"><span class="hljs-string">'CacheInterface'</span></span>); $httpClient = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMock(<span class="hljs-string"><span class="hljs-string">'HttpClientInterface'</span></span>); $nickname = <span class="hljs-string"><span class="hljs-string">'test_nick'</span></span>; $twitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Twitter($httpClient); $url = <span class="hljs-string"><span class="hljs-string">'http://api.twitter.com/1/statuses/user_timeline.json?screen_name='</span></span> . $nickname; $urlMd5 = md5($url); $resultCached = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'status1'</span></span>, <span class="hljs-string"><span class="hljs-string">'status2'</span></span>, <span class="hljs-string"><span class="hljs-string">'status3'</span></span>); $resultNotCached = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'save_to_cache'</span></span>); $twitter-&gt;setCache($cache); $cache-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;at(<span class="hljs-number"><span class="hljs-number">0</span></span>))-&gt;method(<span class="hljs-string"><span class="hljs-string">'load'</span></span>)-&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo($urlMd5))-&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue($resultCached)); $cache-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;at(<span class="hljs-number"><span class="hljs-number">1</span></span>))-&gt;method(<span class="hljs-string"><span class="hljs-string">'load'</span></span>)-&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo($urlMd5))-&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); $httpClient-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once())-&gt;method(<span class="hljs-string"><span class="hljs-string">'get'</span></span>)-&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo($url))-&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue($resultNotCached)); $cache-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once())-&gt;method(<span class="hljs-string"><span class="hljs-string">'save'</span></span>)-&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo($urlMd5), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;equalTo($resultNotCached)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals($resultCached, $twitter-&gt;getStatuses($nickname)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals($resultNotCached, $twitter-&gt;getStatuses($nickname)); }</code> </pre> <br>  This test is quite voluminous.  It also uses mock objects.  In addition to the Http client's mock object, the cash class mock object is also used, despite the fact that this class has already been developed (remember about the independence of the tests).  The test checks whether HTTP is accessed if the data is already in the cache.  In addition, the validity of the returned data is verified. <br>  The source code for the Twitter class that performs both tests is as follows: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> HttpClientInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $httpClient; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $methodUrl = <span class="hljs-string"><span class="hljs-string">'http://api.twitter.com/1/statuses/user_timeline.json'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> CacheInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $cache = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> HttpClientInterface $httpClient */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpClientInterface $httpClient)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;httpClient = $httpClient; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> CacheInterface $cache * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Twitter */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CacheInterface $cache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = $cache; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $nickname * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatuses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($nickname)</span></span></span><span class="hljs-function"> </span></span>{ $url = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;methodUrl . <span class="hljs-string"><span class="hljs-string">'?screen_name='</span></span> . $nickname; $cache = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache; $cacheId = md5($url); $data = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cache !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { $data = $cache-&gt;load($cacheId); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($data === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $data = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;httpClient-&gt;get($url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cache !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { $cache-&gt;save($cacheId, $data); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $data; } }</code> </pre> <br><h4>  Done! </h4><br>  Both classes are designed through testing, they work properly.  To test the real work, I wrote a simple HTTP client that returns the result of the file_get_contents function, and also wrote a simple php script that displays the results of the work, but this is beyond the scope of the article. <br>  The project is also posted on GitHub: <a href="https://github.com/xstupidkidzx/tddttl">github.com/xstupidkidzx/tddttl</a> <br>  In your comments, I would like to see comments on this article.  Problem points that I encountered during deliberation, and which I would like to read in the comments: <br><ol><li>  How widely should the functionality be covered by a separate test?  Should a test test only one method?  Or he can test a variety of methods or a separate piece of one method? </li><li>  Is it necessary to thoroughly test every aspect (for example, the correctness of the parameters passed to the method or constructor)?  Let's say whether it was worth including testing - is the FileCache class a CacheInterface interface? </li></ol><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/130086/">https://habr.com/ru/post/130086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130075/index.html">‚ÄúCreating a National Software Platform is an important step towards building an information society‚Äù</a></li>
<li><a href="../130081/index.html">Japanese cloned teeth</a></li>
<li><a href="../130082/index.html">Creating a simple module for CMS Datalife Engine (DLE)</a></li>
<li><a href="../130084/index.html">Excel Add-in Guide for Beginners</a></li>
<li><a href="../130085/index.html">Encryption / decryption of data on the client in web-based systems</a></li>
<li><a href="../130087/index.html">My experience of writing a program for Android</a></li>
<li><a href="../130088/index.html">Writing a Redmine Plugin</a></li>
<li><a href="../130089/index.html">Imitation of named variables in LESS (with an example in jsFiddle)</a></li>
<li><a href="../130090/index.html">Firewalls - a bit of theory for beginners or what you need to know before you buy</a></li>
<li><a href="../130091/index.html">Free software at school or three days spent with benefit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>