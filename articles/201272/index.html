<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a bot for Grepolis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this article I will describe the writing of a bot for the online mmo strategy of the game Grepolis. Note that the rules of the game use o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a bot for Grepolis</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ff3/210/aee/ff3210aee72916db87ef868098b282b4.jpg" alt="image" align="left">  Good day.  In this article I will describe the writing of a bot for the online mmo strategy of the game Grepolis.  Note that the rules of the game use of such programs is prohibited, for it is banned, and not without reason.  I just have a hobby to write bots for games.  And writing is not prohibited.  To whom the logic and implementation are interesting, I ask under kat. <br><a name="habracut"></a><br>  As always, at the beginning of the link to the <a href="https://github.com/peinguin/Grepolis-Bot">source code</a> . <br><br>  I like Grepolis, a good game.  But in order to survive there, you need to collect tribute from villages every 5 minutes.  And I am busy all day at the main job, so the main purpose of writing a bot was to collect tribute.  Then the auto-improvement of villages was added (then more profit is given), autobuilding (so that at night, when I sleep, the construction queue is not empty).  As I understand it, these functions bring the bulk of the revenue of the administration of the game.  Probably because the players that use bots, so often banyat. <br><br>  By itself, the bot will not play, it is assigned only auxiliary functions.  And in general, it is better not to leave him alone for a long time - they can be banned. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Honestly speaking, this is the second version of the bot, like the first one written in Perl.  The first version of the crown once every five minutes to collect resources, built and completed.  And it worked well, I got into the top players, everything was fine.  But then the game got tired and I scored, when after a while I started playing again - I was banned.  Apparently, they added bot detection features.  So you need to change the approach.  The fact is that the old version did not know anything about what was before it, and it re-collected all the information.  She was not able to determine the list of farms and cities and in general was not hard. <br><br>  So the second version was born.  Now all you need to do is just to specify sid (taken from cookies through dev-tools, for example) and the server you are playing on.  Build a list of cities / farms automatically.  Although I have not tried two cities yet, I still have only one city, but watch out for the github repository - fixes will be released immediately.  The peculiarity of the new version is that it remembers as much data as possible and tries to send less extra requests. <br><br>  The game itself was also updated, if previously the client was sent basically just html code, now separate objects have appeared, although sending another json object's object to the json field as a line is another move.  For example: <br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'backbone'</span></span>, <span class="hljs-string"><span class="hljs-string">'param_id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">13980</span></span>, <span class="hljs-string"><span class="hljs-string">'subject'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Units'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">4414096</span></span>, <span class="hljs-string"><span class="hljs-string">'param_str'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'{"Units":{"id":13980,"home_town_id":5391,"current_town_id":5391,"sword":23,"slinger":21,"archer":5,"hoplite":10,"rider":0,"chariot":0,"catapult":0,"minotaur":0,"manticore":0,"zyklop":0,"harpy":0,"medusa":0,"centaur":0,"pegasus":0,"cerberus":0,"fury":0,"griffin":0,"calydonian_boar":0,"godsent":34,"big_transporter":0,"bireme":0,"attack_ship":0,"demolition_ship":0,"small_transporter":0,"trireme":0,"colonize_ship":0,"sea_monster":0,"militia":0,"heroes":null,"home_town_link":"&lt;a href=\\"#eyJpZCI6NTM5MSwiaXgiOjUxMSwiaXkiOjYyMywidHAiOiJ0b3duIiwibmFtZSI6IlBlcmwifQ==\\" class=\\"gp_town_link\\"&gt;Perl&lt;\\/a&gt;","same_island":true,"current_town_link":"&lt;a href=\\"#eyJpZCI6NTM5MSwiaXgiOjUxMSwiaXkiOjYyMywidHAiOiJ0b3duIiwibmFtZSI6IlBlcmwifQ==\\" class=\\"gp_town_link\\"&gt;Perl&lt;\\/a&gt;","current_player_link":"&lt;a href=\\"#eyJuYW1lIjoiUGluZ3ZlaW4iLCJpZCI6e319\\" class=\\"gp_player_link\\"&gt;Pingvein&lt;\\/a&gt;"}}'</span></span>, <span class="hljs-string"><span class="hljs-string">'time'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1383837485</span></span> }</code> </pre> <br>  I created the install_libraries.sh file for those who have debian / ubuntu to resolve all dependencies.  Others are encouraged to use cpan or the repositories of their distribution.  All my code is single-threaded, because it will be strange if the bot simultaneously sends 2 requests.  And the flow is managed by ‚ÄúIO :: Async :: Loop‚Äù.  Async.pm: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> GrepolisBotModules::Async; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Log; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> IO::Async::Timer::Countdown; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> IO::Async::Loop; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $loop = IO::Async::Loop-&gt;new; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span>($delay, $callback) = @_; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Start delay $delay \n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $timer = IO::Async::Timer::Countdown-&gt;new( <span class="hljs-string"><span class="hljs-string">delay =&gt;</span></span> $delay, <span class="hljs-string"><span class="hljs-string">on_expire =&gt;</span></span> $callback, ); $timer-&gt;start; $loop-&gt;add( $timer ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span></span>{ $loop-&gt;later(<span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>); $loop-&gt;run; } <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  In this module, event initiators are simply added to the main loop.  I have everything on a timer, but the code that initializes the application is given in the "run" method.  Please note that I try to calculate the time of the timer on the basis of the rand function, so as not to burn.  The main file is grepolis_bot.pl: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use warnings; use Config::IniFiles; use GrepolisBotModules::Request; use GrepolisBotModules::Town; use GrepolisBotModules::Async; use GrepolisBotModules::Log; use utf8; my $cfg = Config::IniFiles-&gt;new( -file =&gt; "config.ini" ); my $config = { security =&gt; { sid =&gt; $cfg-&gt;val( 'security', 'sid' ), server =&gt; $cfg-&gt;val( 'security', 'server' ) }, global =&gt; { log =&gt; $cfg-&gt;val( 'global', 'log' ), } }; undef $cfg; my $Towns = []; GrepolisBotModules::Async::run sub{ GrepolisBotModules::Request::init($config-&gt;{'security'}); GrepolisBotModules::Log::init($config-&gt;{'global'}); GrepolisBotModules::Log::echo(0, "Program started\n"); my $game = GrepolisBotModules::Request::base_request('http://'.$config-&gt;{'security'}-&gt;{'server'}.'.grepolis.com/game'); $game =~ /"csrfToken":"([^"]+)",/; GrepolisBotModules::Request::setH($1); $game =~ /"townId":(\d+),/; GrepolisBotModules::Log::echo 1, "Town $1 added\n"; push($Towns, new GrepolisBotModules::Town($1)); };</span></span></code> </pre><br>  We read the config, set the csrfToken for subsequent requests, and the current city.  Support for several cities will appear as soon as I capture a new city.  I promise to do it as quickly as I can. <br><br>  The module for the city, Town.pm: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> GrepolisBotModules::Town; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> strict; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> warnings; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Request; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Farm; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Log; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> JSON; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $get_town_data = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span>( $self ) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $resp = JSON-&gt;new-&gt;allow_nonref-&gt;decode( GrepolisBotModules::Request::request( <span class="hljs-string"><span class="hljs-string">'town_info'</span></span>, <span class="hljs-string"><span class="hljs-string">'go_to_town'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) ); $self-&gt;{<span class="hljs-string"><span class="hljs-string">'max_storage'</span></span>} = $resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'max_storage'</span></span>}; $resp = JSON-&gt;new-&gt;allow_nonref-&gt;decode( GrepolisBotModules::Request::request( <span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-string"><span class="hljs-string">'get'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}, <span class="hljs-string"><span class="hljs-string">'{"types":[{"type":"backbone"},{"type":"map","param":{"x":0,"y":0}}]}'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ) ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $arg (@{$resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'backbone'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'collections'</span></span>}}) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'model_class_name'</span></span>} &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'model_class_name'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'Town'</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $town = <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span>($arg-&gt;{<span class="hljs-string"><span class="hljs-string">'data'</span></span>}); $self-&gt;setResources($town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_iron'</span></span>}, $town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_stone'</span></span>}, $town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_wood'</span></span>}); } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $data (@{$resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'map'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'data'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'data'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'data'</span></span>}} ) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $key (<span class="hljs-keyword"><span class="hljs-keyword">keys</span></span> %{$data-&gt;{<span class="hljs-string"><span class="hljs-string">'towns'</span></span>}}) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $data-&gt;{<span class="hljs-string"><span class="hljs-string">'towns'</span></span>}-&gt;{$key}-&gt;{<span class="hljs-string"><span class="hljs-string">'relation_status'</span></span>} &amp;&amp; $data-&gt;{<span class="hljs-string"><span class="hljs-string">'towns'</span></span>}-&gt;{$key}-&gt;{<span class="hljs-string"><span class="hljs-string">'relation_status'</span></span>} == <span class="hljs-number"><span class="hljs-number">1</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $village = new GrepolisBotModules::Farm($data-&gt;{<span class="hljs-string"><span class="hljs-string">'towns'</span></span>}-&gt;{$key}-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}, $self); <span class="hljs-keyword"><span class="hljs-keyword">push</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'villages'</span></span>}, $village); } } } }; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $build_something; $build_something = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Build request "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $response_body = GrepolisBotModules::Request::request(<span class="hljs-string"><span class="hljs-string">'building_main'</span></span>, <span class="hljs-string"><span class="hljs-string">'index'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}, <span class="hljs-string"><span class="hljs-string">'{"town_id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">'"}'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); $response_body =~ <span class="hljs-regexp"><span class="hljs-regexp">m/({.*})/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> %hash = ( JSON-&gt;new-&gt;allow_nonref-&gt;decode( $1 )-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'html'</span></span>} =~ <span class="hljs-regexp"><span class="hljs-regexp">/BuildingMain.buildBuilding\('([^']+)',\s(\d+)\)/g</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $to_build = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'main'</span></span>} &amp;&amp; $hash{<span class="hljs-string"><span class="hljs-string">'main'</span></span>}&lt;<span class="hljs-number"><span class="hljs-number">25</span></span>){ $to_build = <span class="hljs-string"><span class="hljs-string">'main'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'academy'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'academy'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'farm'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'farm'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'barracks'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'barracks'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'storage'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'storage'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'docks'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'docks'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'stoner'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'stoner'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'lumber'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'lumber'</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $hash{<span class="hljs-string"><span class="hljs-string">'ironer'</span></span>}){ $to_build = <span class="hljs-string"><span class="hljs-string">'ironer'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($to_build <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $response_body = GrepolisBotModules::Request::request( <span class="hljs-string"><span class="hljs-string">'building_main'</span></span>, <span class="hljs-string"><span class="hljs-string">'build'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}, <span class="hljs-string"><span class="hljs-string">'{"building":"'</span></span>.$to_build.<span class="hljs-string"><span class="hljs-string">'","level":5,"wnd_main":{"typeinforefid":0,"type":9},"wnd_index":0,"town_id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">'"}'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $time_wait = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $json = JSON-&gt;new-&gt;allow_nonref-&gt;decode($response_body); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $arg (@{$json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}}) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'backbone'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'BuildingOrder'</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $order = JSON-&gt;new-&gt;allow_nonref-&gt;decode($arg-&gt;{<span class="hljs-string"><span class="hljs-string">'param_str'</span></span>})-&gt;{<span class="hljs-string"><span class="hljs-string">'BuildingOrder'</span></span>}; $time_wait = $order-&gt;{<span class="hljs-string"><span class="hljs-string">'to_be_completed_at'</span></span>} - $order-&gt;{<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>}; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $time_wait){ GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" build "</span></span>.$to_build.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; GrepolisBotModules::Async::delay( $time_wait + <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>)), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{$self-&gt;$build_something} ); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" can not build. Waiting\n"</span></span>; GrepolisBotModules::Async::delay( <span class="hljs-number"><span class="hljs-number">600</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>(<span class="hljs-number"><span class="hljs-number">300</span></span>)), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{$self-&gt;$build_something} ); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setResources</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $iron = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $stone = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $wood = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'iron'</span></span>} = $iron; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'wood'</span></span>} = $wood; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'stone'</span></span>} = $stone; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" resources updates iron-"</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'iron'</span></span>}.<span class="hljs-string"><span class="hljs-string">", stone-"</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'stone'</span></span>}.<span class="hljs-string"><span class="hljs-string">", wood-"</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'wood'</span></span>}.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">needResources</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $resources_by_request = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $self-&gt;{<span class="hljs-string"><span class="hljs-string">'iron'</span></span>} + $resources_by_request &lt; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'max_storage'</span></span>} || $self-&gt;{<span class="hljs-string"><span class="hljs-string">'wood'</span></span>} + $resources_by_request &lt; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'max_storage'</span></span>} || $self-&gt;{<span class="hljs-string"><span class="hljs-string">'stone'</span></span>} + $resources_by_request &lt; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'max_storage'</span></span>} ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toUpgradeResources</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">wood =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'iron'</span></span>}/<span class="hljs-number"><span class="hljs-number">5</span></span>), <span class="hljs-string"><span class="hljs-string">stone =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'wood'</span></span>}/<span class="hljs-number"><span class="hljs-number">5</span></span>), <span class="hljs-string"><span class="hljs-string">iron =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'stone'</span></span>}/<span class="hljs-number"><span class="hljs-number">5</span></span>), }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $class = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = { <span class="hljs-string"><span class="hljs-string">id =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>, <span class="hljs-string"><span class="hljs-string">villages =&gt;</span></span> [], <span class="hljs-string"><span class="hljs-string">max_storage =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-string"><span class="hljs-string">iron =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-string"><span class="hljs-string">wood =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-string"><span class="hljs-string">stone =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">bless</span></span> $self, $class; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" init started\n"</span></span>; $self-&gt;$get_town_data; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" data gettings finished\n"</span></span>; $self-&gt;$build_something; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Town "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" build started\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $self; } <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  During initialization, he reads out the resources he has, searches for farms from which tribute can demand, and the volume of the warehouse.  Also pay attention to the procedure "build_something".  I didn‚Äôt really think about any special construction strategy, so you can change the priority of construction as you see fit.  Module for "farms" (the so-called peasant settlements) Farm.pm: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> GrepolisBotModules::Farm; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Request; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> GrepolisBotModules::Log; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> JSON; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $get_farm_data = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $resp = JSON-&gt;new-&gt;allow_nonref-&gt;decode( GrepolisBotModules::Request::request( <span class="hljs-string"><span class="hljs-string">'farm_town_info'</span></span>, <span class="hljs-string"><span class="hljs-string">'claim_info'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId, <span class="hljs-string"><span class="hljs-string">'{"id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">'"}'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) ); $self-&gt;{<span class="hljs-string"><span class="hljs-string">'name'</span></span>} = $resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'farm_town_name'</span></span>}; $resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'html'</span></span>} =~ <span class="hljs-regexp"><span class="hljs-regexp">/&lt;h4&gt;You\sreceive:\s\d+\sresources&lt;\/h4&gt;&lt;ul&gt;&lt;li&gt;(\d+)\swood&lt;\/li&gt;&lt;li&gt;\d+\srock&lt;\/li&gt;&lt;li&gt;\d+\ssilver\scoins&lt;\/li&gt;&lt;\/ul&gt;/</span></span>; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'resources_by_request'</span></span>} = $1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($resp-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}-&gt;{<span class="hljs-string"><span class="hljs-string">'html'</span></span>} =~ <span class="hljs-regexp"><span class="hljs-regexp">/&lt;h4&gt;Upgrade\slevel\s\((\d)\/6\)&lt;\/h4&gt;/</span></span> ){ $self-&gt;{<span class="hljs-string"><span class="hljs-string">'level'</span></span>} = $1; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Level not found'</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $upgrade = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $donate = $self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;toUpgradeResources(); $json = <span class="hljs-string"><span class="hljs-string">'{"target_id":'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">',"wood":'</span></span>.$donate-&gt;{<span class="hljs-string"><span class="hljs-string">'wood'</span></span>}.<span class="hljs-string"><span class="hljs-string">',"stone":'</span></span>.$donate-&gt;{<span class="hljs-string"><span class="hljs-string">'stone'</span></span>}.<span class="hljs-string"><span class="hljs-string">',"iron":'</span></span>.$donate-&gt;{<span class="hljs-string"><span class="hljs-string">'iron'</span></span>}.<span class="hljs-string"><span class="hljs-string">',"town_id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId().<span class="hljs-string"><span class="hljs-string">'"}'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $response_body = GrepolisBotModules::Request::request(<span class="hljs-string"><span class="hljs-string">'farm_town_info'</span></span>, <span class="hljs-string"><span class="hljs-string">'send_resources'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId(), $json, <span class="hljs-number"><span class="hljs-number">1</span></span>); GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Village send request. Town ID "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId().<span class="hljs-string"><span class="hljs-string">" Village ID "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; $self-&gt;$get_farm_data; }; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $claim = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; $json = <span class="hljs-string"><span class="hljs-string">'{"target_id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">'","claim_type":"normal","time":300,"town_id":"'</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId.<span class="hljs-string"><span class="hljs-string">'"}'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $response_body = GrepolisBotModules::Request::request(<span class="hljs-string"><span class="hljs-string">'farm_town_info'</span></span>, <span class="hljs-string"><span class="hljs-string">'claim_load'</span></span>, $self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;getId, $json, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $json = JSON-&gt;new-&gt;allow_nonref-&gt;decode($response_body)-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $arg (@{$json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}}) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'backbone'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'Town'</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $town = JSON-&gt;new-&gt;allow_nonref-&gt;decode($arg-&gt;{<span class="hljs-string"><span class="hljs-string">'param_str'</span></span>})-&gt;{<span class="hljs-string"><span class="hljs-string">'Town'</span></span>}; $self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;setResources($town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_iron'</span></span>}, $town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_stone'</span></span>}, $town-&gt;{<span class="hljs-string"><span class="hljs-string">'last_wood'</span></span>}); } } } GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Farm "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" claim finished\n"</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $needUpgrade = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'level'</span></span>} &lt; <span class="hljs-number"><span class="hljs-number">6</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> true; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> false; } }; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $tick; $tick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($self-&gt;{<span class="hljs-string"><span class="hljs-string">'town'</span></span>}-&gt;needResources($self-&gt;{<span class="hljs-string"><span class="hljs-string">'resources_by_request'</span></span>})){ $self-&gt;$claim(); GrepolisBotModules::Async::delay( <span class="hljs-number"><span class="hljs-number">360</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>(<span class="hljs-number"><span class="hljs-number">240</span></span>)), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ $self-&gt;$tick} ); }<span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span>($self-&gt;$needUpgrade()){ $self-&gt;$upgrade(); GrepolisBotModules::Async::delay( <span class="hljs-number"><span class="hljs-number">600</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>(<span class="hljs-number"><span class="hljs-number">240</span></span>)), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ $self-&gt;$tick} ); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $class = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = { <span class="hljs-string"><span class="hljs-string">id =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>, <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-string"><span class="hljs-string">resources_by_request =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>, <span class="hljs-string"><span class="hljs-string">town =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>, <span class="hljs-string"><span class="hljs-string">level =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span> }; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Farm "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" init started\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bless</span></span> $self, $class; $self-&gt;$get_farm_data; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Farm "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" data gettings finished\n"</span></span>; $self-&gt;$tick; GrepolisBotModules::Log::echo <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Farm "</span></span>.$self-&gt;{<span class="hljs-string"><span class="hljs-string">'id'</span></span>}.<span class="hljs-string"><span class="hljs-string">" ticker started\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $self; } <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  The farm, when initialized, reads its level and the amount of resources given every 5 minutes.  To save on requests, I check if the city really needs these resources, if not, I check if the current settlement can be improved so that it gives more resources at a time.  After resources are requested from the settlement, I check the notifications, and on the basis of them I set the resource values ‚Äã‚Äãto the city in order not to send individual requests for this.  After each improvement, information about the settlement is updated.  I will also write about one fragment from the module, which is responsible for sending requests to the server, Request.pm: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($response_body =~ <span class="hljs-regexp"><span class="hljs-regexp">/^{/</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $json = JSON-&gt;new-&gt;allow_nonref-&gt;decode( $response_body )-&gt;{<span class="hljs-string"><span class="hljs-string">'json'</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $arg (@{$json-&gt;{<span class="hljs-string"><span class="hljs-string">'notifications'</span></span>}}) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'building_finished'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'newreport'</span></span> &amp;&amp; ( $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'backbone'</span></span> || $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'type'</span></span>} eq <span class="hljs-string"><span class="hljs-string">'backbone'</span></span> &amp;&amp; ( !(<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>}) || ( $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'BuildingOrder'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'Town'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'PlayerRanking'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'Buildings'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'IslandQuest'</span></span> &amp;&amp; $arg-&gt;{<span class="hljs-string"><span class="hljs-string">'subject'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'TutorialQuest'</span></span> ) ) ) ) ){ GrepolisBotModules::Log::<span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, $arg; } } } }</code> </pre><br>  I check the notifications to highlight one that interests me.  Namely, a request to introduce a captcha.  Actually, I plan to read requests before the need arises to enter a captcha to limit bot activity.  A "night mode" is also planned - so that the bot does not send requests at night.  Although, if the warehouses are full and the construction line is full of long tasks, requests will not be sent anyway. <br><br>  In the game, the first city is universal, but then it is necessary to divide into cities that there are a naval attacking army, a naval defensive and a land attacking / defensive.  Depending on the type of city, it is used to build various buildings, to save free population, and different scientific policies.  I will be glad to see the comments, whether it is worthwhile to implement the autobuilding of armies, buildings, auto research depending on the city or leave the bot as a simple auto collector.  I also wonder if the schedule sending function will be useful. <br><br>  I am pleased to answer in the comments about the features of the Grepolis server that I was able to detect. </div><p>Source: <a href="https://habr.com/ru/post/201272/">https://habr.com/ru/post/201272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201260/index.html">How to publish open data and why not all XML files are equally useful</a></li>
<li><a href="../201264/index.html">Do-it-yourself duplicator slide</a></li>
<li><a href="../201266/index.html">Registration of participants of the InfoTeKS Academy program 2013-2014 has opened</a></li>
<li><a href="../201268/index.html">SqliteDog - modern SQLite database manager</a></li>
<li><a href="../201270/index.html">Is LTE in our area?</a></li>
<li><a href="../201280/index.html">Software generation of PDF forms on ABAP or how to get rid of problems with SPOOL</a></li>
<li><a href="../201282/index.html">How to find a logistics partner or why you do not need to wait for a steam locomotive</a></li>
<li><a href="../201284/index.html">Manageability of complex networks - translation of the article Controllability of complex networks</a></li>
<li><a href="../201286/index.html">COLT released with TypeScript support</a></li>
<li><a href="../201292/index.html">Using COLT annotations in front-end development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>