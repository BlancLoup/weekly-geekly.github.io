<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We learn wordpress (and not only) to draw quickly Youtube players</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I remembered the site of one old programmer friend, who has one hip-hop in the site‚Äôs tape, 6 years ago he spat on the page loading speed: ‚Äúyes, yes, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We learn wordpress (and not only) to draw quickly Youtube players</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/webt/us/rm/ow/usrmowkg03gobdp7nh575a04qfm.gif" alt="youtube-speedload"><br><br>  I remembered the site of one old programmer friend, who has one hip-hop in the site‚Äôs tape, 6 years ago he spat on the page loading speed: ‚Äúyes, yes, yes, we must redo it, but there‚Äôs nothing complicated there ...‚Äù I came in now - everything is as before :-) Despite the simple technical solutions, I admit that not only do I have such a friend.  Therefore this little technical note. <br><br>  To understand what problem we are talking about: <br><img src="https://habrastorage.org/webt/fa/zo/ua/fazouap0ncvp7umicdrwjzf5zpi.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>400kb script base.js?</b> <br><br>  The rest do not even look. <br>  After optimization, even without compression, the gain will be dozens of times and will be: <br><a name="habracut"></a><br>  html - 0.5 kb <br>  css - 1.4 kb <br>  js - 0.2 kb <br><br>  I myself often had to publish lectures from our YouTube channel in the site ribbon, they were heated up a lot on one page.  Yes, and when viewing personal blogs there are collections of others or their videos.  And what made me nervous is how youtube puts on performance when embedding.  What is there just is not loaded through the iframe for the sake of the same image with a click.  And the funny thing is, I just may not want to watch the video, what for me to load the content? <br><br>  This problem has long been solved a long time ago in social networks and many other resources with high attendance.  Yes, and in mobile browsers.  It's no secret that the user spends more time on the site if he receives content as quickly as possible. <br><br>  Here is the same Habr, it does not come across so much in the video tape, so this is not so popular.  However, if you popularize this approach? <br><br>  Let's try to implement this with the example of a WordPress plugin. <br><br>  As a holder of a couple of sites on wordpress, I know perfectly well how plugin authors can shit into the database.  Therefore, I have definitely decided that the plugin will use the native caching mechanism and will not require anything and break compatibility if it is deleted. <br><br><h3>  What can you get out of Youtube </h3><br>  Youtube for embedding content uses oembed.  More on my answer to SO about what can be pulled out without referring to the official API. <br><br>  <a href="https://stackoverflow.com/questions/10066638/get-youtube-information-via-json-for-single-video-not-feed-in-javascript/23253789">stackoverflow.com/questions/10066638/get-youtube-information-via-json-for-single-video-not-feed-in-javascript/23253789#23253789</a> <br><br>  JSON response <br>  <a href="http">www.youtube.com/oembed?url=http</a> : //www.youtube.com/watch? v = ojCkgU5XGdg &amp; format = json <br><br>  Or xml <br>  <a href="http">www.youtube.com/oembed?url=http</a> : //www.youtube.com/watch? v = ojCkgU5XGdg &amp; format = xml <br><br>  Types of thumbnails of different sizes hq, sd, maxres <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/hqdefault.jpg</a> <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/sddefault.jpg</a> <br>  <a href="">i.ytimg.com/vi/ojCkgU5XGdg/maxresdefault.jpg</a> <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/0.jpg</a> <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/1.jpg</a> <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/2.jpg</a> <br>  <a href="">img.youtube.com/vi/ojCkgU5XGdg/3.jpg</a> <br><br>  Video annotations <br>  <a href="http://www.youtube.com/annotations_invideo%3Fcap_hist%3D1%26video_id%3DojCkgU5XGdg">www.youtube.com/annotations_invideo?cap_hist=1&amp;video_id=ojCkgU5XGdg</a> <br><br>  Another link <br>  <a href="http://www.youtube.com/get_video_info%3Fhtml5%3D1%26video_id%3DojCkgU5XGdg">www.youtube.com/get_video_info?html5=1&amp;video_id=ojCkgU5XGdg</a> <br><br>  And this will come in handy if you make streams. <br>  <a href="https://www.youtube.com/embed/live_stream%3Fchannel%3DUCkA21M22vGK9GtAvq3DvSlA">www.youtube.com/embed/live_stream?channel=UCkA21M22vGK9GtAvq3DvSlA</a> <br><br>  Preview live broadcasts <br>  <a href="">i.ytimg.com/vi/W-fSCPrYSL8/hqdefault_live.jpg</a> <br><br>  It is a pity that YT does not support jsonp.  Therefore, we will not be able to completely refuse to save data. <br><br><h3>  How WordPress Caches oembed </h3><br>  WordPress supports auto-alignment when finding links in the editor from the white list.  When this event is triggered, it creates a meta-field for the post with the _oembed_ prefix, and when output, it replaces the code from the cache with html. <br><br>  If we decided to show the layout with the iframe substitution on click, then we need to store this state somewhere, best of all in the same cache. <br><br>  Filter <code>add_filter('embed_oembed_html');</code>  Allows you to change the cache before displaying the post.  He is the well-known iframe. <br><br><pre> <code class="php hljs">&lt;iframe width=<span class="hljs-string"><span class="hljs-string">""</span></span> height=<span class="hljs-string"><span class="hljs-string">""</span></span> src=<span class="hljs-string"><span class="hljs-string">""</span></span>&gt;&lt;/iframe&gt;</code> </pre> <br><br>  Since we still understand why Google does not generate a title for its iframe ( <a href="https://core.trac.wordpress.org/ticket/40245">ticket # 4024</a> ), we, alas, are forced to make a one-time request to the server to capture the title in the cache. <br><br><h3>  How to update the cache with your data </h3><br><pre> <code class="php hljs">add_filter(<span class="hljs-string"><span class="hljs-string">'embed_oembed_html'</span></span>, <span class="hljs-string"><span class="hljs-string">'ytsl_oembed_html'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); ytsl_oembed_html($cache, $url, $attr){};</code> </pre> <br><br>  When the filter is triggered, I‚Äôm looking for the presence of my data-ytsl tag in the $ cache variable.  If not, then I make a request for <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span>://<span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.youtube</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span>/<span class="hljs-selector-tag"><span class="hljs-selector-tag">oembed</span></span>?<span class="hljs-selector-tag"><span class="hljs-selector-tag">url</span></span>=<span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span>://<span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.youtube</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span>/<span class="hljs-selector-tag"><span class="hljs-selector-tag">watch</span></span>?<span class="hljs-selector-tag"><span class="hljs-selector-tag">v</span></span>=<span class="hljs-selector-tag"><span class="hljs-selector-tag">ojCkgU5XGdg</span></span>&amp;<span class="hljs-selector-tag"><span class="hljs-selector-tag">format</span></span>=<span class="hljs-selector-tag"><span class="hljs-selector-tag">json</span></span></code> </pre> <br><br>  and form the content of the new tag.  As a result, the cache looks like this: <br><br><pre> <code class="php hljs">&lt;iframe width=<span class="hljs-string"><span class="hljs-string">""</span></span> height=<span class="hljs-string"><span class="hljs-string">""</span></span> src=<span class="hljs-string"><span class="hljs-string">" "</span></span> data-ytsl=<span class="hljs-string"><span class="hljs-string">" "</span></span>&gt;&lt;/iframe&gt;</code> </pre> <br><br>  Updating the cache is done like this.  First, consider the key <br><pre> <code class="php hljs">$cachekey = <span class="hljs-string"><span class="hljs-string">'_oembed_'</span></span> . md5( $url . serialize( $attr ) );</code> </pre> <br>  And then update. <br><pre> <code class="php hljs">update_post_meta( get_the_ID(), $cachekey, $cache );</code> </pre> <br><br>  If my <b>data-ytsl tag is</b> found, I pull out the title and id from it and form the html. <br>  In the <b>data-iframe,</b> I insert the already clean cache code without my tag, in order to replace the content by this click with a click. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ytsl-click_div'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-iframe</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'$ytsl'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'$fixed position:relative;background: url($thumb_url) no-repeat scroll center center / cover'</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ytsl-title_grad'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ytsl-title_text'</span></span></span><span class="hljs-tag">&gt;</span></span>{$json['title']}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ytsl-play_b'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>"</code> </pre> <br>  Css on the githaba, there is no show washed it. <br><br>  As a result, the player looks like this. <br><img src="https://habrastorage.org/webt/51/38/jg/5138jg1grzueotu0f5jyy5vivfy.png"><br><br>  As a difference, I made a play button of a different color.  But the fact that the title was written by Arial, and not a custom font, which is also loaded via the iframe, in my opinion, does not affect how much recognition. <br><br>  The final ‚Äúon-the-fly‚Äù processing solution is very fast, and judging by the plug-in, the P3 goDaddy profiler is completely painless.  Therefore, we managed to find a balance between convenience and speed.  The plugin does not require any action from the user.  It simply shows pictures instead of an iframe when turned on. <br><br>  <b>On the front end.</b> <br><br>  Just connect the script.  All the ugly elementary: <br><br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> f = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">".ytsl-click_div"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; f.length; ++i) { f[i].onclick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parentElement.innerHTML = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getAttribute(<span class="hljs-string"><span class="hljs-string">"data-iframe"</span></span>); } } })();</code> </pre><br><br>  Cons - on mobile devices, browsers are very smart, and know how to do it yourself.  Therefore, if you do not define mobile devices, you will have to make two clicks to play. <br><br>  Total: <br>  html - 0.5 kb <br>  css - 1.4 kb <br>  js - 0.2 kb <br>  font - 0 kb <br>  img - 50 kb (depends on the background image) <br><br>  The remaining cons did not notice for a fairly large period of time. <br><br>  Well, the cat drew a load for a not so long, and not so technically interesting story. <br><br>  The code is here <a href="https://github.com/Alexufo/youtube-speedload">github.com/Alexufo/youtube-speedload</a> </div><p>Source: <a href="https://habr.com/ru/post/417039/">https://habr.com/ru/post/417039/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417029/index.html">Code profiling with LLVM</a></li>
<li><a href="../417031/index.html">Mobile OAuth 2.0 Security</a></li>
<li><a href="../417033/index.html">QIWI Kitchen from June 7th - videos of our speakers</a></li>
<li><a href="../417035/index.html">UnnyWorld: postmortem</a></li>
<li><a href="../417037/index.html">BEERBRAZZERS. Control the light. Vixen Lights 3. Quick Start (1/4)</a></li>
<li><a href="../417041/index.html">eslint-scope v3.7.2 steals NPM tokens</a></li>
<li><a href="../417043/index.html">Fable about Burger King and user data. Developer Comments</a></li>
<li><a href="../417045/index.html">Clinical trials of the first anti-aging therapy</a></li>
<li><a href="../417047/index.html">Python Creator: I'm tired, I'm leaving</a></li>
<li><a href="../417049/index.html">In the Russian Federation, a preliminary standard for mobile applications with 87 requirements for their functionality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>