<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Investigating the obfuscation of the Linksys WRT120N firmware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, my attention was drawn to the fact that in firmware updates for Linksys WRT120N they use some kind of obfuscation. It seemed to me that it w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Investigating the obfuscation of the Linksys WRT120N firmware</h1><div class="post__text post__text-html js-mediator-article">  Recently, my attention was drawn to the fact that in firmware updates for Linksys WRT120N they use some kind of obfuscation.  It seemed to me that it would be interesting to rummage in it, and I decided to take a look. <br><br>  <a href="">The latest firmware version</a> does not look like firmware, with which you can immediately work <br><img src="https://habrastorage.org/getpro/habr/post_images/1a8/8fa/807/1a88fa807b2b76eaa786a8cb599e37b1.png" alt="image"><br><br>  As you can see, there is a small data block compressed with LZMA - these are just HTML files for the web interface of the router.  Most of the firmware consists of some strange, random data.  Since  I couldn‚Äôt do anything with it anymore, and curiosity tried to overpower me more and more, I bought this model of the router myself (how much they screwed Amazon Prime cost!). <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Iron analysis </h5><br>  At first glance, it became clear that the WRT120N runs on the Atheros AR7240 SoC, it has 2MB SPI flash, 32MB RAM and something similar to Serial and JTAG wiring: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ed0/dbe/d84/ed0dbed843b99ee7a25aa20278d2821b.jpg" alt="image"></a> <br><br>  In order to take a deeper look at the boot process, I decided to start with the serial port. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e1e/7bf/4ef/e1e7bf4ef4fb7cf0986b3db4589ab620.jpg" alt="image"></a> <br><br>  I have already <a href="http://www.devttys0.com/2012/11/reverse-engineering-serial-ports/">talked</a> about serial ports, so I will not focus on the methods for finding pins and speed in this article.  It was easy to find the findings of the port using a multimeter and visual inspection of the board: <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Pin</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì RX Pin <span class="hljs-number"><span class="hljs-number">3</span></span> ‚Äì TX Pin <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Äì Ground</code> </pre> <br>  The port operates at a speed of 115200 baud and provides interesting boot information: <br><pre> <code class="hljs vbscript">$ sudo miniterm.py /dev/ttyUSB0 <span class="hljs-number"><span class="hljs-number">115200</span></span> --- Miniterm <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> /dev/ttyUSB0: <span class="hljs-number"><span class="hljs-number">115200</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,N,<span class="hljs-number"><span class="hljs-number">1</span></span> --- --- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H --- ======================================================================= Wireless Router WG7005G11-LF<span class="hljs-number"><span class="hljs-number">-88</span></span> Loader v0<span class="hljs-number"><span class="hljs-number">.03</span></span> build Feb <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">2009</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> Arcadyan Technology Corporation ======================================================================= flash MX25L1605D found. Copying boot params.....DONE Press <span class="hljs-built_in"><span class="hljs-built_in">Space</span></span> Bar <span class="hljs-number"><span class="hljs-number">3</span></span> times <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> enter command mode ... Flash Checking Passed. Unzipping firmware at <span class="hljs-number"><span class="hljs-number">0x80002000</span></span> ... [ZIP <span class="hljs-number"><span class="hljs-number">3</span></span>] [ZIP <span class="hljs-number"><span class="hljs-number">1</span></span>] done <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> c_entry() <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ... install_exception install exception handler ... install interrupt handler ... ulVal: <span class="hljs-number"><span class="hljs-number">0x484fb</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> GPIO #<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> OUTPUT <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> GPIO #<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> OUTPUT <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> GPIO #<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> OUTPUT <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> GPIO #<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> INPUT <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> GPIO #<span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> INPUT <span class="hljs-built_in"><span class="hljs-built_in">Timer</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> requested ##### _ftext = <span class="hljs-number"><span class="hljs-number">0x80002000</span></span> ##### _fdata = <span class="hljs-number"><span class="hljs-number">0x80447420</span></span> ##### __bss_start = <span class="hljs-number"><span class="hljs-number">0x804D5B04</span></span> ##### <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> = <span class="hljs-number"><span class="hljs-number">0x81869518</span></span> ##### Backup Data from <span class="hljs-number"><span class="hljs-number">0x80447420</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0x81871518</span></span>~<span class="hljs-number"><span class="hljs-number">0x818FFBFC</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> <span class="hljs-number"><span class="hljs-number">583396</span></span> ##### Backup Data completed ##### Backup Data verified [INIT] HardwareStartup .. [INIT] System <span class="hljs-built_in"><span class="hljs-built_in">Log</span></span> Pool startup ... [INIT] MTinitialize .. CPU Clock <span class="hljs-number"><span class="hljs-number">350000000</span></span> Hz init_US_counter : time1 = <span class="hljs-number"><span class="hljs-number">270713</span></span> , time2 = <span class="hljs-number"><span class="hljs-number">40272580</span></span>, diff <span class="hljs-number"><span class="hljs-number">40001867</span></span> US_counter = <span class="hljs-number"><span class="hljs-number">70</span></span> cnt1 <span class="hljs-number"><span class="hljs-number">41254774</span></span> cnt2 <span class="hljs-number"><span class="hljs-number">41256561</span></span>, diff <span class="hljs-number"><span class="hljs-number">1787</span></span> Runtime code version: v1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.04</span></span> System startup... [INIT] Memory COLOR <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1600000</span></span> bytes .. [INIT] Memory COLOR <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1048576</span></span> bytes .. [INIT] Memory COLOR <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2089200</span></span> bytes .. [INIT] tcpip_startup .. Data size: <span class="hljs-number"><span class="hljs-number">1248266</span></span> e89754967e337d9f35e8290e231c9f92 <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> flash memory layout <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Boot Parameters found !!! Bootcode version: v0<span class="hljs-number"><span class="hljs-number">.03</span></span> Serial number: JUT00L602233 Hardware version: <span class="hljs-number"><span class="hljs-number">01</span></span>A ...</code> </pre><br><br>  It seems that the firmware was made by <a href="http://www.arcadyan.com/home.aspx">Arcadyan</a> , the message ‚ÄúUnzipping firmware ...‚Äù was especially interesting, a quick google brought me to the <a href="http://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/">post</a> about the deobfuscation of Arcadyan firmware, but here, it seems, a slightly different method is used. <br><br>  Through the serial port you can only use the bootloader menu.  During the download, you can climb into it if you press the spacebar three times, and perform some actions, such as cleaning the flash and setting the board settings: <br><pre> <code class="hljs dos">Press Space Bar <span class="hljs-number"><span class="hljs-number">3</span></span> times to enter command <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> ...<span class="hljs-number"><span class="hljs-number">123</span></span> Yes, Enter command <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> ... [WG7005G11-LF-<span class="hljs-number"><span class="hljs-number">88</span></span> Boot]:? ====================== [U] Upload to Flash [E] <span class="hljs-built_in"><span class="hljs-built_in">Erase</span></span> Flash [G] Run Runtime Code [A] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> MAC Address [#] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> Serial Number [V] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> Board Version [H] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> Options [P] <span class="hljs-built_in"><span class="hljs-built_in">Print</span></span> Boot Params [I] Load ART From TFTP [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> SKU Number [<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> PIN Number ======================</code> </pre> <br><br>  Unfortunately, the bootloader did not allow dumping the contents of RAM or flash.  Although there is JTAG wiring on the board, I decided to dump the flash directly, because  The dump process through JTAG is usually not fast, and the SPI connection is very simple. <br><br>  Probably any device that supports the SPI protocol can read flash.  I used an <a href="http://www.digikey.com/product-detail/en/C232HM-DDHSL-0/768-1106-ND/2714139">FTDI C232HM</a> cable and spiflash.py from <a href="https://code.google.com/p/libmpsse/">libmpsse</a> <br><pre> <code class="hljs dos">$ sudo spiflash --read=flash.bin --size=$((<span class="hljs-number"><span class="hljs-number">0</span></span>x200000)) --<span class="hljs-built_in"><span class="hljs-built_in">verify</span></span> FT232H Future Technology Devices International, Ltd initialized <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> <span class="hljs-number"><span class="hljs-number">15000000</span></span> hertz Reading <span class="hljs-number"><span class="hljs-number">2097152</span></span> bytes starting <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> address <span class="hljs-number"><span class="hljs-number">0</span></span>x0...saved to flash.bin. Verifying...success.</code> </pre> <br>  A flash consists of three LZMA blocks and a small amount of MIPS code, but the firmware itself is still not good: <br><img src="https://habrastorage.org/getpro/habr/post_images/ac5/074/7d3/ac50747d3747975bf760c45e2d32dafa.png" alt="image"><br><br>  The first two LZMA blocks are part of the recovery image, and the MIPS code is the bootloader itself.  The rest of the space is taken by the obfuscated firmware file, except for zeros and some data at the end. <br><br><h5>  Bootloader analysis </h5><br>  The loader, besides the fact that it decrypts the firmware and downloads it to the address in memory, contains some interesting things.  I‚Äôll skip boring things, sort of like I‚Äôve looked for the boot loader address, manually determined the functions of the standard C library, found the offset table JUMPs, etc., and I‚Äôll go straight to the interesting. <br><br>  First, in the early boot phase, the bootloader checks if the reset button is pressed.  If it is clicked, it downloads the image ‚ÄúTiny_ETCPIP_Kernel‚Äù - a small recovery image, with a web interface. <br><img src="https://habrastorage.org/getpro/habr/post_images/42a/db9/df4/42adb9df4c97f08fdf3e48b74bf491b6.png" alt="image"><br><br>  It's a good news.  Now we know that if something goes wrong during the firmware update process, you can click reset and revive the device. <br>  And there is also a hidden administrator mode in the bootloader menu: <br><img src="https://habrastorage.org/getpro/habr/post_images/4f0/c31/aae/4f0c31aae28aecd2b668cbf9e6f53213.png" alt="image"><br><br>  Pressing "!"  will activate the administrator mode, which unlocks some options, including reading and writing to memory. <br><br><pre> <code class="hljs pgsql">[WG7005G11-LF<span class="hljs-number"><span class="hljs-number">-88</span></span> Boot]:! Enter Administrator Mode ! ====================== [U] Upload <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Flash [E] Erase Flash [G] Run Runtime Code [M] Upload <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Memory [R] <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Memory [W] <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Memory [Y] Go <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Memory [A] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> MAC Address [#] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> <span class="hljs-type"><span class="hljs-type">Serial</span></span> Number [V] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> Board <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span> [H] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> [P] Print Boot Params [I] <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> ART <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> TFTP [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> SKU Number [<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> PIN Number ====================== [WG7005G11-LF<span class="hljs-number"><span class="hljs-number">-88</span></span> Boot]:</code> </pre> <br>  The most interesting part of the bootloader, of course, is the one that loads the obfuscated firmware into memory. <br><br><h5>  Obfuscation analysis </h5><br><br>  Deobfuscation is performed in the load_os function, which is passed a pointer to the obfuscated image and the address where the unpacked image should be placed: <br><img src="https://habrastorage.org/getpro/habr/post_images/b01/b92/a44/b01b92a44d41fc04dc488aa266a0287f.png" alt="image"><br>  The unpacking itself is not particularly difficult: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5a4/547/d39/5a4547d39898ce6cb765887e757a79f5.png" alt="image"></a> <br><br>  In general, if the firmware starts from 04 01 09 20 (and ours begins with these bytes), then the decryption algorithm is executed, which: <br><ul><li>  Swaps two 32-byte data blocks at 0 √ó 04 and 0 √ó 68 addresses </li><li>  Swaps 4 bits in the first 32 bytes, starting at address 0 √ó 04 </li><li>  Byte-swaps adjacent 32 bytes, starting at 0 √ó 04 </li></ul><br>  After all this, the data at 0 √ó 04 contains the correct LZMA header, which is then decompressed. <br><br>  Implementing the deobfuscation utility was easy, and the WRT120N firmware can now be unpacked and released. <br><pre> <code class="hljs swift">$ ./wrt120n ./firmware/<span class="hljs-type"><span class="hljs-type">FW_WRT120N_1</span></span>.<span class="hljs-number"><span class="hljs-number">0.07</span></span>.002_US.bin ./deobfuscated.bin <span class="hljs-type"><span class="hljs-type">Doing</span></span> block <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>... <span class="hljs-type"><span class="hljs-type">Doing</span></span> nibble-<span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>... <span class="hljs-type"><span class="hljs-type">Doing</span></span> byte-<span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>... <span class="hljs-type"><span class="hljs-type">Saving</span></span> data to ./deobfuscated.bin... <span class="hljs-type"><span class="hljs-type">Done!</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/59f/39f/ba4/59f39fba4dc69aebaa916f6707a553c8.png" alt="image"><br>  <i>Analysis of unpacked, but not decompressed firmware</i> <br><br>  If anyone is interested, you can download the <a href="https://github.com/devttys0/wrt120n">utility for unpacking</a> . </div><p>Source: <a href="https://habr.com/ru/post/213191/">https://habr.com/ru/post/213191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213177/index.html">Video reports from the Loc Kit conference</a></li>
<li><a href="../213179/index.html">ORM in PHP to be or not to be?</a></li>
<li><a href="../213181/index.html">Experience in developing an intelligent tutorial interface</a></li>
<li><a href="../213183/index.html">Application of the Pareto chart to analyze the reasons for the backlog</a></li>
<li><a href="../213187/index.html">How to delete 1,500,000 entries from Yahoo database</a></li>
<li><a href="../213193/index.html">Very simple screen slider</a></li>
<li><a href="../213195/index.html">Fitbit for the brain: a cognitive activity tracker</a></li>
<li><a href="../213197/index.html">BigRep One: A New 3D Printer That Can Print Entire Furniture</a></li>
<li><a href="../213199/index.html">A little note on how to make friends with Heroku, Kraken.js and Sockjs</a></li>
<li><a href="../213201/index.html">Another money transfer protection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>