<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker implementation for a small project in Production, part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous parts we prepared the server for the use of containers: 

 ‚Üí Part 1. Installing CoreOS 
 ‚Üí Part 2. Basic configuration and security se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker implementation for a small project in Production, part 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/646/fef/ff2/646fefff2c8bc3779eb1b1c030e38ec8.jpg" alt="image"><br><br>  In the previous parts we prepared the server for the use of containers: <br><br>  ‚Üí <a href="https://habrahabr.ru/post/320316/">Part 1. Installing CoreOS</a> <br>  ‚Üí <a href="https://habrahabr.ru/post/320346/">Part 2. Basic configuration and security settings for SSH</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this part, we will learn how to work with containers and deploy the application stack in seconds.  But first, I would like to make a small digression on the comments and comments received. <a name="habracut"></a><br><br>  One of the important questions was, and how in CoreOS things are with Swap, I answer, things are fine and you are now convinced of this.  So let's get down to setting it up.  As always, for this we need to connect to the server via SSH and a text editor, by the way, I wanted to add earlier that I said that there is no vim editor in the system, I was wrong, it is there, so you can use vi and vim doesn't change it.  In order to enable the swap, we will not need to mark up the disk, for this it is enough to have an existing partition with ext4.  Swap will be started as a service, plus this method is that the swap can be disabled and enabled as a service, while adjusting the size of the swap through the service description file. <br><br>  So, on the command line, do the following: <br><br><pre><code class="bash hljs">sudo vi /etc/systemd/system/swap.service</code> </pre> <br>  In the contents of the file we add the following text: <br><br><pre> <code class="hljs ruby">[Unit] Description=Turn on swap partition [Service] Type=oneshot Environment=<span class="hljs-string"><span class="hljs-string">"SWAP_PATH=/var/vm"</span></span> <span class="hljs-string"><span class="hljs-string">"SWAP_FILE=swapfile1"</span></span> ExecStartPre=-<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/rm -rf ${SWAP_PATH} ExecStartPre=/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/mkdir</span></span> -p ${SWAP_PATH} ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/touch ${SWAP_PATH}/</span></span>${SWAP_FILE} ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/bin/bash</span></span> -c <span class="hljs-string"><span class="hljs-string">"fallocate -l 2048m ${SWAP_PATH}/${SWAP_FILE}"</span></span> ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/chmod 600 ${SWAP_PATH}/</span></span>${SWAP_FILE} ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/usr/sbin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mkswap ${SWAP_PATH}/</span></span>${SWAP_FILE} ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/usr/sbin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/sysctl vm.swappiness=10 ExecStart=/sbin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/swapon ${SWAP_PATH}/</span></span>${SWAP_FILE} ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/swapoff</span></span> ${SWAP_PATH}/${SWAP_FILE} ExecStopPost=-<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/rm -rf ${SWAP_PATH} RemainAfterExit=true [Install] WantedBy=multi-user.target</span></span></code> </pre> <br>  For convenience, the swap setting goes through the environment variables: <br><br><pre> <code class="hljs objectivec">Environment=<span class="hljs-string"><span class="hljs-string">"SWAP_PATH=/var/vm"</span></span> <span class="hljs-string"><span class="hljs-string">"SWAP_FILE=swap_part1"</span></span></code> </pre> <br>  Specify the path and file name, for further work, the following line: <br><br><pre> <code class="hljs perl">ExecStartPre=<span class="hljs-regexp"><span class="hljs-regexp">/bin/bash</span></span> -c <span class="hljs-string"><span class="hljs-string">"fallocate -l 2048m </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${SWAP_PATH}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${SWAP_FILE}</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br>  We say that the file size is 2048 megabytes, which is equal to 2 GB, I think this will be abundant in our system. <br><br>  This part of the file is actually responsible for enabling and disabling the file itself, I think additional explanations are not needed, everything is extremely readable and understandable. <br><br><pre> <code class="hljs ruby">ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/swapon</span></span> ${SWAP_PATH}/${SWAP_FILE} ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/swapoff</span></span> ${SWAP_PATH}/${SWAP_FILE}</code> </pre> <br>  After that, you need to save our file and leave the editor, now you need to start the service and activate swapping. <br><br>  To do this, as usual, use the console and enter the command: <br><br><pre> <code class="bash hljs">sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> --now /etc/systemd/system/swap.service</code> </pre> <br>  After execution, we will enable the swap, to see that it is active, a simple command will help us: <br><br><pre> <code class="bash hljs">free ‚Äìhm</code> </pre> <br>  Which will show us information about the memory in a clear form in megabytes.  As a result, we will see that the values ‚Äã‚Äãof the Swap partition will be acquired by the numbers that we set up, namely only 2GB, and the use depends on the load on the system, but since we have not loaded it, then there will be zeroes. <br><br>  Great, now it's time to prepare everything you need to deploy our site, since we have a WordPress site and we need a Web Server (Apache, Nginx), PHP, MySQL for it to work.  Personally, I will use the following bundle: PHP 7.1, Nginx 1.11.9, MariaDB 10.1.21.  Why this one?  Yes, because I like it so much.  I believe that this is the most productive combination in order to use WordPress, but in addition to this, we will probably add Varnish 5, and Memcached 1.4.34 in order for our blog to work even faster.  We begin with the simplest and move on to the more complex.  First we start memcache, for this we give the command to execute the command to the console as usual: <br><br><pre> <code class="bash hljs">docker run -d -p 11211:11211 --restart=always --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=syslog --name=memcached memcached</code> </pre> <br>  It's all quite simple, we tell the container to restart automatically, we output logs to syslog, and we give a distinct name.  By default, the settings are well balanced, and if I'm not mistaken there is allocated 64 megabytes of memory, for our blog this will be enough.  In order to use this feature in our WP, you need to deliver a plugin, I personally use WP Total Cache, how to set it up is a bunch of manuals, we will not stop there. <br><br>  Next, we will launch our database server, this is also a trivial task and does not require much time and settings, the command to start looks like this: <br><br><pre> <code class="bash hljs">docker run -d -ti -p local_ip:3306:3306 --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=syslog -v /cloud/mysql:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=PASSWORD --restart=always --name=mariadb mariadb</code> </pre> <br>  I'll tell you about what options we set at startup, so local_ip: 3306: 3306 here you need to specify what IP address our server will have access to, if you have a private private cloud, specify the address assigned to the map that looks in the cloud's local network if you just have a dedicated virtual host then specify 127.0.0.1, you don‚Äôt need to publish the database server to an external IP in order to maintain security.  Thus, all software that uses database resources will be connected via our internal network address to our database.  Logs are sent as usual to syslog, but the -v / cloud / mysql parameter: / var / lib / mysql tells us that we need to forward a local folder to our container.  This is done to ensure that during the destruction of the container, our bases remain safe and sound.  Then in the container you need to pass an environment variable, MYSQL_ROOT_PASSWORD without it, our container will not start.  Here we set the root user password to our database, the more complicated the better.  Do not limit password length. <br><br>  Enter it rarely have to.  Further parameters known to us.  I just wanted to draw attention to the fact that I use the official images of these applications from the hub, without specifying the tag, that is, the latest version will always be taken by default.  But if you already have an image locally, then the version that is stored locally will be taken, so in order to be updated we can execute the following command: <br><br><pre> <code class="bash hljs">docker pull memcached mariadb</code> </pre> <br>  Then from the hub, the latest version of the image will be taken guaranteed.  For those who need time according to the time zone set by us at the installation stage, it makes sense to add the following option to the launch of each container: <br><br><pre> <code class="hljs pgsql">-v /etc/<span class="hljs-built_in"><span class="hljs-built_in">localtime</span></span>:/etc/<span class="hljs-built_in"><span class="hljs-built_in">localtime</span></span></code> </pre> <br>  She will forward a file to us in the container with the time zone setting.  Next, run our web server, for this we execute the command: <br><br><pre> <code class="bash hljs">docker run -d -p 80:80 -p 443:443 -p 81:81 -v /cloud/run/php-fpm:/sock -v /cloud/etc/nginx:/etc/nginx -v /cloud/etc/letsencrypt/:/etc/letsencrypt/ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=syslog -v /cloud/data/www/:/var/www/html --restart=always --name=nginx nginx</code> </pre> <br>  If you take a closer look, there are already a lot more parameters we pass to the container at launch.  Let's look at them in more detail.  To begin with, we will forward ports 80, 443 and 81 to our system, if everything is clear with the first two, then here 81 raises questions.  We will use this port for the Varnish backend, this will be further.  The scheme is quite simple, since Varnish doesn‚Äôt know how to work with SSL, first connect to port 80 on Nginx, make a redirect to port 443, since we‚Äôll use LetsEncrypt certificates, from port 443 we will redirect to Varnish, if it finds cache, the result of the request then returns it; if not, refer to the back-end on port 81 which serves Nginx again.  An example of the configuration files I post below.  In order for our php container to handle skrpity, we will forward a folder with a php-fpm socket to the web server container like this: -v / cloud / run / php-fpm: / sock.  Next, let's forward the -v / cloud / etc / nginx configuration: / etc / nginx, -v / cloud / etc / letsencrypt /: / etc / letsencrypt / certificates.  Just configure the log, and forward our directory with the sites -v / cloud / data / www /: / var / www / html.  This is where the launch of the container is complete, but in order for it to really start we need to prepare the configuration files.  An example of a file as promised here below. <br><br><div class="spoiler">  <b class="spoiler_title">Nginx.conf</b> <div class="spoiler_text"><pre> <code class="hljs apache"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> nginx; worker_processes 1; pid /var/run/nginx.pid; events { worker_connections 1024; use epoll; multi_accept <span class="hljs-literal"><span class="hljs-literal">on</span></span>; } http { server_tokens <span class="hljs-literal"><span class="hljs-literal">off</span></span>; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /dev/stdout; sendfile <span class="hljs-literal"><span class="hljs-literal">on</span></span>; sendfile_max_chunk 128k; keepalive_timeout 65; keepalive_requests 10; client_body_buffer_size 1K; client_header_buffer_size 2k; large_client_header_buffers 2 1k; client_max_body_size 32m; fastcgi_buffers 64 16K; fastcgi_buffer_size 64k; client_body_timeout 10; client_header_timeout 10; reset_timedout_connection <span class="hljs-literal"><span class="hljs-literal">on</span></span>; send_timeout 1; tcp_nopush <span class="hljs-literal"><span class="hljs-literal">on</span></span>; tcp_nodelay <span class="hljs-literal"><span class="hljs-literal">on</span></span>; open_file_cache max=200000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors <span class="hljs-literal"><span class="hljs-literal">on</span></span>; include /etc/nginx/sites-enabled/*.conf; } Site-0001.conf # frontend configuration section # listen based 80 http server { listen 80 default_server; server_name www.your_site.ru; location /.well-known { root /var/www/html; } return 301 https://$host$request_uri; } # listen based 80 http server { listen 80; server_name your_site.ru; location /.well-known { root /var/www/html; } return 301 https://$host$request_uri; } server { listen 443 ssl http2; server_name www.your_site.ru; location /.well-known { root /var/www/html; } ssl <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ssl_certificate /etc/letsencrypt/live/your_site.ru/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/your_site.ru/privkey.pem; ssl_trusted_certificate /etc/letsencrypt/live/your_site.ru/chain.pem; return 301 https://your_site.ru$request_uri; } server { listen 443 ssl http2 default_server; server_name your_site.ru; ssl <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ssl_stapling <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ssl_certificate /etc/letsencrypt/live/your_site.ru/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/your_site.ru/privkey.pem; ssl_trusted_certificate /etc/letsencrypt/live/your_site.ru/chain.pem; root /var/www/html/your_site.ru; rewrite /wp-admin$ $scheme://$host$uri/ permanent; keepalive_timeout 60 60; gzip <span class="hljs-literal"><span class="hljs-literal">on</span></span>; gzip_comp_level 1; gzip_min_length 512; gzip_buffers 8 64k; gzip_types text/plain; gzip_proxied any; ssl_prefer_server_ciphers <span class="hljs-literal"><span class="hljs-literal">on</span></span>; ssl_session_cache shared:ssl_session_cache:10m; ssl_session_timeout 2m; ssl_dhparam /etc/nginx/ssl/dh2048.pem; ssl_protocols TLSv1.2 TLSv1.1 TLSv1; ssl_ciphers EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA512:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:ECDH+AESGCM:ECDH+AES256:DH+AESGCM:DH+AES256:RSA+AESGCM:!aNULL:!eNULL:!LOW:!RC4:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS; add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains'; location / { location = /wp-login.php { auth_basic <span class="hljs-string"><span class="hljs-string">"Restricted"</span></span>; auth_basic_user_file /etc/nginx/.htpasswd/passwd; proxy_pass http://your_interal_ip:81; } location ~* /wp-admin/~^.*\$ { auth_basic <span class="hljs-string"><span class="hljs-string">"Authorization Required"</span></span>; auth_basic_user_file /etc/nginx/.htpasswd/passwd; proxy_pass http://your_interal_ip:81; } proxy_pass http://your_interal_ip:6081/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header X-Forwarded-Port 443; } } # end of frontend configuration section # backend configuration server { listen 81; root /var/www/html/your_site.ru; gzip <span class="hljs-literal"><span class="hljs-literal">on</span></span>; gzip_comp_level 7; gzip_min_length 512; gzip_buffers 8 64k; gzip_types text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml; gzip_proxied any; server_name your_site.ru; index index.html index.php; location / { if ($host !~ ^(your_site.ru)$ ) { return 444; } try_files $uri $uri/ /index.php?$args; error_page 404 /404.html; error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; proxy_set_header X-Real-IP $remote_addr; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } location ~ /\.ht { deny <span class="hljs-literal"><span class="hljs-literal">all</span></span>; } location ~* /(?:uploads|files)/.*\.php$ { deny <span class="hljs-literal"><span class="hljs-literal">all</span></span>; # deny for scripts } location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ { access_log <span class="hljs-literal"><span class="hljs-literal">off</span></span>; log_not_found <span class="hljs-literal"><span class="hljs-literal">off</span></span>; expires max; # cashe for static } location = /favicon.ico { log_not_found <span class="hljs-literal"><span class="hljs-literal">off</span></span>; access_log <span class="hljs-literal"><span class="hljs-literal">off</span></span>; } location = /robots.txt { allow <span class="hljs-literal"><span class="hljs-literal">all</span></span>; log_not_found <span class="hljs-literal"><span class="hljs-literal">off</span></span>; access_log <span class="hljs-literal"><span class="hljs-literal">off</span></span>; } location = /xmlrpc.php { deny <span class="hljs-literal"><span class="hljs-literal">all</span></span>; } #deny referer if ( $http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen) ) { return 403; } if ($http_user_agent ~* LWP::Simple|BBBike|wget) { return 403; } if ($http_user_agent ~* msnbot|scrapbot) { return 403; } } location ~<span class="hljs-meta"><span class="hljs-meta"> [^/]\.php(/|$) { fastcgi_split_path_info ^(.+?\.php)(/.*)$; if (!-f $document_root$fastcgi_script_name) { return 404; } include fastcgi_params; fastcgi_param HTTPS on; fastcgi_ignore_client_abort off; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_pass unix:/sock/php-fpm.sock; } }</span></span></code> </pre> <br></div></div><br>  I will not explain about the values ‚Äã‚Äãin the configs, there are articles on Habr√© on which I set up these services myself, if you like, you can easily find them. <br><br>  Now let's get down to the most interesting, this is the build of our PHP 7, the fact is that the base image does not include all the extensions we need, so we will build the image ourselves.  In order for you to earn almost any engines, with any topic, we need to create the following container by describing it with a Dockerfile: <br><br><pre> <code class="bash hljs">FROM php:7-fpm RUN apt-get update \ &amp;&amp; apt-get -y install \ libmagickwand-dev \ libmcrypt-dev \ libpng12-dev \ libjpeg62-turbo-dev \ libfreetype6-dev \ libmemcached-dev \ libicu-dev \ --no-install-recommends \ &amp;&amp; pecl install imagick \ &amp;&amp; docker-php-ext-enable imagick\ &amp;&amp; curl -L -o /tmp/memcached.tar.gz <span class="hljs-string"><span class="hljs-string">"https://github.com/php-memcached-dev/php-memcached/archive/php7.tar.gz"</span></span> \ &amp;&amp; mkdir -p /usr/src/php/ext/memcached \ &amp;&amp; tar -C /usr/src/php/ext/memcached -zxvf /tmp/memcached.tar.gz --strip 1 \ &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \ &amp;&amp; docker-php-ext-configure memcached \ &amp;&amp; docker-php-ext-install gd mcrypt mysqli pdo_mysql zip calendar opcache memcached exif intl sockets \ &amp;&amp; rm -rf /tmp/* /var/cache/apk/* /var/lib/apt/lists/* \</code> </pre> <br>  Since the base image is built on Debian Jessie, we will not violate this tradition, and we will build our own on its base, just add to it the extensions we need.  Next, the case will remain for the soap, set the config, and run the container. <br><br>  After assembling the container, you need to pull out the configuration files for editing, suppose we called the container local / php7 during the assembly.  Next, proceed to the configuration: <br><br><pre> <code class="bash hljs">docker create --name=php7 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/php7 docker cp php7:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc /cloud/etc/php-fpm</code> </pre> <br>  Everything, we copied the default configuration files to our directory, it remains to configure them a bit. <br><br><div class="spoiler">  <b class="spoiler_title">docker-php-custom-user.ini</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">default_charset = "UTF-8" file_uploads = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> max_file_uploads = <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-type"><span class="hljs-type">date</span></span>.timezone = "Europe/Moscow" cgi.fix_pathinfo=<span class="hljs-number"><span class="hljs-number">1</span></span> display_errors = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> log_errors = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> log_errors_max_len = <span class="hljs-number"><span class="hljs-number">1024</span></span> html_errors = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> register_globals = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> short_open_tag = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> safe_mode = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> output_buffering = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> zlib.output_compression = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> implicit_flush = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> allow_call_time_pass_reference = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> max_execution_time = <span class="hljs-number"><span class="hljs-number">30</span></span> max_input_time = <span class="hljs-number"><span class="hljs-number">60</span></span> max_input_vars = <span class="hljs-number"><span class="hljs-number">10000</span></span> variables_order = ‚ÄúEGPCS‚Äù register_argc_argv = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> magic_quotes_gpc = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> magic_quotes_runtime = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> magic_quotes_sybase = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.use_cookies = <span class="hljs-number"><span class="hljs-number">1</span></span> magic_quotes_gpc = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>; default_charset = UTF<span class="hljs-number"><span class="hljs-number">-8</span></span>; memory_limit = <span class="hljs-number"><span class="hljs-number">64</span></span>M; max_execution_time = <span class="hljs-number"><span class="hljs-number">36000</span></span>; upload_max_filesize = <span class="hljs-number"><span class="hljs-number">999</span></span>M; mysql.connect_timeout = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.auto_start = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.use_only_cookies = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.use_cookies = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.use_trans_sid = <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.cookie_httponly = <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.gc_maxlifetime = <span class="hljs-number"><span class="hljs-number">3600</span></span>; allow_url_fopen = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;</code> </pre> <br></div></div><br>  Further in the same folder we create files with the name of the add-on for php and the ini extension of the following content: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imagick</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span></span></code> </pre> <br>  This is for example the docker-php-ext-imagick.ini file. <br><br>  And so for everyone.  I will not give them all, I think the principle is clear.  For the particularly lazy, I laid it all out <a href="">here</a> . <br><br>  The most important setting is in the zz-docker.conf file. <br><br><pre> <code class="hljs pgsql">[<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>] daemonize = <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> [www] <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = /sock/php-fpm.sock</code> </pre> <br>  Do not forget to register it, otherwise php-fpm will not work through unix sockets.  If we leave it by default, then php-fpm will run on port 9000, and we will need to change our upstream in nginx from socket to tcp, this is for those who want to take php-fpm to a separate machine in the future.  As part of a virtual private cloud, it is not only easy but also safe. <br><br>  Everything is ready, now we start the container by typing the command in the console: <br><br><pre> <code class="bash hljs">docker run -d -v /cloud/run/php-fpm:/sock -v /cloud/etc/php-fpm/etc:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc -v /cloud/data/www:/var/www/html -v /cloud/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/php-fpm:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/php-fpm --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=syslog --restart=always --name=php7 visman/php7.1</code> </pre> <br>  I‚Äôm not going to describe the parameters of the container launch command, I‚Äôll just note that I have forwarded the -v / cloud / data / www: / var / www / html folder with the web server files to the container, I think you know for what. <br><br>  So let's summarize, we have Nginx ready to accept connections, there is PHP-FPM 7.1, which will process our php files, there is a database, and there are beginnings of caching in the form of memcached.  Now we need to configure Varnish.  But at first we will collect our image, as usual below I bring Dockerfile <br><br><pre> <code class="bash hljs">FROM debian:jessie RUN <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEBIAN_FRONTEND=noninteractive &amp;&amp; \ apt-get update -y -q &amp;&amp; \ apt-get install -y -q apt-transport-https curl &amp;&amp; \ rm -rf /var/lib/apt/lists/* RUN curl -k https://repo.varnish-cache.org/GPG-key.txt | apt-key add - &amp;&amp; \ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb https://repo.varnish-cache.org/debian/ jessie varnish-4.1"</span></span> | tee -a /etc/apt/sources.list.d/varnish-cache.list &amp;&amp; \ apt-get update -y -q &amp;&amp; \ apt-get install -y -q gcc libjemalloc1 libedit2 &amp;&amp; \ curl -O https://repo.varnish-cache.org/pkg/5.0.0/varnish_5.0.0-1_amd64.deb &amp;&amp; \ dpkg -i varnish_5.0.0-1_amd64.deb &amp;&amp;\ rm varnish_5.0.0-1_amd64.deb &amp;&amp; \ apt-get install -y -q varnish-agent &amp;&amp; \ rm -rf /var/lob/apt/lists/* ADD docker-entrypoint.sh /usr/bin/entrypoint.sh ADD varnish /etc/default/varnish RUN chmod +x /usr/bin/entrypoint.sh EXPOSE 6081 6082 6085 ENTRYPOINT [<span class="hljs-string"><span class="hljs-string">"/usr/bin/entrypoint.sh"</span></span>]</code> </pre> <br>  Please note, I put the latest 5th version not from repositories, but manually.  Since she came out not so long ago and did not have time to get into the turnips.  Moreover, I add Varnish Agent, unfortunately it is version 4.1, but this does not hurt us.  For what we will see later. <br><br>  entrypoint.sh <br><pre> <code class="hljs swift">#!/bin/bash <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> -e service varnish start varnish-agent -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">6085</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html/varnish-dashboard/ tailf /etc/varnish/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.vcl</code> </pre> <br>  The last line serves us to deduce our caching rules for Varnish, it is not necessary, but at the time of debugging it is convenient to see if it picks up the necessary rules or not. <br><br>  varnish <br><pre> <code class="hljs pgsql">RELOAD_VCL=<span class="hljs-number"><span class="hljs-number">1</span></span> START=yes # Maximum number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> files (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ulimit -n) NFILES=<span class="hljs-number"><span class="hljs-number">131072</span></span> # Maximum locked memory size (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ulimit -l) # Used <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> locking the shared memory <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> memory. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you increase <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> size, # you need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> increase this number <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> well MEMLOCK=<span class="hljs-number"><span class="hljs-number">82000</span></span> DAEMON_OPTS="-a :6081 \ -T :6082 \ -f /etc/varnish/default.vcl \ -S /etc/varnish/secret \ -s malloc,256m"</code> </pre> <br>  This is the settings file I allocate 256 MB for the cache, for me personally this is enough.  Next, we need to configure the Varnish Dashboard, as it is done, described <a href="https://github.com/brandonwamboldt/varnish-dashboard">here</a> .  I will not describe this process, but for whom I need to write in comments or drugs, I will definitely help.  For nginx, the configuration file will be as follows: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name varnish.your_site.ru; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https://$host$<span class="perl"><span class="perl">request_uri; </span><span class="hljs-keyword"><span class="perl"><span class="hljs-keyword">if</span></span></span><span class="perl"> ($scheme != </span><span class="hljs-string"><span class="perl"><span class="hljs-string">"https"</span></span></span><span class="perl">) { </span><span class="hljs-keyword"><span class="perl"><span class="hljs-keyword">return</span></span></span><span class="perl"> </span><span class="hljs-number"><span class="perl"><span class="hljs-number">301</span></span></span><span class="perl"> https:</span><span class="hljs-regexp"><span class="perl"><span class="hljs-regexp">//</span></span></span><span class="perl">$host$</span></span>request_uri; } # managed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Certbot } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; server_name varnish.your_site.ru; ssl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; ssl_certificate /etc/letsencrypt/live/varnish. your_site.ru/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/varnish. your_site.ru/privkey.pem; ssl_trusted_certificate /etc/letsencrypt/live/varnish. your_site.ru/chain.pem; <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> /.well-known { root /var/www/html; } <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { proxy_pass http://interal_ip:<span class="hljs-number"><span class="hljs-number">6085</span></span>; } }</code> </pre><br>  Now run the container. <br><br><pre> <code class="bash hljs">docker run -d -ti -p 6082:6082 -p 6081:6081 -p 6085:6085 -v /cloud/data/www/varnish-dashboard:/var/www/html/varnish-dashboard -v /cloud/etc/varnish:/etc/varnish -v /etc/localtime:/etc/localtime --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=syslog --name=varnish visman/d_varnish:5</code> </pre> <br>  For those who are too lazy to collect their image, the launch line already has my image collected earlier.  You only need to place the configs in their places.  I deliberately did not post the default.vcl file since everyone has his own, moreover there is a good <a href="https://habrahabr.ru/post/278189/">article</a> on how to configure Varnish.  That's actually we finished installing our soup kit to start a blog on WP. <br><br>  I deliberately missed the MariaDB configuration part, since the Internet is full of instructions on how to do this.  I do not use docker-compose due to the fact that it is not in the CoreOS distribution, but this is solved.  And the launch of single services seems to me more convenient.  Moreover, all the commands can be wrapped into one script, put in cloud-init, use Ansible .... <br><br>  Thank you for your attention, to be continued.  If I forgot anything, I apologize, since I am writing an article looking up from my work. </div><p>Source: <a href="https://habr.com/ru/post/320872/">https://habr.com/ru/post/320872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320862/index.html">Recommendations for the use of Hero Images (UPD)</a></li>
<li><a href="../320864/index.html">The book "Programming without fools"</a></li>
<li><a href="../320866/index.html">The logic of consciousness. Part 10. The task of generalization</a></li>
<li><a href="../320868/index.html">PR for a startup: which sites must write about your company</a></li>
<li><a href="../320870/index.html">XELTEK Adapter Cloning Protection Mechanism</a></li>
<li><a href="../320874/index.html">Visualization of data in the browser using D3.js</a></li>
<li><a href="../320878/index.html">Master-master replication and scaling of applications between all IoT devices and the cloud</a></li>
<li><a href="../320880/index.html">VPS hosting and cloud hosting: what to choose and what is the difference?</a></li>
<li><a href="../320882/index.html">Off splinters from the brain. 15 stereotypes about CRM-systems</a></li>
<li><a href="../320884/index.html">We set up a private Docker repository</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>