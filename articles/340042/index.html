<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OSSIM + SEC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don‚Äôt know about you, but for me in the Alienvault OSSIM (USM) product there was always a lack of flexibility in setting correlation rules. Those. t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OSSIM + SEC</h1><div class="post__text post__text-html js-mediator-article">  I don‚Äôt know about you, but for me in the Alienvault OSSIM (USM) product there was always a lack of flexibility in setting correlation rules.  Those.  there is such an opportunity, and the solution is positioned as a ‚Äúcombine‚Äù as part of which there is also a SIEM component.  But the possibilities of this SIEM in terms of correlation are currently very, very limited.  I sincerely hope that in future releases, developers will add at least some kind of lookup / active lists, and at least the possibility of correlation not only in the fields DST_IP, SRC_IP, DST_PORT, SRC_PORT. <br><br>  In the meantime, I came up with the idea of ‚Äã‚Äãusing SEC (Simple Event Correlator) to expand the functionality of the correlation of IS events in OSSIM / USM. <br><a name="habracut"></a><br>  The solution architecture is shown in the figure below. <br><br><img src="https://habrastorage.org/webt/59/e0/c9/59e0c93cf35a9564578520.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>Brief description of the solution</b> </h4><br>  A SEC deployed on an OSSIM server or on a stand-alone server receives a copy of the logs from text files processed by OSSIM PLUGINs (in FILE 5).  Based on the analysis performed, the SEC generates events and alerts that are written to a file (FILE 6).  This file is read by a specially designed PLUGIN for OSSIM.  Thus, the events generated by the SEC can be seen in the OSSIM console, prioritize them, perform alerts, etc. <br><br>  Of course, in this solution, the drill-down search for events that generated the SEC alerts will be difficult.  To compensate for this shortcoming, it is possible in the alerts generated by the SEC to include copies of the original events that generated them (alerts). <br><br>  Further I will sort a small example. <br><br>  The example is very primitive and created only to demonstrate the functionality.  In further development, the functionality that will put the "raw events", on the basis of which the SEC correlation rule worked, into the userdataX fields of the OSSIM system.  Thus, opening an event in the OSSIM interface, which is an incident generated by the SEC, you can immediately see the source events that caused it. <br><br><h3>  <b>Example</b> </h3><br>  Let's look at an example.  Let's say we want to register events for the modification of suricata signatures. <br><br>  The trigger for this alert will be two events following each other: <br><br><ul><li>  an auditd daemon event indicating changes to the /etc/suricata/suricata.yml file; </li><li>  event from the suricata log about the start of the suricata service. </li></ul><br>  Suppose that auditd is already configured as necessary, to record events for changing the configuration file suricata.yml.  Then, to solve this problem you need: <br><br><ol><li>  configure the auditd and suricata log redirection to a file that reads SEC, say /var/log/sec_input.log </li><li>  configure the SEC rule that generates an alert when the above condition is met; </li><li>  create an OSSIM plugin that reads the file in which the SEC writes alert logs, /var/log/sec_output.log. </li></ol><br><h4>  <b>Configure Redirects</b> </h4><br>  Here, everything is pretty trivial.  To solve the problem, I use the following configuration <br><br><pre><code class="bash hljs">syslog-ng (/etc/syslog-ng/syslog-ng.conf): <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> s_audit_file { file(<span class="hljs-string"><span class="hljs-string">"/var/log/audit/audit.log"</span></span>); }; <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> s_suricata_file { file(<span class="hljs-string"><span class="hljs-string">"/var/log/suricata.log"</span></span>); }; destination d_sec { file(<span class="hljs-string"><span class="hljs-string">"/var/log/sec_input.log"</span></span>); }; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>(s_ audit_file); <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>(s_suricata_file); destination(d_sec); };</code> </pre> <br>  Accordingly, the audit log and surikat logs (only stop and start) are sent to the /var/log/sec_input.log file.  This file reads SEC. <br><br><h4>  <b>SEC Setup</b> </h4><br>  Contents of the main SEC configuration file (/ etc / default / sec): <br><br><pre> <code class="bash hljs">RUN_DAEMON=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> DAEMON_ARGS=<span class="hljs-string"><span class="hljs-string">"-conf=/etc/sec.conf -input=/var/log/sec_input.log -pid=/var/run/sec.pid -detach -log=/var/log/sec_output.log"</span></span></code> </pre> <br>  It specifies the file that reads the SEC (input parameter), the file that contains the correlation rules (the conf parameter), and the file to which the SEC writes a response log and just informational messages (the log parameter). <br><br>  The file with the SEC rules (/etc/sec.conf) looks like this: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=PairWithWindow ptype=RegExp pattern=syscall=5\s+success=yes.*key=<span class="hljs-string"><span class="hljs-string">"suricata-file"</span></span> desc=Suricata config modified action=logonly ptype2=RegExp pattern2=threads initialized, engine started desc2=src_ip=NULL dst_ip=NULL user=NULL msg=<span class="hljs-string"><span class="hljs-string">"Suricata restart initiated with new config file"</span></span> action2=logonly window=600</code> </pre> <br>  It contains only one rule, which correlates two events from the sources, as shown in the figure below: <br><br><img src="https://habrastorage.org/webt/59/e0/b6/59e0b6345fabf048424239.jpeg"><br><br><h4>  <b>OSSIM plugin</b> </h4><br>  The OSSIM plugin is created to handle events generated by the SEC.  For the convenience of processing them, they (events) should have one format. <br><br>  This plugin is developed as a regular plugin for reading text files, as described, for example, here.  If you are not involved in the development of plug-ins, I recommend to read the article at a quick reference to make everything described below have meaning for you. <br><br>  The SEC event format for description in the plugin for this example I took "from the head."  You can make it any, add or remove fields. <br><br>  What is a uniform format for?  After all, is it possible to add regexp to the plug-in configuration file for each type of SEC event? <br><br>  Yes you can.  However, I am a supporter of unification.  In the presence of a single format, all that will be needed to add new types of SEC events is to add one line of description to the corresponding sql file.  Adding new event types will be a very simple process. <br>  So, the format is as follows (without the syslog header, of course): <br><br>  event_name = &lt;event name&gt; src_ip = &lt;address&gt; dst_ip = &lt;address&gt; user = &lt;user name&gt; msg = &lt;informational message itself&gt; <br><br>  SEC message example: <br><br><pre> <code class="bash hljs">Sun Sep 3 23:26:06 ossim_server: src_ip=NULL dst_ip=NULL user=NULL msg=<span class="hljs-string"><span class="hljs-string">"Suricata restart initiated with new config file"</span></span></code> </pre> <br>  The sec.conf plugin configuration file looks like this: <br><br><pre> <code class="bash hljs">[DEFAULT] plugin_id=9006 [config] <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=detector <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> location=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/sec_output.log create_file=<span class="hljs-literal"><span class="hljs-literal">false</span></span> process= start=no stop=no restart=no startup= shutdown= [translation] suricata_conf_change=1 [0001 - Suricata Modified Config] event_type=event regexp=<span class="hljs-string"><span class="hljs-string">"(?P&lt;DATE&gt;\w+\s+\w+\s+\d+\s+\d+\:\d+\:\d+)\s+(?P&lt;HOST&gt;\S+)\:\s+event_name=(?P&lt;EVENT_NAME&gt;\S+)\s+src_ip=(?P&lt;SRC_IP&gt;\S+)\s+dst_ip=(?P&lt;DST_IP&gt;\S+)\s+user=(?P&lt;USER&gt;\S+)\s+msg=(?P&lt;MSG&gt;.*)"</span></span> plugin_sid={translate(<span class="hljs-variable"><span class="hljs-variable">$EVENT_NAME</span></span>)} device={<span class="hljs-variable"><span class="hljs-variable">$HOST</span></span>} username={<span class="hljs-variable"><span class="hljs-variable">$USER</span></span>} src_ip={<span class="hljs-variable"><span class="hljs-variable">$SRC_IP</span></span>} dst_ip={<span class="hljs-variable"><span class="hljs-variable">$DST_IP</span></span>} userdata1={<span class="hljs-variable"><span class="hljs-variable">$MSG</span></span>}</code> </pre> <br>  Configuration file sec.sql: <br><br><pre> <code class="bash hljs">DELETE FROM plugin WHERE id = <span class="hljs-string"><span class="hljs-string">"9006"</span></span>; DELETE FROM plugin_sid <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> plugin_id = <span class="hljs-string"><span class="hljs-string">"9006"</span></span>; INSERT IGNORE INTO plugin (id, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, name, description) VALUES (9006, 1, <span class="hljs-string"><span class="hljs-string">'sec'</span></span>, <span class="hljs-string"><span class="hljs-string">'Simple Event Correlator'</span></span>); INSERT IGNORE INTO plugin_sid (plugin_id, sid, category_id, class_id, name) VALUES (9006, 1, NULL, NULL, <span class="hljs-string"><span class="hljs-string">'SEC: Suricata Config Changed'</span></span>);</code> </pre> <br>  Import the .sql file: <br><br><pre> <code class="bash hljs">ossim-db &lt; /usr/share/doc/ossim-mysql/contrib/plugins/sec.sql</code> </pre> <br>  Enable the plugin: <br><br><img src="https://habrastorage.org/webt/59/e0/b6/59e0b634a6978354371474.jpeg"><br><br>  And enjoy the result: <br><br><img src="https://habrastorage.org/webt/59/e0/b6/59e0b634b9e18793133628.jpeg"><br><br>  And more: <br><br><img src="https://habrastorage.org/webt/59/e0/b6/59e0b634dddcf897940680.jpeg"></div><p>Source: <a href="https://habr.com/ru/post/340042/">https://habr.com/ru/post/340042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340032/index.html">Overview of one Russian RTOS, part 8. Work with interruptions</a></li>
<li><a href="../340034/index.html">React, built-in functions and performance</a></li>
<li><a href="../340036/index.html">Using the advantages of TypeScript in JavaScript development</a></li>
<li><a href="../340038/index.html">10 tools for parsing information from websites, including competitors' prices + legal assessment for Russia</a></li>
<li><a href="../340040/index.html">‚ÄúInformation sciences can be taught only by young people‚Äù - Interview with A.A. Shalyto, a professor at ITMO University</a></li>
<li><a href="../340044/index.html">7 conclusions self-taught programmer for 1 year</a></li>
<li><a href="../340048/index.html">Why DataScientists do not use errors of the first and second kind</a></li>
<li><a href="../340050/index.html">Why a Python Networker? Part two</a></li>
<li><a href="../340052/index.html">Not on TK</a></li>
<li><a href="../340054/index.html">VPC statistics service</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>