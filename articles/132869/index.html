<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Depersonalization of the MySQL database. Interesting technique</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the company where I work, we use a depersonalized base with Production-a. Its total volume at the moment about 30 GB. The ruby ‚Äã‚Äãobfuscation script...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Depersonalization of the MySQL database. Interesting technique</h1><div class="post__text post__text-html js-mediator-article"><img src="http://servernews.ru/assets/images/articles/593698/mysql.jpg" alt="image"><br><br>  In the company where I work, we use a depersonalized base with Production-a.  Its total volume at the moment about 30 GB.  The ruby ‚Äã‚Äãobfuscation script took about 6 hours.  Acceleration can be achieved by rewriting this all into a stored procedure (stored procedure).  But in our project they are forbidden ... Alas and ah. <br><br>  Then I asked myself a question: is it possible to speed up the process to the maximum, to depersonalize the entire database (or at least one table completely) using only one update statement?  The problem is that some fields. D.  unique and some random values ‚Äã‚Äãfrom the list. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  It turned out possible.  A little thought, the decision came with the help of user variables, a pseudo-random number generator and the case operator. <br><br>  Below is a bit of code and explanation: <br><br>  Let there is a table users with fields: <br>  first_name <br>  gender <br>  last_name <br>  address_1 <br>  address_2 <br>  home_phone <br>  birthdate <br>  ssn <br>  password <br><br>  After obfuscation should be: <br>  <b>first_name is one of:</b> female - Patricia, Taylor, Susan, Lisa, Linda, Sandra, Carol, Debra, Teresa, Rebecca, Diana, Veronika, Helen, Alexandra, Svetlana, Elona, ‚Äã‚ÄãMarina, Mila, Olga, Vasilisa, Marta <br>  men - David, John, Robert, Steven, William, Mark, Thomas, Michael, Richard, Kevin, Donald, Andrew, Ruslan, Eugene, Sergey, Alexandr, Yura, Ivan, Daniel <br>  <b>gender:</b> no change <br>  <b>last_name:</b> Johnson, Anderson, Reed, Erickson, Frank, Lucas, Jenkins, Watson, Morgan, Kim, Kovalinen, Konovalov, Tereshko, Urchik, Kuleshov, Kisliakov, Areshnik, Pekar, Matroskin, Gallagher <br>  <b>address_1:</b> 123 Main Street <br>  <b>address_2:</b> if there is nothing in the original, then after obfuscation it should be NULL, otherwise the address is 123 Main Street <br>  <b>home_phone:</b> if there is nothing in the original, then after obfuscation it should be NULL, otherwise the phone 111-111-2222 <br>  <b>birthdate:</b> leave the year of birth the same and change the date and month <br>  <b>ssn: a</b> random nine-character value unique to each line, starting with '30' <br>  <b>password:</b> NULL <br><br>  Decision: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> = <span class="hljs-number"><span class="hljs-number">276821</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> first_name= <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> gender=<span class="hljs-string"><span class="hljs-string">'F'</span></span> || gender=<span class="hljs-string"><span class="hljs-string">'f'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>() * <span class="hljs-number"><span class="hljs-number">21</span></span>), <span class="hljs-string"><span class="hljs-string">'Patricia'</span></span>, <span class="hljs-string"><span class="hljs-string">'Taylor'</span></span>, <span class="hljs-string"><span class="hljs-string">'Susan'</span></span>, <span class="hljs-string"><span class="hljs-string">'Lisa'</span></span>, <span class="hljs-string"><span class="hljs-string">'Linda'</span></span>, <span class="hljs-string"><span class="hljs-string">'Sandra'</span></span>, <span class="hljs-string"><span class="hljs-string">'Carol'</span></span>, <span class="hljs-string"><span class="hljs-string">'Debra'</span></span>, <span class="hljs-string"><span class="hljs-string">'Teresa'</span></span>, <span class="hljs-string"><span class="hljs-string">'Rebecca'</span></span>, <span class="hljs-string"><span class="hljs-string">'Diana'</span></span>, <span class="hljs-string"><span class="hljs-string">'Veronika'</span></span>, <span class="hljs-string"><span class="hljs-string">'Helen'</span></span>, <span class="hljs-string"><span class="hljs-string">'Alexandra'</span></span>, <span class="hljs-string"><span class="hljs-string">'Svetlana'</span></span>, <span class="hljs-string"><span class="hljs-string">'Elona'</span></span>, <span class="hljs-string"><span class="hljs-string">'Marina'</span></span>, <span class="hljs-string"><span class="hljs-string">'Mila'</span></span>, <span class="hljs-string"><span class="hljs-string">'Olga'</span></span>, <span class="hljs-string"><span class="hljs-string">'Vasilisa'</span></span>, <span class="hljs-string"><span class="hljs-string">'Marta'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>() * <span class="hljs-number"><span class="hljs-number">19</span></span>), <span class="hljs-string"><span class="hljs-string">'David'</span></span>, <span class="hljs-string"><span class="hljs-string">'John'</span></span>, <span class="hljs-string"><span class="hljs-string">'Robert'</span></span>, <span class="hljs-string"><span class="hljs-string">'Steven'</span></span>, <span class="hljs-string"><span class="hljs-string">'William'</span></span>, <span class="hljs-string"><span class="hljs-string">'Mark'</span></span>, <span class="hljs-string"><span class="hljs-string">'Thomas'</span></span>, <span class="hljs-string"><span class="hljs-string">'Michael'</span></span>, <span class="hljs-string"><span class="hljs-string">'Richard'</span></span>, <span class="hljs-string"><span class="hljs-string">'Kevin'</span></span>, <span class="hljs-string"><span class="hljs-string">'Donald'</span></span>, <span class="hljs-string"><span class="hljs-string">'Andrew'</span></span>, <span class="hljs-string"><span class="hljs-string">'Ruslan'</span></span>, <span class="hljs-string"><span class="hljs-string">'Eugene'</span></span>, <span class="hljs-string"><span class="hljs-string">'Sergey'</span></span>, <span class="hljs-string"><span class="hljs-string">'Alexandr'</span></span>, <span class="hljs-string"><span class="hljs-string">'Yura'</span></span>, <span class="hljs-string"><span class="hljs-string">'Ivan'</span></span>, <span class="hljs-string"><span class="hljs-string">'Daniel'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, last_name = <span class="hljs-keyword"><span class="hljs-keyword">ELT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>() * <span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-string"><span class="hljs-string">'Johnson'</span></span>, <span class="hljs-string"><span class="hljs-string">'Anderson'</span></span>, <span class="hljs-string"><span class="hljs-string">'Reed'</span></span>, <span class="hljs-string"><span class="hljs-string">'Erickson'</span></span>, <span class="hljs-string"><span class="hljs-string">'Frank'</span></span>, <span class="hljs-string"><span class="hljs-string">'Lucas'</span></span>, <span class="hljs-string"><span class="hljs-string">'Jenkins'</span></span>, <span class="hljs-string"><span class="hljs-string">'Watson'</span></span>, <span class="hljs-string"><span class="hljs-string">'Morgan'</span></span>, <span class="hljs-string"><span class="hljs-string">'Kim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Kovalinen'</span></span>, <span class="hljs-string"><span class="hljs-string">'Konovalov'</span></span>, <span class="hljs-string"><span class="hljs-string">'Tereshko'</span></span>, <span class="hljs-string"><span class="hljs-string">'Urchik'</span></span>, <span class="hljs-string"><span class="hljs-string">'Kuleshov'</span></span>, <span class="hljs-string"><span class="hljs-string">'Kisliakov'</span></span>, <span class="hljs-string"><span class="hljs-string">'Areshnik'</span></span>, <span class="hljs-string"><span class="hljs-string">'Pekar'</span></span>, <span class="hljs-string"><span class="hljs-string">'Matroskin'</span></span>, <span class="hljs-string"><span class="hljs-string">'Gallagher'</span></span>), address_1 = <span class="hljs-string"><span class="hljs-string">'123 Main Street'</span></span>, address_2 = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> address_2 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'Apt. 14'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, home_phone = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> home_phone <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'111-111-2222'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, birthdate = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> birthdate <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAKEDATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(birthdate),<span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">RAND</span></span>()*<span class="hljs-number"><span class="hljs-number">365</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, ssn = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> ((@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> + <span class="hljs-number"><span class="hljs-number">609673</span></span>) % <span class="hljs-number"><span class="hljs-number">1048576</span></span> &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; ((@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> + <span class="hljs-number"><span class="hljs-number">609673</span></span>) % <span class="hljs-number"><span class="hljs-number">1048576</span></span> &lt;&gt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'30'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">LPAD</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>:=(@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> + <span class="hljs-number"><span class="hljs-number">609673</span></span>) % <span class="hljs-number"><span class="hljs-number">1048576</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-string"><span class="hljs-string">'0'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'30'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">LPAD</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>:=(@<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> + <span class="hljs-number"><span class="hljs-number">609673</span></span>*<span class="hljs-number"><span class="hljs-number">2</span></span>) % <span class="hljs-number"><span class="hljs-number">1048576</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-string"><span class="hljs-string">'0'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span>;</code> </pre> <br><br>  As can be seen from the code, you can select a random value from the list using ELT (FLOOR (1 + RAND () * 21), ...), where FLOOR (1 + RAND () * 21) is a random value in the range from 1 to 21. ELT - selects the appropriate drain with the specified index. <br><br>  CASE helps to choose separate female and male names depending on gender.  Such progress control functions that can be used in a separate statement are four CASE, IF, IFNULL (), NULLIF (). <br><br>  From what is worth mentioning, this is a generator of a random unique value.  A prime number (276821) was chosen as the initial value of the generator and written to the user variable <a href="http://habrahabr.ru/users/rand/" class="user_link">rand</a> .  The following value is set directly in the CASE statement: <a href="http://habrahabr.ru/users/rand/" class="user_link">rand</a> : = ( <a href="http://habrahabr.ru/users/rand/" class="user_link">rand</a> + 609673 * 2)% 1048576. The CONCAT expression ('30', LPAD ( <a href="http://habrahabr.ru/users/rand/" class="user_link">rand</a> , 7, '0')) forms the final look of the <a href="http://habrahabr.ru/users/rand/" class="user_link">rand</a> value. <br><br>  Conclusion: <br>  What have we achieved in this way of depersonalizing the base? <br>  1) The execution speed was reduced from 6 hours to 4 minutes. <br>  2) Stored procedures are not used. <br>  3) Clear (not complicated) logic of work and all code is assembled in one place. </div><p>Source: <a href="https://habr.com/ru/post/132869/">https://habr.com/ru/post/132869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132863/index.html">Perfect marker board</a></li>
<li><a href="../132864/index.html">Digium's Switchvox is recognized!</a></li>
<li><a href="../132866/index.html">Rereading Cooper</a></li>
<li><a href="../132867/index.html">One day in the life of a project manager through the eyes of a developer</a></li>
<li><a href="../132868/index.html">FreeSWITCH life example ...</a></li>
<li><a href="../132870/index.html">Manage dependencies in Android projects using Ivy</a></li>
<li><a href="../132871/index.html">HP: caveat emptor</a></li>
<li><a href="../132874/index.html">Social spam</a></li>
<li><a href="../132875/index.html">Writing the function of saving pictures to the SD card</a></li>
<li><a href="../132876/index.html">HTA Interactive Card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>