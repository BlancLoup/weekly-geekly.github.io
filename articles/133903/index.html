<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of code execution speed</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about how classic algorithms can make our code faster. We will look at the zero-bit search algorithm and how it can help us increase t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of code execution speed</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/7025a24c/03730100/beb9908d/96a0a329.jpg"><br><br>  This article is about how classic algorithms can make our code faster.  We will look at the zero-bit search algorithm and how it can help us increase the efficiency of a character search algorithm from a range (for example, find the first occurrence of a character from the range 0-9 in a line). <br>  Those.  <s>just a spherical horse in a vacuum is</s> quite common situation when processing text, when it is necessary to find the position of the first digit in a free text.  What many begin to learn regular expressions with. <br>  This article describes the use of gcc.  If desired, everything can be repeated under other compilers and languages ‚Äã‚Äãwith minor modifications.  Carefully, there is an assembler under the cut! <br><a name="habracut"></a><br>  To solve this problem, we can use the following ways: <br>  1) Take advantage of the regular expression library. <br>  2) Write a function to search for yourself. <br>  If the lines are small, the question of optimization does not arise.  This task becomes interesting when the length of the lines increases, or there is a large number of checks. <br>  We will measure the execution time using the clock () function from the &lt;time.h&gt; file. <br><br><h5>  Use REGEX </h5><br>  Consider a method using regular expressions.  One of the first methods that comes to mind is to use the REGEX library.  The regular expression will look like this: <br>  <b>"[[: digit:]]"</b> <br>  The code for using this library can be: <br><pre><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> tbefore; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> eplased; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pmatch[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">regex_t</span></span> regex; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reti; ‚Ä¶. <span class="hljs-comment"><span class="hljs-comment">/*REGEXP usage*/</span></span> tbefore = clock(); reti = regcomp( &amp; regex, <span class="hljs-string"><span class="hljs-string">"[[:digit:]]"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">1</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">100000</span></span>;i++){ reti = regexec(&amp; regex, test_string, <span class="hljs-number"><span class="hljs-number">1</span></span>, pmatch, <span class="hljs-number"><span class="hljs-number">0</span></span>); } eplased=clock()-tbefore; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Function strchr used %.3f seconds %d\n"</span></span>, eplased/CLOCKS_PER_SEC, pmatch[<span class="hljs-number"><span class="hljs-number">0</span></span>]); regfree( &amp; regex); <span class="hljs-comment"><span class="hljs-comment">/**************/</span></span></code> </pre> <br>  Execution speed: <b>1.74 sec.</b> <br>  In this code, I deliberately removed the checks on the success of the compilation and search, that is, you cannot use this code to solve real problems.  But to test the speed in "greenhouse" conditions - the most it.  In addition, I measure the execution time based on the compilation of a regular expression and the release of memory after using it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Own function to search </h5><br>  Let's try to use the traditional approach - in the forehead.  Search function <br>  will look like this ( <i>Algorithm 1</i> ): <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> search1(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> l=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; l = strlen(<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;l;i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>[i] &gt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>) &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>[i] &lt;= <span class="hljs-string"><span class="hljs-string">'9'</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (i); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre><br>  Execution speed: <b>7.19 seconds.</b> <br>  And the results of measurements show more than four times lower speed of execution!  What should be expected. <br><br><h5>  Optimized algorithm </h5><br>  Let's try to optimize.  Once I came across the book ‚ÄúAlgorithmic Tricks for Programmers‚Äù by G. Warren.  And in this book there was a description of the algorithms for finding the zero character in the string.  These algorithms are used for example in the C language to search for the end of a line.  Also in one of the paragraphs proposed a generalization of one of these algorithms for the range tag. <br>  The idea of ‚Äã‚Äãthe algorithm is that, in order to search for the index of a character in a string, they search through not four characters at once, but four at a time, reading double words from the array (dword = 4 byte).  Those.  In terms of the C language, we read from the array of characters (char) long integers (unsigned). <br>  After this, arithmetic operations are performed with the word.  For a range from zero to nine, it looks like this: <br><pre> <code class="hljs coffeescript">int zbytel3(unsigned z) { unsigned y; x = z ^ <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Original byte: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> other y = (x &amp; <span class="hljs-number"><span class="hljs-number">0x7F7F7F7F</span></span>) + <span class="hljs-number"><span class="hljs-number">0x76767676</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>F <span class="hljs-number"><span class="hljs-number">7</span></span>F <span class="hljs-number"><span class="hljs-number">1</span></span>xxxxxxx y = ~(y | x | <span class="hljs-number"><span class="hljs-number">0x7F7F7F7F</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> // These steps map: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y &gt; <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>xxxxxx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (y &gt;&gt; <span class="hljs-number"><span class="hljs-number">31</span></span>) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0080</span></span>xxxx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">000080</span></span>xx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (y &gt;&gt; <span class="hljs-number"><span class="hljs-number">15</span></span>) ^ <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00000080</span></span> =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span> }</code> </pre><br><br>  i.e. x = z ^ 0x30303030 is an exclusive operation or, which turns the minimum number of the range ‚Äû0‚Äú - 0x30 into 0. 0x76 = 0x7F-9, where 9 = n-1, where n is the number of characters in the range. <br>  Then simple byte arithmetic, as a result of which you can get the number that is processed in the branch, and as a result we get the numbers from 1 to 4. That is,  if the character is not found, then 4. <br>  Now our function will look like this: <br><pre> <code class="hljs coffeescript">int search2( char *str){ int n, j = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned x, y, *r; const char *c_ptr; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,   . <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c_ptr=str; ((unsigned long int)c_ptr &amp; (sizeof(x) - <span class="hljs-number"><span class="hljs-number">1</span></span>)) != <span class="hljs-number"><span class="hljs-number">0</span></span>; ++c_ptr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*c_ptr &gt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>) &amp;&amp; (*c_ptr &lt;= <span class="hljs-string"><span class="hljs-string">'9'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c_ptr - str; r = (unsigned *) c_ptr; j = c_ptr - str ; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>){ x = *r ^ <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; y = (x &amp; <span class="hljs-number"><span class="hljs-number">0x7F7F7F7F</span></span>) + <span class="hljs-number"><span class="hljs-number">0x76767676</span></span>; y = ~(y | x | <span class="hljs-number"><span class="hljs-number">0x7F7F7F7F</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> These steps map: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y == <span class="hljs-number"><span class="hljs-number">0</span></span>) n = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y &gt; <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>xxxxxx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, n= (y &gt;&gt; <span class="hljs-number"><span class="hljs-number">31</span></span>) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0080</span></span>xxxx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">000080</span></span>xx =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, n= (y &gt;&gt; <span class="hljs-number"><span class="hljs-number">15</span></span>) ^ <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00000080</span></span> =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span> j=j+n ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>) {j =j +<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">-2</span></span>*n; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;} r++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (j); }</code> </pre><br>  Execution speed: <b>1.71 sec.</b> <br>  The measurement results show a speed close to regexp.  Can we do it faster?  Yes! <br>  We use assembler inserts.  The strength of the described method is that it allows to reduce the number of cycles that the processor spends on execution due to the application of elementary arithmetic operations.  Programming in a high-level language does not fully allow the possibilities of this algorithm to be realized. <br>  Therefore, now our function will take the following form: <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> search3( char *str){ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, j = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned <span class="hljs-keyword"><span class="hljs-keyword">x</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">y</span></span>, *r; const char *c_ptr; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c_ptr=str; ((unsigned long <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)c_ptr &amp; (sizeof(<span class="hljs-keyword"><span class="hljs-keyword">x</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>)) != <span class="hljs-number"><span class="hljs-number">0</span></span>; ++c_ptr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*c_ptr &gt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>) &amp;&amp; (*c_ptr &lt;= <span class="hljs-string"><span class="hljs-string">'9'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c_ptr - str; r = (unsigned *) c_ptr; j = c_ptr - str ; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>){ __asm_<span class="hljs-number"><span class="hljs-number">_</span></span>( <span class="hljs-string"><span class="hljs-string">"movl $5, %%edx\n"</span></span> <span class="hljs-string"><span class="hljs-string">"movl (%%ebx), %%eax\n"</span></span> <span class="hljs-string"><span class="hljs-string">"xor $0x30303030, %%eax\n"</span></span> // <span class="hljs-string"><span class="hljs-string">"and $0x7F7F7F7F, %%eax\n"</span></span> <span class="hljs-string"><span class="hljs-string">"add $0x76767676, %%eax\n"</span></span> <span class="hljs-string"><span class="hljs-string">"movl %%eax, %%ecx\n"</span></span> <span class="hljs-string"><span class="hljs-string">"or %%eax, %%ecx\n"</span></span> <span class="hljs-string"><span class="hljs-string">"or $0x7F7F7F7F, %%ecx\n"</span></span> <span class="hljs-string"><span class="hljs-string">"notl %%ecx\n"</span></span> :<span class="hljs-string"><span class="hljs-string">"=c"</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">y</span></span>) :<span class="hljs-string"><span class="hljs-string">"b"</span></span>( r ) ); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> These steps <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">y</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) n = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> ==&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">y</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>) // <span class="hljs-number"><span class="hljs-number">80</span></span>xxxxxx ==&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, n= (<span class="hljs-keyword"><span class="hljs-keyword">y</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">31</span></span>) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>80xxxx ==&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> // <span class="hljs-number"><span class="hljs-number">0000</span></span>80xx ==&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, n= (<span class="hljs-keyword"><span class="hljs-keyword">y</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">15</span></span>) ^ <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">000000</span></span>8<span class="hljs-number"><span class="hljs-number">0</span></span> ==&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>. j=j+n ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>) {j =j +<span class="hljs-number"><span class="hljs-number">3</span></span> -<span class="hljs-number"><span class="hljs-number">2</span></span>*n; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;} r++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (j); }</code> </pre><br>  Execution speed: <b>1.23 seconds.</b> <br>  I replaced the inset assembly with only arithmetic operations.  Branching can also be replaced by an assembler code, but I‚Äôm not sure of a significant gain, but a few branches with labels will significantly complicate the debugging process. <br>  The win is present, but not many times in comparison with regexp.  In principle, optimizing assembly inserts can still improve the code, but this all entails the complication of the debugging process.  If you optimize the branching and the cycle, then you can increase the speed one and a half more.  But debugging the code will be much harder.  You can also optimize this algorithm for 64 bits instead of 32, try to parallelize the process. <br><br>  So we get: <br><table><tbody><tr><td>  Regex </td><td>  1.74 </td></tr><tr><td>  Algorithm 1 </td><td>  7.19 </td></tr><tr><td>  Algorithm 2 </td><td>  1.71 </td></tr><tr><td>  Algorithm 2 + asm </td><td>  1.23 </td></tr></tbody></table><br><br>  The conclusion suggests itself: The invention of bicycles is not welcome, and the gain from assembler optimization may not always be so significant. <br><br>  Link to the source archive: <br>  <a href="http://webfile.ru/5706721">webfile.ru/5706721</a> <br><br>  <b>UPD:</b> <br>  Optimization for the processor architecture was specified, adding the -O 2 parameter. <br>  Also I add summation inside test functions to somehow use the result. <br>  Result: <br><br><table><tbody><tr><td>  Regex </td><td>  4.56 </td></tr><tr><td>  Algorithm 1 </td><td>  2.99 </td></tr><tr><td>  Algorithm 2 </td><td>  one </td></tr><tr><td>  Algorithm 2 + asm </td><td>  1.7 * </td></tr></tbody></table><br><br>  * With the -O2 key, it stopped working properly, __volatile_ did not help, the result with the -O1 key but with added summation. <br><br>  <b>UPD 2:</b> <br><br>  The user <a href="http://habrahabr.ru/users/Maratyszcza/">Maratyszcza</a> (thanks to him!) <a href="http://habrahabr.ru/users/Maratyszcza/">Offered</a> an even faster option using <a href="http://ru.wikipedia.org/wiki/SIMD">SIMD extensions</a> . <br><br><pre> <code class="hljs rust">#include &lt;intrin.h&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* find_digit(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __m128i str_mask[<span class="hljs-number"><span class="hljs-number">16</span></span>] = { _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00FFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x000000FF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00FFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000FF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00FFFFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000FF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00FFFFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0000FFFF</span></span>), _mm_set_epi32(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000FF</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __m128i str_offset = _mm_set1_epi8(<span class="hljs-number"><span class="hljs-number">127</span></span> - <span class="hljs-string"><span class="hljs-string">'9'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __m128i str_threshold = _mm_set1_epi8(<span class="hljs-number"><span class="hljs-number">127</span></span> - <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> size_t str_misalignment = ((size_t)<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) &amp; ((size_t)<span class="hljs-number"><span class="hljs-number">15</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __m128i* str_aligned = (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __m128i*)(((size_t)<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) - str_misalignment); __m128i str_vector = _mm_load_si128(str_aligned); str_vector = _mm_and_si128(str_vector, str_mask[str_misalignment]); str_vector = _mm_add_epi8(str_vector, str_offset); int str_bitmask = _mm_movemask_epi8(_mm_cmpgt_epi8(str_vector, str_threshold)); unsigned long index; _BitScanForward(&amp;index, str_bitmask); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (str_bitmask == <span class="hljs-number"><span class="hljs-number">0</span></span>) { str_aligned += <span class="hljs-number"><span class="hljs-number">1</span></span>; str_vector = _mm_load_si128(str_aligned); str_vector = _mm_add_epi8(str_vector, str_offset); str_bitmask = _mm_movemask_epi8(_mm_cmpgt_epi8(str_vector, str_threshold)); _BitScanForward(&amp;index, str_bitmask); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*)str_aligned) + index; }</code> </pre><br><br>  While this is the fastest option. </div><p>Source: <a href="https://habr.com/ru/post/133903/">https://habr.com/ru/post/133903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133894/index.html">The complex of devices for automatic fare payment on the basis of a system of long-range RFID identification</a></li>
<li><a href="../133895/index.html">GTV Channel: Steve Jobs Documentary and NEXT. 1986 (Russian translation)</a></li>
<li><a href="../133896/index.html">Kaspersky vs SOPA</a></li>
<li><a href="../133897/index.html">Cross platform is cool</a></li>
<li><a href="../133900/index.html">Symbian Web Runtime: easy mobile application development</a></li>
<li><a href="../133906/index.html">Anti-rootkit hypervisor: how it works</a></li>
<li><a href="../133907/index.html">Binary compatibility in the examples and not only</a></li>
<li><a href="../133909/index.html">Upgrade viola jones</a></li>
<li><a href="../133910/index.html">Combat rebuilding cache with RED</a></li>
<li><a href="../133911/index.html">Model-oriented design, or continue taming the Cortex M3 with Matlab / Simulink</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>