<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Single Sign-On for SalesForce</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After 3 days of torment and fruitless attempts to start SSO for SalesForce, I hasten to share with the community the right way to solve the problem, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Single Sign-On for SalesForce</h1><div class="post__text post__text-html js-mediator-article">  After 3 days of torment and fruitless attempts to start SSO for SalesForce, I hasten to share with the community the right way to solve the problem, so that future generations will not waste my precious time hitting my head against the wall.  If interested, then please under the cat. <br><a name="habracut"></a><br>  What is <a href="http://en.wikipedia.org/wiki/Single_sign-on">SSO (Single Sign-On) is</a> best described by the wiki, because I am not a master of high syllable. <br>  In general, the project required the organization of SSO support for such a service as <a href="http://en.wi">SalesForce</a> .  Since for communication between servers <a href="http://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">SAML</a> was used, it was decided to torment Google with searches for a ready implementation.  After persistent searches, the OpenSAML library was found to generate SAML, which saved the universe from the birth of another bicycle. <br><br>  First of all, we will generate certificates.  I used the keytool from the JDK but I can use OpenSSL as well: <br><pre><code class="bash hljs">keytool -genkey -keyalg RSA -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> SSO -keystore keystore keytool -<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> SSO -keystore keystore -file certificate.crt</code> </pre> <br><br>  After the keys are generated, you need to configure SalesForce to allow logging in using SSO.  The best instruction is on their wiki - <a href="">Single Sign-On with SAML on Force.com</a> .  The article is good and big, but we need only one item ‚ÄúConfiguring Force.com for SSO‚Äù.  Yes, and with minor changes: Since my implementation passes the user name in the NameIdentifier element, we leave the switches in their default state: ‚ÄúAssertion contains User‚Äôs salesforce.com username‚Äù and ‚ÄúUser ID is the nameIdentifier element of the Subject statement‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since a couple of examples were found to work with the OpenSAML library, a simple generator was quickly written, suitable for test needs.  After a working day spent on licking the code, a generator generating a valid SAML (according to the SalesForce validator) was obtained.  Below is a licked code. <br><br>  Since it is planned to fasten support for other services besides SalesForce, the generator is divided into several classes: the common part (SAMLResponseGenerator), the implementation for SalesForce (SalesforceSAMLResponseGenerator) and the program to run all this disgrace: <br><br>  <strong>SAMLResponseGenerator.java:</strong> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLResponseGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> XMLObjectBuilderFactory builderFactory = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String issuerId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> X509Certificate certificate; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PublicKey publicKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PrivateKey privateKey; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> Assertion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildAssertion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SAMLResponseGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(X509Certificate certificate, PublicKey publicKey, PrivateKey privateKey, String issuerId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.certificate = certificate; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.publicKey = publicKey; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.privateKey = privateKey; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.issuerId = issuerId; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateSAMLAssertionString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, KeyStoreException, NoSuchProviderException, SignatureException, MarshallingException, ConfigurationException, IOException, org.opensaml.xml.signature.SignatureException, UnmarshallingException </span></span>{ Response response = buildDefaultResponse(issuerId); Assertion assertion = buildAssertion(); response.getAssertions().add(assertion); assertion = signObject(assertion, certificate, publicKey, privateKey); response = signObject(response, certificate, publicKey, privateKey); Element plaintextElement = marshall(response); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> XMLHelper.nodeToString(plaintextElement); } <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unchecked"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> &lt;T extends XMLObject&gt; <span class="hljs-function"><span class="hljs-function">XMLObjectBuilder&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getXMLObjectBuilder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QName qname)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (builderFactory == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// OpenSAML 2.3 DefaultBootstrap.bootstrap(); builderFactory = Configuration.getBuilderFactory(); } return (XMLObjectBuilder&lt;T&gt;) builderFactory.getBuilder(qname); } protected &lt;T extends XMLObject&gt; T buildXMLObject(QName qname) throws ConfigurationException { XMLObjectBuilder&lt;T&gt; keyInfoBuilder = getXMLObjectBuilder(qname); return keyInfoBuilder.buildObject(qname); } protected Attribute buildStringAttribute(String name, String value) throws ConfigurationException { Attribute attrFirstName = buildXMLObject(Attribute.DEFAULT_ELEMENT_NAME); attrFirstName.setName(name); attrFirstName.setNameFormat(Attribute.UNSPECIFIED); // Set custom Attributes XMLObjectBuilder&lt;XSString&gt; stringBuilder = getXMLObjectBuilder(XSString.TYPE_NAME); XSString attrValueFirstName = stringBuilder.buildObject(AttributeValue.DEFAULT_ELEMENT_NAME, XSString.TYPE_NAME); attrValueFirstName.setValue(value); attrFirstName.getAttributeValues().add(attrValueFirstName); return attrFirstName; } private &lt;T extends XMLObject&gt; Element marshall(T object) throws MarshallingException { return Configuration.getMarshallerFactory().getMarshaller(object).marshall(object); } @SuppressWarnings("unchecked") private &lt;T extends XMLObject&gt; T unmarshall(Element element) throws MarshallingException, UnmarshallingException { return (T) Configuration.getUnmarshallerFactory().getUnmarshaller(element).unmarshall(element); } protected &lt;T extends SignableSAMLObject&gt; T signObject(T object, X509Certificate certificate, PublicKey publicKey, PrivateKey privateKey) throws MarshallingException, ConfigurationException, IOException, UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, KeyStoreException, NoSuchProviderException, SignatureException, org.opensaml.xml.signature.SignatureException, UnmarshallingException { BasicX509Credential signingCredential = new BasicX509Credential(); signingCredential.setEntityCertificate(certificate); signingCredential.setPrivateKey(privateKey); signingCredential.setPublicKey(publicKey); KeyInfo keyInfo = buildXMLObject(KeyInfo.DEFAULT_ELEMENT_NAME); X509Data x509Data = buildXMLObject(X509Data.DEFAULT_ELEMENT_NAME); org.opensaml.xml.signature.X509Certificate x509Certificate = buildXMLObject(org.opensaml.xml.signature.X509Certificate.DEFAULT_ELEMENT_NAME); x509Certificate.setValue(Base64.encodeBase64String(certificate.getEncoded())); x509Data.getX509Certificates().add(x509Certificate); keyInfo.getX509Datas().add(x509Data); Signature signature = buildXMLObject(Signature.DEFAULT_ELEMENT_NAME); signature.setSigningCredential(signingCredential); signature.setSignatureAlgorithm(SignatureConstants.ALGO_ID_SIGNATURE_RSA_SHA1); signature.setCanonicalizationAlgorithm(SignatureConstants.ALGO_ID_C14N_EXCL_OMIT_COMMENTS); signature.setKeyInfo(keyInfo); object.setSignature(signature); Element element = marshall(object); Signer.signObject(signature); return unmarshall(element); } protected Response buildDefaultResponse(String issuerId) { try { DateTime now = new DateTime(); // Create Status StatusCode statusCode = buildXMLObject(StatusCode.DEFAULT_ELEMENT_NAME); statusCode.setValue(StatusCode.SUCCESS_URI); Status status = buildXMLObject(Status.DEFAULT_ELEMENT_NAME); status.setStatusCode(statusCode); // Create Issuer Issuer issuer = buildXMLObject(Issuer.DEFAULT_ELEMENT_NAME); issuer.setValue(issuerId); issuer.setFormat(Issuer.ENTITY); // Create the response Response response = buildXMLObject(Response.DEFAULT_ELEMENT_NAME); response.setIssuer(issuer); response.setStatus(status); response.setIssueInstant(now); response.setVersion(SAMLVersion.VERSION_20); return response; } catch (Exception e) { e.printStackTrace(); } return null; } public String getIssuerId() { return issuerId; } public void setIssuerId(String issuerId) { this.issuerId = issuerId; } }</span></span></code> </pre><br><br>  <strong>SalesforceSAMLResponseGenerator.java:</strong> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SalesforceSAMLResponseGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLResponseGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SALESFORCE_LOGIN_URL = <span class="hljs-string"><span class="hljs-string">"https://login.salesforce.com"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SALESFORCE_AUDIENCE_URI = <span class="hljs-string"><span class="hljs-string">"https://saml.salesforce.com"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger = Logger.getLogger(SalesforceSAMLResponseGenerator.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxSessionTimeoutInMinutes = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String nameId; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SalesforceSAMLResponseGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(X509Certificate certificate, PublicKey publicKey, PrivateKey privateKey, String issuerId, String nameId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(certificate, publicKey, privateKey, issuerId); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameId = nameId; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Assertion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildAssertion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Create the NameIdentifier NameID nameId = buildXMLObject(NameID.DEFAULT_ELEMENT_NAME); nameId.setValue(this.nameId); nameId.setFormat(NameID.EMAIL); // Create the SubjectConfirmation SubjectConfirmationData confirmationMethod = buildXMLObject(SubjectConfirmationData.DEFAULT_ELEMENT_NAME); DateTime notBefore = new DateTime(); DateTime notOnOrAfter = notBefore.plusMinutes(maxSessionTimeoutInMinutes); confirmationMethod.setNotOnOrAfter(notOnOrAfter); confirmationMethod.setRecipient(SALESFORCE_LOGIN_URL); SubjectConfirmation subjectConfirmation = buildXMLObject(SubjectConfirmation.DEFAULT_ELEMENT_NAME); subjectConfirmation.setMethod(SubjectConfirmation.METHOD_BEARER); subjectConfirmation.setSubjectConfirmationData(confirmationMethod); // Create the Subject Subject subject = buildXMLObject(Subject.DEFAULT_ELEMENT_NAME); subject.setNameID(nameId); subject.getSubjectConfirmations().add(subjectConfirmation); // Create Authentication Statement AuthnStatement authnStatement = buildXMLObject(AuthnStatement.DEFAULT_ELEMENT_NAME); DateTime now2 = new DateTime(); authnStatement.setAuthnInstant(now2); authnStatement.setSessionNotOnOrAfter(now2.plus(maxSessionTimeoutInMinutes)); AuthnContext authnContext = buildXMLObject(AuthnContext.DEFAULT_ELEMENT_NAME); AuthnContextClassRef authnContextClassRef = buildXMLObject(AuthnContextClassRef.DEFAULT_ELEMENT_NAME); authnContextClassRef.setAuthnContextClassRef(AuthnContext.UNSPECIFIED_AUTHN_CTX); authnContext.setAuthnContextClassRef(authnContextClassRef); authnStatement.setAuthnContext(authnContext); Audience audience = buildXMLObject(Audience.DEFAULT_ELEMENT_NAME); audience.setAudienceURI(SALESFORCE_AUDIENCE_URI); AudienceRestriction audienceRestriction = buildXMLObject(AudienceRestriction.DEFAULT_ELEMENT_NAME); audienceRestriction.getAudiences().add(audience); Conditions conditions = buildXMLObject(Conditions.DEFAULT_ELEMENT_NAME); conditions.setNotBefore(notBefore); conditions.setNotOnOrAfter(notOnOrAfter); conditions.getConditions().add(audienceRestriction); // Create Issuer Issuer issuer = (Issuer) buildXMLObject(Issuer.DEFAULT_ELEMENT_NAME); issuer.setValue(getIssuerId()); // Create the assertion Assertion assertion = buildXMLObject(Assertion.DEFAULT_ELEMENT_NAME); assertion.setIssuer(issuer); assertion.setID(UUID.randomUUID().toString()); assertion.setIssueInstant(notBefore); assertion.setVersion(SAMLVersion.VERSION_20); assertion.getAuthnStatements().add(authnStatement); assertion.setConditions(conditions); assertion.setSubject(subject); return assertion; } catch (ConfigurationException e) { logger.error(e, e); } return null; } }</span></span></code> </pre><br><br>  <strong>TestSSO.java:</strong> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestSSO</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PrivateKey privateKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> X509Certificate certificate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCertificate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream inputStream, String alias, String password)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchAlgorithmException, CertificateException, IOException, UnrecoverableKeyException, KeyStoreException </span></span>{ KeyStore keyStore = KeyStore.getInstance(<span class="hljs-string"><span class="hljs-string">"JKS"</span></span>); keyStore.load(inputStream, password.toCharArray()); Key key = keyStore.getKey(alias, password.toCharArray()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Got null key from keystore!"</span></span>); } privateKey = (PrivateKey) key; certificate = (X509Certificate) keyStore.getCertificate(alias); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (certificate == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Got null cert from keystore!"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ConfigurationException, UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, FileNotFoundException, KeyStoreException, NoSuchProviderException, SignatureException, IOException, org.opensaml.xml.signature.SignatureException, URISyntaxException, UnmarshallingException, MarshallingException </span></span>{ String strIssuer = <span class="hljs-string"><span class="hljs-string">"Eugene Burtsev"</span></span>; String strNameID = <span class="hljs-string"><span class="hljs-string">"user@test.com"</span></span>; InputStream inputStream = TestSSO.class.getResourceAsStream(<span class="hljs-string"><span class="hljs-string">"/keystore"</span></span>); readCertificate(inputStream, <span class="hljs-string"><span class="hljs-string">"SSO"</span></span>, <span class="hljs-string"><span class="hljs-string">"12345678"</span></span>); SAMLResponseGenerator responseGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SalesforceSAMLResponseGenerator(certificate, certificate.getPublicKey(), privateKey, strIssuer, strNameID); String samlAssertion = responseGenerator.generateSAMLAssertionString(); System.out.println(); System.out.println(<span class="hljs-string"><span class="hljs-string">"Assertion String: "</span></span> + samlAssertion); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ConfigurationException, UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, FileNotFoundException, KeyStoreException, NoSuchProviderException, SignatureException, IOException, org.opensaml.xml.signature.SignatureException, URISyntaxException, UnmarshallingException, MarshallingException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestSSO().run(); } }</code> </pre><br><br>  Despite all the assurances of the validator that the code is valid, forcing SalesForce to authenticate using SSO was not a trivial task.  About a dozen examples were tested with their wiki and none earned at best saying that they say "invalid assertion" ... So three days passed ... And then it came to my mind to read <a href="http://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf">the OASIS specifications</a> , in which sacred knowledge was drawn that SAML needed send in the parameter ‚ÄúSAMLResponse‚Äù POST request ... Already not hoping for success, this knowledge was applied in practice, and the miracle did happen - salesforce issued a link with a token for the login.  Below is a complete example of a program illustrating the right approach for implementing SSO for SalesForce. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestSSO</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger = Logger.getLogger(TestSSO.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DefaultHttpClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getThreadSafeClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DefaultHttpClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHttpClient(); ClientConnectionManager mgr = client.getConnectionManager(); HttpParams params = client.getParams(); client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHttpClient(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadSafeClientConnManager( mgr.getSchemeRegistry()), params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HttpClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createHttpClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HttpClient httpclient = getThreadSafeClient(); httpclient.getParams().setParameter( CoreProtocolPNames.PROTOCOL_VERSION, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProtocolVersion(<span class="hljs-string"><span class="hljs-string">"HTTP"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> httpclient; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSamlRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String samlAssertion)</span></span></span><span class="hljs-function"> </span></span>{ HttpClient httpClient = createHttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.out.println(samlAssertion); HttpPost httpPost = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpPost(<span class="hljs-string"><span class="hljs-string">"https://login.salesforce.com/"</span></span>); MultipartEntity entity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MultipartEntity(HttpMultipartMode.STRICT); entity.addPart(<span class="hljs-string"><span class="hljs-string">"SAMLResponse"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBody(samlAssertion)); httpPost.setEntity(entity); HttpResponse httpResponse = httpClient.execute(httpPost); Header location = httpResponse.getFirstHeader(<span class="hljs-string"><span class="hljs-string">"Location"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> != location) { System.out.println(location.getValue()); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { logger.error(e, e); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { httpClient.getConnectionManager().shutdown(); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PrivateKey privateKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> X509Certificate certificate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCertificate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream inputStream, String alias, String password)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchAlgorithmException, CertificateException, IOException, UnrecoverableKeyException, KeyStoreException </span></span>{ KeyStore keyStore = KeyStore.getInstance(<span class="hljs-string"><span class="hljs-string">"JKS"</span></span>); keyStore.load(inputStream, password.toCharArray()); Key key = keyStore.getKey(alias, password.toCharArray()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Got null key from keystore!"</span></span>); } privateKey = (PrivateKey) key; certificate = (X509Certificate) keyStore.getCertificate(alias); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (certificate == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Got null cert from keystore!"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ConfigurationException, UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, FileNotFoundException, KeyStoreException, NoSuchProviderException, SignatureException, IOException, org.opensaml.xml.signature.SignatureException, URISyntaxException, UnmarshallingException, MarshallingException </span></span>{ String strIssuer = <span class="hljs-string"><span class="hljs-string">"Eugene Burtsev"</span></span>; String strNameID = <span class="hljs-string"><span class="hljs-string">"user@test.com"</span></span>; InputStream inputStream = TestSSO.class.getResourceAsStream(<span class="hljs-string"><span class="hljs-string">"/keystore"</span></span>); readCertificate(inputStream, <span class="hljs-string"><span class="hljs-string">"SSO"</span></span>, <span class="hljs-string"><span class="hljs-string">"12345678"</span></span>); SAMLResponseGenerator responseGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SalesforceSAMLResponseGenerator(certificate, certificate.getPublicKey(), privateKey, strIssuer, strNameID); String samlAssertion = responseGenerator.generateSAMLAssertionString(); System.out.println(); System.out.println(<span class="hljs-string"><span class="hljs-string">"Assertion String: "</span></span> + samlAssertion); sendSamlRequest(Base64.encodeBase64String(samlAssertion.getBytes(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>))); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ConfigurationException, UnrecoverableKeyException, InvalidKeyException, NoSuchAlgorithmException, CertificateException, FileNotFoundException, KeyStoreException, NoSuchProviderException, SignatureException, IOException, org.opensaml.xml.signature.SignatureException, URISyntaxException, UnmarshallingException, MarshallingException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestSSO().run(); } }</code> </pre><br><br>  The source archive can be found <a href="">here.</a> <br>  And finally, the moral: Do not believe anyone, only the specs are the truth! <br><br>  List of useful resources: <br><ol><li>  <a href="">Single Sign-On with SAML on Force.com</a> </li><li>  <a href="http://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf">docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf</a> </li><li>  <a href="http://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html">www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/151006/">https://habr.com/ru/post/151006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151000/index.html">How to write a game</a></li>
<li><a href="../151001/index.html">IMAP: transition difficulties</a></li>
<li><a href="../151002/index.html">Do you buy software for your iOS / Android device?</a></li>
<li><a href="../151003/index.html">Holo Android Settings</a></li>
<li><a href="../151005/index.html">On the creation of personal ratings. Like IMHO.net</a></li>
<li><a href="../151008/index.html">Lazarus as it is</a></li>
<li><a href="../151009/index.html">How I made friends with Unity3D and F #</a></li>
<li><a href="../151010/index.html">Career Programmer, or Cracking Coding Interview</a></li>
<li><a href="../151011/index.html">Raises telephony from scratch: Asterisk, FreePBX, GSM Gateway on Huawei E173 in Debian</a></li>
<li><a href="../151014/index.html">Saltarelle: open source C # - JavaScript compiler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>