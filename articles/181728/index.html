<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributed audio player on Odroid U2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I noticed that I spend quite a lot of time in the kitchen, where the sound from the speakers located in the room comes to bad. And then I wanted ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributed audio player on Odroid U2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/e1a/089/480/e1a089480b90b1345bb5a5b36f94ce6b.jpg" align="right"><br>  Once I noticed that I spend quite a lot of time in the kitchen, where the sound from the speakers located in the room comes to bad.  And then I wanted to make a good silent player that can <b>simultaneously</b> play music in several rooms.  Of course, the problem could be solved by simply turning the volume control, but this method was discarded as inhuman to the neighbors.  Another important point was that I wanted to use the same speakers to output sound from the computer.  Why should I have several sets of acoustics in one room? <br>  The post was quite long, as I tried to pay attention to the considerations for which I chose this or that solution. <br><a name="habracut"></a><br><h2>  Iron </h2><br><ul><li>  <b>HiFi speakers and amplifier</b> - a kit for each room.  All devices in the room should use them. </li><li>  <b>Usb sound card</b> </li><li>  <b>Ethernet</b> is a good old reliable and predictable data transfer medium.  The best solution if you can lay several cables. </li><li>  <b>NAS</b> - music must be stored somewhere.  Flash cards are good, but their volume is not enough to store loseless music, therefore, remain HDD.  But the hard drives are noisy, so they have the place in the far corner on the mezzanine or in the closet.  In addition, a normal NAS will have a gigabit port, and all small ARM motherboards will have 100 megabit. </li></ul><br><br><h2>  Soft </h2><br><h3>  Synchronized playback </h3><br>  Programs that can synchronously reproduce sound very little.  Our ear can discern the slightest deviation and we begin to hear an echo.  Pleasures as much as from announcements of arriving trains through the speakerphone at the station in the outback.  Two sound systems show good results: <a href="http://jackaudio.org/">jack</a> and <a href="http://www.pulseaudio.org/">PulseAudio</a> .  They say that <a href="http://en.wikipedia.org/wiki/Squeezebox_(network_music_player)">squeezebox</a> still works well.  I also tried mplayer and vlc, but I didn‚Äôt get acceptable synchronicity from them.  Vlc copes well with the video stream, if you use <a href="http://www.videolan.org/doc/streaming-howto/en/ch04.html">RTP multicast</a> , but the sound has a noticeable echo.  And with <a href="http://www.videolan.org/doc/streaming-howto/en/ch05.html">video on demand</a> , there is no synchronization at all, since each client receives a separate stream.  Mplayer just terribly slow, if udp sync is enabled. <br>  So, if there is no need to display video synchronously, then jack or PulseAudio are a good choice due to its flexibility.  If you need a video ... let me know if there is something really working. <br><br><h3>  Jack vs PulseAudio </h3><br>  After a long search, it turned out that there was no struggle between them: they were written for very different purposes.  I do not need very short delays and tremendous flexibility in switching threads while working in order to <b>listen to</b> music.  But I want to load less CPU and not to drive packets over the network, if nothing is played.  All I need is to turn on and off the pre-defined outputs.  Therefore, in my case, PulseAudio is the preferred choice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  PulseAudio </h3><br>  <i><b>Hint:</b> First you need to set the clock correctly.</i>  <i>If they are badly synchronized between devices, strange bugs can occur.</i>  <i>Therefore, ntpd should be installed everywhere.</i> <br>  You can set up synchronous playback in several ways.  You can use module-combine-sink with module-tunnel-sink, or you can use broadcast rtp streams.  I chose module-combine-sink, as it gives a much smaller cut.  But it does not work via WiFi, and rtp can be.  But I do not like WiFi, I love the wires. <br>  Another subtlety is that PulseAudio can work either as a system-wide daemon, or for each user separately.  The latter is the <a href="http://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/WhatIsWrongWithSystemWide/">preferred solution</a> , mainly due to security concerns, for example, so that users cannot disconnect or redirect other people's flows.  But if we are talking about a client without X11, then only system mode will remain.  And security problems ... so this is exactly what I need: a common sound server for several trusted users. <br>  If you selected the system mode, then do not forget to add yourself to the <b>pulse-access</b> group.  Configuration files are located in the / etc / pulse / directory.  For system mode, this is <b>system.pa</b> , and for user <b>default.pa</b> . <br><br><h3>  Output devices </h3><br>  These are devices to which amplifiers are connected.  They need to allow remote access, so add the module-native-protocol-tcp to the config: <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">native</span></span>-protocol-tcp auth-ip-acl=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>;192.168.0.0/16</code> </pre> <br><br><h3>  Input devices </h3><br>  On the device from which the audio stream will go, you need to configure the remote outputs.  For each output device (except for local outputs) we add the following lines: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-tunnel-sink <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=&lt;<span class="hljs-keyword"><span class="hljs-keyword">output</span></span> device address&gt;</code> </pre> <br><br>  Now you need to learn how to turn them on and off dynamically.  PulseAudio sends data even to muted channels, but does not send to the outputs that are disabled.  In order not to turn off the audio output for all applications, we will create intermediate outputs for each real output: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-combine-sink sink_name=kitchen_mpd slaves=tunnel-sink.u2k.home <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-combine-sink sink_name=hall_mpd slaves=alsa_output.usb-ESI_Audiotechnik_GmbH_Dr._DAC_nano<span class="hljs-number"><span class="hljs-number">-01</span></span>-nano.analog-stereo</code> </pre><br><br>  And, finally, combine these outputs into one: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">load</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-combine-sink sink_name=mpd_sink slaves=kitchen_mpd,hall_mpd</code> </pre><br><br>  Now, after restarting PulseAudio, you can turn on and off individual outputs with commands like this: <br><br><pre> <code class="hljs kotlin">#  pactl <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span>-sink hall_mpd <span class="hljs-number"><span class="hljs-number">1</span></span> #  pactl <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span>-sink hall_mpd <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  Hooray!  A tunable output that synchronously reproduces sound through several output devices connected via a network is ready. <br><br><h3>  Music reproduction </h3><br>  Now you need to connect any player to this output.  I chose MPD, since it can be remotely controlled from almost any device.  This is convenient when listening to music in the kitchen, and the computer is in the room.  The setup is very simple: <br><br><pre> <code class="hljs pgsql">audio_output { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> "pulse" <span class="hljs-type"><span class="hljs-type">name</span></span> "Pulse" <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> "u2.home" # optional sink "mpd_sink" }</code> </pre><br><br>  But if there are several outputs, I still want to control them via the MPD interface.  I wrote a <a href="http://yadi.sk/d/Uqp2eVBH5QmU1">small hack</a> for MPD that allows you to do this.  This is a modified NullOutput that executes arbitrary commands when turned on and off.  It remains to configure these outputs for the corresponding pactl calls and hide the main (first) output with another small hack. <br><br><pre> <code class="hljs pgsql">audio_output { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> "exec" <span class="hljs-type"><span class="hljs-type">name</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> "pactl suspend-sink hall_mpd 0" <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> "pactl suspend-sink hall_mpd 1" } audio_output { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> "exec" <span class="hljs-type"><span class="hljs-type">name</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> "/usr/bin/pactl suspend-sink kitchen_mpd 0" <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> "/usr/bin/pactl suspend-sink kitchen_mpd 1" }</code> </pre><br><br><h3>  Sharing </h3><br>  On a stationary computer, I registered in <b>/etc/pulse/client.conf</b> <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = u2.home</code> </pre> <br>  As a result, all applications are connected to a remote sound server directly.  It works flawlessly. <br><br><h2>  Problems </h2><br>  The main problem faced was unreliability.  If the network connection is lost, PulseAudio deletes the corresponding outputs and does not re-create them.  It is necessary to restart manually. <br>  Another problem is that the status of the outputs in the MPD and PulseAudio may not coincide.  You have to make a button once more to turn the sound on or off. <br><br><h2>  Virtues </h2><br>  I can listen to music at breakfast and at dinner.  Moreover, the music is well audible in most parts of the apartment and does not play softly or loudly.  Optionally, individual zones can be turned off.  To manage it is easy and simple.  In general, the cat approves: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/41d/362/3eb/41d3623ebc84303b6896a338f500917b.jpg"></div><br><br>  PS The specific combination of dr.  DAC nano and odroid U2 is not very successful.  With a high probability, this sound card will work only through a USB hub due to insufficient capacitor capacity on the VBUS at U2. </div><p>Source: <a href="https://habr.com/ru/post/181728/">https://habr.com/ru/post/181728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181708/index.html">Oil cooled housing (continued)</a></li>
<li><a href="../181710/index.html">Qt Creator 2.8.0 beta released</a></li>
<li><a href="../181712/index.html">Model-View in QML. Part zero, introductory</a></li>
<li><a href="../181714/index.html">Archive of interesting code</a></li>
<li><a href="../181718/index.html">Legendary JS-Livecoding example of Bret Victor (Bret Victor) done in Flash</a></li>
<li><a href="../181732/index.html">Google will have to disclose user data at the request of the FBI</a></li>
<li><a href="../181734/index.html">Five file managers for Android</a></li>
<li><a href="../181740/index.html">Super simple iOS JSON mapper</a></li>
<li><a href="../181744/index.html">What is a FlexPod?</a></li>
<li><a href="../181746/index.html">Implementing underscore styles in LESS via png generation in data-URI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>