<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inter-AS Option C Pitfalls on JunOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is written so to speak at the request of listeners of our radio station. When configuring Option C on JunOS, many people have the same qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inter-AS Option C Pitfalls on JunOS</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/330/441/8dc/3304418dc51847c19ed08794a93019b4.jpg" alt="image alt"></div><br>  This article is written so to speak at the request of listeners of our radio station.  When configuring Option C on JunOS, many people have the same question: why does nothing work, although everything seems to be correct?  At JunOS, things are not as trivial as at Cisco, and there may be several problems.  Let's go straight to the point: the symptoms are - you set up a session on the ASBR BGP-LU for organizing the Opt.C interface on Juniper equipment (and of course a VPNv4 session between reflectors, but there‚Äôs nothing to do with it), PE loops from different autonomous systems have PE but L3VPN doesn't work.  Let's understand why this happens and how to deal with it. <a name="habracut"></a><br><br>  Opt.C, unlike opt.B or opt.A, is not only a session between ASBRs of different autonomous systems, but a complete solution that includes a BGP-LU session between ASBRs designed to transfer routes with tags to loopbacks between autonomous systems, but the same VPNv4 session, as a rule, between reflectors of different autonomous systems, designed to transmit VPNv4 prefixes.  Inside your autonomous system, you yourself choose the method of distributing routes with labels to remote loopbacks - this can be a BGP-LU session directly with ASBR or via RR, or redistributing BGP-LU routes to IGP on ASBR.  Each approach has its pros and cons, you can read about it in my previous article describing the principle of opt.C operation.  The choice of the option is yours, but I personally like it when everything works exclusively through BGP, however I operate a network in which there are both segments where redistribution occurs and segments that use BGP exclusively. <br><br>  Let's reproduce the problem in the emulator and get to the bottom of its essence.  Take the following grid: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/af7/3e7/056/af73e70565e4415d8da35eb8fe340189.png"><br><br>  We will distribute labels obtained from eBGP-LU from a neighboring autonomous system within our local autonomy using iBGP-LU (as I wrote earlier, redistribution can also be used, but I don‚Äôt like this approach, besides, it has its own pitfall I will write further): <br><br><img src="https://habrastorage.org/web/af9/913/b18/af9913b182fb4cd09a9a172fb1ed8d07.png"><br><br>  The configuration of the joints is the same, and for RZN-ASBR1 it looks like this: <br><br><pre><code class="javascript hljs">bormoglotx@RZN-ASBR1# show protocols bgp group PE { type internal; family inet { labeled-unicast; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> NHS; neighbor <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { local-address <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; } } group ASBR { type external; family inet { labeled-unicast; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LO-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { local-address <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; peer-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>; } } [edit] bormoglotx@RZN-ASBR1# show policy-options policy-statement NHS then { next-hop self; accept; } [edit] bormoglotx@RZN-ASBR1# show policy-options policy-statement LO-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span> term Lo { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol ospf; route-filter <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; } then accept; } term Lo-local { from { protocol direct; route-filter 62.0.0.0/</span></span><span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; } then accept; } then reject;</span></span></code> </pre> <br>  For TULA-ASBR1, everything will be the same, adjusted for addressing.  The first policy is hung in the direction of local PE routers and simply changes the next-hop to itself.  The second policy is hung in the direction of the remote ASBR and is intended for exporting only routes to loopbacks to a neighboring autonomous system. <br><br>  Note: there are two terms in the policy - the first one exports lupbacks that are in igp, the second one exports its own ASBR lupback, since it is set to rib by direct protocol, not igp.  This can be done with one term, but it's more convenient for me. <br><br>  Check the state of the BGP-LU session between the RZN-ASBR1 and TULA-ASBR1: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show bgp neighbor <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Peer: <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>+<span class="hljs-number"><span class="hljs-number">179</span></span> AS <span class="hljs-number"><span class="hljs-number">71</span></span> Local: <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>+<span class="hljs-number"><span class="hljs-number">56580</span></span> AS <span class="hljs-number"><span class="hljs-number">62</span></span> Type: External State: Established Flags: &lt;Sync&gt; Last State: OpenConfirm Last Event: RecvKeepAlive Last Error: None Export: [ LO-export ] Options: &lt;Preference LocalAddress AddressFamily PeerAS Refresh&gt; Address families configured: inet-labeled-unicast Local Address: 30.0.0.0 Holdtime: 90 Preference: 170 Number of flaps: 0 Peer ID: 71.0.0.3 Local ID: 62.0.0.3 Active Holdtime: 90 Keepalive Interval: 30 Group index: 1 Peer index: 0 BFD: disabled, down Local Interface: ge-0/0/0.0 NLRI for restart configured on peer: inet-labeled-unicast NLRI advertised by peer: inet-labeled-unicast NLRI for this session: inet-labeled-unicast Peer supports Refresh capability (2) Stale routes from peer are kept for: 300 Peer does not support Restarter functionality NLRI that restart is negotiated for: inet-labeled-unicast NLRI of received end-of-rib markers: inet-labeled-unicast NLRI of all end-of-rib markers sent: inet-labeled-unicast Peer supports 4 byte AS extension (peer-as 71) Peer does not support Addpath Table inet.0 Bit: 10000 RIB State: BGP restart is complete Send state: in sync Active prefixes: 3 Received prefixes: 3 Accepted prefixes: 3 Suppressed due to damping: 0 Advertised prefixes: 3 Last traffic (seconds): Received 3 Sent 27 Checked 26 Input messages: Total 1731 Updates 7 Refreshes 0 Octets 33145 Output messages: Total 1728 Updates 3 Refreshes 0 Octets 33030 Output Queue[0]: 0</code> </pre><br>  Everything is fine, we give 3 routes and take the same.  In my case, a direct iBGP-LU session is configured between ASBR and PE, in which lupbacks are transmitted (the circuit is small and therefore there is no reflector). <br><br>  We go further.  Check out what exactly announces the RZN-ASBR1 in the next autonomous system: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">14</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">2</span></span> I * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">1</span></span> I * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self I</code> </pre> <br>  No surprises - we give only lupbacks.  Now a vpnv4 session should rise between PE routers.  Check: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bgp summary group eBGP-VPNV4 Groups: <span class="hljs-number"><span class="hljs-number">2</span></span> Peers: <span class="hljs-number"><span class="hljs-number">2</span></span> Down peers: <span class="hljs-number"><span class="hljs-number">0</span></span> Table Tot Paths Act Paths Suppressed History Damp State Pending inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Peer AS InPkt OutPkt OutQ Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped... <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> Establ bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Great, session in ap and we see that we get one route.  But the route in the routing table will not be, since its next-hop is unusable: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> hidden bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">1</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> [BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> AS path: <span class="hljs-number"><span class="hljs-number">71</span></span> I, validation-state: unverified Unusable</code> </pre> <br>  In this state, it is because there is no route to the loopback in the inet.3 table, in which bgp resolves the next hop.  To do this, enable resolve-vpn sessions on bgp-lu so that routes are set in both inet.0 and inet.3 (by default, BGP-LU routes go to the inet.0 table): <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> hidden bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">3</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) bormoglotx@RZN-PE1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">3</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> AS path: <span class="hljs-number"><span class="hljs-number">71</span></span> I, validation-state: unverified &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299968</span></span>, Push <span class="hljs-number"><span class="hljs-number">299792</span></span>(top)</code> </pre> <br>  As you can see, the route immediately disappeared from hidden and installed in the routing table. <br><br>  In theory, everything is set up, there are routes - the traffic should go: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route table TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">3</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> AS path: <span class="hljs-number"><span class="hljs-number">71</span></span> I, validation-state: unverified &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299968</span></span>, Push <span class="hljs-number"><span class="hljs-number">299792</span></span>(top) bormoglotx@RZN-PE1&gt; ping routing-instance TEST1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes ..... --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">0</span></span> packets received, <span class="hljs-number"><span class="hljs-number">100</span></span>% packet loss</code> </pre> <br>  But in fact we get an epic fail - nothing worked for us.  Moreover, the connectivity between the loopbacks of PE routers is: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; ping source <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">9.564</span></span>/<span class="hljs-number"><span class="hljs-number">13.021</span></span>/<span class="hljs-number"><span class="hljs-number">16.509</span></span>/<span class="hljs-number"><span class="hljs-number">2.846</span></span> ms</code> </pre> <br>  Let's figure out what's wrong.  To do this, you have to check what intermediate routers do with labels. <br><br>  So, RZN-PE1 is pushing three tags: Push 16, Push 299968, Push 299792 (top).  Label 299792 is needed to get to RZN-ASBR1, label 299968 is the label that RZN-ASBR1 generated for the prefix 71.0.0.1 (TULA-PE1) and label 16 is the vpnv4 label. <br><br>  The top label in the stack is the label 299792, and the RZN-P1 router is working with it, receiving a transit mpls packet ‚Äî it does not look at the next label on the stack.  We will check what RZN-P1 should do by receiving a packet with the above label: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-P1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299792</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> destinations, <span class="hljs-number"><span class="hljs-number">8</span></span> routes (<span class="hljs-number"><span class="hljs-number">8</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299792</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299792</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop</code> </pre> <br>  Everything is logical, since RZN-P1 is the penultimate router in the LSP to RZN-ASBR1, it removes the top label (PHP) and then sends a packet with two tags to the ASBR.  That is, on the RZN-ASBR1, a packet arrives with a top tag on the 299968 stack: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299968</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">14</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299968</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">300000</span></span></code> </pre> <br>  There is also no crime here - as it should be, a swap of this tag occurs and the transfer in the direction of TULA-ASBR1. <br><br>  Now we move to the next autonomous system and see what will be done with the received TULA-ASB1 package: <br><br><pre> <code class="javascript hljs">bormoglotx@TULA-ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">300000</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">14</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">300000</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">300000</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop</code> </pre> <br>  TULA-ASBR1 removes the top tag and sends traffic to the side of the TULA-P1 packet with just one tag - tag 16, which is a vpnv4 tag.  This is our problem - TULA-P1 does not know about such a label and just drops the package (and if it knows label 16, it will be the label of some other service and traffic will be dropped only a little later): <br><br><pre> <code class="javascript hljs">bormoglotx@TULA-P1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">16</span></span> bormoglotx@TULA-P1&gt;</code> </pre> <br>  Why is this happening?  The fact is, which route is taken as the basis for generating tags through the BGP-LU session.  By default, the inet.0 table is used for the labeled-unicast session ‚Äî it sets up the received routes and sends routes from it.  With this, IGP routes are taken as the basis for generating routes to loopbacks (since they are the best in inet.0), in our case these are the ospf routes.  As you know, IGP routes do not have MPLS tags, so when returning a route through a BGP-LU session, the TULA-ASBR1 router recorded in the routing table that the label must be removed and the packet sent through some specific interface (in our case, the packet with one tagged - the router does not know that there will be another one under the top tag - it will not go there).  That is, we simply do not have two LSPs stitched together.  The essence of the above is shown in the figure below: <br><br><img src="https://habrastorage.org/web/e19/918/180/e199181807e745628b5007ad953889a1.gif"><br><br>  But why then ping to remote PE passes?  It's simple - when the PE router sends an icmp request, it does not hang the vpnv4 tag - the packet comes with a stack of two tags (well, either one if you use redistribution).  The traffic still arrives on the ASBR of the remote autonomous system (in our case, on the TULA-ASBR1), as we found out, the label is removed and the bare ip traffic goes through the P router, which is in the same IGP domain with the destination host and knows the route to it (although TULA-P1 does not know the reverse route, but this does not prevent it from forwarding traffic).  That is, it works like this: <br><br><img src="https://habrastorage.org/web/a7a/754/8c7/a7a7548c7de24c4187ca22ce27054001.gif"><br><br>  There are several ways to solve this problem.  Let's start with the mpls protocol traffic engineering options.  This is not the engineering traffic that you thought about (I think the word RSVP came to mind).  There are 4 engineering traffic options: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1# set protocols mpls traffic-engineering ? Possible completions: bgp BGP destinations only bgp-igp BGP and IGP destinations bgp-igp-both-ribs BGP and IGP destinations <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> both routing tables mpls-forwarding Use MPLS routes <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> forwarding, not routing</code> </pre> <br>  <b>The bgp</b> option is the default option, it forces the router to install the ldp and rsvp routes into the inet.3 table and therefore only bgp has access to these routes (the next-hop resolver for the VPNv4 \ L2-signaling \ EVPN routes).  But I draw your attention to the fact that BGP-LU routes will fall into inet.0, and not into inet.3. <br><br>  <b>Bgp-igp</b> option ‚Äî this option causes the router to install the rsvp and ldp routes in the inet.0 table, and in this case inet.3 will become empty.  If your ASBR is used as a PE for terminating L3VPN, then you should be aware that they will stop working without crutches.  Another side effect - routing ‚Äúbreaks down‚Äù. <br><br>  <b>The bgp-igp-both-ribs</b> option ‚Äî this option causes the router to install the ldp and rsvp routes both in the inet.0 table and in the inet table.3.  The side effect is similar to the previous option - routing ‚Äúbreaks down‚Äù, but L3VPN will work. <br><br>  <b>The mpls-forwarding</b> option ‚Äî this option forces the router to copy routes from inet.3 to inet.0, but these routes will only be available for forwarding.  There will be no changes in the inet.3 table.  A side effect - traffic that previously went through ip (for example, bgp sessions to remote lupbacks) will now go on mpls (although this is probably more plus than minus - depending on which side to look). <br><br>  These options should be used with caution, especially the second and third.  Both of these options break routing ‚Äî since ldp and rsvp routes appear in the inet.0 table, in which usually the main igp protocol is isis or ospf.  But now igp routes will become lower priority due to their large protocol preference in comparison with label distribution protocols.  Routing breaks down, which means that if you‚Äôve seen the route to which loopback via ospf / isis as the best, before turning on the option, then now ldp / rsvp routes will take its place.  If you in some export policy set the condition from ospf for example, then now this condition will not be met with all the consequences ... The second option, as I indicated above, is also dangerous because the inet.3 table becomes empty.  Keep this in mind.  But the mpls-forwarding option is just what we need.  When it is turned on, routes from inet.3 will be simply copied to inet.0, but only for forwarding - that is, now the traffic will not flow through ip, but through mpls. <br><br>  It is important to understand that none of these options generate new LSPs ‚Äî simply existing LSPs are copied (or transferred) to inet.0.  Using these options (meaning the 2nd, 3rd and 4th options in the list), you allow the router to use its LSPs not only for forwarding L2 / 3VPN traffic, as well as regular traffic (if between points that they want to exchange this traffic, there is LSP - well, for example, these points are Lupbek routers), which usually runs with a clean IP. <br><br>  Enable this option and check what happens.  As you remember, earlier TUAL-ASBR1 announced the 300000 label and made a pop label instead of swap.  After enabling this option, labels will be regenerated: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> detail inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">16</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) Accepted Route Label: <span class="hljs-number"><span class="hljs-number">300080</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> MED: <span class="hljs-number"><span class="hljs-number">2</span></span> AS path: <span class="hljs-number"><span class="hljs-number">71</span></span> I</code> </pre> <br>  Now TULA-ASBR1 announces the label 300080 to us. Let's see what the router will do with the transit packet with this label: <br><br><pre> <code class="javascript hljs">bormoglotx@TULA-ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">300080</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span> destinations, <span class="hljs-number"><span class="hljs-number">18</span></span> routes (<span class="hljs-number"><span class="hljs-number">18</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">300080</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">299776</span></span></code> </pre> <br>  Now everything is as it should - swap tags are happening - our LSPs are now stapled.  And this is what happens with the inet.0 routing table: <br><br><pre> <code class="javascript hljs">bormoglotx@TULA-ASBR1&gt; show route table inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">16</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) @ = Routing Use Only, # = Forwarding Use Only + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> @[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> #[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> @[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> #[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[Direct/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> &gt; via lo0<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  New routes appeared in the table.  Now for forwarding, we use LSP (LDP \ RSVP route marked with #), and for routing all the same IGP routes (which are now marked @).  I would like to note that now the routes towards the neighboring ASBR, as previously, are generated from ospf routes that do not have tags.  But since we now use the LDP route for forwarding, the router will not make a pop label but a swap. <br><br>  Well, check that the L3VPN is wound up: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; ping routing-instance TEST1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">6.861</span></span>/<span class="hljs-number"><span class="hljs-number">16.084</span></span>/<span class="hljs-number"><span class="hljs-number">47.210</span></span>/<span class="hljs-number"><span class="hljs-number">15.596</span></span> ms</code> </pre> <br>  In case you will do redistribution in igp on ASBR: <br><br><img src="https://habrastorage.org/web/e0f/f58/817/e0ff5881720e4c0db232f0674329238a.png"><br><br>  then you will need to make an egress-policy for the ldp protocol in order for the ASBR to generate labels for the received prefixes and distribute them within the network.  By default, JunOS generates a label only for its loopback, as well as to routes with tags received via ldp, in contrast to the same Cisco, so there is no such problem on Cisco equipment (but without this, there are enough problems there). <br><br>  On RZN-ASBR-1, I exported routes received via bgp to ospf (there is no bgp LU between PE and ASBR now): <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> destinations, <span class="hljs-number"><span class="hljs-number">14</span></span> routes (<span class="hljs-number"><span class="hljs-number">14</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> I * <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> I * <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> I</code> </pre> <br>  According to the export policy, these routes go to ospf: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show configuration protocols ospf <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> OSPF-EXPORT; area <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span> { passive; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { interface-type p2p; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> { passive; } } bormoglotx@RZN-ASBR1&gt; show configuration policy-options policy-statement OSPF-EXPORT term Remote-Lo { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { route-filter <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; } then accept; } then reject;</span></span></code> </pre> <br>  Routes obtained from the neighboring autonomous system fall into the ospf database as external and are further distributed within the igp domain: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show ospf database OSPF database, Area <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Type ID Adv Rtr Seq Age Opt Cksum Len Router <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">0x80000016</span></span> <span class="hljs-number"><span class="hljs-number">2576</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0xf0fb</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> Router <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">0x80000017</span></span> <span class="hljs-number"><span class="hljs-number">2575</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0xf57b</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> Router *<span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0x8000001a</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0xd2dd</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> OSPF AS SCOPE link state database Type ID Adv Rtr Seq Age Opt Cksum Len Extern *<span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0x80000001</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0x2afc</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span> Extern *<span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0x80000001</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0x1611</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span> Extern *<span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">0x80000001</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">0x22</span></span> <span class="hljs-number"><span class="hljs-number">0x225</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span></code> </pre> <br>  Check on RZN-PE1 route availability: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span> destinations, <span class="hljs-number"><span class="hljs-number">13</span></span> routes (<span class="hljs-number"><span class="hljs-number">13</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">150</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span>, tag <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre> <br>  The route is only in the inet.0 table, but in order for bgp to integrate the route into the bgp.l3vpn.0 table, you must have lsp to the next-hop in the inet.3 table.  Now the inet.3 table does not have a route to the prefix 71.0.0.1/32.  There is no route, since ldp does not generate labels for these prefixes. <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show ldp database Input label database, <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">-62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> Label Prefix <span class="hljs-number"><span class="hljs-number">299776</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">299792</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Output label database, <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">-62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> Label Prefix <span class="hljs-number"><span class="hljs-number">300640</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">300656</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span></code> </pre> <br>  In order for lsp to appear, you need to make egress-policy for ldp on RZN-ASBR1, in which you specify that for the prefixes from the range 71.0.0.0/24, you need to generate tags: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show configuration protocols ldp egress-policy LDP-EXPORT; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>; bormoglotx@RZN-ASBR1&gt; show configuration policy-options policy-statement LDP-EXPORT term Local-Lo { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { route-filter <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> exact; } then accept; } term Remote-Lo { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { route-filter <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; } then accept; }</span></span></code> </pre> <br>  Be careful with the egress-policy for the LDP, because most of the time when it is configured for the first time, the engineer gets an empty inet.3.  Those prefixes that you specify in the policy will be announced via LDP, but then the router will assume that it is the source for all these FECs and simply will not install them in inet.3 (since local FECs in inet.3 are not installed - default). the local FEC on JunOS is its own loopback and ldp is why there‚Äôs no need to build lsp to itself).  In the above policy, in the first term I give my own lubpek; in the second term, the lupbacks of the neighboring autonomy, obtained via bgp.  If you want to install ASBR routes from another autonomy in inet.3.  then the session in the direction of the neighboring autonomous system must add the option resolve-vpn: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show configuration protocols bgp group ASBR type external; family inet { labeled-unicast { resolve-vpn; } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LO-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { local-address <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; peer-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>; }</code> </pre> <br>  Now labels will be generated for prefixes from the range 71.0.0.0/24: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show ldp database Input label database, <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">-62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> Label Prefix <span class="hljs-number"><span class="hljs-number">299776</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">299792</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">299952</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">299968</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">299984</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Output label database, <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">-62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> Label Prefix <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">300704</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">300720</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">300736</span></span> <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span></code> </pre> <br>  After the data manipulation on RZN-PE1 in inet.3, a route should appear to the loops of the neighboring autonomous system and, as a result, a connection should appear inside L3VPN: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span> destinations, <span class="hljs-number"><span class="hljs-number">13</span></span> routes (<span class="hljs-number"><span class="hljs-number">13</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">150</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>, metric <span class="hljs-number"><span class="hljs-number">2</span></span>, tag <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> destinations, <span class="hljs-number"><span class="hljs-number">5</span></span> routes (<span class="hljs-number"><span class="hljs-number">5</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299952</span></span> bormoglotx@RZN-PE1&gt; ping routing-instance TEST1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">7.054</span></span>/<span class="hljs-number"><span class="hljs-number">11.118</span></span>/<span class="hljs-number"><span class="hljs-number">21.571</span></span>/<span class="hljs-number"><span class="hljs-number">5.493</span></span> ms</code> </pre> <br>  We considered the first solution to the problem.  We now turn to the second. <br><br>  As I said earlier, by default labeled-unicat routes are installed and sent from the inet.0 table, in which, by default, there are no routes with tags.  We can force the router to send and receive routes from the inet table.3.  This is done like this: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1# show protocols bgp group ASBR type external; family inet { labeled-unicast { rib { inet<span class="hljs-number"><span class="hljs-number">.3</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LO-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { local-address <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; peer-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>; }</code> </pre> <br>  Note: the import in the policy should not specify the igp protocol, since ospf / isis routes are not in the inet table.3 <br><br>  Now let's see what we give to the neighboring autonomous system: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">1</span></span> I * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">1</span></span> I</code> </pre> <br>  Only two routes, but before there were three.  The route to yourself is not given (to the RZN-ASBR1 loopback).  Why - it is easy to understand, if you search for your lubek in the inet.3 table: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route table inet<span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> bormoglotx@RZN-ASBR1&gt;</code> </pre> <br>  Since the local FEC is not installed in inet.3, it is logical that there is no route.  In order for our loopback to be given, we need to copy it from the inet.0 table to the inet table.  For this you need to make a rib-group and hang it on the interface-routes: <br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show configuration | compare rollback <span class="hljs-number"><span class="hljs-number">4</span></span> [edit routing-options] + interface-routes { + rib-group inet inet<span class="hljs-number"><span class="hljs-number">.0</span></span>&gt;&gt;&gt;inet<span class="hljs-number"><span class="hljs-number">.3</span></span>-Local-Lo; + } + rib-groups { + inet<span class="hljs-number"><span class="hljs-number">.0</span></span>&gt;&gt;&gt;inet<span class="hljs-number"><span class="hljs-number">.3</span></span>-Local-Lo { + <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-rib [ inet<span class="hljs-number"><span class="hljs-number">.0</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span> ]; + <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-policy Local-Lo; + } + } [edit policy-options] + policy-statement Local-Lo { + term Lo { + <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { + protocol direct; + route-filter <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; + } + then accept; + } + then reject; + }</span></span></code> </pre> <br>  So this line: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-rib [ inet<span class="hljs-number"><span class="hljs-number">.0</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span> ]</code> </pre> <br>  tells us that the routes from the inet.0 table need to be copied to the inet.3 table.  But this line <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-policy Local-Lo</code> </pre> <br>  applies a policy to this import so as not to copy all routes.  Well, in the end this rib-group needs to be screwed.  Since we copy the direct route, we fasten it to interface-routes. <br><br>  After such manipulations, the route to the loopback will be accessed in the inet.3 table (but, as in inet.0, it will be installed into the table not by the ldp / rsvp protocol, but by the direct channel): <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-ASBR1# run show route <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> table inet<span class="hljs-number"><span class="hljs-number">.3</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> destinations, <span class="hljs-number"><span class="hljs-number">5</span></span> routes (<span class="hljs-number"><span class="hljs-number">5</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[Direct/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> &gt; via lo0<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  We can check whether we are now giving our Lupback to the neighboring autonomous unit: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> destinations, <span class="hljs-number"><span class="hljs-number">5</span></span> routes (<span class="hljs-number"><span class="hljs-number">5</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">1</span></span> I * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">1</span></span> I * <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self I</code> </pre> <br>  One problem solved.  But there is a second problem: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show route table TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> destinations, <span class="hljs-number"><span class="hljs-number">2</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[Direct/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span> &gt; via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[Local/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span> Local via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5.0</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now there are no routes in L3VPN to the neighboring autonomous system, since bgp peering between PE routers lies: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bgp summary group eBGP-VPNV4 Groups: <span class="hljs-number"><span class="hljs-number">2</span></span> Peers: <span class="hljs-number"><span class="hljs-number">2</span></span> Down peers: <span class="hljs-number"><span class="hljs-number">1</span></span> Table Tot Paths Act Paths Suppressed History Damp State Pending inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Peer AS InPkt OutPkt OutQ Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped... <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> <span class="hljs-number"><span class="hljs-number">179</span></span> <span class="hljs-number"><span class="hljs-number">183</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Active</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact is that the routes on the ASBR are in the inet.3 table, and the label-unicast session with remote PEs is built from inet.0, and naturally nothing is given on the PE. </font><font style="vertical-align: inherit;">To do this, you need to make another rib-group on the ASBR and transfer the routes from inet.3 to inet.0:</font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-ASBR1# show routing-options rib-groups inet<span class="hljs-number"><span class="hljs-number">.3</span></span>&gt;&gt;&gt;inet<span class="hljs-number"><span class="hljs-number">.0</span></span>-Remote-Lo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-rib [ inet<span class="hljs-number"><span class="hljs-number">.3</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-policy Remote-Lo; [edit] bormoglotx@RZN-ASBR1# show policy-options policy-statement Remote-Lo term Lo { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { route-filter <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-regexp"><span class="hljs-regexp">/32; } then accept; } then reject;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And fasten it to our BGP session, in which we receive these routes: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-ASBR1# show protocols bgp group ASBR type external; family inet { labeled-unicast { rib-group inet<span class="hljs-number"><span class="hljs-number">.3</span></span>&gt;&gt;&gt;inet<span class="hljs-number"><span class="hljs-number">.0</span></span>-Remote-Lo; rib { inet<span class="hljs-number"><span class="hljs-number">.3</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LO-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { local-address <span class="hljs-number"><span class="hljs-number">30.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; peer-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A similar configuration must be made on the second ASBR, if you and there have redistribution in igp, after which the routes to the remote loopbacks will be installed in the routing table on the PE and eBGP vpnv4 session will rise (no one forbids doing redistribution in one autonomous system, but the second is to use BGP exclusively - the choice is only for network administrators): </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bgp summary group eBGP-VPNV4 Groups: <span class="hljs-number"><span class="hljs-number">2</span></span> Peers: <span class="hljs-number"><span class="hljs-number">2</span></span> Down peers: <span class="hljs-number"><span class="hljs-number">0</span></span> Table Tot Paths Act Paths Suppressed History Damp State Pending inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Peer AS InPkt OutPkt OutQ Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped... <span class="hljs-number"><span class="hljs-number">71.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> <span class="hljs-number"><span class="hljs-number">189</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> Establ bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> TEST1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now you can check the connectivity inside L3VPN: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; ping routing-instance TEST1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">4.332</span></span>/<span class="hljs-number"><span class="hljs-number">37.029</span></span>/<span class="hljs-number"><span class="hljs-number">83.503</span></span>/<span class="hljs-number"><span class="hljs-number">29.868</span></span> ms</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, I think that there will be fewer issues with setting opt.C on JunOS. </font><font style="vertical-align: inherit;">But if someone has any questions - write in the comments, well, or to me in a telegram.</font></font><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/336486/">https://habr.com/ru/post/336486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336474/index.html">Work and life in Bulgaria</a></li>
<li><a href="../336476/index.html">Desktop GUI tests in Python. Lecture in Yandex</a></li>
<li><a href="../336478/index.html">We sharpen a tool on PyQt</a></li>
<li><a href="../336480/index.html">Solving the direct and dual problems of linear programming with Python</a></li>
<li><a href="../336482/index.html">Migrate the VueJS application to Vuex</a></li>
<li><a href="../336488/index.html">The digest of interesting materials for the mobile developer # 218 (August 21 - August 27)</a></li>
<li><a href="../336490/index.html">I'm too busy to do anything</a></li>
<li><a href="../336492/index.html">ggplot2: how to easily combine multiple graphs in one, part 1</a></li>
<li><a href="../336494/index.html">Quick registration of image focal points using big-vote</a></li>
<li><a href="../336496/index.html">Architectural Pyramid Applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>