<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PIC16F1503. Wheelbarrow for pumping - 1. Sound</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think every parent has such a moment when he discovers a child with something in the store at the checkout counter, and the child claims that this i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PIC16F1503. Wheelbarrow for pumping - 1. Sound</h1><div class="post__text post__text-html js-mediator-article">  I think every parent has such a moment when he discovers a child with <i>something</i> in the store at the checkout counter, and the child claims that this is <i>something</i> very important for the whole world on earth and for him in particular.  So I have this happened again.  On the move, having estimated the cost of this <i>neht</i> , the parental toad gave up and decided that we once lived and still could not make all the money.  Reason also appreciated the speed of dying of this <i>dumb</i> and also gave the go-ahead. <br><br>  As a result, the children's car park has been replenished with such a miracle of Chinese engineering.  Jeep, with a "chandelier" and a winch! <br><br><img src="https://habrastorage.org/files/bd5/3ee/98e/bd53ee98e7ac4bc492b13f3027af8f1a.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Miracle skillfully blink "chandelier" and "headlights" and loudly produce three recorded sounds.  According to all canons, the machine ‚Äúdied‚Äù pretty quickly and was brought in for repair.  I refused to take the car for repairs, citing the refusal with unwashed hands and half-eaten dinner.  Plus, the Chinese somehow managed to squeeze a couple of extra decibels out of this machine at a frequency resonating with my skull (my teeth ached), so I didn‚Äôt smile at all to re-experience the same sensations. <br><br>  As a result of long negotiations, it was decided that a simple battery change is no longer fashionable.  After all, all real drivers tyunyut their cars in special studios, after which they drive cars that no one else has.  So I took the car to the studio "All Mine" for tuning ... <br><a name="habracut"></a><br>  What is the first thing to do?  That's right, estimate how much work has fallen on us.  We disassemble the car. <br><br><img src="https://habrastorage.org/files/b9b/72a/b13/b9b72ab13558416b91ca7e1483788dfb.jpg"><br>  Inside there are three LEDs (blue, bright, cheap), a squeaker and an unknown boxless microcontroller of the ‚ÄúChinese snot‚Äù class.  All this is powered by 3 LR4 batteries (capacity in the region of 20 mAh), so it is not surprising that the car died so quickly.  All this splendor is triggered by a button, which, in the best traditions of the Chinese automotive industry, seizes and bites. <br><br>  In general, here it is necessary to change everything.  Or almost everything.  For what? <br><br>  Of course, I would not mind sticking the STM32F4 inside, but the estimated board wouldn‚Äôt get inside, but it‚Äôs really lazy to plant <i>a</i> printed circuit board <i>under it</i> .  Rummaging in the boxes, I found a demo card on the PIC16F1503.  Up to 16 megahertz, 3 kilobytes of flash and already 128 bytes of memory.  The most it for cars! <br><br>  <i>If you wish to repeat my exercises, then you need to look for according to PIC-H1503 (this is the microcontroller itself) and PIC-KIT3 (this is a programmer) from Olimex.</i>  <i>It will also be necessary to download and install MPLAB X Ide and XC8 from microlab.</i>  <i>Unlike OT, Windows, Linux and OS X are supported.</i> <br><br>  How to start tuning?  That's right, let's start with the sound.  Louder we do not need, we need to be screaming "in a police manner" and not loudly. <br><br>  We get out of the machine "pishchalku" and try to understand what it is.  Not finding any identification marks, we cling to the ohmmeter.  Ohmmeter shows 15 Ohms.  So, microdynamic: if an ohmmeter showed a "break", then this is a piezo squeaker. <br><br>  Connecting the speaker directly to the microprocessor's foot is meaningless (15 ohm at 3 volts will give a current of 200mA, which the microcontroller, which is 20 over the eyes), obviously, so we make a simple circuit on the first NPN transistor. <br><br><img src="https://habrastorage.org/files/f24/20b/785/f2420b785431473a9c3d72a0e516982e.png"><br><br>  Ratings are almost not important.  Plus or minus from the scheme will bring almost no changes.  Why the capacitor on the circuit, I will explain later (in principle, you can stick and parallel to the transistor).  The input is connected to the 9th leg of the microcontroller. <br><br>  Now it remains to understand how we extract the sound.  From a school course in physics, we know that sound is the vibration of air.  And the speaker translates the fluctuations of electricity into vibrations of air.  So we need to shake the speaker.  But the speaker is connected directly to the microcontroller, and he can only give out ‚Äú1‚Äù (on the leg) and ‚Äú0‚Äù (there is nothing).  Yes, even (even? Yes, this is rare) this microcontroller has a 5-bit DAC (audiophiles trudge from one-bit, if that. Smail), but this is not sports. <br><br>  Physics saves us again: even if applying ‚Äú1‚Äù to the speaker, the magnet will not instantly pull up the diffuser, as after ‚Äú0‚Äù it will not let go of it instantly. <br><br>  The simplest thing is to write code like this. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { dinamikON(); pause(<span class="hljs-number"><span class="hljs-number">1</span></span>); dinamikOFF(); pause(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><br>  If pauses are counted in milliseconds, then in dynamics we will get a ‚Äúsqueak‚Äù of 500 Hz.  And changing the duration of the pauses, you can get quite a decent sound.  What is the problem?  The problem is that we will need to be constantly distracted by the "hooting". <br><br>  But in any decent microcontroller there is such a thing as PWM, it is PWM (what is it? Easily searched in the same wikipedia, with pictures and long explanations).  There is it in peak.  Open MPLAB, create a new project and use the Code Configurator (Tools-Embedded menu. It may be necessary to first put in the Plugins) add a new PWM. <br><br><img src="https://habrastorage.org/files/27a/4b6/583/27a4b6583cb84c20bca5f37fcf89e336.png"><br><br>  I took the PWM4 solely because of the convenience of the legs.  Since PWM in peak cannot do without a timer, let's look at it. <br><br><img src="https://habrastorage.org/files/0e6/ca9/036/0e6ca903636d41fd9f820c32bdbfaece.png"><br><br>  Since nothing is clear yet, just click on ‚ÄúGenerate Code‚Äù and try to run the result.  As usual, nothing should happen - there is no program.  <i>If you got an error about VDD, then in the Run-Project Configuration-PICKit3-Power check the box next to Power target Circuit.</i>  <i>It is just possible to program the boards ‚Äúin operation‚Äù, and the current from the programmer is not always enough to power the circuit.</i> <br><br>  We collect the first code.  Everything is done in main.c, where I divided the blocks with comments. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> count; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(count=<span class="hljs-number"><span class="hljs-number">0</span></span>; count&lt;<span class="hljs-number"><span class="hljs-number">1024</span></span>; count++) { PWM4_LoadDutyValue(count); __delay_ms(<span class="hljs-number"><span class="hljs-number">10</span></span>); }</code> </pre><br><br>  We download and connect the oscilloscope with one input to the output of the microcontroller (blue line) and the other to the dynamics (red). <br><br><img src="//habrastorage.org/files/e55/8f1/6fd/e558f16fd86140afa30b9f5758f9cab1.gif"><br><br>  So, what do we see?  The blue line is the result of the work of SHIM.  Fill from 0 to 100% and jump back to zero.  But the red line somewhere in the middle of the filling is remotely similar to a sine wave.  Frankly, this distance is obtained by hooking a 0.47 microfarad capacitor parallel to the transistor, for a beautiful gif.  The real picture can be seen below. <br><br>  Remove the capacitor. <br><img src="//habrastorage.org/files/ac8/200/e67/ac8200e676704e3aa207fc3b8505481b.png"><br>  See the spikes on red?  This speaker on the "reverse" works as a generator and easily throws a whole volt when powered from 3x.  In principle, under certain conditions, it is easy to burn the scheme.  But these peaks do not bother anyone, so it‚Äôs up to you to put a conder or not.  I set for the sake of beauty. <br><br>  Put again.  It already was, but this picture is static. <br><img src="//habrastorage.org/files/0f0/656/3d9/0f06563d95194912ac30d24db9646f70.png"><br>  Let's replace by 0.1 ŒºF.  Just to compare and display the effect of capacitance on the sound :) <br><img src="//habrastorage.org/files/c42/37a/b97/c4237ab976dc4d41b7cf87899b302f44.png"><br><br>  In principle, we have already received a squeak of 15 kilohertz, but who needs it, except for mosquitoes?  So you need to turn the frequency.  The frequency of the PWM depends on the timer, and how often the timer will ‚Äútick‚Äù depends on the counter that is set each time the timer starts. <br><br>  That is, the timer operation algorithm looks like this <br>  <i>- We start the timer.</i> <i><br></i>  <i>- The timer ticked and reduced the counter.</i> <i><br></i>  <i>- Counter at zero?</i>  <i>If not, then tick again.</i>  <i>If so, generate an interrupt.</i> <i><br><br></i>  <i>Interrupt Handler:</i> <i><br></i>  <i>- Oh!</i>  <i>The timer has ticked!</i> <i><br></i>  <i>- Reset timer again</i> <i><br></i> <br><br>  And here is the launch of PWM just as we hooked up to interrupt the timer.  And we can turn both the frequency of the ‚Äútick entry‚Äù (prescaler in the settings) and the counter value. <br><br>  Change the code (it is stage2) <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> count; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(count=<span class="hljs-number"><span class="hljs-number">0</span></span>;count&lt;<span class="hljs-number"><span class="hljs-number">256</span></span>;count++) { PWM4_LoadDutyValue(count*<span class="hljs-number"><span class="hljs-number">2</span></span>); TMR2_LoadPeriodRegister(count); __delay_ms(<span class="hljs-number"><span class="hljs-number">100</span></span>); }</code> </pre><br><img src="//habrastorage.org/files/2b0/eb3/108/2b0eb3108f6340b6ba6dc83bb86fab55.gif"><br><br>  We look at the beautiful red line and see that it turns out something distant to a sinusoid, and that varies in frequency.  Yes, and confirms the ear.  What we need! <br><br>  <i>Why do I change the filling of SHIM, I propose to think independently.</i>  <i>But in principle, if you mentally continue the schedule and slow down the change in one parameter, then everything becomes clear.</i>  <i>Those who are especially advanced can see a similar picture in some emulator, for example proteus</i> <br><br>  Let's now determine which frequency range we got <br><br>  Nailing the count at 255 <br><img src="//habrastorage.org/files/fd6/bf0/7cb/fd6bf07cb101457db7b9ab6b3724cb36.png"><br>  And now we put in 10 <br><img src="//habrastorage.org/files/d53/eff/8d4/d53eff8d48bc41a4b258dc1406e7559d.png"><br><br>  Pay attention to the upper right corner where the grid step is indicated.  I have "by eye" turned out the range of about 300-5000Hz.  Full  And on the skull "ride" will not.  <i>Perfectionists can use a frequency meter, or calculate the real value from the clock frequency and prescalers.</i> <br><br>  But then I have problems.  I don't have any understanding how <i>it</i> should sound.  Roughly speaking, in the music of the Chukchi reader, but not a writer. <br><br>  With difficulty I found what frequencies correspond to which notes, I found some musical notation ‚Äúa Christmas tree was born‚Äù ... <br><br>  I calculated the delay, wrote <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> do 243 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//523Hz #define re 239 //587 #define mi 236 //659 #define fa 231 //739 #define sol 229 //783 #define la 224 //880 #define si 218 //987 // and again +523Hz const uint8_t elka[29]={do,la,la,sol,la,fa,do,do,do,la,la,si,sol,do,do,re,re,si,si,si,la,sol,fa,do,la,la,sol,la,fa}; void play(uint8_t p) { // 255 - 3ms period - 300Hz // 10 - 0,2ms - 5000Hz PWM4_LoadDutyValue(p*2); TMR2_LoadPeriodRegister(p); } .... uint8_t count; for (count = 0; count &lt; 29; count++) { play(elka[count]); __delay_ms(300); PWM4_LoadDutyValue(0); TMR2_LoadPeriodRegister(0); __delay_ms(50); }</span></span></span></span></code> </pre><br><br>  Compiled, launched.  No, the melody is guessed without problems, but it's not like that.  By selecting resistors and capacitors, he achieved an ‚Äúalmost sinusoid-saw‚Äù at the exit, but the ear can hear the difference. <br><br>  As a result, I stopped at the usual two-tone signal: ‚Äúhigh-low‚Äù.  The classic ‚Äúwow wow‚Äù policeman, known to everyone from Hollywood films, didn‚Äôt work out for me.  And Google in response to the ‚Äúpolice sirene tones code program example‚Äù gives out anything, just not what is needed. <br><br>  <b><i>Help, pliz?</i></b>  <b><i>In what sequence does the chuck go there?</i></b> <br><br>  In principle, we have already come to the fact that the next step is to take and reproduce the usual wav.  That is not to suffer with tones and other things.  Just record the sound, translate it into a digestible form and lose.  As did various ScreamTrackers in due time. <br><br>  There is only one problem: half a second of PCM audio, mono, with 8 kHz sampling takes about kilobytes.  And I have only three and a half kilobytes.  Will not go.  But you can familiarize yourself with the principles and examples by simply typing google ‚Äúpic pcm sound‚Äù.  And right from the first link there will be both the source code and the programs themselves. <br><br>  Therefore, we are comforted by the fact that we will have a real, ‚Äúwarm tube sound from those times‚Äù for which the programmer‚Äôs attention is not needed: he said what frequency to scribble and went to do his own business, and there the hardware will do everything themselves. <br><br>  But sound is half the battle.  <a href="http://habrahabr.ru/post/250229/">Good light is also the hallmark of real tuning</a> :) But this is a bit later. <br><br>  As usual, ready projects for MPLAB with all the pieces can be <a href="">collected here.</a> </div><p>Source: <a href="https://habr.com/ru/post/250123/">https://habr.com/ru/post/250123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250109/index.html">Why you need to update your SSL certificates</a></li>
<li><a href="../250113/index.html">IT spring in Minsk</a></li>
<li><a href="../250115/index.html">Automate and speed up the process of setting up cloud servers with Ansible. Part 2: output, debug, and reuse the playbook</a></li>
<li><a href="../250117/index.html">ANT +</a></li>
<li><a href="../250121/index.html">Books for "pumping" the brain</a></li>
<li><a href="../250125/index.html">Trends 2015: 5 ways to put the API to serve the business</a></li>
<li><a href="../250127/index.html">Differentiation of information systems in the protection of personal data</a></li>
<li><a href="../250129/index.html">Use SVG (Part One)</a></li>
<li><a href="../250135/index.html">Thoughts</a></li>
<li><a href="../250137/index.html">Creating a view with an animated property change</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>