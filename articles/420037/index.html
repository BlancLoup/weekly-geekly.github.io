<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stream with several cameras made from scrap materials</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the fact that, with the help of OBS Studio and some program for animating desktop wallpapers, they made a videologue from the logo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stream with several cameras made from scrap materials</h1><div class="post__text post__text-html js-mediator-article"><p>  It all started with the fact that, with the help of <a href="https://obsproject.com/download">OBS Studio</a> and some program for animating desktop wallpapers, they made a videologue from the logo (which also animated under the current playing music).  At that moment, I realized that OBS Studio can MUCH more than just stream games.  After a closer acquaintance with OBS Studio, she claims to be the coolest program <a href="https://github.com/Himura2la/awesome-soft">I've ever met</a> . </p><br><p>  I had to stream a small event for friends, but since I have the equipment for good sound and the desire to do cool, I was puzzled by the organization of the stream with a separate sound and several cameras.  Stream for various reasons turned out to be so myself, but after this experience, I would seem to imagine how it should be.  And I want to share.  Here it is. </p><br><p><img src="https://habrastorage.org/webt/n3/v1/yk/n3v1yk3isu110pqfjrr6qojtnbu.png"></p><a name="habracut"></a><br><h1 id="chto">  What? </h1><br><p>  The idea is to find 2-3 wireless operators who go to different venues of the event, communicate with people, shoot traffic, etc.  (well, like serious guys, in short).  And someone is sitting, communicating with them on the radio, and from all of this (and something else, for example, all kinds of windows / monitors / projectors of restraint) forms interesting video content that is not boring to watch. </p><br><p>  It is also possible to combine the screens of several computers into one stream, perhaps this may be useful for games.  Although most likely specifically for this task there are other technologies. </p><br><h1 id="zachem">  What for? </h1><br><p>  Because it allows you to do very cool and greatly shift the technological ceiling of the quality of the stream almost for nothing. </p><br><p>  When using heaps of video streams, the coolness of the stream will be determined by the creative and organizational component (well, the quality of the connections). </p><br><h1 id="chem">  Than? </h1><br><ol><li>  Nout <br>  1.1.  <a href="https://obsproject.com/download">OBS Studio</a> <br>  1.2.  <a href="https://www.nginx.com/">nginx</a> with <a href="https://en.wikipedia.org/wiki/Real-Time_Messaging_Protocol">RTMP</a> <a href="https://github.com/arut/nginx-rtmp-module">module</a> </li><li>  Operators with their smartphones <br>  2.1.  Any application from the "stream rtmp" request, for example <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.wmspanel.larix_broadcaster">Larix Broadcaster</a> , or (if you have some extra money) <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.dev47apps.screenstream">Ace Live Streaming</a> or <a href="https://play.google.com/store/apps/details%3Fid%3Dro.numedecod.cast">BitStream</a> </li><li>  Stable Wi-Fi, preferably 5GHz </li><li>  Stable <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB_%25D1%2581%25D0%25B2%25D1%258F%25D0%25B7%25D0%25B8_%25D0%25B2_%25D1%258D%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8">uplink</a> </li></ol><br><p>  If there is something else, you can make a good sound, at least on stationary cameras (which can be any relatively high-quality webcam). </p><br><p>  And if there is another computer on Linux (they say, even Raspberry Pi is ok for ‚â§3 threads), you can slightly unload the main computer and its network to process and send the stream. </p><br><h1 id="kak">  How? </h1><br><p>  Conventional protocol for video streaming - <a href="https://en.wikipedia.org/wiki/Real-Time_Messaging_Protocol">RTMP</a> .  Attempts to use <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.pas.webcam">something else</a> lead to wild lags, it was my main mistake. </p><br><blockquote>  In fairness, it is worth noting the proprietary technology <a href="https://www.newtek.com/ndi/">NewTek NDI</a> (thanks, <a href="https://habr.com/users/alexsey/" class="user_link">Alexsey</a> ), which is kind of cooler than RTMP.  However, for our juz-case, the use of NDI <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.newtek.ndicamera">will require a</a> lot of extra money. </blockquote><p>  It turns out that taking an RTMP stream and redirecting it to OBS Studio is a snap.  You just need to compile nginx with a custom module and write the config.  But more about that later. </p><br><p>  In an amicable way, you have to do something like this: </p><br><p><img src="https://habrastorage.org/webt/6b/l3/1t/6bl31ti2fcwnsz97hov5jdvkaee.png"></p><br><p>  That is, do not give mobile phones the Internet so that they do not spend resources on anything other than stream. <br>  But if a good Wi-Fi with the Internet is already there (and there is no extra access point on 5GHz), then you can not disdain and use existing connections.  However, it is still desirable to send the final stream from another connection, or, in extreme cases, from the same, but through a wire. </p><br><p>  If there is a need to receive streams from cameras and send the final stream through the same Wi-Fi, carefully test stability (and note that it will decrease greatly if a crowd of devices get into this Wi-Fi). </p><br><h2 id="kak-podnyat-rtmp-server">  How to raise the RTMP server? </h2><br><p>  It is better to do this on Linux, so as not to have problems with all sorts of MINGW / MSYS.  And on a separate hardware (not necessarily powerful).  Either in docker, then you can skip this section, because <a href="https://github.com/arut/nginx-rtmp-module/wiki/Building-a-docker-image-with-nginx---rtmp-module">there is already a pre-file</a> .  It is also possible through <a href="https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux">WSL</a> , but it will be necessary to manually forward TCP port 1935 in the firewall. </p><br><p>  Here's a great manual: a <a href="https://obsproject.com/forum/resources/how-to-set-up-your-own-private-rtmp-server-using-nginx.50/">RTMP server using nginx</a> , and the <a href="https://github.com/arut/nginx-rtmp-module/wiki/Getting-started-with-nginx-rtmp">dock is</a> also validly written.  A brief retelling in freestyle: </p><br><ol><li><p>  We put dependences: </p><br><pre><code class="bash hljs">sudo apt install build-essential libpcre3 libpcre3-dev libssl-dev</code> </pre> <br></li><li><p>  We download the latest Mainline version of the source <a href="http://nginx.org/en/download.html">from here</a> : </p><br><pre> <code class="bash hljs">wget http://nginx.org/download/nginx-1.15.2.tar.gz <span class="hljs-comment"><span class="hljs-comment"># Check for newer versions tar xzf nginx-* &amp;&amp; cd !$</span></span></code> </pre> <br></li><li><p>  Downloading the latest version of the <a href="http://nginx-rtmp.blogspot.com/">RTMP module</a> : </p><br><pre> <code class="bash hljs">wget https://github.com/arut/nginx-rtmp-module/archive/master.zip -O rtmp-module.zip unzip !$ -d .</code> </pre> <br></li><li><p>  Create a Makefile: </p><br><pre> <code class="bash hljs">./configure --with-http_ssl_module --add-module=./nginx-rtmp-module-master</code> </pre> <br><p>  If it falls down before reaching the <code>Configuration summary</code> , we fix the problems. <br>  This command will set up your streamer nginx live in <code>/usr/local/nginx/</code> and run with the command <code>sudo /usr/local/nginx/sbin/nginx</code> .  Thus, nginx from the repository will not feel anything.  This can be changed by examining <code>./configure --help</code> . </p><br></li><li><p>  Compile: </p><br><pre> <code class="bash hljs">make -j4</code> </pre> <br></li><li><p>  Install: </p><br><pre> <code class="plaintext hljs">echo "nginx with RTMP module" &gt; description-pak sudo checkinstall --pkgname nginx-rtmp --provides nginx --nodoc --deldesc -y sudo mkdir /usr/local/nginx/logs/ # Doesn't start without it</code> </pre> <br><p>  In principle, through <code>make install</code> is safe in this case, but still <a href="https://habr.com/post/130868/">not necessary</a> . </p><br></li><li><p>  Check </p><br><pre> <code class="bash hljs">$ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx -v nginx version: nginx/1.15.2</code> </pre> <br></li><li><p>  Customize </p><br><pre> <code class="bash hljs">sudo vim /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/conf/nginx.conf</code> </pre> <br><p>  At the end we add the config of the RTMP server: </p><br><pre> <code class="plaintext hljs">rtmp { server { listen 1935; application live { live on; record off; } } }</code> </pre> <br><p>  If desired, you can <a href="https://github.com/arut/nginx-rtmp-module/wiki/Getting-started-with-nginx-rtmp">configure the HTTP server to display statistics</a> . <br>  The <a href="https://github.com/arut/nginx-rtmp-module/wiki/Directives">dock</a> describes what else can be customized, there really is a lot of things.  If you know how to do better, I will be happy to add a section about server configuration with material from comments. </p><br></li><li><p>  Make it convenient </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> rtmp-start=<span class="hljs-string"><span class="hljs-string">"sudo /usr/local/nginx/sbin/nginx"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> rtmp-stop=<span class="hljs-string"><span class="hljs-string">"sudo /usr/local/nginx/sbin/nginx -s stop"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> rtmp-status=<span class="hljs-string"><span class="hljs-string">"cat /usr/local/nginx/logs/nginx.pid"</span></span></code> </pre> <br></li></ol><br><h2 id="chto-delat-s-rtmp-serverom">  What to do with the RTMP server? </h2><br><ol><li><p>  Send a stream from the mobile app to <code>rtmp://&lt;  IP&gt;:1935/live/habr</code> where <code>live</code> is the name of the RTMP application in the nginx config, and <code>habr</code> is the <strong>Stream Key</strong> , which needs to be changed for different cameras. </p><br></li><li><p>  If you have <a href="https://github.com/arut/nginx-rtmp-module/wiki/Getting-started-with-nginx-rtmp">configured the display of statistics</a> (and did not forget to change the path to the <code>stat.xsl</code> file), check that the stream came (at <a href="http://localhost:8080/stat">http: // localhost: 8080 / stat</a> ). </p><br></li><li><p>  Connect to all streams OBS Studio. </p><br><p><img src="https://habrastorage.org/webt/tp/ee/d0/tpeed09aq4pycyoiwonubpfhuxc.png"></p><br><p><img src="https://habrastorage.org/webt/hx/rc/fz/hxrcfzlcv8lzmhwzawckz64bu5a.png"></p><br></li><li><p>  PROFIT !!! </p><br></li></ol><br><p>  Obviously, the server can be not only local, but also accessible from the external one, which will allow you to do the same, but not via Wi-Fi, but via the Internet.  You can make your analog of Instagram group streams, well, in general, limitless possibilities)) </p><br><h1 id="vsyo">  Everything? </h1><br><p>  There are a couple of things that I learned from mistakes and would like to share: </p><br><ol><li>  It is possible and necessary to change the target bitrate of the final stream in the course of the broadcast, and adapt to the connectivity.  Restream, for example, draws cool graphs that make it clear how much to lower.  There is a <a href="https://github.com/obsproject/obs-studio/pull/1086">pull request to auto bitrate</a> , but it stalled (( </li><li>  There is such a parameter <strong>Keyframe Interval</strong> , and it must be greater than a second (this must be manually set in the <strong>Advanced</strong> versions of the <strong>Output</strong> settings).  Restream talks about this only after the end of the stream, the UX is on top!  )) </li><li>  There is another <a href="https://github.com/obsproject/obs-studio/pull/1253">extremely useful Pull Request</a> , in which I participated, and for which I actively drown, but it also looks stalled, although the maintener recently remembered and rethought about it.  Like, pliz, if it seems to you too that the absence of the <strong>Monitor</strong> button on the audio channels is awful. </li></ol><br><p>  Now everything is exactly, thank you for your attention ^ _ ^ </p><br><h1 id="ps">  PS </h1><br><p>  For those who try to still knock out nginx for the ubiquitous Venda, here‚Äôs the rake I walked through, it still turned out to be a quest, I was not afraid of this process in vain: </p><br><ul><li>  It is necessary to take the source code EXACTLY from Mercurial (it‚Äôs good that there is a "download zip" button), there is no <code>src\os\win32</code> folder in the archives from the site.  If you have the source from the site, there will be an error <code>don't know how to make 'src/os/win32/ngx_win32_config.h'</code> . </li><li>  Need ancient mingw <a href="http://www.mingw.org/wiki/Getting_Started">from here</a> and not <del>  a little less ancient </del>  MSYS2. </li><li>  When installing the <code>mingw-developer-toolkit</code> you need to uncheck the Perl checkbox.  Perl has to be screw. </li><li>  <a href="https://stackoverflow.com/a/22649559/3399377">This answer</a> helped a lot. </li><li>  When compiling, use <code>rc.exe</code> from <code>%ProgramFiles(x86)%\Windows Kits\10\bin\10.0.16299.0\x64</code> , you need to add this folder manually in PATH </li><li>  It is necessary to remove the <code>-WX</code> flag from <code>CFLAGS</code> in the Makefile so that the vornings do not interrupt the compilation, there are vornings in 1.15.3 ... </li></ul><br><p>  So I did something like this: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cmd: "%ProgramFiles(x86)%\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" #cmd: set PATH=%PATH%;%ProgramFiles(x86)%\Windows Kits\10\bin\10.0.16299.0\x64 #cmd: C:\MinGW\msys\1.0\msys.bat #bash: cd nginx-1.15.3 ./auto/configure \ --with-cc=cl \ --with-debug \ --prefix= \ --conf-path=conf/nginx.conf \ --pid-path=logs/nginx.pid \ --http-log-path=logs/access.log \ --error-log-path=logs/error.log \ --sbin-path=nginx.exe \ --http-client-body-temp-path=temp/client_body_temp \ --http-proxy-temp-path=temp/proxy_temp \ --http-fastcgi-temp-path=temp/fastcgi_temp \ --http-scgi-temp-path=temp/scgi_temp \ --http-uwsgi-temp-path=temp/uwsgi_temp \ --with-cc-opt=-DFD_SETSIZE=1024 \ --with-pcre=objs/lib/pcre-8.42 \ --with-zlib=objs/lib/zlib-1.2.11 \ --with-openssl=objs/lib/openssl-1.1.1 \ --with-openssl-opt=no-asm \ --with-select_module \ --with-http_ssl_module \ --add-module=nginx-rtmp-module-master nmake</span></span></code> </pre> <br><p>  <a href="https://drive.google.com/open%3Fid%3D1GrfNWagKtAuCKDHyvXBbJG41VUqBrUTk">nginx-1.15.3-rtmp-win32.7z</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/420037/">https://habr.com/ru/post/420037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420025/index.html">Smart farm. What will it be?</a></li>
<li><a href="../420029/index.html">As we in 1C: Enterprise, we solve systems of algebraic equations</a></li>
<li><a href="../420031/index.html">Drawing with Render Targets in the Unreal Engine</a></li>
<li><a href="../420033/index.html">How we started registering cash desks for our clients</a></li>
<li><a href="../420035/index.html">GUI on Golang: GTK + 3</a></li>
<li><a href="../420041/index.html">War of TypeScript or Conquest of Enum</a></li>
<li><a href="../420045/index.html">Bunker for the date: how I was allowed to walk on the data center RUVDS on the territory of the space plant</a></li>
<li><a href="../420049/index.html">The book "The Man Talking. Evolution and language "</a></li>
<li><a href="../420051/index.html">[DotNetBook] Span, Memory and ReadOnlyMemory</a></li>
<li><a href="../420053/index.html">Veeam Academy for C # Developers: New Season</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>