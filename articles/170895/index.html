<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks for the smallest. Part Seven. VPN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All issues  8. Networks for the smallest. Part Eight BGP and IP SLA 
 7. Networks for the smallest. Part Seven. VPN 
 6. Networks for the smallest. Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks for the smallest. Part Seven. VPN</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">All issues</b> <div class="spoiler_text">  <a href="http://linkmeup.ru/blog/65.html">8. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/65.html">Part Eight</a>  <a href="http://linkmeup.ru/blog/65.html">BGP and IP SLA</a> <br>  <a href="http://linkmeup.ru/blog/50.html">7. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/50.html">Part Seven.</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br>  <a href="http://linkmeup.ru/blog/33.html">6. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/33.html">Part six.</a>  <a href="http://linkmeup.ru/blog/33.html">Dynamic routing</a> <br>  <a href="http://linkmeup.ru/blog/16.html">5. Networks for the smallest: Part Five.</a>  <a href="http://linkmeup.ru/blog/16.html">NAT and ACL</a> <br>  <a href="http://linkmeup.ru/blog/15.html">4. Networks for the smallest: Part Four.</a>  <a href="http://linkmeup.ru/blog/15.html">STP</a> <br>  <a href="http://linkmeup.ru/blog/14.html">3. Networks for the smallest: Part Three.</a>  <a href="http://linkmeup.ru/blog/14.html">Static routing</a> <br>  <a href="http://linkmeup.ru/blog/13.html">2. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a>  <a href="http://linkmeup.ru/blog/13.html">Switching</a> <br>  <a href="http://linkmeup.ru/blog/12.html">1. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a>  <a href="http://linkmeup.ru/blog/12.html">Connection to the equipment cisco</a> <br>  <a href="http://linkmeup.ru/blog/11.html">0. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/11.html">Part zero.</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div><br><br>  Buying plants in Siberia was a strategic decision for Lift mi Am.  After the elevators began to drive not only up but also down, the company‚Äôs business went ... no, it flew up.  Elevators began to disassemble, like hot cakes from the table.  The name no longer corresponded to reality and the decision on rebranding was made.  ( <i>In fact, they were tortured by a lawsuit with Mobi</i> ). <br>  So, it is planned to take factories in Novosibirsk, Tomsk and Brno under LinkMiAp's wing.  It's time to think about how this farm is connected to the existing network. <br><br>  So, today we are considering <br>  1) Possible connection options, their pros and cons <br>  2) Site-to-Site VPN based on GRE and IPSec <br>  3) Big topic: Dynamic Multipoint Virtual Network (DMVPN) in theory and practice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In traditional video, only a succinct squeeze out of an article dedicated to the work and configuration of DMVPN. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/e6l02YjMcbw%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253&amp;usg=ALkJrhi2qTrnWc3a9x3nhx-7Fqcb-XWZ7A" frameborder="0" allowfullscreen=""></iframe><a name="habracut"></a><br><br>  When you want to link several offices, you have a huge selection of ways and means.  It all depends on your capabilities, abilities, desires and the availability of equipment. <br><br>  Let's take it in order. <br><br>  <b>A</b> ) personally build a physical channel.  Then it can be: <br><ol><li>  Ethernet - twisted pair.  Up to 100 meters.  Maximum over the building or between adjacent buildings.  Speed ‚Äã‚Äãup to 1 Gbit / s (Strictly speaking, there is a standard 10GBASE-T, which allows data to be transmitted at a speed of 10 Gbit / s at the same distance). </li><li>  Wifi  The distance depends on the implementation: it is possible to achieve a 40 km operation with powerful directional antennas.  On average, up to 5 km with direct visibility.  The speed depends on the standard used and the distance.  It is necessary to register in ‚ÄúRoskomnadzor‚Äù, and, at high radiation powers, obtain permission for switching on. </li><li>  xDSL - two to four wires.  The speed depends on the distance (theoretical maximum 250 Mbit / s, distance up to 6 km).  Although there are rumors about the development of a standard 1Gb / c on two wires. <br>  Or solutions like E1. <br><blockquote>  There is no connection to the Internet through xDSL, namely the link: modem modem.  Yes, and such solutions <a href="http://eucariot.livejournal.com/64323.html">exist</a> .  You can call it a bridge. <br></blockquote><br></li><li>  Radio Relay Lines.  Distance up to several tens of kilometers.  Speed ‚Äã‚Äãup to 600 Mb / s.  But this solution is already of an operator level, since it requires a lot of approvals and arrangements for planning, construction, commissioning. </li><li>  Optical fiber.  1 Gb / s (solutions for 10 and 100 Gb / s may cost unreasonably expensive).  The distance depends on many factors: from several kilometers to hundreds.  Coordination of cable laying, qualified personnel for construction and maintenance are required.  For small companies, it only makes sense to connect the building not very far from the central hub.  In general, of course, each case is individual and requires calculation. </li></ol><br><br>  In this case, everything is transparent for you - you use your own physical line, so you can pass anything through it without restrictions. <br><br>  <b>B) The</b> second option is to rent the channel from the provider.  In the case of the need for a stable channel to another city - this is the most common and reliable option.  The provider can provide you with the following services: <br><br><ol><li> The most genuine straight cable.  For example, he may loan you one or two <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2591%25D0%25BC%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B2%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25BD%25D0%25BE">dark</a> fibers from his optical beam.  You are free to send him everything your heart desires.  On the part of the provider, this is in no way controlled, not limited, it provides only support.  For example, in the event of an accident, you will not have to look for a contractor and a welding machine, but as a provider.  And for the simple it is responsible.  If this is not your mutual agreement (read, netting), then perhaps the most expensive way. </li><li>  L2VPN.  You can also allow anything to the channel, but in this case, your traffic will go through the active equipment of the provider, so it can be limited, for example, by speed. <br>  This term means several second-level services: <br>  VLAN - in one form or another, a branch VLAN is provided to you. <br>  A <a href="">pseudo cable</a> ( <a href="">PWE3</a> ) is a Point-to-Point service when you have a cable between two nodes.  All frames transmitted by you are delivered without changes to the remote point.  Similarly, the opposite way.  This is possible due to the fact that your frame coming to the provider's router is encapsulated in a higher-level <a href="http://en.wikipedia.org/wiki/Protocol_data_unit">PDU</a> , as a rule, this is an MPLS packet. <br>  VPLS ( <a href="http://en.wikipedia.org/wiki/Virtual_Private_LAN_Service">Virtual Private Network</a> ) is a simulation of a local network.  In this case, the entire network provider for you will be like a kind of abstract giant switch.  Like the present, it will store the table of MAC addresses and decide on where to send the incoming frame.  This is also implemented by encapsulating the frame into an MPLS packet. </li><li>  L3VPN.  In this case, the provider's network is like a big router with several interfaces.  That is, the joint at you will occur at the network level.  You configure the IP addresses on your routers on both sides, but routing in the provider's network is already the headache of the provider.  The IP addresses for the junction points can either be determined by you or provide by the provider - it depends on the implementation and on your agreement.  It can function on the basis of GRE, IPSec or the same MPLS. </li></ol><br><br>  This service looks very simple from the point of view of the client - both in terms of customization and in terms of implementation - but difficult - from the point of view of the operator. <br>  We will deal with the implementation of L2 / L3 VPN based on MPLS, but much later. <br><br>  <b>B)</b> Well, the last option: a tunnel through a public network.  Suppose you have Internet access at both your points.  Often the cheapest way is to build a tunnel between these two points.  To do this, you just need to have white (public) static addresses on all points (and sometimes enough on one) and the equipment on which to implement it.  This solution has a number of shortcomings, which we will consider below, but nevertheless, we will stop on it today. <br><br>  So, your will to choose which option to use, based on the budget, feasibility, and your ability to persuade leadership. <br>  As part of this release, we need to connect 3 offices: in Novosibirsk, Tomsk and Brno.  We agree that everywhere we will only use the Internet connection. <br><br>  Connection scheme of hub and spoke nodes - in Russian, the star: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3e/742/667/b3e7426672469a02b95d58a6f26f736b.png"><br><br>  I remind you that the general scheme of the LinkMiAp network now looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd0/c6f/943/fd0c6f943b1d3631436379de673876eb.png"><br><br>  But we abstract from it, pushing only on essential things. <br><br>  Since we decided to implement option B, we will have to sort out the options in detail. <br>  Today, there are an innumerable set of all kinds of applications and protocols for organizing a VPN, but most of them are ways to connect hosts, not networks.  We mean remote work.  For example: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f2/e25/91d/0f2e2591da76a3c7e79a37025b8133f5.jpg"><img src="https://habrastorage.org/getpro/habr/post_images/da6/13a/5c2/da613a5c2854dfbdb91bba33e8308bad.jpg"><br><br>  That is, this is the work scheme when one employee connects to the corporate network remotely (teleworker in Cisco terminology). <br><br>  Frankly, we are not very interesting, much more interesting question, how to connect entire networks. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df7/83f/faf/df783ffafe15bc725ef380d532a9f958.jpg"><br><br>  Today we consider the most common options: <br><ul><li>  GRE </li><li>  IPSec (tunnel and transport modes) </li><li>  GRE over IPSec </li><li>  VTI </li><li>  DMVN </li></ul><br><h1>  GRE </h1><br>  Generic Routing Encapsulation is a very simple tunneling protocol. <br>  Taxi <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2583%25D0%25BD%25D0%25BD%25D0%25B5%25D0%25BB%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8)">tunneling</a> .  What is this beast?  Roughly speaking, this means that your original data is taken along with service headers (usually IP, but maybe Ethernet and ATM), packed in a packet and transmitted over a public network, as if the car is traveling through a tunnel through the mountains.  On the end node, the headers of the new package are removed, and your data in its original form continues its journey. <br>  Not very clear, yes?  Let us consider an example with GRE. <br><br>  For now, take the abstract topology: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc1/e35/b5c/fc1e35b5c1e9c377d11018aa78ee3d02.jpg"><br><br>  Two routers are connected to the Internet through static white addresses.  On each of them private networks from a range of 10.0.0.0/8 are set up. <br>  Of course, these networks are not routed on the Internet.  (The picture shows a computer and a laptop, but in practice we will configure the virtual interface Loopback0) <br>  Our task is to run a tunnel: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71a/5c6/7a7/71a5c67a7edf1289f88d811f78466cd0.png"><br><br>  Thus, for PC1, when communicating with PC2, there is no Internet - both of them will think that they are on the same local network. <br><br>  The GRE tunnel is configured as follows: <br><blockquote>  interface Tunnel0 <br>  ip address 10.2.2.1 255.255.255.252 <br></blockquote><br>  Since the tunnel is a virtual L3 interface, through which we will have routing, it must be assigned an IP address, which is selected according to your IP plan, probably from a private network. <br><br>  You can select the source address as the IP address of the output interface. <br>  (white address provided by the provider) and its name (FE0 / 0 in our case): <br><blockquote>  tunnel source 100.0.0.1 <br></blockquote><br>  The destination address is the public address of the remote side: <br><blockquote>  tunnel destination 200.0.0.1 <br></blockquote><br>  Finished view: <br><blockquote>  interface Tunnel0 <br>  ip address 10.2.2.1 255.255.255.252 <br>  tunnel source 100.0.0.1 <br>  tunnel destination 200.0.0.1 <br></blockquote><br>  Immediately after this, the tunnel should rise: <br><br><blockquote>  R1 # sh int tun 0 <br>  <b>Tunnel0 is up, line protocol is up</b> <br>  Hardware is tunnel <br>  Internet address is 10.2.2.1/30 <br>  <b>MTU 1514 bytes</b> , BW 9 Kbit, DLY 500000 usec, <br>  reliability 255/255, txload 1/255, rxload 1/255 <br>  Encapsulation TUNNEL, loopback not set <br>  Keepalive not set <br>  <b>Tunnel source 100.0.0.1, destination 200.0.0.1</b> <b><br></b>  <b>Tunnel protocol / transport GRE / IP</b> <br></blockquote><br><br>  All basic information is reflected here.  Pay attention to the size of the MTU - it is not 1500, as it is for ordinary physical interfaces.  We'll talk about the MTU parameter at the end of the article. <br><br><blockquote>  By default, GRE does not check the availability of the destination address and immediately sends a tunnel to Up.  But one has only to add a <b>keepalive X</b> command to the tunnel interface, as the router starts sending Kipalaiva and does not rise until there is an answer. <br></blockquote><br><br>  In our test scheme as a local network, we simply set up Loopback interfaces - they are always in Up.  Gave them addresses with a mask / 32.  Actually, they mean the real subnets of your enterprise (well, like in the picture). <br><blockquote>  interface Loopback0 <br>  ip address 10.0.0.0 255.255.255.255 <br></blockquote><br>  On the router, you should have two static routes: <br><blockquote>  ip route 0.0.0.0 0.0.0.0 100.0.0.2 <br>  ip route 10.1.1.0 255.255.255.255 10.2.2.2 <br></blockquote><br>  The first one says that the default gateway is the provider address 100.0.0.2: <br><br><blockquote><br>  R1 # traceroute 200.0.0.1 <br>  Type escape sequence to abort. <br>  Tracing the route to 200.0.0.1 <br>  <b>1,100.0.0.2</b> 56 msec 48 msec 36 msec <br>  2,200.0.0.1 64 msec * 60 msec <br></blockquote><br><br>  The second one forwards packets addressed to the host with the address 10.1.1.0, to the next-hop 10.2.2.2 - this is the tunnel address on the reverse side. <br><br>  GRE tunnels are unidirectional, and the reverse tunnel is usually implied on the other side, although generally speaking, this is not necessary.  But in our case, when the Internet is in the middle, and the task is to organize a private network, on the reverse side there should be a symmetrical setting: <br><br>  nsk-obsea-gw1: <br><blockquote>  interface Tunnel0 <br>  ip address 10.2.2.2 255.255.255.252 <br>  tunnel source 200.0.0.1 <br>  tunnel destination 100.0.0.1 <br><br>  ip route 0.0.0.0 0.0.0.0 200.0.0.2 <br>  ip route 10.0.0.0 255.255.255.255 10.2.2.1 <br></blockquote><br>  We try to run ping: <br><br><blockquote><br>  R1 # ping 10.1.1.0 source 10.0.0.0 <br>  Type escape sequence to abort. <br>  Sending 5, 100-byte ICMP Echos to 10.1.1.0, timeout is 2 seconds: <br>  !!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 44/71/136 ms <br><br>  R1 # tracer 10.1.1.0 <br>  Type escape sequence to abort. <br>  Tracing the route to 10.1.1.0 <br>  1 10.2.2.2 68 msec * 80 msec <br></blockquote><br><br>  Sumptuously!  But what happens behind the scenes? <br>  And there, guys, amazing things: <br><br>  When you start ping 10.1.1.0, what does the router do? <br>  1) Generates an IP packet :: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/457/206/422/457206422ead3d82ba5f5cf5f5f01706.png"><br><br>  2) Looks at the routing table <br><br><blockquote><br>  R1 # sh ip route 10.1.1.0 <br>  Routing entry for 10.1.1.0/32 <br>  Known via "static", distance 1, metric 0 <br>  Routing Descriptor Blocks: <br>  * <b>10.2.2.2</b> <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br><br>  Further recursively looks, where the address 10.2.2.2: <br><br><blockquote><br>  R1 # sh ip rou 10.2.2.2 <br>  Routing entry for 10.2.2.0/30 <br>  Known via "connected", distance 0, metric 0 (connected, via interface) <br>  Routing Descriptor Blocks: <br>  * <b>directly connected, via Tunnel0</b> <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br><br>  Thaxss, Tunnel 0: <br><br><blockquote><br>  R1 # sh int tun 0 <br>  Tunnel0 is up, line protocol is up <br>  Hardware is tunnel <br>  Internet address is 10.2.2.1/30 <br>  MTU 1514 bytes, BW 9 Kbit, DLY 500000 usec, <br>  reliability 255/255, txload 1/255, rxload 1/255 <br>  Encapsulation TUNNEL, loopback not set <br>  Keepalive not set <br>  <b>Tunnel source 100.0.0.1, destination 200.0.0.1</b> <br></blockquote><br><br>  3) Realizing that this is a GRE tunnel, adds a GRE header to the packet: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/544/229/c83/544229c836d27c6310e01c1491f50378.png"><br><br>  And on top of the new heading IR.  The address of the tunnel source will appear as the sender, and the destination will be the destination. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d68/7aa/054/d687aa054815f9bd873d097871722377.png"><br><br>  4) The new package is sent to the brave world via the default route: <br><br><blockquote><br>  R1 # sh ip route <br>  Gateway of last resort is 100.0.0.2 to network 0.0.0.0 <br></blockquote><br><br>  5) Do not forget about the Ethernet header, when sending it to the provider, it must also be formed. <br><br>  Since the GRE tunnel is a Layer 3 virtual interface, it does not have its own MAC address (like Loopback, for example).  Finally, the frame will leave the FastEthernet0 / 0 physical interface: <br><br><blockquote>  R1 # sh ip route 100.0.0.2 <br>  Routing entry for 100.0.0.0/30 <br>  Known via "connected", distance 0, metric 0 (connected, via interface) <br>  Routing Descriptor Blocks: <br>  * <b>directly connected, via FastEthernet0 / 0</b> <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br><br>  Accordingly, he will indicate his address as a Source MAC. <br><br><blockquote>  R1 # sh int <br>  FastEthernet0 / 0 is up, line protocol is up <br>  Hardware is Gt96k FE, address is <b>c000.25a0.0000</b> (bia c000.25a0.0000) <br>  Internet address is 100.0.0.1/30 <br></blockquote><br><br>  Destination is traditionally taken from the ARP cache or obtained using an ARP request from the address 100.0.0.2: <br><blockquote>  R1 # show arp <br>  Protocol Address Age (min) Hardware Addr Type Interface <br>  Internet 100.0.0.1 - c000.25a0.0000 ARPA FastEthernet0 / 0 <br>  Internet 100.0.0.2 71 <b>c001.25a0.0000</b> ARPA FastEthernet0 / 0 <br></blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/eeb/049/8f5/eeb0498f514880aff50fb4232bcf6b71.png"><br><br>  6) And in this form, the new IP packet is transmitted to the Internet.  And since each router does not strip a packet, but makes a decision based on the first IP header, no one on the Internet will know that your private addresses 10.1.1.0 and 10.0.0.0 are hidden somewhere inside. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f64/d04/0da/f64d040da352b244cf5f9a0bf739d71e.jpg"><br><br>  7) And finally stays at the destination. <br>  R3 discovers that the destination address belongs to him, removes the IP header and what does he find under it?  GRE header. <br><br>  It checks that it does have such a GRE tunnel, removes the GRE header, and then it is the most common IP packet that you need to dispose of according to the entries in the routing table. <br><br>  In this case, transfer Loopback 0 to the interface. <br><br><blockquote>  R3 # sh ip route 10.1.1.0 <br>  Routing entry for 10.1.1.0/32 <br>  Known via "connected", distance 0, metric 0 (connected, via interface) <br>  Routing Descriptor Blocks: <br>  * <b>directly connected, via Loopback0</b> <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br><br>  Here are some simple manipulations. <br>  While the packet is on the local network, it looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/a97/307/33a/a9730733a74555d990cbdef2403ecd91.png"><br>  and processed on the basis of private addresses. <br>  As soon as it enters the public network, GRE places an additional IP header on it: <br><img src="https://habrastorage.org/getpro/habr/post_images/4b3/af5/5a8/4b3af55a8bf8d248b315d50317ce5ea7.png"><br>  and the packet is processed based on public addresses. <br><br>  Here‚Äôs what the package looks like on the Internet: <br><img src="https://habrastorage.org/getpro/habr/post_images/53f/1f2/6ce/53f1f26cecb26224e43607ec3a14f8fe.png"><br>  1 - initial data <br>  2 - first IP header (internal) <br>  3 - GRE header (indicating that IP data is inside) <br>  4 - new IP header (external, with tunnel addresses) <br><br>  Ordinary ICMP messaging may look like <a href="">this</a> on a closer look <a href="">.</a> <br><br>  <a href="https://docs.google.com/document/d/17ah5yg5n5vO-zyM_ALHZ1kKZ5u4fJ-xDXZPKtnlJQZ0/pub">Complete router configuration for GRE</a> . <br><br>  If you try to draw analogies with a tangible world, then imagine a situation when you are driving from the village, encapsulated in a car.  You reach the river, and you need to move to the other side and continue your journey there to the city. <br>  At the river port, your car is encapsulated in a ferry and transported through the surging waves to the other side, where your car is removed and you continue to move.  So this ferry was a GRE-ferry. <br><br><blockquote>  We make three remarks: <br>  First, we chose Loopback interfaces and masked addresses / 32 simply for the test, in fact, it could well be interfaces fa1 / 0.15 and fa0 / 1.16 with subnets 172.16.15.0/24 and 172.16.16.0/24, for example, or any others. <br>  Secondly, we are all talking about public networks and addresses, but in fact, of course, it doesn‚Äôt matter and the tunnels can be lifted even inside our corporate network, when the final networks already have IP connectivity without a tunnel. <br>  Thirdly, despite the fact that theoretically the traffic can return back and not through the tunnel, it is necessary to create it so that the end node can successfully decapsulate GRE packets <br></blockquote><br><br>  The usual GRE is a vivid example of tunneling that is very easy to configure and relatively easy to troubleshoot. <br>  Obviously, you already guess what three big problems lurk in this field? <br><ul><li>  Security.  The data encapsulated in GRE is transmitted nonetheless in the clear. </li><li>  The difficulty of scaling.  If you have 5-7 branches, the maintenance of such a number of tunnels still seems possible, and if there are 50 of them?  Moreover, traffic tunneling is often performed on the CPU, especially on the younger and middle lines, so this is an extra load on the processor. </li><li>  All branches will interact with each other through the central site, although they could directly. </li></ul><br><h1>  Ipsec </h1><br>  The first problem voiced above is designed to solve encryption. <br><br>  Now for the organization of an encrypted VPN-channel, the following technologies are mainly used: IPSec (IP Security), OpenVPN and PPTP (Point-to-Point Tunneling Protocol). <br><br>  The undisputed leader, of course, is IPSec, and we'll talk about it. <br><br>  First you need to understand that IPSec is not a protocol, it is a standard that includes as many as three protocols, each with its own functions: <br><ol><li>  <b>ESP</b> (Encapsulating Security Payload - secure payload encapsulation) deals directly with data encryption, and can also provide source authentication and data integrity checks. </li><li>  <b>AH</b> (Authentication Header) is responsible for authenticating the source and checking the integrity of the data. </li><li>  <b>The IKE</b> (Internet Key Exchange protocol) is used to form the IPSec SA (Security Association, more on this below), in other words, to negotiate the work of participants in a secure connection.  Using this protocol, the participants agree on what encryption algorithm will be used, what algorithm will be used (and whether there will be any at all) integrity checking, how to authenticate each other </li></ol><br><br>  Before moving on, let's deal with the term SA - Security Association.  SA is generally a set of secure connection parameters (for example, an encryption algorithm, an encryption key) that can be used by both sides of the connection.  Each compound has an <i>associated</i> SA. <br>  Now, in order, how to create a secure connection in IPSec: <br><ul><li>  To begin with, the participants need to agree on what algorithms / protection mechanisms they will use for their secure connection, so IKE comes into play.  The process consists of two phases: <br><ul><li>  Phase one: the participants authenticate each other and agree on the settings for setting up a special connection (also secure) intended only for exchanging information about the desired / supported encryption algorithms and other details of the future IPSec tunnel.  The parameters of this mini-tunnel (correctly called the ISAKMP Tunnel) are determined by the ISAKMP policy, the editing mode of which we can get from the configuration mode <b>using the crypto isakmp policy <i>policy_number</i></b> .  If the parties agree, an ISAKMP tunnel is established (its presence can be viewed with the <b>show crypto isakmp sa command</b> ), through which the second phase of IKE already passes. </li><li>  Phase two: those already trusting each other agree on how to build the main tunnel for the data.  They take turns offering each other the options specified in the <b>crypto ipsec transform-set command</b> , and, if they come to an agreement, raise the main tunnel.  It must be said that, after its establishment, the auxiliary ISAKMP tunnel does not disappear anywhere - it is used to update the main SA.  The fact is that the keys chosen for encrypting information in the IPSec tunnel have a certain ‚Äúlifetime‚Äù (can be expressed both in the number of bytes and in seconds - that the former will reach the threshold value), after which they must be replaced.  This is like a password that you change once per hour (the default lifetime IPSec SA is 4,608,000 kilobytes / 3,600 seconds). </li></ul><br></li><li>  Participants received an encrypted tunnel with parameters that suit them all, and send there data streams to be encrypted, that is, falling under the access list specified in the crypto map. </li><li>  Periodically, in accordance with the configured lifetime, the encryption keys for the main tunnel are updated: the participants again communicate via the ISAKMP tunnel, go through the second phase and establish new SAs. </li></ul><br><blockquote>  Strictly speaking, there is a zero step in this process: some traffic must match the access list in the crypto map.  Only after that all the rest will occur. </blockquote><br><br>  Now a little about the transform set and how ESP differs from AH.  How our data going through the tunnel will be encrypted is determined by the <b>crypto ipsec transform-set <i>set_name command</i></b> , followed by the name of the protocol to be used (ESP or AH) + algorithm that the protocol will use.  For example, the <b>crypto ipsec transform-set SET1 esp-aes command</b> will make it clear to the router that the transform set with the name ‚ÄúSET1‚Äù, if applied, will work only via ESP protocol with AES encryption.  Well, if everything is more or less clear with ESP, its business is to encrypt (to ensure <i>confidentiality</i> ), what is AH and why is it needed at all?  AH provides data <i>authentication</i> , that is, it makes sure that this data came precisely from who we contacted and were not changed along the way.  If you do not go into details, it works like this: an AH header is inserted into each packet between the IP header and the transport layer header, in which it is present: <br><ul><li>  Information on which the recipient can understand to which SA the given package belongs (i.e., including, according to what algorithm, to consider as a hash for comparison - MD5 or SHA) </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the so-called ICV (Integrity Check Value), which is a hash of a package (in fact, not the entire package, but fields that cannot be changed during the journey), which allows the recipient to be sure that this package has not changed along the way by calculating the hash from same information and comparing the result with the value of this field. </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec can work in two modes: tunnel and transport. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec Tunnel Mode </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this mode, your initial IP packet is taken, encrypted completely, along with the IP header, the IPSec service information and the new IP header are added: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5a/e58/bc2/f5ae58bc2d38cd199440422c7c42eee6.jpg"> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* the picture is not accurate and only shows the essence, in fact there are more headers, and there are also trailers at the end . </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the default mode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see again in the course of setting. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the local side: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the general policy for phase 1 is to establish the first, auxiliary tunnel: encryption type (DES default) and authentication. </font><font style="vertical-align: inherit;">Authentication can be done based on certificates, but we will look at a simple example with a preshared key:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto isakmp policy 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encr aes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authentication pre-share</font></font><br></blockquote><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often, there are several such policies with different combinations of encryption, hash and DH group. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When creating isakmp sa, the party that initiates the connection sends all locally configured isakmp policies. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The host looks in turn, in order of priority, of their locally configured policies. </font><font style="vertical-align: inherit;">The first policy for which a match is found will be used.</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Specify the pre-shared key for neighbor authentication 200.0.0.1 </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> crypto isakmp key CISCO address 200.0.0.1 </font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we specify the parameters for processing traffic. </font><font style="vertical-align: inherit;">AES encryption algorithm using ESP header and authentication algorithm.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> crypto ipsec transform-set AES128-SHA esp-aes esp-sha-hmac </font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, we immediately specify a set of protocols, as you see, it is called transform-set. </font><font style="vertical-align: inherit;">When setting up an IPSec session, routers exchange these sets. </font><font style="vertical-align: inherit;">They must match.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To simplify troubleshooting, the names for the transform-set are usually given using the protocols used. </font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we create an encryption card: </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto map MAP1 10 ipsec-isakmp </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set peer 200.0.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set transform-set AES128-SHA </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">match address 101</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is here that the IPSec neighbor address is determined, with which the tunnel will be established later - 200.0.0.1. </font><font style="vertical-align: inherit;">There is also a set of protocols and an ACL, which determines which traffic will be encrypted and transmitted through the tunnel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our case, it looks like this:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> access-list 101 permit ip host 10.0.0.0 host 10.1.1.0 </font></font><br></blockquote><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Be careful when setting the ACL. </font><font style="vertical-align: inherit;">It defines the parameters of not only outgoing traffic, but also incoming (as opposed to ACL for NAT, for example). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, if packets come not from 10.1.1.0, but from 10.2.2.2, it will not be processed and decrypted.</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I mean, if we generate traffic from a host with an address of 10.0.0.0 at 10.1.1.0, then it and only it will be encrypted and sent to the IPSec tunnel. </font><font style="vertical-align: inherit;">Anyone else will go the easy way.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that encryption occurs at the very least, after routing. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And this, by the way, is a very important moment. </font><font style="vertical-align: inherit;">You do not have enough route to the public address of the peer (200.0.0.1). </font><font style="vertical-align: inherit;">We need a route to 10.1.1.0 even if it is default. </font><font style="vertical-align: inherit;">Otherwise, the packet will be dropped in accordance with normal routing rules. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No matter how strange it may seem, but the traffic to the local network should be ‚Äúrouted‚Äù, for example, to the Internet. </font><font style="vertical-align: inherit;">At the same time, private packets that are about to be sent to the provider and dropped there are encrypted at the last moment, receiving public addresses. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, </font></font><a href="http://www.cisco.com/en/US/tech/tk648/tk361/technologies_tech_note09186a0080133ddd.shtml"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a table with the order of the operations performed on the traffic.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ad/d0f/d7f/7add0fd7f2533be041548203949a1a77.png"><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last step is to bind the encryption card to the interface. </font><font style="vertical-align: inherit;">Until you do this the mechanism will not work.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface FastEthernet0 / 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto map MAP1</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the reverse side you need to make a symmetrical setting. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, we simply use the following configuration on R3:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto isakmp policy 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encr aes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authentication pre-share </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto isakmp key CISCO address 100.0.0.1</font></font><br>  ! <br>  ! <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> crypto ipsec transform-set AES128-SHA esp-aes esp-sha-hmac </font></font><br>  ! <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto map MAP1 10 ipsec-isakmp </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set peer 100.0.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set transform-set AES128-SHA </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">match address 101 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface FastEthernet0 / 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto map MAP1 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">access-list 101 permit ip host 10.1.1.0 host 10.0.0.0</font></font><br></blockquote><br>  That's all. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But no matter how much you watch a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">show crypto session</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">show crypto isakmp sa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you will only see </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Down</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The tunnel does not rise. </font><b><font style="vertical-align: inherit;">Show crypto ipsec sa</font></b></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> counters </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Also by zeros.</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # sh crypto session </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crypto session current status </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface: FastEthernet0 / 0 </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Session status: DOWN</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Peer: 200.0.0.1 port 500 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSEC FLOW: permit ip host 10.0.0.0 host 10.1.1.0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Active SAs: 0, origin: crypto map </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # sh crypto isakmp sa </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dst src state conn-id slot status</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact is that you need to let traffic into it. </font><font style="vertical-align: inherit;">In the literal sense, like this:</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # ping 10.1.1.0 source 10.0.0.0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type escape sequence to abort. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending 5, 100-byte ICMP Echos to 10.1.1.0, timeout is 2 seconds: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet sent with a source address of 10.0.0.0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. !!! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Success rate is 80 percent (4/5), round-trip min / avg / max = 60/94/160 ms</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And once you have done this, you will have success: </font></font><br><blockquote> R1#sh crypto session <br> Crypto session current status <br><br> Interface: FastEthernet0/0 <br> Session status: UP-ACTIVE <br> Peer: 200.0.0.1 port 500 <br> IKE SA: local 100.0.0.1/500 remote 200.0.0.1/500 Active <br> IPSEC FLOW: permit ip host 10.0.0.0 host 10.1.1.0 <br> Active SAs: 2, origin: crypto map <br><br> R1#sh crypto isakmp sa <br> dst src state conn-id slot status <br> 200.0.0.1 100.0.0.1 QM_IDLE 1 0 ACTIVE <br></blockquote><br><br> <a href="https://docs.google.com/document/d/1cFIc6teN1UScC4pfn1zuMWlcfp6maCbgiyUcmHyEDws/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full router configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/38.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 1</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Initial configuration: ‚ÄúIPsec‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Router R1 is located in the central office. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Router R3 is a router in one of the branches. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4 - the second branch is added to the scheme. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Configure an IPsec tunnel using a crypto-map between R4 and R1: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- The data protection policies are the same as for the tunnel between R3 and R1. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Add the appropriate settings so that R3 and R4 can also exchange data: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Data between the branches for R3 and R4 should be transmitted through the central R1 router. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task details on the </font></font><a href="http://linkmeup.ru/blog/38.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ================ =====</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What happened?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1) We launched the ping to the address 10.1.1.0 from the address 10.0.0.0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) According to the routing table, the packet must be transmitted to the public network as it is. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) But the router sees that it falls on its ACL 101 and sends the packet to IPSec. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4) IPSec, working in tunnel mode (default mode), packs the source packet first into the IPSec PDU, simultaneously encrypting anything and everything, and then completes it with a new IP header. As a destination address, the router registers the address of its IPSec-neighbor - 200.0.0.1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the screenshot below you can see the encapsulation: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c1a/478/3fb/c1a4783fba064eb6354bd62075fa1ebd.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This was an exchange of ICMP messages. All source data is encrypted, including the old IP, the new IP header is based on the IPSec configuration.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5) At the end node, the router sees that the destination address belongs to it, removes the IP header and sees the IPSec header, to which protocol it sends the packet for processing. The latter is decrypted, all service information is deleted, and the source packet travels further. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why did we run such a strange ping? In it, we specified the sender's address explicitly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we try to start Ping 10.1.1.0, it will not work, because the router automatically substitutes the physical interface address as the sender: 100.0.0.1, which does not fall into our ACL, and therefore the packet tries to go to the gateway of last resort. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the most important problem we have here?</font></font> Bingo!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic routing Implementing it in such conditions is impossible - all IGPs require a direct L2 link between neighbors, which IPSec does not provide. Therefore, in such an implementation, the traffic is sent to the tunnel based on the ACL and the encryption card, rather than the routing table. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus we have a problem with multicast, because we set specific subnets in the ACL. </font></font><br><br> <a href="https://docs.google.com/document/d/1cFIc6teN1UScC4pfn1zuMWlcfp6maCbgiyUcmHyEDws/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full router configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/40.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 2</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration: "IPsec"</font></font><br><br>  Note: <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem can be solved, both theoretically and practically. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you try the task in practice, carefully follow the conditions of the task. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conditions of the problem: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Router R1 is located in the central office and 3 branches will be connected to it (for this task, there are enough R1, R2, R3 routers. R3 is one of the branches). Branch offices use routers with different capabilities, and you must use different IPsec policies. There are 3 different policies in total. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On router R3, in addition to the tunnel to the central office, there are also several tunnels with partners. Therefore, various politicians have also been created here. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The traffic is transmitted only from the branches to the central office, there are no communications between the branches.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the side of the R3 branch to the central office of R1, data is generated that initiates the VPN tunnel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Question: What data protection policy will routers use to build a tunnel between them? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the tasks on the </font></font><a href="http://linkmeup.ru/blog/40.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was a tunnel mode, colleagues. </font><font style="vertical-align: inherit;">Go to the next exhibit.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec Transport Mode </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is much different from the tunnel, but the most important is the encapsulation method. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is an IPSec packet in tunnel mode. </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/f5a/e58/bc2/f5ae58bc2d38cd199440422c7c42eee6.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And this is an IPSec packet in the transport one: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/565/77c/799/56577c79911d2eba47a2f87694b2847f.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, the tunnel encrypts the original packet completely and adds a new IP header. The transport encrypts everything that is above the IP level, and the IP header remains unchanged. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roughly speaking, you use tunnel mode to connect two private networks through a public one, while ensuring encryption (Something like safe GRE). Transport is relevant when IP connectivity has already been achieved, but traffic between nodes must be encrypted. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A good example of the use of transport mode can be a server-client scheme. For example, the work of client-bank. The server is already available, but the traffic needs to be encrypted.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we are not talking about that. </font><font style="vertical-align: inherit;">We still need to unite the network. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/42.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 3</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: "final scheme of task 7.1" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device configurations: on the project website</font></font><br><br>  Description of the problem: <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No data is transferred between R1 and R4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find the error and correct the configuration so that the tunnel between R1 and R4 is established and traffic is transmitted between R1 and R4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the tasks on the </font></font><a href="http://linkmeup.ru/blog/42.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> =====================</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GRE over IPSec </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginners often get confused here ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">he happened to the author</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): GRE over IPSec or IPSec over GRE. What is the difference where applied. You can not stop it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normal mode, which we consider here and which is used in the overwhelming majority of cases, is GRE over IPSec, that is, GRE data is encapsulated with ESP or AH headers, </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/92e/e96/c20/92ee96c205f49a07194b5b7206b1816e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and IPSec over GRE means, on the contrary, that inside will be encrypted IPSec data, and on top of GRE / headers IP. They will not be encrypted: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/da8/c6c/b63/da8c6cb638171f415377ec04dead28c9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This option is possible, for example, if you have encryption on a separate device before tunneling. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/570/c37/9d7/570c379d7ad091ed14b3a20582495217.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why such a pahabschina is needed is not very clear, therefore GRE over IPSec is usually used.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let us return to our old scheme and implement this variant on it. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc1/e35/b5c/fc1e35b5c1e9c377d11018aa78ee3d02.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, at the same time, we again have a tunnel interface (configured as usual GRE):</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Tunnel0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip address 10.2.2.1 255.255.255.252 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel source 100.0.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel destination 200.0.0.1</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And then you send to it the traffic you need a static route. </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ip route 10.1.1.0 255.255.255.255 10.2.2.2 </font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What changes in the IPSec configuration? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In principle, even if you do not change anything, everything will already work, but this is not our way. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firstly, since the tunnel already exists (GRE), there is no need to do it with IPSec tools - you can transfer it to transport mode, thereby saving 20 bytes on the excess IP header:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto ipsec transform-set AES128-SHA esp-aes esp-sha-hmac </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mode transport</font></font><br></blockquote><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* Note, change, it is necessary on both sides, otherwise the IPSec neighborhood will not be established. </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly, all traffic between branches should be encrypted, that is, the one that goes through the tunnel, respectively, there is no need to register all networks in the ACL, we‚Äôll get smarter:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> access-list 101 permit gre host 100.0.0.1 host 200.0.0.1 </font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The condition is met if traffic arrived on the port with the GRE header and the corresponding addresses. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What will happen in this situation? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) The packet with the destination address 10.1.1.0 comes to the router, it determines from its table that the packet needs to be sent to next-hop 10.2.2.2</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # sh ip route 10.1.1.0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Routing entry for 10.1.1.0/32 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Known via "static", distance 1, metric 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Routing Descriptor Blocks: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.2.2.2</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Route metric is 0, traffic share count is 1</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) This is a tunnel interface, with a destination address of 200.0.0.1. </font><font style="vertical-align: inherit;">The packet is packed with a GRE header and a new IP header.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # sh int tun 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel0 is up closeup, line protocol is up closeup </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Hardware is Tunnel </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of Internet address is 10.2.2.1/30 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the MTU 1514 bytes, BW 9 Kbit, DLY 500,000 usec, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reliability What 255/255, txload 1/255, rxload 1 / 255 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encapsulation TUNNEL, loopback not set </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keepalive not set </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel source 100.0.0.1, destination 200.0.0.1</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tunnel protocol / transport GRE / IP</font></font><br></blockquote><br><br>  3) Network 200.0.0.1 is known through the address 100.0.0.2 <br><br><blockquote>  R1 # sh ip route <br>  Gateway of last resort is 100.0.0.2 to network 0.0.0.0 <br></blockquote><br><br>  And the subnet 100.0.0.0/30 is connected to the FE0 / 0 interface <br><blockquote>  R1 # sh ip route 100.0.0.0 <br>  Routing entry for 100.0.0.0/30, 1 known subnets <br>  Attached (1 connections) <br><br>  C <b>100.0.0.0 is directly connected, FastEthernet0 / 0</b> <br></blockquote><br><br>  And on it is applied encryption card with ACL. <br>  The traffic, naturally, falls under it (it has the GRE header and the necessary IP addresses), so everything that is inside the external IP header will be encrypted. <br><br>  Such a scheme of work allows the normal implementation of dynamic routing protocols, as well as multicast traffic, leaving the possibility of encryption.  Hooligans will not be able to steal secret recipes for the preparation of elevators. <br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/46.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/46.html"><b>Problem number 5</b></a> <br><br>  Scheme: <a href="https://docs.google.com/document/d/1BT2Bv4zj-y3ldqri3Avvdc1kMutGbMsv4FL1_SEkwtw/pub">"GRE_over_IPSec"</a> <br><br>  Configuration: on the project website <br><br>  Description of the problem: <br>  After setting up GRE over IPSec between R1 and R3, everything works fine, the traffic between R1 and R3 (from 10.0.0.0 to 10.1.1.0) is transmitted. <br>  However, a few days later, when the administrator wanted to see the VPN status, it turned out that there are no SAs installed on the routers at all. <br>  Accordingly, the traffic between R1 and R3 is not encrypted. <br><br>  The task: <br>  You need to check the settings, correct the configuration and make sure that the traffic is encrypted (traffic between loopback interfaces 10.0.0.0 and 10.1.1.0). <br><br>  Details of the task on the <a href="http://linkmeup.ru/blog/46.html">site</a> <br>  ===================== <br><br>  <a href="https://docs.google.com/document/d/1BT2Bv4zj-y3ldqri3Avvdc1kMutGbMsv4FL1_SEkwtw/pub">Complete router configuration for IPSec</a> . <br><br><blockquote>  You can make one more addition here: technically, you can exclude the four-byte GRE header from the packet, indicating on both sides that the IPIP tunnel is in operation mode: <br><blockquote>  interface Tunnel0 <br>  tunnel mode ipip <br></blockquote><br>  Truth must be remembered that in this case you can only encapsulate IP data, and not any, as in the case of GRE. <br></blockquote><br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/44.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/44.html"><b>Task number 4</b></a> <br><br>  Scheme: "GRE_over_IPSec" <br><br>  Configuration: <a href="https://docs.google.com/document/d/1BT2Bv4zj-y3ldqri3Avvdc1kMutGbMsv4FL1_SEkwtw/pub">"GRE_over_IPSec"</a> <br><br>  The task: <br>  Change the initial configuration of GRE over IPSec and configure GRE over IPsec without using a crypto-map. <br><br>  Details of the task on the <a href="http://linkmeup.ru/blog/44.html">site</a> <br>  ===================== <br><br><h1>  IPSec VTI </h1><br>  The latest example of a Site-to-Site VPN using IPSec, which, in fact, is recommended by ciskoy - VTI (Virtual Tunnel Interface) <br><br>  IPSec configuration is different in that we no longer need to manually create a crypto-map (and, accordingly, an ACL), instead we create an IPSec profile <br><blockquote>  crypto isakmp policy 1 <br>  authentication pre-share <br><br>  crypto isakmp key DMVPNpass address 0.0.0.0 0.0.0.0 <br><br>  crypto ipsec transform-setVTI-TS esp-aes <br>  mode transport <br><br>  crypto ipsec profile VTI-P <br>  set transform-set VTI-TS <br></blockquote><br>  And in turn, it must be tied to the tunnel interface. <br><blockquote>  interface Tunnel0 <br>  tunnel protection ipsec profile DMVPN-P <br></blockquote><br>  The difference from the previously used Crypto map is that now there is no need to create an ACL - all traffic that enters the tunnel is encrypted (encryption cards are still generated, but automatically). <br><br>  It turned out the usual Tunnel Protection without VTI.  It is also widely used. <br>  The <b>tunnel mode ipsec ipv4 command</b> indicates VTI usage. <br>  The difference from the usual GRE in encapsulation methods - VTI saves 4 bytes by excluding the GRE header. <br><br>  <a href="http://henrydu.com/blog/networks/vpn/ipsec-over-gre-and-ipsec-vti-368.html">Small description</a> <br>  <a href="https://docs.google.com/document/d/1Ss_bo0WDZzM_5CI24jokEDks5Y0deUGFs6n-RmedcgA/pub">Complete router configuration for IPSec VTI</a> . <br><br><h1>  DMVPN </h1><br>  The apotheosis of today's release is DMVPN (Dymamic Multipoint VPN).  So far, we have been talking about universal venderozavisimyh things.  Unfortunately, DMVPN is a purely ciskovian thing and has not yet opened adequate analogs (correct it if I am mistaken). <br><br>  In the previous parts, we solved the problem with the security of the transmitted data - now we encrypt them - and with IGP - through GRE over IPSec we use dynamic routing protocols. <br>  The last problem remains - scalability. <br>  Well, when you have this mesh: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db7/844/c82/db7844c8234862620a2a6538d102cc7c.png"><br><br>  Two tunnels on each node and that's it. <br>  Add another node: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/78c/80d/976/78c80d9761e3e2d094f4a541354d3b63.jpg"><br><br>  And one more: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73c/457/dfe/73c457dfeec79b0d085cdf2c9ca88762.jpg"><br><br>  Much more tunnels are needed to obtain a fully connected topology.  A typical problem with m * (m-1) / 2 complexity. <br>  If you do not use Full-Mesh, but turn to the Hub-and-Spoke topology with one central point, then another problem arises - traffic between any branches will pass through the central node. <br><br>  DMVPN solves both problems. <br>  The point is this: the central point of the Hub (or several) is selected.  It will be the server to which clients will connect (Spoke) and receive all the necessary information.  Wherein: <br><br>  1) Data will be encrypted by IPSec <br>  2) Customers can send traffic directly to each other, bypassing the central site <br>  3) Only a central site requires a static public IP address.  Remote nodes can have a dynamic address and even be behind a NAT, using addresses from private ranges ( <a href="http://en.wikipedia.org/wiki/NAT_traversal">NAT Traversal</a> ).  But at the same time there are restrictions on the part of dynamic tunnels. <br><br>  This is all the focus of the power of GRE and IPSec, flavored with NHRP and IGP. <br><br><h2>  Theory and Practice of DMVPN </h2><br>  Abstracting from our old network, we take into consideration only Moscow, the Internet, which will be emulated by the Balagan-Telecom router, and the actual branches in Novosibirsk, Tomsk and Brno: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3e/742/667/b3e7426672469a02b95d58a6f26f736b.png"><br><br>  New IP plan: <br>  Subnets allocated to connect to the Internet affiliates: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5d4/686/736/5d46867369970592c29d5aefe5ce0917.png"><br><br>  LAN: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25b/ca6/7f7/25bca67f71f879a1f818956443ef462d.png"><br><br>  For tunnel interfaces, take the internal network: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b01/263/434/b01263434422f5dd63eb281ed904cad1.png"><br><br>  And we will also assign Loopback addresses for them: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/88f/aeb/5fe/88faeb5fe0262a665662f5393b658cf5.png"><br><br>  The idea is that the central node will have a single dynamic tunnel, which we will set up at the very beginning, and when adding new remote points, no changes are needed here - neither to add new tunnel interfaces, nor to reconfigure the existing one. <br>  In fact, when adding new nodes, you only need to configure them. <br>  <a href="http://searchnetworking.techtarget.com/definition/Next-Hop-Resolution-Protocol">NHRP</a> - NBMA Next Hop resolution Protocol is running everywhere. <br>  It allows you to dynamically study the addresses of remote points that you want to connect to the main. <br>  It is based on the possibility of implementing multipoint VPN.  The hub (central site) here acts as a server (NHS - Next-Hop Server), and all remote sites will be clients (NHC - Next-Hop Client). <br>  It sounds difficult.  To explain on the fingers, too, will not work.  You only need to set up once and see how the packages run. <br><br>  Hub configuration: <br><blockquote>  interface Tunnel0 <br>  ip address 172.16.254.1 255.255.255.0 <br>  ip nhrp map multicast dynamic <br>  ip nhrp network-id 1 <br>  tunnel source FastEthernet0 / 1.6 <br>  tunnel mode gre multipoint <br></blockquote><br>  In order: <br>  <i>ip address 172.16.254.1 255.255.255.0</i> - IP address from the desired range. <br>  <i>ip nhrp map multicast dynamic</i> - Dynamic exploring NHRP data from clients.  Since we have a lot of customers and they can be with dynamic addresses, it is impossible to set an explicit correspondence of internal and external addresses on the hub. <br>  <i>ip nhrp network-id 1</i> - Determine the Network ID - just an identifier that does not have to be the same on all DMVPN nodes (similar to the OSPF Router-ID). <br>  <i>tunnel source FastEthernet0 / 1.6</i> - legacy GRE - binding to the physical interface. <br>  <i>tunnel mode gre multipoint</i> - A tunnel at the central site will terminate all tunnels from remote points.  That is, it will be a point-to-multipoint. <br><br>  Branch Configuration: <br><blockquote>  interface Tunnel0 <br>  ip address 172.16.254.2 255.255.255.0 <br>  ip nhrp map 172.16.254.1 198.51.100.2 <br>  ip nhrp map multicast 198.51.100.2 <br>  ip nhrp network-id 1 <br>  ip nhrp nhs 172.16.254.1 <br>  ip nhrp registration no-unique <br>  tunnel source FastEthernet0 / 0 <br>  tunnel mode gre multipoint <br></blockquote><br><br>  In order: <br>  <i>ip address 172.16.254.2 255.255.255.0</i> - IP address from the desired range. <br>  <i>ip nhrp map 172.16.254.1 198.51.100.2</i> - Static ratio of internal and external addresses of the hub. <br>  <i>ip nhrp map multicast 198.51.100.2</i> multicast traffic should receive a hub. <br><br><blockquote>  Without this command you will have quite interesting symptoms of the problem. <br>  Here you run OSPF, the peering rises, the hub and branches go to Full, exchanged routes, and you are happy that everything is fine, and then bang - ping disappears, peering drops, but only on one side, the pier is dead. <br><br>  <i>* Mar 1 01: 51: 20.331:% OSPF-5-ADJCHG: Process 1, Nbr 172.16.255.2 on Tunnel0 from FULL to DOWN, Neighbor Down: Dead timer expired</i> <i><br></i>  <i>msk-arbat-gw1 #</i> <i><br></i>  <i>* Mar 1 01: 51: 25.435:% OSPF-5-ADJCHG: Process 1, Nbr 172.16.255.2 on Tunnel0 from LOADING to FULL, Loading Done</i> <br><br>  What kind of garbage? <br>  Watch debug, watch dumps <br><br>  <i>* Mar 1 01: 53: 44.915: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.4 from 172.16.2.1</i> <i><br></i>  <i>* Mar 1 01: 53: 44.919: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.7 from 172.16.2.33</i> <i><br></i>  <i>* Mar 1 01: 53: 44.923: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.5 from 172.16.2.17</i> <i><br></i>  <i>* Mar 1 01: 53: 44.923: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.8 from 172.16.2.129</i> <i><br></i>  <i>* Mar 1 01: 53: 44.963: OSPF: Send hello to 224.0.0.5 area 0 on Tunnel0 from 172.16.254.1</i> <i><br></i>  <i>msk-arbat-gw1 #</i> <i><br></i>  <i>* Mar 1 01: 53: 54.919: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.4 from 172.16.2.1</i> <i><br></i>  <i>* Mar 1 01: 53: 54.923: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.7 from 172.16.2.33</i> <i><br></i>  <i>* Mar 1 01: 53: 54.927: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.5 from 172.16.2.17</i> <i><br></i>  <i>* Mar 1 01: 53: 54.931: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.8 from 172.16.2.129</i> <i><br></i>  <i>* Mar 1 01: 53: 54.963: OSPF: Send hello to 224.0.0.5 area 0 on Tunnel0 from 172.16.254.1</i> <i><br></i>  <i>msk-arbat-gw1 #</i> <i><br></i>  <i>* Mar 1 01: 54: 04.919: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.4 from 172.16.2.1</i> <i><br></i>  <i>* Mar 1 01: 54: 04.927: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.7 from 172.16.2.33</i> <i><br></i>  <i>* Mar 1 01: 54: 04.931: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.5 from 172.16.2.17</i> <i><br></i>  <i>* Mar 1 01: 54: 04.935: OSPF: Send hello to 224.0.0.5 area 0 on FastEthernet0 / 1.8 from 172.16.2.129</i> <i><br></i>  <i>* Mar 1 01: 54: 04.963: OSPF: Send hello to 224.0.0.5 area 0 on Tunnel0 from 172.16.254.1</i> <i><br></i> <br><img src="https://habrastorage.org/getpro/habr/post_images/65a/bea/6ea/65abea6eac052a887d429e7e38c67d16.png"><br>  On the 5 OSPF Hello from the hub, only one Hello from the branch. <br>  As you already understood, the router simply cannot figure out where to send multicast messages to the address 224.0.0.5, the hub does not receive them, and pulls the OSPF session. <br></blockquote><br><br>  <i>ip nhrp network-id 1</i> - Network ID.  It does not have to be the same as the one on the hub. <br>  <i>ip nhrp nhs 172.16.254.1</i> - Statically configured address of the NHRP server - hub.  That is why in the center we need a static public address.  Clients send a registration request to hub 172.16.254.1.  This request contains the configured local address of the tunnel interface, as well as its public address (the case when the client is behind NAT is not yet considered). <br>  The hub records the received information in its NHRP address matching table.  It spreads the same table on request to any Spoke-router. <br><br>  <i>ip nhrp registration no-unique</i> - if the address in the branches is issued dynamically, this command is required. <br>  <i>tunnel source FastEthernet0 / 0</i> - binding to the physical interface. <br>  <i>tunnel mode gre multipoint</i> - indicate that the tunnel type is mGRE - this will allow you to create dynamically tunnels not only to the hub, but also to other branches. <br><br>  Our situation is simple - without NAT - and we can already check the status of the tunnels. <br><br><blockquote>  msk-arbat-gw1 # sh int tun 0 <br>  <b>Tunnel0 is up, line protocol is up</b> <br>  Hardware is tunnel <br>  Internet address is 172.16.254.1/24 <br>  MTU 1514 bytes, BW 9 Kbit, DLY 500000 usec, <br>  reliability 255/255, txload 1/255, rxload 1/255 <br>  Encapsulation TUNNEL, loopback not set <br>  Keepalive not set <br>  <b>Tunnel source 198.51.100.2 (FastEthernet0 / 1.6), destination UNKNOWN</b> <br>  <b>Tunnel protocol / transport multi-GRE / IP</b> <br>  Key disabled, sequencing disabled <br>  Checksumming of packets disabled <br></blockquote><br><br><blockquote>  msk-arbat-gw1 # ping 172.16.254.2 <br><br>  Type escape sequence to abort. <br>  Sending 5, 100-byte ICMP Echos to 172.16.254.2, timeout is 2 seconds: <br>  !!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 176/213/284 ms <br></blockquote><br><br><blockquote>  msk-arbat-gw1 # sh ip nhrp brief <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.2/32 172.16.254.2 198.51.101.2 dynamic Tu0 <br>  msk-arbat-gw1 # sh ip nhrp <br>  172.16.254.2/32 via 172.16.254.2, Tunnel0 created 00:09:48, expire 01:50:11 <br>  Type: dynamic, Flags: authoritative unique registered <br>  NBMA address: 198.51.101.2 <br><br>  nsk-obsea-gw1 # sh ip nhrp brief <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br></blockquote><br><br><h2>  Ospf </h2><br>  That is, connectivity is already provided, but the branches cannot work yet - routing is not configured. <br><br>  Here for each protocol their subtleties emerge. <br>  Let's take a look at the OSPF configuration process, for example. <br><br>  Since we have a broadcast L2 network on the tunnel interfaces, we explicitly indicate the type of the Broadcast network on the tunnel interfaces on all nodes: <br><blockquote>  ip ospf network broadcast <br></blockquote><br>  In addition, DR should be selected on such a network.  It is logical that they become a hub.  All Spoke-routers prohibit participation in DR elections: <br><blockquote>  ip ospf priority 0 <br></blockquote><br>  Well and, naturally, we define the announced networks. <br><blockquote>  router ospf 1 <br>  network 172.16.0.0 0.0.255.255 area 0 <br></blockquote><br>  Networks are announced: <br><br><blockquote>  msk-arbat-gw1 # sh ip route <br><br>  Gateway of last resort is 198.51.100.1 to network 0.0.0.0 <br><br>  172.16.0.0/16 is variably subnetted, 7 subnets, 3 masks <br>  C 172.16.2.128/30 is directly connected, FastEthernet0 / 1.8 <br>  C 172.16.255.1/32 is directly connected, Loopback0 <br>  C 172.16.254.0/24 is directly connected, Tunnel0 <br>  C 172.16.2.32/30 is directly connected, FastEthernet0 / 1.7 <br>  C 172.16.2.16/30 is directly connected, FastEthernet0 / 1.5 <br>  C 172.16.2.0/30 is directly connected, FastEthernet0 / 1.4 <br>  O 172.16.255.128/32 [110/11112] via 172.16.254.2, 00:05:14, Tunnel0 <br>  198.51.100.0/28 is subnetted, 1 subnets <br>  C 198.51.100.0 is directly connected, FastEthernet0 / 1.6 <br>  S * 0.0.0.0/0 [1/0] via 198.51.100.1 <br></blockquote><br><br>  Ping passes <br><br><blockquote>  msk-arbat-gw1 # ping 172.16.255.128 <br><br>  Type escape sequence to abort. <br>  Sending 5, 100-byte ICMP Echos to 172.16.255.128, timeout is 2 seconds: <br>  !!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 60/70/80 ms <br></blockquote><br><br>  Here are the packets transmitted via the Internet: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae0/543/f42/ae0543f42615bfe1ff399298da604b34.png">  <i>* Dump with nsk-obsea-gw1 fa0 / 0</i> <br><br>  We check how we ping from one branch to another: <br><br><blockquote>  nsk-obsea-gw1 # ping 172.16.255.132 <br><br>  Type escape sequence to abort. <br>  Sending 5, 100-byte ICMP Echos to 172.16.255.132, timeout is 2 seconds: <br>  !!! <br>  Success rate is 100 percent (5/5), round-trip min / avg / max = 132/231/492 ms <br><br>  nsk-obsea-gw1 # traceroute 172.16.255.132 <br><br>  Type escape sequence to abort. <br>  Tracing the route to 172.16.255.132 <br><br>  1,172.16.254.3 240 msec * 172 msec <br><br>  nsk-obsea-gw1 # sh ip nhrp br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br>  172.16.254.3/32 172.16.254.3 198.51.102.2 dynamic Tu0 <br></blockquote><br><br>  As you can see, the packets do not go to the hub, but go directly directly to the router of another branch via the Internet.  But the reality is somewhat more complicated. <br><br>  What happens at this moment? <br>  1) We send ping to the address of the Loopback interface in Tomsk <br>  2) According to the routing table, the next hop <br><br><blockquote>  nsk-obsea-gw1 # sh ip route 172.16.255.132 <br>  Routing entry for 172.16.255.132/32 <br>  Known via "ospf 1", distance 110, metric 11112, type intra area <br>  Last update from 172.16.254.3 on Tunnel0, 00:18:47 ago <br>  Routing Descriptor Blocks: <br>  * <b>172.16.254.3, from 172.16.255.132, 00:18:47 ago, via Tunnel0</b> <br>  Route metric is 11112, traffic share count is 1 <br></blockquote><br><br>  This is the address from the network directly connected to the interface Tunnel 0 <br><br><blockquote>  nsk-obsea-gw1 # sh ip route 172.16.254.3 <br>  Routing entry for 172.16.254.0/24 <br>  Known via "connected", distance 0, metric 0 (connected, via interface) <br>  Routing Descriptor Blocks: <br>  * <b>directly connected, via Tunnel0</b> <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br>  3) According to the interface settings, NHRP is used here.  We look at the correspondence table received from the hub <br><br><blockquote>  nsk-obsea-gw1 # sh ip nhrp brief <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br></blockquote><br><br>  As you can see, the address 172.16.254.3 nhrp is <b>unknown</b> . <br>  Therefore, the ICMP packet is sent to the statically configured hub - 198.51.100.2: <br><br>  <b>msk-arbat-gw1, fa0 / 1:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c1b/a59/4a3/c1ba594a3216d173e192b239f0d2b263.png"><br><br>  And the hub immediately redirects the request to the desired address: <br><br>  <b>msk-arbat-gw1, fa0 / 1:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/254/57f/c27/25457fc270a0348b2fc7fde3131c7fc0.png"><br><br>  4) At the same time, the router client in Novosibirsk sends an NHRP request, saying that someone harboring the address 172.16.254.3: <br><br>  <b>msk-arbat-gw1, fa0 / 1:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/df8/609/fe4/df8609fe468294222979536597d75e86.png"><br><br>  5) The hub has this knowledge: <br><br><blockquote>  msk-arbat-gw1 # sh ip nhr br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.2/32 172.16.254.2 198.51.101.2 dynamic Tu0 <br>  172.16.254.3/32 172.16.254.3 198.51.102.2 dynamic Tu0 <br></blockquote><br><br>  And sends this information in the NHRP response: <br><br>  <b>msk-arbat-gw1, fa0 / 1:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/74e/0ed/270/74e0ed2701c1fc67da84c132c3eff101.png"><br><br>  More Hub does not intervene in the conversation of two spokes. <br><br>  6) ICMP request came to Tomsk: <br><br>  <b>tmsk-lenina-gw1, fa0 / 0:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/fae/c0c/4a6/faec0c4a67fa2eeab2bb86f9cf0b1204.png"><br><br>  Despite the fact that in the external header, the source IP address is the hub address, the initial address of the Novosibirsk router appears inside: <br><br>  7) Tomsk also does not know anything about the address 172.16.254.2, which sent the ICMP request. <br><br><blockquote>  tmsk-lenina-gw1 (config-if) #do sh ip nh br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br></blockquote><br><br>  Therefore, it sends the ICMP reply to the hub too: <br>  <b>tmsk-lenina-gw1, fa0 / 0:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/cf0/119/cf1/cf0119cf1d1321d75320c522e9a640e6.png"><br><br>  8) Following him, he is interested in the public address of the sender: <br><br>  <b>tmsk-lenina-gw1, fa0 / 0:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/d93/5ce/31e/d935ce31e973bdb46058498a09f06d15.png"><br><br>  9) Well, the hub naturally answers: <br><br>  <b>tmsk-lenina-gw1, fa0 / 0:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/895/b69/364/895b69364644809c697434a6b1903339.png"><br><br>  10) Now on all nodes relevant information NHRP: <br><br><blockquote>  msk-arbat-gw1 (config-if) #do sh ip nhr br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.2/32 172.16.254.2 198.51.101.2 dynamic Tu0 <br>  172.16.254.3/32 172.16.254.3 198.51.102.2 dynamic Tu0 <br></blockquote><br><br><blockquote>  nsk-obsea-gw1 (config-if) #do sh ip nhr br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br>  172.16.254.3/32 172.16.254.3 198.51.102.2 dynamic Tu0 <br></blockquote><br><br><blockquote>  tmsk-lenina-gw1 (config-if) #do sh ip nh br <br>  Target Via NBMA Mode Intfc Claimed <br>  172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 <br>  172.16.254.2/32 172.16.254.2 198.51.101.2 dynamic Tu0 <br></blockquote><br><br>  As you can see, the distribution does not occur automatically, but on request, and only the clients are the initiators, because in fact, only they know where to turn (the hub initially does not know anything about the clients) <br><br>  11) It will send the next ICMP request in a new way: <br><br><blockquote>  nsk-obsea-gw1 # sh ip route 172.16.255.132 <br>  Routing entry for 172.16.255.132/32 <br>  Known via "ospf 1", distance 110, metric 11112, type intra area <br>  Last update from 172.16.254.3 on Tunnel0, 00:20:24 ago <br>  Routing Descriptor Blocks: <br>  * 172.16.254.3, from 172.16.255.132, 00:20:24 ago, via Tunnel0 <br>  Route metric is 11112, traffic share count is 1 <br></blockquote><br><br>  Subnet 172.16.254.0 connected to the interface Tunnel 0 <br><br><blockquote>  nsk-obsea-gw1 # sh ip route 172.16.254.3 <br>  Routing entry for 172.16.254.0/24 <br>  Known via "connected", distance 0, metric 0 (connected, via interface) <br>  Routing Descriptor Blocks: <br>  * directly connected, via Tunnel0 <br>  Route metric is 0, traffic share count is 1 <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12) We repeat a little, but ... The Tunnel 0 interface is mGRE and according to the NHRP table all traffic for which the next hop is 172.16.254.3 should be encapsulated into GRE and the external IP header with the destination address 198.51.102.2 (The source address will be selected physical interface address - 198.51.101.2): </font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nsk-obsea-gw1 (config-if) #do sh ip nhr br </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Target Via NBMA Mode Intfc Claimed </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.16.254.1/32 172.16.254.1 198.51.100.2 static Tu0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.16.254.3/32 172.16.254.3 198.51.102.2 dynamic Tu0</font></font><br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tmsk-lenina-gw1, fa0 / 0:</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/550/c8c/f98/550c8cf98d3d705e622e37f9e1600b0c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13) And then the packet with the destination address 198.51.102.2 is sent according to the routing table:</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gateway of last resort is 198.51.101.1 to network 0.0.0.0 </font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is important to understand that despite the fact that communication between branches is bypassing the central hub, the hub, however, carries a vital auxiliary function here and will not work without it: it provides clients with an NHRP table, and also announces all routes - the branches distribute routing information is not directly to each other, but through the hub. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current configuration of nodes:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msk-arbat-gw1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Tunnel0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip address 172.16.254.1 255.255.255.0</font></font><br>  no ip redirects <br>  ip nhrp map multicast dynamic <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip nhrp network-id 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip ospf network broadcast </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip ospf 10 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel source FastEthernet0 / 1.6</font></font><br>  tunnel mode gre multipoint <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nsk-obsea-gw1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Tunnel0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip address 172.16.254.2 255.255.255.0</font></font><br>  no ip redirects <br> ip nhrp map 172.16.254.1 198.51.100.2 <br> ip nhrp map multicast 198.51.100.2 <br> ip nhrp network-id 1 <br> ip nhrp nhs 172.16.254.1 <br> ip ospf network broadcast <br> ip ospf priority 0 <br> tunnel source FastEthernet0/0 <br>  tunnel mode gre multipoint <br><br> tmsk-leneina-gw1 <br> interface Tunnel0 <br> ip address 172.16.254.3 255.255.255.0 <br>  no ip redirects <br> ip nhrp map 172.16.254.1 198.51.100.2 <br> ip nhrp map multicast 198.51.100.2 <br> ip nhrp network-id 1 <br> ip nhrp nhs 172.16.254.1 <br> ip ospf network broadcast <br> ip ospf priority 0 <br> tunnel source FastEthernet0/0 <br>  tunnel mode gre multipoint <br>  end <br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Currently the following problems have been solved: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Connectivity. </font><font style="vertical-align: inherit;">Branches are connected and available. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Routing. </font><font style="vertical-align: inherit;">Through mGRE, IGP tunnels are successfully launched. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) Scalability. </font><font style="vertical-align: inherit;">When adding a new spoke-router, only it is configured itself and there is no need to go into the configuration of already existing nodes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4) Unloaded the hub - only service traffic is transmitted through it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains to settle the issue with security.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ipsec </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is solved as before - encryption. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If for the Site-to-Site VPN we could still use the pre-shared key, because we rigidly set the IPSec peer address, in the case of DMVPN we need flexibility, and we don‚Äôt know in advance the address of our neighbors. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this regard, the use of certificates is recommended. </font><font style="vertical-align: inherit;">On xgu there is a good </font></font><a href="http://xgu.ru/wiki/%25D0%25A6%25D0%25B5%25D0%25BD%25D1%2582%25D1%2580_%25D1%2581%25D0%25B5%25D1%2580%25D1%2582%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2582%25D0%25BE%25D0%25B2_%25D0%25BD%25D0%25B0_%25D0%25BC%25D0%25B0%25D1%2580%25D1%2588%25D1%2580%25D1%2583%25D1%2582%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25B5_Cisco"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the center of certificates on cisco. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But for simplicity‚Äôs sake, we‚Äôll take the setup with the pre-shared key.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto isakmp policy 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authentication pre-share</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> From the Tunnel Protection and VTI discussed above, it will differ using the template address: </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> crypto isakmp key DMVPNpass address 0.0.0.0 0.0.0.0 </font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The danger here is that you can set up an IPSec session with a hub, knowing the key, any device. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here you can safely use the transport mode:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto ipsec transform-set AES128-SHA esp-aes esp-sha-hmac </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mode transport </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto ipsec profile DMVPN-P </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set transform-set AES128-SHA</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the created profile is applied to the tunnel interface. </font><font style="vertical-align: inherit;">The configuration on all nodes is the same.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Tunnel0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel protection ipsec profile DMVPN-P</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now packets transmitted over the Internet will be encrypted: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msk-arbat-gw1, fa0 / 1:</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/353/3c3/486/3533c348672e59b2e23e69b5106750bf.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Just do not think of putting </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel mode ipsec ipv4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec tunnels and encryption cards will be created dynamically for data transmission between branches and will be permanent for Hub channels -Spoke.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> NAT-Traversal </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we will not go into the principles of the </font></font><a href="http://en.wikipedia.org/wiki/NAT_traversal"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NAT-T.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will only convey the essence: at the expense of an additional UDP header, IPSec can build a tunnel through NAT. </font><font style="vertical-align: inherit;">This allows you to build a VPN, even on those sites where you do not have a public address. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is no need to activate this function in any special way and configure it - it works by default. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's complicate the scheme by adding another router to Brno. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f1/1e4/0dd/2f11e40dd4c7a6dec09c6b4315ddfe6d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, this is a provider piece of hardware that carries out the tension. </font><font style="vertical-align: inherit;">That is, in fact, on the branch office router we will have a dynamic address from the private range on the physical interface. </font><font style="vertical-align: inherit;">GRE in its pure form can not build a VPN under these conditions, IPSec can, but is difficult to configure. </font><font style="vertical-align: inherit;">mGRE in conjunction with IPSec can easily!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's see what the NHRP table looks like in this case: </font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msk-arbat-gw1 # show ip nhrp brief </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Target Via NBMA Mode Intfc Claimed </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.16.254.4/32 172.16.254.4 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.0.0.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dynamic Tu0</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, he still studied the private address allocated by the provider. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should be noted that in the routing table there should be a route to this private address, issued by the provider in the branch, even if the default one. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the tunnel interface, we have IPSec activated, so there should be encryption cards:</font></font><br><br><blockquote> msk-arbat-gw1#show crypto map <br> Crypto Map ¬´Tunnel0-head-0¬ª 65537 ipsec-isakmp <br> Map is a PROFILE INSTANCE. <br> <b>Peer = 198.51.103.2</b> <br> Extended IP access list <br> access-list permit gre host 198.51.100.2 host 10.0.0.2 <br> <b>Current peer: 198.51.103.2</b> <br> Security association lifetime: 4608000 kilobytes/3600 seconds <br> PFS (Y/N): N <br> Transform sets={ <br> AES128-SHA, <br>  } <br> Interfaces using crypto map Tunnel0-head-0: <br> Tunnel0 <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, the encrypted tunnel is built between 198.51.100.2 and 198.51.103.2, further, the data is still encrypted with NAT-T in the tunnel go to 10.0.0.2. </font><font style="vertical-align: inherit;">And then you already know. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explanatory detailed article on </font></font><a href="http://habrahabr.ru/post/84738/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NHRP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/48.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 6</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Initial configuration: </font></font><a href="https://docs.google.com/document/d/1HApl7vsNqz4lLIrBG0vbL6osO85GiT-vMRh3K-8SYoE/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"DMVPN"</font></font></a> <br><br>  Scenario: <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The DMVPN network was fully operational, everything worked correctly. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But after rebooting the hub msk-arbat-gw1 strange behavior began. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Check the network operability. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Restart the hub </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. After the restart, check the network operability again </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Fix the problem:</font></font><br>  4.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (minimum) Make the network work again </font></font><br>  4.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make the network restore automatically after the hub appears again. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the tasks on the </font></font><a href="http://linkmeup.ru/blog/48.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> =====================</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TShoot IPSec </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lastly, I want to say a few words about how to solve problems with IPSec. The procedure is far from trivial. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When troubleshooting VPNs, debugs play a huge role. The method of a close look at a config is less reliable - it is easy to miss a small error. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An extremely valuable tool in IPSec troubleshooting is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sh crypto ipsec sa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No, the point is not even in the binary ‚Äúhas risen - it has not risen‚Äù, but in the counters, first of all </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encaps-decaps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can start a continuous ping and observe which of the counters is growing. Most of the problems can be localized in this way. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Counters do not grow at all? See where the crypto map is applied and is everything fine with the ACL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grow </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Something is wrong with the agreement, see debag.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grow </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encaps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decaps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Forward to study the opposite side of the tunnel, everything is fine.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MTU </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, we discuss one insidious moment - the size of the MTU. In the life of every system / network administrator, there comes a time when the symptoms of the problem are as follows: Yandex opens, ping works, but no other site is accessible and Outlook connects. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The devil is in the amount of MTU and the availability of additional headers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU - Maximum Transmission Unit. This is the maximum data block size that can be transmitted via the interface. This concept is located at the intersection of L2 and L3 and its interpretation may vary for different vendors. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, the typical MTU size for a physical L3 interface is 1500. That is, roughly speaking, an 1500-byte IP packet will be processed and 1501 will be dropped or fragmented. Often packet fragmentation is prohibited, and therefore large packets are discarded.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are using tunneling, the packet size increases with additional headers (GRE, IPSec, etc.) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, for GRE: 24 bytes (GRE, New IP). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For GRE over IPSec: 56 or </font></font><a href="http://www.firewall.cx/cisco-technical-knowledgebase/cisco-routers/872-cisco-router-gre-ipsec-tunnel-transport.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bytes (depending on the operation mode and type of encryption) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For PPPoE: 36 (PPP, PPPoE, Ethernet) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The tunnel interface itself has a standard MTU 1514 and passes such packets, but the provider has an MTU = on the physical interface 1500, and the packet will be dropped on it:</font></font><br><br><blockquote> R1#sh int tun 0 <br> Tunnel0 is up, line protocol is up <br> Hardware is Tunnel <br> Internet address is 10.2.2.1/30 <br> <b>MTU 1514 bytes</b> , BW 9 Kbit, DLY 500000 usec, <br><br> R1#sh int fa0/1 <br> FastEthernet0/1 is administratively down, line protocol is down <br> Hardware is Gt96k FE, address is c000.19ac.0001 (bia c000.19ac.0001) <br> <b>MTU 1500 bytes</b> , BW 10000 Kbit, DLY 1000 usec, <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, you must take into account not only your own settings, but also the settings of all intermediate nodes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often you do not have the opportunity to influence the MTU along the way. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, you can reduce the MTU, on the local side, use the </font></font><a href="http://www.opennet.ru/base/net/pmtu_troubles.txt.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Path MTU Discovery</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mechanism, </font><font style="vertical-align: inherit;">or even configure the MSS - Maximum Segment Size (already applies to TCP). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more about problems with MTU </font></font><a href="http://www.opennet.ru/base/net/pppoe_mtu.txt.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://supportforums.cisco.com/thread/150917"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For various tunnels, this is a completely typical problem. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do ping and yandex work? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ICMP Request and Relpy packets are 32 to 64 bytes in size, ya.ru returns very little information, which fits into the allowed size of 1500 along with all the headers. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, the following interesting topics remained unaffected: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fully flew past the topic of remote access for employees. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, the FlexVPN topic is very relevant now. </font><font style="vertical-align: inherit;">This is a new stage in the development of VPN technology. </font><font style="vertical-align: inherit;">But it uses IKE version 2 and is supported at the moment, as usual only with cisco equipment. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We would really like to pay attention to this and that and those topics, but it‚Äôs impossible to put everything in the framework of one article.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Release materials </font></font></h1><br> <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AooexOHebRpTdDJMTUhIbmFPRFJJX254dFFrbUJIWWc"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP plan</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Device configuration </font></font><a href="https://docs.google.com/document/d/17ah5yg5n5vO-zyM_ALHZ1kKZ5u4fJ-xDXZPKtnlJQZ0/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GRE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1cFIc6teN1UScC4pfn1zuMWlcfp6maCbgiyUcmHyEDws/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1BT2Bv4zj-y3ldqri3Avvdc1kMutGbMsv4FL1_SEkwtw/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GRE over IPSec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1Ss_bo0WDZzM_5CI24jokEDks5Y0deUGFs6n-RmedcgA/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1HApl7vsNqz4lLIrBG0vbL6osO85GiT-vMRh3K-8SYoE/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMVPN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font><br><br><h1>  useful links </h1><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The IPSec </font></font><br> <a href="http://www.firewall.cx/networking-topics/protocols/870-ipsec-modes.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.firewall.cx/networking-topics/protocols/870-ipsec-modes.html </font></font></a> <br> <a href="http://www.tcpipguide.com/free/t_IPSecModesTransportandTunnel.htm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.tcpipguide.com/free/t_IPSecModesTransportandTunnel.htm</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the DMVPN </font></font><br> <a href="http://www.anticisco.ru/blogs/%3Ftag%3Ddmvpn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.anticisco.ru/blogs/?tag=dmvpn </font></font></a> <br> <a href="http://xgu.ru/wiki/%25D0%259D%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0_DMVPN_%25D0%25BD%25D0%25B0_%25D0%25BC%25D0%25B0%25D1%2580%25D1%2588%25D1%2580%25D1%2583%25D1%2582%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25B0%25D1%2585_Cisco"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru/wiki/ % D0% 9D% D0% B0% D1% 81% D1% 82% D1% 80% D0% BE% D0% B9% D0% BA% D0% B0_DMVPN_% D0% BD% D0% B0_% D0% BC% D0 % B0% D1% 80% D1% 88% D1% 80% D1% 83% D1% 82% D0% B8% D0% B7% D0% B0% D1% 82% D0% BE% D1% 80% D0% B0 % D1% 85_Cisco</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> NHRP. </font></font><br> <a href="http://habrahabr.ru/post/84738/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habrahabr.ru/post/84738 </font></font></a> <br> <a href="http://blog.ine.com/tag/nhrp/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog.ine.com/tag/nhrp</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FlexVPN. </font></font><br> <a href="http://www.cisco.com/en/US/docs/ios-xml/ios/sec_conn_ike2vpn/configuration/15-2mt/sec-intro-ikev2-flex.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.cisco.com/en/US/docs/ios-xml/ios/sec_conn_ike2vpn/configuration/15-2mt/sec-intro-ikev2-flex.html </font></font></a> <br> <a href="http://habrahabr.ru/post/160555/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habrahabr.ru/post/160555 </font></font></a> <br> <a href="http://alexandremspmoraes.wordpress.com/2012/06/28/hello-world-simple-lan-to-lan-flex-vpn-configuration/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexandremspmoraes.wordpress.com/2012/ 06/28 / hello-world-simple-lan-to-lan-flex-vpn-configuration</font></font></a> <br> <a href="http://alexandremspmoraes.wordpress.com/2012/07/02/flex-vpn-sample-lan-to-lan-configuration-with-dynamic-routing/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexandremspmoraes.wordpress.com/2012/07/02/flex-vpn-sample-lan-to-lan-configuration-with-dynamic-routing This</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article was prepared for you by </font></font><a href="http://habrahabr.ru/users/eucariot/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eucariot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="http://habrahabr.ru/users/thegluck/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thegluck</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For brain-agonizing tasks, thanks to </font></font><a href="http://xgu.ru/wiki/%25D0%259A%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F:%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580_%25D0%259D%25D0%25B0%25D1%2582%25D0%25B0%25D1%2588%25D0%25B0_%25D0%25A1%25D0%25B0%25D0%25BC%25D0%25BE%25D0%25B9%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25BA%25D0%25BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natasha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks for the comments and help </font></font><a href="http://habrahabr.ru/users/jdima/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDima</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The cycle ‚ÄúNetworks for the smallest‚Äù has its own website: </font></font><a href="http://linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linkmeup.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where you can find all the issues neatly folded and ready for thoughtful reading. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And as a moment of self-promotion: last week there was a </font></font><a href="http://linkmeup.ru/blog/37.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zero release of a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podcast for telecommunications operators.</font></font><br></div><p>Source: <a href="https://habr.com/ru/post/170895/">https://habr.com/ru/post/170895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170883/index.html">ZOPO ZP950H</a></li>
<li><a href="../170885/index.html">On the nose what? Google</a></li>
<li><a href="../170887/index.html">Canadian startup Coinkite Cryptobank from Toronto presents offline payment service for cryptocurrency</a></li>
<li><a href="../170889/index.html">Airspace app store from Leap Motion announced</a></li>
<li><a href="../170891/index.html">Toshiba Satellite U840W Ultrabook Video Review</a></li>
<li><a href="../170897/index.html">Runetology (187): Vladimir Gorbunov, founder of Workle.ru</a></li>
<li><a href="../170901/index.html">How to make your server for receiving, processing and sending SMS</a></li>
<li><a href="../170903/index.html">Monitoring HP EVA status from icinga / nagios. Plugin check_eva.py</a></li>
<li><a href="../170905/index.html">OPPO Finder X907 - Thin Facts</a></li>
<li><a href="../170907/index.html">Mobility is a guide to business change.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>