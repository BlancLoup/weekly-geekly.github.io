<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the extension module for Python on C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OMFG! - can exclaim the reader. Why write something on C when there is Python, and will be largely right. However, fortunately, unfortunately our gree...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the extension module for Python on C</h1><div class="post__text post__text-html js-mediator-article">  OMFG!  - can exclaim the reader.  Why write something on C when there is Python, and will be largely right.  However, <s>fortunately,</s> unfortunately our green friend is not omnipotent. <a name="habracut"></a>  So‚Ä¶ <br><br><h4>  Task Description </h4><br>  In the framework of the current project (a virtual machine management system based on <a href="http://libvirt.org/">Libvirt</a> ), it was necessary to programmatically control the <a href="http://en.wikipedia.org/wiki/Loop_device">loop device</a> in Linux.  The first version when based on a call to the command line command losetup via subprocess.Popen () worked fairly well on my Ubuntu 8.04, however, after the deployment, there was a bug report that RHEL and some other systems did not work.  After some trials, it turned out that the losetup accepts slightly different arguments in them, and it will not be possible to implement our task. <br><br>  Having picked the source code of losetup, I saw that all the operations I needed are done by sending IOCTL calls to the device.  With Python's fcntl.ioctl (), something went wrong for me.  It was decided to go down to a lower level, write a module in C. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Disclaimer </h4><br>  As it turned out, fcntl.ioctl () is quite sufficient to implement all that I needed.  I do not remember what scared me at the beginning.  Probably need to work less than 10 hours a day;) <br><br>  On the other hand, if I used it right away - this topic would not exist. <br><br>  So again, for those who read diagonally, <b>there is an excellent module fcntl.ioctl () in Python.</b>  <b>All that read below is just an example.</b> <br><br><h4>  API Planning </h4><br>  All that you can do on Python is to do on Python.  What does not work out is to carry it to a low-level in C. <br><br>  What I can‚Äôt do on python is a bit of a mess: actually mounting / unmounting an image, and checking if the device is busy. <br><br>  As part of the task, there were no requirements for supporting encryption, and other frills, therefore from the C side, the interface turned out to be quite simple: <br><ul><li>  mount (device, imagepath) - mounts the imagepath in the device. </li><li>  unmount (device, imaepath) - frees the device. </li><li>  is_used (device) - 1 if the device is mounted, and 0 if free </li></ul><br><br><h4>  Making a skeleton </h4><br>  The module, by analogy with the command line utility, will be called losetup.  We start favorite Eclipse + PyDev and we create the project.  In it we create losetup.py in which there will be all Python code of the module. <br><br>  The module that implements the low-level interaction with the system is called _losetup.  Our losetup will import _losetup and use it to implement a high-level API. <br><br>  Create a folder src, in which we put two files losetupmodule.c and losetupmodule.h <br><br>  losetupmodule.c <br><blockquote> <code><font color="#BC7A00">#include &lt;Python.h&amp;rt; <br> <br> #include "losetupmodule.h" <br></font> <br> <font color="#408080"><i>//        -  <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> LosetupError; <br> <br> <font color="#408080"><i>//     <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_mount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br> <font color="#408080"><i>//   <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_unmount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br> <font color="#408080"><i>// ,   -   <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_is_used</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#B00040">int</font> fd, is_used; <br> <font color="#008000"><b>const</b></font> <font color="#B00040">char</font> <font color="#666666">*</font> device; <br> <font color="#008000"><b>struct</b></font> loop_info64 li; <br> <br> <font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"s"</font> , <font color="#666666">&amp;</font> device)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br> <br> <font color="#008000"><b>if</b></font> ((fd <font color="#666666">=</font> open (device, O_RDONLY)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> <br> is_used <font color="#666666">=</font> ioctl(fd, LOOP_GET_STATUS64, <font color="#666666">&amp;</font> li) <font color="#666666">==</font> <font color="#666666">0</font> ; <br> <br> close(fd); <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">"i"</font> , is_used); <br> } <br> <br> <font color="#408080"><i>//     <br> // , , ,  <br></i></font> <font color="#008000"><b>static</b></font> PyMethodDef LosetupMethods[] <font color="#666666">=</font> { <br> { <font color="#BA2121">"mount"</font> ,  losetup_mount, METH_VARARGS, <font color="#BA2121">"Mount image to device. Usage _losetup.mount(loop_device, file)."</font> }, <br> { <font color="#BA2121">"unmount"</font> ,  losetup_unmount, METH_VARARGS, <font color="#BA2121">"Unmount image from device.  Usage _losetup.unmount(loop_device)."</font> }, <br> { <font color="#BA2121">"is_used"</font> , losetup_is_used, METH_VARARGS, <font color="#BA2121">"Returns True is loopback device is in use."</font> }, <br> { <font color="#008000">NULL</font> , <font color="#008000">NULL</font> , <font color="#666666">0</font> , <font color="#008000">NULL</font> } <font color="#408080"><i>/* Sentinel */</i></font> <br> }; <br> <br> <font color="#408080"><i>//  <br></i></font> PyMODINIT_FUNC <br> <font color="#0000FF">init_losetup</font> ( <font color="#B00040">void</font> ) <br> { <br> PyObject <font color="#666666">*</font> m; <br> <br> <font color="#408080"><i>//   _losetup <br></i></font> m <font color="#666666">=</font> Py_InitModule( <font color="#BA2121">"_losetup"</font> , LosetupMethods); <br> <font color="#008000"><b>if</b></font> (m <font color="#666666">==</font> <font color="#008000">NULL</font> ) <br> <font color="#008000"><b>return</b></font> ; <br> <br> <font color="#408080"><i>//   <br></i></font> LosetupError <font color="#666666">=</font> PyErr_NewException( <font color="#BA2121">"_losetup.error"</font> , <font color="#008000">NULL</font> , <font color="#008000">NULL</font> ); <br> Py_INCREF(LosetupError); <br> PyModule_AddObject(m, <font color="#BA2121">"error"</font> , LosetupError); <br> } <br></code> </blockquote> <code><font color="#BC7A00">#include &lt;Python.h&amp;rt; <br> <br> #include "losetupmodule.h" <br></font> <br> <font color="#408080"><i>//        -  <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> LosetupError; <br> <br> <font color="#408080"><i>//     <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_mount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br> <font color="#408080"><i>//   <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_unmount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br> <font color="#408080"><i>// ,   -   <br></i></font> <font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_is_used</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#B00040">int</font> fd, is_used; <br> <font color="#008000"><b>const</b></font> <font color="#B00040">char</font> <font color="#666666">*</font> device; <br> <font color="#008000"><b>struct</b></font> loop_info64 li; <br> <br> <font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"s"</font> , <font color="#666666">&amp;</font> device)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br> <br> <font color="#008000"><b>if</b></font> ((fd <font color="#666666">=</font> open (device, O_RDONLY)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> <br> is_used <font color="#666666">=</font> ioctl(fd, LOOP_GET_STATUS64, <font color="#666666">&amp;</font> li) <font color="#666666">==</font> <font color="#666666">0</font> ; <br> <br> close(fd); <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">"i"</font> , is_used); <br> } <br> <br> <font color="#408080"><i>//     <br> // , , ,  <br></i></font> <font color="#008000"><b>static</b></font> PyMethodDef LosetupMethods[] <font color="#666666">=</font> { <br> { <font color="#BA2121">"mount"</font> ,  losetup_mount, METH_VARARGS, <font color="#BA2121">"Mount image to device. Usage _losetup.mount(loop_device, file)."</font> }, <br> { <font color="#BA2121">"unmount"</font> ,  losetup_unmount, METH_VARARGS, <font color="#BA2121">"Unmount image from device.  Usage _losetup.unmount(loop_device)."</font> }, <br> { <font color="#BA2121">"is_used"</font> , losetup_is_used, METH_VARARGS, <font color="#BA2121">"Returns True is loopback device is in use."</font> }, <br> { <font color="#008000">NULL</font> , <font color="#008000">NULL</font> , <font color="#666666">0</font> , <font color="#008000">NULL</font> } <font color="#408080"><i>/* Sentinel */</i></font> <br> }; <br> <br> <font color="#408080"><i>//  <br></i></font> PyMODINIT_FUNC <br> <font color="#0000FF">init_losetup</font> ( <font color="#B00040">void</font> ) <br> { <br> PyObject <font color="#666666">*</font> m; <br> <br> <font color="#408080"><i>//   _losetup <br></i></font> m <font color="#666666">=</font> Py_InitModule( <font color="#BA2121">"_losetup"</font> , LosetupMethods); <br> <font color="#008000"><b>if</b></font> (m <font color="#666666">==</font> <font color="#008000">NULL</font> ) <br> <font color="#008000"><b>return</b></font> ; <br> <br> <font color="#408080"><i>//   <br></i></font> LosetupError <font color="#666666">=</font> PyErr_NewException( <font color="#BA2121">"_losetup.error"</font> , <font color="#008000">NULL</font> , <font color="#008000">NULL</font> ); <br> Py_INCREF(LosetupError); <br> PyModule_AddObject(m, <font color="#BA2121">"error"</font> , LosetupError); <br> } <br></code> <br>  In losetupmodule.h, just a definition set ruthlessly torn from <a href="http://userweb.kernel.org/~kzak/util-linux-ng/">util-linux-ng</a> <br><br><h4>  Customize the assembly </h4><br>  Modules can be assembled in different ways, but the easiest and most reliable is through setuptools (distutils). <br><br>  Create setup.py <br><blockquote> <code><font color="#008000"><b>from</b></font> <font color="#0000FF"><b>setuptools</b></font> <font color="#008000"><b>import</b></font> setup, Extension <br> setup(name <font color="#666666">=</font> <font color="#BA2121">'losetup'</font> , <br> version <font color="#666666">=</font> <font color="#BA2121">'1.0.1'</font> , <br> description <font color="#666666">=</font> <font color="#BA2121">'Python API for "loop" Linux module'</font> , <br> author <font color="#666666">=</font> <font color="#BA2121">'Sergey Kirillov'</font> , <br> author_email <font color="#666666">=</font> <font color="#BA2121">'serg@rainboo.com'</font> , <br> ext_modules <font color="#666666">=</font> [Extension( <font color="#BA2121">'_losetup'</font> , [ <font color="#BA2121">'src/losetupmodule.c'</font> ], include_dirs <font color="#666666">=</font> [ <font color="#BA2121">'src'</font> ])], <br> py_modules <font color="#666666">=</font> [ <font color="#BA2121">'losetup'</font> ] <br> ) <br></code> </blockquote><br>  All white magic in the string "ext_modules = [Extension ('_ losetup', ['src / losetupmodule.c'], include_dirs = ['src'])]".  It describes the extension named _losetup, whose code is in src / losetupmodule.c, including src.  This is enough for the distutils to build an extension, install it, make all kinds of pekedges out of it (including the win32 installer, although it's not that simple). <br><br>  We check that everything builds by calling "python setup.py build" <br><br><h4>  Build muscle </h4><br>  Implement the mount () method <br><blockquote> <code><font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_mount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#B00040">int</font> ffd, fd; <br> <font color="#B00040">int</font> mode <font color="#666666">=</font> O_RDWR; <br> <font color="#008000"><b>struct</b></font> loop_info64 loopinfo64; <br> <font color="#008000"><b>const</b></font> <font color="#B00040">char</font> <font color="#666666">*</font> device, <font color="#666666">*</font> filename; <br> <br> <font color="#408080"><i>// Check parameters <br></i></font> <font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"ss"</font> , <font color="#666666">&amp;</font> device, <font color="#666666">&amp;</font> filename)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br> <br> <font color="#408080"><i>// Initialize loopinfo64 struct, and set filename <br></i></font> memset( <font color="#666666">&amp;</font> loopinfo64, <font color="#666666">0</font> , <font color="#008000"><b>sizeof</b></font> (loopinfo64)); <br> strncpy(( <font color="#B00040">char</font> <font color="#666666">*</font> )loopinfo64.lo_file_name, filename, LO_NAME_SIZE <font color="#666666">-</font> <font color="#666666">1</font> ); <br> loopinfo64.lo_file_name[LO_NAME_SIZE <font color="#666666">-</font> <font color="#666666">1</font> ] <font color="#666666">=</font> <font color="#666666">0</font> ; <br> <br> <font color="#408080"><i>// Open image file <br></i></font> <font color="#008000"><b>if</b></font> ((ffd <font color="#666666">=</font> open(filename, O_RDWR)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>if</b></font> (errno <font color="#666666">==</font> EROFS) <font color="#408080"><i>// Try to reopen as read-only on EROFS <br></i></font> ffd <font color="#666666">=</font> open(filename, mode <font color="#666666">=</font> O_RDONLY); <br> <font color="#008000"><b>if</b></font> (ffd <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> loopinfo64.lo_flags <font color="#666666">|=</font> LO_FLAGS_READ_ONLY; <br> } <br> <br> <font color="#408080"><i>// Open loopback device <br></i></font> <font color="#008000"><b>if</b></font> ((fd <font color="#666666">=</font> open(device, mode)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> close(ffd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> <br> <font color="#408080"><i>// Set image <br></i></font> <font color="#008000"><b>if</b></font> (ioctl(fd, LOOP_SET_FD, ffd) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> close(fd); <br> close(ffd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> close (ffd); <br> <br> <font color="#408080"><i>// Set metadata <br></i></font> <font color="#008000"><b>if</b></font> (ioctl(fd, LOOP_SET_STATUS64, <font color="#666666">&amp;</font> loopinfo64)) { <br> ioctl (fd, LOOP_CLR_FD, <font color="#666666">0</font> ); <br> close (fd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> close(fd); <br> <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br></code> </blockquote> <code><font color="#008000"><b>static</b></font> PyObject <font color="#666666">*</font> <br> <font color="#0000FF">losetup_mount</font> (PyObject <font color="#666666">*</font> self, PyObject <font color="#666666">*</font> args) <br> { <br> <font color="#B00040">int</font> ffd, fd; <br> <font color="#B00040">int</font> mode <font color="#666666">=</font> O_RDWR; <br> <font color="#008000"><b>struct</b></font> loop_info64 loopinfo64; <br> <font color="#008000"><b>const</b></font> <font color="#B00040">char</font> <font color="#666666">*</font> device, <font color="#666666">*</font> filename; <br> <br> <font color="#408080"><i>// Check parameters <br></i></font> <font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"ss"</font> , <font color="#666666">&amp;</font> device, <font color="#666666">&amp;</font> filename)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br> <br> <font color="#408080"><i>// Initialize loopinfo64 struct, and set filename <br></i></font> memset( <font color="#666666">&amp;</font> loopinfo64, <font color="#666666">0</font> , <font color="#008000"><b>sizeof</b></font> (loopinfo64)); <br> strncpy(( <font color="#B00040">char</font> <font color="#666666">*</font> )loopinfo64.lo_file_name, filename, LO_NAME_SIZE <font color="#666666">-</font> <font color="#666666">1</font> ); <br> loopinfo64.lo_file_name[LO_NAME_SIZE <font color="#666666">-</font> <font color="#666666">1</font> ] <font color="#666666">=</font> <font color="#666666">0</font> ; <br> <br> <font color="#408080"><i>// Open image file <br></i></font> <font color="#008000"><b>if</b></font> ((ffd <font color="#666666">=</font> open(filename, O_RDWR)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>if</b></font> (errno <font color="#666666">==</font> EROFS) <font color="#408080"><i>// Try to reopen as read-only on EROFS <br></i></font> ffd <font color="#666666">=</font> open(filename, mode <font color="#666666">=</font> O_RDONLY); <br> <font color="#008000"><b>if</b></font> (ffd <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> loopinfo64.lo_flags <font color="#666666">|=</font> LO_FLAGS_READ_ONLY; <br> } <br> <br> <font color="#408080"><i>// Open loopback device <br></i></font> <font color="#008000"><b>if</b></font> ((fd <font color="#666666">=</font> open(device, mode)) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> close(ffd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> <br> <font color="#408080"><i>// Set image <br></i></font> <font color="#008000"><b>if</b></font> (ioctl(fd, LOOP_SET_FD, ffd) <font color="#666666">&lt;</font> <font color="#666666">0</font> ) { <br> close(fd); <br> close(ffd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> close (ffd); <br> <br> <font color="#408080"><i>// Set metadata <br></i></font> <font color="#008000"><b>if</b></font> (ioctl(fd, LOOP_SET_STATUS64, <font color="#666666">&amp;</font> loopinfo64)) { <br> ioctl (fd, LOOP_CLR_FD, <font color="#666666">0</font> ); <br> close (fd); <br> <font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError); <br> } <br> close(fd); <br> <br> <font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br> } <br> <br></code> <br><br>  It seems to be easy, but perhaps not quite clear what is happening here.  Let's take a look at the main elements. <br><blockquote> <code><font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"ss"</font> , <font color="#666666">&amp;</font> device, <font color="#666666">&amp;</font> filename)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br></code> </blockquote> <code><font color="#008000"><b>if</b></font> ( <font color="#666666">!</font> PyArg_ParseTuple(args, <font color="#BA2121">"ss"</font> , <font color="#666666">&amp;</font> device, <font color="#666666">&amp;</font> filename)) { <br> <font color="#008000"><b>return</b></font> <font color="#008000">NULL</font> ; <br> } <br></code> <br><br>  Functions declared as METH_VARARGS get arguments in the form of a tuple.  PyArg_ParseTuple () checks that the arguments match the specified pattern (in this case, ‚Äúss‚Äù is two strings), and receives data, or, if the argument does not match the pattern, sets an error, and returns false.  Details on how this works can be found in <a href="http://www.python.org/doc/2.5.2/ext/parseTuple.html">Extracting Parameters in Extension Functions.</a> <br><br>  From the point of view of python, it looks like this: <br><pre> &gt;&gt;&gt; import _losetup
 &gt;&gt;&gt; _losetup.mount ("aaa")
 Traceback (most recent call last):
   File "&lt;stdin&gt;", line 1, in &lt;module&gt;
 TypeError: function takes exactly 2 arguments (1 given)
 &gt;&gt;&gt; _losetup.mount (1,2)
 Traceback (most recent call last):
   File "&lt;stdin&gt;", line 1, in &lt;module&gt;
 TypeError: argument 1 must be string, not int
 &gt;&gt;&gt; 
</pre><br><br>  Go ahead <br><blockquote> <code><font color="#008000"><b>return</b></font> PyErr_SetFromErrno(LosetupError);</code> </blockquote> <br><br>  PyErr_SetFromErrno creates an exception with the specified type, receives an error code from the global variable errno, and returns NULL - which means that the exception has occurred.  Documentation Links: <a href="http://www.python.org/doc/2.5.2/ext/errors.html">Intermezzo: Errors and Exceptions</a> , <a href="http://www.python.org/doc/2.0.1/api/exceptionHandling.html">Exception Handling</a> <br><br>  For python, it looks like this: <br><pre> &gt;&gt;&gt; _losetup.mount ('/ dev / loop0', '/ tmp / somefile')
 Traceback (most recent call last):
   File "&lt;stdin&gt;", line 1, in &lt;module&gt;
 _losetup.error: (2, 'No such file or directory')
 &gt;&gt;&gt; 
</pre><br><br><blockquote> <code><font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br></code> </blockquote> <code><font color="#008000"><b>return</b></font> Py_BuildValue( <font color="#BA2121">""</font> ); <br></code> <br>  Our function does not need to return any specific data, so we return None.  Read more in <a href="http://www.python.org/doc/2.5.2/ext/buildValue.html">Building Arbitrary Values</a> <br><br>  The remaining functions are implemented similarly. <br><br><h4>  PyPI Publication </h4><br>  So the module is written.  We need to give humanity a chance to use it.  The easiest way to do this is to publish a module in the <a href="http://pypi.python.org/">Python Package Index</a> . <br><br>  Register on PyPI. <br><br>  After registration, write to the console <br><blockquote>  python setup.py register </blockquote><br>  Enter your account information, and setuptools will create a PyPI package. <br><br><blockquote>  python setup.py sdist upload </blockquote><br>  does source destribution (tgz archive with code and metadata), and uploads it to PyPI. <br><br>  The result can be seen here <a href="http://pypi.python.org/pypi/losetup/">http://pypi.python.org/pypi/losetup/</a> <br><br>  We go to the hated RHEL, write easy_install -U losetup, and while we speak the magic words ‚Äúcryble-craft-bumc‚Äù, setuptools will download our package, bring it down and install it into the system. <br><br>  Add losetup as a dependency in the setup.py of the main application.  Now when it is installed, setuptools will also be installed by our module. <br><br><h4>  Completion </h4><br>  So, it was unexpectedly easy to fall from Python to the abstraction level below, and write a module for low-level interaction with the system. <br><br>  We also got a good example of what you need to think more and do less.  Our Green Friend is powerful, and even such exotic tasks can be solved without parting with it. <br><br>  What you want. <br><br><h4>  Used literature </h4><br><ul><li>  <a href="http://www.python.org/doc/2.5.2/ext/ext.html">Extending and Embedding the Python Interpreter</a> Guido van Rossum </li></ul></div><p>Source: <a href="https://habr.com/ru/post/44520/">https://habr.com/ru/post/44520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445190/index.html">Buy back / not buy back: our ML-pilot in the "Platypus"</a></li>
<li><a href="../445192/index.html">4K: evolution or marketing?</a></li>
<li><a href="../445194/index.html">10 concepts for the designer in 2019</a></li>
<li><a href="../445196/index.html">Kubernetes 1.14: a review of major innovations</a></li>
<li><a href="../445198/index.html">Console Player cmus for Linux</a></li>
<li><a href="../445200/index.html">Internet providers ask the Ministry of Communications and Mass Media to let them into homes without an agreement</a></li>
<li><a href="../445204/index.html">Stream Firebird 2.5 bases conversion to ODS12 format (Firebird 3.0)</a></li>
<li><a href="../445206/index.html">Reduce downtime when updating Zimbra</a></li>
<li><a href="../445208/index.html">Maturity Levels of Enterprise IT Infrastructure</a></li>
<li><a href="../44521/index.html">Google has the worst economic situation right now.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>