<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cackle comment system: how we did the analytics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In our previous post about the cloud service Cackle, we talked about architecture, technology and loads in general. Today we want to share how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cackle comment system: how we did the analytics</h1><div class="post__text post__text-html js-mediator-article">  <b>Hello!</b>  In our <a href="http://habrahabr.ru/company/cackle/blog/255013/">previous post</a> about the cloud service Cackle, we talked about architecture, technology and loads in general.  Today we want to share how under the conditions of such heavy loads and already accumulated information (30,000,000 comments from 2011) we did a detailed analytics for <a href="http://cackle.ru/">the Cackle comment system</a> .  Our method of collecting statistics is universal and I think it will be interesting, in terms of practical application, to all those who are faced with the task of developing analytics, but for the time being do not quite know where to start. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b77/eb9/6d6/b77eb96d604a0c68e775c5ee202c40ab.png" alt="Cackle analyst"></div><br><a name="habracut"></a><br><h2>  <font color="#144269">Not a lot of source data</font> </h2><br>  Since the <a href="http://cackle.ru/comments">Cackle comment system has</a> been in operation since 2011, about 30 million comments have been accumulated.  About 100,000 are published per day, on peaks, per second, up to 1000 simultaneous. <br><br>  All this in the database is stored in the comment table of 15GB size.  The table is indexed by the site_id field, which is the client's site identifier.  Total registered 35,000 sites.  The largest number of comments is rusvesna.su (9 million), svpressa.ru (800 thousand), 3dnews.ru (500 thousand), carambatv.ru (450 thousand). <br><br>  Requirements for analytics are the collection and updating of daily statistics for each site: <br><ul><li>  Comments (total, published, pending, spam, deleted); </li><li>  Likes and dislikes; </li><li>  Comments from social providers, anonymous and SSO (authorized through a single authorization mechanism). </li></ul><br>  All this should work quickly regardless of the site, large or very small. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <font color="#144269">Server part - PostgreSQL</font> </h2><br>  As we <a href="http://habrahabr.ru/company/cackle/blog/255013/">wrote earlier</a> , as a database we have PostgreSQL with replication into several data centers distributed throughout Russia and Europe.  PostgreSQL copes with the load and it was chosen as the main component of the business logic for collecting comment statistics. <br><br>  In short, the collection is done in two stages. <br><br>  Suppose a client came into the administration panel, chose one of their sites and moved to Analytics: <br>  1. If the selected site has comments and no statistics on them, then PostgreSQL executes an SQL request for the initial collection of statistics on all the necessary parameters; <br>  2. Next, the same SQL query will be put in the heading and executed every 15 minutes to update the data. <br><br><h3>  <font color="#0078b6">1. Initial collection of statistics for all comments.</font> </h3><br>  So we need to collect daily statistics of comments for all the time for: the selected site (site_id), for all (total), approved (approved), pending (pending), spam (spam), deleted (deleted) comments, likes (up) , dizlaykam (down), as well as for each social provider (vk, ok, fb, tw, gp, etc.), anonymous (anonym) or SSO (sso) user from the comment table and mc_user (user table) .  The comment.created field is the time the comment was created. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, :siteId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> site_id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> total, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> approved, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pending, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> spam, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> deleted, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.rating &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> up, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.rating &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> down, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'vkontakte'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> vk, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'odnoklassniki'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ok, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'facebook'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fb, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'twitter'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tw, ... <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'sso'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sso, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.anonym &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> anonym <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.id, c.created, c.status, c.rating, c.anonym, u.provider <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mc_user u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.author = u.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.site_id = :siteId ) t <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created);</code> </pre> <br>  The distribution of the query execution time depends on the number of site comments and looks like this: <br>  1. Comments up to 100 000 - request time up to 5 seconds; <br>  2. Comments up to 1 000 000 - request time up to 1 min; <br>  3. Comments up to 9 000 000 - request time up to 2 minutes; <br><br>  It is clear that every time chasing this SQL is suicide and therefore we need to create additional tables to store the data received by this query. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> comment_stats ( <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, site_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, total <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, approved <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, pending <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, spam <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, deleted <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, up <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, down <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, vk <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ok <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, fb <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, tw <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ... sso <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, anonym <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> comment_stats_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, site_id) );</code> </pre><br>  Next, add the INSERT INTO comment_stats to the first SQL query. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, :siteId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> site_id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> total, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> approved, ...</code> </pre><br>  Now we will get the analytics data directly from the comment_stats table: <br>  <code>select * from comment_stats where site_id = :siteId</code> . <br><br><h3>  <font color="#0078b6">2. Update data</font> </h3><br>  There was a problem updating data.  It is impossible to simply take and execute the SQL of the initial collection of statistics all the time, because if analytics are connected to several large sites, the database performance will disappear. <br><br>  The simplest and most effective solution is to add a new comment_id field to the comment_stats table, which stores the maximum comment id for each day.  When updating data, the collection of statistics will begin with this id.  Given all this, we modify the initial request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, :siteId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> site_id, <span class="hljs-comment"><span class="hljs-comment">--   id     MAX(t.id) as comment_id, COUNT(t) as total, SUM(CASE WHEN t.status = 1 THEN 1 ELSE 0 END) as approved, ... SUM(CASE WHEN t.anonym &gt; 0 THEN 1 ELSE 0 END) as anonym FROM ( SELECT c.id, c.created, c.status, c.rating, c.anonym, u.provider FROM comment c LEFT JOIN mc_user u ON c.author = u.id WHERE c.site_id = :siteId --    id    comment_id   comment_stats AND c.id &gt; (SELECT COALESCE(MAX(comment_id), 0) FROM comment_stats WHERE site_id = :siteId) ) t GROUP BY DATE_TRUNC('day', t.created) ORDER BY DATE_TRUNC('day', t.created);</span></span></code> </pre><br>  If anyone noticed, then this construction <code>COALESCE(MAX(comment_id), 0)</code> allows you to make one request both for the initial collection of statistics, as well as for updating data.  That is, if there is nothing in comment_stats, then we return 0 and the collection goes through the entire comment table for site_id, if there is data, then the collection starts only from the last comment_id. <br><br>  Now everything is OK, except that in this form the data update request will not work.  Since the first call for already collected statistics will result in an exception caused by an attempt to insert data with the already existing private key comment_stats_pkey.  In other words, we collected the initial statistics, 15 minutes had passed, the update data was launched with the condition id&gt; last comment_id from comment_stats and if someone published new comments during this time, our query will try to insert data with the same day and site_id. <br><br>  There is a very simple solution (without any <a href="http://www.postgresql.org/docs/9.4/static/rules-update.html">Rules on INSERT</a> ) - before requesting data update, delete the last line in the comment_stats table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id = :siteId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id = :siteId <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Summary code</b> <div class="spoiler_text">  The comment_stats table contains all the statistics for all sites: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> comment_stats ( <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, site_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, total <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, approved <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, pending <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, spam <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, deleted <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, up <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, down <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, vk <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ok <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, fb <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, tw <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ... sso <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, anonym <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> comment_stats_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, site_id) );</code> </pre><br><br>  Single request for the initial collection or updating of statistics: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, :siteId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> site_id, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t.id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> comment_id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> total, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> approved, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pending, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> spam, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.status = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> deleted, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.rating &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> up, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.rating &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> down, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'vkontakte'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> vk, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'odnoklassniki'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ok, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'facebook'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fb, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'twitter'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tw, ... <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.provider = <span class="hljs-string"><span class="hljs-string">'sso'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sso, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.anonym &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> anonym <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.id, c.created, c.status, c.rating, c.anonym, u.provider <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mc_user u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.author = u.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.site_id = :siteId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> c.id &gt; (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(comment_id), <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id = :siteId) ) t <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DATE_TRUNC(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, t.created);</code> </pre><br><br>  Before updating it is necessary to start: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id = :siteId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> comment_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id = :siteId <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br></div></div><br><br>  The described mechanism is very simple and effective.  It has simple logic, which is suitable for collecting almost any statistics of objects in a relational database.  For example, we, using all the same 2 SQL queries (deletion, collection), collect statistics of moderators, publications (posts), and very soon the same analytics will appear for the <a href="http://cackle.ru/reviews">Cackle Reviews</a> review system. <br><br><h2>  <font color="#144269">Client part - HighCharts</font> </h2><br>  In the client browser, we use <a href="http://www.highcharts.com/">HighCharts</a> to display charts.  This is a paid library (for commercial projects) charting.  I have to say that before choosing HighCharts, we looked at many <a href="http://en.wikipedia.org/wiki/Comparison_of_JavaScript_charting_frameworks">similar frameworks,</a> and none was better. <br><br>  From what I liked most: the lack of lags even at 33,000 thousand points, mobile adaptability, clever time interval narrowing, easy integration, good API.  By the way, for startups they have a discount, you can ask for it in a letter. <br><br><div class="spoiler">  <b class="spoiler_title">Javascript integration code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Highcharts.Chart({ <span class="hljs-attr"><span class="hljs-attr">chart</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'line'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// &lt;div id="chart"&gt;&lt;/div&gt; renderTo: 'chart' }, title: { text: '', style: { //title   display: 'none' } }, xAxis: { // days      ( comment_stats) //    ['2015-05-03', '2015-05-04', ... '2015-06-03'] categories: days }, yAxis: { min:0, title: { // Y  text: MESSAGES.comments } }, legend: { layout: 'vertical', align: 'right', verticalAlign: 'middle', borderWidth: 0 }, //series      : // , , ,   ,   .. series: series //  credits: { enabled: false } }); // series //Params -   var Params = [ { name: 'total', index: 3, color: '#999' }, { name: 'approved', index: 4, color: '#9edd69' }, { name: 'pending', index: 5, color: '#ffbb3d' }, { name: 'spam', index: 6, color: '#ff95af' }, { name: 'deleted', index: 7, color: '#666' }, { name: 'up', index: 8, color: '#239600' }, { name: 'down', index: 9, color: '#ff2f2f' }, { name: 'vk', index: 10, color: '#6383a8' }, { name: 'ok', index: 11, color: '#eb722e' }, { name: 'fb', index: 13, color: '#4e69a2' }, { name: 'tw', index: 14, color: '#55acee' }, ... { name: 'sso', index: 22, color: '#17c200' }, { name: 'anonym', index: 23, color: '#c6cde0' } ]; for (var p in Params) { //stats         //: stats.total, stats.spam, stats.vk, stats.anony  .. var param = Params[p], stat = stats[param.name]; if (stat) { series.push({ nick: param.name, name: MESSAGES[param.name], //  data: stat, color: param.color }); } }</span></span></code> </pre><br></div></div><br>  A few screenshots of how this ultimately looks. <br><br><div style="text-align:center;"> <a href="http://cackle.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/8cc/48e/1cb/8cc48e1cb1522bd07640f7ede1e42548.png" alt="Cackle analyst comment system"></a> </div><br><div style="text-align:center;"> <a href="http://cackle.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/e28/61e/519/e2861e519fef20bb20c8f5792a0ca52a.png" alt="Cackle analyst comment system"></a> </div><br><div style="text-align:center;"> <a href="http://cackle.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/488/854/f1a488854932185eff150d218d7c4363.png" alt="Cackle analyst comment system"></a> </div><br><div style="text-align:center;"> <a href="http://cackle.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/7c3/198/b96/7c3198b9610535384e441a56a6cc4919.png" alt="Cackle analyst comment system"></a> </div><br><div style="text-align:center;"> <a href="http://cackle.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/a73/627/66d/a7362766d7e1136b34f6bdac077a3e5c.png" alt="Cackle analyst comment system"></a> </div><br>  If you have additional questions on the above technology or on <a href="http://cackle.ru/">our system,</a> we will be happy to answer hi@cackle.me. <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/259301/">https://habr.com/ru/post/259301/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259291/index.html">Tunnel modeling - version 0.9</a></li>
<li><a href="../259293/index.html">Time management for the developer</a></li>
<li><a href="../259295/index.html">From detour to Dijkstra‚Äôs algorithm</a></li>
<li><a href="../259297/index.html">Interface settings and much more in the assembly Vivaldi 1.0.190.2</a></li>
<li><a href="../259299/index.html">Rusty evidence</a></li>
<li><a href="../259303/index.html">Creating plug-ins for AutoCAD using the .NET API (Part 5 - Introduction to Blocks)</a></li>
<li><a href="../259305/index.html">PHP Digest number 63 - interesting news, materials and tools (May 11 - 31, 2015)</a></li>
<li><a href="../259307/index.html">Operations as objects</a></li>
<li><a href="../259309/index.html">Web Application Security Audit Methodology</a></li>
<li><a href="../259311/index.html">AngularJS vs. Backbone.js vs. Ember.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>