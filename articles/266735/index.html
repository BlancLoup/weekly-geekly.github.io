<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Snaql. Raw SQL in Python projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last year, I have a new rule - every 3 months to learn a new programming language and its ecosystem. There are several reasons for this: new pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Snaql. Raw SQL in Python projects</h1><div class="post__text post__text-html js-mediator-article">  In the last year, I have a new rule - every 3 months to learn a new programming language and its ecosystem.  There are several reasons for this: new paradigms, concepts, tools, and it‚Äôs just interesting what is there, on the other side of Python, which has become awesome over the years.  This simple rule allowed studying modern hipster Go, Clojure and Rust for the current year, imbued with their ideas and best practices, which, by the way, has a very positive effect on the style and quality of the code when I write in my main language. <br><br>  Looking at the <a href="http://www.luminusweb.net/">Luminus</a> stack, I came across a simple and at the same time chic, for my taste, <a href="https://github.com/krisajenkins/yesql">Yesql</a> library for organizing SQL queries in a project on Clojure and I did not see something similar for Python (maybe I was looking bad).  The idea of ‚Äã‚Äãthis library is simple - do not fool yourself, use ordinary SQL queries, you have the possibility of naming these queries and mapping to the corresponding dynamic functions.  All this looks like a set of micro-templates with SQL and their rendering for some context.  Simply, effectively, I want this in my project in Python. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, lately I have been impressed by the idea that ORMs are not needed.  They overcomplicate, in fact, work with relational databases, hide ‚Äúhellish‚Äù SQL behind the screen of complex constructions of their own objects, and often produce an extremely inefficient result.  Surely someone will argue with this conclusion, but my practice has shown that Django ORM is terribly simple a little more than ever (and is only available if you use Django, of course), SQLAlchemy is terribly complex, Peewee has never met in the wild. the same a little more and he will become like Alchemy on his own threshold of entry.  SQL is in itself a powerful and expressive DSL, you don't need another level of abstraction over it, seriously.  From a different angle, I was thinking about the feasibility of ORM during the next Tornado project.  Alchemy miraculously alchemically kills all the asynchronous execution of the handler with blocking calls to the database.  And the options except how to use the same Momoko with raw queries, I did not see. <br><br>  All we need for complete happiness is the dilution of SQL strings and Python code in different angles and some flexibility in constructing constructions by conditions or context.  Well, stop being afraid to write SQL, of course.  Studying SQL to the required level is really easier than all the nuances of Alchemy for the same result. <br><br>  After trying and rethinking Yesql a little bit, I had a tiny Snaql library that solves the problem described above, albeit in a slightly different way.  I decided not to bind clients to the databases at all and use Jinja2 as an engine for parsing and rendering templates with SQL blocks (with all the ensuing possibilities to use its template logic).  Here's what it looks like. <br><br>  1. We put Snaql. <br><br><pre><code class="bash hljs">$ pip install snaql</code> </pre> <br><br>  2. Create in your project a folder where we will add files with SQL blocks.  Or several such folders. <br><br><pre> <code class="bash hljs">/queries users.sql</code> </pre><br><br>  3. In users.sql we have, for example, all queries related to the user's identity. <br><br><pre> <code class="bash hljs">{% sql <span class="hljs-string"><span class="hljs-string">'users_by_country'</span></span>, note=<span class="hljs-string"><span class="hljs-string">'counts users'</span></span> %} SELECT count(*) AS count FROM user WHERE country_code = ? {% endsql %}</code> </pre><br><br>  As you can guess, SQL is placed inside the {% sql%} {% endsql%} block, ‚Äúusers_by_country‚Äù is the name of the function that this SQL is attached to (it is created dynamically), and ‚Äúnote‚Äù is the docstring to this function, it is optional. <br><br>  There can be any number of such blocks in one file.  The main thing is that their names are unique. <br><br>  4. Now we need a factory that parses such files and creates a set of functions of the same name. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> snaql.factory <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Snaql <span class="hljs-comment"><span class="hljs-comment">#   root_location = os.path.abspath(os.path.dirname(__file__)) #     snaql_factory = Snaql(root_location, 'queries') #    SQL- # users_queries = snaql_factory.load_queries('users.sql')</span></span></code> </pre><br><br>  Extract the necessary SQL in the code, you can now simply call <br><br><pre> <code class="python hljs">your_sql = users_queries.users_by_country() <span class="hljs-comment"><span class="hljs-comment"># SELECT count(*) AS count # FROM user # WHERE country_code = ?</span></span></code> </pre><br><br>  In fact, this may already be enough.  But not in the case of the generated query terms.  In this case, you can add to the template all the logic that Jinja provides.  For example: <br><br><pre> <code class="python hljs">{% sql <span class="hljs-string"><span class="hljs-string">'users_select_cond'</span></span>, note=<span class="hljs-string"><span class="hljs-string">'select users with condition'</span></span> %} SELECT * FROM user {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> users_ids %} WHERE user_id IN ({{ users_ids|join(<span class="hljs-string"><span class="hljs-string">', '</span></span>) }}) {% endif %} {% endsql %}</code> </pre><br><br>  If you call a function without context: <br><br><pre> <code class="python hljs">your_sql = users_queries.users_select_cond() <span class="hljs-comment"><span class="hljs-comment"># SELECT * # FROM user</span></span></code> </pre><br><br>  And if with context: <br><br><pre> <code class="python hljs">your_sql = users_queries.users_select_cond(users_ids=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]) <span class="hljs-comment"><span class="hljs-comment"># SELECT * # FROM user # WHERE user_id IN (1, 2, 3)</span></span></code> </pre><br><br>  Having received the generated SQL, the rest is a matter of technique.  It seems not bad, right?  In any case, write your pros and cons in the comments, I‚Äôm interested in the opinion of the community, as far as it can be convenient for someone other than me. <br><br>  <a href="https://github.com/semirook/snaql">GitHub</a> , <a href="">PyPi</a> <br><br>  UPD: Thanks for the constructive comments.  Now I have a way to form a roadmap on 0.2.  Feel free to send issues and requests to GitHub. <br><br>  UPD2: Thanks to your constructive notes, I updated Snaql to version 0.2, there are now guards and conditions blocks, extended support for interpreter versions to 2.6, 2.7, 3.3, 3.4, 3.5. </div><p>Source: <a href="https://habr.com/ru/post/266735/">https://habr.com/ru/post/266735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266721/index.html">Z-Desk - geometric constructions in space</a></li>
<li><a href="../266727/index.html">About a Data Science Problem</a></li>
<li><a href="../266729/index.html">We log context of exceptions</a></li>
<li><a href="../266731/index.html">Run a mega-manual from Stackoverflow</a></li>
<li><a href="../266733/index.html">Why SMS is limited to 160 characters, and Twitter messages - 140 characters?</a></li>
<li><a href="../266743/index.html">Python 3.5; async / await</a></li>
<li><a href="../266745/index.html">Vim-like control with xmodmap</a></li>
<li><a href="../266747/index.html">Once again about type casting in C ++ or the arrangement of all points above the cast</a></li>
<li><a href="../266749/index.html">Group the same applications from different stores by icon</a></li>
<li><a href="../266753/index.html">Walking across tiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>