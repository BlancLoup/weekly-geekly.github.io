<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Zabbix API. When there is not enough standard statistics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a task to get some statistics from Zabbix, I share the experience of getting data from the Zabbix database through the API using Python tool...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Zabbix API. When there is not enough standard statistics</h1><div class="post__text post__text-html js-mediator-article">  There was a task to get some statistics from Zabbix, I share the experience of getting data from the Zabbix database through the API using Python tools. <br><br><img src="https://habrastorage.org/files/330/9e6/13e/3309e613e2d24ca7b1b40375928a00bf.png"><br><a name="habracut"></a><br>  Pieces of code will be for Python 2.7 <br><br>  There is a ready <a href="https://github.com/blacked/py-zabbix">py-zabbix</a> library for working with zabbix-api, documentation on it is available <a href="https://py-zabbix.readthedocs.io/en/latest/quickstart_guide.html">here</a> , but there are not many examples.  The official <a href="https://www.zabbix.com/documentation/3.0/manual/api">Zabbix API</a> manual. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, after the standard installation: <br><br><pre><code class="bash hljs">pip install py-zabbix</code> </pre> <br>  We are trying to connect to the Zabbix server: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI z = ZabbixAPI(<span class="hljs-string"><span class="hljs-string">'https://172.16.1.10'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'user1'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'pass1'</span></span>) answer = z.do_request(<span class="hljs-string"><span class="hljs-string">'apiinfo.version'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Version:"</span></span>,answer[<span class="hljs-string"><span class="hljs-string">'result'</span></span>]</code> </pre><br>  The format of the response from the server is JSON: <br><br><pre> <code class="hljs python">{<span class="hljs-string"><span class="hljs-string">u'jsonrpc'</span></span>: <span class="hljs-string"><span class="hljs-string">u'2.0'</span></span>, <span class="hljs-string"><span class="hljs-string">u'result'</span></span>: <span class="hljs-string"><span class="hljs-string">u'3.0.2'</span></span>, <span class="hljs-string"><span class="hljs-string">u'id'</span></span>: <span class="hljs-string"><span class="hljs-string">u'1'</span></span>}</code> </pre><br>  The script prints the contents of the <i>result</i> field: <br><br><pre> <code class="bash hljs">Version: 3.0.2</code> </pre> <br>  Now you can take to solving the problem of interest.  The task is to get the average value of Disk Idle Time from all virtual machines per week (Mon-Fri) during working hours (from 10:00 to 19:00) for a certain week.  I do not want to focus on the relevance of these parameters, but simply share my experience with the Zabbix API using the example of this specific task. <br><br>  So, virtual machines in Zabbix are in a separate group, first we get a list of available groups using the <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/hostgroup/get">hostgroup.get</a> method: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#Get List of available groups groups = z.hostgroup.get(output=['itemid','name']) for group in groups: print group['groupid'],group['name']</span></span></code> </pre><br>  With the <i>output</i> parameter you can determine which fields the API returns: <br><br><pre> <code class="bash hljs">38 _Local Domains 53 _Local NAS 23 _Local Servers Linux 27 _Local Servers Virtual Linux 25 _Local Servers Virtual Windows 24 _Local Servers Windows 35 _Local Switches</code> </pre><br>  You can then get a list of hosts in a specific group using the <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/host/get">host.get</a> method: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#Get List of hosts in the group hosts = z.host.get(groupids=25, output=['hostid','name']) for host in hosts: print host['hostid'],host['name']</span></span></code> </pre><br>  The <i>groupids</i> parameter specifies the group ID: <br><br><pre> <code class="bash hljs">10197 DC1_--172.16.1.4-- 10204 DC2_--172.16.1.5-- 10637 LocalDB_--172.16.1.12-- 10686 WSUS_--172.16.1.16-- 10708 Jira_--172.16.1.24--</code> </pre><br>  To get a list of items for a specific host, use the <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/item/get">item.get</a> method: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#Get List of items on the host items = z.item.get(hostids=10637, output=['itemid','name']) for item in items: print item['itemid'],item['name']</span></span></code> </pre><br>  Result: <br><br><pre> <code class="bash hljs">525617 ICMP ping 525618 ICMP loss 525619 ICMP response time 940205 Input Microsoft Hyper-V Network Adapter <span class="hljs-comment"><span class="hljs-comment">#2 940206 Output Microsoft Hyper-V Network Adapter #2 990808 Disk Idle time on C: 990809 Disk Idle time on D:</span></span></code> </pre><br>  As can be seen from the answer, the selected host has 2 disks, you need to display the minimum value from several.  To access data on items, use the <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/history/get">history.get</a> method.  The following code does not claim to be optimal, I just started learning Python, but in general, the script coped with the task. <br><br>  For the <i>history.get</i> method, you need to define the following parameters: <br><br><ul><li>  history - type of return value </li><li>  itemids - the id of the item of interest </li><li>  time_from - the beginning of the time interval </li><li>  time_till - the end of the time interval </li></ul><br>  Script collecting statistics: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys z = ZabbixAPI(<span class="hljs-string"><span class="hljs-string">'https://172.16.1.10'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'user1'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'pass1'</span></span>) groupid = <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-comment"><span class="hljs-comment">#Local Servers Virtual Windows hosts = z.host.get(groupids=groupid , output=['hostid','name']) #   host_names = [host['name'] for host in hosts] #  host_ids = [host['hostid'] for host in hosts] nameindex = 0 #, -    increment = 60*60*24 for host_id in host_ids: # search    items,       items = z.do_request('item.get',{'hostids':[host_id],'output': ['itemid','name'],'search':{'name': 'Idle time'}}) #   disk_ids = [item['itemid'] for item in items['result']] #   -  num_disks = len(disk_ids) avg_list=[] #      for disk in disk_ids: #       time # ,     - 27  2017 ,  9:00  18:00 time_from = time.mktime((2017,3,27,9,0,0,0,0,0)) time_till = time.mktime((2017,3,27,18,0,0,0,0,0)) history_sum=0 history_len=0 #  5   27  31  for day in range(0,5): data = z.history.get(history = 0, itemids=disk, time_from=time_from, time_till=time_till) #      graph = [float(item['value']) for item in data] #   ,        if(len(graph)!=0): history_sum+=sum(graph) history_len+=len(graph) #    time_from += increment time_till += increment #   ,        if(history_len!=0): avg_list.append(history_sum/history_len) else: avg_list.append(0) #   ,    if(len(avg_list)&gt;0): sys.stdout.write(host_names[nameindex]) print ',',num_disks,',',min(avg_list) nameindex+=1</span></span></code> </pre><br>  The result is a comma-separated host name, number of screws, and min idle time: <br><br><pre> <code class="bash hljs">DC1_--172.16.1.4--, 1 , 99.0758766296 DC2_--172.16.1.5--, 1 , 97.0989181683 LocalDB_--172.16.1.12--, 2 , 98.9930628704</code> </pre><br>  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/325876/">https://habr.com/ru/post/325876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325864/index.html">What "kills" the seller</a></li>
<li><a href="../325866/index.html">101 free services for the designer</a></li>
<li><a href="../325868/index.html">Starting your blog on Ghost using docker-compose</a></li>
<li><a href="../325872/index.html">ASP.NET Core: Creating ASP.NET Web API Reference Pages with Swagger</a></li>
<li><a href="../325874/index.html">Returning to Unallocated Final Interpreters with Dotty</a></li>
<li><a href="../325880/index.html">The test of knowledge of the C language, found in April Fool's joke</a></li>
<li><a href="../325882/index.html">Vulnerability of the Xen hypervisor allows access to host memory from a virtual machine</a></li>
<li><a href="../325884/index.html">7 bad tips to the REST API designer</a></li>
<li><a href="../325888/index.html">ThinkPHP # 14 Mitap in Kharkov. 5 years together</a></li>
<li><a href="../325890/index.html">Review of the section "Design" at the conference DUMP-2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>