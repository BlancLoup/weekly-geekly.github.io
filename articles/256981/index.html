<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The use of STM32 in industrial machines on the example of the blow molding machine CHODOS (Czech Republic)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of the shops of the company where I work, there is a machine that produces plastic packaging. The machine is called a blow molding machine. It ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The use of STM32 in industrial machines on the example of the blow molding machine CHODOS (Czech Republic)</h1><div class="post__text post__text-html js-mediator-article">  In one of the shops of the company where I work, there is a machine that produces plastic packaging.  The machine is called a blow molding machine.  It was released in 1988 in Karlovy Vary by CHODOS: <br><br><img src="https://habrastorage.org/files/e98/215/aca/e98215aca6354203ba69ccf3ade26f55.jpg" alt="image"><br><br>  Cycle controls electronics on TTL logic chips (such as K155 (555) or SN74xx).  Under the cut, I'll tell you how I replaced the electronics of the last century with the STM32 microcontroller. <br><a name="habracut"></a><br>  The principle of operation of the blow molding machine in brief is as follows: the plastic crumb coming from the bunker melts and is squeezed out by a screw under pressure through nozzles, forming ‚Äúsleeves‚Äù.  After that, the ‚Äúsleeves‚Äù are cut off and fed into blow molding forms in which a product is formed under the pressure of the supplied air (in my case, it is a plastic bottle). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The machine is controlled by a pair of dozens of TTL-logic boards, several load switch boards with seven-dors for switching on valves and actuators, several boards of transducers of input signal levels from limit switches.  All boards are inserted into the basket with connectors in the control cabinet.  In the basket, all connected by the method of cheating.  TTL logic boards are assembled on TESLA production chips (analogs of K155 (555) or SN74XX). <br><br>  The indication of the cycle state is practically absent and therefore during its strong glitches it is almost impossible to understand what's wrong with it.  In addition, the boards eventually fail and before you repair them, you need to go through an endless quest with a multimeter and a bunch of paper schemes, and even in uncomfortable positions. <br><br><div class="spoiler">  <b class="spoiler_title">Photo baskets with cards (2 photos)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/667/1c7/312/6671c731212b4c6da1392dcb0b9c1067.jpg"><br><br><img src="https://habrastorage.org/files/9ba/1da/91a/9ba1da91a6614ade987352f262a97f35.jpg"><br></div></div><br>  It was decided to transfer the control and management of the casting cycle to microcontrollers.  The first experimental controller was the Arduino Mega 2560. The controller was very "gentle" to work in conditions of strong electromagnetic bursts from starters and electric motors.  He just hung out when he pleased.  Neither the shielding of the controller itself, nor the replacement of all cables coming from the limit switches to an earthed MKESh 3x0.5, helped.  And of course, the entire wiring of the machine was completely replaced.  One solution to the hangup problem was to use the optiboot bootloader for Arduino with the watchdog function enabled while maintaining state in the EEPROM and restoring the state with the loop continuing after a reset.  But it did not help. <br><br>  In general, it was decided to abandon Atmega and switch to STM32. <br><br>  As an STM32, the <a href="http://developer.mbed.org/platforms/ST-Nucleo-F401RE/">NUCLEO-F401RE</a> controller was purchased.  All signals from <a href="http://www.e-voron.dp.ua/files/pdf/optopara/pc817xx.pdf">limit</a> switches were collected through <a href="http://www.e-voron.dp.ua/files/pdf/optopara/pc817xx.pdf">PC817</a> optocouplers.  Control of the solenoid <a href="http://sharp-world.com/products/device/lineup/data/pdf/datasheet/s102s02_e.pdf">valves</a> and starters was done on the SSR <a href="http://sharp-world.com/products/device/lineup/data/pdf/datasheet/s102s02_e.pdf">SHARP S202S02</a> (a pair of <a href="http://radio-stv.ru/wp-content/files/MOC3063.pdf">MOC3061</a> + <a href="http://www.bucek.name/pdf/bt138.pdf">BT138</a> can also be used). <br><br><img src="https://habrastorage.org/files/159/000/166/1590001660b14b09afe596f8ca8c87fb.gif" alt="image"><br><br>  As an indicator, it was ordered and paid for on Aliexpress LCD12864 (ST7920), but the seller sent a 20x4 LCD (during the dispute, the money was returned, but the display remained) and decided to use it. <br><br>  The program was written in the online compiler <a href="https://developer.mbed.org/compiler/">mbed</a> . <br><br>  Now a little on the methods of programming this controller in mbed.  Work with signals from a limit switch, load control and work with timers: <br><br><div class="spoiler">  <b class="spoiler_title">Cut from code</b> <div class="spoiler_text">  All code takes about 2000 lines.  I will not post.  I can only say that service information is constantly coming out of the controller via the COM port (made for myself). <br><br>  I will show only the key fragments. <br><br>  // Initial Settings <br>  // Operator-regulated variables are stored in the eeprom memory. <br>  <b>#include "_24LCXXX.h"</b> // <a href="">Library of working with the eeprom memory chip</a> <br>  <b>_24LCXXX eeprom (&amp; i2c, 0x50);</b>  // Connect the eeprom chip <br>  <b><a href="http://developer.mbed.org/handbook/DigitalIn">DigitalIn</a> S41 (PC_8);</b>  // End switch S41 is connected via the optocoupler to the controller output PC_8 <br>  <b><a href="http://developer.mbed.org/handbook/DigitalOut">DigitalOut</a> Y43 (PA_13);</b>  // Hydraulic valve control Y43 (coil 220V) through the output PA_13 <br>  <b><a href="http://developer.mbed.org/handbook/Timer">Timer</a> T48;</b>  // T48 - timer used in the casting cycle <br>  <b><a href="http://developer.mbed.org/handbook/C-Data-Types">float</a> SetT48 = 15.0;</b>  // Variable adjustable by operator.  The time for which the timer T48 is activated. <br>  <b>...</b> <b><br></b>  <b>void setup ()</b> <b><br></b>  <b>{</b> <b><br></b>  <b>...</b> <br>  <b><a href="http://developer.mbed.org/users/4180_1/notebook/pushbuttons/">S41.mode (PullDown);</a></b>  // Enable pull-up resistor <br>  <b>...</b> <b><br></b>  <b>}</b> <b><br></b>  <b>int main ()</b> // main loop <b>{</b> <b><br></b>  <b>...</b> <br>  // Method of working with the signal from the trailer <br>  <b>if (S41 == LOW) {</b> // Check the status of the trailer <br>  <b>...</b> <b><br></b>  <b>}</b> <b><br></b>  <b>...</b> <br>  // Load control method <br>  <b>Y43 == 1;</b>  // Enable Hydro Valve Y43 <br>  <b>Y43 == 0;</b>  // Turn off the hydraulic valve Y43 <br>  <b>...</b> <br>  // Work with timer <br>  <b>T48.reset ();</b>  // Reset Timer T48 <br>  <b>T48.start ();</b>  // Start timer T48 <br>  <b>...</b> <br>  <b>CurrentT48 = T48.read ();</b>  // Read the current value of the counting timer T48 <br>  <b>if (CurrentT48&gt; SetT48) {</b> // Compare with a given value <br>  <b>T48.stop ();</b> <b><br></b>  <b>}</b> <br>  // Displays the dynamic state of the timer on the LCD <br>  <b>lcd.printf ("T48 =% 4.1f", CurrentT48);</b> <b><br></b>  <b>...</b> <br>  // Method of working with eeprom: <br>  <b>eeprom.nbyte_read (0x00, &amp; SetT48, 4);</b>  // Reading 4 bytes from its eprompm starting at address 0x00 and writing the contents to the setT48 variable allocated to memory (the type of the variable float is 4 bytes) <br>  <b>eeprom.nbyte_write (0x00, &amp; SetT48, 4);</b>  // Write to it with 4 bytes starting from the address 0x00 of the memory values ‚Äã‚Äãof the allotted variable SetT48 (the type of the variable float is 4 bytes) <br>  <b>...</b> <b><br></b>  <b>}</b> <br></div></div><br>  The controller is flashed.  NUCLEO stitched very easily.  After connecting the USB cable from the NUCLEO to the computer, the removable disk appears in the latter.  In it we copy the binary obtained after compilation in the online compiler and everything - the firmware itself will be poured into the crystal.  There were moments when you had to upload a binary directly from the Galaxy Nexus via an OTG cable. <br><br>  Made PCB method LUT.  Soldered.  Mounted in the cabinet of the machine.  Launched.  He taught the operators to set up. <br><br><div class="spoiler">  <b class="spoiler_title">Result photo</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/aa8/7f8/778/aa87f877807844dc99932ba6c41f1bab.jpg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result Video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/xooBjqIEQDo%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiuXirB2EEdqv7EXZcQLtx0IkqFKQ" frameborder="0" allowfullscreen=""></iframe><br></div></div><br>  To date, the "mileage" is more than 100 thousand cycles!  Not a single fault due to electronics. <br><br>  Total.  The blower controller has 13 optical isolating inputs, 11 optical isolating outputs, each switching up to 8A load.  Programming the casting cycle.  LED indication of inputs and outputs.  Display of various information.  Automatic and manual control modes.  In manual mode, it is possible to turn on and off each power output separately with software protection from emergency conditions (for example, controlling the three-phase reverse motor starters of one of the machine mechanisms) to diagnose the health of individual machine components. <br><br>  We have three machines.  The remaining two also translate to the controller. <br><br>  About the prices do not write.  The course is jumping.  Yes, and all the details can be found on Aliexpress, where I bought everything. <br><br>  Thank.  I will answer questions. <br><br>  PS At the next stage, the replacement of the ancient control of heating of the six zones of the screw and the ‚Äúhead‚Äù of the machine with modern electronics (6xMAX6675 + Atmega328 + 6xMOC3061 + 6xBT138-600 + LCD20x4).  I will collect everything in a small box and finally throw out a huge control cabinet. </div><p>Source: <a href="https://habr.com/ru/post/256981/">https://habr.com/ru/post/256981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256967/index.html">Apple is investing $ 1.9 billion in EU infrastructure. What is it, expansion to Europe or escape from the USA?</a></li>
<li><a href="../256971/index.html">Waski loader is used to distribute the banker Dyreza Trojan</a></li>
<li><a href="../256975/index.html">Audit of one ‚Äúslow‚Äù application in one large concern</a></li>
<li><a href="../256977/index.html">Step-by-Step: Preparing Mac OS Installation Packages. Part one</a></li>
<li><a href="../256979/index.html">Create an isomorphic application on React and Flummox</a></li>
<li><a href="../256985/index.html">Step-by-Step: Preparing Mac OS Installation Packages. Part two. Package Creation in Package Maker</a></li>
<li><a href="../256987/index.html">Chatbot on neural networks</a></li>
<li><a href="../256989/index.html">Hacker implanted an NFC chip in his hand to bypass security scanners and control android phones</a></li>
<li><a href="../256993/index.html">Looking for the perfect review system for an online store</a></li>
<li><a href="../256995/index.html">Vivaldi Technologies - Straight Talk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>