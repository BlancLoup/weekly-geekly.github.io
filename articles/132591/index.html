<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Update Active Directory Credentials</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people remember the feeling when a company expands to the size when there are not enough working groups, and the first Active Directory domain ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Update Active Directory Credentials</h1><div class="post__text post__text-html js-mediator-article">  Many people remember the feeling when a company expands to the size when there are not enough working groups, and the first Active Directory domain rises: ‚ÄúOh, now everything will be all right!‚Äù But no, the domain is growing more and more, new accounts are being created, old ones are being blocked computers are added, girls get married, names are changed, and in the end, the directory service database looks like a full seam.  In this topic, we will establish a connection between the Active Directory database and the personnel system of the enterprise, as well as create a mechanism for maintaining employee data in AD up to date. <br><a name="habracut"></a><br>  First of all, we will describe the requirements that we must present to the employee records.  And we will try to estimate these requirements based on the user's needs.  It is no secret that many corporate systems that use authentication through Active Directory often display various fields of AD accounts in their admin panels and just during the work: this is Sharepoint, Citrix, and many, many others.  As an example of such a system, I will take the well-known MS Outlook, but not completely, but only its address book, which derives its data directly from Active Directory. <br><br><img src="https://habrastorage.org/storage1/b8ad289f/14eaba30/5649628e/1bed9442.png"><br><br>  What does the user use?  In our organization, he often searches by phone for his name, email address, and the name of the department.  Of course, it is not bad to fill in the address information too, but due to the fact that we have a topic about a bundle with an abstract personnel system, we will leave addresses and phone numbers outside the brackets. <br>  First, we write out the list of fields that we wish to take from the personnel system; we will have it: <br><ul><li>  Full Name </li><li>  Position </li><li>  Organization </li><li>  Subdivision </li><li>  Postcode </li><li>  Type of employment </li></ul>  At this stage it is useful to consolidate our list of fields and issue an Order in the name of the Biggest Director, obliging HR officers and administrators to keep this data up to date. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Mechanism </h4><br>  It goes without saying that in order to link a person from the personnel system and a person from Active Directory, it is necessary to have some identifier linking these two records.  Usually, such an identifier is the employee's employee number, it is assigned when applying for a job and never changes, however, I have encountered situations where the personnel number is not static, in which case such an identifier should be invented. <br><br>  Information about an Active Directory user is not limited to information that can be seen in the Active Directory Users and Computers snap-in (well-established abbreviation ADUC), and is far from being exhausted.  In fact, a user object has a trillion attributes, and these attributes can even be added by the schema administrator.  For example, there is an attribute such as <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms675438(v%3Dvs.85).aspx">carLicense</a> , which contains information about a driver's license, or <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms675651(v%3DVS.85).aspx">drink</a> , which characterizes the user's favorite drink.  In general, Microsoft in this sense has provided a lot. <br><br>  In my example, I will use the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms675662(v%3DVS.85).aspx">employeeID</a> attributes to store the user ID, and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms675677(v%3DVS.85).aspx">flags</a> , for which I will inform you later. <br><br>  We will also use attributes to fill in user fields: <br><ul><li>  displayName and CN for storage name </li><li>  department to store units </li><li>  company storage organization </li><li>  title to hold the post </li><li>  employeeType to store employee type </li><li>  postalCode for index storage </li></ul>  Pedants can, of course, additionally use givenName, initials, and sn to store the first name, initials, and last name, respectively, but I think that this is subtlety. <br><br>  So, our application will work like this: <br><ol><li>  List accounts with employeeID </li><li>  Search in the personnel system for each account the changed data </li><li>  Update data in Active Directory </li><li>  Log changes to the file </li></ol><h4>  To business </h4><br>  The first thing to do is to put down the employeeID, which our personnel number represents, to all users.  If there are few users, then it is easiest to do this through <a href="http://technet.microsoft.com/en-us/library/cc773354(WS.10).aspx">ADSI Edit</a> , if there are a few more, then you can fasten a script for prescription, for example <a href="http://adisfun.blogspot.com/2009/05/add-employee-id-field-aduc.html">like this</a> .  And if there are a lot of users, the arrangement of identifiers must be delegated, I want a pleasant interface and additional baubles are used, then you can create this additional tab in ADUC: <br><br><img src="https://habrastorage.org/storage1/d9568531/9081fa6e/e84a9449/7ea9f65c.png"><br><br>  However, the creation of such a tab is in itself a topic for a separate topic. <br><br>  The second subtle point is that sometimes it happens that for some people only certain attributes should be changed.  For example, we have an employee, let's call him Kudrymunbekov Sadruddin Fatkhullarovich, but everyone calls him simply San Sanych.  And there is a general director, whose position in the personnel is written not only as the General Director of the Open Joint-Stock Company of Far Space Communication Horn and Hoof, which in AD it would be better to just leave exactly with the connection, but without horns and hoofs.  Thus, we see the need to lay out some exceptions to the logic of our application, and we will store these exceptions in the Active Directory attribute in the flags attribute.  This attribute has a value of four bytes, which means that by setting one or another bit to one or another value, we can, if necessary, remember as many as 32 exceptions.  However, we will still use only six. <br><br>  We proceed to the implementation on powershell: <br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#       Active Directory #   param($strServer, $strContainer, $strUserName, $strPassword, $strFileName, $strLogName) function Write-LogFile([string]$logFileName) { Process { $_ $dt = Get-Date $str = $dt.DateTime + " " + $_ $str | Out-File -FilePath $logFileName -Append } } #      ,    #      .       1, #    ,      Oracle e-Buisness suite, #        csv-. #  ,     Import-CSV , #     ,  - ,     function Get-Employee($employeeID, $fileName, [ref]$title, [ref]$department, [ref]$displayName, [ref]$company, [ref]$postalCode, [ref]$employeeType) { $records = $fileName | Import-CSV -Delimiter ";" $employee = $records | where-object {$_.EmployeeID -eq $employeeID} if ($employee -eq $null) {return $false} $title.Value = [string]$employee.Title $department.Value = [string]$employee.Department $displayName.Value = [string]$employee.Name $company.Value = [string]$employee.Company $postalCode.Value = [string]$employee.PostalCode $employeeType.Value = [string]$employee.EmployeeType return $true } #     "---" | Write-LogFile $strLogName "  :" | Write-LogFile $strLogName ": " + $strServer | Write-LogFile $strLogName ": " + $strContainer | Write-LogFile $strLogName " : " + $strUserName | Write-LogFile $strLogName ": " + $strPassword | Write-LogFile $strLogName " : " +$strFileName | Write-LogFile $strLogName "  : " + $strLogName | Write-LogFile $strLogName #   ,           #  ,     000001, 000010, 000100, 001000, 010000  100000 #   .  ,     , #     New-Variable -Option constant -Name C_COMPANY_FLAG -Value 1 New-Variable -Option constant -Name C_POSTALCODE_FLAG -Value 2 New-Variable -Option constant -Name C_TITLE_FLAG -Value 4 New-Variable -Option constant -Name C_DEPARTMENT_FLAG -Value 8 New-Variable -Option constant -Name C_NAME_FLAG -Value 16 New-Variable -Option constant -Name C_EMPLOYEETYPE_FLAG -Value 32 #     title.  title   # http://msdn.microsoft.com/en-us/library/windows/desktop/ms680037(v=VS.85).aspx #  64     Windows Server 2003 #  128     Windows Server 2008 #     ,   New-Variable -Option constant -Name C_PARAMETERS_LENGTH -Value 64 # (!userAccountControl:1.2.840.113556.1.4.803:=2)   "     " $strFilter = "(&amp;(objectClass=user)(!objectClass=computer)(employeeID=*)(!userAccountControl:1.2.840.113556.1.4.803:=2))" # , ,    Active Directory  Windows Server 2008 # http://blogs.msdn.com/adpowershell #        Windows Server 2003  Windows XP, #     $objDomain = New-Object System.DirectoryServices.DirectoryEntry("LDAP://"+$strServer+"/"+$strContainer) $objSearcher = New-Object System.DirectoryServices.DirectorySearcher $objSearcher.SearchRoot = $objDomain $objSearcher.PageSize = 1000 $objSearcher.Filter = $strFilter $objSearcher.SearchScope = "Subtree" $colProplist = "employeeID","postalCode","title","department", "displayName", "cn", "employeeType" foreach ($i in $colPropList) { $objSearcher.PropertiesToLoad.Add($i) } $colResults = $objSearcher.FindAll() #   colResults      $startTime = Get-Date $totalCount = $colResults.Count $i = 0 foreach ($objResult in $colResults) { $objItem = $objResult.Properties $aDEmployeeID = $objItem.employeeid #  ,     flags,        # ,      ,      $flagProtectCompany = $false $flagProtectPostalCode = $false $flagProtectTitle = $false $flagProtectDepartment = $false $flagProtectName = $false $flagProtectEmployeeType = $false if (!($objItem.flags -eq $null)) { $flags = $objItem.flags if (($flags[0] -band $C_COMPANY_FLAG) -ne 0) {$flagProtectCompany = $true} if (($flags[0] -band $C_POSTALCODE_FLAG) -ne 0) {$flagProtectPostalCode = $true} if (($flags[0] -band $C_TITLE_FLAG) -ne 0) {$flagProtectTitle = $true} if (($flags[0] -band $C_DEPARTMENT_FLAG) -ne 0) {$flagProtectDepartment = $true} if (($flags[0] -band $C_NAME_FLAG) -ne 0) {$flagProtectName = $true} if (($flags[0] -band $C_EMPLOYEETYPE_FLAG) -ne 0) {$flagProtectEmployeeType = $true} } #   ,      $cSVName = "" $cSVTitle = "" $cSVDepartment = "" $cSVCompany = "" $cSVPostalCode = "" $cSVEmployeeType = "" #         PowerShell,    # ,     $rc = Get-Employee $aDEmployeeID $strFileName ([ref]$cSVTitle) ([ref]$cSVDepartment) ([ref]$cSVName) ([ref]$cSVCompany) ([ref]$cSVPostalCode) ([ref]$cSVEmployeeType) if ($rc) { #            ,   #  .       , #    , ,       #    $objDirectoryEntry = new-object System.DirectoryServices.DirectoryEntry($objItem.adspath, $strUsername, $strPassword, [System.DirectoryServices.AuthenticationTypes]::Secure) $oTitle = $cSVTitle if ($oTitle.Length -gt $C_PARAMETERS_LENGTH) {$oTitle = $oTitle.Substring(0,$C_PARAMETERS_LENGTH)} $oDepartment = $cSVDepartment if ($oDepartment.Length -gt $C_PARAMETERS_LENGTH) {$oDepartment = $oDepartment.Substring(0,$C_PARAMETERS_LENGTH)} $newEmployeeType = $cSVEmployeeType #     ,    ,    ,  , #    (    ).       if (($newEmployeeType -ne $objItem.employeetype) -and -not $flagProtectEmployeeType) { " EmployeeType  """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.employeetype + """  """ + $newEmployeeType + """" | Write-LogFile $strLogName $objDirectoryEntry.employeetype = [string]$newEmployeeType $objDirectoryEntry.CommitChanges() } if (($cSVCompany -ne $objItem.company) -and -not $flagProtectCompany) { "   """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.company + """  """ + $cSVCompany + """" | Write-LogFile $strLogName $objDirectoryEntry.company = [string]$cSVCompany $objDirectoryEntry.CommitChanges() } if (($cSVPostalCode -ne $objItem.postalcode) -and -not $flagProtectPostalCode) { "   """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.postalCode + """  """ + $cSVPostalCode + """" | Write-LogFile $strLogName $objDirectoryEntry.postalCode = $cSVPostalCode $objDirectoryEntry.CommitChanges() } if (($oTitle -ne $objItem.title) -and -not $flagProtectTitle) { "   """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.title + """  """ + $cSVTitle + """" | Write-LogFile $strLogName if ($title.Length -gt $C_PARAMETERS_LENGTH) { $objDirectoryEntry.title = $cSVTitle.Substring(0,$C_PARAMETERS_LENGTH) } else { $objDirectoryEntry.title = $cSVTitle.ToString() } $objDirectoryEntry.CommitChanges() } if (($oDepartment -ne $objItem.department) -and -not $flagProtectDepartment) { "   """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.department + """  """ + $cSVDepartment + """" | Write-LogFile $strLogName if ($department.Length -gt $C_PARAMETERS_LENGTH) { $objDirectoryEntry.department = $cSVDepartment.Substring(0,$C_PARAMETERS_LENGTH) } else { $objDirectoryEntry.department = $cSVDepartment.ToString() } $objDirectoryEntry.description = $cSVDepartment.ToString() $objDirectoryEntry.CommitChanges() } if ((($cSVName -ne $objItem.displayname) -or ($cSVName -ne $objItem.cn)) -and -not $flagProtectName) { "   """ + $objDirectoryEntry.name + """" | Write-LogFile $strLogName " """ + $objDirectoryEntry.displayname + """  """ + $cSVName + """" | Write-LogFile $strLogName $objDirectoryEntry.displayName = $cSVName $objDirectoryEntry.CommitChanges() $objDirectoryEntry.Rename("cn="+$cSVName) } $i++ #         ,    #  ,  , ,       $status = $i.ToString() + " of " + $totalCount.ToString() + " complete - " + $objDirectoryEntry.name $currentTime = Get-Date $diffTime = [int][System.Math]::Round(($currentTime - $startTime).Ticks / $i) $delta = $diffTime*$totalCount $endTime = $startTime.Add([int64]($delta)) $activityString = " .    " + $endTime Write-Progress -Activity $activityString -Status $status -PercentComplete (($i / $totalCount) * 100) } } " " | Write-LogFile $strLogName #      ,   Write-Host `a</span></span></code> </pre> <br><br>  Let's create a test environment, absolutely arbitrarily assign names to accounts: <br><br><img src="https://habrastorage.org/storage1/eae5faa8/78754fab/262d35b7/22be5460.png"><br><br>  Now run the script with the parameters.  Of course, it can be entered and executed on a schedule, just do not forget the account on whose behalf the task is being performed, assign the right to <i>log in as a batch task</i> : <br><br><img src="https://habrastorage.org/storage1/4efd1d4f/90be4044/832e6afb/78abe7ee.png"><br><br>  As you can see, after the execution, we got good readable names, excellent positions and great company names: <br><br><img src="https://habrastorage.org/storage1/2b8eeeb5/0159734b/bd25d358/1d239637.png"><br><br>  Of course, by shallow script modification, we can fill the user with everything: from phones and addresses to notorious favorite drinks, there would be a source.  And if the script is run with a certain regularity, then we ensure that all user data will be relevant. <br><br>  upd Corrected a small error, moved the reset of flags in the loop </div><p>Source: <a href="https://habr.com/ru/post/132591/">https://habr.com/ru/post/132591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132583/index.html">A set of PHD CTF Quals / Afterparty teams opens.</a></li>
<li><a href="../132584/index.html">Google hides bold future projects in a secret lab</a></li>
<li><a href="../132585/index.html">Three lines of shamanism</a></li>
<li><a href="../132586/index.html">Video review of Android applications and games - kedDroid</a></li>
<li><a href="../132587/index.html">Why sell on social networks profitable?</a></li>
<li><a href="../132593/index.html">Please me internet with filter</a></li>
<li><a href="../132594/index.html">Enter into the program hierarchical list</a></li>
<li><a href="../132599/index.html">zsh :: set up the ‚Äúright‚Äù command line prompt</a></li>
<li><a href="../132600/index.html">Conspiracy theory</a></li>
<li><a href="../132601/index.html">It is urgent to make a news portal with an integrated social network and a large load. On what?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>