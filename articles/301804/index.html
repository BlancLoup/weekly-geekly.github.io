<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Event system and responses or the makings of Visual Scripting for Unity3D</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In my last article , I presented ways to ensure a ‚Äúsoft‚Äù connection between the components of the game logic, based on notifications an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Event system and responses or the makings of Visual Scripting for Unity3D</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>Introduction</b> </h4><br>  In my last <a href="https://habrahabr.ru/post/282524/">article</a> , I presented ways to ensure a ‚Äúsoft‚Äù connection between the components of the game logic, based on notifications and subscriptions to them.  In a general sense, such notifications can be sent to any action or event that we want in a component's work: from changing a variable to more complex things.  However, often certain events require us to perform a series of actions that are not advisable to delegate.  The simplest example is sound design - an event has arisen in the component that requires sound.  In the simplest version, we will call the AudioSource.Play () function, in a slightly more complex, wrapper function over the sound system.  In principle, there is nothing wrong with that, if the project is small and there are few people in the team who combine many roles, but if this project is large, where there are several programmers and a sound designer, then, in particular, tuning the sounds will turn into a programmer nightmare.  It‚Äôs not a secret that we are trying to abstract from the content and work less with it in terms of customization, for it‚Äôs more correct if the responsible specialists deal with this, and not us. <br><a name="habracut"></a><br>  The example described above is applicable not only to sounds, but also to many other things: animations, effects, actions with GUI elements, etc., etc.  All of this together represents a big problem on relatively large projects.  In the course of my work, I came across this many times and basically all my decisions came down to lightening my work, which is essentially a dead end, since content management was completely cut off from the designers.  In the end, it was decided to come up with some kind of system that would allow responsible persons to manage such things themselves with minimal participation of programmers.  About this system and will be discussed in this article. <br><br><h4>  <b>Events and Feedback</b> </h4><br><h5>  <i><u>Little intro</u></i> </h5><br>  I think it‚Äôs no secret to anyone what the gameplay is like from a programmer‚Äôs point of view.  However, I still explain that my point of view is clear to readers. <br><br>  So, all the code that we write to implement the gameplay is initially a set of components, each of which is the generator of a number of events occurring in the game world and affecting it, or on other components.  In the simplest version, logic is divided into components according to events that are grouped by the source criterion: character, opponent, interface, interface window, etc., etc.  However, the events themselves do not form the gameplay, we need the necessary actions (responses) performed in response to the events.  For example, a character took a step and generated corresponding events, in response to which we need to play a sound, play the effect of dust from under our feet and maybe even shake the camera.  In a more complex version, actions performed in response to events can also generate new events, I call this the ‚Äúsound wave effect‚Äù.  Thus, the ‚Äúsurface‚Äù of our gameplay is formed, as a chain of events and responses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In most cases, the mechanism described above is formed directly in the code, but as was said earlier, a number of events can (and will) be associated with content that provides animation and perception of the game - the part for which artists and designers are responsible.  With the wrong project management process and the wrong approach to the production of the game, most of these tasks are solved by the programmer.  The artist gets angry - the programmer writes a ‚Äúhack‚Äù and everything will be fine.  It was good for the beginning of the ‚Äúrussian game development‚Äù, but now we need quality, speed and flexibility, so I decided to go the other way and this path is connected with the <b>Unity Editor</b> <b><br></b>  <b>Extensions</b> . <br><br><h5>  <i><u>A couple of words about architecture</u></i> </h5><br>  Below is a small block diagram showing the main elements necessary to implement the mechanism of events and responses, which will allow designers to customize certain elements of the game logic themselves. <br><img src="https://habrastorage.org/files/c14/6ba/334/c146ba334ae84adbb5164f1827f5d1c7.png" alt="image"><br>  So, the basic elements of the system are <b>EventPoint</b> (event point in the component) and <b>Action</b> (event response).  Each of these elements requires a specialized editor to be configured, which will be implemented through Editor Extensions, in our case through custom inspector (more on this will be written in a separate section). <br><br>  In the baseline scenario, each event point can generate not one response, but a multitude, with each response, can also be an event generator and contain entry points to them.  In addition, the response should be able to operate with the basic entities of the Unity3D engine. <br>  Based on the above, I decided that the simplest option would be to make <b>Action the</b> heir from <b>MonoBehaviour</b> , and <b>EventPoint</b> to make part of the logic of components in the form of a public field, which should be serialized by the standard Unity3D mechanism. <br><br>  Let us dwell on these elements. <br><br><div class="spoiler">  <b class="spoiler_title">Eventpoint</b> <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EventPoint</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;ActionBase&gt; ActionsList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ActionBase&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Occurrence</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ActionsList) { action.Execute(); } } }</code> </pre> <br></div></div><br>  As you can see from the code, everything is quite simple.  <b>EventPoint</b> is essentially a list that stores a set of Actions that are tied to it.  Entry to the event point in the code occurs through a call to the <b>Occurence</b> function.  <b>ActionsList</b> is made public field so it can be serialized with Unity3D tools. <br><br><div class="spoiler">  <b class="spoiler_title">Use in code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomComponent</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { [HideInInspector] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EventPoint OnStart; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { OnStart.Occurrence(); } }</code> </pre><br></div></div><br>  As it was said above, the Action should be an heir from <b>MonoBehaviour</b> , and also since the event point should not care what the response it causes, we will make a wrapper over this class in the form of an abstraction. <br><br><div class="spoiler">  <b class="spoiler_title">Actionbase</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActionBase</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br></div></div><br>  Trite and primitive.  The <b>Execute</b> function is required to trigger response logic when entering an event point. <br><br><div class="spoiler">  <b class="spoiler_title">Now you can implement the response (as an example - turn on and off the scene object)</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActionSetActive</span></span> : <span class="hljs-title"><span class="hljs-title">ActionBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GameObject Target; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Value; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Target.SetActive(Value); } }</code> </pre><br></div></div><br>  It is not difficult to notice that the basis of the system does not represent any complexity at all and in general is primitive.  All problems are caused by the implementation of the visual part of the system associated with the inspector.  Read more about this below. <br><br><h4>  <b>Editor</b> </h4><br>  Before proceeding to the analysis of the implementation code of the editor, I want to show what we will strive for visually, and then we will consider how to achieve this.  Below are images of the inspector with points of events and responses to them. <br><img src="https://habrastorage.org/files/386/527/00b/38652700b564414aba797ed48027731b.png" width="475" alt="image"><img src="https://habrastorage.org/files/a23/937/019/a23937019d2344d285dff679ff23ffea.png" width="475" alt="image"><br><br>  Let's start in order: <br><br><h5>  <u><i>Override the inspector for the component</i></u> . </h5><br>  Since we need flexibility, in order to unify the editor redefinition in the inspector for event points, there are two ways: <br><ol><li>  Redefining the inspector for a specific type of property (in our case <b>EventPoint</b> ) </li><li>  Redefining the inspector for the entire component (in our case, the successor to <b>MonoBehaviour</b> ) </li></ol><br>  In general, both options are acceptable, I chose the second one, because in it I can set the desired order for displaying the component's public fields in the inspector. <br><br><div class="spoiler">  <b class="spoiler_title">Custom editor for all heirs of MonoBehaviour</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CustomEditor(typeof(MonoBehaviour), true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomMonoBehaviour_Editor</span></span> : <span class="hljs-title"><span class="hljs-title">Editor</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br></div></div><br><h5>  <u><i>Receiving and displaying a list of responses</i></u> </h5><br>  In order for the system to be as flexible as possible, we need to deduce all the responses we have implemented (classes derived from <b>ActionBase</b> ) and add them to the event point by simple selection from the list. <br><br><div class="spoiler">  <b class="spoiler_title">It is implemented as follows.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEnable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runtimeAssembly = Assembly.GetAssembly(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ActionBase)); m_actionList.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> checkedType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> runtimeAssembly.GetTypes()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ActionBase).IsAssignableFrom(checkedType) &amp;&amp; checkedType != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ActionBase)) { m_actionList.Add(checkedType.FullName, checkedType); } } }</code> </pre><br></div></div><br>  As you can see, we get a list of all the heirs from ActionBase, and then exclude the asbtraction from the list.  The response name is taken from the class name.  Here you can go a more complicated way and pick up the name through the class attribute and also through the attribute you can set a short description of what the response does.  Since I call the classes in detail, I decided to take a simpler path. <br><br><h5>  <u><i>Listing event points and component public fields</i></u> </h5><br>  Since we need to redefine how to display only the event points, the drawing function of the inspector will take the following form. <br><br><div class="spoiler">  <b class="spoiler_title">GUI Inspector's drawing function</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnInspectorGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { serializedObject.Update(); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnInspectorGUI(); <span class="hljs-comment"><span class="hljs-comment">//          FindAndEditEventPoint(target); //    serializedObject.ApplyModifiedProperties(); }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Function for finding event points (EventPoints)</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindAndEditEventPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UnityEngine.Object editedObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fields = editedObject.GetType().GetFields(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldInfo.FieldType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventPoint)) { EventPointInspector(fieldInfo, editedObject); <span class="hljs-comment"><span class="hljs-comment">//   } } }</span></span></code> </pre><br></div></div><br>  The main question that arises when looking at this code is why reflection is used, and not <b>SerializedProperty</b> .  The reason is simple, because we redefine the inspector for all <b>MonoBehaviour</b> heirs, we have no idea about the naming of the component fields and their relationship to the type, therefore, we cannot use the <b>serializedObject.FindProperty ()</b> function. <br><br>  Now, as for the immediate drawing of the inspector for the event points.  I will not give the whole code, because everything is quite simple there: FoldOut style is used for folding and unfolding information about responses.  Let us dwell on the key points. <br><br><div class="spoiler">  <b class="spoiler_title">Retrieving EventPoint Instance Data</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventPoint = (EventPoint)eventPointField.GetValue(editedObject);</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Listing responses and adding them to an event point</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selectIndex = EditorGUILayout.Popup(<span class="hljs-number"><span class="hljs-number">-1</span></span>, actionNames.ToArray()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectIndex &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actionType = m_actionList[actionNames [selectIndex]]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actionObject = (ActionBase)((target <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Component).gameObject.AddComponent(actionType)); eventPoint.ActionsList.Add(actionObject); }</code> </pre><br></div></div><br><h5>  <u><i>Inspector for responses (Actions)</i></u> </h5><br>  As can be seen from the code above, the response is added as a component to the object, as a result of such an action, this class will be displayed in the inspector window and will be processed accordingly (with the display of all fields, etc.).  For us, this is not convenient, since we go all the manipulations on setting parameters to produce in one place.  First of all, let's prevent Unity from displaying response class parameters in the inspector. <br><br><div class="spoiler">  <b class="spoiler_title">This is done by overriding the editor for all heirs to ActionBase.</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CustomEditor(typeof(ActionBase), true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActionBase_Editor</span></span> : <span class="hljs-title"><span class="hljs-title">Editor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnInspectorGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Now you can show the response class fields in the inspector, which we redefined for the event point (I quote the base code, how to add styles (FoldOut), I think it is not necessary to explain)</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> destroyingComponent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ActionBase&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; eventPoint.ActionsList.Count; i++) { EditorGUILayout.BeginHorizontal(); ActionBaseInspector(eventPoint.ActionsList[i]); <span class="hljs-comment"><span class="hljs-comment">//     ,    if (GUILayout.Button("-", GUILayout.Width(25))) { destroyingComponent.Add(eventPoint.ActionsList[i]); } EditorGUILayout.EndHorizontal(); }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The response is deleted as follows.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (ActionBase action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> destroyingComponent) { RecursiveFindAndDeleteAction(action); eventPoint.ActionsList.Remove(action); GameObject.DestroyImmediate(action); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RecursiveFindAndDeleteAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fields = obj.GetType().GetFields(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> destroyingComponent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ActionBase&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldInfo.FieldType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventPoint)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventPoint = (EventPoint)fieldInfo.GetValue(obj); destroyingComponent.AddRange(eventPoint.ActionsList); eventPoint.ActionsList.Clear(); } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (ActionBase action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> destroyingComponent) { RecursiveFindAndDeleteAction(action); GameObject.DestroyImmediate(action); } }</code> </pre><br></div></div><br>  Since the system is not limited in any way (although it is possible) in the length of the chain of events and responses, the removal of the response at the beginning or middle of the chain should be accompanied by the removal of all responses below, and for this it is necessary to recursively go through this chain and systematically delete all, including components from the object, and then delete the base response. <br><br><div class="spoiler">  <b class="spoiler_title">Note:</b> <div class="spoiler_text">  Here lies the strangest point that I still can not overcome: despite the fact that Unity recommends using <b>DestroyImmediate</b> to remove components from an object through the editor, this leads to the <b>MissingReferenceException</b> error in the editor.  However, it does not affect the correct operation of the code.  The bug is my or Unity, I still try to understand.  If anyone knows what's the matter, write in the comments. <br></div></div><br><h5>  <u><i>Drawing fields of the class that implements the response (Action)</i></u> </h5><br>  As mentioned earlier, we cannot use serializedObject.FindProperty () in the code, because field names are not available to us, among other things, <b>serializedObject</b> is not available to us, so, like for <b>EventPoint</b> , reflection is used, which in turn is the most inconvenient moment in the whole system. <br><br><div class="spoiler">  <b class="spoiler_title">We draw the inspector for the response</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ActionBaseInspector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ActionBase action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fields = action.GetType().GetFields(); EditorGUILayout.BeginVertical(); EditorGUILayout.Space(); EditorGUILayout.Space(); EditorGUILayout.Space(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldInfo fieldInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldInfo.FieldType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)fieldInfo.GetValue(action); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = EditorGUILayout.IntField(fieldInfo.Name, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); fieldInfo.SetValue(action, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldInfo.FieldType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)fieldInfo.GetValue(action); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = EditorGUILayout.FloatField(fieldInfo.Name, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); fieldInfo.SetValue(action, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ..   ,      } FindAndEditEventPoint(action); //        . EditorGUILayout.EndVertical(); }</span></span></code> </pre><br></div></div><br>  As you can see, we will have to define the output of the editor for all the necessary field types with pens.  On the one hand, this is tin, on the other hand, it is possible to redefine the field editor, which I use, for example, for sounds. <br><br><h4>  <b>Total</b> </h4><br>  If you look at the system as a whole, there is nothing difficult in it, however, the advantages that it gives are simply incomparable.  Saving time and effort is huge.  In fact, the programmer now needs to create an event point and entry in the necessary logic component, and then, what is called ‚Äúwash hands‚Äù, of course, besides this, writing response code is required, but since they are essentially Unity components, here everything is limited only by imagination: you can make large complicated things, you can make many small monosyllables. <br><br>  At the beginning of the article, I mentioned that delegating the processing of events to other components may be inappropriate, but in fact this has its advantages from the position of the pipeline.  Using the message system (see previous article), you can define specialized components to process them so that you can create entries to event points.  If you place such components in a predetermined place, then designers will not have to scour the hierarchy of objects.  This approach, for example, can be used to tune the sound environment. <br><br>  As it was said earlier, the system is not limited to a long chain of events and responses, in fact, the designer can create as many large and complex logic of behavior (referring to <b>Visual Scripting</b> ), but in practice this is not convenient or unreadable, therefore it is better to limit the chains to at least verbal agreements.  In the course of our work, my partner and I used such chains in an extended version - a separate window ( <b>EdtiorWindow</b> ) was used for editing.  Everything was fine until there was a need to create complex branches in logic.  Understand after some time in this mess was just unreal.  That is why in my system I went towards a simple solution based on an inspector. <br><br>  With regard to <b>Visual Scripting</b> as a whole, the approach of events and responses and their implementation through the Unity components has its advantages and, in the end, my partner and I decided to develop a full-fledged visual logic editor in the course of our work on several projects.  What came out of this is a topic for a separate article, and in conclusion I want to give a small video demonstrating the work of the described system, using the example of uGUI. <br>  <a href="https://youtu.be/sfZ9Tf_EVYE">https://youtu.be/sfZ9Tf_EVYE</a> </div><p>Source: <a href="https://habr.com/ru/post/301804/">https://habr.com/ru/post/301804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301786/index.html">Techniques to capture the user's attention - from a magician and a designer ethics specialist at Google</a></li>
<li><a href="../301790/index.html">Paul Graham: Chapter 2. Hackers and Artists (Habr edition)</a></li>
<li><a href="../301798/index.html">Distributed time tracking program</a></li>
<li><a href="../301800/index.html">DevCon 2016. Join the broadcast today at 09:30! What awaits you on the second day?</a></li>
<li><a href="../301802/index.html">All lie, and you do not lie, or the debunking of the myth of memorization</a></li>
<li><a href="../301806/index.html">DevConf :: PHP 2016 - the final vote on the section reports is over, manage to cast your vote before May 31</a></li>
<li><a href="../301808/index.html">PostgreSQL is not Rocket Science. How much is the eggs now?</a></li>
<li><a href="../301810/index.html">Squeezing gigabits: or undocumented ViPNet Client / Coordinator feature</a></li>
<li><a href="../301812/index.html">We test the project on SaltStack using KitchenCI</a></li>
<li><a href="../301814/index.html">How to choose ITshnika in Russia: myth number 2, number 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>