<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We water the flowers - simply and quickly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear Habrozhiteli! 
 Recently my father called me, told me that he had a flower, which he constantly forgets to water or pours too much water, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We water the flowers - simply and quickly</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/7cd/973/52c/7cd97352c356d4af43f5ab5ba85fa818.png" alt="image"><br><br>  Hello, dear Habrozhiteli! <br>  Recently my father called me, told me that he had a flower, which he constantly forgets to water or pours too much water, eventually he dries up, then suffers from an excess of moisture. <br><br>  We will solve this problem with a microcontroller and C #. <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage3/278/9a1/732/2789a17323caff187ec877e234cf4988.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Not long after consulting, it was decided to automate this process.  We identified for ourselves the basic requirements for what we would like to see: <br><ul><li>  It should be cheap, cheaper than market analogs. </li><li>  It should be very easy to program, there should be a visual interface on the screen. </li><li>  Information should be collected on the basis of sensors (that is, no nonsense about the timer - all analogues in the market at the time of this writing are working on a timer, or we just did not find such) </li><li>  The flower stands next to the computer, which means you can (preferably, to avoid the power supply) use USB </li></ul><br><br><h5>  Part 1. Hardware </h5><br>  Asking a question on Habr√© ( <a href="http://habrahabr.ru/qa/46188/">question</a> ), I received a lot of suggestions about Arduino and other devices, however, I stopped at <a href="http://microsin.net/programming/AVR/avr-usb-mega16.html">AVR-USB-MEGA16</a> (thanks to Andrew for the advice and assistance in mastering, as well as for the speed of delivery). <br><br><img src="https://habrastorage.org/storage3/46b/0d6/b2b/46b0d6b2be722d1d1136e231174fae4b.jpg"><br><br>  As a result, the following components were purchased: <br><ul><li>  AVR-USB-MEGA16 - 500 rub. </li><li>  Soil moisture sensor - 120 rubles. </li><li>  Aquarium pump for 200 l / h - 507 rubles. </li><li>  Soil cleaner (needed a tube from the kit) - 330 rubles. </li><li>  Dushik aquarium - 193 rubles. </li><li>  Relay 5DC / 220AC - 170 rubles. </li><li>  Biopolar transistor - 7.5 rubles. </li><li>  Resistance - 10 p. </li><li>  Block with terminals - 100 p. </li><li>  Fuse block - 50 p. </li><li>  Fuse - 22 rubles. </li><li>  USB wire - 220 rubles. </li></ul><br><br>  Total not counting all sorts of trifles got about 2,200 rubles. <br><br><img src="https://habrastorage.org/storage3/fa5/137/504/fa5137504ffd41836a5a4961a759a928.png"><br><br>  All parts are very compact, the biggest is the pump: <br><br><img src="https://habrastorage.org/storage3/dd4/5d3/313/dd45d331369d7d5376bdb76db0f3f0dd.jpg"><br><br>  So, everything is bought, it's time to build.  The circuit for switching on the relay was advised by @AlekseyNovikov, for which many thanks to him.  Here is the diagram: <br><br><img src="https://habrastorage.org/storage3/5b7/e5c/721/5b7e5c721dedd24230f5e6fdc348f5d3.gif"><br><br>  The only thing that decided to remove the diode.  Having spent the evening on the ration, it turned out quite sane result: <br><br><img src="https://habrastorage.org/storage3/cb3/376/77e/cb337677e1fda5cb3aed311d9957bd8b.jpg"><br><br>  Now we come to the most interesting - the logic of work. <br><br><h5>  Part 2. Software part </h5><br><br>  Before the start of this venture, the main fear or fear was the complexity of microcontroller programming, the absence of normal debugs and other difficulties, so the main purpose of this article is not to describe the idea as such, because it is not new, but to promote the simplicity of using such devices with the help of modern languages programming such as C #. <br><br>  We only need two things from the board: <br><ul><li>  Soil moisture sensor reading </li><li>  On / off relay </li></ul><br><br>  So, I used WPF in conjunction with Sergey's Kukhteksky's firmware (for details, you can read how it works <a href="http://microsin.net/programming/avr-working-with-usb/avr-usb-mega16-and-csharp-class.html">here</a> ). <br>  The program is a tray icon and a small unobtrusive window. <br><br><img src="https://habrastorage.org/storage3/0f5/b25/3c1/0f5b253c1efbe8143067cdd6d4df6aa7.png"><br><br>  Program settings are also as simple as possible: <br><br><img src="https://habrastorage.org/storage3/583/880/3ee/5838803eef88504c9e324c2ea5856d6c.png"><br><br>  The main problems in the software include the following problems: <br><ol><li>  The pump performance indicated on the pump has almost nothing to do with reality. </li><li>  The pump performance depends very much on the height of the water rise, for example, if the pump just drains water, then the performance of my pump specifically reaches 350 liters per hour, but at a height of 80 cm, it hardly reaches 40 liters per hour. </li><li>  It's hard to determine the capacity of the container in which the pump will work </li><li>  Before the water reaches the flower, it must not pass a simple way up the tube. </li></ol><br><br>  To solve these problems, a simple measurement-based algorithm was invented.  After everything is in place, water is drawn into the tank: <br><ul><li>  We determine the rate of water rise: just click on the corresponding field with the mouse, then press Enter, the pump will start working as soon as the first drop of water appears, press Enter again and see the time spent on the water rise. </li><li>  We determine the pump performance at this height: after determining the time, we find a glass, the capacity of which is known to be known, I took a baby bottle for the mixes, measured risks are set on it, set the ‚ÄúWatering volume‚Äù value to 200 ml.  Click the mouse on the field "Pump performance", press Enter and wait until exactly 200 ml is poured into the bottle, as soon as this happens press the Enter button again and voila, we have the exact pump performance. </li><li>  Determine the volume of the tank: here we need a bucket or some large capacity, by analogy, activate the desired field, press Enter and just wait for almost all the water to spill out, stop at the moment when the pump is still slightly covered with water.  We have a volume of water that can be used. </li></ul><br><br>  Everything, the system is ready to work.  According to the first parameter of the settings - the amount of watering, it is determined automatically based on the soil moisture sensor and the optimum humidity for this type of plant (unfortunately, I did not bring it into the interface, it is installed in the XML file) <br><br><h6>  The algorithm of the APC (Automatic Flower Polylka) is simple: </h6><br>  Once every ten minutes readings are taken from the soil moisture sensor (a number of measurements occur, the arithmetic average is taken).  Based on the testimony, a decision is made to irrigate the soil, if the deviation from the norm is more than 5%, then watering occurs.  Data on all actions are recorded in the database, based on them, an irrigation forecast is subsequently constructed, a graph and the required amount of irrigation is determined.  The algorithm for determining the volume of poured liquid is also very simple.  There is a certain standard of humidity, say 74% (indicated in the XML file for a specific plant), the first irrigation of 100 ml occurs, after 10 minutes the next measurement of humidity occurs and we look at the deviation from the reference humidity level, if the humidity is less than necessary, then the next watering is added in increments depending on the deviation (100 ml, 50 ml, 10 ml, 3 ml).  If the level of humidity has not changed + -5 units, then we consider that the water in the reservoir has run out, send SMS. <br><br>  Unfortunately, <i>I do not like flowers</i> , I simply don‚Äôt have them, so I didn‚Äôt succeed in running around the system on a real plant, I bought an experimental chrysanthemum, which successfully died in the first week of experiments.  The mechanism was successfully sent to my father (hello to the Post of Russia, the parcel should have reached within a week, it is already three and it is not known what is with it), as soon as he installs and launches everything, he will definitely make a video and I will add it. <br><br>  The disadvantages of this system include a lot, first of all, dependence on the PC, secondly, all this is quite massive, a large reservoir, wires go to it, a thick tube goes from it to the top of the pot, wires come out of the pot from the sensors, all this included in the outlet, because  220V pump. <br><br>  The plans for the near future to eliminate all the shortcomings, I want to draw a 3D model that will include everything in one pot - tank, pump, water channels, sensors, LCD screen, etc., I want it all to work on batteries for at least six months This pot will work on the Arduin Mini Pro. <br><br>  At the moment, I master Blender (I have a lot of experience in 3D Max), because I decided to completely abandon pirated software, after I finish, I pass the model into 3D printing, eliminate all the flaws, launch the prototype and will definitely write a continuation of this article. <br><br>  UPD: I am attaching the current device circuit (without a diode, later it must be added) <br><img src="https://habrastorage.org/storage3/25c/f5e/db9/25cf5edb944cfc490996c43c4a133f4a.png"><br><br>  The most interesting points are the preparation of the device: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { dev = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ATMega16(vid, pid); <span class="hljs-comment"><span class="hljs-comment">//   dev  ATMega16. if (!dev.IsOpen()) //     USB { return false; } else //   ,    USB { dev.DDRD |= 0x80; //  7  D -   dev.PORTD &amp;= 0x7F; //     dev.ADMUX = (3 &lt;&lt; ATMega16.REFS0); //       //       200 .     //     128 ( ADPS0, ADPS1  ADPS2   1). ..  125 . //    (1/125000)*13 = 104 ,   - 9.6  //   ADEN  1    dev.ADCSRA = (1 &lt;&lt; ATMega16.ADEN) | (1 &lt;&lt; ATMega16.ADPS2) | (1 &lt;&lt; ATMega16.ADPS1) | (1 &lt;&lt; ATMega16.ADPS0); } return true; }</span></span></code> </pre> <br><br>  Readings from the sensor: <br><br><pre> <code class="cs hljs"> dev.ADMUX = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((dev.ADMUX &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span>) | <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    - ADC0 dev.ADCSRA |= (1 &lt;&lt; ATMega16.ADSC); //   //    ( 100 ).       while ((dev.ADCSRA &amp; (1 &lt;&lt; ATMega16.ADIF)) == 0) ; return (dev.ADCL + (((int)dev.ADCH) &lt;&lt; 8)); //  </span></span></code> </pre><br><br>  Conversion of readings from the sensor in% humidity, and later in line value: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> persantage = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(stateOfSoil / <span class="hljs-number"><span class="hljs-number">8.4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">20</span></span>) result = <span class="hljs-string"><span class="hljs-string">" "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">30</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">50</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">60</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">70</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">80</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persantage &lt; <span class="hljs-number"><span class="hljs-number">90</span></span>) result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Format(<span class="hljs-string"><span class="hljs-string">"{0} ({1}%)"</span></span>, result, persantage);</code> </pre><br><br>  Turn on the pump: <br><pre> <code class="cs hljs"> dev.PORTD |= <span class="hljs-number"><span class="hljs-number">0x80</span></span>;</code> </pre><br><br>  Disconnect the pump: <br><pre> <code class="cs hljs"> dev.PORTD &amp;= <span class="hljs-number"><span class="hljs-number">0x7F</span></span>;</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/195998/">https://habr.com/ru/post/195998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195980/index.html">A Tale of the Present PRINTRBOTe (Part 1: Musa Isaakovna)</a></li>
<li><a href="../195982/index.html">The Atom platform from Yandex - the Internet adapted for everyone</a></li>
<li><a href="../195988/index.html">Start loop: launch of payload into orbit for $ 3 / kg</a></li>
<li><a href="../195990/index.html">The role of team leader: what is left for managers?</a></li>
<li><a href="../195996/index.html">Introduction to the analysis of the complexity of algorithms (part 3)</a></li>
<li><a href="../196000/index.html">Sales of Highscreen Boost 2: 6,000 mAh and the Guinness Book of Records began</a></li>
<li><a href="../196002/index.html">Derby.js Warrior's Way</a></li>
<li><a href="../196006/index.html">Collaboration of Aastra Blustar 8000i and Cisco CUCM 9.0 video terminals</a></li>
<li><a href="../196008/index.html">We write our book</a></li>
<li><a href="../196012/index.html">A new war has begun for Vkontakte. Durov threatened with dismissal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>