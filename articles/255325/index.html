<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Malefactors use complex malware to attack Russian business</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the end of last year, we started tracking a new malicious campaign to spread the banking Trojan. The attackers were focused on the compromise of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Malefactors use complex malware to attack Russian business</h1><div class="post__text post__text-html js-mediator-article">  From the end of last year, we started tracking a new malicious campaign to spread the banking Trojan.  The attackers were focused on the compromise of Russian companies, ie, corporate users.  The malicious campaign was active for at least a year and, in addition to the banking trojan, the attackers resorted to the use of other various software tools.  These include a special loader packaged using <a href="https://ru.wikipedia.org/wiki/Nullsoft_Scriptable_Install_System">NSIS</a> , and spyware that is disguised as the well-known legitimate Yandex Punto software.  As soon as the attackers managed to compromise the victim's computer, they install a backdoor and then a banking Trojan program. <br><br><img src="https://habrastorage.org/files/b4e/8b5/46a/b4e8b546a9fe48edb03d999148083ead.jpeg"><br><br><a name="habracut"></a>  For their malicious programs, the attackers used several valid (at that time) digital certificates and special circumvention techniques for AV products.  The malicious campaign was aimed at a large number of Russian banks and is of particular interest, because the attackers used for it those methods that are often used in targeted attacks, i.e. attacks that are not motivated by purely financial fraud.  It may be noted that there is some similarity between this malicious campaign and a major incident, which has gained greater fame earlier.  This is a cybercrime group that used the <a href="https://www.fox-it.com/en/files/2014/12/Anunak_APT-against-financial-institutions2.pdf">Anunak</a> / <a href="https://securelist.com/blog/research/68732/the-great-bank-robbery-the-carbanak-apt/">Carbanak</a> banking trojan. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The attackers installed malware only on those computers that used the Russian language in Windows (localization) by default.  The main distribution vector of the Trojan was the Word document with the exploit <a href="https://web.nvd.nist.gov/view/vuln/detail%3FvulnId%3DCVE-2012-0158">CVE-2012-0158</a> , which was sent as an attachment to the document.  Below the screenshots show the appearance of such forged documents.  The first document is entitled ‚ÄúAccount No. 522375-FLORL-14-115.doc‚Äù, and the second ‚Äúkontrakt87.doc‚Äù, it is a copy of the contract for the provision of telecommunications services of the mobile operator Megafon. <br><br><img src="https://habrastorage.org/files/b46/8e5/6b0/b468e56b08d345f7b2c0c82f302efd6d.png"><br>  Fig.  1. Phishing document. <br><br><img src="https://habrastorage.org/files/78e/623/a48/78e623a4833a47d883ffbc61d674f3a4.png"><br>  Fig.  2. Another modification of the phishing document. <br><br>  The following facts indicate that the attackers were guided by the Russian business: <br><ul><li>  distribution of malware using fake documents on the specified subject; </li><li>  malicious tactics and the malicious tools they use; </li><li>  links to business applications in some executable modules; </li><li>  names of malicious domains that were used in this campaign. </li></ul><br>  Special software tools that attackers install in a compromised system, allow them to gain remote control over the system and track user activity.  To perform these functions, they establish a backdoor, and also try to get a password from a Windows account or create a new account.  Attackers also use the services of a keylogger (keylogger), a thief of information from the Windows clipboard (clipboard stealer), as well as special software for working with smart cards.  This group tried to compromise other computers that were on the same local network as the victim‚Äôs computer. <br><br>  Our ESET LiveGrid telemetry system, which allows you to quickly track malware distribution statistics, has provided us with interesting geographical statistics about the distribution of malware used by attackers in the mentioned campaign. <br><br><img src="https://habrastorage.org/files/ad3/ce1/3ea/ad3ce13ead51487db6c0cf9fc62d301a.png"><br>  Fig.  3. Geographical distribution statistics of the malware used in this malicious campaign. <br><br>  <b>Malware Installation</b> <br><br>  After the user opens a malicious document with an exploit on the vulnerable system, a special downloader packed with NSIS will be loaded and executed there.  At the beginning of its work, the program checks the Windows environment for the presence of debuggers there or running in the context of a virtual machine.  It also checks the localization of Windows and whether the user has visited the URLs listed in the table below in the browser.  For this, the <i>FindFirst</i> / <i>NextUrlCacheEntry API</i> and the Software \ Microsoft \ Internet Explorer \ TypedURLs registry key are used. <br><br><img src="https://habrastorage.org/files/588/f9a/8c0/588f9a8c0b244f8a96697b66138f3738.png"><br><br>  The loader checks the presence of the following applications in the system. <br><br><img src="https://habrastorage.org/files/fa7/3f8/a07/fa73f8a07f924be9b6d78b2c16135a20.png"><br><br>  The list of processes is really impressive and, as you can see, not only banking applications are present in it.  For example, an executable file named "scardsvr.exe" refers to software for working with smart cards (Microsoft SmartCard reader).  The banking trojan itself incorporates capabilities for working with smart cards. <br><br><img src="https://habrastorage.org/files/fc4/dd4/242/fc4dd42428d54248b5d0e4e6e4386c1b.png"><br>  Fig.  4. The general scheme of the installation of malware. <br><br>  In case of successful completion of all checks, the bootloader downloads a special file (archive) from the remote server, which contains all the malicious executables used by the attackers.  It is interesting to note that, depending on the checks listed above, the archives downloaded from a remote C &amp; C server may vary.  The archive may be malicious and not.  In the case of non-malicious, it installs the user to the Windows Live Toolbar.  Most likely, the attackers have gone to such tricks to deceive the automatic systems for analyzing files and virtual machines that run suspicious files. <br><br>  The file downloaded by the NSIS loader is a 7z archive that contains various modules of malware.  The figure below shows the whole process of installing this malware and its various modules. <br><br><img src="https://habrastorage.org/files/fe4/11f/203/fe411f203eb547a9b5480333d8b68b02.png"><br>  Fig.  5. The general scheme of the malware. <br><br>  Although the loaded modules serve to perform different tasks of intruders, they are equally packed and many of them have been signed with valid digital certificates.  We found four such certificates that the attackers used from the very beginning of the campaign.  After our complaint, these certificates were revoked.  It is interesting to note that all certificates were issued to companies registered in Moscow. <br><br><img src="https://habrastorage.org/files/5b7/6ad/910/5b76ad91079448179774e269a21573e7.png"><br>  Fig.  6. The digital certificate that was used to sign malware. <br><br>  The following table shows the digital certificates that attackers used in this malicious campaign. <br><br><img src="https://habrastorage.org/files/2fc/75d/ff8/2fc75dff8cf44025a5523d87b51add48.png"><br><br>  Almost all malicious modules used by attackers have the same installation procedure.  They are 7zip self-extracting archives that are password protected. <br><br><img src="https://habrastorage.org/files/250/aa2/58e/250aa258e7de49e0be3eab0fb15fb03b.png"><br>  Fig.  7. Fragment of the install.cmd batch file. <br><br>  A batch .cmd file is responsible for installing malware into the system and launching various malicious tools.  If the execution requires the missing administrator rights, the malicious code uses several methods for obtaining them (bypassing UAC).  To implement the first method, two executable files are used with the names l1.exe and cc1.exe, which specialize in bypassing the UAC mechanism from <a href="http://habrahabr.ru/company/eset/blog/184576/">leaked Carberp</a> source texts.  Another way is based on exploiting the CVE-2013-3660 vulnerability.  Each module of a malicious program that needs privilege escalation contains both a 32-bit and 64-bit version of the exploit. <br><br>  During the tracking of this campaign, we analyzed several archives downloaded by the loader.  The contents of the archives differed, that is, attackers could adapt malicious modules for various purposes. <br><br>  <b>User compromise</b> <br><br>  As we mentioned above, attackers use special tools to compromise users' computers.  Such tools include programs with executable file names mimi.exe and xtm.exe.  They help attackers to establish control over the victim's computer and specialize in the following tasks: retrieving / recovering passwords for Windows accounts, enabling the RDP service, creating a new account (account) in the OS. <br><br>  The mimi.exe executable file includes a modified version of the famous open source <a href="https://twitter.com/gentilkiwi">tool Mimikatz</a> .  This tool allows you to get passwords for Windows user accounts.  The attackers removed from the Mimikatz the part that is responsible for user interaction.  The executable code was also modified to start Mimikatz with the privilege :: debug and sekurlsa: logonPasswords commands. <br><br>  Another executable file xtm.exe runs special scripts for execution that include the RDP service in the system, try to create a new account in the OS, and also change the system settings to allow several users to simultaneously connect to the compromised computer through RDP.  Obviously, these steps are necessary to gain complete control over the compromised system. <br><br><img src="https://habrastorage.org/files/fb5/4bf/0a9/fb54bf0a91294e9b9450e7cddbc92deb.png"><br>  Fig.  8. Commands executed by xtm.exe in the system. <br><br>  Attackers use another executable file called impack.exe, which is used to install special software into the system.  This software is called LiteManager and is used by hackers as a backdoor. <br><br><img src="https://habrastorage.org/files/834/a2f/545/834a2f54590d48fb893451b50ea988b9.png"><br>  Fig.  9. Interface LiteManager. <br><br>  Once installed in the user's system, LiteManager allows attackers to directly connect to this system and remotely control it.  This software has special command line parameters for its secretive installation, creating special firewall rules, and running its own module.  All parameters are used by intruders. <br><br>  The latest module from the malware suite used by attackers is the bank malware with the name of the executable file pn_pack.exe.  She specializes in spying on the user and is responsible for interacting with the C &amp; C server manager.  The launch of the banker is performed using the legitimate software Yandex Punto.  Punto is used by attackers to launch a malicious DLL (Side-Loading DLL method).  Malware itself can perform the following functions: <br><br><ul><li>  track keystrokes on the keyboard and the contents of the clipboard for subsequent transfer to a remote server; </li><li>  list all smart cards that are present in the system; </li><li>  interact with a remote C &amp; C server. </li></ul><br>  The module of the malicious program, which is responsible for performing all these tasks, is an encrypted DLL library.  It is decrypted and loaded into memory during the execution of Punto.  To perform the above tasks, the executable code DLL runs three threads. <br><br>  The fact that the attackers chose Punto software for their own purposes is not a surprise: some Russian forums openly provide detailed information on such a topic as the use of flaws in legitimate software to compromise users. <br><br>  The malicious library uses the RC4 algorithm to encrypt its strings, as well as during network interaction with the C &amp; C server.  She contacts the server every two minutes and transmits there all the data that was collected on the compromised system during this period of time. <br><br><img src="https://habrastorage.org/files/f86/ccb/946/f86ccb946bfd4780ac76ee487b790405.png"><br>  Fig.  10. Fragment of network interaction between the bot and the server. <br><br>  Below are some of the C &amp; C server instructions that the library can receive. <br><br><img src="https://habrastorage.org/files/097/97a/cfb/09797acfb2a643b391e7b0d55a88ae4a.png"><br><br>  In response to receiving instructions from the C &amp; C server, the malware responds with a status code.  It is interesting to note that all the modules of the banker that we analyzed (the latest one with the compilation date of January 18th) contain the string ‚ÄúTEST_BOTNET‚Äù, which is sent in each message to the C &amp; C server. <br><br>  <b>Conclusion</b> <br><br>  To compromise corporate users, attackers at the first stage compromise one employee of the company by sending a phishing message with an exploit.  Further, as soon as the malware is installed in the system, they will use software tools that will help them significantly empower the system and perform additional tasks on it: compromise other computers on the corporate network and spy on the user, as well as on bank transactions that performs. <br><br><img src="https://habrastorage.org/files/634/62a/c19/63462ac1986d4edeb82d71440e815e90.png"><br><br><img src="https://habrastorage.org/files/97d/f7e/db0/97df7edb005d4784b367f730c7a4dd06.png"></div><p>Source: <a href="https://habr.com/ru/post/255325/">https://habr.com/ru/post/255325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255311/index.html">Global Education: Russian government scholarship program for study abroad</a></li>
<li><a href="../255315/index.html">AppStore comprehension path or how much experience?</a></li>
<li><a href="../255317/index.html">openEMS is an open source electromagnetic simulator</a></li>
<li><a href="../255321/index.html">Create a fully automatic farm (finished implementation)</a></li>
<li><a href="../255323/index.html">We are switching from STM32 to the Russian K1986BE92QI microcontroller. Setting up the project in keil and flashing LED</a></li>
<li><a href="../255327/index.html">Why one AJAX is not enough: WAMP protocol</a></li>
<li><a href="../255329/index.html">Simulate sensor readings using an array of waypoints</a></li>
<li><a href="../255331/index.html">Vulnerability in Xamarin for Android: we replace dll and we eat for free</a></li>
<li><a href="../255333/index.html">New adware is embedded directly in the browser.</a></li>
<li><a href="../255337/index.html">How does a boiler house in Middle Akhtuba differ from a power center of a data center?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>