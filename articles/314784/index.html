<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle database audit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrachiteli! Naturally, the desire of each employer to evaluate the effectiveness and quality of the work performed by employees, to incr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle database audit</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fc9/4e9/1b0/fc94e91b0cc042948d8410d024110b2f.jpg"><br><br>  Hello, dear habrachiteli!  Naturally, the desire of each employer to evaluate the effectiveness and quality of the work performed by employees, to increase profits and reduce costs.  IT infrastructure support is always a ‚Äúblack box‚Äù.  For what money is paid, because nothing is broken yet?  Since no one manager will most likely want to delve into the problematic, it is very likely that there will soon be a need for a report on the work done, and preferably daily.  Considering beautiful tsiferki and slender graphics, the customer invariably "comes to taste."  Gradually, there are reports of monitoring infrastructure, the state of backups, missed incidents, the work of DLP systems.  And the further, the worse.  IT support starts to lose in efficiency, the team‚Äôs work schedule changes, because the report is needed in the morning.  This practice incredibly stimulates mental activity in the direction of the rapid provision of data to which you have almost exclusive access.  My way to solve this problem I will try to describe further. <br><a name="habracut"></a><br><h3>  Report report chases </h3><br>  The customer is a very large production company with a huge number of stores and warehouses.  She loves Oracle in a Windows environment (which is rare).  We do not consider factories, our goal is warehouses and shops, and all the DBMS that are spinning there. <br><br>  It is known that new DBMS instances are created on a regular basis by developers or testers - they can easily not inform anyone about the existence of their test environment, but they will panic when they accidentally delete it due to server decommissioning or regular virtualization.  There are god-forgotten servers with databases 10 years ago.  They still work with any store or warehouse.  Where are the bases located (at least geographically) - no one knows, including the customer and the monitoring system for $ 10K.  These DBMS were never brought there.  As already stated, the specificity is such that most of the Oracle DBMS is deployed in a Windows environment.  Win-instans already about 200 and collect such information about them is very difficult.  There is also Oracle for Linux.  There are only 40 such bases, of which there are 40 pieces. There is another serious plus ‚Äî the servers have a Name convention on location: find the name of the server ‚Äî find its location. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the development of the report we will use PowerShell.  Why?  For: <br><br><ul><li>  Work is carried out from the terminal machine of Windows Server 2008. There is no access to other servers from outside. </li><li>  Excel is there!  PowerShell wonderfully works with it as with a com object.  You do not need to look for modules, like, for example, Python, since everything is already embedded in NET. </li><li>  Most of the servers we still have Windows. </li><li>  I have more experience with PowerShell. </li></ul><br>  In order to access and obtain information from Linux-hosts, we still install Cygwin.  All scripts and reports will then be in one place, and this is good.  The task of the report: there is a long-term security audit of Oracle databases in connection with the migration of the DBMS to the virtual environment. <br><br>  It is necessary to determine: <br><br><ul><li>  how many bases do we have </li><li>  What is their current state? </li><li>  which servers are located, are they running at all, </li><li>  how to consume resources, which version of Oracle is deployed. </li></ul><br><h3>  Start with linux </h3><br>  For some reason, local developers are afraid of them, so all the DBMSs are in production.  Servers are known, they are few.  We scan the list of Linux hosts and get the resulting file in our directory.  To search for Oracle instances, we are looking for a running Pmon process with a simple one-line bash script. <br><br>  Script 1: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(cat file.txt) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ssh oracle@<span class="hljs-variable"><span class="hljs-variable">$line</span></span> <span class="hljs-string"><span class="hljs-string">'$(ps -e -o cmd | grep ora_pmon |grep -v grep|cut -c 10-19 &gt; /tmp/result.txt) ; while read i ; do my_var=$(echo $i ); echo $(hostname -s)";"${my_var##*_}";;;"; done &lt; /tmp/result.txt ; rm /tmp/result.txt'</span></span> &gt;&gt;script_files/FileOra2.csv <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><h3>  Windows is our everything </h3><br>  Here we will not find Pmon, the whole Oracle is implemented as one multi-threaded process.  We will bypass Windows-hosts with the help of Windows Management Interface.  Oracle instance will be found in Windows services.  Use PowerShell: <br><br><h4>  Script 2 </h4><br><pre> <code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$MLpath</span></span>= <span class="hljs-string"><span class="hljs-string">'c:\scripts\DBA\script_files\ML.txt'</span></span> <span class="hljs-variable"><span class="hljs-variable">$MLdir</span></span>= [System.IO.Path]::GetDirectoryName(<span class="hljs-variable"><span class="hljs-variable">$MLPath</span></span>) <span class="hljs-variable"><span class="hljs-variable">$outfile</span></span>=$(<span class="hljs-variable"><span class="hljs-variable">$MLdir</span></span> +<span class="hljs-string"><span class="hljs-string">'\'</span></span>+<span class="hljs-string"><span class="hljs-string">'FileOra.csv'</span></span>) <span class="hljs-variable"><span class="hljs-variable">$Dbfile</span></span>= $(<span class="hljs-variable"><span class="hljs-variable">$MLdir</span></span> +<span class="hljs-string"><span class="hljs-string">'\'</span></span>+<span class="hljs-string"><span class="hljs-string">'DBList.csv'</span></span>) <span class="hljs-variable"><span class="hljs-variable">$hosts</span></span>=get-content <span class="hljs-variable"><span class="hljs-variable">$MLpath</span></span> -Force <span class="hljs-variable"><span class="hljs-variable">$a</span></span>= foreach (<span class="hljs-variable"><span class="hljs-variable">$pc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$hosts</span></span>){ write-host <span class="hljs-string"><span class="hljs-string">"test </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pc</span></span></span><span class="hljs-string">"</span></span> try{ &lt;<span class="hljs-comment"><span class="hljs-comment">#TO display gwmi -Class win32_service -computername "$pc"|where { $_.name -like "OracleService*" } -ErrorAction SilentlyContinue|format-table "$pc", name, state, pathname, StartMode -autosize|out-host#&gt; $colItems = gwmi -Class win32_service -computername "$pc"|where { $_.name -like "OracleService*" } -ErrorAction SilentlyContinue foreach ($objItem in $colItems) {$($pc +";" +($objItem.name).trimstart("OracleService") +";" +$objitem.state +";" +$ObjITem.pathname +";" +$ObjITem.startmode) &gt;&gt; $outfile } } catch { Write-Output $("$pc" + $_.Exception.Message) } }</span></span></code> </pre><br><h3>  What's next </h3><br>  Having collected a list of hosts and databases, the first step to updating information has been made.  First of all, I started a single user in each DBMS, from which I performed further actions.  It is time to gather information.  It would be possible to use SQL * Plus, but since we are working with com objects, it is better to use OLEDB for Oracle.  To do this, we will install an OLEDB-provider on our terminal and execute the query we are interested in in each DBMS.  You can download it, for example, from the official website of Oracle.  In the system requirements for OLEDB we see about the following: <br><br>  - Access to an Oracle Database (Oracle 9.2 or later) <br>  - Oracle Client release 11.1 or later and Oracle Net Services (included with Oracle Provider for OLE DB installation). <br><br>  Now you can abstract from the operating system on the servers.  We create the connector, execute the query in each separate database and save the results in a file.  I, however, use the script 3 separately, executing any arbitrary queries to the DBMS list, such as free space, SGA, PGA parameters, user lists, and their password strength (HASH for Oracle passwords can be easily found on the Internet).  Some query characters will require escaping in PowerShell ‚Äî in this case, it is convenient to use the Oracle function CHR, which returns a character from the ASCII character set table.  Also, we will get a separate list of hosts to which we could not connect with the error codes for further analysis. <br><br><h4>  Script 3 </h4><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OLEDBData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($connectstring, $sql)</span></span></span><span class="hljs-function"> </span></span>{ $OLEDBConn = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object System.Data.OleDb.OleDbConnection($connectstring) $OLEDBConn.open() $readcmd = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object system.Data.OleDb.OleDbCommand($sql,$OLEDBConn) $readcmd.CommandTimeout = <span class="hljs-string"><span class="hljs-string">'10'</span></span> $da = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object system.Data.OleDb.OleDbDataAdapter($readcmd) $dt = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object system.Data.datatable [void]$da.fill($dt) $OLEDBConn.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $dt } $date=(get-date).toshortdatestring().replace(<span class="hljs-string"><span class="hljs-string">"/"</span></span>,<span class="hljs-string"><span class="hljs-string">"."</span></span>) $log = <span class="hljs-string"><span class="hljs-string">"$("</span></span>$date<span class="hljs-string"><span class="hljs-string">" +"</span></span>_<span class="hljs-string"><span class="hljs-string">"+ 'error')"</span></span> $db = <span class="hljs-string"><span class="hljs-string">"$("</span></span>$date<span class="hljs-string"><span class="hljs-string">" +"</span></span>_<span class="hljs-string"><span class="hljs-string">"+ 'DBlist')"</span></span> $qry= <span class="hljs-string"><span class="hljs-string">'select INSTANCE_NAME,HOST_NAME,VERSION from V$INSTANCE'</span></span> gc c:\_tir\fileORA.csv| % { $row = $_.split(<span class="hljs-string"><span class="hljs-string">";"</span></span>) $hostname = $row[<span class="hljs-number"><span class="hljs-number">0</span></span>] $service = $row[<span class="hljs-number"><span class="hljs-number">1</span></span>] $connString = <span class="hljs-string"><span class="hljs-string">"password=xxxxXXXxxx;User ID=ORAUSER;Data Source=$hostname/$service;Provider=OraOLEDB.Oracle"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Get-OLEDBData $connString $qry} <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> {Write-Output $(<span class="hljs-string"><span class="hljs-string">"$Compname"</span></span> +<span class="hljs-string"><span class="hljs-string">';'</span></span>+ $_.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>.Message) &gt;&gt; C:\_tir\$log.log } }|Export-Csv c:\_tir\$db.csv -delim <span class="hljs-string"><span class="hljs-string">';'</span></span></code> </pre><br><h3>  Induce beauty </h3><br>  Text files are ugly.  We combine all the results in the catalog into a daily Excel report.  We work with Excel sheet as with a regular object.  Hide the sheet so that the operation goes faster.  The report is sent to your email.  Finally, we will update our TNSNAMES file for the convenience of further connecting to the database via SQL * Plus.  We use the correct syntax of the file (never could remember it). <br><br><h4>  Script 4 </h4><br><pre> <code class="hljs scala">$date=(get-date).toshortdatestring().replace(<span class="hljs-string"><span class="hljs-string">"/"</span></span>,<span class="hljs-string"><span class="hljs-string">"."</span></span>) $<span class="hljs-type"><span class="hljs-type">MLpath</span></span>= <span class="hljs-symbol"><span class="hljs-symbol">'c</span></span>:\scripts\<span class="hljs-type"><span class="hljs-type">DBA</span></span>\script_files\<span class="hljs-type"><span class="hljs-type">ML</span></span>.txt' $<span class="hljs-type"><span class="hljs-type">MLdir</span></span>= [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">Path</span></span>]::<span class="hljs-type"><span class="hljs-type">GetDirectoryName</span></span>($<span class="hljs-type"><span class="hljs-type">MLPath</span></span>) $outfile=$($<span class="hljs-type"><span class="hljs-type">MLdir</span></span> +'\'+<span class="hljs-symbol"><span class="hljs-symbol">'FileOra</span></span>.csv') $<span class="hljs-type"><span class="hljs-type">Dbfile</span></span>= $($<span class="hljs-type"><span class="hljs-type">MLdir</span></span> +'\'+<span class="hljs-symbol"><span class="hljs-symbol">'DBList</span></span>.csv') $<span class="hljs-type"><span class="hljs-type">Dbfilexls</span></span>= $($<span class="hljs-type"><span class="hljs-type">MLdir</span></span> +'\'+<span class="hljs-symbol"><span class="hljs-symbol">'DBLis</span></span>t'+ $date +'.xlsx') #$logFile= [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">Path</span></span>]::<span class="hljs-type"><span class="hljs-type">Combine</span></span>($<span class="hljs-type"><span class="hljs-type">MLdir</span></span>,$(<span class="hljs-string"><span class="hljs-string">"{0}.log"</span></span> -f $sourceFileName )) gc $outfile|<span class="hljs-type"><span class="hljs-type">Sort</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> -<span class="hljs-type"><span class="hljs-type">Unique</span></span>|out-file $<span class="hljs-type"><span class="hljs-type">Dbfile</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> &lt;#creating excel doc#&gt; $excel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">-comobject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">excel</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$excel</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span></span>= $<span class="hljs-literal"><span class="hljs-literal">false</span></span> $workbook = $excel.workbooks.add() $workbook.workSheets.item(<span class="hljs-number"><span class="hljs-number">3</span></span>).delete() $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.item(<span class="hljs-number"><span class="hljs-number">2</span></span>).delete() $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.item(<span class="hljs-number"><span class="hljs-number">1</span></span>).<span class="hljs-type"><span class="hljs-type">Name</span></span> = <span class="hljs-string"><span class="hljs-string">"Databases"</span></span> $sheet = $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.<span class="hljs-type"><span class="hljs-type">Item</span></span>(<span class="hljs-string"><span class="hljs-string">"Databases"</span></span>) $x = <span class="hljs-number"><span class="hljs-number">2</span></span> $colorIndex = <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlColorIndex"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$borderWeight</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlBorderWeight"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$chartType</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlChartType"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">For</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">$b = 1 ; $b -le 5 ; $b++</span></span></span><span class="hljs-class">) </span></span>{ $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).font.bold = $<span class="hljs-literal"><span class="hljs-literal">true</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).borders.<span class="hljs-type"><span class="hljs-type">ColorIndex</span></span> = $colorIndex::xlColorIndexAutomatic $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).borders.weight = $borderWeight::xlMedium } $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) = <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) = <span class="hljs-string"><span class="hljs-string">"Instance"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) = <span class="hljs-string"><span class="hljs-string">"state"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>) = <span class="hljs-string"><span class="hljs-string">"path"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) = <span class="hljs-string"><span class="hljs-string">"autorun"</span></span> <span class="hljs-type"><span class="hljs-type">Foreach</span></span> ($row in $data=<span class="hljs-type"><span class="hljs-type">Import</span></span>-<span class="hljs-type"><span class="hljs-type">Csv</span></span> $<span class="hljs-type"><span class="hljs-type">Dbfile</span></span> -<span class="hljs-type"><span class="hljs-type">Delimiter</span></span> ';' -<span class="hljs-type"><span class="hljs-type">Header</span></span> name, value, path, state, start) { $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">1</span></span>) = $row.name $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">2</span></span>) = $row.value $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">3</span></span>) = $row.path $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">4</span></span>) = $row.state $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">5</span></span>) = $row.start $x++ } $range = $sheet.usedRange $range.<span class="hljs-type"><span class="hljs-type">EntireColumn</span></span>.<span class="hljs-type"><span class="hljs-type">AutoFit</span></span>() | <span class="hljs-type"><span class="hljs-type">Out</span></span>-<span class="hljs-type"><span class="hljs-type">Null</span></span> $<span class="hljs-type"><span class="hljs-type">Excel</span></span>.<span class="hljs-type"><span class="hljs-type">ActiveWorkbook</span></span>.<span class="hljs-type"><span class="hljs-type">SaveAs</span></span>($<span class="hljs-type"><span class="hljs-type">Dbfilexls</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($workbook -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $sheet = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> $range = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> $workbook.<span class="hljs-type"><span class="hljs-type">Close</span></span>($<span class="hljs-literal"><span class="hljs-literal">false</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($excel -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $excel.<span class="hljs-type"><span class="hljs-type">Quit</span></span>() $excel = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> [<span class="hljs-type"><span class="hljs-type">GC</span></span>]::<span class="hljs-type"><span class="hljs-type">Collect</span></span>() [<span class="hljs-type"><span class="hljs-type">GC</span></span>]::<span class="hljs-type"><span class="hljs-type">WaitForPendingFinalizers</span></span>() } <span class="hljs-type"><span class="hljs-type">IF</span></span>(<span class="hljs-type"><span class="hljs-type">Test</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> $<span class="hljs-type"><span class="hljs-type">MLdir</span></span>\tnsnames.ora ) { remove-item $<span class="hljs-type"><span class="hljs-type">MLdir</span></span>\tnsnames.ora -<span class="hljs-type"><span class="hljs-type">Force</span></span> } <span class="hljs-type"><span class="hljs-type">ELSE</span></span> { <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-string"><span class="hljs-string">"new tnsora"</span></span> } &lt;# <span class="hljs-type"><span class="hljs-type">Update</span></span> <span class="hljs-type"><span class="hljs-type">TNSORA</span></span> file#&gt; gc $<span class="hljs-type"><span class="hljs-type">Dbfile</span></span>| % { $row = $_.split(<span class="hljs-string"><span class="hljs-string">";"</span></span>) $hostname = $row[<span class="hljs-number"><span class="hljs-number">0</span></span>] $service = $row[<span class="hljs-number"><span class="hljs-number">1</span></span>] $name=$service+'_'+$hostname <span class="hljs-string"><span class="hljs-string">"$name = (DESCRIPTION = (ADDRESS_LIST = (ADDRESS = (PROTOCOL = TCP)(HOST = $hostname)(PORT = 1521)) ) (CONNECT_DATA = (SERVICE_NAME = $service) ) )"</span></span>&gt;&gt; $<span class="hljs-type"><span class="hljs-type">MLdir</span></span>\tnsnames.ora } &lt;#<span class="hljs-type"><span class="hljs-type">Mail</span></span> report to #&gt; $filename= $<span class="hljs-type"><span class="hljs-type">Dbfilexls</span></span>= $($<span class="hljs-type"><span class="hljs-type">MLdir</span></span> +'\'+<span class="hljs-symbol"><span class="hljs-symbol">'DBLis</span></span>t'+ $date +'.xlsx') $smtpServer = ‚Äúserver_name‚Äù $smtp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SmtpClient</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">$smtpServer</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$credentials=new-object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">system</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">networkcredential</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">"server_name\mail","</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Dfgtnb451</span></span></span></span><span class="hljs-class"><span class="hljs-params">"</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$smtp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credentials=$credentials</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getcredential</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">$smtpserver,‚Äù25‚Äù,‚Äùbasic‚Äù</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$msg=</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">New-Object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$att</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attachment</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">$filename</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$msg</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span></span>= ‚Äúuser<span class="hljs-meta"><span class="hljs-meta">@yourdomain</span></span>.com‚Äù $msg.to.add(‚Äútimur<span class="hljs-meta"><span class="hljs-meta">@rrrr</span></span>.xxx, valentin<span class="hljs-meta"><span class="hljs-meta">@rrrr</span></span>.xxx‚Äù) $msg.subject = ‚Äú<span class="hljs-type"><span class="hljs-type">Database_Report</span></span>‚Äù $msg.body = <span class="hljs-string"><span class="hljs-string">"DAtabase report sample body"</span></span> $msg.isbodyhtml= <span class="hljs-string"><span class="hljs-string">"false"</span></span> $msg.<span class="hljs-type"><span class="hljs-type">Attachments</span></span>.<span class="hljs-type"><span class="hljs-type">Add</span></span>($att) $smtp.<span class="hljs-type"><span class="hljs-type">Send</span></span>($msg)</code> </pre><br>  It remains to make our scripts in the Windows-scheduler.  First, we collect information about Oracle instances on Linux and Windows-hosts, respectively (1 and 2 scripts).  Next we connect to each DBMS and collect information (script 3).  Then we build an aggregated Excel report and send it by mail (script 4). <br><br><h3>  Conclusions: for what they fought - that is what ran into </h3><br><ul><li>  Put things in order.  There were ancient bases from Oracle 9 and the silent installations of Oracle 12. Finally, they got rid of them. </li><li>  I set up automatic forwarding of a letter from my Exchange mailbox to interested parties.  Always aware of changes in infrastructure. </li><li>  I know when and where the base fell, comparing two reports. </li><li>  I gradually pulled apart parts of this solution in other applications.  Always got the current list of Tnsnames </li><li>  During the creation of the report script, there were holes in the entrance with standard Oracle passwords, like scott / tiger with elevated access privileges.  Therefore, after creating the report, we had to carry out a separate security audit with enumeration of standard passwords and create a report already on the list of passwords.  Thus, the solution came in handy twice. </li></ul><br>  Successful automation! </div><p>Source: <a href="https://habr.com/ru/post/314784/">https://habr.com/ru/post/314784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314774/index.html">The remote proxy class is not (very) painful</a></li>
<li><a href="../314776/index.html">Know the competitor in person: how we conducted a competitive analysis</a></li>
<li><a href="../314778/index.html">NetApp ONTAP & ESXi 6.x tuning</a></li>
<li><a href="../314780/index.html">We use generics in RAD Studio Delphi. Create a library of sorting lists of similar objects</a></li>
<li><a href="../314782/index.html">TrickBot - a new spam attack on the company</a></li>
<li><a href="../314786/index.html">Topographer was drunk</a></li>
<li><a href="../314790/index.html">Personal experience: how to find a sales manager for a web studio</a></li>
<li><a href="../314792/index.html">The best IT vacancies on My Circle in a week, October 17-23</a></li>
<li><a href="../314794/index.html">Itseez, double Intel Company</a></li>
<li><a href="../314796/index.html">How we ran Habr for the humanities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>