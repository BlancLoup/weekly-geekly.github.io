<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use C # 5 features (async and await) in .NET 2.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dedicated to those 45% of .NET developers that still sit on the frameworks 2.0-3.5. 

 Yes, you heard right. async and await in the second dotnet. But...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use C # 5 features (async and await) in .NET 2.0</h1><div class="post__text post__text-html js-mediator-article">  <i>Dedicated to those <a href="http://habrahabr.ru/post/169029/">45% of .NET developers</a> that still sit on the frameworks 2.0-3.5.</i> <br><br>  Yes, you heard right.  async and await in the second dotnet.  But first things first. <br><br><h5>  What for? </h5><br>  At some point I got tired of manually fiddling with writing asynchronous code.  Async / awat looked too tasty not to try.  Knowing that Microsoft, when adding new features to the language and the compiler, does not tie them tightly to the framework (for example, extension-methods and LINQ can be perfectly used in the second .NET, if you declare System.Runtime.CompilerServices.ExtensionAttribute somewhere), and seeing Async CTP, adding the ability to use async / await to the 2010th studio when using the .NET 4.0 target framework, I thought, why not? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h5>  Way </h5><br>  Studying the results of the compiler activity and the dependencies of the framework classes, I realized that adding one attribute without a code is not enough.  Need a complete implementation, but where is it to get?  And then Mono comes to the rescue with its implementation of the BCL under the MIT license.  Well, brazenly we swing <a href="">Mono 3.10.1</a> and we pull out naked System.Threading.Tasks and necessary classes from System.Runtime.CompilerServices.  They are dependent on a lot of things, but for the most part everything is solved by simple copying.  There are two problems: <br><br>  1) OperationCanceledException knows nothing about CancellationToken.  We create a class OperationCancelledExceptionExt that knows.  It is thrown by CancellationToken.ThrowIfCancelled, so knowing our code about it is not necessary. <br><br>  2) ExceptionDispatchInfo.  This is where the real problems begin.  The class allows you not to lose the set-point when you re-throw an exception, which is very useful for async / await, for which everything was started.  Mono implements it through the internal-method of its implementation of the Exception class, so these sources will not help us much.  Well, we climb into the source code of the framework.  After a cursory analysis, we understand that there is a mechanism used by runtime to support the constructs when using Remoting. <br>  We analyze, issue the following code here (extracting the necessary Field / MethodInfo and saving the state elsewhere): <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Throw</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> _exception; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { InternalPreserveStackTrace.Invoke (_exception, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]); RemoteStackTrace.SetValue (_exception, _stackTrace); Source.SetValue (_exception, _source); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br><br>  We get the behavior close to the required: <br><blockquote>  There is a problem in the case where the Throw method is called. </blockquote><br>  For lack of the best solutions, we leave it like this. <br><br>  We compile, we connect to the project ... We observe the picture: async / await work, but for some reason they are marked in red.  It is treated by setting the correct version of the language in the project properties. <br><br><h5>  How to use </h5><br>  To build using Visual Studio 2010, you need to install <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D9983%25E2%2580%258E">Async CTP</a> .  To install, you need to perform a number of non-obvious actions, such as preliminary removal of MVC3 and <i>all</i> updates to the studio, released after SP1. <br>  In Visual Studio 2012, I did not check, but it should start. <br><br>  Next, we connect to the project <a href="https://github.com/kekekeks/MonoLib">MonoLib.dll</a> and use, not forgetting to set in the project properties, that we have C # 5. A small demo is in the same place. <br><br><h5>  Additions and improvements </h5><br>  Since Tuple and Action / Func overloads were needed to build tasks, it was decided not to waste time on stuff and stuff LINQ2Objects into the library.  If you wish, you can delete. <br><br>  The MonoLib.Async.Extensions class was created where several useful extension methods were added, half of which are copied with minor changes from <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D19957">this document</a> .  By the way, I strongly recommend that you read the document, it is detailed how to use tasks and async / await, as well as how to properly wrap code in them that uses other models of asynchronous calls. <br><br>  MonoLib.dll sources (borrowing from Mono + edits + ExceptionDispatchInfo) are available on <a href="https://github.com/kekekeks/MonoLib">GitHub</a> , improve the solution in your power. </div><p>Source: <a href="https://habr.com/ru/post/179381/">https://habr.com/ru/post/179381/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179371/index.html">Some statistics on email marketing</a></li>
<li><a href="../179373/index.html">Mnemonic: you can remember everything</a></li>
<li><a href="../179375/index.html">Little Computer People: the progenitor of Tamagotchi and Sims</a></li>
<li><a href="../179377/index.html">Crowdfunding for someone who releases something on a regular basis.</a></li>
<li><a href="../179379/index.html">NetApp and Cisco: Enhanced Collaboration, New FlexPod Configurations</a></li>
<li><a href="../179383/index.html">Fast translation of large lists on the example of regions of the world</a></li>
<li><a href="../179391/index.html">On-the-Knee Monitoring - Using Cacti to Control Java Applications</a></li>
<li><a href="../179393/index.html">Lomogram Windows Phone Statistics</a></li>
<li><a href="../179395/index.html">Studying Rails (well, Ruby)</a></li>
<li><a href="../179397/index.html">Mnemonic: you can remember even numbers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>