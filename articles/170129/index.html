<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Maps in a browser without a network: open source strikes back</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I wrote about how it is possible to use maps on the web without a network and tried to do this with the help of Google maps. Unfortunate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Maps in a browser without a network: open source strikes back</h1><div class="post__text post__text-html js-mediator-article"> Some time ago I <a href="http://habrahabr.ru/post/141707/">wrote about how it is possible to use maps on the web without a network</a> and tried to do this with the help of Google maps.  Unfortunately, the terms of use prohibited the modification of resources, and the code I wrote worked only with <code>localStorage</code> , so I decided to switch to the bright side of power, where the code is open, simple and understandable. <a name="habracut"></a><br><br><h4>  What do I want? </h4><br>  I want to make a map caching for full work without a network, for the first time you load a map, view tiles of interest (which will be cached in this case) and the next time a map with viewed tiles will be fully accessible without a network. <br><br>  In principle, it is not necessary to cache on the fly and you can do the same for a specific region separately.  But I just want to show you the approach. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What do we have? </h4><br>  In a modern web for storage of our data can approach: <br>  <a href="http://caniuse.com/offline-apps">Application Cache</a> - for statics, but not for tiles. <br>  <a href="http://caniuse.com/namevalue-storage">Local Storage</a> - using base64 data uri, synchronously, supported everywhere, but very little space. <br>  <a href="http://caniuse.com/indexeddb">Indexed DB</a> - using base64 data uri, asynchronously, is supported in full and mobile chrome, ff, ie10. <br>  <a href="http://caniuse.com/sql-storage">Web SQL</a> - using base64 data uri, asynchronously, designated as obsolete, supported in full-featured and mobile chrome, safari, opera, android browser. <br>  <a href="http://caniuse.com/filesystem">File Writer</a> is only chrome. <br><br>  You can also try using <a href="http://caniuse.com/blobbuilder">blobs</a> and <a href="http://caniuse.com/bloburls">blobs</a> to reduce the space occupied by tiles, but this can only work together with <a href="http://caniuse.com/indexeddb">Indexed DB</a> .  I will leave this venture for now. <br><br>  So, if you combine <a href="http://caniuse.com/offline-apps">Application Cache</a> , <a href="http://caniuse.com/indexeddb">Indexed DB</a> and <a href="http://caniuse.com/sql-storage">Web SQL</a> , then you can solve the problem of storing tiles sufficient for normal use in modern browsers, including mobile ones. <br><br><h4>  Theory </h4><br>  In theory, we need: <br><ol><li>  take an API; </li><li>  add all static in application cache; </li><li>  redefine the tile layer so that it loads data from our asynchronous storages; </li><li>  add logic for loading tiles into repositories. </li></ol><br><h4>  Storage </h4><br>  To begin with we will organize key-value storage with basic operations add, delete, get for Indexed DB and Web SQL.  There is one magic construct <code>emr.fire('storageLoaded', storage);</code>  , which will be called after the storage is initialized and ready to use, so that the card does not fall when accessing the storage. <br><br><div class="spoiler">  <b class="spoiler_title">Implementing storage using Indexed DB</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getIndexedDBStorage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> indexedDB = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.indexedDB || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozIndexedDB || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitIndexedDB || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.msIndexedDB; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> IndexedDBImpl = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = indexedDB.open(<span class="hljs-string"><span class="hljs-string">'TileStorage'</span></span>); request.onsuccess = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ db = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result; emr.fire(<span class="hljs-string"><span class="hljs-string">'storageLoaded'</span></span>, self); }; request.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); }; request.onupgradeneeded = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result.createObjectStore(<span class="hljs-string"><span class="hljs-string">'tile'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">keyPath</span></span>: <span class="hljs-string"><span class="hljs-string">'key'</span></span>}); store.createIndex(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.add = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = db.transaction([<span class="hljs-string"><span class="hljs-string">'tile'</span></span>], <span class="hljs-string"><span class="hljs-string">'readwrite'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectStore = transaction.objectStore(<span class="hljs-string"><span class="hljs-string">'tile'</span></span>); objectStore.put({<span class="hljs-attr"><span class="hljs-attr">key</span></span>: key, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: value}); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.delete = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = db.transaction([<span class="hljs-string"><span class="hljs-string">'tile'</span></span>], <span class="hljs-string"><span class="hljs-string">'readwrite'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectStore = transaction.objectStore(<span class="hljs-string"><span class="hljs-string">'tile'</span></span>); objectStore.delete(key); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, successCallback, errorCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = db.transaction([<span class="hljs-string"><span class="hljs-string">'tile'</span></span>], <span class="hljs-string"><span class="hljs-string">'readonly'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectStore = transaction.objectStore(<span class="hljs-string"><span class="hljs-string">'tile'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = objectStore.get(key); result.onsuccess = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ successCallback(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result.value : <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>); }; result.onerror = errorCallback; }; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> indexedDB ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDBImpl() : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Implementing storage using Web SQL</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getWebSqlStorage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> openDatabase = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.openDatabase; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> WebSqlImpl = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = openDatabase(<span class="hljs-string"><span class="hljs-string">'TileStorage'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'Tile Storage'</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); db.transaction(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tx</span></span></span><span class="hljs-function">) </span></span>{ tx.executeSql(<span class="hljs-string"><span class="hljs-string">'CREATE TABLE IF NOT EXISTS tile (key TEXT PRIMARY KEY, value TEXT)'</span></span>, [], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ emr.fire(<span class="hljs-string"><span class="hljs-string">'storageLoaded'</span></span>, self); }); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.add = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ db.transaction(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tx</span></span></span><span class="hljs-function">) </span></span>{ tx.executeSql(<span class="hljs-string"><span class="hljs-string">'INSERT INTO tile (key, value) VALUES (?, ?)'</span></span>, [key, value]); }); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.delete = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">) </span></span>{ db.transaction(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tx</span></span></span><span class="hljs-function">) </span></span>{ tx.executeSql(<span class="hljs-string"><span class="hljs-string">'DELETE FROM tile WHERE key = ?'</span></span>, [key]); }); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.get = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, successCallback, errorCallback</span></span></span><span class="hljs-function">) </span></span>{ db.transaction(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tx</span></span></span><span class="hljs-function">) </span></span>{ tx.executeSql(<span class="hljs-string"><span class="hljs-string">'SELECT value FROM tile WHERE key = ?'</span></span>, [key], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tx, result</span></span></span><span class="hljs-function">) </span></span>{ successCallback(result.rows.length ? result.rows.item(<span class="hljs-number"><span class="hljs-number">0</span></span>).value : <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>); }, errorCallback); }); }; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> openDatabase ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSqlImpl() : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Creating a repository</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storage = getIndexedDBStorage() || getWebSqlStorage() || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!storage) { emr.fire(<span class="hljs-string"><span class="hljs-string">'storageLoaded'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre><br></div></div><br>  I propose to consider this implementation very schematic, I think there is something to think about, for example, in order not to block the initialization of the map while the storage is initialized;  remember which tiles are in the repository without directly accessing the API;  try to combine multiple save operations into a single transaction to reduce the number of writes per disk;  try using blobs wherever they are supported.  Perhaps the implementation of Indexed DB in old browsers will fall, <code>onupgradeneeded</code> event may not be implemented in them. <br><br><h4>  IMG to data URI &amp; CORS </h4><br>  In order to store the tiles, we need to convert them to the data URI, that is, the base64 representation.  To do this, use the canvas and its methods <code>toDataURL</code> or <code>getImageData</code> : <br><br><pre> <code class="javascript hljs">_imageToDataUri: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">image</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.createElement(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); canvas.width = image.width; canvas.height = image.height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); context.drawImage(image, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">'image/png'</span></span>); }</code> </pre><br>  Since the html img element can take as a picture any available resource, including on authorized services and the local file system, the ability to send this content to a third party is a security risk, therefore the pictures do not allow <code>Access-Control-Allow-Origing</code> for Your domain will not be saved.  Fortunately, mapnik tiles or tile.openstreetmap.org have an <code>Access-Control-Allow-Origing: *</code> , but for everything to work, you need to set the flag of the <code>img.crossOrigin</code> element to <code>Anonymous</code> . <br><br>  The operation of CORS in this implementation in all mobile browsers is not guaranteed, so the easiest way is to configure a proxy for your site on your domain or turn off CORS checking for example for Phoengap adherents.  Personally, my code did not take off in the default Androids browser (androin 4.0.4 sony xperia active), and in the opera some tiles were kept in a strange way (compare <a href="">what sometimes happens</a> and <a href="">what should really be</a> , but it looks like an opera bug ). <br><br>  Here you can try using <a href="http://caniuse.com/webworkers"><code>WebWorkers</code></a> + <code>AJAX</code> instead of <code>canvas</code> . <br><br><h4>  Leaflet </h4><br>  So we need the popular open source JS API, one such candidate is <a href="http://leafletjs.com/">Leaflet</a> . <br><br>  After a bit of looking at the <a href="">sources,</a> you can find a tile layer method that is responsible for directly specifying <code>src</code> for tiles: <br><br><pre> <code class="javascript hljs">_loadTile: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tile, tilePoint</span></span></span><span class="hljs-function">) </span></span>{ tile._layer = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; tile.onload = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tileOnLoad; tile.onerror = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tileOnError; tile.src = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTileUrl(tilePoint); }</code> </pre><br>  That is, if you override this class and this method directly to load data into <code>src</code> from storage, then we will do what we need.  We also implement adding data to the repository, if they were downloaded from the network and we get full caching. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation for Leaflet</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageTileLayer = L.TileLayer.extend({ <span class="hljs-attr"><span class="hljs-attr">_imageToDataUri</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">image</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.createElement(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); canvas.width = image.width; canvas.height = image.height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); context.drawImage(image, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">'image/png'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">_tileOnLoadWithCache</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storage = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._layer.options.storage; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (storage) { storage.add(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storageKey, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._layer._imageToDataUri(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } L.TileLayer.prototype._tileOnLoad.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">_setUpTile</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tile, key, value, cache</span></span></span><span class="hljs-function">) </span></span>{ tile._layer = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache) { tile._storageKey = key; tile.onload = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tileOnLoadWithCache; tile.crossOrigin = <span class="hljs-string"><span class="hljs-string">'Anonymous'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tile.onload = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tileOnLoad; } tile.onerror = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._tileOnError; tile.src = value; }, <span class="hljs-attr"><span class="hljs-attr">_loadTile</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tile, tilePoint</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._adjustTilePoint(tilePoint); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = tilePoint.z + <span class="hljs-string"><span class="hljs-string">','</span></span> + tilePoint.y + <span class="hljs-string"><span class="hljs-string">','</span></span> + tilePoint.x; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.options.storage) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.options.storage.get(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value) { self._setUpTile(tile, key, value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self._setUpTile(tile, key, self.getTileUrl(tilePoint), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self._setUpTile(tile, key, self.getTileUrl(tilePoint), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self._setUpTile(tile, key, self.getTileUrl(tilePoint), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } } });</code> </pre><br></div></div><br>  The card itself in this case will be initialized as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map = L.map(<span class="hljs-string"><span class="hljs-string">'map'</span></span>).setView([<span class="hljs-number"><span class="hljs-number">53.902254</span></span>, <span class="hljs-number"><span class="hljs-number">27.561850</span></span>], <span class="hljs-number"><span class="hljs-number">13</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageTileLayer(<span class="hljs-string"><span class="hljs-string">'http://{s}.tile.osm.org/{z}/{x}/{y}.png'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">storage</span></span>: storage}).addTo(map);</code> </pre><br>  We will also add our resources to Application Cache so that the map can work fully without a network with cached tiles: <br><br><div class="spoiler">  <b class="spoiler_title">Application Cache manifest for Leaflet</b> <div class="spoiler_text"><pre> <code class="hljs mel">CACHE MANIFEST NETWORK: * CACHE: index.html style.css <span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.js storage.js map.js run.js leaflet.css leaflet.js images/layers.png images/<span class="hljs-keyword"><span class="hljs-keyword">marker</span></span>-icon.png images/<span class="hljs-keyword"><span class="hljs-keyword">marker</span></span>-icon@2x.png images/<span class="hljs-keyword"><span class="hljs-keyword">marker</span></span>-shadow.png</code> </pre><br></div></div><br>  <a href="http://tbicr.github.com/OfflineMap/leaflet/index.html">An example</a> and <a href="https://github.com/tbicr/OfflineMap/tree/master/leaflet_idb_sql_site">its githaba code</a> . <br><br><h4>  Mapbox (modesmaps) </h4><br>  Another candidate open map JS API is the <a href="">mapbox</a> based on <a href="http://modestmaps.com/">modesmaps</a> . <br><br>  <a href="">Having</a> looked at the <a href="">sources of the mapbox,</a> we will not find anything interesting for us, so let's move on to the <a href="https://github.com/modestmaps/modestmaps-js">sources of modestmaps</a> .  Let's start with <a href=""><code>TemplatedLayer</code></a> , which is a regular map layer with a template provider, the code that we need will be in the layer class: <br><br><pre> <code class="javascript hljs">MM.TemplatedLayer = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template, subdomains, name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MM.Layer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MM.Template(template, subdomains), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, name); };</code> </pre><br>  Having found the <a href="">use of the template provider in the map layer,</a> you can see that our provider can return either the tile URL or the finished DOM element, with the DOM element being positioned immediately, and the <code>requestManager</code> URL being sent to the <code>requestManager</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestManager.hasRequest(tile_key)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tileToRequest = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.provider.getTile(tile_coord); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> tileToRequest == <span class="hljs-string"><span class="hljs-string">'string'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addTileImage(tile_key, tile_coord, tileToRequest); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tileToRequest) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addTileElement(tile_key, tile_coord, tileToRequest); } }</code> </pre><br><pre> <code class="javascript hljs">addTileImage: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, coord, url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestManager.requestTile(key, coord, url); }</code> </pre><br><pre> <code class="javascript hljs">addTileElement: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, coordinate, element</span></span></span><span class="hljs-function">) </span></span>{ element.id = key; element.coord = coordinate.copy(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.positionTile(element); }</code> </pre><br>  The <code>requestManager</code> itself is initialized in the map layer's constructor.  Creating an <code>img</code> element <code>img</code> and setting its <code>src</code> occurs in the <a href=""><code>processQueue</code></a> method, which also jerks from the map layer: <br><br><pre> <code class="javascript hljs">processQueue: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sortFunc</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sortFunc &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.length &gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.sort(sortFunc); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openRequestCount &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxOpenRequests &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.pop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openRequestCount++; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'img'</span></span>); img.id = request.id; img.style.position = <span class="hljs-string"><span class="hljs-string">'absolute'</span></span>; img.coord = request.coord; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loadingBay.appendChild(img); img.onload = img.onerror = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getLoadComplete(); img.src = request.url; request = request.id = request.coord = request.url = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre><br>  That is, if we override this method, we will also get the desired result. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation for mapbox (modestmaps)</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageRequestManager = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">storage</span></span></span><span class="hljs-function">) </span></span>{ MM.RequestManager.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, []); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storage = storage; }; StorageRequestManager.prototype._imageToDataUri = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">image</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.createElement(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); canvas.width = image.width; canvas.height = image.height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); context.drawImage(image, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">'image/png'</span></span>); }; StorageRequestManager.prototype._createTileImage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, coord, value, cache</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.createElement(<span class="hljs-string"><span class="hljs-string">'img'</span></span>); img.id = id; img.style.position = <span class="hljs-string"><span class="hljs-string">'absolute'</span></span>; img.coord = coord; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loadingBay.appendChild(img); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache) { img.onload = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getLoadCompleteWithCache(); img.crossOrigin = <span class="hljs-string"><span class="hljs-string">'Anonymous'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { img.onload = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getLoadComplete(); } img.onerror = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getLoadComplete(); img.src = value; }; StorageRequestManager.prototype._loadTile = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, coord, url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storage) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storage.get(id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value) { self._createTileImage(id, coord, value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self._createTileImage(id, coord, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self._createTileImage(id, coord, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self._createTileImage(id, coord, url, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }; StorageRequestManager.prototype.processQueue = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sortFunc</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sortFunc &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.length &gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.sort(sortFunc); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openRequestCount &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxOpenRequests &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestQueue.pop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openRequestCount++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadTile(request.id, request.coord, request.url); request = request.id = request.coord = request.url = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }; StorageRequestManager.prototype.getLoadCompleteWithCache = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadComplete) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> theManager = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadComplete = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e = e || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.event; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = e.srcElement || e.target; img.onload = img.onerror = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (theManager._storage) { theManager._storage.add(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id, theManager._imageToDataUri(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } theManager.loadingBay.removeChild(img); theManager.openRequestCount--; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> theManager.requestsById[img.id]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.type === <span class="hljs-string"><span class="hljs-string">'load'</span></span> &amp;&amp; (img.complete || (img.readyState &amp;&amp; img.readyState === <span class="hljs-string"><span class="hljs-string">'complete'</span></span>))) { theManager.dispatchCallback(<span class="hljs-string"><span class="hljs-string">'requestcomplete'</span></span>, img); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { theManager.dispatchCallback(<span class="hljs-string"><span class="hljs-string">'requesterror'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">element</span></span>: img, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: (<span class="hljs-string"><span class="hljs-string">''</span></span> + img.src) }); img.src = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } setTimeout(theManager.getProcessQueue(), <span class="hljs-number"><span class="hljs-number">0</span></span>); }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadComplete; }; MM.extend(StorageRequestManager, MM.RequestManager); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageLayer = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">provider, parent, name, storage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parent = parent || <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parent.style.cssText = <span class="hljs-string"><span class="hljs-string">'position: absolute; top: 0px; left: 0px;'</span></span> + <span class="hljs-string"><span class="hljs-string">'width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.levels = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageRequestManager(storage); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestManager.addCallback(<span class="hljs-string"><span class="hljs-string">'requestcomplete'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTileComplete()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requestManager.addCallback(<span class="hljs-string"><span class="hljs-string">'requesterror'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTileError()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (provider) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setProvider(provider); } }; MM.extend(StorageLayer, MM.Layer); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageTemplatedLayer = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template, subdomains, name, storage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageLayer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MM.Template(template, subdomains), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, name, storage); };</code> </pre><br></div></div><br>  The card itself in this case will be initialized as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map = mapbox.map(<span class="hljs-string"><span class="hljs-string">'map'</span></span>); map.addLayer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageTemplatedLayer(<span class="hljs-string"><span class="hljs-string">'http://{S}.tile.osm.org/{Z}/{X}/{Y}.png'</span></span>, [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>], <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, storage)); map.ui.zoomer.add(); map.ui.zoombox.add(); map.centerzoom({<span class="hljs-attr"><span class="hljs-attr">lat</span></span>: <span class="hljs-number"><span class="hljs-number">53.902254</span></span>, <span class="hljs-attr"><span class="hljs-attr">lon</span></span>: <span class="hljs-number"><span class="hljs-number">27.561850</span></span>}, <span class="hljs-number"><span class="hljs-number">13</span></span>);</code> </pre><br>  We will also add our resources to Application Cache so that the map can work fully without a network with cached tiles: <br><br><div class="spoiler">  <b class="spoiler_title">Application Cache manifest for Mapbox (modestmaps)</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">CACHE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MANIFEST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NETWORK</span></span>: * <span class="hljs-selector-tag"><span class="hljs-selector-tag">CACHE</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.html</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">style</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.css</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">event</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">storage</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">map</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">run</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mapbox</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.css</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mapbox</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">map-controls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.png</span></span></code> </pre><br></div></div><br>  <a href="http://tbicr.github.com/OfflineMap/mapbox/index.html">An example</a> and <a href="https://github.com/tbicr/OfflineMap/tree/master/mapbox_idb_sql_site">its githaba code</a> . <br><br><h4>  Openlayers </h4><br>  And the last candidate of the open JS API maps is <a href="http://openlayers.org/">OpenLayers</a> . <br><br>  I had to spend some time to figure out how to run the minimum view, in the end my assembly file acquired the following form: <br><br><pre> <code class="hljs pgsql">[first] [last] [<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>] OpenLayers/Map.js OpenLayers/Layer/OSM.js OpenLayers/Control/Zoom.js OpenLayers/Control/Navigation.js OpenLayers/Control/TouchNavigation.js [<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span>]</code> </pre><br>  I will use <a href=""><code>OpenLayers.Layer.OSM</code></a> , so I‚Äôll start the search from it: <br><br><pre> <code class="javascript hljs">url: [ <span class="hljs-string"><span class="hljs-string">'http://a.tile.openstreetmap.org/${z}/${x}/${y}.png'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://b.tile.openstreetmap.org/${z}/${x}/${y}.png'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://c.tile.openstreetmap.org/${z}/${x}/${y}.png'</span></span> ]</code> </pre><br>  <code>OpenLayers.Layer.OSM</code> inherited from <code>OpenLayers.Layer.XYZ</code> with redefined URLs.  The <a href=""><code>getURL</code></a> method is interesting here: <br><br><pre> <code class="javascript hljs">getURL: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bounds</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xyz = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getXYZ(bounds); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OpenLayers.Util.isArray(url)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-string"><span class="hljs-string">''</span></span> + xyz.x + xyz.y + xyz.z; url = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectUrl(s, url); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> OpenLayers.String.format(url, xyz); }</code> </pre><br>  Also interesting is the <a href=""><code>getXYZ</code></a> method, which can be used to create a key: <br><br><pre> <code class="javascript hljs">getXYZ: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bounds</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getServerResolution(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round((bounds.left - <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxExtent.left) / (res * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileSize.w)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round((<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxExtent.top - bounds.top) / (res * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileSize.h)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> z = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getServerZoom(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wrapDateLine) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> limit = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.pow(<span class="hljs-number"><span class="hljs-number">2</span></span>, z); x = ((x % limit) + limit) % limit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'x'</span></span>: x, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: y, <span class="hljs-string"><span class="hljs-string">'z'</span></span>: z}; }</code> </pre><br>  <code>OpenLayers.Layer.XYZ</code> itself is inherited from <code>OpenLayers.Layer.Grid</code> , which has the <a href=""><code>addTile</code></a> method and which internally creates tiles using <code>tileClass</code> , which is <a href=""><code>OpenLayers.Tile.Image</code></a> : <br><br><pre> <code class="javascript hljs">addTile: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bounds, position</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileClass( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, position, bounds, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileSize, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileOptions ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.triggerEvent(<span class="hljs-string"><span class="hljs-string">"addtile"</span></span>, {<span class="hljs-attr"><span class="hljs-attr">tile</span></span>: tile}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tile; }</code> </pre><br>  In <code>OpenLayers.Tile.Image</code> <code>src</code> is set in the <a href=""><code>setImgSrc</code></a> method: <br><br><pre> <code class="javascript hljs">setImgSrc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imgDiv; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (url) { img.style.visibility = <span class="hljs-string"><span class="hljs-string">'hidden'</span></span>; img.style.opacity = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.crossOriginKeyword) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (url.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) !== <span class="hljs-string"><span class="hljs-string">'data:'</span></span>) { img.setAttribute(<span class="hljs-string"><span class="hljs-string">"crossorigin"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.crossOriginKeyword); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { img.removeAttribute(<span class="hljs-string"><span class="hljs-string">"crossorigin"</span></span>); } } img.src = url; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stopLoading(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imgDiv = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (img.parentNode) { img.parentNode.removeChild(img); } } }</code> </pre><br>  But it does not specify <code>onload</code> and <code>onerror</code> .  The method itself is twitching from <a href=""><code>initImage</code></a> , where these handlers are hung: <br><br><pre> <code class="javascript hljs">initImage: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.triggerEvent(<span class="hljs-string"><span class="hljs-string">'beforeload'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.div.appendChild(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTile()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadEvent); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getImage(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url &amp;&amp; img.getAttribute(<span class="hljs-string"><span class="hljs-string">"src"</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadTimeout = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setTimeout( OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageLoad, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stopLoading(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.crossOriginKeyword) { img.removeAttribute(<span class="hljs-string"><span class="hljs-string">"crossorigin"</span></span>); } OpenLayers.Event.observe(img, <span class="hljs-string"><span class="hljs-string">"load"</span></span>, OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageLoad, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); OpenLayers.Event.observe(img, <span class="hljs-string"><span class="hljs-string">"error"</span></span>, OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageError, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageReloadAttempts = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setImgSrc(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url); } }</code> </pre><br>  You can see that the layer's <code>getURL</code> class method, as well as <code>initImage</code> , is jerked from the <a href=""><code>renderTile</code></a> : <br><br><pre> <code class="javascript hljs">renderTile: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.async) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.asyncRequestId = (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.asyncRequestId || <span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.getURLasync(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bounds, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.asyncRequestId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url = url; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.initImage(); } }, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.getURL(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bounds); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.initImage(); } }</code> </pre><br>  So, if we override this class, we also get the desired result. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation for OpenLayers</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageImageTile = OpenLayers.Class(OpenLayers.Tile.Image, { <span class="hljs-attr"><span class="hljs-attr">_imageToDataUri</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">image</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.createElement(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); canvas.width = image.width; canvas.height = image.height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); context.drawImage(image, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">'image/png'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">onImageLoadWithCache</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage.add(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storageKey, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._imageToDataUri(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imgDiv)); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageLoad.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">renderTile</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xyz = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.getXYZ(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bounds); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = xyz.z + <span class="hljs-string"><span class="hljs-string">','</span></span> + xyz.y + <span class="hljs-string"><span class="hljs-string">','</span></span> + xyz.x; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.getURL(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bounds); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage.get(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value) { self.initImage(key, value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self.initImage(key, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self.initImage(key, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self.initImage(key, url, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }, <span class="hljs-attr"><span class="hljs-attr">initImage</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, url, cache</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.triggerEvent(<span class="hljs-string"><span class="hljs-string">'beforeload'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.layer.div.appendChild(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTile()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.triggerEvent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._loadEvent); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getImage(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stopLoading(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache) { OpenLayers.Event.observe(img, <span class="hljs-string"><span class="hljs-string">'load'</span></span>, OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageLoadWithCache, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._storageKey = key; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { OpenLayers.Event.observe(img, <span class="hljs-string"><span class="hljs-string">'load'</span></span>, OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageLoad, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); } OpenLayers.Event.observe(img, <span class="hljs-string"><span class="hljs-string">'error'</span></span>, OpenLayers.Function.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onImageError, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageReloadAttempts = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setImgSrc(url); } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageOSMLayer = OpenLayers.Class(OpenLayers.Layer.OSM, { <span class="hljs-attr"><span class="hljs-attr">async</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">tileClass</span></span>: StorageImageTile, <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, url, options</span></span></span><span class="hljs-function">) </span></span>{ OpenLayers.Layer.OSM.prototype.initialize.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileOptions = OpenLayers.Util.extend({ <span class="hljs-attr"><span class="hljs-attr">storage</span></span>: options.storage }, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.options &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.options.tileOptions); }, <span class="hljs-attr"><span class="hljs-attr">clone</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageOSMLayer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getOptions()); } obj = OpenLayers.Layer.Grid.prototype.clone.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, [obj]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj; } });</code> </pre><br></div></div><br>  The card itself in this case will be initialized as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.Map(<span class="hljs-string"><span class="hljs-string">'map'</span></span>); map.addLayer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageOSMLayer(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>, {<span class="hljs-attr"><span class="hljs-attr">storage</span></span>: storage})); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fromProjection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.Projection(<span class="hljs-string"><span class="hljs-string">'EPSG:4326'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> toProjection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.Projection(<span class="hljs-string"><span class="hljs-string">'EPSG:900913'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> center = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.LonLat(<span class="hljs-number"><span class="hljs-number">27.561850</span></span>, <span class="hljs-number"><span class="hljs-number">53.902254</span></span>).transform(fromProjection, toProjection); map.setCenter(center, <span class="hljs-number"><span class="hljs-number">13</span></span>);</code> </pre><br>  We will also add our resources to Application Cache so that the map can work fully without a network with cached tiles: <br><br><div class="spoiler">  <b class="spoiler_title">Application Cache manifest for OpenLayers</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CACHE</span></span> MANIFEST NETWORK: * <span class="hljs-built_in"><span class="hljs-built_in">CACHE</span></span>: index.html style.css event.js storage.js map.js run.js theme/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/style.css OpenLayers.js</code> </pre><br></div></div><br>  <a href="http://tbicr.github.com/OfflineMap/openlayers/index.html">An example</a> and <a href="https://github.com/tbicr/OfflineMap/tree/master/openlayers_idb_sql_site">its githaba code</a> . <br><br>  I also found a ready-made implementation of the <a href=""><code>OpenLayers.Control.CacheWrite</code></a> cache, but only using <code>localStorage</code> , which is not very interesting. <br><br><h4>  Conclusion </h4><br>  Actually, I got what I wanted.  The examples work smartly in chrome or if you have an SSD, there is a tormaz in the fox and the opera while saving to disk, the donkey is not at hand.  Brakes also appear in mobile browsers, and even when reading, which upset me a bit, this task is more relevant for mobile devices. <br><br>  The standard size of the <code>IndexedDB</code> or <code>WebSQL</code> is enough to cache a city or more, which makes the application approach more interesting than in the version with <code>localStorage</code> . <br><br>  In my examples, you can work with asynchronous storages, but for more comfort, you need to work on their implementation to improve performance compared to what is now. </div><p>Source: <a href="https://habr.com/ru/post/170129/">https://habr.com/ru/post/170129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170111/index.html">Video review laptop Lenovo IdeaPad Z500</a></li>
<li><a href="../170119/index.html">Microsoft has changed the supplier of the proofing module for the Office 2013 (in vain)</a></li>
<li><a href="../170121/index.html">Your social afterlife</a></li>
<li><a href="../170125/index.html">What are the design patterns for?</a></li>
<li><a href="../170127/index.html">In C ++, the unit of encapsulation is the class.</a></li>
<li><a href="../170135/index.html">Icinga in action. Monitoring of the Large Hadron Collider at CERN, Switzerland / France</a></li>
<li><a href="../170137/index.html">Instant PlanningPoker on socket.io</a></li>
<li><a href="../170139/index.html">Quake 3 Source Code Overview: Architecture (Part 1)</a></li>
<li><a href="../170141/index.html">Using Google Map in a JavaFX application</a></li>
<li><a href="../170143/index.html">How Google changed Android with your brain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>