<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Resizing images on the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. I am a developer with over 10 years of experience. In order to assess the quality of the source code of the sites, not without a share of se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Resizing images on the site</h1><div class="post__text post__text-html js-mediator-article">  Good day.  I am a developer with over 10 years of experience.  In order to assess the quality of the source code of the sites, not without a share of self-irony, I created a small checklist.  Today I will talk about an important point for me - images on sites.  I deliberately omitted a specific technology, because this problem was encountered and is found everywhere, I would be very grateful if in the comments you reveal your approaches using your technology stack, in the end we are all very similar. <br><br><img src="https://habrastorage.org/webt/am/o0/mw/amo0mwrqyygawdaciwq1jemf6lk.png"><br><a name="habracut"></a><br>  Experimentally, I found that the way to work with the image on the site is a litmus test of quality.  See how a person works with images in five sizes and you can make a conclusion about the whole project.  The reason is quite clear, I have not met a book or article that describes the logic of storing, updating and working with an image, if someone specifies it in the comments - I would be grateful.  Everyone invented their own bike services, which could save on a specific directory structure or in the database.  As time went on, the sites on the support evolved, somewhere the image sizes changed, somewhere new functionality was added, which required a new size of previously loaded images.  Each step added a new round of the already debugged procedure: we walk in all the images - the originals, change the size and save in the necessary parameters.  Long, expensive. <br><br>  Manual control will sooner or later lead to failure, will require extra money for testing in a test environment.  I started to search for a similar problem with others, because it has long been known that if you have some kind of problem, then you are not the first to encounter it.  Pretty quickly, I went to the cloud services for changing images, caching and placement.  I was delighted with the simplicity of the solution, using the link to the original image and the control parameters in it, you can get cropped, compressed, inverted, shifted, transparent, images with printed text and effects, and much, much more.  One of these services, which seemed to me the most simple and convenient, I decided to try.  For this, I made a list of the functionality I needed and decided to remove the time characteristics, because it‚Äôs not a secret to anyone that the speed of the site‚Äôs work is a very important parameter from the user's and search engines point of view. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sample list by memory: <br><br><ul><li>  Change width, proportional change in height. </li><li>  Change in height, proportional change in width. </li><li>  Crop the image at the specified boundaries. </li><li>  Fit the image to the boundaries of the rectangle. </li><li>  Caching and storage of results on the service side, while its regular update depending on the ETag and MaxAge. </li><li>  The time of receiving the modified image by a new user from Russia. </li><li>  Https availability. </li><li>  Reasonable price of the service and transparency of its payment. </li></ul><br>  I walked through the functional requirements, each of them was reflected with an example of use and fully suited, there was a brief instruction manual and a small control panel for monitoring statistics and decreasing balance. <br><br>  At the same time, I watched the speed and, to be honest, I did not expect good results in speed, as there was no Russia on the map of the location and processing servers.  But I had noticed before that the speed to Europe and the USA is much better than to the neighboring city, so I decided to check.  The results were acceptable, about 35-60 ms per image when changing the image width from 3000 to 500 and 30-150KB result. <br><br>  Further caching was based on MaxAge and Last-modified, the ETag was missing and not transmitted from the source server of the storage in any way, but I could not think of a situation where it may be needed if there is Last-modified.  MaxAge, when properly configured, quietly flowed to the service.  I wondered how the service handles changing the original image on the server storage.  There were three algorithms in my head, according to the first, he had to return to the original storage before returning the image and look at Last-modified from him, the second had to compare the information about what was stored in the service and at the repository in the background at some time, for example, obtained through MaxAge and the third, when the next update was assigned through MaxAge, but occurred only if the client makes a request.  I decided to install a simple experiment, changing the original and requesting an image from the service.  Then I found that the image has not changed, so the service does not access the repository until a certain point.  Moreover, if you change the image again, the original image will be taken from the service cache, and not from the storage.  Further, changing MaxAge, I achieved updating the original image in the service cache. <br><br>  On my list, the price was in last place in order, but not in priority.  I was unpleasantly upset by the price (I quote prices today) from $ 500 for a plan with SLA, while the plan for the number of accesses to the original image was also poorly arranged, each 1000 images were paid for separately.  At the same time it was not clear how access to the original image is considered.  Does access re-request a previously modified image from the service cache, without using the browser cache, i.e.  new user, but before someone had already called and changed.  This question arose because in one of the projects we had more than 150 new original images every day, which were viewed by at least 5 thousand people daily.  Requests from the cache accounted for only ~ 50% of requests.  The answer was simple, after the image service was loaded into the cache, all operations with it were unlimited and the restriction was only on consumed traffic.  Having estimated the number of images came out about 150 dollars a month without traffic. <br><br><img src="https://habrastorage.org/webt/ek/8w/vb/ek8wvbak9dj1bbrbufm3ozf4jr0.png"><br><br>  Everything would be fine, but 2014 came and the dollar began to confidently overcome the borders of the rational, the good, the eternal.  Bablo began to defeat evil and it was decided to create their own service for changing images on the fly.  So the internal project appeared, and recently (about a year ago) I and the team published a beta version for public testing.  The service is built using Microsoft .NET technologies, and NoSQL Redis for caching original images.  We work with different countries, in total about 15 sites.  One of our clients, a site from Vietnam of popular Vietnamese music, as far as we can tell, from where he learned about our service is still a mystery.  The attendance of each site from 50 to 30 000 people per day.  Our target audience is relatively small (up to 50,000 - 100,000 people per day. Original image size is up to 10MB each, limited within the system) information sites, online stores, product catalogs, and just websites with responsive designs and a desire to reduce traffic or fill gaps with image compression in old IE. <br><br><h3>  Architecture </h3><br>  The first version of the project was straightforward processing, no authorization and complete freedom of action for users of the service.  I will say right away - this is a bad idea, in all respects except the convenience of the user, until the service falls under the load of unscrupulous users or directly violating the law.  This is best shown on the diagram and identify the main components. <br><br><img src="https://habrastorage.org/webt/ft/hw/2q/fthw2qvlwrxn8-scgtmgahyrsb8.png"><br><br>  All query statistics, all caching parameters we stored on Redis.  The originals and processed files were also stored there, because they wanted to maximize the speed of content delivery to the user, minimizing the participation of the disks.  Having launched our prototype, we realized that it is quite viable and covers the requirements of one of the sites with interest (5,000-10,000 users per day).  Placed on their own hardware, started to use.  The problems started when we wanted to scale.  Not because we got some sort of solution limit, but because other customers began to show interest in us and we began to fear that we could not cope with the growing load. <br><br>  Thus was born the second version of the service.  A version built on a queue on top of Redis and microservices that listen to the events of this queue.  The facade was left behind by IIS, but it became very thin and began to proxy requests to the necessary services.  There were restrictions both on the number of files and on their size, binding to the domain name in order to avoid unscrupulous users and indicate the owner to the appropriate structures, in case of their interest.  DNS appeared with Round Robin and the ability to issue addresses relative to the intended client address (CDN). <br><br><img src="https://habrastorage.org/webt/lz/c8/ug/lzc8ugbsvs_lkdjxqyfn9dly2zs.png"><br><br>  The scheme allowed us to spread processing services, duplicate them in terms of fault tolerance and performance, independently send the endpoints to the service without stopping the entire system.  Moreover, services are no longer geographically linked. <br><br>  We continue to develop the second version of the service.  We really want to get feedback from users.  We have a list of possible developments, with new features: <br><br><ul><li>  Drawing text on the image - already implemented </li><li>  Setting quality in the context of a domain, rules, and / or operation (this is now a hard OptimalCompression value) </li><li>  Adding a system selection - a plan for caching original images </li><li> Adding sources other than the site (for example, Amazon or the new Mail with its cold storage) </li><li>  Placement of additional services outside the central region </li></ul><br>  It is necessary - it is not necessary, it is important - it does not matter, therefore, during registration, a Early Adopter plan is issued, with 500 MB storage units, up to 5 domains, 2000 original images.  It will remain with you only if you do not delete the account (this can be done on your own from the control panel at any time).  All offers can and should be sent to support contacts or in the comments here.  Keep in mind that the Early Adopter plan is flexible and if you need large scales, just write in support.  High probability that you will be helped.  Also, if it is interesting how some of the parts are arranged inside - write.  I will try to answer all the questions, just give some code examples somewhere. <br><br><h3>  Thank! </h3><br>  Contacts.  I tried to approach the article objectively, not to violate the rules of topics and advertising, to share with you my thoughts about the simplicity of the approach.  Thank you more for your time and attention.  Contacts will inform in a personal message or comments, if there is interest. </div><p>Source: <a href="https://habr.com/ru/post/352012/">https://habr.com/ru/post/352012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352002/index.html">A manager from Amazon about layoffs in the US and programmer performance evaluation</a></li>
<li><a href="../352004/index.html">What is a digital handwritten signature (CRP)</a></li>
<li><a href="../352006/index.html">Key Application Metrics - Mobile Landmarks 2018 Report</a></li>
<li><a href="../352008/index.html">Top 10 errors in C ++ projects for 2017</a></li>
<li><a href="../352010/index.html">Overview of the second day of Data Science Weekend 2018. Data Engineering, ETL, search services and more</a></li>
<li><a href="../352014/index.html">How to crack a picture and (not) get BTC</a></li>
<li><a href="../352016/index.html">Transparency and trust</a></li>
<li><a href="../352020/index.html">Work with notifications about events of IOT objects and GPS trackers</a></li>
<li><a href="../352022/index.html">Hacking Team is back in business: ESET has discovered new spyware samples of the company</a></li>
<li><a href="../352024/index.html">3CX v15.5 Update 4 Beta - speech recognition through Microsoft Speech and updated Call Flow Designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>