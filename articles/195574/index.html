<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go: multithreading and parallelism</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I love Go, I love to praise him (it happens even, I instill a little), I love articles about him. I read the article ‚Äú Go: Two years in production, ‚Äù ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go: multithreading and parallelism</h1><div class="post__text post__text-html js-mediator-article">  I love Go, I love to praise him (it happens even, I instill a little), I love articles about him.  I read the article ‚Äú <a href="http://habrahabr.ru/post/195464/">Go: Two years in production,</a> ‚Äù then comments.  It became clear, on Habr√© - optimists!  They want to believe in the best. <br><a name="habracut"></a><br>  By default, Go runs on the same thread using its scheduler and asynchronous calls.  (The programmer has a feeling of multithreading and parallelism.) In this case, the channels work very quickly.  But if you specify Go to use 2 or more streams, then Go starts using locks and the performance of the channels may fall.  I do not want to limit myself to the use of channels.  Moreover, most third-party libraries use channels at every opportunity.  Therefore, it is often effective to run Go with one thread, as is done by default. <br><br>  channel01.go <br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { numcpu := runtime.NumCPU() fmt.Println(<span class="hljs-string"><span class="hljs-string">"NumCPU"</span></span>, numcpu) <span class="hljs-comment"><span class="hljs-comment">//runtime.GOMAXPROCS(numcpu) runtime.GOMAXPROCS(1) ch1 := make(chan int) ch2 := make(chan float64) go func() { for i := 0; i &lt; 1000000; i++ { ch1 &lt;- i } ch1 &lt;- -1 ch2 &lt;- 0.0 }() go func() { total := 0.0 for { t1 := time.Now().UnixNano() for i := 0; i &lt; 100000; i++ { m := &lt;-ch1 if m == -1 { ch2 &lt;- total } } t2 := time.Now().UnixNano() dt := float64(t2 - t1) / 1000000.0 total += dt fmt.Println(dt) } }() fmt.Println("Total:", &lt;-ch2, &lt;-ch2) }</span></span></code> </pre> <br><br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel01.go NumCPU 4 23.901 24.189 23.957 24.072 24.001 23.807 24.039 23.854 23.798 24.1 Total: 239.718 0</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now let's activate all the kernels by re-commenting the lines. <br><br><pre> <code class="go hljs"> runtime.GOMAXPROCS(numcpu) <span class="hljs-comment"><span class="hljs-comment">//runtime.GOMAXPROCS(1)</span></span></code> </pre><br><br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel01.go NumCPU 4 543.092 534.985 535.799 533.039 538.806 533.315 536.501 533.261 537.73 532.585 Total: 5359.113 0</code> </pre><br><br>  20 times slower?  What's the catch?  The default channel size is 1. <br><br><pre> <code class="go hljs"> ch1 := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)</code> </pre><br><br>  We put 100. <br><br><pre> <code class="go hljs"> ch1 := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br><br>  result 1 thread <br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel01.go NumCPU 4 9.704 9.618 9.178 9.84 9.869 9.461 9.802 9.743 9.877 9.756 Total: 0 96.848</code> </pre><br><br>  result 4 threads <br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel01.go NumCPU 4 17.046 17.046 16.71 16.315 16.542 16.643 17.69 16.387 17.162 15.232 Total: 0 166.77300000000002</code> </pre><br><br>  Only two times slower, but it is not always possible to use it. <br><br><h5>  Channel Channel Example </h5><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { numcpu := runtime.NumCPU() fmt.Println(<span class="hljs-string"><span class="hljs-string">"NumCPU"</span></span>, numcpu) <span class="hljs-comment"><span class="hljs-comment">//runtime.GOMAXPROCS(numcpu) runtime.GOMAXPROCS(1) ch1 := make(chan chan int, 100) ch2 := make(chan float64, 1) go func() { t1 := time.Now().UnixNano() for i := 0; i &lt; 1000000; i++ { ch := make(chan int, 100) ch1 &lt;- ch &lt;- ch } t2 := time.Now().UnixNano() dt := float64(t2 - t1) / 1000000.0 fmt.Println(dt) ch2 &lt;- 0.0 }() go func() { for i := 0; i &lt; 1000000; i++ { ch := &lt;-ch1 ch &lt;- i } ch2 &lt;- 0.0 }() &lt;-ch2 &lt;-ch2 }</span></span></code> </pre><br><br>  result 1 thread <br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel03.go NumCPU 4 1041.489</code> </pre><br>  result 4 threads <br><pre> <code class="bash hljs">users-iMac:channel user$ go run channel03.go NumCPU 4 11170.616</code> </pre><br>  Therefore, if you have 8 cores and you write the server on Go, you should not completely rely on Go in parallelizing the program, or maybe run 8 single-threaded processes, and in front of them a balancer, which can also be written on Go.  In our production, there was a server that, when switching from a single-core server to 4x, began to process 10% fewer requests. <br><br>  What do these numbers mean?  We were faced with the task of processing 3000 requests per second in one context (for example, giving each request consecutive numbers: 1, 2, 3, 4, 5 ... maybe a little more complicated) and the performance of 3000 requests per second is limited primarily by channels.  With the addition of threads and cores, performance is not growing as much as one would like.  3000 requests per second for Go is a certain limit on modern equipment. <br><br><h4>  Night Update: How not to optimize </h4><br><br>  Comments from the article ‚Äú <a href="http://habrahabr.ru/post/195464/">Go: Two years in production</a> ‚Äù prompted me to write this article, but the comments of this one surpassed the comments of the first. <br><br>  Cybergrind <a href="http://habrahabr.ru/users/cybergrind/" class="user_link">hacker</a> suggested the following optimization.  She has already liked 8 other habrazhiteli.  I do not know if they read the code or maybe they are divers and they do everything intuitively, but I will explain.  So the article will become more complete and informative. <br>  Here is the code: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { numcpu := runtime.NumCPU() fmt.Println(<span class="hljs-string"><span class="hljs-string">"NumCPU"</span></span>, numcpu) <span class="hljs-comment"><span class="hljs-comment">//runtime.GOMAXPROCS(numcpu) runtime.GOMAXPROCS(1) ch3 := make(chan int) ch1 := make(chan int, 1000000) ch2 := make(chan float64) go func() { for i := 0; i &lt; 1000000; i++ { ch1 &lt;- i } ch3 &lt;- 1 ch1 &lt;- -1 ch2 &lt;- 0.0 }() go func() { fmt.Println("TT", &lt;-ch3) total := 0.0 for { t1 := time.Now().UnixNano() for i := 0; i &lt; 100000; i++ { m := &lt;-ch1 if m == -1 { ch2 &lt;- total } } t2 := time.Now().UnixNano() dt := float64(t2 - t1) / 1000000.0 total += dt fmt.Println(dt) } }() fmt.Println("Total:", &lt;-ch2, &lt;-ch2) }</span></span></code> </pre><br><br>  What is the essence of this optimization? <br><br>  1. Added channel ch3.  This channel blocks the second gorutina, until the end of the first gorutina. <br>  2. Since the second one does not read from channel ch1, it blocks the first one when filling.  Therefore, ch1 is increased to the required 1,000,000 <br><br>  That is, the code is no longer parallel, works in series, and the channel is used as an array.  And of course this code is not able to use the second core.  In the context of this code, one cannot speak of ‚Äúperfect acceleration N times‚Äú. <br><br>  The main thing is that such a code will work only with a initially defined amount of data and is not able to work constantly, to process live information for as long as desired. <br><br><h4>  Update 2: Tests for Go 1.1.2 </h4><br><br>  test number one with buffer 1 (channel01.go) <br><br><pre> <code class="go hljs"> ch1 := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><br>  1 thread <br><pre> <code class="bash hljs">go runchannel01.go NumCPU 4 66.0038 66.0038 67.0038 66.0038 67.0038 66.0038 65.0037 67.0038 67.0039 76.0043 Total: 0 673.0385000000001</code> </pre><br><br>  4 threads <br><pre> <code class="bash hljs">go run channel01.go NumCPU 4 116.0066 186.0106 112.0064 117.0067 175.01 115.0066 114.0065 148.0084 133.0076 153.0088 Total: 0 1369.0782</code> </pre><br>  Conclusion: much better.  Why put buffer 1 is difficult to imagine, but perhaps there is a use for such a buffer. <br><br>  test number one with buffer 100 (channel01.go) <br><br><pre> <code class="go hljs"> ch1 := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br><br>  1 thread <br><pre> <code class="bash hljs">go run channel01.go NumCPU 4 16.0009 17.001 16.0009 16.0009 16.0009 16.0009 17.001 16.0009 17.001 16.0009 Total: 0 163.00930000000002</code> </pre><br><br>  4 threads <br><pre> <code class="bash hljs">go runchannel01.go NumCPU 4 66.0038 66.0038 67.0038 66.0038 67.0038 66.0038 65.0037 67.0038 67.0039 76.0043 Total: 0 673.0385000000001</code> </pre><br>  Conclusion: Twice as bad as version 1.0.2. <br><br>  test number two (channel03.go) <br><br>  1 thread <br><pre> <code class="bash hljs">go run channel03.go NumCPU 4 1568.0897</code> </pre><br><br>  4 threads <br><pre> <code class="bash hljs">go run channel03.go NumCPU 4 12119.6932</code> </pre><br><br>  About the same as version 1.0.2, but slightly better.  1: 8 against 1:10 </div><p>Source: <a href="https://habr.com/ru/post/195574/">https://habr.com/ru/post/195574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195562/index.html">Jet manifest</a></li>
<li><a href="../195564/index.html">The third version of the typograph Muravyov</a></li>
<li><a href="../195566/index.html">Valve's latest announcement for the week - new game controllers</a></li>
<li><a href="../195568/index.html">Make the world better (karma policy)</a></li>
<li><a href="../195572/index.html">Usability: Value swapping error or worse than the built-in Android dialer</a></li>
<li><a href="../195578/index.html">GNOME Shell Extensions</a></li>
<li><a href="../195580/index.html">We look at the world through the eyes of a mantis cancer: the near infrared range</a></li>
<li><a href="../195582/index.html">See the invisible, or a little about the secrets of mail.ru</a></li>
<li><a href="../195584/index.html">The author of scientific articles Clive Thompson does not think that technology makes us sillier.</a></li>
<li><a href="../195586/index.html">RailsClub'Moscow 2013. The conference has begun!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>