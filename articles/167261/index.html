<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Python in a multithreaded C ++ application and true multithreading in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All more or less knowledgeable Python developers know about such a terrible thing as GIL. The global blocker of the entire process as long as Python i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Python in a multithreaded C ++ application and true multithreading in Python</h1><div class="post__text post__text-html js-mediator-article">  All more or less knowledgeable Python developers know about such a terrible thing as GIL.  The global blocker of the entire process as long as Python is running in one of the threads.  It gives stream-security methods comparable to sadism, because any implicit lock in a multithreaded application of death is similar, all that was based on parallel execution, dies in torment, stumbling over and over again on the GIL lock. <br>  It is known that to this day, because of this sad fact, C ++ programmers use Python wrappers for the most part only in single-threaded applications, and Python programmers try to convince everyone that they live well enough. <br>  It would seem that if the stream is generated in C ++, it does not know about any GIL, use Python without blocking and rejoice.  The developer‚Äôs joy, however, will end on the second thread that has requested the realm of global variables without blocking. <br>  However, there is a path leading to a brighter future! <br>  This path was originally in a language like Perl, it is also supported in the C-API of the Python language and I won‚Äôt mind why such a mechanism is not included in one of the standard Python modules!  The method essentially reduces the use of various Python sub-interpreters in different streams, and using your GIL for everyone (!!!) without any shamanism and magic, simply by calling several functions and a standard set of C-API of the Python language! <br><a name="habracut"></a><br><h4>  Honest multithreading in Python </h4><br>  All of the following is based on the new GIL introduced in Python 3.2, debugged and running on Python 3.3.  However, for earlier versions, the same Python 2.7, it is proposed to use the same API, the very behavior of GIL is not as important as its launch from the generated interpreter. <br>  So let's start, we need the main thread, in which we simply initialize everything and run a number of threads that work with various Python functions, both native Python and written in C ++.  We will do everything from C ++, we will work with the libraries boost :: python and boost :: thread.  If you do not have the BOOST library yet, or you use pure C instead of C ++, this is not scary, most of the work goes on C, and BOOST is used only for clarity and ease of development, all the same can be done on pure C using the Python API and the OS API for working with threads. <br>  At the beginning of working with Python, you need to initialize the interpreter, enable the GIL mechanism, and enable multithreading in GIL, while maintaining the state of the main thread: <br><pre><code class="cpp hljs">Py_Initialize(); <span class="hljs-comment"><span class="hljs-comment">//   Python PyEval_InitThreads(); //    Python   GIL mGilState = PyGILState_Ensure(); //   GIL     mThreadState = PyEval_SaveThread(); //       GIL //  GIL     Python      </span></span></code> </pre> <br>  Of course, initialization also means releasing resources; it is most convenient to create a class with a constructor and destructor, where the destructor restores the state of the thread, releases the GIL, and terminates the interpreter (including the work of the sub-interpreters): <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">//  GIL       PyEval_RestoreThread( mThreadState ); //        GIL PyGILState_Release( mGilState ); //   GIL    Py_Finalize(); //     ,   - Python</span></span></code> </pre><br>  So far, everything is obvious to all who have ever worked with GIL from the C-API of the Python language.  For the main thread, all that is needed is to act as a dispatcher, without blocking the GIL and not disturbing the other threads to do their work.  This is how the class should look like: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PyMainThread</span></span></span><span class="hljs-class"> //      {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: PyMainThread() <span class="hljs-comment"><span class="hljs-comment">//         { Py_Initialize(); //   Python PyEval_InitThreads(); //    Python   GIL mGilState = PyGILState_Ensure(); //   GIL     mThreadState = PyEval_SaveThread(); //       GIL //  GIL     Python       } ~PyMainThread() //         { //  GIL       PyEval_RestoreThread( mThreadState ); //        GIL PyGILState_Release( mGilState ); //   GIL    Py_Finalize(); //     ,   - Python } private: PyGILState_STATE mGilState; //   GIL PyThreadState* mThreadState; //     };</span></span></code> </pre><br>  Actually the work in the function main () or its analog is reduced to the following scheme: <br><pre> <code class="cpp hljs"> PyMainThread main_thread; <span class="hljs-comment"><span class="hljs-comment">//       boost::thread_group group; //  ,    ,   Python   GIL for( int id = 1; id &lt;= THREAD_NUM; ++id) group.create_thread( ThreadWork(id) ); group.join_all();</span></span></code> </pre><br>  Everything finished with primitive, the people are eager for magic ... oh yes, I promised that it would not be. <br><br><h4>  Work in every thread </h4><br>  If we now try to simply make time.sleep (1) in each child stream we will get a drop on the second thread. <br>  We will be saved by the magic function Py_NewInterpreter (!!!), in which everything would be fine, but using it requires blocking GIL (!) And it would be scary if it were not for the fact that GIL comes and goes, but the sub-interpreter remains.  And already in it you can block it as much as you like with GIL, it will have exactly one thread itself - the one in which it was created: <br><pre> <code class="cpp hljs"> mMainGilState = PyGILState_Ensure(); <span class="hljs-comment"><span class="hljs-comment">//     mOldThreadState = PyThreadState_Get(); //      mNewThreadState = Py_NewInterpreter(); //    - PyThreadState_Swap( mNewThreadState ); //        - mSubThreadState = PyEval_SaveThread(); //      GIL mSubGilState = PyGILState_Ensure(); //   GIL   -</span></span></code> </pre><br>  This is also best done in a special class constructor, and the destructor has the following code, respectively: <br><pre> <code class="cpp hljs"> PyGILState_Release( mSubGilState ); <span class="hljs-comment"><span class="hljs-comment">//  GIL  - PyEval_RestoreThread( mSubThreadState ); //         Py_EndInterpreter( mNewThreadState ); //   - PyThreadState_Swap( mOldThreadState ); //       PyGILState_Release( mMainGilState ); //   GIL   </span></span></code> </pre><br>  The code for the entire class is shown below: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PySubThread</span></span></span><span class="hljs-class"> //        {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: PySubThread() <span class="hljs-comment"><span class="hljs-comment">//    - Python      { mMainGilState = PyGILState_Ensure(); //     mOldThreadState = PyThreadState_Get(); //      mNewThreadState = Py_NewInterpreter(); //    - PyThreadState_Swap( mNewThreadState ); //        - mSubThreadState = PyEval_SaveThread(); //      GIL mSubGilState = PyGILState_Ensure(); //   GIL   - } ~PySubThread() //         - Python { PyGILState_Release( mSubGilState ); //  GIL  - PyEval_RestoreThread( mSubThreadState ); //         Py_EndInterpreter( mNewThreadState ); //   - PyThreadState_Swap( mOldThreadState ); //       PyGILState_Release( mMainGilState ); //   GIL    } private: PyGILState_STATE mMainGilState; //  GIL   Python PyThreadState* mOldThreadState; //       PyThreadState* mNewThreadState; //     - PyThreadState* mSubThreadState; //      GIL PyGILState_STATE mSubGilState; //  GIL   - Python };</span></span></code> </pre><br>  As you can see, the work on initialization in each thread is no longer as trivial and primitive as in the main thread.  However, we have a complete PROFIT for each stream.  Suppose that in each individual sub-interpreter we have to re-import the modules, however, we get almost complete isolation of the Python data for each stream! <br><br><h4>  Test the result </h4><br>  So let's check how right we are.  Let's get our Python module written in C ++ for completeness of sensations and provide the function analogue of time.sleep: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;boost/python.hpp&gt; #include &lt;boost/thread.hpp&gt; using namespace boost::python; using namespace boost::this_thread; using namespace boost::posix_time; void wait( double sec ) //  ,   time.sleep  Python { int msec = static_cast&lt;int&gt;( sec * 1000 ); //    sleep( millisec( msec ) ); //      } BOOST_PYTHON_MODULE( ctimer ) //  boost::python    ctimer { def( "wait", wait, args("sec") ); //  Python   ctimer.wait(sec) }</span></span></span></span></code> </pre><br>  We collect DLL and we rename into the Python module ctimer.pyd, if we are under Windows.  We put the received ctimer module for execution of the main application.  We will use ctimer.wait along with the standard time.sleep. <br>  We get a class functor for work in each separate flow: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThreadWork</span></span></span><span class="hljs-class"> //  -     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">boost</span></span></span><span class="hljs-class">:</span></span>:thread { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ThreadWork( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id ) <span class="hljs-comment"><span class="hljs-comment">//      : mID( id ) { } void operator () ( void ) //       { cout &lt;&lt; "Thread#" &lt;&lt; mID &lt;&lt; " &lt;= START" &lt;&lt; endl; PySubThread sub_thread; //    - Python for( int rep = 1; rep &lt;= REPEAT_TIMES; ++rep ) { //      Python cout &lt;&lt; "Thread#" &lt;&lt; mID &lt;&lt; " &lt;= Repeat#" &lt;&lt; rep &lt;&lt; " &lt;= import time; time.sleep(pause)" &lt;&lt; endl; object time = import( "time" ); // import time time.attr( "sleep" )( PAUSE_SEC ); // time.sleep(pause) //      C++ cout &lt;&lt; "Thread#" &lt;&lt; mID &lt;&lt; " &lt;= Repeat#" &lt;&lt; rep &lt;&lt; " &lt;= import ctimer; ctimer.wait(pause)" &lt;&lt; endl; object ctimer = import( "ctimer" ); // import ctimer ctimer.attr( "wait" )( PAUSE_SEC ); // ctimer.wait(pause) } cout &lt;&lt; "Thread#" &lt;&lt; mID &lt;&lt; " &lt;= END" &lt;&lt; endl; //  - Python    } private: int mID; //      };</span></span></code> </pre><br>  Run the application and enjoy!  Threads work in parallel with modules in Python, each thread has small sub-python buttons that have blocked each GIL and work freely together without interfering with each other. <br>  Cheers, comrades! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A link to the MSVS 2012 project with source codes (as many as two .cpp files) and compiled DLLs and EXEs for Python 3.3 x64 <a href="http://www.2shared.com/file/pzFCcAkG/pymt.html">can be downloaded here (290 KB)</a> <br><br><h4>  useful links </h4><br>  <a href="http://docs.python.org/3/c-api/init.html%3Fhighlight%3Dpy_newinterpreter">Working with the Python Interpreter</a> <br>  <a href="http://docs.python.org/3/c-api/init.html">API for working with threads, interpreter and GIL</a> <br>  <a href="http://www.boost.org/doc/libs/1_52_0/libs/python/doc/">Boost.Python Documentation</a> <br>  <a href="http://www.boost.org/doc/libs/1_52_0/doc/html/thread.html">Boost.Thread Documentation</a> </div><p>Source: <a href="https://habr.com/ru/post/167261/">https://habr.com/ru/post/167261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167241/index.html">Version of the table of STL-containers for printing</a></li>
<li><a href="../167245/index.html">Translation SDL Game Framework Series. Part 3 - SDL Events</a></li>
<li><a href="../167247/index.html">Object-disoriented language</a></li>
<li><a href="../167249/index.html">Apple released iOS 6.1 beta 5</a></li>
<li><a href="../167257/index.html">Interview with the creator of C ++ STL, 1995 Part 2</a></li>
<li><a href="../167263/index.html">Download, play sound, use microphone in ActionScript 3.0</a></li>
<li><a href="../167265/index.html">Communication between windows of one browser by means of cookies</a></li>
<li><a href="../167269/index.html">Setting up multiple Postfix instances on the same server</a></li>
<li><a href="../167273/index.html">Custom JavaScript and CSS on mobile devices</a></li>
<li><a href="../167277/index.html">Flying phone or wand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>