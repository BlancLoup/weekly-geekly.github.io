<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We break and restore the Chinese IP camera</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began more than a year ago, when several relatively cheap Chinese Falcon Eye FE-MTR300 P2P IP cameras were purchased by the organization, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We break and restore the Chinese IP camera</h1><div class="post__text post__text-html js-mediator-article">  This story began more than a year ago, when several relatively cheap Chinese Falcon Eye FE-MTR300 P2P IP cameras were purchased by the organization, so that there were no excesses between employees and visitors under the supervision of a big brother. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/30f/4cf/a4d/30f4cfa4d8964b89baa14c726eec8794.jpg" alt="image"></div><br>  Not to say that everything was good ... Everything was average.  And it seemed to us that the software update of cameras could improve something.  It turned out that some models of Falcon Eye, Tenvis, Foscam and, perhaps, some other companies almost coincide.  Somewhere buttons more conveniently, somewhere the interface Russian is.  And we decided! <br><br>  Updated software cameras on a similar model from the Tenvis TR3818.  Then they read it and decided that it was possible to upgrade to a steeper firmware from another camera. <br><a name="habracut"></a><br>  After the update, the camera ordered to live long.  Checking the motors when turned on did not occur, the speakers did not rustle, the LED did not blink.  Only the LED on the LAN interface was on, and when turned on, a single broadcast packet was leaving. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After such an incident, the rest of the cells were hung in places, and the ‚Äúbrick‚Äù moved to live with us.  From time to time there were attempts to reanimate it.  The camera was disassembled, found a site where you can solder for access through the console. <br><br><img src="https://habrastorage.org/web/fe8/355/918/fe8355918b7c4186a8e813738201e961.jpg" alt="image"><br>  <i>(there are 3.3V, GND, TX, RX markings under the wires)</i> <br><br><img src="https://habrastorage.org/web/fd0/fdc/741/fd0fdc74176f43c6868b929b8d3b81c6.jpg" alt="image"><br>  <i>(camera board assembly)</i> <br><br>  I had to take a USB-TTL converter. <br><br><img src="https://habrastorage.org/web/1a9/c5d/827/1a9c5d82701146fd8ab379ca17fb431e.jpg" alt="image"><br>  <i>(there is a contact)</i> <br><br>  Connect to the console via putty or HyperTerminal and see the following: <br> <code><b>U-Boot 1.1.3 (Aug 26 2014 - 17:15:00) <br> <br> Board: Ralink APSoC DRAM: 16 MB <br> relocate_code Pointer at: 80fb0000 <br> spi_wait_nsec: 42 <br> spi device id: c2 20 17 c2 20 (2017c220) <br> find flash: MX25L6405D <br> raspi_read: from:2b000 len:1000 <br> .raspi_read: from:2b000 len:1000 <br> .============================================ <br> Ralink UBoot Version: 3.6.0.0 <br> -------------------------------------------- <br> ASIC 5350_MP (Port5&lt;-&gt;None) <br> DRAM_CONF_FROM: Boot-Strapping <br> DRAM_TYPE: SDRAM <br> DRAM_SIZE: 128 Mbits <br> DRAM_WIDTH: 16 bits <br> DRAM_TOTAL_WIDTH: 16 bits <br> TOTAL_MEMORY_SIZE: 16 MBytes <br> Flash component: 8 MBytes NOR Flash <br> Date:Aug 26 2014 Time:17:15:00 <br> ============================================ <br> icache: sets:256, ways:4, linesz:32 ,total:32768 <br> dcache: sets:128, ways:4, linesz:32 ,total:16384 <br> <br> ##### The CPU freq = 360 MHZ #### <br> estimate memory size =16 Mbytes <br> raspi_read: from:80028 len:6 <br> . <br> start time:31742632l <br> File: cmd_net.c, Func: do_my_tftpb, Line: 69 <br> <br> netboot_common, argc= 3 <br> <br> NetTxPacket = 0x80FE3C80 <br> <br> KSEG1ADDR(NetTxPacket) = 0xA0FE3C80 <br> <br> NetLoop,call eth_halt ! <br> <br> NetLoop,call eth_init ! <br> Trying Eth0 (10/100-M) <br> <br> Waitting for RX_DMA_BUSY status Start... done <br> <br> Header Payload scatter function is Disable !! <br> <br> ETH_STATE_ACTIVE!! <br> Using Eth0 (10/100-M) device <br> TFTP from server 51.204.51.204; our IP address is 192.168.1.5 <br> Filename 'xx.img'. <br> <br> TIMEOUT_COUNT=10,Load address: 0x80100000 <br> Loading: ====================broadcast get file <br> T ====================broadcast get file <br> <br> could not get file, cancel update <br> ret = 1 <br> <br> Please choose the operation: <br> 1: Load system code to SDRAM via TFTP. <br> 2: Load system code then write to Flash via TFTP. <br> 3: Boot system code via Flash (default). <br> 4: Entr boot command line interface. <br> 7: Load Boot Loader code then write to Flash via Serial. <br> 9: Load Boot Loader code then write to Flash via TFTP. <br> <br> You choosed 3 <br> 0 <br> <br> 3: System Boot system code via Flash. <br> ## Booting image at bc0e0000 ... <br> raspi_read: from:e0000 len:40 <br> .Magic Number,85190320 <br> Bad Magic Number,85190320 <br></b></code> <br>  Bad, says you have a magic number.  And he doesn‚Äôt want to react to my choice of any other menu item.  This was completed the first approach to the camera and she returned to the shelf in the department. <br><br>  Having gained strength, we made another approach.  I had to spend my nerves to understand that it was in our case that the RX converter should be connected to the RX cameras, and the TX to the TX.  Either the marking was incorrectly applied or one of the two.  The camera began to respond to the choice of menu items, but this did not explain the nature of the magic numbers. <br><br>  Then the firmware for Tenvis TR3818 and several firmware for similar cameras were downloaded, a tftp-server was configured and item 4 was selected, the entrance to the command interface.  Actually, by <b>?</b>  gives us a list of possible commands, where we find <b>tftpboot</b> - which loads the file from tftp into memory and <b>bootm</b> - which loads the application from memory. <br><br>  The procedure is as follows: <br><br><ul><li>  load the firmware into the camera via <b>tftpboot</b> </li><li>  run the <b>bootm</b> command </li><li>  We look at the result, think it over. </li></ul><br>  And the results were as follows: <br><br><ul><li>  On the firmware of similar cameras - the magic number does not match </li><li>  On Tenvis TR3818 firmware <br> <code><b>RT5350 # bootm <br> ## Booting image at 80100000 ... <br> Magic Number,27051956 <br> Image Name: SPI Flash Image <br> Created: 2014-11-26 6:26:49 UTC <br> Image Type: MIPS Linux Standalone Program (uncompressed) <br> Data Size: 112920 Bytes = 110.3 kB <br> Load Address: 80200000 <br> Entry Point: 80200000 <br> Verifying Checksum ... OK <br> OK</b></code> <br>  <i>(We learned the magic number, but only here 110 KB and this is the firmware of the bootloader, and the firmware file is 7 MB)</i> </li><li>  We are trying to feed the entire firmware file as a boot loader update (item 9 in the menu) - it swears at a file that is too large.  Browse the file with Frhed and see that the magic number is at the very beginning of the file.  And since we know that the size of the loader is 112920 bytes + 64 bytes is the size of the header, then we copy 112984 bytes into a separate file, feed the camera through 9 menu items and rejoice in the updated loader. </li><li>  Inspired by the success, we are looking for a repetition of the magic number in the firmware file and find the same header in the firmware file at 0xE0000, but only with <b>Linux Kernel Image.</b> We copy everything from it to the end of the file into a separate file and try to check through <b>tftpboot</b> and <b>bootm</b> . <br> <code><b>RT5350 # bootm <br> ## Booting image at 80100000 ... <br> Magic Number,27051956 <br> Image Name: Linux Kernel Image <br> Created: 2014-11-26 6:26:54 UTC <br> Image Type: MIPS Linux Kernel Image (lzma compressed) <br> Data Size: 1065116 Bytes = 1 MB <br> Load Address: 80000000 <br> Entry Point: 80347000 <br> Verifying Checksum ... OK <br> Uncompressing Kernel Image ... LZMA ERROR 1 - must RESET board to recover</b></code> <br>  <i>(The number came together, the size is known, we load it as it is through the 2nd menu item and we see what is written to the memory at offset 0x30000, and when the camera starts, it accesses 0xE0000, that is, we miss by 0xB0000 bytes past the magic number)</i> </li><li>  So we take another 0xB0000 byte of data before the magic number from the file with Tenvis firmware.  Fill through the 2nd menu item and the camera comes to life! </li></ul><br>  I hope this is much more interesting and less tedious to read than switching wiring, shoveling the Internet and calculating offsets, restoring the logic of the work of Chinese genius.  Perhaps this should teach us the next time to refrain from thoughtless firmware technology than got. <br><br>  And thank you!  If it were not for the desire to please Habr, perhaps this camera would have stood in our department for a long time. </div><p>Source: <a href="https://habr.com/ru/post/335810/">https://habr.com/ru/post/335810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335798/index.html">What a job scheduler can do in Postgres Pro</a></li>
<li><a href="../335800/index.html">The Great Silk Road: from tablets from China to a nanny-robot from Moscow region</a></li>
<li><a href="../335804/index.html">Random forest vs neural network: who will better cope with the task of recognizing gender in speech (part 2)</a></li>
<li><a href="../335806/index.html">Guide to localizing applications for the Chinese market. Part 1</a></li>
<li><a href="../335808/index.html">BIM: how we build builders in construction</a></li>
<li><a href="../335812/index.html">Simple Java code breaking the Scala type inference system</a></li>
<li><a href="../335814/index.html">Kubernetes success stories in production. Part 3: GitHub</a></li>
<li><a href="../335816/index.html">Computer networks for dummies</a></li>
<li><a href="../335818/index.html">Yamichat - customizable chat bot and online consultant in one platform</a></li>
<li><a href="../335820/index.html">Modern methods of web application security research</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>