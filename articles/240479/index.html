<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fight against memory leaks in Android. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this article we open a series of articles on Habr√© about our development for Android. 
 According to a 2012 report from Crittercism, OutOfMemoryE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fight against memory leaks in Android. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/448/a03/6ef/448a036efa9f4664bc54e03271b63b98.png" align="left">  With this article we open a series of articles on Habr√© about our development for Android. <br>  According to a 2012 report from Crittercism, OutOfMemoryError is the second most common reason for crashing mobile apps. <br>  To be honest, in Badoo this error was in the top of all the most beautiful (which is not surprising given the volume of photos that our users view).  Fighting OutOfMemory is a painstaking exercise.  We picked up the Allocation Tracker and started playing with the app.  Observing the data of the reserved memory, we identified several scenarios in which the memory allocation grew with suspicious swiftness, forgetting to decrease.  Armed with several memory dumps after these scenarios, we analyzed them in MAT ( <a href="http://www.eclipse.org/mat/">http://www.eclipse.org/mat/</a> ). <br>  The result was entertaining and allowed us to reduce the amount of beautiful at times over several weeks.  Something was specific to our code, but also revealed typical problems inherent in most Android applications. <br>  Today we will talk about a specific case of memory leak.  Many people know about him, but often close their eyes to it (but in vain). <br><a name="habracut"></a><br>  It will be about memory leaks associated with improper use of android.os.Handler.  Not entirely obvious, but everything you put into the Handler is in memory and cannot be cleared by the garbage collector for some time.  Sometimes quite long. <br>  A little later, we will show with examples what is happening and why memory cannot be freed.  If you are not curious, but want to know how to deal with the problem, then go to the conclusions at the end of the article.  Or immediately go to the page of a small library, which we have laid out in open access: <a href="https://github.com/badoo/android-weak-handler">https://github.com/badoo/android-weak-handler</a> . <br><br>  So, what is there "flowing"?  Let's see. <br><br><h4>  Simple example </h4><br><img src="https://habrastorage.org/files/a7e/c9d/606/a7ec9d606c3f41c9b62123fe889c1b90.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is a very simple Activity class.  Suppose we need to change the text after 800 seconds.  An example, of course, is ridiculous, but it will well demonstrate to us how the streams flow to our memory. <br>  Pay attention to the anonymous Runnable, which we post in Handler.  It is also important to pay attention to the long timeout. <br>  For the test, we launched this example and turned the phone 7 times, thereby causing a change of screen orientation and the re-creation of the Activity.  Then they took a memory dump and opened it in MAT ( <a href="http://www.eclipse.org/mat/">http://www.eclipse.org/mat/</a> ). <br><br>  Using OQL, we launch a simple query that displays all the instances of the Activity class: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> instanceof android.app.Activity</code> </pre> <br>  We highly recommend reading about OQL - it will significantly help you in memory analysis. <br>  You can <a href="http://visualvm.java.net/oqlhelp.html">read</a> here <a href="http://visualvm.java.net/oqlhelp.html">visualvm.java.net/oqlhelp.html</a> or here <a href="http://help.eclipse.org/luna/index.jsp%3Ftopic%3D%252Forg.eclipse.mat.ui.help%252Freference%252Foqlsyntax.html">help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html</a> . <br><br><img src="https://habrastorage.org/files/42c/828/8dd/42c8288dddee4dc59854ccd1a311f4f5.png"><br><br>  In memory hangs 7 instances of Activity.  This is 7 times more than necessary.  Let's see why the garbage collector could not remove the spent objects from memory.  Let's open the shortest graph of links to one of the Activity: <br><br><img src="https://habrastorage.org/files/0de/445/a19/0de445a192804f27bfc47f10235f77ec.png"><br><br>  The screenshot shows that <b>this $ 0</b> refers to Activity.  This is an implicit link from an anonymous class to an external class.  In Java, any anonymous class always has an implicit reference to an external class, even if you never access external fields or methods.  Java is not perfect, but life is pain.  Such things, the cat. <br><br>  Further, a link to <b>this $ 0</b> is stored in a <b>callback</b> , which is stored in a linked list of messages.  At the end of the chain is a local reference in the stack of the main thread.  Apparently, this is a local variable in the main UI loop of the thread, which will be released when the cycle runs.  In our case, this will happen after the application has completed its work. <br><br>  So, after we put Runnable or Message in Handler, it will be stored in the list of messages in LooperThread until the message runs out.  Obviously, if we put a postponed message, it will remain in memory until its time comes.  Along with the message in memory will be all the objects referenced by the message, explicitly and implicitly. <br>  And with this you need to do something. <br><br><h4>  Static class solution </h4><br>  Let's try to solve our problem by getting rid of the link <b>this $ 0</b> .  To do this, we convert the anonymous class into a static one: <br><br><img src="https://habrastorage.org/files/e0f/36e/b0e/e0f36eb0e1f246d6852e76139c8f395e.png"><br><br>  We start, turn the phone a couple of times and collect a memory dump. <br><br><img src="https://habrastorage.org/files/f08/0ef/bc5/f080efbc51364a1ca753cfc632b5e0c0.png"><br><br>  Again more than one Activity?  Let's see why the garbage collector could not remove them. <br><br><img src="https://habrastorage.org/files/137/06d/5f8/13706d5f82a44cc98e2d43d4ddf2e4d0.png"><br><br>  Pay attention to the very bottom of the link graph: Activity is stored in the mContext link from mTextView inside the DoneRunnable class.  Obviously, using a static class alone is not enough to avoid memory leaks.  We need to do something else. <br><br><h4>  Solution using static class and WeakReference </h4><br>  Let's continue the sequential method of getting rid of the link to TextView, which we found during the study of memory dumps. <br><br><img src="https://habrastorage.org/files/0a0/527/234/0a0527234e19415eba6e135a1598bcff.png"><br><br>  Please note that we save the link to the TextView in the WeakReference.  Using WeakReference requires special care: such a link can be reset at any time.  Therefore, we first save the link to a local variable and work only with the last one, checking it for null. <br><br>  We start, we turn and we collect memory dump. <br><br><img src="https://habrastorage.org/files/49a/c76/9b2/49ac769b27ed4b55983affe290a4d102.png"><br><br>  We have achieved the desired!  Only one Activity in memory.  Problem solved. <br><br>  To use this approach, we need: <br><br><ul><li>  use a static inner or outer class; </li><li>  use WeakReference for all objects that we refer to. </li></ul><br>  Is this method good? <br>  If we compare the original code and the "safe" code, then a large amount of "noise" catches the eye.  It distracts from understanding the code and complicates its support.  Writing such code is still a pleasure, not to mention the fact that you can forget or score something. <br><br>  Well, there are better solutions. <br><br><h4>  Purging all messages in onDestroy </h4><br>  The Handler class has an interesting and very useful method - <b>removeCallbacksAndMessages</b> , which takes null as an argument.  It deletes all messages in the queue of this Handler.  Let's use it in <b>onDestroy.</b> <br><br><img src="https://habrastorage.org/files/ba7/e99/d08/ba7e99d08c8c4394ae0efbac43c669ac.png"><br><br>  Run, rotate and remove the memory dump. <br><br><img src="https://habrastorage.org/files/50e/657/6db/50e6576db28944979b835bf2f3b6a037.png"><br><br>  Perfectly!  Only one Activity class. <br><br>  This method is much better than the previous one: the amount of accompanying code is minimal, the risks of making a mistake are much lower.  One problem - do not forget to call for cleaning in <b>onDestroy</b> methods or where you need to clean the memory. <br><br>  We have another method in stock, which you may like a lot more. <br><br><h4>  WeakHandler Solution </h4><br><br>  The Badoo team wrote its Handler - <b>WeakHandler</b> .  This is a class that behaves perfectly like a Handler, but excludes memory leaks. <br><br>  It uses soft and hard links to avoid memory leaks.  The principle of its work, we describe a little later, but for now let's take a look at the code: <br><br><img src="https://habrastorage.org/files/fc6/c52/d2b/fc6c52d2b52945c0a0c62785b9b9a6b7.png"><br><br>  Very similar to the original code, isn't it?  Just one small detail: instead of using <b>android.os.Handler,</b> we used <b>WeakHandler</b> .  Let's run, turn the phone several times and take a memory dump. <br><br><img src="https://habrastorage.org/files/61b/2ec/71b/61b2ec71b85f471597353743ece8c4fd.png"><br><br>  Finally!  The code is clean as a tear and memory does not flow. <br><br>  If you like this method, here's the good news: using <b>WeakHandler is</b> very simple. <br><br>  Add maven dependency to your project: <br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">repositories</span></span> { <span class="hljs-section"><span class="hljs-section">maven</span></span> { <span class="hljs-section"><span class="hljs-section">repositories</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">url</span></span> <span class="hljs-string"><span class="hljs-string">'https://oss.sonatype.org/content/repositories/releases/'</span></span> } } } dependencies { <span class="hljs-attribute"><span class="hljs-attribute">compile</span></span> <span class="hljs-string"><span class="hljs-string">'com.badoo.mobile:android-weak-handler:1.0'</span></span> }</code> </pre><br><br>  Import <b>WeakHandler</b> in your code: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.badoo.mobile.util.WeakHandler</code> </pre><br>  The source code is posted on github: <a href="https://github.com/badoo/android-weak-handler">github.com/badoo/android-weak-handler</a> . <br><br><h4>  WeakHandler principle of operation </h4><br>  The main idea is to keep a hard link to messages or Runnable as long as there is a hard link to <b>WeakHandler</b> .  As soon as <b>WeakHandler</b> can be removed from memory, everything else should be removed with it. <br><br>  For ease of explanation, we will show a simple diagram showing the difference between placing anonymous Runnable in a simple Handler and in <b>WeakHandler</b> : <br><br><img src="https://habrastorage.org/files/7d5/117/caf/7d5117caf7294225822ada7d64b7d577.png"><br><br>  Pay attention to the upper diagram: Activity refers to Handler, which posts Runnable (puts it in the message queue referenced by Thread).  Everything is not bad, except for the implicit backlink from Runnable to Activity.  As long as Message is in the queue, which lives while the Thread is alive, the entire graph cannot be collected by the garbage collector.  Including fat Activity. <br><br>  In the bottom diagram, Activity refers to WeakHandler, which holds the Handler inside.  When we ask him to put Runnable, he wraps it up in WeakRunnable and posts it in a queue.  Thus, the message queue refers only to WeakRunnable.  WeakRunnable contains WeakReference on the original Runnable, i.e.  the garbage collector can clean it up at any time.  Whatever he clears ahead of time, WeakHandler holds a hard link to Runnable.  But as soon as WeakHandler itself can be deleted, Runnable can also be deleted. <br><br>  You need to be careful and do not forget that WeakHandler should be a link from the outside, otherwise all messages will be cleared with it by the garbage collector. <br><br><h4>  findings </h4><br>  Using <b>postDelayed</b> in Android is not as simple as it seems: you need to take additional steps to keep the memory running.  To do this, you can use the following methods: <br><br><ul><li>  use the static inner class Runnable / Handler with WeakReferences on the outer class; </li><li>  clean all messages in the Handler class from the onDestroy method; </li><li>  use WeakHandler from Badoo ( <a href="https://github.com/badoo/android-weak-handler">https://github.com/badoo/android-weak-handler</a> ). </li></ul><br>  The choice is yours.  The first method is definitely not for the lazy.  The second method looks quite simple, but requires additional work.  The third is our favorite, but you need to be careful: <b>WeakHandler</b> should have an external link as long as you need it, otherwise the garbage collector will delete it along with all messages from the queue. <br><br>  Good luck to you!  Stay tuned - this topic will be continued. <br><br>  Article in our English-language blog: <a href="http://bit.ly/AndroidHandlerMemoryLeaks">bit.ly/AndroidHandlerMemoryLeaks</a> <br><br>  Dmitry Voronkevich, Lead Developer </div><p>Source: <a href="https://habr.com/ru/post/240479/">https://habr.com/ru/post/240479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240469/index.html">MindCub3r in Russian - we make a robot that can assemble a Rubik's Cube (article updated)</a></li>
<li><a href="../240471/index.html">Utilities in (FREE status) for the calculation of wave resistance and not only ...</a></li>
<li><a href="../240473/index.html">Demo versions from Google Play, data on revenues from games for 2014, consolidation of market leaders from Japan - and other news of the week for a mobile developer</a></li>
<li><a href="../240475/index.html">Creating Today Extension for iOS 8</a></li>
<li><a href="../240477/index.html">Enchanting performance by Bertrand Picard</a></li>
<li><a href="../240483/index.html">Using the beanstalkd queue server to distribute our mailing list</a></li>
<li><a href="../240485/index.html">Sequential execution of tasks in Gulp JS</a></li>
<li><a href="../240489/index.html">We create notebooks for the book in automatic mode</a></li>
<li><a href="../240491/index.html">Starban. Flexible development methodology, gamification and many more buzz words</a></li>
<li><a href="../240493/index.html">We introduce work with coordinates in sonata-admin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>