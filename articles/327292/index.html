<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing parallel processes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you met with errors that occur from time to time in production, but cannot be reproduced in any way locally? It happens, you study such a bug and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing parallel processes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c1c/007/ca9/c1c007ca94e40da77659a0c2bb9e46df.jpg" alt="image"><br><br>  Have you met with errors that occur from time to time in production, but cannot be reproduced in any way locally?  It happens, you study such a bug and suddenly you realize that it manifests itself only with simultaneous parallel execution of scripts.  Having studied the code, you understand how to fix it so that this does not happen again.  But it would be good to write a test for such a fix ... <br><br>  In the article I will talk about my approach to testing such situations.  And also I will give several illustrative (and probably even classical) examples of bugs that are convenient to test using this approach.  All examples of bugs are alive - that is found in the work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Looking ahead, I‚Äôll immediately say that at the end of the article there will be a link to github, where I posted a ready-made solution that allows you to test parallel console processes easily and simply. <br><a name="habracut"></a><br><h3>  Example number one.  Parallel addition of the same </h3><br>  Task.  We have an application with a database (PostgreSQL) and we need to adjust the import of data from a third-party system.  Suppose there is a table <code>account (id, name)</code> and the association of identifiers with the external system in the <code>account_import (id, external_id)</code> table <code>account_import (id, external_id)</code> .  Let's outline a simple message receiving mechanism. <br><br>  When receiving a message, we will first check if there are such records in our database.  If so, we will update the available ones.  If not, we will add to the database. <br><br><pre> <code class="php hljs">$data = json_decode($jsonInput, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">// '{"id":1,"name":"account1"}' try { $connection-&gt;beginTransaction(); // ,       $stmt = $connection-&gt;prepare("SELECT id FROM account_import WHERE external_id = :external_id"); $stmt-&gt;execute([ ':external_id' =&gt; $data['id'], ]); $row = $stmt-&gt;fetch(); usleep(100000); // 0.1 sec //      ,    if ($row) { $stmt = $connection-&gt;prepare("UPDATE account SET name = :name WHERE id = ( SELECT id FROM account_import WHERE external_id = :external_id )"); $stmt-&gt;execute([ ':name' =&gt; $data['name'], ':external_id' =&gt; $data['id'], ]); $accountId = $row['id']; } //     else { $stmt = $connection-&gt;prepare("INSERT INTO account (name) VALUES (:name)"); $stmt-&gt;execute([ ':name' =&gt; $data['name'], ]); $accountId = $connection-&gt;lastInsertId(); $stmt = $connection-&gt;prepare("INSERT INTO account_import (id, external_id) VALUES (:id, :external_id)"); $stmt-&gt;execute([ ':id' =&gt; $accountId, ':external_id' =&gt; $data['id'], ]); } $connection-&gt;commit(); } catch (\Throwable $e) { $connection-&gt;rollBack(); throw $e; }</span></span></code> </pre> <br>  At first glance it looks good.  But if the data in our system can not be transmitted strictly in a consistent manner, then we may encounter a problem.  The delay is 0.1 seconds in this example, we need to ensure that the problem is reproduced.  What happens if you import the same data in parallel?  Probably, instead of the data being added, and then updated, there will be an attempt to re-insert the data and, as a result, an error of violation of the primary key in account_import. <br><br>  To correct a mistake, it would be good to reproduce it first.  And the best thing is to write a test that reproduces the error.  I decided to run the commands asynchronously for this using bash and wrote a simple script for this, which can be used not only in conjunction with PHP. <br><br>  The idea is simple - we run several instances of commands in the background, then we wait for them to complete, and check the execution codes.  If among the execution codes there are non-zero, then we have found a bug.  In a simplified form, the script will look like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ,    COMMAND=‚Äùecho -e '{\"id\":1,\"name\":\"account1\"}' | ./cli app:import‚Äù # PID-    pids=() #     results=() #      () expects=() #         stderr for i in $(seq 2) do eval $COMMAND 1&gt;&amp;2 &amp; pids+=($!) ; echo -e '&gt;&gt;&gt;' Process ${pids[i-1]} started 1&gt;&amp;2 done #         $results for pid in "${pids[@]}" do wait $pid results+=($?) expects+=(0) echo -e '&lt;&lt;&lt;' Process $pid finished 1&gt;&amp;2 done #      result=`( IFS=$', '; echo "${results[*]}" )` expect=`( IFS=$', '; echo "${expects[*]}" )` if [ "$result" != "$expect" ] then exit 1 fi</span></span></code> </pre> <br>  The full version of the script <a href="https://github.com/mnvx/pprocess/blob/master/bin/pprocess">posted on github</a> . <br><br>  Based on this command, we can add new assertions to PHPUnit.  Everything is easier here and I will not dwell on this in detail.  I can only say that they are implemented in the above project.  To use them, it is enough to connect the AsyncTrait <code>AsyncTrait</code> to your test. <br><br>  We write this test. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">Initializer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Tester</span></span>\<span class="hljs-title"><span class="hljs-title">CommandTester</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportCommandTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testImport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $cli = Initializer::create(); $command = $cli-&gt;find(<span class="hljs-string"><span class="hljs-string">'app:delete'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   c external_id = 1, //           $commandTester = new CommandTester($command); $commandTester-&gt;execute([ 'externalId' =&gt; 1, ]); $asnycCommand = new Command( 'echo -e \'{"id":1,"name":"account1"}\' | ./cli app:import', //   dirname(__DIR__), // ,      2 //     ); //   $this-&gt;assertAsyncCommand($asnycCommand); } }</span></span></code> </pre> <br>  As a result of launching the test, we will get this output. <br><br><pre> <code class="hljs pgsql">$ ./vendor/bin/phpunit PHPUnit <span class="hljs-number"><span class="hljs-number">6.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Sebastian Bergmann <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> contributors. F <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">100</span></span>%) <span class="hljs-type"><span class="hljs-type">Time</span></span>: <span class="hljs-number"><span class="hljs-number">230</span></span> ms, Memory: <span class="hljs-number"><span class="hljs-number">6.00</span></span>MB There was <span class="hljs-number"><span class="hljs-number">1</span></span> failure: <span class="hljs-number"><span class="hljs-number">1</span></span>) ImportCommandTest::testImport Failed asserting that command echo -e <span class="hljs-string"><span class="hljs-string">'{"id":1,"name":"account1"}'</span></span> | ./cli app:<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> (<span class="hljs-type"><span class="hljs-type">path</span></span>: /var/www/pprocess-playground, count: <span class="hljs-number"><span class="hljs-number">2</span></span>) executed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parallel. Output: &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">18143</span></span> started &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">18144</span></span> started Account <span class="hljs-number"><span class="hljs-number">25</span></span> imported correctly [Doctrine\DBAL\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>\UniqueConstraintViolationException] An <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> occurred <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> executing <span class="hljs-string"><span class="hljs-string">'INSERT INTO account_import (id, exte rnal_id) VALUES (:id, :external_id)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> params ["26", <span class="hljs-number"><span class="hljs-number">1</span></span>]: <span class="hljs-built_in"><span class="hljs-built_in">SQLSTATE</span></span>[<span class="hljs-number"><span class="hljs-number">23505</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">Unique</span></span> violation: <span class="hljs-number"><span class="hljs-number">7</span></span> :       "account_import_pkey" DETAIL:  "(external_id)=(1)"  . <span class="hljs-comment"><span class="hljs-comment">------- app:import &lt;&lt;&lt; Process 18143 finished &lt;&lt;&lt; Process 18144 finished . /var/www/pprocess-playground/vendor/mnvx/pprocess/src/AsyncTrait.php:19 /var/www/pprocess-playground/tests/ImportCommandTest.php:30 FAILURES! Tests: 1, Assertions: 1, Failures: 1.</span></span></code> </pre> <br>  The reason we have already discussed.  Now we will try to add a forced blocking of parallel execution of a fragment of our script ( <a href="https://github.com/malkusch/lock">malkusch / lock is</a> used here). <br><br><pre> <code class="php hljs">$mutex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlockMutex(fopen(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>)); $mutex-&gt;synchronized(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($connection, $data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     try });</span></span></code> </pre><br>  Test passed: <br><br><pre> <code class="hljs pgsql">$ ./vendor/bin/phpunit PHPUnit <span class="hljs-number"><span class="hljs-number">6.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Sebastian Bergmann <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> contributors. . <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">100</span></span>%) <span class="hljs-type"><span class="hljs-type">Time</span></span>: <span class="hljs-number"><span class="hljs-number">361</span></span> ms, Memory: <span class="hljs-number"><span class="hljs-number">6.00</span></span>MB OK (<span class="hljs-number"><span class="hljs-number">1</span></span> test, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assertion</span></span>)</code> </pre> <br>  I <a href="https://github.com/mnvx/pprocess-playground">put</a> this and other examples <a href="https://github.com/mnvx/pprocess-playground">on github</a> , if suddenly someone needs it. <br><br><h3>  Example number two.  Preparation of data in the table </h3><br>  This example will be a little more interesting.  Suppose we have a users <code>users (id, name)</code> table <code>users (id, name)</code> and we want to store in the <code>users_active (id)</code> table a list of currently active users. <br><br>  We will have a team that every time will delete all records from the <code>users_acitve</code> table and add data there again. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $connection-&gt;beginTransaction(); $connection-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"DELETE FROM users_active"</span></span>)-&gt;execute(); usleep(<span class="hljs-number"><span class="hljs-number">100000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 0.1 sec $connection-&gt;prepare("INSERT INTO users_active (id) VALUES (3), (5), (6), (10)")-&gt;execute(); $connection-&gt;commit(); $output-&gt;writeln('&lt;info&gt;users_active refreshed&lt;/info&gt;'); } catch (\Throwable $e) { $connection-&gt;rollBack(); throw $e; }</span></span></code> </pre> <br>  Here, only at first glance, everything is fine.  In fact, when running in parallel, we get an error again. <br><br>  Let's write a test to reproduce it. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DetectActiveUsersCommandTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testImport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $asnycCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Command( <span class="hljs-string"><span class="hljs-string">'./cli app:detect-active-users'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   dirname(__DIR__), // ,      2 //     ); //   $this-&gt;assertAsyncCommand($asnycCommand); } }</span></span></code> </pre> <br>  Run the test and see the error text: <br><br><pre> <code class="hljs pgsql">$ ./vendor/bin/phpunit tests/DetectActiveUsersCommandTest.php PHPUnit <span class="hljs-number"><span class="hljs-number">6.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Sebastian Bergmann <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> contributors. F <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">100</span></span>%) <span class="hljs-type"><span class="hljs-type">Time</span></span>: <span class="hljs-number"><span class="hljs-number">287</span></span> ms, Memory: <span class="hljs-number"><span class="hljs-number">4.00</span></span>MB There was <span class="hljs-number"><span class="hljs-number">1</span></span> failure: <span class="hljs-number"><span class="hljs-number">1</span></span>) DetectActiveUsersCommandTest::testImport Failed asserting that command ./cli app:detect-active-users (<span class="hljs-type"><span class="hljs-type">path</span></span>: /var/www/pprocess-playground, count: <span class="hljs-number"><span class="hljs-number">2</span></span>) executed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parallel. Output: &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">24717</span></span> started &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">24718</span></span> started users_active refreshed &lt;&lt;&lt; Process <span class="hljs-number"><span class="hljs-number">24717</span></span> finished [Doctrine\DBAL\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>\UniqueConstraintViolationException] An <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> occurred <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> executing <span class="hljs-string"><span class="hljs-string">'INSERT INTO users_active (id) VALUES (3), (5), (6), (10)'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">SQLSTATE</span></span>[<span class="hljs-number"><span class="hljs-number">23505</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">Unique</span></span> violation: <span class="hljs-number"><span class="hljs-number">7</span></span> :       "users_active_pkey" DETAIL:  "(id)=(3)"  . <span class="hljs-comment"><span class="hljs-comment">------- app:detect-active-users &lt;&lt;&lt; Process 24718 finished . /var/www/pprocess-playground/vendor/mnvx/pprocess/src/AsyncTrait.php:19 /var/www/pprocess-playground/tests/DetectActiveUsersCommandTest.php:19 FAILURES! Tests: 1, Assertions: 1, Failures: 1.</span></span></code> </pre> <br>  In the text of the error, it is clear that again the INSERT is executed in parallel and this leads to undesirable consequences.  Let's try to make a lock at the record level - add a line after the start of the transaction: <br><br><pre> <code class="php hljs">$connection-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT id FROM users_active FOR UPDATE"</span></span>)-&gt;execute();</code> </pre><br>  We start the test - the error is gone.  Our test runs two instances of the process.  Let's increase the number of copies in our test to 3 and see what happens. <br><br><pre> <code class="php hljs">$asnycCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Command( <span class="hljs-string"><span class="hljs-string">'./cli app:detect-active-users'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   dirname(__DIR__), // ,      3 //     );</span></span></code> </pre><br>  And again we have the same error.  What's the matter, we added a lock?  A little thought, you can guess that such a lock will only help if there are entries in the <code>users_active</code> table.  In the case when 3 processes work at the same time, the picture is the following: the first process gets a lock.  The second and third processes are waiting for the completion of the first process transaction.  As soon as the transaction is completed, the second and third processes will continue to run in parallel, with undesirable consequences. <br><br>  To fix it, let's make the lock more common.  For example, <br><br><pre> <code class="php hljs">$connection-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT id FROM users WHERE id IN (3, 5, 6, 10) FOR UPDATE"</span></span>)-&gt;execute();</code> </pre> <br>  Or instead of <code>DELETE</code> we could just use <code>TRUNCATE</code> , which blocks the entire table. <br><br><h3>  Example number three.  Deadlock </h3><br>  It happens that the command itself does not lead to problems, but the simultaneous calling of two different teams working with the same resources leads to problems.  Find the causes of such bugs is not easy.  But if the reason is found, then the test is written exactly to avoid returning the problem in the future when making changes to the code. <br><br>  Let's write a couple of such commands.  This is a classic case of deadlock. <br><br>  The first command first updates the record with id = 1, then with id = 2. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $connection-&gt;beginTransaction(); $connection-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"UPDATE deadlock SET value = value + 1 WHERE id = 1"</span></span>)-&gt;execute(); usleep(<span class="hljs-number"><span class="hljs-number">100000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 0.1 sec $connection-&gt;prepare("UPDATE deadlock SET value = value + 1 WHERE id = 2")-&gt;execute(); $connection-&gt;commit(); $output-&gt;writeln('&lt;info&gt;Completed without deadlocks&lt;/info&gt;'); } catch (\Throwable $e) { $connection-&gt;rollBack(); throw $e; }</span></span></code> </pre> <br>  The second command first updates the record with id = 2, then with id = 1. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $connection-&gt;beginTransaction(); $connection-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"UPDATE deadlock SET value = value + 1 WHERE id = 2"</span></span>)-&gt;execute(); usleep(<span class="hljs-number"><span class="hljs-number">100000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 0.1 sec $connection-&gt;prepare("UPDATE deadlock SET value = value + 1 WHERE id = 1")-&gt;execute(); $connection-&gt;commit(); $output-&gt;writeln('&lt;info&gt;Completed without deadlocks&lt;/info&gt;'); } catch (\Throwable $e) { $connection-&gt;rollBack(); throw $e; }</span></span></code> </pre> <br>  The test will look like this. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mnvx</span></span>\<span class="hljs-title"><span class="hljs-title">PProcess</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">CommandSet</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeadlockCommandTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AsyncTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testImport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $asnycCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandSet( [ <span class="hljs-comment"><span class="hljs-comment">//   './cli app:deadlock-one', './cli app:deadlock-two' ], dirname(__DIR__), // ,      1 //     ); //   $this-&gt;assertAsyncCommands($asnycCommand); } }</span></span></code> </pre> <br>  As a result of the test run, we will see the cause of the error: <br><br><pre> <code class="hljs pgsql">$ ./vendor/bin/phpunit tests/DeadlockCommandTest.php PHPUnit <span class="hljs-number"><span class="hljs-number">6.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Sebastian Bergmann <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> contributors. F <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">100</span></span>%) <span class="hljs-type"><span class="hljs-type">Time</span></span>: <span class="hljs-number"><span class="hljs-number">1.19</span></span> seconds, Memory: <span class="hljs-number"><span class="hljs-number">4.00</span></span>MB There was <span class="hljs-number"><span class="hljs-number">1</span></span> failure: <span class="hljs-number"><span class="hljs-number">1</span></span>) DeadlockCommandTest::testImport Failed asserting that commands ./cli app:deadlock-one, ./cli app:deadlock-two (<span class="hljs-type"><span class="hljs-type">path</span></span>: /var/www/pprocess-playground, count: <span class="hljs-number"><span class="hljs-number">1</span></span>) executed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parallel. Output: &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">5481</span></span> started: ./cli app:deadlock-one &gt;&gt;&gt; Process <span class="hljs-number"><span class="hljs-number">5481</span></span> started: ./cli app:deadlock-two [Doctrine\DBAL\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>\DriverException] An <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> occurred <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> executing <span class="hljs-string"><span class="hljs-string">'UPDATE deadlock SET value = value + 1 WHERE id = 1'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">SQLSTATE</span></span>[<span class="hljs-number"><span class="hljs-number">40</span></span>P01]: Deadlock detected: <span class="hljs-number"><span class="hljs-number">7</span></span> :   DETAIL:  <span class="hljs-number"><span class="hljs-number">5498</span></span>    ShareLock  " 294 738";   <span class="hljs-number"><span class="hljs-number">5499.</span></span>  <span class="hljs-number"><span class="hljs-number">5499</span></span>    ShareLock  " 294737";    <span class="hljs-number"><span class="hljs-number">5498.</span></span> HINT:      . CONTEXT:    (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>)   "deadlock" <span class="hljs-comment"><span class="hljs-comment">------- app:deadlock-two Completed without deadlocks &lt;&lt;&lt; Process 5481 finished &lt;&lt;&lt; Process 5484 finished . /var/www/pprocess-playground/vendor/mnvx/pprocess/src/AsyncTrait.php:39 /var/www/pprocess-playground/tests/DeadlockCommandTest.php:22 FAILURES! Tests: 1, Assertions: 1, Failures: 1.</span></span></code> </pre> <br>  The problem is treated by adding a lock by analogy with the first example.  Either by revising the structure of the database or the algorithm for working with data. <br><br><h3>  We summarize </h3><br>  If the code is executed in parallel, unexpected situations may arise, and if corrected, it is useful to write tests.  We reviewed several of these situations and wrote tests using <a href="https://github.com/mnvx/pprocess">pprocess</a> . </div><p>Source: <a href="https://habr.com/ru/post/327292/">https://habr.com/ru/post/327292/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327280/index.html">Sending voice messages VKontakte using VK API</a></li>
<li><a href="../327282/index.html">Capacity management is another problem.</a></li>
<li><a href="../327284/index.html">New mobile banking on Google Play - now disguised as a flashlight application</a></li>
<li><a href="../327288/index.html">Discussing "The operating systems of the future for the Internet of things": come - it will be interesting</a></li>
<li><a href="../327290/index.html">YUBITSEC CTF: Learn reverse or +925 rating points in a few minutes</a></li>
<li><a href="../327294/index.html">What the front-end developer should be able to do</a></li>
<li><a href="../327296/index.html">Analyzing and comparing your IT product with competitors</a></li>
<li><a href="../327298/index.html">Getting a user is easy</a></li>
<li><a href="../327300/index.html">Creating an application for brain training. Choice of technology and gamification techniques</a></li>
<li><a href="../327302/index.html">How to lead and promote the channel in Telegram - the complete guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>