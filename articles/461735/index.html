<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FFmpeg DXVA2 Hardware Decoding Practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! This article is a continuation of my FFmpeg article getting started with Visual Studio. Here we get down to hardware decoding of the FULL HD RT...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FFmpeg DXVA2 Hardware Decoding Practice</h1><div class="post__text post__text-html js-mediator-article">  Hello!  This article is a continuation of <a href="https://habr.com/ru/post/449198/">my FFmpeg article getting started with Visual Studio.</a>  Here we get down to hardware decoding of the FULL HD RTSP stream.  I will say in advance that even the Intel ATOM Z8350 can easily cope with this task. <br><br>  <b>Objective:</b> hardware decoding and recording up to 4 frames in RAM for subsequent parallel processing (four processor cores) from an RTSP h.264 IP camera.  I display the processed frames using the WinAPI functions.  As a result, we get a high-speed system for computer processing of the RTSP stream in parallel mode.  Next, you can connect the <b>computer vision</b> algorithms for processing <b>Real Time</b> frames. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wd/bc/j2/wdbcj2te4ze6ezmd1_ap8lhxtv4.png" alt="image"></div><br><h4>  Introduction </h4><br>  Why do I need hardware decoding?  Do you want to decode real-time video with a weak and cheap processor or you want to unload the processor as much as possible, then it's time to get acquainted with hardware decoding. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>DirectX Video Acceleration</b> (DXVA) is an API for using hardware acceleration to accelerate video processing with GPUs.  DXVA 2.0 allows you to redirect more operations to the GPU, including video capture and video processing operations. <br><a name="habracut"></a><br>  After writing the previous article, I was asked quite a few questions: ‚Äúwhy is it used FFmpeg?‚Äù I'll start with the problems.  The main difficulty of hardware decoding is to write the decoded frame to RAM.  For Full HD, this is 1920 x 1080 x 3 = 6,220,800 bytes.  Even taking into account the fact that the frame is stored in the NV12 format, this is also a lot of 1920 x 1080 x 1.5 = 3 110 400 bytes.  Overwriting 75 MB per second is a serious task for any processor.  To solve this problem, Intel has added SSE 4 commands, which allow you to rewrite data without a processor.  Unfortunately, not all libraries have this implemented.  I have tested the following libraries: <br><br><ol><li>  Ffmpeg </li><li>  VLC </li><li>  Opencv </li></ol><br>  <b>VLC</b> - works with IP cameras through hardware decoding (very low processor load), a primitive RTSP stream player can be built in just 10 lines of code, but receiving decoded frames in RAM takes too much processor time. <br><br>  <b>OpenCV</b> - RTSP uses FFmpeg to work with the stream, so it was decided to work without intermediaries, i.e.  use the FFmpeg library.  In addition, FFmpeg, which is installed by default, is built in OpenCV without hardware decoding. <br><br>  <b>FFmpeg</b> - showed good, in my opinion, results, it works stably.  The only drawback is not implemented working with WEB-cameras for version X86 (X64 seems to allow you to work) in Windows. <br><br><h2>  Hardware video decoding is easy </h2><br>  In fact, hardware decoding using the FFmpeg library is no more complicated than software.  The project settings are the same as for the software implementation, the block diagram remained unchanged. <br><br>  You can display a list of hardware decoding methods supported by FFmpeg. <br><br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">" %s"</span></span>, av_hwdevice_get_type_name(type));</code> </pre> <br>  The first thing we need to do is tell FFmpeg with which hardware decoder you want to decode the video.  In my case, Windows10 + Intel Atom Z8350 leaves only DXVA2: <br><br><pre> <code class="cpp hljs">type = av_hwdevice_find_type_by_name(<span class="hljs-string"><span class="hljs-string">"dxva2"</span></span>);</code> </pre> <br>  You can choose CUDA, D3D11VA, QSV or VAAPI (Linux only) as a hardware decoder.  Accordingly, you should have this hardware solution and FFmpeg should be built with its support. <br><cut></cut><br>  Open the video stream: <br><br><pre> <code class="cpp hljs">avformat_open_input(&amp;input_ctx, filename, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br>  We get information about the video stream: <br><br><pre> <code class="cpp hljs">av_find_best_stream(input_ctx, AVMEDIA_TYPE_VIDEO, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, &amp;decoder, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  Allocate memory: <br><br><pre> <code class="cpp hljs">frame = av_frame_alloc(); <span class="hljs-comment"><span class="hljs-comment">//       sw_frame = av_frame_alloc(); //       </span></span></code> </pre> <br>  This function overwrites the decoded file in RAM: <br><br><pre> <code class="cpp hljs">av_hwframe_transfer_data(sw_frame, frame, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><h3>  A bit about the NV12 format </h3><br>  So, we got a frame in the sw_frame structure.  The received frame is stored in NV12 format.  This format was invented by Microsoft.  It allows you to store pixel information in 12 bits.  Where 8 bits are the intensity, and 4 bits describe the color (or rather, the color is immediately described for 4 adjacent 2x2 pixels).  Moreover, sw_frame.data [0] - the intensity is stored, and sw_frame.data [1] - the color is stored.  To convert from NV-12 to RGB, you can use the following function: <br><cut></cut><br><div class="spoiler">  <b class="spoiler_title">C ++ translation from NV12 to RGB</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * f1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * f2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iFrame)</span></span></span><span class="hljs-function"> </span></span>{ FILE *pFile; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> szFilename[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, i, j; <span class="hljs-comment"><span class="hljs-comment">// char buff[1920 * 1080 * 3]; uint8_t *buff = new uint8_t(1920*3*2); int u=0, v=0, y=0; // Open file sprintf(szFilename, "frame%d.ppm", iFrame); pFile = fopen(szFilename, "wb"); if (pFile == NULL) return; //    fprintf(pFile, "P6\n%d %d\n255\n", 1920, 1080); for (j = 0; j &lt; 1080 / 2; j++) { for (i = 0; i &lt; 1920; i +=2) { // 1  rgb y = *(f1 + j * 1920 * 2 + i); v = *(f2 + j * 1920 + i) - 128; u = *(f2 + j * 1920 + i + 1) - 128; x = round(y + 1.370705 * v); if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; // if (j &gt; 34) printf("%i, ",(j * 1920 * 2 + i) * 3); buff[i * 3 + 2] = x; x = round(y - 0.698001 * v - 0.337633 * u); if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[i * 3 + 1] = x; x = round(y + 1.732446 * u); if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[i * 3] = x; // 2  rgb y = *(f1 + j * 1920 * 2 + i + 1); x = y + 1.370705 * v; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[i * 3 + 5] = x; x = y - 0.698001 * v - 0.337633 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[i * 3 + 4] = x; x = y + 1.732446 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[i * 3 + 3] = x; // 3  rgb y = *(f1 + j * 1920 * 2 + 1920 + i); x = y + 1.370705 * v; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 2] = x; x = y - 0.698001 * v - 0.337633 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 1] = x; x = y + 1.732446 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 0] = x; // 4  rgb y = *(f1 + j * 1920 * 2 + 1920 + i + 1); x = y + 1.370705 * v; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 5] = x; x = y - 0.698001 * v - 0.337633 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 4] = x; x = y + 1.732446 * u; if (x &lt; 0) x = 0; if (x &gt; 255) x = 255; buff[(1920 + i) * 3 + 3] = x; // printf("%i, ", i); } // for i fwrite(buff, 1, 1920 * 3 * 2, pFile); printf("\n %i\n", j); } // for j // printf("Save4\n"); // Write pixel data // fwrite(buff, 1, 1920*1080*3, pFile); // Close file printf("close\n"); fclose(pFile); printf("exit\n"); delete buff; // return; }</span></span></code> </pre><br></div></div><br>  Although working with NV12 allows you to speed up the implementation of procedures such as blurring, Retinex and obtaining images in grayscale (just by discarding the color).  In my tasks, I do not translate the NV12 format to RGB, as this takes extra time. <br><br>  And so we learned how to decode video files in hardware and display them in a window.  We met in NV12 format and how to convert it to familiar RGB. <br><br><h3>  Dll hardware decoding </h3><br>  FFmpeg issues frames after 40 ms (at 25 frames per second).  As a rule, processing a Full HD frame takes significantly longer.  This requires multithreading to maximize the load of all 4 processor cores.  In practice, I start 6 threads once and do not remove them anymore, which greatly simplifies the work and increases the reliability of the program.  The operation scheme is shown in Fig.  one <br><br><img src="https://habrastorage.org/webt/zy/pd/27/zypd27dsdmasmsc6g2yeyy3u8iu.png" alt="image"><br>  <i>Fig. 1 Scheme of building a multithreaded program with FFmpeg</i> <br><br>  I wrote my decoder as <b>* .dll</b> (FFmpegD.DLL) for inclusion in my projects.  This allows you to reduce the code of the project, which increases the understanding of the code and include it in any programming language, up to Assembler (verified :)).  Using it, we will write our RTSP stream player from the IP camera. <br><br>  To start working with a DLL, you need to pass a pointer to an int [13] array, a HANDLE of a new frame arrival event, a HANDLE to start processing a new data packet from the camera, and a char array of the camera address. <br><br>  The array structure is given in table 1. <br><br><img src="https://habrastorage.org/webt/ds/g7/mq/dsg7mqh4ioarsp5mi9uio98k-yi.png" alt="image"><br><br>  Before calling, you must reset the frame numbers 1-4. <br><br>  The DLL will take all necessary steps to initialize FFmpeg and will record pointers and frame numbers.  After it sets the event ‚ÄúNew frame arrival‚Äù.  It is only necessary to process the incoming frames and write 0 instead of the frame number (this means the frame has been processed and is no longer used). <br><br>  Below you will find an example player with source code.  The example is ShowDib3 Charles Petzold. <br><br>  ‚Üí <a href="">Archive with the project</a> <br>  ‚Üí <a href="">FFmpegD.dll archive</a> <br><br>  <b>RESULTS:</b> FFmpeg hardware motion detector even on Intel Atom Z8350 decodes h264 Full HD in real time with processor loading up to 20% with a connected motion detector. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2I1hL9g8LqY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>Motion Detector Operation Example on Intel ATOM Z8350.</i>  <i>The first 30 seconds is the calculation of the background.</i>  <i>After that, the motion detector works by the method of subtracting the background.</i> <br><br>  <b>PS</b> You can also decode video files (compressed h.264) !!! <br><br>  References: <br><br><ol><li>  <a href="https://trac.ffmpeg.org/wiki">Miscellaneous useful information on FFmpeg</a> </li><li>  <a href="https://ffmpeg.org/doxygen/4.1/index.html">Information on using various libraries provided by FFmpeg</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/YUV">Information on formats and conversion to RGB</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/461735/">https://habr.com/ru/post/461735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461725/index.html">DataGrip 2019.2: Connection management, data search, filtering in navigation</a></li>
<li><a href="../461727/index.html">Cisco Small Business Solutions: A Good Network Is Not Necessarily Costly</a></li>
<li><a href="../461729/index.html">Using jailbreak to extract data: risks and consequences</a></li>
<li><a href="../46173/index.html">Chinese cybercafes forcibly translate to Linux</a></li>
<li><a href="../461733/index.html">Learning English: 9 American-style idioms</a></li>
<li><a href="../461737/index.html">We collect the environment for modern TDD on JavaScript + VS code</a></li>
<li><a href="../461739/index.html">Backend United 4: Okroshka. Incidents</a></li>
<li><a href="../461741/index.html">Hierarchical clustering of categorical data in R</a></li>
<li><a href="../461743/index.html">Security Week 31: VLC vulnerability and broken phone</a></li>
<li><a href="../461745/index.html">Russian black market prices for breaking through personal data (plus a response to Tinkoff Bank's answer)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>