<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with sockets in Cach√© DBMS. An example of the implementation of the server side of the protocol WebSocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cach√© DBMS for communicating via TCP / IP with remote processes via sockets provides low-level commands , which can be a challenge for beginners. 

 I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with sockets in Cach√© DBMS. An example of the implementation of the server side of the protocol WebSocket</h1><div class="post__text post__text-html js-mediator-article">  Cach√© DBMS for communicating via TCP / IP with remote processes via sockets provides low-level <a href="">commands</a> , which can be a challenge for beginners. <br><br>  Is it possible to use sockets ‚Äúdifferently‚Äù without losing the flexibility, speed and convenience of development? <br><br><a name="habracut"></a><br>  Of course, there is: it is enough to write an object wrapper around existing commands of <b>open</b> , <b>use</b> , <b>close</b> , etc.  In terms of OOP, this is <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25BA%25D0%25B0%25D0%25BF%25D1%2581%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">encapsulation</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, such a class, even classes - one for the server part and one for the client part - have already been written and are delivered at least with the Cach√© version 5.2, namely: <br><habracut><br><ul><li>  <a href="">% IO.ServerSocket</a> - to work on the server side; </li><li>  <a href="">% IO.Socket</a> - for work on the client side; </li></ul><br>  Consider two simple examples with their use. <br><br><h4>  Example ‚Ññ1 </h4><br><h5>  Server side code </h5><br> <code><font color="#0000ff">#dim</font> <font color="#000000">sock</font> <font color="#0000ff">As</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">=</font> <font color="#000080">##class</font> <font color="#000000">(</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">).</font> <font color="#0000ff">%New</font> <font color="#000000">() <br></font> <font color="#0000ff">set</font> <font color="#000000">sock.</font> <font color="#0000ff">TranslationTable</font> <font color="#000000">=</font> <font color="#008000">"UTF8" <br> <br></font> <font color="#0000ff">write</font> <font color="#000000">#,</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br> <br></font> <font color="#008000">#; : pPort, pTimeout, pSC <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Open</font> <font color="#000000">(7001, 1, .sc) <br> <br></font> <font color="#0000ff">if $$$ISOK</font> <font color="#000000">(sc)</font> <font color="#800080">{ <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Listen</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">do</font> <font color="#800080">{ <br></font> <font color="#008000">#; : pMaxReadLen, pTimeout <br></font> <font color="#0000ff">set</font> <font color="#000000">s=sock.</font> <font color="#0000ff">ReadAny</font> <font color="#000000">(250, 5) <br></font> <font color="#0000ff">write</font> <font color="#000000">s,! <br> <br></font> <font color="#008000">#; : pData, pFlush <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#0000ff">$$$FormatText</font> <font color="#000000">(</font> <font color="#008000">"   %1"</font> <font color="#000000">,</font> <font color="#0000ff">$$$quote</font> <font color="#000000">(s)),</font> <font color="#0000ff">$$$YES</font> <font color="#000000">) <br></font> <font color="#800080">}</font> <font color="#0000ff">while</font> <font color="#000000">(s'=</font> <font color="#008000">"bye!"</font> <font color="#000000">) <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Close</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br></font> <font color="#800080">}</font></code> <br> <br><h5>  Client Code </h5><br> <code><font color="#0000ff">#dim</font> <font color="#000000">sock</font> <font color="#0000ff">As</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">=</font> <font color="#000080">##class</font> <font color="#000000">(</font> <font color="#008080">%IO.Socket</font> <font color="#000000">).</font> <font color="#0000ff">%New</font> <font color="#000000">() <br></font> <font color="#0000ff">set</font> <font color="#000000">sock.</font> <font color="#0000ff">TranslationTable</font> <font color="#000000">=</font> <font color="#008000">"UTF8" <br> <br></font> <font color="#0000ff">write</font> <font color="#000000">#,</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br> <br></font> <font color="#008000">#; : pHost, pPort, pTimeout, pSC <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Open</font> <font color="#000000">(</font> <font color="#008000">"127.0.0.1"</font> <font color="#000000">,</font> <font color="#008000">"7001"</font> <font color="#000000">,1,.sc) <br> <br></font> <font color="#0000ff">if $$$ISOK</font> <font color="#000000">(sc)</font> <font color="#800080">{ <br> <br></font> <font color="#008000">#; : pData, pFlush <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#008000">"  "</font> <font color="#000000">,</font> <font color="#0000ff">$$$YES</font> <font color="#000000">) <br> <br></font> <font color="#008000">#; : pMaxReadLen, pTimeout <br></font> <font color="#0000ff">write</font> <font color="#000000">sock.</font> <font color="#0000ff">ReadAny</font> <font color="#000000">(250, 5),! <br> <br></font> <font color="#0000ff">hang</font> <font color="#000000">2 <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#008000">"bye!"</font> <font color="#000000">,</font> <font color="#0000ff">$$$YES</font> <font color="#000000">) <br></font> <font color="#0000ff">write</font> <font color="#000000">sock.</font> <font color="#0000ff">ReadAny</font> <font color="#000000">(250, 5),! <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Close</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br></font> <font color="#800080">}</font></code> <br> <ul><li>  Server Results: <br><pre> <code class="hljs erlang-repl"> ...    bye!  ...</code> </pre> </li><li>  Results on the client: <br><pre> <code class="hljs erlang"> ...    <span class="hljs-string"><span class="hljs-string">"  "</span></span>    <span class="hljs-string"><span class="hljs-string">"bye!"</span></span>  ...</code> </pre> </li></ul><br>  To dwell in detail on an example does not make sense, since everything is quite transparent. <br>  I will note only that when receiving the stop line " <b>bye!</b> " From the client side, the server part completes its work. <br><br><h4>  Example 2 </h4><br>  Code: <br><br> <code><font color="#000080">Class demo.socket Extends %RegisteredObject <br></font> <font color="#000000">{ <br> <br></font> <font color="#000080">ClassMethod</font> <font color="#000000">Server2() <br> { <br></font> <font color="#008000">#; do ##class(demo.socket).Server2() <br> <br></font> <font color="#0000ff">#dim</font> <font color="#000000">sock</font> <font color="#0000ff">As</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">=</font> <font color="#000080">##class</font> <font color="#000000">(</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">).</font> <font color="#0000ff">%New</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#000000">#,</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Open</font> <font color="#000000">(10081, 1, .sc) <br> <br></font> <font color="#0000ff">if $$$ISOK</font> <font color="#000000">(sc)</font> <font color="#800080">{ <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Listen</font> <font color="#000000">(-1, .sc) <br> <br></font> <font color="#0000ff">do</font> <font color="#800080">{ <br></font> <font color="#0000ff">set</font> <font color="#000000">s=sock.</font> <font color="#0000ff">ReadAny</font> <font color="#000000">(</font> <font color="#0000ff">$$$MaxLocalLength</font> <font color="#000000">,, .sc) <br></font> <font color="#0000ff">write</font> <font color="#000000">s,! <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(s,</font> <font color="#0000ff">$$$YES</font> <font color="#000000">, .sc) <br></font> <font color="#800080">}</font> <font color="#0000ff">while</font> <font color="#000000">(s'=</font> <font color="#008000">"bye!"</font> <font color="#000000">) <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Close</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br></font> <font color="#800080">} <br></font> <font color="#000000">} <br> <br></font> <font color="#000080">ClassMethod</font> <font color="#000000">Client2(</font> <font color="#ff00ff">end</font> <font color="#000080">As %Boolean</font> <font color="#000000">= {</font> <font color="#0000ff">$$$NO</font> <font color="#000000">}) <br> { <br></font> <font color="#008000">#; do ##class(demo.socket).Client2(1) <br> <br></font> <font color="#0000ff">#dim</font> <font color="#000000">sock</font> <font color="#0000ff">As</font> <font color="#008080">%IO.ServerSocket</font> <font color="#000000">=</font> <font color="#000080">##class</font> <font color="#000000">(</font> <font color="#008080">%IO.Socket</font> <font color="#000000">).</font> <font color="#0000ff">%New</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#000000">#,</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Open</font> <font color="#000000">(</font> <font color="#008000">"127.0.0.1"</font> <font color="#000000">,</font> <font color="#008000">"10081"</font> <font color="#000000">,1,.sc) <br> <br></font> <font color="#0000ff">if $$$ISOK</font> <font color="#000000">(sc)</font> <font color="#800080">{ <br> <br></font> <font color="#0000ff">set</font> <font color="#000000">time=</font> <font color="#0000ff">$zhorolog <br> <br> for</font> <font color="#000000">i=1:1:10</font> <font color="#800080">{ <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#008000">"1234567890"</font> <font color="#000000">,</font> <font color="#0000ff">$$$YES</font> <font color="#000000">, .sc) <br></font> <font color="#0000ff">set</font> <font color="#000000">s=sock.</font> <font color="#0000ff">ReadAny</font> <font color="#000000">(</font> <font color="#0000ff">$$$MaxLocalLength</font> <font color="#000000">,, .sc) <br></font> <font color="#0000ff">write</font> <font color="#000000">s,! <br></font> <font color="#800080">} <br> <br></font> <font color="#0000ff">write</font> <font color="#008000">"= "</font> <font color="#000000">,</font> <font color="#0000ff">$zhorolog</font> <font color="#000000">-time,</font> <font color="#008000">" ."</font> <font color="#000000">,! <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">:end sock.</font> <font color="#0000ff">Write</font> <font color="#000000">(</font> <font color="#008000">"bye!"</font> <font color="#000000">,</font> <font color="#0000ff">$$$YES</font> <font color="#000000">, .sc) <br> <br></font> <font color="#0000ff">do</font> <font color="#000000">sock.</font> <font color="#0000ff">Close</font> <font color="#000000">() <br> <br></font> <font color="#0000ff">write</font> <font color="#008000">" ..."</font> <font color="#000000">, ! <br></font> <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{ <br></font> <font color="#0000ff">write $system</font> <font color="#008080">.Status</font> <font color="#000000">.</font> <font color="#0000ff">GetErrorText</font> <font color="#000000">(sc,</font> <font color="#008000">"ru"</font> <font color="#000000">),! <br></font> <font color="#800080">} <br></font> <font color="#000000">} <br> <br> }</font></code> <br> <br><h4>  Example of the implementation of the server part to support the protocol WebSocket </h4><br>  The two examples above are quite simple, since the server part allowed only one client connection to be processed at a time. <br><br>  What if we need to handle tens / hundreds of client connections at the same time? <br>  To do this, use the <b>% IO.ServerSocket</b> method <b>: ListenJob ()</b> <br><br>  Let's write an example more complicated, for example, add support for the WebSocket protocol to the Cach√© DBMS. <br><br>  This will be especially true, given that Cach√© DBMS provides web application creation technology ( <a href="">CSP</a> ), and also has a ready-made framework with a rich set of visual, MVC and other components ( <a href="">ZEN</a> ). <br><br>  And remembering that Cach√©, in addition to supporting OOP and SQL, can also act as NoSQL storage ... <br><br>  Much has been written about the <a href="http://ru.wikipedia.org/wiki/WebSocket">WebSocket</a> protocol on the Internet.  Based on it, they write chats, online games and everything that requires fast data exchange with the server (database). <br>  I note that our demo will support only two versions of the protocol: 76 and 7. <br><br>  For the tests, we need one of the modern browsers that have WebSocket support. <br>  For older browsers, such as IE 8, you can use a special <a href="https://github.com/gimite/web-socket-js">plugin</a> that runs on top of Flash. <br><br>  Technical details of the implementation of the protocol can be found in the source at the end of the article <br><br>  Here we consider only a small example that implements the simplest web chat. <br><blockquote>  Note: The source code for implementing the WebSocket protocol in Cach√© ObjectScript is for informational purposes only. </blockquote><br>  So: <br><ol><li>  in <a href="">Studio,</a> import the project into an area with customized web application support, for example, ‚ÄúSAMPLES‚Äù; </li><li>  create your server-side event handler class, <b>inherit</b> from the <b>net.WebSocketEvents</b> class <b>,</b> and redefine the corresponding methods in it. <br><br>  For example: <br><br> <code><font color="#000080">///     . <br> Class demo.Server Extends net.WebSocketEvents <br></font> <font color="#000000">{ <br> <br></font> <font color="#000080">///   onbeforeconnect. <br> /// &lt;br&gt;        . <br> Method</font> <font color="#000000">onbeforeconnect()</font> <font color="#000080">As %Boolean <br></font> <font color="#000000">{ <br></font> <font color="#0000ff">set</font> <font color="#000000">^tmp(</font> <font color="#0000ff">$i</font> <font color="#000000">(^tmp),</font> <font color="#008000">"onbeforeconnect"</font> <font color="#000000">)=</font> <font color="#0000ff">$lb</font> <font color="#000000">(..</font> <font color="#0000ff">WebSocketGET</font> <font color="#000000">,..</font> <font color="#0000ff">WebSocketHost</font> <font color="#000000">,..</font> <font color="#0000ff">WebSocketOrigin</font> <font color="#000000">,..</font> <font color="#0000ff">WebSocketVer</font> <font color="#000000">) <br></font> <font color="#0000ff">q $$$YES <br></font> <font color="#000000">} <br> <br></font> <font color="#000080">///   onconnect. <br> Method</font> <font color="#000000">onconnect() <br> { <br></font> <font color="#0000ff">set</font> <font color="#000000">^tmp(</font> <font color="#0000ff">$i</font> <font color="#000000">(^tmp),</font> <font color="#008000">"onconnect"</font> <font color="#000000">)=</font> <font color="#008000">"" <br></font> <font color="#000000">} <br> <br></font> <font color="#000080">///   onmessage. <br> /// &lt;br&gt; : <br> /// &lt;br&gt;&lt;var&gt;msg&lt;/var&gt; - ,   . <br> Method</font> <font color="#000000">onmessage(</font> <font color="#ff00ff">msg</font> <font color="#000080">As %String</font> <font color="#000000">) <br> { <br></font> <font color="#0000ff">set</font> <font color="#000000">^tmp(</font> <font color="#0000ff">$i</font> <font color="#000000">(^tmp),</font> <font color="#008000">"onmessage"</font> <font color="#000000">)=msg <br> <br></font> <font color="#008000">#;                . <br> <br> /* <br> <br> do ..send("Cach√©asd"_$random(1000)):msg="get", <br> ..send($replace($j("",32000)," ","√©")):msg="getBig", <br> ..sendBroadcast("from Cach√© to All"):msg="toAll", <br> ..sendBroadcast($$$FormatText(" : %1",$$$quote($p(msg,"^",2)))):$e(msg)="^" <br> <br> */ <br> <br></font> <font color="#0000ff">if</font> <font color="#000000">msg=</font> <font color="#008000">"get"</font> <font color="#800080">{ <br></font> <font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">send</font> <font color="#000000">(</font> <font color="#008000">"Cach√©asd"</font> <font color="#000000">_</font> <font color="#0000ff">$random</font> <font color="#000000">(1000)) <br></font> <font color="#800080">}</font> <font color="#0000ff">elseif</font> <font color="#000000">msg=</font> <font color="#008000">"getBig"</font> <font color="#800080">{ <br></font> <font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">send</font> <font color="#000000">(</font> <font color="#0000ff">$replace</font> <font color="#000000">(</font> <font color="#0000ff">$j</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,32000),</font> <font color="#008000">" "</font> <font color="#000000">,</font> <font color="#008000">"√©"</font> <font color="#000000">)) <br></font> <font color="#800080">}</font> <font color="#0000ff">elseif</font> <font color="#000000">msg=</font> <font color="#008000">"toAll"</font> <font color="#800080">{ <br></font> <font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">sendBroadcast</font> <font color="#000000">(</font> <font color="#008000">"from Cach√© to All"</font> <font color="#000000">) <br></font> <font color="#800080">}</font> <font color="#0000ff">elseif $e</font> <font color="#000000">(msg)=</font> <font color="#008000">"^"</font> <font color="#800080">{ <br></font> <font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">sendBroadcast</font> <font color="#000000">(</font> <font color="#0000ff">$$$FormatText</font> <font color="#000000">(</font> <font color="#008000">" : %1"</font> <font color="#000000">,</font> <font color="#0000ff">$$$quote</font> <font color="#000000">(</font> <font color="#0000ff">$p</font> <font color="#000000">(msg,</font> <font color="#008000">"^"</font> <font color="#000000">,2)))) <br></font> <font color="#800080">} <br></font> <font color="#000000">} <br> <br></font> <font color="#000080">///   onclose. <br> Method</font> <font color="#000000">onclose() <br> { <br></font> <font color="#0000ff">set</font> <font color="#000000">^tmp(</font> <font color="#0000ff">$i</font> <font color="#000000">(^tmp),</font> <font color="#008000">"onclose"</font> <font color="#000000">)=</font> <font color="#008000">"" <br></font> <font color="#000000">} <br> <br> }</font></code> </li> <li>  If you use a plugin that uses Flash (see above), then pre-install the latest version of Flash Player, which can be downloaded <a href="http://techdows.com/2011/10/flash-player-11-offline-installer.html">from here</a> . <br><blockquote>  Note: Do not forget to enable WebSocket in browsers in which they are disabled by default, for example in Opera. </blockquote></li><li>  Launch the WebSocket connection processing daemon on the server: <pre> <code class="hljs pgsql">SAMPLES&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(net.WebSocketServer).<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>("demo.Server")</code> </pre> </li><li>  launch in your browser, for example, FireFox, the <b>demo.webclient</b> page (class), the source code of which is the following: <br><br> <code><a href="http://www.intersystems.com/zen%2522%25C2%25A0"></a> <a href="http://www.intersystems.com/zen%2522%25C2%25A0"></a> <font color="#000080">Class demo.webclient Extends %ZEN.Component.page <br></font> <font color="#000000">{ <br> <br></font> <font color="#000080">/// If true, then attempt to refresh this page when its session timeout period has expired. <br> /// This will cause a login page to display if the current session has ended <br> /// and security is set to require login. <br> Parameter</font> <font color="#000000">AUTOLOGOUT</font> <font color="#000080">As</font> <font color="#000000">BOOLEAN =</font> <font color="#000080">0</font> <font color="#000000">; <br> <br></font> <font color="#000080">/// Comma-separated list of additional JS include files for the page. <br> Parameter</font> <font color="#000000">JSINCLUDES</font> <font color="#000080">As</font> <font color="#000000">STRING =</font> <font color="#800080">"websocket/swfobject.js,websocket/web_socket.js"</font> <font color="#000000">; <br> <br></font> <font color="#000080">XData</font> <font color="#000000">Contents [</font> <font color="#000080">XMLNamespace</font> <font color="#000000">=</font> <font color="#800080">"www.intersystems.com/zen"</font> <font color="#000000">] <br> { <br> &lt;</font> <font color="#000080">page</font> <font color="#800000">xmlns</font> <font color="#000000">=</font> <font color="#008000">"www.intersystems.com/zen"</font> <font color="#800000">title</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">&gt; <br> &lt;</font> <font color="#000080">vgroup</font> <font color="#800000">labelPosition</font> <font color="#000000">=</font> <font color="#008000">"left"</font> <font color="#000000">&gt; <br> &lt;</font> <font color="#000080">label</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#008000">"lb"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">" :"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">text</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#008000">"usr"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">":"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"zenPage.start();"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">" 1"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">"Hello123xcf789"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"ws.send('Hello123xcf789');"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">" 2"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">"toAll"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"ws.send('toAll');"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">" 3"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">"get"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"ws.send('get');"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">" 4"</font> <font color="#800000">label</font> <font color="#000000">=</font> <font color="#008000">"getBig"</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"ws.send('getBig');"</font> <font color="#000000">/&gt; <br> &lt;</font> <font color="#000080">button</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#800000">onclick</font> <font color="#000000">=</font> <font color="#008000">"ws.close();"</font> <font color="#000000">/&gt; <br> &lt;/</font> <font color="#000080">vgroup</font> <font color="#000000">&gt; <br> &lt;/</font> <font color="#000080">page</font> <font color="#000000">&gt; <br> } <br> <br></font> <font color="#000080">ClientMethod</font> <font color="#000000">start() [</font> <font color="#000080">Language</font> <font color="#000000">= javascript ] <br> { <br> ws</font> <font color="#000080">=</font> <font color="#800000">new</font> <font color="#000000">WebSocket(</font> <font color="#800000">"ws://127.0.0.1:10081/asd s HTTP/1.1///"</font> <font color="#000000">); <br> ws.onopen</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">() { <br> zenSetProp(</font> <font color="#800000">'lb'</font> <font color="#000000">,</font> <font color="#800000">'value'</font> <font color="#000000">,</font> <font color="#800000">'open'</font> <font color="#000000">); <br> ws.send(</font> <font color="#800000">'^'</font> <font color="#000080">+</font> <font color="#000000">zenGetProp(</font> <font color="#800000">'usr'</font> <font color="#000000">,</font> <font color="#800000">'value'</font> <font color="#000000">)); <br> }; <br> ws.onmessage</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">(e) { <br> zenAlert(</font> <font color="#800000">'onmessage'</font> <font color="#000000">,</font> <font color="#800000">' length='</font> <font color="#000000">,e.data.length,</font> <font color="#800000">' data='</font> <font color="#000000">,e.data); <br> }; <br> ws.onclose</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">() { <br> zenSetProp(</font> <font color="#800000">'lb'</font> <font color="#000000">,</font> <font color="#800000">'value'</font> <font color="#000000">,</font> <font color="#800000">'close'</font> <font color="#000000">); <br> }; <br> ws.onerror</font> <font color="#000080">=</font> <font color="#008080">function</font> <font color="#000000">() { <br> zenAlert(</font> <font color="#800000">'onerror'</font> <font color="#000000">); <br> }; <br> } <br> <br></font> <font color="#000080">/// This client event, if present, is fired when the page is loaded. <br> ClientMethod</font> <font color="#000000">onloadHandler() [</font> <font color="#000080">Language</font> <font color="#000000">= javascript ] <br> { <br></font> <font color="#008000">// Let the library know where WebSocketMain.swf is: <br></font> <font color="#000000">WEB_SOCKET_SWF_LOCATION</font> <font color="#000080">=</font> <font color="#800000">"websocket/WebSocketMain.swf"</font> <font color="#000000">; <br> WEB_SOCKET_DEBUG</font> <font color="#000080">=</font> <font color="#000000">false; <br> } <br> <br> }</font></code> </li> <li>  Press the "Start" button first.  If the connection of the browser to the Cach√© DBMS is successful, then you will see the status ‚Äúopen‚Äù. <br>  If there is no connection, then check the <a href="https://github.com/gimite/web-socket-js">Troubleshooting</a> section.  On the local machine, everything should work without problems. </li><li>  when the connection is successfully established, you can try different tests - in the example there are four of them - in any order. </li><li>  At the end of the test, do not forget to press the ‚ÄúStop‚Äù button. </li><li>  Try running multiple browsers and repeat steps 6-8. </li></ol><br>  Let's look at the contents of the log on the server: <br><ul><li>  Firefox 12 <br><pre> <code class="hljs perl">USER&gt;zw ^tmp ^tmp=<span class="hljs-number"><span class="hljs-number">8</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"onbeforeconnect"</span></span>)=$lb(<span class="hljs-string"><span class="hljs-string">"/asd%20s%20HTTP/1.1///"</span></span>,<span class="hljs-string"><span class="hljs-string">"127.0.0.1:10081"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"hybi-10"</span></span>) ^tmp(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"onconnect"</span></span>)=<span class="hljs-string"><span class="hljs-string">""</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">"onmessage"</span></span>)=<span class="hljs-string"><span class="hljs-string">"^sdsdf"</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-string"><span class="hljs-string">"onmessage"</span></span>)=<span class="hljs-string"><span class="hljs-string">"Hello123xcf789"</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">"onmessage"</span></span>)=<span class="hljs-string"><span class="hljs-string">"toAll"</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-string"><span class="hljs-string">"onmessage"</span></span>)=<span class="hljs-string"><span class="hljs-string">"get"</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-string"><span class="hljs-string">"onmessage"</span></span>)=<span class="hljs-string"><span class="hljs-string">"getBig"</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-string"><span class="hljs-string">"onclose"</span></span>)=<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> </li><li>  IE 9 <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;zw ^tmp ^tmp=<span class="hljs-number"><span class="hljs-number">8</span></span> ^tmp(<span class="hljs-number"><span class="hljs-number">1</span></span>,"onbeforeconnect")=$lb("/asd s HTTP/1.1///","127.0.0.1:10081","","hybi-10") ^tmp(<span class="hljs-number"><span class="hljs-number">2</span></span>,"onconnect")="" ^tmp(<span class="hljs-number"><span class="hljs-number">3</span></span>,"onmessage")="^dfg" ^tmp(<span class="hljs-number"><span class="hljs-number">4</span></span>,"onmessage")="Hello123xcf789" ^tmp(<span class="hljs-number"><span class="hljs-number">5</span></span>,"onmessage")="toAll" ^tmp(<span class="hljs-number"><span class="hljs-number">6</span></span>,"onmessage")="get" ^tmp(<span class="hljs-number"><span class="hljs-number">7</span></span>,"onmessage")="getBig" ^tmp(<span class="hljs-number"><span class="hljs-number">8</span></span>,"onclose")=""</code> </pre> </li></ul><br><h4>  Using the secure <b><i><u>wss</u></i></b> protocol instead of <b>ws</b> </h4><br>  For this you will need: <br><ol><li>  set up a SSL server configuration in the <a href="">Portal</a> with the name, for example, <b>WebSocketSSL</b> and set the " <font color="green"><b>Peer certificate verification level</b></font> " to " <font color="green"><b>None</b></font> ". <br><blockquote>  Note: Details on setting up SSL in Cach√© DBMS can be found in one of the previous <a href="http://habrahabr.ru/company/intersystems/blog/144310/">articles in</a> this blog. </blockquote></li><li>  When starting the WebSocket daemon, you need to specify our SSL configuration: <pre> <code class="hljs pgsql">SAMPLES&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(net.WebSocketServer).<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>("demo.Server",,"WebSocketSSL")</code> </pre> </li><li>  If you are using a plugin that uses Flash (see above), then first run the policy file processing daemon on port <b>843</b> : <pre> <code class="hljs kotlin">SAMPLES&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(net.WebSocketServer).StartPolicy()</code> </pre> </li><li>  recompile the <b>demo.webclient</b> class <b>before</b> changing the string <pre>  "ws: //127.0.0.1: 10081 ..." </pre>  on <pre>  "wss: //127.0.0.1: 10081 ..." </pre></li><li>  further see above. </li></ol><br>  As a result, we have a web application, a server part and a database implemented exclusively within the Cach√© DBMS. <br><br>  <a href="http://db.tt/8TaPFjPF">Original project</a> </habracut></div><p>Source: <a href="https://habr.com/ru/post/144311/">https://habr.com/ru/post/144311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144306/index.html">Work with Cach√© DBMS Objects on the Example of Delphi</a></li>
<li><a href="../144307/index.html">So.cl: Microsoft's social search based social network.</a></li>
<li><a href="../144308/index.html">From idea to release. Manifest</a></li>
<li><a href="../144309/index.html">SASS vs. LESS</a></li>
<li><a href="../144310/index.html">Work with SSL / TLS in Cach√© DBMS</a></li>
<li><a href="../144312/index.html">Localization in Cach√© DBMS</a></li>
<li><a href="../144313/index.html">Mdday # MoCO - conference for mobile developers</a></li>
<li><a href="../144314/index.html">DARPA peaceful competitions for military use</a></li>
<li><a href="../144317/index.html">Epigraph to perl 5.16.0</a></li>
<li><a href="../144318/index.html">ICANN finally solved the technical problems of the new domain zone application system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>