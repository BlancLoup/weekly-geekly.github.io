<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Details on random and pseudorandom number generators</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© and the network, articles devoted to vulnerabilities in random number generators often began to appear. This topic is extremely extensive and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Details on random and pseudorandom number generators</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© and the network, articles devoted to vulnerabilities in random number generators often began to appear.  This topic is extremely extensive and is one of the main cryptography.  Under the cut is a description of random numbers from A to Z. The article is the result of a free translation of a cycle of articles from one Western blog and personal additions of the author.  The main goal is to get feedback and share knowledge. <br><img src="https://habrastorage.org/getpro/habr/post_images/3dc/c3f/05e/3dcc3f05e7ab5d5fc68c8d72e1d2de7b.jpg" alt="image"><br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Random number generators are a key part of web security.  A small list of applications: <br><ul><li>  Session Generators (PHPSESSID) </li><li>  Generate text for captcha </li><li>  Encryption </li><li>  Salt generation for storing passwords in irreversible form </li><li>  Password generator </li><li>  The procedure for the distribution of cards in online casinos </li></ul><br><br><h4>  How to distinguish a random sequence of numbers from non-random? </h4><br>  Let there be a sequence of numbers: <code>1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9</code> .  Is it random?  There is a strict definition for a random variable.  A random variable is a quantity that as a result of experience takes one of a multitude of values, and the appearance of one or another value of this quantity before its measurement cannot be accurately predicted.  But it does not help to answer our question, because we do not have enough information to answer.  Now let's say that these numbers turned out to be a set of one of the top lines of the keyboard.  ‚ÄúOf course not random‚Äù - exclaim you and immediately call the following number and you will be absolutely right.  The sequence will be random only if there is no dependency between characters.  For example, if these symbols appeared as a result of pulling the kegs into a lotto, the sequence would be random. <br><br><h4>  Slightly more complex example or number Pi </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/096/5ee/61c/0965ee61c195b3ecccc315b32b5c9847.jpg"><br>  The sequence of digits in Pi is considered random.  Let the generator be based on the output bits of the representation of the number Pi, starting from some unknown point.  Such a generator, possibly, will pass the <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2581%25D1%2582_%25D0%25BD%25D0%25B0_%25D1%2581%25D0%25BB%25D0%25B5%25D0%25B4%25D1%2583%25D1%258E%25D1%2589%25D0%25B8%25D0%25B9_%25D0%25B1%25D0%25B8%25D1%2582">‚Äútest for the next bit‚Äù</a> , since the PI, apparently, is a random sequence.  However, this approach is not critically reliable - if the cryptanalyst determines which bit of Pi is currently being used, he will be able to calculate all the preceding and subsequent bits. <br>  This example imposes another restriction on random number generators.  A cryptanalyst should not be able to predict the operation of a random number generator. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The difference between the pseudorandom number generator (PRNG) and the random number generator (PRNG) </h4><br>  The entropy sources are used to accumulate the entropy and then obtain from it the initial value (initial value, seed) needed by the random number generator (RNG) to generate random numbers.  The PRNG uses a single initial value, from which its pseudo-randomness follows, and the RNG always generates a random number, having at the beginning a high-quality random variable provided by various sources of entropy. <br>  Entropy is a measure of disorder.  Informational entropy is a measure of uncertainty or unpredictability of information. <br>  We can say that RNG = PRNG + source of entropy. <br><br><h4>  PRNG vulnerabilities </h4><br><ul><li>  Predictable dependency between numbers. </li><li>  Predictable initial value of the generator. </li><li>  Small period length of the generated sequence of random numbers, after which the generator loops. </li></ul><br><br><h4>  Linear congruent PRNG (LCPRNG) </h4><br>  A common method for generating pseudo-random numbers that does not have cryptographic security.  The linear congruential method consists in calculating the members of a linear recurrent sequence modulo some natural number m given by the following formula: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f3/262/704/0f3262704abb03b2d13d6aa0b10ea14f.png" alt="image"><br><br>  where a (multiplier), c (addend), m (mask) are some integer coefficients.  The resulting sequence depends on the choice of the starting number (seed) X0 and for its different values, different sequences of random numbers are obtained. <br><br>  To select the coefficients, there are properties that allow you to maximize the length of the period (the maximum length is equal to m), that is, the moment from which the generator will cycle around [1]. <br><br>  Let the generator produce several random numbers X0, X1, X2, X3.  It turns out the system of equations <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb8/a51/7d5/eb8a517d59a986ff5e65d05f9a95eaa3.png" alt="image"><br><br>  Having solved this system, we can determine the coefficients a, c, m.  According to Wikipedia <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B3%25D1%2580%25D1%2583%25D1%258D%25D0%25BD%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4">[8]</a> , this system has a solution, but it was not possible to decide on its own or find a solution.  I would be very grateful for any help in this direction. <br><br><h4>  Prediction of results of the linear-congruential method </h4><br>  The main algorithm for predicting numbers for a linearly congruent method is Plumstead's, an implementation that can be found here <a href="http://www.staff.uni-mainz.de/pommeren/Kryptologie/Bitstrom/2_Analyse/LCGcrack.html">[4]</a> (there is an online launch) and here <a href="http://www.staff.uni-mainz.de/pommeren/Kryptologie99/English.html">[5]</a> .  A description of the algorithm can be found in <a href="http://zaic101.ru/files/728/using_linear_congruential_generators_for_cryptographic_purposes.pdf">[9]</a> . <br>  A simple implementation of the congruential method in Java. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">45</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = <span class="hljs-number"><span class="hljs-number">21</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = <span class="hljs-number"><span class="hljs-number">67</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> seed = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ seed = (a * seed + c) % m; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> seed; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>; i++) System.out.println(getRand()); }</code> </pre><br><br>  By sending 20 numbers to the site <a href="http://www.staff.uni-mainz.de/pommeren/Kryptologie/Bitstrom/2_Analyse/lcgc.html">[4]</a> , you can most likely get the following.  The more numbers, the more likely. <br><h4>  Hacking a built-in random number generator in Java </h4><br>  Many programming languages, such as C (rand), C ++ (rand), and Java, use LPRNG.  Consider how you can hack on the example of <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Random.html">java.utils.Random</a> .  Going to the source code (jdk1.7) of this class, you can see the constants used <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> multiplier = <span class="hljs-number"><span class="hljs-number">0x5DEECE66DL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 25214903917 private static final long addend = 0xBL; // 11 private static final long mask = (1L &lt;&lt; 48) - 1; // 281474976710655 = 2^48 ‚Äì 1</span></span></code> </pre><br><br>  The java.utils.Randon.nextInt () method looks like this (here bits == 32) <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bits)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> oldseed, nextseed; AtomicLong seed = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.seed; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { oldseed = seed.get(); nextseed = (oldseed * multiplier + addend) &amp; mask; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!seed.compareAndSet(oldseed, nextseed)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(nextseed &gt;&gt;&gt; (<span class="hljs-number"><span class="hljs-number">48</span></span> - bits)); }</code> </pre><br><br>  The result is the nextseed shifted to the right by 48-32 = 16 bits.  This method is called truncated-bits, which is especially unpleasant when the black-box, you have to add another loop to brute-force.  Hacking will be done by brute-force. <br><br>  Suppose we know two successively generated numbers x1 and x2.  Then you need to go through 2 ^ 16 = 65536 variants of oldseed and apply the formula to x1: <br><br><pre> <code class="java hljs">((x1*multiplier + addend) &amp; mask) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span></code> </pre><br><br>  until it becomes equal to x2.  The code for brute-force might look like this. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Field; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.atomic.AtomicLong; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PasswordCracking</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> multiplier = <span class="hljs-number"><span class="hljs-number">0x5DEECE66DL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> addend = <span class="hljs-number"><span class="hljs-number">0xBL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> mask = (<span class="hljs-number"><span class="hljs-number">1L</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">48</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> v1 = random.nextInt(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> v2 = random.nextInt(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> v3 = random.nextInt(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> v4 = random.nextInt(); System.out.println(<span class="hljs-string"><span class="hljs-string">"v1="</span></span> + v1 + <span class="hljs-string"><span class="hljs-string">"\nv2="</span></span> + v2 + <span class="hljs-string"><span class="hljs-string">"\nv3="</span></span> + v3 + <span class="hljs-string"><span class="hljs-string">"\nv4="</span></span> + v4); <span class="hljs-comment"><span class="hljs-comment">// brute-force seed for (int i = 0; i &lt; 65536; i++) { long seed = (((long) v1) &lt;&lt; 16) + i; int nextInt = (int)(((seed * multiplier + addend) &amp; mask) &gt;&gt;&gt; 16); if (nextInt == v2) { System.out.println("Seed found: " + seed); Random crackingRandom = new Random(); try { /* set the seed for Random to be convinced that we have found the right seed because constructor Random (long seed) uses the private static long initialScramble (long seed) { return (seed ^ multiplier) &amp; mask; } for simplicity will use Reflection */ Field privateSeedField = Random.class.getDeclaredField("seed"); privateSeedField.setAccessible(true); AtomicLong crackingSeed = (AtomicLong)privateSeedField.get(crackingRandom); crackingSeed.set(seed); }catch(Exception e) { System.out.println(e.toString()); System.exit(1); } long cv1 = crackingRandom.nextInt(); long cv2 = crackingRandom.nextInt(); long cv3 = crackingRandom.nextInt(); long cv4 = crackingRandom.nextInt(); System.out.println("Set fiend seed and generate random numbers"); System.out.println("cv1=" + cv1 + "\ncv2=" + cv2 + "\ncv3=" + cv3 + "\ncv4=" + cv4); break; } } } }</span></span></code> </pre><br><br>  The output of this program will be something like this: <br><br><pre> <code class="java hljs">v1 = -<span class="hljs-number"><span class="hljs-number">1184958941</span></span> v2 = <span class="hljs-number"><span class="hljs-number">274285127</span></span> v3 = -<span class="hljs-number"><span class="hljs-number">1566774765</span></span> v4 = <span class="hljs-number"><span class="hljs-number">30466408</span></span> Seed found: -<span class="hljs-number"><span class="hljs-number">77657469128792</span></span> Set fiend seed and generate random numbers cv1 = <span class="hljs-number"><span class="hljs-number">274285127</span></span> cv2 = -<span class="hljs-number"><span class="hljs-number">1566774765</span></span> cv3 = <span class="hljs-number"><span class="hljs-number">30466408</span></span> cv4 = -<span class="hljs-number"><span class="hljs-number">803980434</span></span></code> </pre><br><br>  It is easy to understand that we did not find the very first seed, but the seed used to generate the second number.  To find the original seed, you need to perform several operations that Java used to transform the seed, in the reverse order. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPreviousSeed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> prevSeed)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> seed = prevSeed; <span class="hljs-comment"><span class="hljs-comment">// reverse the addend from the seed seed -= addend; // reverse the addend long result = 0; // iterate through the seeds bits for (int i = 0; i &lt; 48; i++) { long mask = 1L &lt;&lt; i; // find the next bit long bit = seed &amp; mask; // add it to the result result |= bit; if (bit == mask) { // if the bit was 1, subtract its effects from the seed seed -= multiplier &lt;&lt; i; } } System.out.println("Previous seed: " + result); return result; }</span></span></code> </pre><br><br>  And now in the source code replace <br>  crackingSeed.set (seed); <br>  on <br>  crackingSeed.set (getPreviousSeed (seed)); <br><br>  And that's it, we successfully cracked PRNG in Java. <br><br><h4>  Hacking PRNG Mersenne twister in PHP </h4><br>  Consider another non-cryptographic algorithm for generating pseudo-random numbers Mersenne Twister.  The main advantages of the algorithm are the generation rate and a huge period of 2 ^ 19937 - 1. This time we will analyze the implementation of the <a href="http://www.php.net/manual/en/function.mt-srand.php">mt_srand ()</a> and <a href="http://php.net/manual/en/function.mt-rand.php">mt_rand ()</a> algorithm in php version 5.4.6 source code. <br><br><div class="spoiler">  <b class="spoiler_title">Contents of the file /ext/standard/basic_functions.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MT_N (624) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* rand.c */</span></span></span><span class="hljs-meta"> php_uint32 state[MT_N+1]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* state vector + 1 extra to not violate ANSI C */</span></span></span><span class="hljs-meta"> php_uint32 *next; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* next random value is computed from here */</span></span></span><span class="hljs-meta"> int left; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* can *next++ this many times before reloading */</span></span></span><span class="hljs-meta"> unsigned int rand_seed; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Seed for rand(), in ts version */</span></span></span><span class="hljs-meta"> zend_bool rand_is_seeded; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Whether rand() has been seeded */</span></span></span><span class="hljs-meta"> zend_bool mt_rand_is_seeded; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Whether mt_rand() has been seeded */</span></span></span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Content of file / extra/standard/rand.c:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> N MT_N </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* length of state vector */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M (397) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* a period parameter */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> hiBit(u) ((u) &amp; 0x80000000U) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* mask all but highest bit of u */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> loBit(u) ((u) &amp; 0x00000001U) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* mask all but lowest bit of u */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> loBits(u) ((u) &amp; 0x7FFFFFFFU) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* mask the highest bit of u */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> mixBits(u, v) (hiBit(u)|loBits(v)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* move hi bit of u to hi bit of v */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> twist(m,u,v) (m ^ (mixBits(u,v)&gt;&gt;1) ^ ((php_uint32)(-(php_int32)(loBit(u))) &amp; 0x9908b0dfU)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* {{{ php_mt_reload */</span></span></span><span class="hljs-meta"> static inline void php_mt_reload(TSRMLS_D) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Generate N new values in state Made clearer and faster by Matthew Bellew (matthew.bellew@home.com) */</span></span></span><span class="hljs-meta"> register php_uint32 *state = BG(state); register php_uint32 *p = state; register int i; for (i = N - M; i--; ++p) *p = twist(p[M], p[0], p[1]); for (i = M; --i; ++p) *p = twist(p[MN], p[0], p[1]); *p = twist(p[MN], p[0], state[0]); BG(left) = N; BG(next) = state; } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* }}} */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* {{{ php_mt_initialize */</span></span></span><span class="hljs-meta"> static inline void php_mt_initialize(php_uint32 seed, php_uint32 *state) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Initialize generator state with seed See Knuth TAOCP Vol 2, 3rd Ed, p.106 for multiplier. In previous versions, most significant bits (MSBs) of the seed affect only MSBs of the state array. Modified 9 Jan 2002 by Makoto Matsumoto. */</span></span></span><span class="hljs-meta"> register php_uint32 *s = state; register php_uint32 *r = state; register int i = 1; *s++ = seed &amp; 0xffffffffU; for( ; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; N; ++i ) { *s++ = ( 1812433253U * ( *r ^ (*r &gt;&gt; 30) ) + i ) &amp; 0xffffffffU; r++; } } /* }}} */ /* {{{ php_mt_srand */ PHPAPI void php_mt_srand(php_uint32 seed TSRMLS_DC) { /* Seed the generator with a simple uint32 */ php_mt_initialize(seed, BG(state)); php_mt_reload(TSRMLS_C); /* Seed only once */ BG(mt_rand_is_seeded) = 1; } /* }}} */ /* {{{ php_mt_rand */ PHPAPI php_uint32 php_mt_rand(TSRMLS_D) { /* Pull a 32-bit integer from the generator state Every other access function simply transforms the numbers extracted here */ register php_uint32 s1; if (BG(left) == 0) { php_mt_reload(TSRMLS_C); } --BG(left); s1 = *BG(next)++; s1 ^= (s1 &gt;&gt; 11); s1 ^= (s1 &lt;&lt; 7) &amp; 0x9d2c5680U; s1 ^= (s1 &lt;&lt; 15) &amp; 0xefc60000U; return ( s1 ^ (s1 &gt;&gt; 18) ); }</span></span></span></span></code> </pre><br></div></div><br>  You may notice that php_mt_reload is called during initialization and after calling php_mt_rand 624 times.  Start hacking from the end, reversing the transformations at the end of the php_mt_rand () function.  Consider (s1 ^ (s1 &gt;&gt; 18)).  In a binary representation, the operation looks like this: <br><br>  <b>101101110101111001</b> 11111001110010 s1 <br>  00000000000000000010110111010111100111111001110010 s1 &gt;&gt; 18 <br>  <b>101101110101111001</b> 01001110100101 s1 ^ (s1 &gt;&gt; 18) <br>  It can be seen that the first 18 bits (bold) remained unchanged. <br>  Write two functions to invert the bit shift and xor <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unBitshiftRightXor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// we part of the value we are up to (with a width of shift bits) long i = 0; // we accumulate the result here long result = 0; // iterate until we've done the full 32 bits while (i * shift &lt; 32) { // create a mask for this part long partMask = (-1 &lt;&lt; (32 - shift)) &gt;&gt;&gt; (shift * i); // obtain the part long part = value &amp; partMask; // unapply the xor from the next part of the integer value ^= part &gt;&gt;&gt; shift; // add the part to the result result |= part; i++; } return result; } public static long unBitshiftLeftXor(long value, long shift, long mask) { // we part of the value we are up to (with a width of shift bits) long i = 0; // we accumulate the result here long result = 0; // iterate until we've done the full 32 bits while (i * shift &lt; 32) { // create a mask for this part long partMask = (-1 &gt;&gt;&gt; (32 - shift)) &lt;&lt; (shift * i); // obtain the part long part = value &amp; partMask; // unapply the xor from the next part of the integer value ^= (part &lt;&lt; shift) &amp; mask; // add the part to the result result |= part; i++; } return result; }</span></span></code> </pre><br><br>  Then the code to invert the last lines of the php_mt_rand () function will look like this <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> value = output; value = unBitshiftRightXor(value, <span class="hljs-number"><span class="hljs-number">18</span></span>); value = unBitshiftLeftXor(value, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">0xefc60000</span></span>); value = unBitshiftLeftXor(value, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">0x9d2c5680</span></span>); value = unBitshiftRightXor(value, <span class="hljs-number"><span class="hljs-number">11</span></span>);</code> </pre><br><br>  If we have 624 consecutive numbers generated by Mersenne Twister, then applying this algorithm to these consecutive numbers, we get the full Mersenne Twister state, and we can easily determine each subsequent value by running php_mt_reload for a known set of values. <br><br><h4>  Hacking area </h4><br>  If you think that there is nothing to break, then you are deeply mistaken.  One of the interesting directions is the Adobe Flash (Action Script 3.0) random number generator.  Its feature is the closeness of the source code and the absence of the task of the seed.  His main interest is in many online casinos and online poker. <br>  There are many sequences of numbers, ranging from the dollar to the amount of time spent in traffic every day.  And finding a pattern in such data is not an easy task. <br><br><h4>  Distribution job for pseudo-random number generator </h4><br>  For any random variable, you can specify the distribution.  Transferring to the example with cards, you can make aces fall more often than nines.  Below are a few examples for triangular distribution and exponential distribution. <br><br><h5>  Triangular distribution </h5><br>  Let us give an example of generating a random variable with a triangular distribution <a href="http://en.wikipedia.org/wiki/Triangular_distribution">[7]</a> in the language C99. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">triangular</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> U = rand() / (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) RAND_MAX; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> F = (c - a) / (b - a); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (U &lt;= F) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(U * (b - a) * (c - a)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b - <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>((<span class="hljs-number"><span class="hljs-number">1</span></span> - U) * (b - a) * (b - c)); }</code> </pre><br><br>  In this case, we take a random variable rand () and assign it a distribution, based on the triangular distribution function.  For parameters a = -40, b = 100, c = 50, the 10,000,000 measurement graph will look like this <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ce/6a2/ddd/7ce6a2ddd4de7c1b0b85042b2309e3e7.png" alt="image"><br><br><h4>  Exponential distribution </h4><br>  Suppose you want to get a sensor of exponentially distributed random variables.  In this case, F (x) = 1 - exp (-lambda * x).  Then from the solution of the equation y = 1 - exp (-lambda * x) we get x = -log (1-y) / lambda. <br>  You can see that the expression under the sign of the logarithm in the last formula has a uniform distribution on the interval [0,1), which allows you to get another, but also distributed sequence by the formula: x = -log (y) / lambda, where y is a random variable (rand ()). <br><br><h4>  PRNG tests </h4><br>  Some developers believe that if they hide the generation method they use or invent their own, then this is enough for protection.  This is a very common misconception.  It should be remembered that there are special methods and techniques for finding dependencies in a sequence of numbers. <br><br>  One of the known tests is the test for the next bit - a test that serves to test pseudo-random number generators for cryptographic resistance.  The test says that there should not be a polynomial algorithm that, knowing the first k bits of a random sequence, can predict k + 1 bits with a probability greater than ¬Ω. <br><br>  In cryptography theory, a separate problem is the determination of how random the sequence of numbers or bits generated by a generator is.  As a rule, various statistical tests are used for this purpose, such as DIEHARD or NIST.  Andrew Yao in 1982 proved that the generator, which passed the ‚Äútest for the next bit‚Äù, will also pass any other statistical randomness tests that can be performed in polynomial time. <br>  On the Internet <a href="http://www.cacert.at/random/">[10]</a> you can pass the DIEHARD tests and many others to determine the criterion resistance of the algorithm. <br><br><h4>  Known hacks of random number generators </h4><br><ul><li>  Early versions of Netscape's SSL encryption protocol, with low entropy <a href="http://www.cs.berkeley.edu/~daw/papers/ddj-netscape.html">[11]</a> </li><li>  PHP vulnerability sessions <a href="http://habrahabr.ru/company/pt/blog/149746/">habrahabr.ru/company/pt/blog/149746</a> </li><li>  Microsoft's CryptGenRandom <a href="http://www.computerworld.com/s/article/9048438/Microsoft_confirms_that_XP_contains_random_number_generator_bug">[12]</a> </li><li>  Many online casinos have repeatedly become the object of attack through vulnerabilities in the PRNG. </li></ul><br><br><h4>  Bibliography </h4><br>  [1] Donald Knut, The Art of Programming (Volume 2. Algorithms Computed) <br>  [2] Bruce Schneier, Applied Cryptography (Chapter 16) <br>  [4] <a href="http://www.staff.uni-mainz.de/pommeren/Kryptologie/Bitstrom/2_Analyse/LCGcrack.html">www.staff.uni-mainz.de/pommeren/Kryptologie/Bitstrom/2_Analyse/LCGcrack.html</a> <br>  [5] <a href="http://www.staff.uni-mainz.de/pommeren/Kryptologie99/English.html">www.staff.uni-mainz.de/pommeren/Kryptologie99/English.html</a> <br>  [6] <a href="http://en.wikipedia.org/wiki/Mersenne_twister">en.wikipedia.org/wiki/Mersenne_twister</a> <br>  [7] <a href="http://en.wikipedia.org/wiki/Triangular_distribution">en.wikipedia.org/wiki/Triangular_distribution</a> <br>  [8] <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B3%25D1%2580%25D1%2583%25D1%258D%25D0%25BD%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4">en.wikipedia.org/wiki/Linear_congruent_method</a> <br>  [9] <a href="http://zaic101.ru/files/728/using_linear_congruential_generators_for_cryptographic_purposes.pdf">zaic101.ru/files/728/using_linear_congruential_generators_for_cryptographic_purposes.pdf</a> <br>  [10] <a href="http://www.cacert.at/random/">www.cacert.at/random</a> <br>  [11] <a href="http://www.cs.berkeley.edu/~daw/papers/ddj-netscape.html">www.cs.berkeley.edu/~daw/papers/ddj-netscape.html</a> <br>  [12] <a href="http://www.computerworld.com/s/article/9048438/Microsoft_confirms_that_XP_contains_random_number_generator_bug">www.computerworld.com/s/article/9048438/Microsoft_confirms_that_XP_contains_random_number_generator_bug</a> <br>  [13] An interesting example of generation via md5 is <a href="http://raz0r.name/articles/magiya-sluchajnyx-chisel-chast-2/comment-page-1/">described raz0r.name/articles/magiya-sluchajnyx-chisel-chast-2/comment-page-1</a> <br><br><h4>  Original </h4><br>  <a href="http://jazzy.id.au/default/2010/09/20/cracking_random_number_generators_part_1.html">jazzy.id.au/default/2010/09/20/cracking_random_number_generators_part_1.html</a> <br>  <a href="http://jazzy.id.au/default/2010/09/21/cracking_random_number_generators_part_2.html">jazzy.id.au/default/2010/09/21/cracking_random_number_generators_part_2.html</a> <br>  <a href="http://jazzy.id.au/default/2010/09/22/cracking_random_number_generators_part_3.html">jazzy.id.au/default/2010/09/22/cracking_random_number_generators_part_3.html</a> <br>  <a href="http://jazzy.id.au/default/2010/09/25/cracking_random_number_generators_part_4.html">jazzy.id.au/default/2010/09/25/cracking_random_number_generators_part_4.html</a> </div><p>Source: <a href="https://habr.com/ru/post/151187/">https://habr.com/ru/post/151187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151169/index.html">Data Context Interaction (DCI) - the evolution of the object-oriented paradigm</a></li>
<li><a href="../151171/index.html">Innovations in the work and 2 new video</a></li>
<li><a href="../151173/index.html">PostgreSQL 9.2 - official release</a></li>
<li><a href="../151174/index.html">Runet Today, September 10, 2012. Experts of the issue: Anna Artamonova, Vasily Esmanov</a></li>
<li><a href="../151185/index.html">Isolating code during testing using Microsoft Fakes (Shims)</a></li>
<li><a href="../151189/index.html">Miniature technology on the iPhone-control</a></li>
<li><a href="../151190/index.html">If Xerox PARC invented the PC, then Google invented the Internet.</a></li>
<li><a href="../151191/index.html">IBM Augmented Reality Will Change Shopping</a></li>
<li><a href="../151192/index.html">Debugging Android applications without source codes: native methods</a></li>
<li><a href="../151193/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Activity 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>