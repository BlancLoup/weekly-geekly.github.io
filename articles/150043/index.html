<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mathematical expressions in .NET (parsing, differentiation, simplification, fractions, compilation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since school time, I was interested in an algorithm for deriving analytical derivatives and simplifying expressions. This task was relevant later in t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mathematical expressions in .NET (parsing, differentiation, simplification, fractions, compilation)</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/150043/"><img src="https://habrastorage.org/getpro/habr/post_images/8c2/8a6/cf2/8c28a6cf265dac0619a71399bb592d7d.png" align="left"></a>  Since school time, I was interested in an algorithm for deriving analytical derivatives and simplifying expressions.  This task was relevant later in the university.  It was then that I implemented it, but everything did not turn out the way I wanted: instead of IL code, I simply generated C # code in text form, the assemblies were not unloaded, and besides, it was not possible to derive derivatives in analytical form.  However, then I decided to still implement such a library, since interest remained.  It should be noted that there are a large number of such libraries on the Internet, but nowhere did I find the stage of compiling expressions into IL code, i.e.  in essence, interpretation is performed everywhere, which is not as effective as compiling.  Well, and besides, I was developing it purely for myself, for learning new technologies, especially not hoping that the result of my work might be needed anywhere.  For impatient: <a href="">source code</a> , the <a href="">program</a> . <br><br><h4>  Used programs and libraries </h4><br><ol><li>  <a href="http://goldparser.org/"><b>GOLD Parsing System</b></a> - IDE for writing grammars and generating code for lexers and parsers for various languages ‚Äã‚Äã(C, C #, Java, JavaScript, Objective-C, Perl, Python, Ruby, etc.).  Based on LALR parsing. </li><li>  <b>Visual studio 2010</b> </li><li>  <b>GOLD.Engine</b> - assembly under .NET, connected to interact with the generated tables. </li><li>  <a href="http://www.nunit.org/"><b>NUnit</b></a> - Open application testing unit for .NET environment. </li><li>  <a href="http://ilspy.net/"><b>ILSpy</b></a> - OpenSource disassembler for .NET. </li></ol><br>  Stages into which I broke the whole process: <br><ol><li>  <a href="https://habr.com/ru/post/150043/">Building an expression tree</a> </li><li>  <a href="https://habr.com/ru/post/150043/">Calculation of analytical derivative</a> </li><li>  <a href="https://habr.com/ru/post/150043/">Simplification (simplification) of expression</a> </li><li>  <a href="https://habr.com/ru/post/150043/">Processing of rational fractions</a> </li><li>  <a href="https://habr.com/ru/post/150043/">Expression compilation</a> </li></ol><br><a name="habracut"></a><br><a name="ast"></a><h4>  Building an expression tree </h4><br>  I chose the GOLD parser generator because I already have experience with ANTLR and wanted something new.  Well, its advantages, compared with the others, you can see <a href="http://goldparser.org/about/comparison-parsers.htm">in this table</a> .  As you can see, when compared with ANTLR, then GOLD is based on the <a href="http://en.wikipedia.org/wiki/LALR_parser">LALR</a> algorithm, not <a href="http://en.wikipedia.org/wiki/LL_parser">LL</a> .  And this means that, in theory, the generated parser is faster and more powerful, but on the other hand, it cannot be debugged (in GOLD, the file in binary format is loaded), and if it could, it would not be obvious and inconvenient .  Another big difference is the grammar assignment form: <a href="http://en.wikipedia.org/wiki/Backus%25E2%2580%2593Naur_Form">BNF</a> , not <a href="http://en.wikipedia.org/wiki/Extended_Backus%25E2%2580%2593Naur_Form">EBNF</a> .  This means that the grammar written in this form has a slightly larger size due to the angle brackets, the definition sign and the absence of conditional entries and repetitions (in more detail in the <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0_%25D0%2591%25D1%258D%25D0%25BA%25D1%2583%25D1%2581%25D0%25B0_%25E2%2580%2594_%25D0%259D%25D0%25B0%25D1%2583%25D1%2580%25D0%25B0">wiki</a> . And, for example, such a rule in EBNF as <br><br><pre><code class="hljs objectivec">ExpressionList = Expression { <span class="hljs-string"><span class="hljs-string">','</span></span> Expression }</code> </pre> <br>  will be rewritten in this form: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ',' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  So, the final grammar of mathematical expressions is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Grammar of Mathematical Expressions</b> <div class="spoiler_text"><pre> <code class="hljs xml">"Name" = 'Mathematics expressions' "Author" = 'Ivan Kochurkin' "Version" = '1.0' "About" = '' "Case Sensitive" = False "Start Symbol" = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statements</span></span></span><span class="hljs-tag">&gt;</span></span> Id = {Letter}{AlphaNumeric}* Number1 = {Digit}+('.'{Digit}*('('{Digit}*')')?)? Number2 = '.'{Digit}*('('{Digit}*')')? AddLiteral = '+' | '-' MultLiteral = '*' | '/' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statements</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statements</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Devider</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statement</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statements</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Devider</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Devider</span></span></span><span class="hljs-tag">&gt;</span></span> ::= ';' | '.' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Statement</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> '=' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Addition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> ::= Id '(' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ')' | Id '' '(' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ')' | Id '(' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ')' '' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExpressionList</span></span></span><span class="hljs-tag">&gt;</span></span> ',' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Addition</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Addition</span></span></span><span class="hljs-tag">&gt;</span></span> AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Addition</span></span></span><span class="hljs-tag">&gt;</span></span> AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> MultLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Multiplication</span></span></span><span class="hljs-tag">&gt;</span></span> MultLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> MultLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> MultLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> ::= <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> '^' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Negation</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exponentiation</span></span></span><span class="hljs-tag">&gt;</span></span> '^' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> '^' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Negation</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> '^' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Negation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Negation</span></span></span><span class="hljs-tag">&gt;</span></span> ::= AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> | AddLiteral <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FuncDef</span></span></span><span class="hljs-tag">&gt;</span></span> | <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> ::= Id | Number1 | Number2 | '(' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> ')' | '|' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> '|' | '(' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> ')' '' | '|' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Expression</span></span></span><span class="hljs-tag">&gt;</span></span> '|' '' | Id ''</code> </pre><br></div></div><br>  Everything seems to be obvious in grammar, with the exception of the token: <b>Number1</b> = {Digit} + ('.' {Digit} * ('(' {Digit} * ')')?)?  This construction allows to parse lines of the following form: 0.1234 (56), which means a rational fraction: 61111/495000.  I will tell you about the conversion of such a string into a fraction later. <br><br>  So, after the compiled Grammar Table File has been generated and the parser class has been created, it is necessary to modify the latter in order to build a suitable AST tree.  The framework of the parser class in this case is the .cs file in which the crawl cycle is written according to all the rules of grammar, exception handling in case of an incorrect sequence of tokens and other errors (by the way, GOLD also has different generators of such frameworks, and I chose Cook .NET ).  So, in our case ‚Äúsuitable‚Äù means a tree consisting of nodes that can have types: <br><br><ul><li>  <b>Calculated</b> is a node representing a calculated constant in a format acceptable for the compiler <b>double</b> , for example, "0.714285714285714", "0.122222222222222".  For each such constant, a new object is created, even if they are the same. </li><li>  <b>Value</b> is the node representing the calculated constant in the rational fraction format, i.e.  1 is represented as "1/1", "0.1 (2)" - as "11/90", "0.1234" - as "617/5000".  For each such constant, a new object is created, even if they are the same. </li><li>  <b>Constant</b> - a node that represents an undefined constant, for example, "a", "b", etc. If there are two such constants in the expression, then they point to one node. </li><li>  <b>Variable</b> - a node that represents a variable, for example, "x", "y", etc. If a certain variable occurs several times in an expression, then only one object is created for it, as well as for an undefined constant.  It is important to understand that the distinction between a constant and a variable is important only at the stage of derivation of an analytical derivative, and in other cases this knowledge is not necessary. </li><li>  <b>Function</b> - the node representing the function, for example, "+", "sin", "^" and others.  The only node that can have descendants. </li></ul><br>  All types of nodes are graphically represented in the figure: <br><img src="https://habrastorage.org/getpro/habr/post_images/5ca/3ad/124/5ca3ad124f251ca60be109f796615a0b.png"><br><br>  From the grammar it is clear that the nodes of the obtained tree either have no children (for example, values ‚Äã‚Äãor variables), or have from one to two children in the case of standard functions (for example, cos, addition, raising to a power).  All other functions may have more arguments, but they were not considered. <br><br>  Thus, all nodes (or rather nodes with functions) have from 0 to 2 children inclusive.  This is true from a theoretical point of view.  But in fact, I had to make the functions "+" and "*" have an unlimited number of children in order to facilitate the task of simplification, which will be discussed later.  By the way, such binary operations as "-" and "/" also had to be abandoned for the same reasons (they were replaced by addition with negation of the right side and multiplication with inversion of the right side). <br><br>  So, at the parsing stage, all nodes for each rule are dropped or extracted from a buffer called <b>Nodes</b> .  Thus, at the end of the whole process, one or several functions with the right and left parts remain in this buffer.  Also in the parsing process, in order for the addition and multiplication functions to be immediately created by multi-line functions, additional buffers ArgsCount and ArgsFuncTypes were used, storing the current number of arguments in the function and the type of the current function, respectively.  Thus, for example, for the multiplication function, this code is used: <br><br>  <u>Processing the first multiplier:</u> <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// &lt;Multiplication&gt; ::= &lt;Exponentiation&gt; if (MultiplicationMultiChilds) PushFunc(KnownMathFunctionType.Mult);</span></span></code> </pre><br>  <u>Processing the i-th factor:</u> <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// &lt;Multiplication&gt; ::= &lt;Multiplication&gt; MultLiteral &lt;Exponentiation&gt; // &lt;Multiplication&gt; ::= &lt;Multiplication&gt; MultLiteral &lt;FuncDef&gt; if (KnownMathFunction.BinaryNamesFuncs[r[1].Data.ToString()] == KnownMathFunctionType.Div) Nodes.Push(new FuncNode(KnownMathFunctionType.Exp, new MathFuncNode[] { Nodes.Pop(), new ValueNode(-1) })); ArgsCount[ArgsCount.Count - 1]++;</span></span></code> </pre><br>  <u>Handling the last multiplier:</u> <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// &lt;Addition&gt; ::= &lt;Multiplication&gt; if (MultiplicationMultiChilds) PushOrRemoveFunc(KnownMathFunctionType.Mult); if (AdditionMultiChilds) PushFunc(KnownMathFunctionType.Add);</span></span></code> </pre><br><br>  From this code it can be seen that, for example, if there is no multiplication, then the last multiplication function with zero number of elements needs to be removed using <i>PushOrRemoveFunc</i> .  Similar actions need to be carried out and for addition. <br><br>  Processing functions of a single argument, binary functions, constants, variables and values ‚Äã‚Äãis trivial, and all this can be found in <b>MathExprParser.cs</b> . <br><br><a name="symbolic-derivative"></a><h4>  Calculation of analytical derivative </h4><br>  At this stage, you need to convert the function to its derivative. <br><br>  As is known from the first stage, in the created expression tree there are only four types of nodes (the fifth one appears later).  For them, we define the derivative: <br><br><ul><li>  <b>Value '= 0</b> </li><li>  <b>Constant '= 0</b> </li><li>  <b>Variable '= 1</b> </li><li>  <b>Function '= Derivatives [Function]</b> </li></ul><br>  Let me explain: for a derivative of a function, it is necessary to take a previously prepared table value, and this causes certain difficulties, because there are also derivatives within this value, i.e.  The process is recursive.  You can see the full list of such implemented substitutions under the spoiler below. <br><br><div class="spoiler">  <b class="spoiler_title">Derivatives List</b> <div class="spoiler_text"><pre> <code class="hljs matlab">(f(x) ^ g(x))' = f(x) ^ g(x) * (f(x)' * g(x) / f(x) + g(x)' * ln(f(x)));<span class="hljs-string"><span class="hljs-string">"); neg(f(x))' = neg(f(x)');"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(f(x))' = <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(f(x)) * f(x)'; <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(f(x))' = -<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(f(x)) * f(x)'; <span class="hljs-built_in"><span class="hljs-built_in">tan</span></span>(f(x))' = f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(f(x)) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">cot</span></span>(f(x))' = -f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(f(x)) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>; arcsin(f(x))' = f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> - f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>); arccos(f(x))' = -f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> - f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>); arctan(f(x))' = f(x)' / (<span class="hljs-number"><span class="hljs-number">1</span></span> + f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>); arccot(f(x))' = -f(x)' / (<span class="hljs-number"><span class="hljs-number">1</span></span> + f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">sinh</span></span>(f(x))' = f(x)' * <span class="hljs-built_in"><span class="hljs-built_in">cosh</span></span>(x); <span class="hljs-built_in"><span class="hljs-built_in">cosh</span></span>(f(x))' = f(x)' * <span class="hljs-built_in"><span class="hljs-built_in">sinh</span></span>(x); arcsinh(f(x))' = f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>); arcosh(f(x))' = f(x)' / <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(f(x) ^ <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>); ln(f(x))' = f(x)' / f(x); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(f(x), g(x))' = g'(x)/(g(x)*ln(f(x))) - (f'(x)*ln(g(x)))/(f(x)*ln(f(x))^<span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre></div></div><br>  It should be noted that all derivatives are not written rigidly in the code, but can also be entered and parsed dynamically. <br><br>  There is no addition and multiplication in this list because, as mentioned above, these are functions with several arguments.  And in order to parse such rules, it would be necessary to still write a lot of code.  For the same reasons, there is no composition of functions, i.e.  (f (g (x))) '= f (g (x))' * g (x) ', but instead all functions are presented as function compositions. <br><br>  Also, if a substitution in Derivatives (i.e., an undefined function) is not found for a function, then it is simply replaced with a function with a stroke: i.e.  f (x) becomes f (x) '. <br><br>  After the analytical derivative has been successfully obtained, the problem arises, which is that in the resulting expression there is a lot of "garbage", such as a + 0, a * 1, a * a ^ -1, etc., and also, the resulting expression can be calculated in a more optimal way.  For example, even for a simple expression you get an ugly expression: <br><br><pre> <code class="hljs matlab">(x^<span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>)' = <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-number"><span class="hljs-number">1</span></span> * x ^ <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  To eliminate such drawbacks, simplification is used. <br><br><a name="simplification"></a><h4>  Simplification (simplification) of expression </h4><br>  At this stage, unlike the step of calculating derivatives, I did not write down the rules of simplification in a separate place, for their subsequent analysis because the addition and multiplication functions are functions of several arguments, which is a certain difficulty in creating such rules in context of an iterative language. <br><br>  At the beginning of the topic, I touched on the topic of why addition and multiplication are represented as n-ary functions.  Imagine the situation shown in the picture below.  Here we see that <b>a</b> and <b>-a</b> are reduced.  But how to do it in the case of binary functions?  To do this, we need to iterate over nodes <b>a</b> , <b>b,</b> and <b>c</b> , in order to later discover that <b>a</b> and <b>-a</b> are children of the same node, which means that they can be reduced with the node.  But, of course, that sorting through trees is not such an easy task, since it is much easier to perform all the actions in a cycle with all the children at once, as shown in the figure on the right.  By the way, this sort of search allows us to make mathematical properties of <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D1%2581%25D1%2581%25D0%25BE%25D1%2586%25D0%25B8%25D0%25B0%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">associativity</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25BC%25D1%2583%25D1%2582%25D0%25B0%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">commutativity</a> . <br><br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/bda/5e8/af8/bda5e8af81e68f7ca8d5f3fa38a8fb0f.png"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/f8f/6e2/547/f8f6e254727e87e5574d8524a1f7ccbb.png"></td></tr></tbody></table><br>  During the process of simplification, the problem arises of comparing two nodes, which, in turn, can be of one of four types.  This is necessary, for example, in order to reduce expressions such as sin (x + y) and -sin (x + y).  It is clear that it is possible to compare the nodes themselves and all their descendants by nodes.  But the problem is that this method does not cope with the situation when the terms or factors are rearranged, for example, sin (x + y) and -sin (y + x).  To resolve this problem, a preliminary sorting of the terms or factors for which the commutativity property is fulfilled (that is, for addition and subtraction) is used.  The nodes are compared as shown in the picture below, i.e.  values ‚Äã‚Äãless than constants, constants less variables, etc.  For functions, everything is a bit more complicated, since it is necessary to compare not only their names, but also the number of arguments and the arguments themselves. <br><img src="https://habrastorage.org/getpro/habr/post_images/07a/05b/bd5/07a05bbd51d4ee2334ea97e02df5a68d.png"><br><br>  Thus, after all the above-described transformations and iterations, the original expression is simplified quite well. <br><br><a name="rational-fractions"></a><h4>  Processing of rational fractions </h4><br>  In the rational implementations I found there was no conversion of the usual string type, for example, 0.666666, into a fraction type with a specific numerator and denominator, i.e.  in 2/3 with a certain accuracy.  Then I decided to write my own implementation with a lot of options.  The functions below can, for example, determine whether a number is purely irrational, or it has a period or finite fractional part and can be converted to rational, for example, sin (pi) to 0 with a certain accuracy.  In general, for other details, see <a href="http://stackoverflow.com/questions/95727/how-to-convert-floats-to-human-readable-fractions/12564894">my response to stackoverflow.com</a> .  A brief graphic explanation of the method is presented in the figure below, and the code is shown in the listing below.  It is worth noting that, nevertheless, the accuracy of standard mathematical functions and the <i>double</i> type are not enough for normal recognition of rational and real numbers, but theoretically everything works. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc7/c73/526/fc7c73526dc83f8c341aa43f23d2b931.png"><br><br><div class="spoiler">  <b class="spoiler_title">Convert decimal to fraction</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Convert decimal to fraction </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="value"&gt;</span></span></span><span class="hljs-comment">decimal value to convert</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="result"&gt;</span></span></span><span class="hljs-comment">result fraction if conversation is succsess</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="decimalPlaces"&gt;</span></span></span><span class="hljs-comment">precision of considereation frac part of value</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="trimZeroes"&gt;</span></span></span><span class="hljs-comment">trim zeroes on the right part of the value or not</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="minPeriodRepeat"&gt;</span></span></span><span class="hljs-comment">minimum period repeating</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="digitsForReal"&gt;</span></span></span><span class="hljs-comment">precision for determination value to real if period has not been founded</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static bool FromDecimal(decimal value, out Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> result, int decimalPlaces = 28, bool trimZeroes = false, decimal minPeriodRepeat = 2, int digitsForReal = 9) { var valueStr = value.ToString("0.0000000000000000000000000000", CultureInfo.InvariantCulture); var strs = valueStr.Split('.'); long intPart = long.Parse(strs[0]); string fracPartTrimEnd = strs[1].TrimEnd(new char[] { '0' }); string fracPart; if (trimZeroes) { fracPart = fracPartTrimEnd; decimalPlaces = Math.Min(decimalPlaces, fracPart.Length); } else fracPart = strs[1]; result = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(); try { string periodPart; bool periodFound = false; int i; for (i = 0; i </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; fracPart.Length; i++) { if (fracPart[i] == '0' &amp;&amp; i != 0) continue; for (int j = i + 1; j &lt; fracPart.Length; j++) { periodPart = fracPart.Substring(i, j - i); periodFound = true; decimal periodRepeat = 1; decimal periodStep = 1.0m / periodPart.Length; var upperBound = Math.Min(fracPart.Length, decimalPlaces); int k; for (k = i + periodPart.Length; k &lt; upperBound; k += 1) { if (periodPart[(k - i) % periodPart.Length] != fracPart[k]) { periodFound = false; break; } periodRepeat += periodStep; } if (!periodFound &amp;&amp; upperBound - k &lt;= periodPart.Length &amp;&amp; periodPart[(upperBound - i) % periodPart.Length] &gt;</span></span></span><span class="hljs-comment"> '5') { var ind = (k - i) % periodPart.Length; var regroupedPeriod = (periodPart.Substring(ind) + periodPart.Remove(ind)).Substring(0, upperBound - k); ulong periodTailPlusOne = ulong.Parse(regroupedPeriod) + 1; ulong fracTail = ulong.Parse(fracPart.Substring(k, regroupedPeriod.Length)); if (periodTailPlusOne == fracTail) periodFound = true; } if (periodFound &amp;&amp; periodRepeat &gt;= minPeriodRepeat) { result = FromDecimal(strs[0], fracPart.Substring(0, i), periodPart); break; } else periodFound = false; } if (periodFound) break; } if (!periodFound) { if (fracPartTrimEnd.Length &gt;= digitsForReal) return false; else { result = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(long.Parse(strs[0]), 1, false); if (fracPartTrimEnd.Length != 0) result = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(ulong.Parse(fracPartTrimEnd), TenInPower(fracPartTrimEnd.Length)); return true; } } return true; } catch { return false; } } public static Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> FromDecimal(string intPart, string fracPart, string periodPart) { Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> firstFracPart; if (fracPart != null &amp;&amp; fracPart.Length != 0) { ulong denominator = TenInPower(fracPart.Length); firstFracPart = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(ulong.Parse(fracPart), denominator); } else firstFracPart = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(0, 1, false); Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> secondFracPart; if (periodPart != null &amp;&amp; periodPart.Length != 0) secondFracPart = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(ulong.Parse(periodPart), TenInPower(fracPart.Length)) * new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(1, Nines((ulong)periodPart.Length), false); else secondFracPart = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(0, 1, false); var result = firstFracPart + secondFracPart; if (intPart != null &amp;&amp; intPart.Length != 0) { long intPartLong = long.Parse(intPart); result = new Rational</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(intPartLong, 1, false) + (intPartLong == 0 ? 1 : Math.Sign(intPartLong)) * result; } return result; } private static ulong TenInPower(int power) { ulong result = 1; for (int l = 0; l </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; power; l++) result *= 10; return result; } private static decimal TenInNegPower(int power) { decimal result = 1; for (int l = 0; l &gt;</span></span></span><span class="hljs-comment"> power; l--) result /= 10.0m; return result; } private static ulong Nines(ulong power) { ulong result = 9; if (power &gt;= 0) for (ulong l = 0; l </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; power - 1; l++) result = result * 10 + 9; return result; }</span></span></span></span></code> </pre><br></div></div><br><a name="compilation"></a><h4>  Expression compilation </h4><br>  To convert the resulting semantic tree into IL code after the simplification stage, I used Mono.Cecil. <br><br>  At the beginning of the process, an assembly, class and method are created in which commands will be written.  Then for each FuncNode it is calculated how many times it occurs in the program.  For example, if there is a function <i>sin (x ^ 2) * cos (x ^ 2)</i> , then in it the function of raising x to the power of 2 occurs twice, and the functions sin and cos - one at a time.  Further, this information about the repetition of the calculations of functions is used as follows (that is, this way the second time, the calculations of the same function do not occur): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!func.Calculated) { EmitFunc(funcNode); func.Calculated = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number));</code> </pre><br><br>  After generating all this code, some more optimizations of the IL code are possible, as shown in the figure below. <br><img src="https://habrastorage.org/getpro/habr/post_images/150/77c/b3d/15077cb3dd1920a1014f2541436b9eaf.png"><br>  In this picture: <br><ol><li>  <b>Ldarg</b> - The operation of loading a specific function argument to the stack. </li><li>  <b>Ldc_R8</b> - Load a specific double value <b>onto the</b> stack. </li><li>  <b>Stloc.n</b> - Retrieving the last value from the stack and saving it to a local variable <b>n</b> . </li><li>  <b>Ldloc.n</b> - Putting local variable <b>n</b> on the stack. </li></ol><br>  Instructions in beige rectangles can be removed if certain conditions are met.  For example, the case on the upper left image is described as follows: If the current instruction is loading an argument from a function or loading a constant, and the next instruction is saving it to a local variable <i>n</i> , then this block of instructions can be deleted by first replacing the loading instructions of the local variable <i>n</i> by loading function argument or constant loading.  The replacement process is continued until the first save instruction in the local variable <i>n</i> .  The other three cases are explained in a similar way.  for example, the sequence <b>Ldloc.n</b> ;  <b>Stloc.n</b> can be removed immediately. <br><br>  It is worth noting that the optimization data is applicable in the case of absence of branching in the code, and this is obviously why (if not completely obvious, then I suggest reflecting).  But since the code of mathematical functions and their derivatives cannot contain cycles in my case, it all works. <br><br><h5>  Quick exponentiation </h5><br>  I think that almost everyone knows about the <a href="http://en.wikipedia.org/wiki/Exponentiation_by_squaring">algorithm of fast number exponentiation</a> .  But below is the compilation level of this algorithm: <br><div class="spoiler">  <b class="spoiler_title">Algorithm of quick exponentiation implemented in IL code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>) { IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Stloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; power; i++) { IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Mul)); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power == <span class="hljs-number"><span class="hljs-number">4</span></span>) { IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Stloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Mul)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Stloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Ldloc, funcNode.Number)); IlInstructions.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpCodeArg(OpCodes.Mul)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// result: funcNode.Number // x: funcNode.Number + 1 //int result = x; IlInstructions.Add(new OpCodeArg(OpCodes.Stloc, funcNode.Number + 1)); IlInstructions.Add(new OpCodeArg(OpCodes.Ldloc, funcNode.Number + 1)); power--; do { if ((power &amp; 1) == 1) { IlInstructions.Add(new OpCodeArg(OpCodes.Ldloc, funcNode.Number + 1)); IlInstructions.Add(new OpCodeArg(OpCodes.Mul)); } if (power &lt;= 1) break; //x = x * x; IlInstructions.Add(new OpCodeArg(OpCodes.Ldloc, funcNode.Number + 1)); IlInstructions.Add(new OpCodeArg(OpCodes.Ldloc, funcNode.Number + 1)); IlInstructions.Add(new OpCodeArg(OpCodes.Mul)); IlInstructions.Add(new OpCodeArg(OpCodes.Stloc, funcNode.Number + 1)); power = power &gt;&gt; 1; } while (power != 0); }</span></span></code> </pre><br></div></div><br>  It is worth noting that the quick exponentiation algorithm is not the most optimal exponentiation algorithm.  For example, the following is a multiplication of the same variables five times in two ways.  Optimizations of the type x ^ 4 + x ^ 3 + x ^ 2 + x = x * (x * (x * (x + 1) + 1) + 1) are also not implemented by me. <br><br><ul><li>  <b>var t = a ^ 2;</b>  <b>a * a * a * a * a * a = t ^ 2 * t</b> is the usual ‚Äúfast‚Äù algorithm. </li><li>  <b>a * a * a * a * a * a = (a ^ 3) ^ 2</b> is the optimal ‚Äúfast‚Äù algorithm. </li></ul><br><br>  By the way, it is also worth mentioning that for ordinary fixed double numbers, the result of multiplication for the above mentioned multiplications in different order will be different (i.e. (a ^ 2) ^ 2 * a ^ 2! = (A ^ 3) ^ 2 ).  And because of this, some compilers do not optimize many similar expressions.  On this occasion, there are interesting Q &amp; A in stackoverlofw: <a href="http://stackoverflow.com/q/6430448/1046374">Why doesn't GCC optimize a * a * a * a * a * a * a to (a * a * a) * (a * a * a)?</a>  and <a href="http://stackoverflow.com/q/12542802/1046374">Why Math.Pow (x, 2) is not optimized x x neither compiler nor JIT?</a>  . <br><br><h5>  Optimization of local variables </h5><br>  As is known from the previous steps, local variables are used to store the result of all functions that occur more than 1 time in the original expression.  To work with local variables, only two simple instructions are used: <b>stloc</b> and <b>ldloc</b> , which use one argument responsible for the number of this local variable.  But if the number of a local variable is incremented every time there is a recurring result of the calculations (to create it), then there can be a lot of local variables.  To level this problem, the compression algorithm for the life cycles of local variables was implemented, the process of which can be clearly seen in the figure below.  As you can see, instead of 5 local variables in the expression, you can use only 3. However, this ‚Äúgreedy‚Äù algorithm is not the most optimal permutation, but it is quite suitable for the realizable problem. <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/025/e0d/1bb/025e0d1bb60e83e286b2f646d62c365f.png"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/151/8aa/be2/1518aabe2f750f51cd23f638178895e1.png"></td></tr></tbody></table><br><h5>  Compilation of undefined functions and their derivatives </h5><br>  In the developed library, you can use not only simple functions of one variable type f (x), but also others, such as f (x, a, b (x)), where a is an unknown constant, and b (x) is an unknown function transmitted as a delegate.  As is known, the definition of the derivative of any function is as follows: b (x) '= (b (x + dx) - b (x)) / dx.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And when the compilation module encounters an undefined function, it generates the following code: </font></font><br><pre> <code class="cs hljs">ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> callvirt TResult System.Func`<span class="hljs-number"><span class="hljs-number">2</span></span>&lt;System.Double,System.Double&gt;::Invoke(T) ret</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code for calculating the derivative of the undefined function (dx = 0.000001)</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs">ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> ldc.r8 <span class="hljs-number"><span class="hljs-number">1E-06</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> callvirt TResult System.Func`<span class="hljs-number"><span class="hljs-number">2</span></span>&lt;System.Double,System.Double&gt;::Invoke(T) ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> callvirt TResult System.Func`<span class="hljs-number"><span class="hljs-number">2</span></span>&lt;System.Double,System.Double&gt;::Invoke(T) sub ldc.r8 <span class="hljs-number"><span class="hljs-number">0.000001</span></span> div ret</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For numerical calculation of derivatives, other, </font></font><a href="http://en.wikipedia.org/wiki/Numerical_differentiation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more accurate methods</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be used </font><font style="vertical-align: inherit;">.</font></font><br><br><h4>  Testing </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing was conducted for several processing steps, which can be viewed in the project MathFunction.Tests. </font><font style="vertical-align: inherit;">Among the interesting points, we can mention the use of </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WolframAlpha.NET</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for testing analytical derivatives and loading and unloading assemblies using domains.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wolframlpha </font></font></h5><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WolframAlpha.NET</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an API wrapper for the famous </font></font><a href="http://www.wolframalpha.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wolframalpha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> math service </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In my project, it was useful in order to verify the obviously correct derivative obtained on this service with the derivative obtained with the help of my library. </font><font style="vertical-align: inherit;">Used as follows:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckDerivative</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expression, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> derivative</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CheckEquality(<span class="hljs-string"><span class="hljs-string">"diff("</span></span> + expression + <span class="hljs-string"><span class="hljs-string">")"</span></span>, derivative); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckEquality</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expression1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expression2</span></span></span><span class="hljs-function">)</span></span> { WolframAlpha wolfram = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WolframAlpha(ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"WolframAlphaAppId"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query = <span class="hljs-string"><span class="hljs-string">"("</span></span> + expression1.Replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">")-("</span></span> + expression2.Replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; QueryResult result = wolfram.Query(query); result.RecalculateResults(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.TryParse(result.GetPrimaryPod().SubPods[<span class="hljs-number"><span class="hljs-number">0</span></span>].Plaintext, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> d) &amp;&amp; d == <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Loading and unloading assemblies using domains </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creating a domain, assembling from a file, creating an instance of a certain type and getting objects with information about methods (MethodInfo): </font></font><br><br><pre> <code class="cs hljs">Domain = AppDomain.CreateDomain(<span class="hljs-string"><span class="hljs-string">"MathFuncDomain"</span></span>); MathFuncObj = _domain.CreateInstanceFromAndUnwrap(FileName, NamespaceName + <span class="hljs-string"><span class="hljs-string">"."</span></span> + ClassName); Type mathFuncObjType = _mathFuncObj.GetType(); Func = mathFuncObjType.GetMethod(FuncName); FuncDerivative = mathFuncObjType.GetMethod(FuncDerivativeName);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculation of the result of the compiled function: </font></font><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)Func.Invoke(_mathFuncObj, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { x })</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uploading a domain and deleting a file with an assembly: </font></font><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_domain != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) AppDomain.Unload(Domain); File.Delete(FileName);</code> </pre><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comparison of generated IL code </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The final IL code is more optimal, compared to the code generated by the standard C # compiler csc.exe in Release mode, you just have to look at the comparison of the following two listings, for example, for the function </font></font><br><pre> <code class="hljs pgsql">x ^ <span class="hljs-number"><span class="hljs-number">3</span></span> + sin(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x * <span class="hljs-number"><span class="hljs-number">1</span></span>)) + x ^ ln(<span class="hljs-number"><span class="hljs-number">2</span></span> * sin(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x))) - <span class="hljs-number"><span class="hljs-number">2</span></span> * x ^ <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><table><tbody><tr><td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">csc.exe .NET 4.5.1</font></font></b> </td><td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MathExpressions.NET</font></font></b> </td></tr><tr><td><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0000</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0001</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0002</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0003</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0004</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0005</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0018</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0019</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Log(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Sin(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0024</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0025</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0026</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_002f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0038</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0039</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Log(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_003e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_003f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Sin(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0044</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0045</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Log(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_004a</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Pow(float64</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_004f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0050</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0059</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005a</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005b</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005c</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005d</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_005f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0060</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br></td><td><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0000</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0009</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000a</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Log(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0010</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Sin(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0015</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stloc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0016</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldloc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0017</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0018</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0019</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001a</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001b</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001c</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001d</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldarg</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_001e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.r8</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0027</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldloc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0028</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0029</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Log(float64)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_002e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Math</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Pow(float64</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">float64</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0033</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0034</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is curious to see at the same time what kind of disassembled C # code in ILSpy is for a function which is a derivative of the above function, i.e. </font><font style="vertical-align: inherit;">to</font></font><br><pre> <code class="hljs pgsql">(ln(<span class="hljs-number"><span class="hljs-number">2</span></span> * sin(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x))) * x ^ <span class="hljs-number"><span class="hljs-number">-1</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x) * cos(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x)) * sin(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x)) ^ <span class="hljs-number"><span class="hljs-number">-1</span></span> * x ^ <span class="hljs-number"><span class="hljs-number">-1</span></span>) * x ^ ln(<span class="hljs-number"><span class="hljs-number">2</span></span> * sin(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x))) + <span class="hljs-number"><span class="hljs-number">3</span></span> * cos(<span class="hljs-number"><span class="hljs-number">3</span></span> * ln(x)) * x ^ <span class="hljs-number"><span class="hljs-number">-1</span></span> + -(<span class="hljs-number"><span class="hljs-number">3</span></span> * x ^ <span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">double</span></span> arg_24_0 = <span class="hljs-number"><span class="hljs-number">2.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> arg_1A_0 = <span class="hljs-number"><span class="hljs-number">3.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> num = Math.Log(x); <span class="hljs-type"><span class="hljs-type">double</span></span> num2 = arg_1A_0 * num; <span class="hljs-type"><span class="hljs-type">double</span></span> num3 = Math.Sin(num2); <span class="hljs-type"><span class="hljs-type">double</span></span> num4 = Math.Log(arg_24_0 * num3); <span class="hljs-type"><span class="hljs-type">double</span></span> arg_3B_0 = num4; <span class="hljs-type"><span class="hljs-type">double</span></span> num5 = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / x; <span class="hljs-type"><span class="hljs-type">double</span></span> arg_54_0 = arg_3B_0 * num5; <span class="hljs-type"><span class="hljs-type">double</span></span> arg_4F_0 = <span class="hljs-number"><span class="hljs-number">3.0</span></span> * num; num = Math.Cos(num2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (arg_54_0 + arg_4F_0 * num / num3 * num5) * Math.Pow(x, num4) + num * num5 * <span class="hljs-number"><span class="hljs-number">3.0</span></span> - x * x * <span class="hljs-number"><span class="hljs-number">3.0</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, a large number of local variables have been created to store the already calculated results of functions. Although in reality there are fewer local variables, because, for example, for double </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg_24_0 = 2.0;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no local variable is created, it is just a constant. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, in real-world applications, such expressions are rarely encountered, but, nevertheless, the described optimizations can be used in other, more practical cases and for a better understanding of the compiler's work.</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During the implementation of all of the above in C #, I realized that a functional language is more suitable for tasks where you need to do something related to symbolic computation and substitution. Even, for example, the OpenSource </font></font><a href="http://maxima.sourceforge.net/ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxima</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> computer algebra system is </font><font style="vertical-align: inherit;">written in lisp. By the way, on F # there is an implementation of </font></font><a href="http://www.codeproject.com/Articles/87294/Symbolic-Calculation-in-F"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">symbolic calculations on the codeproject</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and there is clearly less code than I have in the project. However, the implementation of this project allowed me to gain more experience in parsing expressions, optimizing, generating low-level code, working with floating point numbers and just in mathematics. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For all interested, I posted it on Github: </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The program itself is also available: </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MathExpressions.NET</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If absolutely necessary, I can refactor it. </font><font style="vertical-align: inherit;">Pull requests are welcome. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS A long formula is hidden in the heart, taking into account the permutation of the terms, the factors and the simplification. </font><font style="vertical-align: inherit;">During its complication the developed program was used.</font></font><br><br><a name="UPDATE"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Since no one has guessed what is encrypted in the heart, I post the result. </font><font style="vertical-align: inherit;">This formula is a special case </font></font><a href="http://primes.utm.edu/glossary/page.php%3Fsort%3DMatijasevicPoly"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of a Matiyasevich polynomial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> whose set of positive values ‚Äã‚Äãfor non-negative values ‚Äã‚Äãof variables coincides with the set of primes. </font><font style="vertical-align: inherit;">Wikipedia also has </font></font><a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE%25D0%25B5_%25D1%2587%25D0%25B8%25D1%2581%25D0%25BB%25D0%25BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">information</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/150043/">https://habr.com/ru/post/150043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150037/index.html">FBI for the first time arrested websites with pirated applications for Android</a></li>
<li><a href="../150038/index.html">Smile to login!</a></li>
<li><a href="../150039/index.html">AMatch, part 2. Error codes, own errors, new callback format</a></li>
<li><a href="../150041/index.html">Class Relationships - From UML To Code</a></li>
<li><a href="../150042/index.html">Andengine: arbitrary landscape with texture</a></li>
<li><a href="../150044/index.html">Organization and optimization of user information space</a></li>
<li><a href="../150045/index.html">10G aggregators for providers and data centers</a></li>
<li><a href="../150047/index.html">Working with ssh in Python</a></li>
<li><a href="../150050/index.html">Sending SMS from under Shell</a></li>
<li><a href="../150051/index.html">Configuring cisco ASA 5510 + security module ASA-SSM-CSC-10 + NAT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>