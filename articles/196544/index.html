<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stored Functions on C in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habracheloveki! Many of you have come up with rendering business logic in a DBMS in the form of stored functions / procedures, facilitating the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stored Functions on C in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/1d5/fef/d25/1d5fefd25516506c4c98927ebe7b6a2d.jpeg"><br>  Hello, habracheloveki!  Many of you have come up with rendering business logic in a DBMS in the form of stored functions / procedures, facilitating the client.  This has both advantages and disadvantages.  Today I would like to tell you how to create stored functions in <b>PostgreSQL</b> written in the C language. The article will contain the very basics you need to know to get started with them. <br><a name="habracut"></a><br><h4>  <b>Description of user functions</b> </h4><br>  Currently, <b>PostgreSQL</b> allows you to define custom functions of the following types: <br><ul><li>  <i>SQL</i> functions </li><li>  C functions </li><li>  functions in procedural languages ‚Äã‚Äã( <i>plpgsql</i> , <i>pltcl</i> , <i>plperl</i> , etc.) </li></ul><br>  <i>SQL</i> functions are functions in the body of which there is one or more <i>SQL</i> queries, with the return result being the result of the last query.  However, if the return result is not <i>void</i> , <b>INSERT</b> , <b>UPDATE</b> , or <b>DELETE</b> with the <b>RETURNING clause is</b> allowed. <br><br>  C functions are statically and dynamically loaded.  Statically loaded (also called internal functions) are created on the server during database cluster initialization, dynamically loaded - loaded by the server on demand. <br><br>  Functions in procedural languages ‚Äã‚Äãrequire the creation of appropriate extensions, and some of the languages ‚Äã‚Äãcan be of two types - trusted and not trusted (for the latter there is no possibility to limit user actions).  In the basic delivery of <b>PostgreSQL</b> go <i>plpgsql</i> , <i>pltcl</i> , <i>plperl</i> and <i>plpython</i> , a list of other languages ‚Äã‚Äãcan be found <a href="http://www.postgresql.org/docs/current/static/external-pl.html">here</a> .  Extensions for procedural languages ‚Äã‚Äãare created via <i>SQL</i> : <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION pltcl; <span class="hljs-comment"><span class="hljs-comment">--    pltcl CREATE EXTENSION pltclu; --     pltcl</span></span></code> </pre> <br>  Or via the console (plpython is available only in a non-trusted form): <br><pre> <code class="bash hljs">createlang plpythonu</code> </pre><br><h4>  <b>Dynamically loadable C functions</b> </h4><br>  Dynamically loaded functions on C are contained in dynamically loaded (or shared) libraries, which are loaded when the function is first called.  An example of creating such a function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> grayscale ( r <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, g <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, b <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>, <span class="hljs-string"><span class="hljs-string">'grayscale'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span>;</code> </pre><br>  This example creates the function <b>grayscale</b> (which has three <i>float</i> parameters and returns a <i>float</i> ), which is located in the <i>utils</i> dynamic library.  The <b>STRICT</b> keyword is used so that the function returns <b>NULL</b> if at least one of the arguments is <b>NULL.</b> If the absolute path is not specified, the directory specified in the variable <i>dynamic_library_path is</i> implied, whose value can be viewed like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> current_setting ( <span class="hljs-string"><span class="hljs-string">'dynamic_library_path'</span></span> );</code> </pre><br>  Moreover, if the value of a variable or the path to the dynamic library begins with <i>$ libdir</i> , then <i>$ libdir</i> is replaced with the path to the directory containing the <b>PostgreSQL</b> libraries, which can be found using the console command: <br><pre> <code class="bash hljs">pg_config --pkglibdir</code> </pre><br>  Since the library is loaded with the rights of the user under which the <b>PostgreSQL</b> daemon is started (as a rule, it is <b>postgres</b> ), this user must have access rights to the library. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For functions, there are two types of convention: <i>version 0</i> (obsolete) and <i>version 1</i> .  The functions of <i>version 0 are</i> not portable and have limited functionality, therefore, the functions of <i>version 1 are</i> implied below.  To indicate that we are using <i>version 1</i> , the function, before defining it, must be marked with a special macro: <br><pre> <code class="cpp hljs">PG_FUNCTION_INFO_V1(grayscale);</code> </pre><br><br><h4>  <b>Dynamic library structure</b> </h4><br>  Each library must have a magic block (one, regardless of the number of files), in order to be able to detect inconsistencies, for example, the older version of <b>PostgreSQL</b> server and the version of <b>PostgreSQL</b> with which the library is compiled.  This block is declared like this: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;fmgr.h&gt; #ifdef PG_MODULE_MAGIC PG_MODULE_MAGIC; #endif</span></span></span></span></code> </pre><br>  If necessary, you can define the initialization function <b>_PG_init</b> (having no parameters and returning <i>void</i> ), which is called after loading the library, and the completion function <b>_PG_fini</b> (having the same signature as <b>_PG_init</b> ), which is called before unloading the library.  Please note, the documentation states that currently the libraries are not being unloaded, therefore the <b>_PG_fini</b> function <b>will</b> never be called.  Example functions: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _PG_init() { createLog(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _PG_fini() { destroyLog(); }</code> </pre><br>  Functions in the library have a specific form, for parameters, receiving arguments, returning the result and some other operations, special macros are provided (described in more detail below): <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Datum </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grayscale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PG_FUNCTION_ARGS)</span></span></span><span class="hljs-function"> </span></span>{ float8 r = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">0</span></span>); float8 g = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">1</span></span>); float8 b = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">2</span></span>); PG_RETURN_FLOAT8(<span class="hljs-number"><span class="hljs-number">0.299</span></span> * r + <span class="hljs-number"><span class="hljs-number">0.587</span></span> * g + <span class="hljs-number"><span class="hljs-number">0.114</span></span> * b); }</code> </pre><br><br><h4>  <b>Data types</b> </h4><br>  The basic data types used in functions are divided into three types: <br><ul><li>  fixed length passed by value </li><li>  with fixed length, passed by pointer </li><li>  variable length transmitted by pointer </li></ul><br>  Types of the first type can be 1, 2 or 4 bytes in size (or 8, if <i>sizeof (Datum)</i> is 8 on your platform).  When defining your own types (for example, via <i>typedef</i> ), you must be sure that they are the same size on all architectures. <br><br>  Types with a fixed length, passed to the pointer, are structures.  To allocate memory for them (and types of the third kind), it is necessary using <i>palloc</i> , for example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> r, g, b, a; } Color; Color *color = (Color*)palloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Color));</code> </pre><br>  For types of the third type, it is necessary to define a field (4 bytes) for storing the size of the entire type (data size + field size) and, in fact, the data itself, which is continuously located beyond this field.  This can be done using the structure of the form: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> int32 length; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> data[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } text;</code> </pre><br>  The value of a field with a type size is set implicitly using the <b>SET_VARSIZE</b> macro.  Other macros for working with variable length types passed by the pointer: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> data[<span class="hljs-number"><span class="hljs-number">10</span></span>]; ... text *<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> = (text*)palloc(VARHDRSZ + <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">// VARHDRSZ -      SET_VARSIZE(string, VARHDRSZ + 20); // SET_VARSIZE -    memcpy(VARDATA(string), data, 10); // VARDATA -    </span></span></code> </pre><br>  The correspondence between types in C and <i>SQL</i> functions is indicated in <a href="http://www.postgresql.org/docs/current/static/xfunc-c.html">this</a> table. <br><br>  Regarding the types passed by the pointer, it should be noted that the data pointed to by this pointer cannot be changed, since this may be data that is directly on the disk, which can lead to damage to it.  The consequences will not be very happy. <br><br><h4>  <b>Function structure</b> </h4><br>  The signature of the function should have the following form: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Datum </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grayscale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PG_FUNCTION_ARGS)</span></span></span></span>;</code> </pre><br>  <b>Datum</b> is a special type for the return value of a function, essentially a <i>typedef</i> pointer.  The <b>PG_FUNCTION_ARGS</b> macro <b>is</b> expanded into a pointer to a structure containing meta information about the function parameters: the context of the call, whether the value is <b>NULL,</b> and so on.  The function arguments are accessed using the <b>PG_GETARG_ *</b> macros: <br><pre> <code class="cpp hljs">float8 r = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     float8 int32 x = PG_GETARG_INT32(1); //     int32 text *msg = PG_GETARG_TEXT_P(2); //     text*</span></span></code> </pre><br>  If the <i>SQL</i> function is declared without <b>STRICT</b> , you can use PG_ARGISNULL to check if the value of the argument is <b>NULL</b> .  You can return the result of a function as <b>NULL</b> , via <b>PG_RETURN_NULL</b> .  As an example, let's see how the implementation of a function without <b>STRICT</b> looks like: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Datum </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grayscale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PG_FUNCTION_ARGS)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PG_ARGISNULL(<span class="hljs-number"><span class="hljs-number">0</span></span>) || PG_ARGISNULL(<span class="hljs-number"><span class="hljs-number">1</span></span>) || PG_ARGISNULL(<span class="hljs-number"><span class="hljs-number">2</span></span>)) { PG_RETURN_NULL(); } float8 r = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">0</span></span>); float8 g = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">1</span></span>); float8 b = PG_GETARG_FLOAT8(<span class="hljs-number"><span class="hljs-number">2</span></span>); PG_RETURN_FLOAT8(<span class="hljs-number"><span class="hljs-number">0.299</span></span> * r + <span class="hljs-number"><span class="hljs-number">0.587</span></span> * g + <span class="hljs-number"><span class="hljs-number">0.114</span></span> * b); }</code> </pre><br><h4>  <b>Function example</b> </h4><br><img src="https://habrastorage.org/storage3/bb9/6f2/581/bb96f2581ae0675b7dda826efa4bb2dd.jpeg"><br>  Now, knowing how to write a stored function in C, let's summarize and look at an example.  The environment we will have is: <br><ul><li>  operating system: Ubuntu 12.10 </li><li>  PostgreSQL version: 9.3 </li><li>  compiler: gcc 4.7.2 </li></ul><br>  Create a utils.c file with the following contents: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;postgres.h&gt; #include &lt;fmgr.h&gt; #ifdef PG_MODULE_MAGIC PG_MODULE_MAGIC; #endif PG_FUNCTION_INFO_V1(grayscale); Datum grayscale(PG_FUNCTION_ARGS) { float8 r = PG_GETARG_FLOAT8(0); float8 g = PG_GETARG_FLOAT8(1); float8 b = PG_GETARG_FLOAT8(2); PG_RETURN_FLOAT8(0.299 * r + 0.587 * g + 0.114 * b); }</span></span></span></span></code> </pre><br>  Next, let's compile utils.c into an object file, while it should be with <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4">position-independent</a> code (for <i>gcc</i> , this is the <i>fpic</i> option): <br><pre> <code class="bash hljs">cc -I/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/include/server -fpic -c utils.c</code> </pre><br>  The <i>pg_config --includedir-server</i> command <i>will prompt the</i> location of the directory with header files.  Linking the object file as a dynamic library (if everything is in order, we should have the <i>utils.so</i> dynamic library, copy it to <i>/ usr / local / pgsql / lib</i> ): <br><pre> <code class="bash hljs">cc -shared -L/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/lib -lpq -o utils.so utils.o</code> </pre><br>  Now, connect to our database and create the function <i>grayscale_c</i> in it, specifying some options: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> grayscale_c ( r <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, g <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, b <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>, <span class="hljs-string"><span class="hljs-string">'grayscale'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> C <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span> VOLATILE <span class="hljs-keyword"><span class="hljs-keyword">COST</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>;;</code> </pre><br>  Check its performance: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> grayscale_c ( <span class="hljs-number"><span class="hljs-number">0.6</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span> ); <span class="hljs-comment"><span class="hljs-comment">-- : 0.5299</span></span></code> </pre><br>  But that is not all.  Let's compare this function with a similar one, but on plpgsql.  <i>Let's</i> call it <i>grayscale_plpgsql</i> : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> grayscale_plpgsql ( r <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, g <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, b <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">0.299</span></span> * r + <span class="hljs-number"><span class="hljs-number">0.587</span></span> * g + <span class="hljs-number"><span class="hljs-number">0.114</span></span> * b; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql <span class="hljs-keyword"><span class="hljs-keyword">STRICT</span></span> VOLATILE <span class="hljs-keyword"><span class="hljs-keyword">COST</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>;</code> </pre><br>  And we will do some test: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> color <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> random () <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r, random () <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> g, random () <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> grayscale_c ( r, g, b ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> color; <span class="hljs-comment"><span class="hljs-comment">--   : 926  SELECT grayscale_plpgsql ( r, g, b ) FROM color; --   : 3679 </span></span></code> </pre><br>  A small check: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> color <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> grayscale_c ( r, g, b ) != grayscale_plpgsql ( r, g, b ); <span class="hljs-comment"><span class="hljs-comment">-- 0 </span></span></code> </pre><br>  Very good result. <br><br>  As we have seen, the creation of dynamically loaded functions on C is not such a complicated thing.  Difficulties, as a rule, are hidden in their implementation. <br><br>  PS Thank you for your attention. <br><br>  References: <br><ul><li>  <a href="http://www.postgresql.org/docs/9.3/static">PostgreSQL Official Documentation</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/196544/">https://habr.com/ru/post/196544/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196530/index.html">DHTML violence and javascript output to desktop. Restoration of old games. Building Web Applications</a></li>
<li><a href="../196532/index.html">RuSSIR Music Hackathon 2013: notes of the organizer</a></li>
<li><a href="../196536/index.html">Promo of new Zoloo game for fun friends groups</a></li>
<li><a href="../196538/index.html">The digest of interesting news and materials from the world of PHP for the last two weeks, No. 27 (September 22 - October 6, 2013)</a></li>
<li><a href="../196542/index.html">NVIDIA Shield - the best portable boom console</a></li>
<li><a href="../196546/index.html">We are preparing a web application for the zoo versions of Android</a></li>
<li><a href="../196548/index.html">Lock-free data structures. The basics: where did the memory barriers go from?</a></li>
<li><a href="../196550/index.html">Configuring Vim to work with Python code</a></li>
<li><a href="../196556/index.html">Test of the prototype of the iLook Media Center</a></li>
<li><a href="../196560/index.html">Introduction to the analysis of the complexity of algorithms (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>