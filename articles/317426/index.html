<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring Microsoft SQL Server "on the knee"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I got a new job, the first task was set before me - to find out why one of the SQL instances is very hard on the disks. And take the necessary ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring Microsoft SQL Server "on the knee"</h1><div class="post__text post__text-html js-mediator-article">  When I got a new job, the first task was set before me - to find out why one of the SQL instances is very hard on the disks.  And take the necessary action to eliminate this terrible problem.  I have not yet said that the disk pool was only one, and that under the load on the disks all copies of the sequel suffered?  So that was it.  What is most important, as it turned out, monitoring in the face of Zabbix did not collect the necessary metrics, and it was necessary to make an application and wait for the addition of these.  Wait and watch the disk array ‚Äúburn‚Äù.  Or‚Ä¶ <br><br>  It was decided to send a request on a journey through the gears of the bureaucratic mechanism and make its own, temporary monitoring. <br><br>  To begin with, let's create a database and objects necessary for collecting metrics of SQL server performance. <br><a name="habracut"></a><br>  For simplicity, I did not specify the database creation options in the script: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> monitor <span class="hljs-comment"><span class="hljs-comment">--   GO use monitor GO create table perf_counters --  ,       ( collect_time datetime, counter_name nvarchar(128), value bigint ) GO CREATE CLUSTERED INDEX cidx_collect_time -- ,      select ON perf_counters ( collect_time ) GO</span></span></code> </pre> <br>  Performance counters will be taken from the sys.dm_os_performance_counters system view.  The script describes the most popular and vital counters, of course, the list can be expanded.  I would like to clarify about CASE'ov.  Counters that are measured in ‚Äúsomething‚Äù / second are incremental.  Those.  SQL Server every second adds the current value of the counter to the existing one.  To get the average current value, the value in the view should be divided by the server uptime in seconds.  You can learn uptime by request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(SS, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> create_date <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.databases <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'tempdb'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>())</code> </pre> <br>  Those.  find the difference between the current moment and the time of creating tempdb, which, as you know, is created when the server starts. <br><br>  Metric Granted Workspace Memory (KB) immediately translate into megabytes. <br><br>  The collection process will be in the form of a procedure: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> sp_insert_perf_counters <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> perf_counters <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Collect_time, Counter = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> counter_name = <span class="hljs-string"><span class="hljs-string">'Granted Workspace Memory (KB)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'Granted Workspace Memory (MB)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rtrim</span></span>(counter_name) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> counter_name <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%/sec%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cntr_value/<span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(SS, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> create_date <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.databases <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'tempdb'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> counter_name <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'Granted Workspace Memory (KB)%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cntr_value/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> cntr_value <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_os_performance_counters <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> counter_name = N<span class="hljs-string"><span class="hljs-string">'Checkpoint Pages/sec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = N<span class="hljs-string"><span class="hljs-string">'Processes Blocked'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (counter_name = N<span class="hljs-string"><span class="hljs-string">'Lock Waits/sec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> instance_name = <span class="hljs-string"><span class="hljs-string">'_Total'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = N<span class="hljs-string"><span class="hljs-string">'User Connections'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = N<span class="hljs-string"><span class="hljs-string">'SQL Re-Compilations/sec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = N<span class="hljs-string"><span class="hljs-string">'SQL Compilations/sec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = <span class="hljs-string"><span class="hljs-string">'Batch Requests/sec'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (counter_name = <span class="hljs-string"><span class="hljs-string">'Page life expectancy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> object_name <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%Buffer Manager%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> counter_name = <span class="hljs-string"><span class="hljs-string">'Granted Workspace Memory (KB)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Next, we will create a procedure that will select data from our log table.  The parameters <a href="https://habrahabr.ru/users/end/" class="user_link">end</a> and <a href="https://habrahabr.ru/users/start/" class="user_link">start</a> set the time interval for which we want to see the values.  If the parameters are not set, display information in the last 3 hours. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> sp_select_perf_counters @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> datetime = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> datetime = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(HH, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> collect_time, counter_name, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> monitor..perf_counters <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> collect_time &gt;= @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> collect_time &lt;= @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span></code> </pre> <cut><br>  Wrap sp_insert_perf_counters in the SQL Agent job.  With start frequency - once a minute. <br>  I will skip the creation script to not clutter up the text.  At the end lay out all in the form of a single script. <br><br>  Looking ahead, I‚Äôll say that it was also because of the banal lack of RAM, so I‚Äôll immediately give you a script that allows you to see the ‚Äúfight‚Äù of the database for the buffer pool.  Create a label where we will add the data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> BufferPoolLog( [collection_time] [datetime], [db_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>), [<span class="hljs-keyword"><span class="hljs-keyword">Size</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>](<span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>), [dirty_pages_size] [<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>](<span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>) )</code> </pre> <br>  Let's create a procedure that will output the use of the buffer pool with each separate database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> sp_insert_buffer_pool_log <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> Monitor.dbo.BufferPoolLog <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> collection_time, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> database_id = <span class="hljs-number"><span class="hljs-number">32767</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'ResourceDB'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> DB_NAME(database_id) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [db_name], (<span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) * <span class="hljs-number"><span class="hljs-number">8.0</span></span>) / <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Size</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (is_modified = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) * <span class="hljs-number"><span class="hljs-number">8</span></span> / <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dirty_pages_size <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_os_buffer_descriptors <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> database_id</code> </pre> <br>  Dirty pages = modified pages.  This procedure is wrapped in a jobb.  I set to run once every three minutes.  And create a procedure for select: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> sp_select_buffer_pool_log @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> datetime = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> datetime = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(HH, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> collection_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'collection_time'</span></span>, db_name, <span class="hljs-keyword"><span class="hljs-keyword">Size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'size'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> BufferPoolLog <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (collection_time&gt;= @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> collection_time&lt;= @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> collection_time, db_name</code> </pre> <br>  Great, data is collected, the historical base is accumulating, it remains to come up with a convenient way to view.  And here good old Excel comes to the rescue. <br><br>  I will give an example for performance counters, and for using the buffer pool it can be configured by analogy. <br><br>  Open Excel, go to ‚ÄúData‚Äù - ‚ÄúFrom other sources‚Äù - ‚ÄúFrom Microsoft Query‚Äù. <br><br>  We create a new data source: driver - SQL Server or ODBC for SQL Server or SQL Server native Client, click ‚Äúlink‚Äù and set up our server, select our database in the parameters, in step 4 select any table (we will not need it). <br><br>  Click on our created data source, click "Cancel" and the question "Continue to change the query in Microsoft Query?" Click "Yes." <br><br>  Close the "Add Table" dialog.  Next, go to "File" ‚Üí "Run a query to SQL."  We write <code>exec sp_select_perf_counters</code> .  Click OK, go to ‚ÄúFile‚Äù - ‚Äúreturn data to Microsoft Excel‚Äù. <br><br>  Choose where to put the results.  I recommend leaving two lines on top for the parameters. <br>  Go to "Data" - "Connections", go to the properties of our connection.  Go to the tab ‚ÄúDefinition‚Äù and where the text of the command is written exec sp_select_perf_counters?,? .. <br>  Click OK and Excel prompts us to choose from which cells to take these parameters.  We indicate to him these cells, put the checkboxes ‚Äúto use the default‚Äù and ‚Äúautomatically update when the cell changes‚Äù.  Personally, I filled these cells with the formulas: <br><br><blockquote>  Parameter1 = TDA () - 3/24 (current date and time minus 3 hours) <br>  Parameter2 = TDA () (current date and time) </blockquote><br>  Next, click on our table and go to the "Insert" - "Pivot Table" - "Pivot Chart". <br>  Customize the pivot table: <br><br><blockquote>  Fields of legend - counter_name, <br>  Axis fields are collect_time, <br>  Values ‚Äã‚Äã- value. </blockquote><br>  Voila!  We get graphs of performance metrics.  I recommend changing the chart type to ‚ÄúGraph‚Äù.  There are still a couple of shtrishkov.  Go to the page with our data, again go to the properties of the connection and set the value to ‚ÄúUpdate every X minutes‚Äù at will.  I think it is logical to set the frequency equal to the frequency of the job on the SQL server. <br><br>  Now the data in the table is updated automatically.  It remains to make the schedule updated.  Go to the tab "developer" - "Visual Basic". <br><br>  Left click on the sheet with the source data and enter the following code: <br><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span> Worksheet_Change(<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Target As Range) Worksheets(<span class="hljs-string"><span class="hljs-string">""</span></span>).PivotTables(<span class="hljs-string"><span class="hljs-string">"1"</span></span>).PivotCache.Refresh <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span></code> </pre><br>  Where, <br><br>  "Summary" - the name of the sheet with a pivot table.  The name that is shown in brackets in the VB editor. <br>  Summary Table1 is the name of the pivot table.  You can see by clicking on the pivot table and go to the "Parameters" section. <br><br>  Now our schedule will be updated each time the source table is updated.  An example of such a schedule: <br><br><img src="https://habrastorage.org/files/588/731/1b4/5887311b4bd947eaa6ecb0804dc4bb47.PNG" alt="image"><br><br>  To clone a file, it is enough to change the connection string in the properties of our connection in Excel by entering the new server name. <br><br>  Regarding the ‚Äúfight‚Äù of databases for the buffer pool and the calculation of the recommended amount of RAM, you can use the following script to minimize this fight.  Calculates the maximum use of RAM in each database, as well as the average percentage of the size of the buffer pool relative to the total size of RAM allocated to the server and, based on this data, calculates the ‚Äúideal‚Äù size of RAM required by the server: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ram <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @avg_perc <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>, @recommended_ram <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span> <span class="hljs-comment"><span class="hljs-comment">--,     SELECT @ram = CONVERT(INT,value_in_use ) FROM sys.configurations WHERE name = 'max server memory (MB)' ORDER BY name OPTION (RECOMPILE); --       Buffer Pool SELECT @avg_perc = avg(t.perc) FROM ( SELECT sum(Size)/@ram*100 AS perc FROM Monitor.dbo.BufferPoolLog GROUP BY collection_time ) t --     SELECT @recommended_ram = sum(t.maxsize)*100/@avg_perc FROM ( SELECT db_name, MAX(Size) AS maxsize FROM Monitor.dbo.BufferPoolLog GROUP BY db_name ) t select @ram as current_RAM_MB, @recommended_ram as Recommended_RAM_MB</span></span></code> </pre> <br>  It is worth noting that these calculations make sense only if you are sure that the queries running on the server are optimized and do not do a full table scan at every convenient (and not so) case.  You should also make sure that you monitor the Maximum Granted Workspace metric that you do not have requests on the server that eat off part of the buffer pool for sorting and hash operations. <br><br>  An example of a database war for buffer cache (names smeared): <br><br><img src="https://habrastorage.org/files/e0a/591/0a1/e0a5910a1aa740ab8fce47661c74d8fe.PNG" alt="image"><br><br>  By the way, it turned out that this method works much faster than our zabbiks, so I kept it in service. <br><br>  As promised, the whole T-sql in one script: <br><br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> monitor <span class="hljs-comment"><span class="hljs-comment">--   GO use monitor GO create table perf_counters --  ,       ( collect_time datetime, counter_name nvarchar(128), value bigint ) GO CREATE CLUSTERED INDEX cidx_collect_time -- ,      select ON perf_counters ( collect_time ) GO CREATE TABLE BufferPoolLog ( collection_time datetime NOT NULL, db_name nvarchar(128) NULL, Size numeric(18, 6) NULL, dirty_pages_size numeric(18, 6) ) GO CREATE CLUSTERED INDEX cidx_collection_time ON BufferPoolLog ( collection_time ) GO create procedure sp_insert_perf_counters -- ,    AS insert into perf_counters select getdate() as Collect_time, rtrim(counter_name) as Counter, Value = CASE WHEN counter_name like '%/sec%' --,  "-  " - , ..    ""     -  . ,       then cntr_value/DATEDIFF(SS, (select create_date from sys.databases where name = 'tempdb'), getdate()) ELSE cntr_value END from sys.dm_os_performance_counters where counter_name = N'Checkpoint Pages/sec' or counter_name = N'Processes Blocked' or (counter_name = N'Lock Waits/sec' and instance_name = '_Total') or counter_name = N'User Connections' or counter_name = N'SQL Re-Compilations/sec' or counter_name = N'SQL Compilations/sec' or counter_name = 'Batch Requests/sec' or (counter_name = 'Page life expectancy' and object_name like '%Buffer Manager%') GO create procedure sp_select_perf_counters --  ,      @start datetime = NULL, @end datetime = NULL as if @start is NULL set @start = dateadd(HH, -3, getdate()) if @end is NULL set @end = getdate() select collect_time, counter_name, value from monitor..perf_counters where collect_time &gt;= @start and collect_time &lt;= @end go CREATE procedure sp_insert_buffer_pool_log --,          AS insert into BufferPoolLog SELECT getdate() as collection_time, CASE WHEN database_id = 32767 THEN 'ResourceDB' ELSE DB_NAME(database_id) END as [db_name], (COUNT(*) * 8.0) / 1024 as Size, Sum(CASE WHEN (is_modified = 1) THEN 1 ELSE 0 END) * 8 / 1024 AS dirty_pages_size FROM sys.dm_os_buffer_descriptors GROUP BY database_id GO CREATE procedure sp_select_buffer_pool_log @start datetime = NULL, @end datetime = NULL AS if @start is NULL set @start = dateadd(HH, -3, getdate()) if @end is NULL set @end = getdate() SELECT collection_time, db_name, Size FROM BufferPoolLog WHERE (collection_time&gt;= @start And collection_time&lt;= @end) ORDER BY collection_time, db_name GO --   ,       USE [msdb] GO BEGIN TRANSACTION DECLARE @ReturnCode INT SELECT @ReturnCode = 0 IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1) BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]' IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback END DECLARE @jobId BINARY(16) EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name=N'collect_perf_counters', @enabled=1, @notify_level_eventlog=0, @notify_level_email=0, @notify_level_netsend=0, @notify_level_page=0, @delete_level=0, @description=N'No description available.', @category_name=N'[Uncategorized (Local)]', @owner_login_name=N'sa', @job_id = @jobId OUTPUT IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'sp_insert_perf_counters', @step_id=1, @cmdexec_success_code=0, @on_success_action=1, @on_success_step_id=0, @on_fail_action=2, @on_fail_step_id=0, @retry_attempts=0, @retry_interval=0, @os_run_priority=0, @subsystem=N'TSQL', @command=N'sp_insert_perf_counters', @database_name=N'monitor', @flags=0 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every 1 minute', @enabled=1, @freq_type=4, @freq_interval=1, @freq_subday_type=4, @freq_subday_interval=1, @freq_relative_interval=0, @freq_recurrence_factor=0, @active_start_date=20161202, @active_end_date=99991231, @active_start_time=0, @active_end_time=235959 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)' IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback COMMIT TRANSACTION GOTO EndSave QuitWithRollback: IF (@@TRANCOUNT &gt; 0) ROLLBACK TRANSACTION EndSave: GO --  ,       .     BEGIN TRANSACTION DECLARE @ReturnCode INT SELECT @ReturnCode = 0 IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1) BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]' IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback END DECLARE @jobId BINARY(16) EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name=N'BufferPoolUsage', @enabled=1, @notify_level_eventlog=0, @notify_level_email=0, @notify_level_netsend=0, @notify_level_page=0, @delete_level=0, @description=N'No description available.', @category_name=N'[Uncategorized (Local)]', @owner_login_name=N'sa', @job_id = @jobId OUTPUT IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'1', @step_id=1, @cmdexec_success_code=0, @on_success_action=1, @on_success_step_id=0, @on_fail_action=2, @on_fail_step_id=0, @retry_attempts=0, @retry_interval=0, @os_run_priority=0, @subsystem=N'TSQL', @command=N'sp_insert_buffer_pool_log', @database_name=N'Monitor', @flags=0 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every 3 minutes', @enabled=1, @freq_type=4, @freq_interval=1, @freq_subday_type=4, @freq_subday_interval=3, @freq_relative_interval=0, @freq_recurrence_factor=0, @active_start_date=20161117, @active_end_date=99991231, @active_start_time=0, @active_end_time=235959 IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)' IF (@@ERROR &lt;&gt; 0 OR @ReturnCode &lt;&gt; 0) GOTO QuitWithRollback COMMIT TRANSACTION GOTO EndSave QuitWithRollback: IF (@@TRANCOUNT &gt; 0) ROLLBACK TRANSACTION EndSave: GO</span></span></code> </pre> <br></div></div><br>  Articles used: <br><br>  <a href="http://logicalread.solarwinds.com/sql-server-memory-buffer-pools-pd01/">SQL Server Memory Buffer Pools: Understand the Basics</a> <br>  ¬ª <a href="http://sqlindia.com/how-to-execute-stored-procedure-in-excel-with-parameters/">How to execute stored procedure in excel with parameters</a> </cut></div><p>Source: <a href="https://habr.com/ru/post/317426/">https://habr.com/ru/post/317426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317408/index.html">Fear and loathing in a single startup. Part 2 - Hate</a></li>
<li><a href="../317412/index.html">Mitap RDSFront & # 1</a></li>
<li><a href="../317418/index.html">Overview of Extreme Networks online stacking tools</a></li>
<li><a href="../317420/index.html">NetGear routers are vulnerable</a></li>
<li><a href="../317422/index.html">CTFzone write-ups - Deeper into the WEB</a></li>
<li><a href="../317428/index.html">Clouds like love</a></li>
<li><a href="../317430/index.html">CSS selectors in the showroom</a></li>
<li><a href="../317432/index.html">How to become an Oracle Certified Professional Java SE 8 Programmer</a></li>
<li><a href="../317434/index.html">Assassin's Creed III mission design lessons in the open world</a></li>
<li><a href="../317438/index.html">New approaches to securing virtual infrastructure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>