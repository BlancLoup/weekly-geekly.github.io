<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing the data access layer on the Entity Framework Code First</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings 

 In this topic, I want to talk about the data access layer (Data Access Level) in relation to the Entity Framework, then EF, about what ta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing the data access layer on the Entity Framework Code First</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3b3/256/4a8/3b32564a8b65eeecbf6cc9240a1dd00b.png"><br><br>  Greetings <br><br>  In this topic, I want to talk about the data access layer (Data Access Level) in relation to the Entity Framework, then EF, about what tasks were and how I solved them.  All submitted code from the post, as well as the <a href="http://yadi.sk/d/P9XDDznpMj6p8">attached demo project is</a> published under the liberal MIT license, that is, you can use the code as you wish. <br>  At once I want to emphasize that all the presented code is a complete solution and has been used for more than 2 years in a project for a rather large Russian company, but nevertheless it is not suitable for highly loaded systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Details under the cut. <br><a name="habracut"></a><br><h5>  Tasks </h5><br>  When writing the application, I had several tasks in relation to the data access layer: <br>  1. All changes to the data should be logged, including information about which user actually did it. <br>  2. Using the <a href="http://habrahabr.ru/post/52173/">‚ÄúRepository‚Äù</a> pattern <br>  3. Control over the change of objects, that is, if we want to update only one object in the database, then exactly one object must. <br>  I will explain: <br>  By default, EF tracks changes to all objects within a specific context, while the ability to save one object is absent, unlike NHibernate.  This situation is fraught with various unpleasant errors.  For example, a user edits two objects at the same time, but wants to save only one.  In case these two objects are connected to the same database context, the EF will save the changes to both objects. <br><br><h5>  Decision </h5><br>  There is quite a lot of code, so I add comments to the most interesting points. <br>  Perhaps I'll start with the most important object - the context of the database. <br>  In standard and simplified form, it is a list of database objects: <br><div class="spoiler">  <b class="spoiler_title">UsersContext</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">TestApp.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UsersContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UsersContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Name=UsersContext"</span></span></span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;User&gt; Users { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Configurations.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserMap()); } } }</code> </pre> <br></div></div><br>  Extend it using the following interface: <br><div class="spoiler">  <b class="spoiler_title">IDbContext</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IDbContext</span></span> { IQueryable&lt;T&gt; Find&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MarkAsAdded&lt;T&gt;(T entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MarkAsDeleted&lt;T&gt;(T entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MarkAsModified&lt;T&gt;(T entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Commit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> withLogging</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      void Rollback(); //       void EnableTracking(bool isEnable); EntityState GetEntityState&lt;T&gt;(T entity) where T : class; void SetEntityState&lt;T&gt;(T entity, EntityState state) where T : class; //         DbChangeTracker GetChangeTracker(); DbEntityEntry GetDbEntry&lt;T&gt;(T entity) where T : class; }</span></span></code> </pre><br></div></div><br>  The resulting modified DbContext: <br><div class="spoiler">  <b class="spoiler_title">DemoAppDbContext</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.DbContexts</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DemoAppDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span>, <span class="hljs-title"><span class="hljs-title">IDbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> User CurrentUser { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILogger _logger; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Context Entities public DbSet&lt;EntityChange&gt; EntityChanges { get; set; } public DbSet&lt;User&gt; Users { get; set; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> static DemoAppDbContext() { //  Database.SetInitializer(new CreateDBContextInitializer()); } //       public static void Seed(DemoAppDbContext context) { //     var defaultUser = new User { Email = "UserEmail@email.ru", Login = "login", IsBlocked = false, Name = "Vasy Pupkin" }; context.Users.Add(defaultUser); context.SaveChanges(); } public DemoAppDbContext(string nameOrConnectionString) : base(nameOrConnectionString) { //   _logger = new Logger(this); } protected override void OnModelCreating(DbModelBuilder modelBuilder) { modelBuilder.Configurations.Add(new EntityChangeMap()); modelBuilder.Configurations.Add(new UserMap()); } public void MarkAsAdded&lt;T&gt;(T entity) where T : class { Entry(entity).State = EntityState.Added; Set&lt;T&gt;().Add(entity); } public void MarkAsDeleted&lt;T&gt;(T entity) where T : class { Attach(entity); Entry(entity).State = EntityState.Deleted; Set&lt;T&gt;().Remove(entity); } public void MarkAsModified&lt;T&gt;(T entity) where T : class { Attach(entity); Entry(entity).State = EntityState.Modified; } public void Attach&lt;T&gt;(T entity) where T : class { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Entry(entity).State == EntityState.Detached) { Set&lt;T&gt;().Attach(entity); } } public void Commit(bool withLogging) { BeforeCommit(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (withLogging) { _logger.Run(); } SaveChanges(); } private void BeforeCommit() { UndoExistAddedEntitys(); } // ,      ,        private void UndoExistAddedEntitys() { IEnumerable&lt;DbEntityEntry&gt; dbEntityEntries = GetChangeTracker().Entries().Where(x =&gt; x.State == EntityState.Added); foreach (var dbEntityEntry in dbEntityEntries) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (GetKeyValue(dbEntityEntry.Entity) &gt; 0) { SetEntityState(dbEntityEntry.Entity, EntityState.Unchanged); } } } //      public void Rollback() { ChangeTracker.Entries().ToList().ForEach(x =&gt; x.Reload()); } public void EnableTracking(bool isEnable) { Configuration.AutoDetectChangesEnabled = isEnable; } public void SetEntityState&lt;T&gt;(T entity, EntityState state) where T : class { Entry(entity).State = state; } public DbChangeTracker GetChangeTracker() { return ChangeTracker; } public EntityState GetEntityState&lt;T&gt;(T entity) where T : class { return Entry(entity).State; } public IQueryable&lt;T&gt; Find&lt;T&gt;() where T : class { return Set&lt;T&gt;(); } public DbEntityEntry GetDbEntry&lt;T&gt;(T entity) where T : class { return Entry(entity); } public static int GetKeyValue&lt;T&gt;(T entity) where T : class { var dbEntity = entity as IDbEntity; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (dbEntity == null) throw new ArgumentException("Entity should be IDbEntity type - " + entity.GetType().Name); return dbEntity.GetPrimaryKey(); } } }</span></span></code> </pre><br></div></div><br>  Interaction with database objects occurs through repositories specific to each object.  All repositories inherit the base class, which provides the basic CRUD functionality. <br><div class="spoiler">  <b class="spoiler_title">Irepository</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> { <span class="hljs-function"><span class="hljs-function">DemoAppDbContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDatabaseContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entityId</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    DbEntityValidationResult Validate(T entity); //     string ValidateAndReturnErrorString(T entity, out bool isValid); }</span></span></code> </pre><br></div></div><br>  Implementation of iRepository: <br><div class="spoiler">  <b class="spoiler_title">Baserepository</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Repositories</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BaseRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IContextManager _contextManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IContextManager contextManager</span></span></span><span class="hljs-function">)</span></span> { _contextManager = contextManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DbEntityValidationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = CreateDatabaseContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Entry(entity).GetValidationResult(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateAndReturnErrorString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isValid</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = CreateDatabaseContext()) { DbEntityValidationResult dbEntityValidationResult = context.Entry(entity).GetValidationResult(); isValid = dbEntityValidationResult.IsValid; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!dbEntityValidationResult.IsValid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DbValidationMessageParser.GetErrorMessage(dbEntityValidationResult); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; } } <span class="hljs-comment"><span class="hljs-comment">//    .   using public DemoAppDbContext CreateDatabaseContext() { return _contextManager.CreateDatabaseContext(); } public List&lt;T&gt; GetAll() { using (var context = CreateDatabaseContext()) { return context.Set&lt;T&gt;().ToList(); } } public T Find(int entityId) { using (var context = CreateDatabaseContext()) { return context.Set&lt;T&gt;().Find(entityId); } } //  .    ,       protected virtual void BeforeSave(T entity, DemoAppDbContext db) { } public T SaveOrUpdate(T entity) { var iDbEntity = entity as IDbEntity; if (iDbEntity == null) throw new ArgumentException("entity should be IDbEntity type", "entity"); return iDbEntity.GetPrimaryKey() == 0 ? Add(entity) : Update(entity); } public T Add(T entity) { using (var context = CreateDatabaseContext()) { BeforeSave(entity, context); context.MarkAsAdded(entity); context.Commit(true); } return entity; } public T Update(T entity) { using (var context = CreateDatabaseContext()) { var iDbEntity = entity as IDbEntity; if (iDbEntity == null) throw new ArgumentException("entity should be IDbEntity type", "entity"); var attachedEntity = context.Set&lt;T&gt;().Find(iDbEntity.GetPrimaryKey()); context.Entry(attachedEntity).CurrentValues.SetValues(entity); BeforeSave(attachedEntity, context); context.Commit(true); } return entity; } public void Delete(T entity) { using (var context = CreateDatabaseContext()) { context.MarkAsDeleted(entity); context.Commit(true); } } } }</span></span></code> </pre><br></div></div><br>  User database object: <br><div class="spoiler">  <b class="spoiler_title">User</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> : <span class="hljs-title"><span class="hljs-title">IDbEntity</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EntityChanges = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;EntityChange&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(AllowEmptyStrings = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"Please input Login"</span></span>)] [StringLength(<span class="hljs-number"><span class="hljs-number">50</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"Login    50- "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Login { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(AllowEmptyStrings = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"Please input Email"</span></span>)] [StringLength(<span class="hljs-number"><span class="hljs-number">50</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"Email    50- "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(AllowEmptyStrings = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"Please input Name"</span></span>)] [StringLength(<span class="hljs-number"><span class="hljs-number">50</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">@"    50- "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsBlocked { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;EntityChange&gt; EntityChanges { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">": User; :{0}, UserId:{1} "</span></span>, Name, UserId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPrimaryKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UserId; } } }</code> </pre><br></div></div><br>  The repository for the User object, with a number of additional methods extending the standard CRUD functionality of the base class: <br><div class="spoiler">  <b class="spoiler_title">UsersRepository</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Repositories</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UsersRepository</span></span> : <span class="hljs-title"><span class="hljs-title">BaseRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UsersRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IContextManager contextManager</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">contextManager</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindByLogin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> login</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = CreateDatabaseContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db.Set&lt;User&gt;().FirstOrDefault(u =&gt; u.Login == login); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExistUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> login</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = CreateDatabaseContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db.Set&lt;User&gt;().Count(u =&gt; u.Login == login) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByUserId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = CreateDatabaseContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db.Set&lt;User&gt;().SingleOrDefault(c =&gt; c.UserId == userId); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFirst</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = CreateDatabaseContext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db.Set&lt;User&gt;().First(); } } } }</code> </pre><br></div></div><br>  In my case, all repositories are initialized once and added to the simplest self-written service locator RepositoryContainer.  This made for the possibility of writing tests. <br><div class="spoiler">  <b class="spoiler_title">RepositoryContainer</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Container</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RepositoryContainer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IContainer _repositoryContainer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Container(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> RepositoryContainer Instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepositoryContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RepositoryContainer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Resolve&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repositoryContainer.Resolve&lt;T&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register&lt;T&gt;(T entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { _repositoryContainer.Register(entity); } } } <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Container</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RepositoryContainerFactory</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterAllRepositories</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IContextManager dbContext</span></span></span><span class="hljs-function">)</span></span> { RepositoryContainer.Instance.Register(dbContext); RepositoryContainer.Instance.Register(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityChangesRepository(dbContext)); RepositoryContainer.Instance.Register(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UsersRepository(dbContext)); } } }</code> </pre><br></div></div><br>  To all repositories, during initialization, the IContextManager object is transmitted, this is done to enable working with several contexts and their centralized creation: <br><div class="spoiler">  <b class="spoiler_title">IContextManager</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Interfaces</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IContextManager</span></span> { <span class="hljs-function"><span class="hljs-function">DemoAppDbContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDatabaseContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } }</code> </pre><br></div></div><br>  And its implementation of ContextManager: <br><div class="spoiler">  <b class="spoiler_title">Contextmanager</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DataAccess.Interfaces; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.DbContexts</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ContextManager</span></span> : <span class="hljs-title"><span class="hljs-title">IContextManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionString; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ContextManager</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">)</span></span> { _connectionString = connectionString; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DemoAppDbContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDatabaseContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoAppDbContext(_connectionString); } } }</code> </pre><br></div></div><br>  Logging occurs in the object implementing the ILogger interface: <br><div class="spoiler">  <b class="spoiler_title">Ilogger</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DataAccess.Interfaces</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ILogger</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } }</code> </pre><br></div></div><br>  ILogger interface implementation <br><div class="spoiler">  <b class="spoiler_title">Logger</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Logger</span></span> : <span class="hljs-title"><span class="hljs-title">ILogger</span></span> { Dictionary&lt;EntityState, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _operationTypes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDbContext _dbContext; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDbContext dbContext</span></span></span><span class="hljs-function">)</span></span> { _dbContext = dbContext; InitOperationTypes(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { LogChangedEntities(EntityState.Added); LogChangedEntities(EntityState.Modified); LogChangedEntities(EntityState.Deleted); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitOperationTypes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _operationTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;EntityState, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { {EntityState.Added, <span class="hljs-string"><span class="hljs-string">""</span></span>}, {EntityState.Deleted, <span class="hljs-string"><span class="hljs-string">""</span></span>}, {EntityState.Modified, <span class="hljs-string"><span class="hljs-string">""</span></span>} }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOperationName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityState entityState</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _operationTypes[entityState]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogChangedEntities</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityState entityState</span></span></span><span class="hljs-function">)</span></span> { IEnumerable&lt;DbEntityEntry&gt; dbEntityEntries = _dbContext.GetChangeTracker().Entries().Where(x =&gt; x.State == entityState); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbEntityEntry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dbEntityEntries) { LogChangedEntitie(dbEntityEntry, entityState); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogChangedEntitie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbEntityEntry dbEntityEntry, EntityState entityState</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> operationHash = HashGenerator.GenerateHash(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> enitityId = DemoAppDbContext.GetKeyValue(dbEntityEntry.Entity); Type type = dbEntityEntry.Entity.GetType(); IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; propertyNames = entityState == EntityState.Deleted ? dbEntityEntry.OriginalValues.PropertyNames : dbEntityEntry.CurrentValues.PropertyNames; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propertyName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> propertyNames) { DbPropertyEntry property = dbEntityEntry.Property(propertyName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entityState == EntityState.Modified &amp;&amp; !property.IsModified) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; _dbContext.MarkAsAdded(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityChange { UserId = DemoAppDbContext.CurrentUser.UserId, Created = DateTime.Now, OperationHash = operationHash, EntityName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty, EntityType = type.ToString(), EntityId = enitityId.ToString(), PropertyName = propertyName, OriginalValue = entityState != EntityState.Added &amp;&amp; property.OriginalValue != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? property.OriginalValue.ToString() : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty, ModifyValue = entityState != EntityState.Deleted &amp;&amp; property.CurrentValue != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? property.CurrentValue.ToString() : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty, OperationType = GetOperationName(entityState), }); } } }</code> </pre><br></div></div><br><h5>  Using </h5><br>  In order to start working with the database, the application needs to initialize the repository factory: <br><pre> <code class="cs hljs">RepositoryContainerFactory.RegisterAllRepositories(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContextManager(Settings.Default.DBConnectionString));</code> </pre><br>  After, you need to pass authorization and specify the current user.  This is necessary in order to save in the history information about the user who made this or that change.  In the demo project this item is omitted. <br><div class="spoiler">  <b class="spoiler_title">InitDefaultUser</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitDefaultUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { User defaultUser = RepositoryContainer.Instance.Resolve&lt;UsersRepository&gt;().GetFirst(); DemoAppDbContext.CurrentUser = defaultUser; }</code> </pre><br></div></div><br>  Calling repository methods is done by getting an instance from the service locator.  In the example below, the call goes to the GetFirst () method of the repository of the UsersRepository type: <br><pre> <code class="cs hljs">User defaultUser = RepositoryContainer.Instance.Resolve&lt;UsersRepository&gt;().GetFirst();</code> </pre><br>  Add new user: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { Email = <span class="hljs-string"><span class="hljs-string">"UserEmail@email.ru"</span></span>, Login = <span class="hljs-string"><span class="hljs-string">"login"</span></span>, IsBlocked = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"Vasy Pupkin"</span></span>}; RepositoryContainer.Instance.Resolve&lt;UsersRepository&gt;().SaveOrUpdate(newUser);</code> </pre><br><h5>  Validation before saving objects </h5><br>  Validation and getting a list of errors: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { Email = <span class="hljs-string"><span class="hljs-string">"UserEmail@email.ru"</span></span>, IsBlocked = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }; DbEntityValidationResult dbEntityValidationResult = RepositoryContainer.Instance.Resolve&lt;UsersRepository&gt;().Validate(newUser);</code> </pre><br>  Getting a string with errors: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { Email = <span class="hljs-string"><span class="hljs-string">"UserEmail@email.ru"</span></span>, IsBlocked = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isValid=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errors = RepositoryContainer.Instance.Resolve&lt;UsersRepository&gt;().ValidateAndReturnErrorString(newUser, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> isValid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isValid) { MessageBox.Show(errors, <span class="hljs-string"><span class="hljs-string">"Error.."</span></span>, MessageBoxButtons.OK, MessageBoxIcon.Error); }</code> </pre><br><h5>  Demo project </h5><br>  Fully working draft you can pick up on the Yandex disk <a href="http://yadi.sk/d/P9XDDznpMj6p8">http://yadi.sk/d/P9XDDznpMj6p8</a> . <br>  Please note that an installed MSSQL is required for the operation. <br>  In case of using MSSQL Express, you need to fix the connection string with <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Data Source=.\; Initial Catalog=EFDemoApp; Integrated Security=True; Connection Timeout=5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  on <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Data Source=.\SQLEXPRESS; Initial Catalog=EFDemoApp; Integrated Security=True; Connection Timeout=5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h5>  Afterword </h5><br>  All the above code is my solution to the tasks.  It may not be right, not optimal, but nevertheless it has been successfully working on one of the projects for several years. <br>  At one time, I spent quite a lot of time and effort to make this system and I hope that my results will be useful to someone. <br><br>  Thanks to all! </div><p>Source: <a href="https://habr.com/ru/post/219947/">https://habr.com/ru/post/219947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219927/index.html">Again vkontakte: about the old in a new way</a></li>
<li><a href="../219929/index.html">Introducing New Nokia Imaging SDK 1.2 BETA and SensorCore SDK Developer Toolkits</a></li>
<li><a href="../219941/index.html">Another 2048, now triangular</a></li>
<li><a href="../219943/index.html">CEO - closer to the people!</a></li>
<li><a href="../219945/index.html">New service from Payler - sms-payments Billingrad</a></li>
<li><a href="../219949/index.html">What is happening in the new gTLD market: current statistics</a></li>
<li><a href="../219951/index.html">How are Yandex.Maps organized? Lecture by Vladimir Zaitsev in Yandex</a></li>
<li><a href="../219953/index.html">Writing a DLL for Metastock from scratch. Part2</a></li>
<li><a href="../219955/index.html">How did we attract money or 13 stories of Russian investors</a></li>
<li><a href="../219965/index.html">Intel software products - How to call a ship ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>