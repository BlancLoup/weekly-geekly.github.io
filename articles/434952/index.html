<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OMower with ROS, first steps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Initially, OMower was designed for simple control interfaces pfodApp and Modbus. The first is a high-level text protocol in which menus and control co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OMower with ROS, first steps</h1><div class="post__text post__text-html js-mediator-article">  Initially, OMower was designed for simple control interfaces pfodApp and Modbus.  The first is a high-level text protocol in which menus and control commands are transmitted, and the second is a well-known, but not very convenient thing in this application, as it requires the control program to constantly poll the state of all sensors used ‚Äúmanually‚Äù.  Therefore, it was decided to gradually move to ROS (Robot OS), a widely used framework for controlling various robots. <br><br> <a href=""><img src="https://habrastorage.org/webt/rr/7_/np/rr7_npqnn9lphvkluh3gc2ulsx8.jpeg" width="720"></a> <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment, ROS support is in its initial stages, including only the transfer of information from sensors in the form of simple arrays (without using specialized message formats offered by many ROS libraries), debug log and control command streams in pfodApp / Modbus format, without the possibility really control the robot using standard ROS tools.  That is, to move the robot from its place or change any internal configuration of the robot, you will need to send a text command in pfodApp format to it.  But even in such a truncated form - you can easily broadcast and record what is happening with the robot, visualizing its movements in standard ROS tools (rviz), as well as adding services for additional functions.  Such, for example, provided by omower_seeker.py the ability to drive in the direction of the visual template (chessboard), for precise arrival at the parking station. <br><br>  The picture shows data streams in the robot.  The main ROS services are executed on Orange PI Zero, plugged into a special slot on the robot's motherboard (on a test machine, the Raspberry PI3 is used for this, connected in a similar way via a serial port).  Through the rosserial interface - the robot sends to the ROS core messages from sensors (such as / imu / orientation or / motors / PWM), its debug log in text format and display of menu / messages in pfodApp or Modbus format, accepting a stream of text commands or Modbus -queries.  From two additional Raspberry PI Zero, streams of pictures from cameras come, but as practice has shown, it is impossible to get normal synchronization for processing stereo images with such a scheme (the quality can be seen in the picture below), so soon you will be replaced with a normal stereo camera. <br><br>  The degree of integration of ROS in OMower will gradually expand, up to providing full access to all internal variables of the robot and the ability to manage it through standard ROS tools (such as cmd_vel messages that specify the desired speed of movement). <br><br> <a href=""><img src="https://habrastorage.org/webt/id/u6/pw/idu6pwvomgxmosirsfjwpl0silm.png" width="720"></a> <br><br>  I'll tell you a little more about the module omower_seeker.py, as an example of using ROS to add functions to OMower.  His appointment is quite simple - to go in the direction of the chessboard, adjusting your route in real time.  This feature will be used to drive a lawnmower to a parking station, where it can quickly charge its batteries.  Analyzing the image from one of the cameras, the module calculates two angles (the angle of deflection of the board from the center of the camera and the angle of rotation of the board itself relative to the perpendicular) and transmits them as a text command to the internal seeker module (omower-seeker.h / cpp in the OMower SDK). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/gCKC3lw30Vo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Outwardly, this looks like a fairly simple task, but in real life there is a serious problem - the speed of image processing on the microcomputer built into the robot.  As practice shows, the search speed of patterns in opencv on the image when using relatively low-powered Orange PI and Raspberry Pi is very low and unstable, taking from tens to hundreds of milliseconds at a resolution of 640x480, which during the ride turns into deviations from the required route, since the robot , even with its low speed, during this time manages to turn a significant angle or travel a relatively large distance.  Actually, this is why a chessboard with a minimum of cells was chosen, since other templates take even more time. <br><br>  To compensate for the long search time of the visual template, a scheme using a compass is used ‚Äî the robot microcontroller saves its values ‚Äã‚Äãevery 100 milliseconds, storing five counts in the last half of a second (longer analyzes are simply discarded, due to their poor suitability for precise navigation).  The calculated angles from omower_seeker.py (which also transfers the template search time to the microcontroller) are recalculated into the real angle of rotation using the saved compass value separated from the search time by no more than 100 milliseconds, and the robot is driving along this angle.  This allows you to more or less accurately go in the direction of the chessboard in a straight line.  Or, if it is slightly rotated relative to the perpendicular, the arc corrects the angle of approximation so that it is as close as possible to the template axis, since we need not only to go up to the board, but also to get into the guide runners and connect to the charging contacts. <br><br>  The full algorithm of arrival at the station is implemented in three stages.  Two points are set on the GPS field - the starting point (somewhere in the middle of the work area), and a point in front of the station, as well as the angle of rotation to the station.  After the robot arrives from the starting point to the second and turns to the desired angle in the direction of the chessboard at the station, the seeker module comes into play, adjusting the engine speed via the PID controller.  If any of the stages fail, or the deviation angles exceed the specified values ‚Äã‚Äã- the robot cancels the race and returns to the starting point again. <br><br>  Links and videos: <br><br>  ‚Üí <a href="https://github.com/vasimv/OMower">OMower SDK, library for Arduino IDE and schematic diagram with PCB layout</a> <br>  ‚Üí <a href="https://github.com/vasimv/OMower_Simple">Ready firmware using SDK, which implements both pfodApp / Modbus and ROS connection</a> <br>  ‚Üí <a href="https://github.com/vasimv/Omower_ROS">Package omower_gateway for ROS</a> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dyz7xH9U1kY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mmV4WPHlc7Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div><p>Source: <a href="https://habr.com/ru/post/434952/">https://habr.com/ru/post/434952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434940/index.html">Business i love you</a></li>
<li><a href="../434942/index.html">The art of shamanism or custom firmware for Olinuxino. UBOOT Part 2</a></li>
<li><a href="../434944/index.html">Notes phytochemist. Banana skin strikes back</a></li>
<li><a href="../434946/index.html">My move to Norway</a></li>
<li><a href="../434950/index.html">The present that will determine our future</a></li>
<li><a href="../434956/index.html">IT-company is growing, profits are not particularly. What to do?</a></li>
<li><a href="../434960/index.html">Tic-tac-toe: demonstration of the controlled process of DNA structure reconfiguration</a></li>
<li><a href="../434962/index.html">No, you do not need Express in your REST API on Node.js</a></li>
<li><a href="../434964/index.html">Enough paranoia or why you do not shine 100 points in Page Speed</a></li>
<li><a href="../434966/index.html">New Mash programming language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>