<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Decomposing a UICollectionViewCell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After viewing Keynote WWDC 2019 and getting acquainted with SwiftUI , intended for the declarative description of the UI in the code, I would like to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Decomposing a UICollectionViewCell</h1><div class="post__text post__text-html js-mediator-article"><p>  After viewing Keynote WWDC 2019 and getting acquainted with <a href="https://developer.apple.com/xcode/swiftui/">SwiftUI</a> , intended for the declarative description of the UI in the code, I would like to speculate on how you can declaratively fill tablets and collections.  For example, like this: </p><br><pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgets</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(objects: Objects)</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">Widget</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> header = [ <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">25</span></span>).widget, <span class="hljs-type"><span class="hljs-type">Header</span></span>(string: <span class="hljs-string"><span class="hljs-string">" "</span></span>).widget, <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">10</span></span>, separator: .bottom).widget ] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> body = objects .flatMap({ (object: <span class="hljs-type"><span class="hljs-type">Object</span></span>) -&gt; [<span class="hljs-type"><span class="hljs-type">Widgets</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-type"><span class="hljs-type">Title</span></span>(object: object).widget, <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">1</span></span>, separator: .bottom).widget ] }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> header + body } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> objects: [<span class="hljs-type"><span class="hljs-type">Object</span></span>] = ... <span class="hljs-type"><span class="hljs-type">Builder</span></span> .widgets(objects: objects) .bind(to: collectionView)</code> </pre> <br><p>  In the collection, this is depicted as follows: <a name="habracut"></a></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/el/r0/bp/elr0bpuqgbgcm5unfprets9_woc.png" alt="image"></div><p></p><br><h1 id="vvedenie">  Introduction </h1><br><p>  As it is known from <a href="https://habr.com/ru/company/rambler-co/blog/306158/">authoritative sources</a> : the typical iOS developer spends the vast majority of his time at work with tablets.  If we assume that the developers on the project are sorely lacking and the plates are not simple, then there is no time left for the rest of the application.  And with this we need to do something ... A possible solution would be the decomposition of the cells. </p><br><p>  Cell decomposition means the replacement of a single cell with several smaller cells.  With this replacement, visually nothing should change.  As an example, you can consider posts from the VK news feed for iOS.  One post can be represented both in the form of a single cell, and in the form of a group of cells - <strong>primitives</strong> . </p><br><p>  Decomposing the cells will not always work.  It will be difficult to break into primitives a cell that has a shadow or rounding on all sides.  In this case, the source cell will be a primitive. </p><br><h1 id="plyusy-i-minusy">  Advantages and disadvantages </h1><br><p>  Using cell decomposition, tables / collections begin to consist of primitives that will often be reused: a primitive with text, a primitive with a picture, a primitive with a background, etc.  The calculation of the height of a single primitive is much simpler and more efficient than a complex cell with a large number of states.  If desired, the dynamic height of the primitive can be calculated or even drawn in the background (for example, text via <code>CTFramesetter</code> ). </p><br><p>  On the other hand, work with data becomes more complicated.  The data will be required for each primitive, and by the <code>IndexPath</code> primitive it will be difficult to determine to which real cell it belongs.  We will have to introduce new layers of abstraction or somehow solve these problems. </p><br><p>  It is possible to talk for a long time about possible pros and cons of this undertaking, but it is better to try to describe the approach to cell decomposition. </p><br><h1 id="vybiraem-instrumenty">  Choosing Tools </h1><br><p>  Since <code>UITableView</code> limited in its capabilities, and we, as already mentioned, have rather complicated tables, an adequate solution would be to use a <code>UICollectionView</code> .  About <code>UICollectionView</code> also the speech in this publication will go. </p><br><p>  Using a <code>UICollectionView</code> encounter a situation where the base <code>UICollectionViewFlowLayout</code> cannot form the required arrangement of collection elements (we do not take into account the new <a href="https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout"><code>UICollectionViewCompositionalLayout</code></a> ).  At such times, it is usually decided to find some open-source <code>UICollectionViewLayout</code> .  But even among the ready-made solutions may not be suitable, as, for example, in the case of the dynamic home page of a large online store or social network.  We assume the worst, so we will create our own universal <code>UICollectionViewLayout</code> . </p><br><p>  In addition to the difficulties with choosing a layout, it is necessary to decide how the collection will receive data.  In addition to the usual approach, where an object (most often a <code>UIViewController</code> ) conforms to the <code>UICollectionViewDataSource</code> protocol and provides data for a collection, the use of data-driven frameworks is gaining popularity.  Vivid representatives of this approach are <a href="https://github.com/SoySauceLab/CollectionKit">CollectionKit</a> , <a href="https://github.com/Instagram/IGListKit">IGListKit</a> , <a href="https://github.com/RxSwiftCommunity/RxDataSources">RxDataSources</a> and others.  Using such frameworks simplifies working with collections and provides the ability to animate data changes, since  The diffing algorithm is already present in the framework.  For publishing purposes, the <a href="https://github.com/RxSwiftCommunity/RxDataSources">RxDataSources</a> framework will be selected. </p><br><h1 id="vidzhet-i-ego-svoystva">  Widget and its properties </h1><br><p>  We introduce an intermediate data structure and call it a <strong>widget</strong> .  We describe the basic properties that the widget should have: </p><br><ol><li>  The widget must comply with the necessary protocols to use the data-driven framework.  Such protocols typically contain an associated value (for example, <a href="https://github.com/RxSwiftCommunity/RxDataSources/blob/master/Sources/Differentiator/IdentifiableType.swift"><code>IdentifiableType</code></a> in <a href="https://github.com/RxSwiftCommunity/RxDataSources">RxDataSources</a> ) </li><li>  It should be possible to collect widgets for different primitives in an array.  To achieve this, the widget should not have associated values.  For these purposes, you can use the type erase mechanism or something like that. </li><li>  The widget must be able to read the size of the primitive.  Then, when forming the <code>UICollectionViewLayout</code> , it will only be <code>UICollectionViewLayout</code> to correctly position the primitives according to the rules provided in advance. </li><li>  The widget must be a factory for a <code>UICollectionViewCell</code> .  Therefore, all the cell creation logic will be removed from the <code>UICollectionViewDataSource</code> implementation and only the following will remain: <br><pre> <code class="plaintext hljs">let cell = widget.widgetCell(collectionView: collectionView, indexPath: indexPath) return cell</code> </pre> </li></ol><br><h1 id="realizaciya-vidzheta">  Widget implementation </h1><br><p>  To be able to use the widget with the <a href="https://github.com/RxSwiftCommunity/RxDataSources">RxDataSources</a> framework, it <a href="https://github.com/RxSwiftCommunity/RxDataSources">must comply with the</a> <code>Equatable</code> and <a href="https://github.com/RxSwiftCommunity/RxDataSources/blob/master/Sources/Differentiator/IdentifiableType.swift"><code>IdentifiableType</code></a> <a href="https://github.com/RxSwiftCommunity/RxDataSources">protocols</a> .  Since the widget represents a primitive, it will be sufficient for publication purposes if the widget identifies itself to conform to the <a href="https://github.com/RxSwiftCommunity/RxDataSources/blob/master/Sources/Differentiator/IdentifiableType.swift"><code>IdentifiableType</code></a> protocol.  In practice, this will affect the fact that when a widget changes, it will not be a reboot of the primitive, but deletion and insertion.  To do this, we introduce a new protocol <code>WidgetIdentifiable</code> : </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IdentifiableType</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identity: <span class="hljs-type"><span class="hljs-type">Self</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> } }</code> </pre> <br><p>  To match the <code>WidgetIdentifiable</code> , the widget must conform to the <code>Hashable</code> protocol.  The data for compliance with the <code>Hashable</code> protocol will be taken from the object that will describe the particular primitive.  You can use <code>AnyHashable</code> to "erase" an object type widget. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> underlying: <span class="hljs-type"><span class="hljs-type">AnyHashable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(<span class="hljs-number"><span class="hljs-number">_</span></span> underlying: <span class="hljs-type"><span class="hljs-type">AnyHashable</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying = underlying } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying.hash(into: &amp;hasher) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> ==</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lhs: Widget, rhs: Widget)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.underlying == rhs.underlying } }</code> </pre> <br><p>  At this stage, the first two properties of the widget are executed.  It is easy to check by gathering into the array several widgets with different types of objects. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> widgets = [<span class="hljs-type"><span class="hljs-type">Widget</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>), <span class="hljs-type"><span class="hljs-type">Widget</span></span>(<span class="hljs-number"><span class="hljs-number">100500</span></span>)]</code> </pre> <br><p>  To implement the remaining properties, we introduce the new <code>WidgetPresentable</code> protocol <code>WidgetPresentable</code> </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> }</code> </pre> <br><p>  The <code>widgetSize(containerWidth:)</code> function will be used in <code>UICollectionViewLayout</code> when forming cell attributes, and <code>widgetCell(collectionView:indexPath:)</code> will be used to get cells. </p><br><p>  When the widget <code>WidgetPresentable</code> protocol, the widget will execute all the properties indicated at the beginning of the publication.  However, the object contained within the AnyHashable widget will have to be replaced with the composition <code>WidgetPresentable</code> and <code>WidgetHashable</code> , where <code>WidgetHashable</code> will not have an associated value (as is the case with <code>Hashable</code> ) and the object type inside the widget will remain "erased": </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetHashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetEqual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> any: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> }</code> </pre> <br><p>  In the final version, the widget will look like this: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> underlying: <span class="hljs-type"><span class="hljs-type">WidgetHashable</span></span> &amp; <span class="hljs-type"><span class="hljs-type">WidgetPresentable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(<span class="hljs-number"><span class="hljs-number">_</span></span> underlying: <span class="hljs-type"><span class="hljs-type">WidgetHashable</span></span> &amp; <span class="hljs-type"><span class="hljs-type">WidgetPresentable</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying = underlying } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying.widgetHash(into: &amp;hasher) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> ==</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lhs: Widget, rhs: Widget)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.underlying.widgetEqual(rhs.underlying) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> underlying.widgetCell(collectionView: collectionView, indexPath: indexPath) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> underlying.widgetSize(containerWidth: containerWidth) } }</code> </pre> <br><h1 id="obekt-primitiva">  Primitive object </h1><br><p>  Let's try to collect the simplest primitive, which will be an indent of a given height. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> height: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpacingView</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constraint = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.heightAnchor.constraint(equalToConstant: <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(frame: .zero) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.constraint.isActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetHashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetEqual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> any: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> spacing = any <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">Spacing</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> == spacing } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.hash(into: &amp;hasher) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell: <span class="hljs-type"><span class="hljs-type">WidgetCell</span></span>&lt;<span class="hljs-type"><span class="hljs-type">SpacingView</span></span>&gt; = collectionView.cellDequeueSafely(indexPath: indexPath) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cell.view == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { cell.view = <span class="hljs-type"><span class="hljs-type">SpacingView</span></span>() } cell.view?.constraint.constant = height <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CGSize</span></span>(width: containerWidth, height: height) } }</code> </pre> <br><p>  <code>WidgetCell&lt;T&gt;</code> is just a subclass of <code>UICollectionViewCell</code> that accepts a <code>UIView</code> and adds it as a subview.  <code>cellDequeueSafely(indexPath:)</code> is a function that registers a cell in the collection before being reused if the cell has not previously been registered in the collection.  <code>Spacing</code> will be used as described at the very beginning of the publication. </p><br><p>  After receiving the array of widgets, it will only zabindit <code>observerWidgets</code> : </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">DataSource</span></span> = <span class="hljs-type"><span class="hljs-type">RxCollectionViewSectionedAnimatedDataSource</span></span>&lt;<span class="hljs-type"><span class="hljs-type">WidgetSection</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataSource: <span class="hljs-type"><span class="hljs-type">DataSource</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.makeDataSource() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> observerWidgets: (<span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Widgets</span></span>&gt;) -&gt; <span class="hljs-type"><span class="hljs-type">Disposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collectionView.rx.items(dataSource: dataSource) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeDataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">DataSource</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">DataSource</span></span>(configureCell: { (<span class="hljs-number"><span class="hljs-number">_</span></span>, collectionView: <span class="hljs-type"><span class="hljs-type">UICollectionView</span></span>, indexPath: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>, widget: <span class="hljs-type"><span class="hljs-type">Widget</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = widget.widgetCell(collectionView: collectionView, indexPath: indexPath) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }) } }</code> </pre> <br><h1 id="rezultaty">  results </h1><br><p>  In conclusion, I would like to show the real work of the collection, which is built entirely on widgets. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_t/od/tz/_todtzto-dqfqf1nwto9pik694c.gif" alt="image"></div><br><p>  As you can see, the decomposition of <code>UICollectionViewCell</code> feasible and, in appropriate situations, can simplify the life of the developer. </p><br><h1 id="zamechaniya">  Remarks </h1><br><p>  The code in the publication is very simplified and should not be collected.  The goal was to describe the approach, rather than provide a ready-made solution. </p><br><p>  The <code>WidgetPresentable</code> protocol can be extended with other functions allowing optimization of the layout, for example, <code>widgetSizeEstimated(containerWidth:)</code> or <code>widgetSizePredefined(containerWidth:)</code> , which return the estimated and fixed size, respectively.  It is worth noting that the <code>widgetSize(containerWidth:)</code> function <code>widgetSize(containerWidth:)</code> must return the size of the primitive even for demanding calculations, for example, for <code>systemLayoutSizeFitting(_:)</code> .  Such calculations can be cached through a <code>Dictionary</code> , <code>NSCache</code> , etc. </p><br><p>  As you know, all cell types used by the <code>UICollectionView</code> must be registered in the collection beforehand.  However, in order to re-use widgets between different screens / collections and not to register in advance all cell identifiers / types, you need to acquire a mechanism that will register the cell immediately before its first use within each collection.  The publication used the <code>cellDequeueSafely(indexPath:)</code> function for this. </p><br><p>  In the collection there can be no headers or footers.  In their place will be primitives.  The presence of the supplementary in the collection will not give any special bonuses in the current approach.  Usually they are used when the data array strictly corresponds to the number of cells and it is required to show additional views before, after or between the cells.  In our case, data for auxiliary views can also be added to the array of widgets and drawn as primitives. </p><br><p>  Within the same collection can be widgets with the same objects.  For example, the same <code>Spacing</code> at the beginning and at the end of the collection.  The presence of such non-unique objects will lead to the fact that the animation in the collection will disappear.  To make such objects unique, you can use special <code>AnyHashable</code> tags, <code>#file</code> and <code>#line</code> places to create an object, etc. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/455421/">https://habr.com/ru/post/455421/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455409/index.html">backward compatibility</a></li>
<li><a href="../455411/index.html">Megaphone conducted a technical update ... network name</a></li>
<li><a href="../455413/index.html">Turn Pocket into a news feed.</a></li>
<li><a href="../455419/index.html">Apple Beta Alive: Little Things That Were Not Told at the Presentation</a></li>
<li><a href="../45542/index.html">Recalculation of habrasil and rating</a></li>
<li><a href="../455425/index.html">Creating IPSec GRE tunnel between Mikrotik hEX S and Juniper SRX via USB Modem</a></li>
<li><a href="../45543/index.html">Methodology for working with clients. For beginner web studio managers</a></li>
<li><a href="../455439/index.html">The new algorithm, created by scientists, allows you to create almost perfect "talking heads" with real people.</a></li>
<li><a href="../455441/index.html">June 21, Moscow, Deworkacy - AnalyzeIT MeetUp # 2</a></li>
<li><a href="../455445/index.html">Software implementation of class D amplifier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>