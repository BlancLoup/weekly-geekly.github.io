<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solve problems without self-balancing trees in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many algorithmic tasks require knowledge of certain data structures. The stack, the queue, the heap, the dynamic array, the binary search tree ‚Äî the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solve problems without self-balancing trees in Python</h1><div class="post__text post__text-html js-mediator-article">  Many algorithmic tasks require knowledge of certain data structures.  The stack, the queue, the heap, the dynamic array, the binary search tree ‚Äî the solution of an algorithmic problem rarely does without using any of them.  However, their high-quality implementation is not a trivial task, and when writing code you always want to do the maximum using the standard language library. <br><br>  As for Python, it has almost everything. <br><br><ul><li> Dynamic array - built-in type <code>list</code> .  It also supports stack operations: <code>.append()</code> and <code>.pop()</code> . </li><li>  The hash table is the built-in types <code>set</code> and <code>dict</code> , and also the immutable brother of the set <code>frozenset</code> . </li><li>  Heap - <code>list</code> with special insert and delete operations implemented in the <code>heapq</code> module. </li><li>  A two-way queue is the type <code>deque</code> described in the <code>collections</code> module. </li></ul><br>  But there is no self-balancing search tree, as such, in the standard library.  It's a pity! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will examine several algorithmic problems that involve solving using a binary tree, and show you how to replace it in different situations in Python. <br><a name="habracut"></a><br><h2>  What the search tree is capable of </h2><br>  You probably already know that the self-balancing binary search tree is the most convenient data structure for many tasks, supporting many operations.  But just in case I will list them and recall their asymptotic complexity. <br><br><ul><li>  Insert item - worth <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.811ex" height="2.66ex" viewBox="0 -832 4224 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3945" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-1"> O (\ log N). </script></li><li>  Deleting an item is worth <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.811ex" height="2.66ex" viewBox="0 -832 4224 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3945" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-2"> O (\ log N). </script></li><li>  Item Search - Worth <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.811ex" height="2.66ex" viewBox="0 -832 4224 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3945" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> O (\ log N). </script></li><li>  Finding the minimum and maximum elements - worth <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.164ex" height="2.66ex" viewBox="0 -832 3945.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-4"> O (\ log N) </script>  .  If necessary, you can remember the pointers to them;  then the need for tree passage is eliminated and the cost is reduced to <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.392ex" height="2.66ex" viewBox="0 -832 2321.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="2043" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-5"> O (1). </script></li><li>  Finding the median, and indeed any k-th ordinal statistics - is <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.811ex" height="2.66ex" viewBox="0 -832 4224 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3945" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-6"> O (\ log N). </script>  In this case, it is necessary to remember in each node of the tree the size of the corresponding subtree. </li><li>  Finding the number of elements less / more than the specified value <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.811ex" height="2.66ex" viewBox="0 -832 4224 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3945" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-7"> O (\ log N). </script>  For this, it is also necessary to remember the size of the corresponding subtree in each node of the tree. </li><li>  Inserting a monotonous sequence of elements - may cost depreciated <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-8"> O (1) </script>  for everyone!  (Did you know that in C ++, <code>std::set</code> <a href="http://ru.cppreference.com/w/cpp/container/set/insert">can be filled</a> from a sorted array in <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.66ex" viewBox="0 -832 2431 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="2041" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-9"> O (N) </script>  ?) </li></ul><br>  And much more (probably).  In general, having a tree at hand is very, very convenient.  Well, move on to the tasks! <br><br><h2>  Task: skyscrapers </h2><br>  On a straight line are skyscrapers, some of which overlap each other.  It is necessary to describe the outlines against the sky of the entire set of skyscrapers. <br><br><img src="https://habrastorage.org/webt/ya/_l/7h/ya_l7hkcis5g-4e42ixie3m1kt4.png" width="45%" align="left"><img src="https://habrastorage.org/webt/ta/he/3-/tahe3-5lhveafud9tq0jj-1kox0.png" width="45%" align="right"><br><br>  Buildings are described as an array of view tuples (coordinate of the left edge of the building, coordinate of the right edge of the building, height).  At the exit you need to pass an array of tuples (x, y), describing the general silhouette of buildings. <br><br>  This problem is solved for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.227ex" height="2.66ex" viewBox="0 -832 4834 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="2291" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="2590" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="3075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="4444" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-10"> O (N \ log N) </script>  .  The algorithm as a whole is approximately the following: we sort all points (both left and right edges of buildings), we go along them from left to right.  If you stumbled upon the left edge of the building - you need to add it to the list of currently active, if the right - to exclude from the list.  In any case, each time it is necessary to check whether the maximum height of the active buildings has changed, and if it has changed, record the next point in response.  (A more detailed analysis of this problem can be found <a href="https://briangordon.github.io/2014/08/the-skyline-problem.html">here</a> .) <br><br>  The list of active buildings, as a data structure, must support the rapid addition of a new element, the removal of an arbitrary element and the finding of a maximum.  Binary tree can do all three operations for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.164ex" height="2.66ex" viewBox="0 -832 3945.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-11"> O (\ log N) </script>  and perfect for this task.  Let's try to do without it! <br><br>  The need to quickly take the maximum, of course, reminds us of the heap.  But the heap does not provide for the removal of an arbitrary element!  For example, to remove a heap item with a <em>known index</em> in Python within a reasonable time, you need to get into the non-standardized implementation details of the <code>heapq</code> module (which is, of course, unreliable and not recommended): <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">heapremove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h, i)</span></span></span><span class="hljs-function">:</span></span> h[i] = h[<span class="hljs-number"><span class="hljs-number">-1</span></span>] h.pop() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i &lt; len(h): heapq._siftup(h, i) heapq._siftdown(h, <span class="hljs-number"><span class="hljs-number">0</span></span>, i)</code> </pre> <br>  ( <i>This code is taken from the <a href="https://stackoverflow.com/a/10163422/999858">response to StackOverflow</a></i> .) <br><br>  However, it is possible to make an add-on over the heap, which allows you to delete an arbitrary element for the cushioned <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-12-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.164ex" height="2.66ex" viewBox="0 -832 3945.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-12"> O (\ log N) </script>  .  The algorithm is as follows: <br><br><ol><li>  We store along with a bunch of many deleted items. </li><li>  If you want to delete an element that is not currently the minimum on the heap, add it to the set of deleted elements. </li><li>  If you want to delete an element that is now minimal, delete it with the standard <code>heappop</code> .  If the new minimal element is contained in the set of deleted elements, delete it, and so on. </li></ol><br>  It remains only to note that the elements can be repeated. <br><br>  Code: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeapWithRemoval</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.heap = [] <span class="hljs-comment"><span class="hljs-comment">#   set,        self.deleted = collections.defaultdict(int) def add(self, value): if self.deleted[value]: self.deleted[value] -= 1 else: heapq.heappush(self.heap, value) def remove(self, value): self.deleted[value] += 1 while self.heap and self.deleted[self.heap[0]]: self.deleted[self.heap[0]] -= 1 heapq.heappop(self.heap) def minimum(self): return self.heap[0] if self.heap else None</span></span></code> </pre> <br><h2>  Task: median in a sliding window </h2><br>  This task is found in different variants.  Most generally, taking into account the specifics of Python, it can be formulated as follows: the algorithm is fed as an input by an iterator of unknown (and, possibly, unlimited) length.  It is necessary to return an iterator with medians for all windows of a predetermined width. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-13-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.211ex" height="2.057ex" viewBox="0 -780.1 521.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi></math></span></span><script type="math/tex" id="MathJax-Element-13"> k </script>  . <br><br><img src="https://habrastorage.org/webt/we/__/ug/we__ugo5npujoipzikutlhvzwfc.png"><br><br>  With the optimal solution of this problem, each next median is calculated for the amortized <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-14-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.311ex" height="2.66ex" viewBox="0 -832 3578.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3189" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-14"> O (\ log k) </script>  .  Like most tasks on a sliding window, the solution is to build a data structure that allows you to quickly add a new element to the window, delete the oldest element and calculate the next median. <br><br>  The tree obviously solves this problem.  Adding, removing and finding the median for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-15-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.311ex" height="2.66ex" viewBox="0 -832 3578.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3189" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-15"> O (\ log k) </script>  give optimal asymptotics for our version of the problem.  There is also a way to reduce the difficulty of finding the median to a depreciated <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-16-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-16"> O (1) </script>  : to do this, remember the pointer to the median element (or two elements, the arithmetic mean of which gives the median if <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-17-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.211ex" height="2.057ex" viewBox="0 -780.1 521.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi></math></span></span><script type="math/tex" id="MathJax-Element-17"> k </script>  even) and update it when adding and deleting elements (the update will cost a depreciated <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-18-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-18"> O (1) </script>  - think why!). <br><br>  If you think the elements needed to find the median, in the tree can only be in three places: <br><br><ul><li>  fundamentally; </li><li>  in the smallest element of the right subtree; </li><li>  in the largest element of the left subtree. </li></ul><br>  The words "smallest" and "greatest", of course, again remind us of the heaps! <br><br>  Indeed, let's store two heaps, a min-heap and a max-heap, in a balanced size.  At the same time, all max-heap elements should be smaller than all min-heap elements.  When adding an element, you need to put it in the correct heap and balance them: this will require a finite number of operations like ‚Äúextract the extreme value from one heap and put it into another‚Äù <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-19-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.311ex" height="2.66ex" viewBox="0 -832 3578.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3189" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-19"> O (\ log k) </script>  .  Getting the median is worth <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-20-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-20"> O (1) </script>  , because for this you need only a maximum of max-heaps and a minimum of min-heaps. <br><br>  Code: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MedianFinder</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, k)</span></span></span><span class="hljs-function">:</span></span> self.k = k self.smaller_heap = HeapWithRemoval() self.larger_heap = HeapWithRemoval() <span class="hljs-comment"><span class="hljs-comment">#      ,   : self.elements = deque([], k) def add(self, num): if len(self.elements) == self.k: #    -     . . element_to_delete = self.elements[0] if self.smaller_heap and element_to_delete &lt;= -self.smaller_heap.minimum(): self.smaller_heap.remove(-element_to_delete) else: self.larger_heap.remove(element_to_delete) self.balance() #      . if self.larger_heap and num &gt;= self.larger_heap.minimum(): self.larger_heap.add(num) else: self.smaller_heap.add(-num) self.elements.append(num) self.balance() def balance(self): #   ,         . if len(self.larger_heap) &gt; len(self.smaller_heap) + 1: num = self.larger_heap.pop() self.smaller_heap.add(-num) elif len(self.smaller_heap) &gt; len(self.larger_heap) + 1: num = -self.smaller_heap.pop() self.larger_heap.add(num) def median(self): if len(self.larger_heap) &gt; len(self.smaller_heap): return self.larger_heap.minimum() if len(self.larger_heap) &lt; len(self.smaller_heap): return -self.smaller_heap.minimum() return (self.larger_heap.minimum() - self.smaller_heap.minimum()) / 2</span></span></code> </pre> <br>  (For this code, I added <code>pop</code> methods to <code>HeapWithRemoval</code> , <br>  <code>__len__</code> and <code>__nonzero__</code> .) <br><br>  The solution of the problem with this data structure becomes elementary: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">median_over_sliding_window</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input, k)</span></span></span><span class="hljs-function">:</span></span> finder = MedianFinder(k) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> input: finder.add(num) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(finder.elements) == k: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> finder.median()</code> </pre> <br><h2>  Task: number of inversions </h2><br>  Dan array of numbers <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-21-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mn>1</mn></msub><mo>,</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>d</mi><mi>o</mi><mi>t</mi><mi>s</mi><mo>,</mo><msub><mi>a</mi><mi>n</mi></msub><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.995ex" height="2.419ex" viewBox="0 -780.1 5594.9 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="748" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2C" x="983" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1678" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-64" x="1977" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="2500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-74" x="2986" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-73" x="3347" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2C" x="3817" y="0"></use><g transform="translate(4262,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6E" x="748" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="5316" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mn>1</mn></msub><mo>,</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>d</mi><mi>o</mi><mi>t</mi><mi>s</mi><mo>,</mo><msub><mi>a</mi><mi>n</mi></msub><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-21"> a_1, \ ldots, a_n. </script>  It is necessary to calculate the number of pairs of array elements that are in the wrong order, that is, when <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-22-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;gt;</mo><mi>j</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.859ex" height="2.298ex" viewBox="0 -728.2 2092.1 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-69" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3E" x="623" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6A" x="1679" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi><mo>&gt;</mo><mi>j</mi></math></span></span><script type="math/tex" id="MathJax-Element-22"> i> j </script>  takes place <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-23-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>i</mi></msub><mo>&amp;lt;</mo><msub><mi>a</mi><mi>j</mi></msub><mo>.</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.914ex" height="2.298ex" viewBox="0 -624.5 3407.5 989.6" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-69" x="748" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3C" x="1151" y="0"></use><g transform="translate(2207,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6A" x="748" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2E" x="3129" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>a</mi><mi>j</mi></msub><mo>.</mo></math></span></span><script type="math/tex" id="MathJax-Element-23"> a_i <a_j. </script>  If an array consists of different numbers from 1 to n, then the parity of this number is nothing but the parity of the permutation described by this array. <br><br>  The task is also generalized to the case when the bad pairs are those for which <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-24-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;gt;</mo><mi>j</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.859ex" height="2.298ex" viewBox="0 -728.2 2092.1 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-69" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3E" x="623" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6A" x="1679" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi><mo>&gt;</mo><mi>j</mi></math></span></span><script type="math/tex" id="MathJax-Element-24"> i> j </script>  and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-25-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>i</mi></msub><mo>&amp;lt;</mo><mi>c</mi><mtext>&amp;#xA0;</mtext><mi>c</mi><mi>d</mi><mi>o</mi><mi>t</mi><msub><mi>a</mi><mi>j</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.045ex" height="2.66ex" viewBox="0 -780.1 5616.5 1145.2" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-69" x="748" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3C" x="1151" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-63" x="2207" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-63" x="2891" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-64" x="3324" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="3848" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-74" x="4333" y="0"></use><g transform="translate(4695,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6A" x="748" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>i</mi></msub><mo>&lt;</mo><mi>c</mi><mtext>&nbsp;</mtext><mi>c</mi><mi>d</mi><mi>o</mi><mi>t</mi><msub><mi>a</mi><mi>j</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-25"> a_i <c \ cdot a_j </script>  where <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-26-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>c</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.007ex" height="1.455ex" viewBox="0 -520.7 433.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-63" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi></math></span></span><script type="math/tex" id="MathJax-Element-26"> c </script>  - some positive coefficient. <br><br>  In both cases, it is decided for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-27-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.66ex" viewBox="0 -832 2431 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="2041" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-27"> O (N) </script>  memory and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-28-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.227ex" height="2.66ex" viewBox="0 -832 4834 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="2291" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="2590" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="3075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="4444" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-28"> O (N \ log N) </script>  time (except in the case of a permutation in which it is solved for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-29-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.66ex" viewBox="0 -832 2431 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="2041" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-29"> O (N) </script>  - but that's another story.  An elementary solution with a tree looks like this: go through the array, at each step add to the answer the number of elements greater than the current one (or the current one, multiplied by <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-30-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>c</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.007ex" height="1.455ex" viewBox="0 -520.7 433.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-63" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi></math></span></span><script type="math/tex" id="MathJax-Element-30"> c </script>  ) - the tree does it for <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-31-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.164ex" height="2.66ex" viewBox="0 -832 3945.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3556" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-31"> O (\ log N) </script>  - and after that we add the current element to the tree. <br><br>  There are already some heaps can not do! <br><br>  But without a tree can not do too.  Implementing a tree is easy;  but if it is not balanced, then in the worst case asymptotics <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-32-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.227ex" height="2.66ex" viewBox="0 -832 4834 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="2291" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="2590" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="3075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="4444" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-32"> O (N \ log N) </script>  worsen to <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-33-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.76ex" height="2.901ex" viewBox="0 -935.7 2910.5 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><g transform="translate(1153,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="1292" y="513"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="2520" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-33"> O (N ^ 2) </script>  !  What to do? <br><br>  Let's expand the task and go from the other end.  After all, you can first build the entire tree, at each step of the cycle, delete the current element from it and add to the answer the number of elements less than the current one.  It is easy to build a balanced tree - it is enough to initially sort the array and write a competent recursion: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> collections Node = collections.namedtuple(<span class="hljs-string"><span class="hljs-string">"Node"</span></span>, <span class="hljs-string"><span class="hljs-string">"value left right"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_tree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nums)</span></span></span><span class="hljs-function">:</span></span> nums = sorted(nums) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _make_tree(nums, <span class="hljs-number"><span class="hljs-number">0</span></span>, len(nums)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_make_tree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nums, l, r)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      . #        [l, r). if r - l &lt;= 0: return None if r - l == 1: return Node(nums[l], None, None) center = (l + r) // 2 left_subtree = _make_tree(nums, l, center) right_subtree = _make_tree(nums, center + 1, r) return Node(nums[center], left_subtree, right_subtree)</span></span></code> </pre> <br>  But the removal from the tree - a dreary exercise.  An unsuccessful deletion algorithm can ruin a tree and again make it an unacceptable height!  Therefore, let's not remove nodes from the tree, but only <em>mark</em> them as deleted.  Then with the height of the tree for the entire time of the algorithm, nothing is guaranteed to happen and we get the coveted <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-34-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.227ex" height="2.66ex" viewBox="0 -832 4834 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="2291" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="2590" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="3075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4E" x="3556" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="4444" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-34"> O (N \ log N) </script>  . <br><br>  However, with this approach, the presence of nodes with repetitive elements (especially in large quantities) can seriously ruin life.  Therefore, before building a tree, it makes sense to deduplicate the elements with a multiplicity calculation. <br><br>  Code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> collections <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value, smaller, larger, total_count)</span></span></span><span class="hljs-function">:</span></span> self.smaller = smaller <span class="hljs-comment"><span class="hljs-comment">#   self.larger = larger #   self.value = value self.total_count = total_count #       def count_smaller(self, value): if not self.total_count: #   ? return 0 if value &lt;= self.value: return self.smaller.count_smaller(value) if self.smaller else 0 if self.larger: larger = self.larger.total_count - self.larger.count_smaller(value) return self.total_count - larger return self.total_count def remove(self, value): #  .    . while True: self.total_count -= 1 if value == self.value: return self = self.smaller if value &lt; self.value else self.larger def make_tree(nums): nums = sorted(nums) counter = collections.Counter(nums) return _make_tree(nums, counter, 0, len(nums)) def _make_tree(nums, counter, l, r): #           # .        [l, r). if r - l &lt;= 0: return None if r - l == 1: return Node(nums[l], None, None, counter[nums[l]]) center = (l + r) // 2 left_subtree = _make_tree(nums, counter, l, center) right_subtree = _make_tree(nums, counter, center + 1, r) value = nums[center] #   ,        . total_count = counter[value] + \ (left_subtree.total_count if left_subtree else 0) + \ (right_subtree.total_count if right_subtree else 0) return Node(value, left_subtree, right_subtree, total_count)</span></span></code> </pre> <br>  The solution of the problem is accordingly elementary again: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count_inversions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nums, coef=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> tree = make_tree(nums) result = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nums: tree.remove(num) result += tree.count_smaller(num * coef) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><h2>  Bonus task: basket with balls </h2><br>  This task does not require self-balancing trees at all - I bring it as a bonus to tell you a little more about the trees in Python. <br><br>  There is a virtual basket with balls of different colors.  In the basket you can put a ball of a certain color, and you can pull out a random ball.  The task is to program this basket programmatically with the most efficient operations. <br><br>  The obvious solution is <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-35-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-35"> O (1) </script>  operations to add a ball and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-36-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.794ex" height="2.66ex" viewBox="0 -832 2064 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="1674" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-36"> O (k) </script>  the choice of random: store an array with the number of balls of each color and the total number of balls N, if necessary, select a random ball, generate a random number from 0 to N - 1 and see where it falls.  (For example, there are 2 balls of zero color, 1 ball of the first color and 4 balls of the second. If a drop of 0 or 1, a ball of zero color came out; if 2, then the first color; if 3, 4, 5 or 6 - the second color.) <br><br>  However, you can arrange the basket so that both operations cost <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-37-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.311ex" height="2.66ex" viewBox="0 -832 3578.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6C" x="1403" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6F" x="1701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-67" x="2187" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="2667" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="3189" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-37"> O (\ log k) </script>  .  To do this, the number of balls of each color must be stored in the leaves of the tree, and in the remaining nodes - the amount of all the leaves in the corresponding subtrees. <br><br>  Since k is given, we know in advance how many leaves will be in the tree.  The number of nodes also can not change.  Total we have a tree of constant size;  when we try to calculate this size, we notice that it has another special property. <br><br>  Suppose we know how many nodes we need.  Let's try to put the whole tree in an array, as Python does in the <code>heapq</code> module: <br><br><img src="https://habrastorage.org/webt/p6/jo/1i/p6jo1ioupxb2ywxbhgxi_y2do5i.png"><br><br>  Each node has its own index in the array.  At the root, this index is 0, in children of the node with index <code>i</code> , the indices are <code>(2 * i + 1)</code> for the left and <code>(2 * i + 2)</code> for the right;  at the parent of the node with the index <code>i</code> index <code>(i - 1) // 2</code> . <br><br>  We need a certain number of leaves in the tree.  It is easy when this number is a power of two.  The leaves in this case simply occupy a whole layer of the tree and in memory are arranged in a row. <br><br><img src="https://habrastorage.org/webt/3t/eo/ax/3teoaxfqhn_qti4drkq8qpgbfdm.png"><br><br>  But what if k is between two powers of two?  Well, we can open several buds (necessarily from the left edge!), So that the number of leaves is as we need: <br><br><img src="https://habrastorage.org/webt/h4/hx/5v/h4hx5vncr1l8um6k16u53d3mj9a.png"><br><br>  Note that while all the leaves are <em>still located in memory in a row</em> !  This useful feature will help us greatly in implementation. <br><br>  It remains only to calculate how many nodes are needed for a tree with a given number of leaves k.  When k is a power of two, everything is clear: everything in the tree will be <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-38-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>2</mn><mi>k</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.377ex" height="2.178ex" viewBox="0 -780.1 2745.4 937.7" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2212" x="1244" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="2244" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>2</mn><mi>k</mi><mo>‚àí</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-38"> 2k - 1 </script>  knots.  Surprisingly, in all other cases too! <br><br><div class="spoiler">  <b class="spoiler_title">Evidence</b> <div class="spoiler_text">  We are looking for a tree of minimal height with k leaves and skewed toward the left subtree if it is needed (that is, if k is not a power of two). <br><br>  If a <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-39-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.472ex" height="2.074ex" viewBox="0 -772.3 2356.1 892.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.28ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3D" x="799" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1855" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-39"> k = 1 </script>  such a tree consists of one (leaf) node and for it the formula is correct. <br><br>  If a <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-40-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;gt;</mo><mn>1</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.472ex" height="2.074ex" viewBox="0 -772.3 2356.1 892.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.28ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3E" x="799" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1855" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>&gt;</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-40"> k> 1 </script>  and a power of two, the formula is again correct. <br><br>  If a <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-41-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;gt;</mo><mn>1</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.472ex" height="2.074ex" viewBox="0 -772.3 2356.1 892.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.28ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3E" x="799" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="1855" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>&gt;</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-41"> k> 1 </script>  and not a power of two, you need to build a tree with two subtrees that satisfy the desired property (and guaranteed non-empty!).  For them, the formula will be true;  in the first will <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-42-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>k</mi><mn>1</mn></msub></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.265ex" height="2.349ex" viewBox="0 -772.3 975.4 1011.3" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.555ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="737" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>k</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-42"> k_1 </script>  leaves, in the second - <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-43-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>k</mi><mn>2</mn></msub></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.265ex" height="2.349ex" viewBox="0 -772.3 975.4 1011.3" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.555ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="737" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>k</mi><mn>2</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-43"> k_2 </script>  leaves ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-44-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>k</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><mo>=</mo><mi>k</mi></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.681ex" height="2.349ex" viewBox="0 -772.3 5029.3 1011.3" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.555ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="737" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2B" x="1197" y="0"></use><g transform="translate(2198,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="737" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3D" x="3451" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="4507" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>k</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><mo>=</mo><mi>k</mi></math></span></span><script type="math/tex" id="MathJax-Element-44"> k_1 + k_2 = k </script>  ), and we have a total number of nodes <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-45-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mn>1</mn><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mn>2</mn><msub><mi>k</mi><mn>1</mn></msub><mo>&amp;#x2212;</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mn>2</mn><msub><mi>k</mi><mn>2</mn></msub><mo>&amp;#x2212;</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mn>2</mn><mo stretchy=&quot;false&quot;>(</mo><msub><mi>k</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2212;</mo><mn>1</mn><mo>=</mo><mn>2</mn><mi>k</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="52.243ex" height="2.762ex" viewBox="0 -831.5 22493.3 1189" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.83ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2B" x="722" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="1723" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="2112" y="0"></use><g transform="translate(2613,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="737" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2212" x="3811" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="4811" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="5312" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2B" x="5924" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="6924" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="7314" y="0"></use><g transform="translate(7814,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="737" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2212" x="9012" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="10013" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="10513" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3D" x="11180" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="12237" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-28" x="12737" y="0"></use><g transform="translate(13127,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="737" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2B" x="14324" y="0"></use><g transform="translate(15325,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="737" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-29" x="16300" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2212" x="16912" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="17913" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-3D" x="18691" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-32" x="19747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMATHI-6B" x="20248" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-2212" x="20992" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350732/&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiI_kfDLlCpSLw6si770dxaktfwrw#MJMAIN-31" x="21992" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mn>1</mn><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>k</mi><mn>1</mn></msub><mo>‚àí</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>k</mi><mn>2</mn></msub><mo>‚àí</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>2</mn><mo stretchy="false">(</mo><msub><mi>k</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>‚àí</mo><mn>1</mn><mo>=</mo><mn>2</mn><mi>k</mi><mo>‚àí</mo><mn>1</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-45"> 1 + (2k_1 - 1) + (2k_2 - 1) = 2 (k_1 + k_2) - 1 = 2k - 1 </script></p><br></div></div><br>  Code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> random <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bucket</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, k)</span></span></span><span class="hljs-function">:</span></span> self.k = k <span class="hljs-comment"><span class="hljs-comment">#       , #      . self.tree = [0] * (2 * k - 1) def add_ball(self, color): #        ! node_index = self.k - 1 + color while node_index &gt;= 0: #      #       . self.tree[node_index] += 1 node_index = (node_index - 1) // 2 def pick_ball(self): total_balls = self.tree[0] ball_index = random.randrange(total_balls) node_index = 0 # ,     ,  - #     (k - 1). while node_index &lt; self.k - 1: self.tree[node_index] -= 1 left_child_index = 2 * node_index + 1 right_child_index = 2 * node_index + 2 if ball_index &lt; self.tree[left_child_index]: node_index = left_child_index else: ball_index -= self.tree[left_child_index] node_index = right_child_index self.tree[node_index] -= 1 return node_index - self.k + 1</span></span></code> </pre> <br><h2>  PS </h2><br>  Yes, most of these tasks have solutions without any trees at all.  Nevertheless, I believe that trying to solve them was a useful exercise.  I hope for you too!  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/350732/">https://habr.com/ru/post/350732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350718/index.html">We generate levels for the game using neural networks</a></li>
<li><a href="../350720/index.html">[Not only to students] Packet Tracer Lab</a></li>
<li><a href="../350724/index.html">Germicidal emitters for smartphones. Prospects for the integration of these systems in gadgets</a></li>
<li><a href="../350728/index.html">How to recover lost text</a></li>
<li><a href="../350730/index.html">Creating a network with Internet access in GNS3 on Windows 10</a></li>
<li><a href="../350734/index.html">As I wrote my VNC, and then no</a></li>
<li><a href="../350738/index.html">802.11ax - details (webinar, english)</a></li>
<li><a href="../350740/index.html">Create your cryptocics (Part 1)</a></li>
<li><a href="../350742/index.html">Optimization of the code in the mind, or "Well, just as definitely faster"</a></li>
<li><a href="../350744/index.html">SSO and Kibana: Kibana integration with integrated Windows authentication (Single Sign-On)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>