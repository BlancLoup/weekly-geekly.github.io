<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Such a pain! Crowds against the Web - 2: 0. Episode One - High-Speed ‚Äã‚ÄãQueuing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tov. phpdude has opened an interesting topic for a large audience with the ‚ÄúPHP + MySQL Optimization‚Äù blog. I will tell about how I Web 2.0 killed two...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Such a pain! Crowds against the Web - 2: 0. Episode One - High-Speed ‚Äã‚ÄãQueuing</h1><div class="post__text post__text-html js-mediator-article">  Tov.  <a href="https://habr.com/ru/users/phpdude/" class="user_link">phpdude has</a> opened an interesting topic for a large audience with the ‚ÄúPHP + MySQL Optimization‚Äù blog.  I will tell about how I Web 2.0 killed two of my servers (because of my stupidity including) and also plans to kill. <br><br>  It all started in the fall of 2006, when I decided to open a small site with 70 million pages.  And no, they would not be made according to <a href="http://ru.wikipedia.org/wiki/%25D0%25A6%25D0%25B5%25D0%25BF%25D1%258C_%25D0%259C%25D0%25B0%25D1%2580%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B0">Markov's chains</a> , namely they would be useful.  Why 70 million?  Because so many .com / .net / .org domains at that moment I could find. <a name="habracut"></a><br><br>  I will not give you a link to the project - I'm tired of you, comrades Habcheloveki, cleaning the mat.  If you really want to - look at my previous topic about ‚Äúearnings from startups‚Äù.  I'm going to tell in the historical order, so that before I memcached from the Heise DDoS, I‚Äôll probably go to the second part. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, I had an idea - to find the most rarely used word on the Internet.  To do this, you need to bypass 70 million sites (the list is honestly scrapped with <a href="http://who.is/">who.is</a> , I tried to get access to the <a href="http://www.verisign.com/information-services/naming-services/com-net-registry/page_001052.html">TLD Zone Access Program</a> , but do not let go).  Linguists, by the way, probably already laughed at my idea of ‚Äã‚Äãfinding the rarest word, well, then I didn‚Äôt know much about words. <br><br>  Actually, the question.  How to organize a queue?  That is, start with aaaa.com and finish zzzz.com - do you need to save it somewhere?  Well, MySQL is clear!  id, url, status = {'were'; 'were not yet'} <br><br>  It was not immediately clear to me ... why my computer was so stupid ... I began to perceive 72 million MySQL records with very great enthusiasm.  Transactions, whether InnoDB or MyISAM.  The problem also arose in the fact that with each next INSERT - they are becoming slower. <br><br>  Okay, somehow done.  We use MyISAM, because InnoDB didn‚Äôt digest that much at all.  (Maybe I did something wrong, but in fact does not change).  Let's go, <b>SELECT id, url WHERE status = 'were not yet';</b>  <b>UPDATE STATUS = 'try'</b> . <br><br>  Yeah, it's not that simple.  There are no transactions; 2-3-10 bots to the same address start breaking (SELECT happens at the same time, everyone receives the same URL and at the same time sets up a new status, discarding all subsequent ones, and go on to that address). <br><br>  This is where I invented (more precisely, I guessed it for myself - this isn‚Äôt the name), the first MySQL optimization focus under high load - for MyISAM without transactions. <br><br>  Add the rand field, then each thread generates a random number and does <b>UPDATE‚Ä¶ rand = '92803423' WHERE (status = 'have not been yet') <u>AND</u> (rand IS NULL) <u>LIMIT 1</u></b> , and then <b>SELECT WHERE rand = '92803423'</b> .  We get a full ATOMIC - only one thread is guaranteed to receive this record <b>without transactions</b> . <br><br>  Okay, but the speed was more than fig - to knead 72 million records with hundreds of threads - this is not a joke for the company.  In general, mySQL was crawling. <br><br><blockquote>  (not about mysql) Then I thought up, as it seemed to me a ‚Äúbrilliant‚Äù plan - to put everything into a file right where only one line - one url and we do so - flock, jump (fseek) to a random place in the file - we find ourselves somewhere then in the middle of the line we read up to the \ n character, now we read the translations to the new line up to the first alphanumeric character.  Great, read the line, save it, do fseek at the beginning of this line and fill it with \ n, release the flock.  Then once an hour we do grep to remove empty lines from the file. <br><br>  It seemed that it all decided - all operations have almost constant time, even an additive, nothing grows even there 100 million, even a billion, but MySQL linearly increases the operation time with each new element.  I did not think that I / O will be sooooo much here.  In general, 100 threads for a month of such techniques killed the hard drive on the server.  We put a new one, but I had to think of something. </blockquote><br><br>  Then I thought that I have the same threads in order and why would they go to the database every time, if they can take 100 url right away, delete them, make them, and then we will apply for new ones.  Immediately, another optimization immediately occurred to me - namely, instead of id, url, status + SELECT / <i>UPDATE,</i> I can use a temporary table with id, urls and SELECT / <i>DELETE</i> . <br><br>  Actually the table looked like this: <br><blockquote>  id;  urls <br>  "one";  "Aaaa.com; aaaab.com; aaaac.com; aaaad.com ...." <br>  "2";  "Aaa ... <br>  "720000"; "zzzzzxxx.com; zzzzy.com; zzzzzzz.com" <br></blockquote><br><br>  This is the first time I used denormalization in MySQL, but there was no choice. <br><br>  that is, the second field was TEXT, which I then did split (';') in PHP.  Why 100, not 1000?  Empirically.  It was necessary to expect that the script, having taken 100 URLs, could hang on some kind, a segfault could occur and anything else, the server would reboot, so it was necessary to limit the losses.  Plus, if I noticed a bug, I had to stop the system - this was done using the kill -9 method. <br><br>  100 urls were processed in 30 seconds on average, so that the losses in case of what would be a maximum of 10,000 url (100 x 100 threads), but in reality it turned out not more than 1000. For a hobby project, it is normal. <br><br>  Then you ask me - why did I give such a value so that two threads, God forbid, did not catch the same URL, and did not consider the loss of 10k url a problem?  Because in the first case I will arrange a light DoS attack to the remote site, which I didn‚Äôt want to do even if it was only 2, and if everything is 100 at the same time? <br><br>  In general, this organization of the queue more than justified itself - MySQL worked everything out for a very quick time, periodic OPTIMIZE TABLE contributed to this. <br><br><h4>  Word frequencies </h4><br><br>  Then the question arose - I needed to keep the cache of what I found, or rather, the list of words that met on the main page and their number ... <br><br><blockquote>  ... in order to analyze and find the Holy Grail - the rarest word that would be so rare that it would exist only once on all sites and that would disappear after my arrival.  It turned out that the word "yoihj" is my nickname.  Like your nickname, reader, and nicknames of everyone who registers anywhere.  Simply put, it turned out to be not-words, but nicknames, typos, etc. </blockquote><br><br>  ... so, store the number of words.  Went the obvious way. <br>  url (varchar); word (varchar); count (int) <br><br>  It‚Äôs a pity that my school teacher of mathematics wasn‚Äôt there - she would quickly explain to me on the head that 72 million sites x 1000 words on each one is 72 billion records, and I just screamed that MySQL 72 million barely pulls and constantly slows down. <br><br>  In general, the idea is the same - I began to store urls in the database;  serialize ($ words).  Then it was later replaced by json_encode ($ words), because the bots had already been rewritten in Python and PHP Serialize support, although it was, but slowed down, so JSON took the priority place. <br><br>  Actually, this is still the way it is kept - both TechCrunch and Heise.de and many others raided. <br><br>  Of course, this is not all that had to be done - there he invented his SphinxSearch and memcached as a database - by the way it worked well.  :) But more about that another time. <br><br>  <b>UPDATE</b> <br>  I forgot about the finish version (which is now). <br>  All sites in the database - 72 million records, with no index, except PRIMARY KEY = url (varchar), <br>  and the SELECT query ... WHERE url&gt; 'kite.com' LIMIT 100, where kite.com is the last bypass site, <br>  the time of this request is constant over the entire base O (1), <br>  no update is done at all, <br>  we process these hundred in threads when the number of live threads is nearing 20 - Suppose this SELECT gives the last one 'klara.com' - save where the thread 'klara.com' - here we already make SELECT ... WHERE url&gt; 'klara.com' LIMIT 100 <br>  Under php, threads are processes, a process account through popen ('ps aux | grep processname', 'r'). <br>  Just now the bots are already translated into Python. <br><br><img src="http://habrahabr.ru/media/userpic/avatar/14/45/58/31055.png"><br>  Yoi Haji <br>  <a href="http://yoihj.habrahabr.ru/blog/">view from Habra</a> </div><p>Source: <a href="https://habr.com/ru/post/39945/">https://habr.com/ru/post/39945/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../399441/index.html">Dry breakfast in deep space</a></li>
<li><a href="../399443/index.html">Ask Ethan # 107: Is inflation linked to dark energy?</a></li>
<li><a href="../399445/index.html">Either these are unusual stars, or 234 alien civilizations send us their regards</a></li>
<li><a href="../399447/index.html">Radical allergy treatment: allergen-specific immunotherapy (ASIT)</a></li>
<li><a href="../399449/index.html">DNA is only half the chromosome volume. Everything else is a shell of unknown functionality.</a></li>
<li><a href="../399451/index.html">Why we do not have infant memories</a></li>
<li><a href="../399453/index.html">Five forms of blockchain money available now.</a></li>
<li><a href="../399455/index.html">Not only home appliances: What else is there in Audiomania for music lovers, amateurs and musicians</a></li>
<li><a href="../399457/index.html">Russian FinTech Meetup # 2: Trading in the Era of Modern Digital Technologies</a></li>
<li><a href="../399459/index.html">Blackjack leakage protection with counters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>