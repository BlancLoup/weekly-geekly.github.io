<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FIAS addresses in the PostgreSQL environment. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the third part of the article, which describes the search function in the list of address-forming 
 FIAS elements loaded into a database runni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FIAS addresses in the PostgreSQL environment. Part 3</h1><div class="post__text post__text-html js-mediator-article">  This is the third part of the article, which describes the search function in the list of address-forming <br>  FIAS elements loaded into a database running PostgreSQL.  Here are links to the <a href="https://habrahabr.ru/post/316314/">first</a> and <a href="https://habrahabr.ru/post/316380/">second</a> parts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/94a/cb7/fbc/94acb7fbc32a4cf18fd15e854b62360c.png"></div><br><a name="habracut"></a><br>  The full text of the article consists of 4 parts.  The first half of this part of the article contains comments on the implementation of the function.  In the second - the source code of the function.  For those readers who are interested only in the source code, we suggest that you go straight to the <a href="https://habr.com/ru/post/316622/">Appendix</a> . <br><a name="tf_Address_SBN"></a><br><h2>  Search for address-forming element </h2><br>  The fstf_AddressObjects_SearchByName function is used to search for FIAS adre-forming elements by their names.  In this case, the search can be carried out not only by the name and type of the current element, but also by the names and types of one or two of its closest ancestors. <br>  Consider a few examples.  And to begin with, we find all address-forming elements in the name of which the word ‚ÄúMushroom‚Äù is found. <br><br>  <strong>Table 8. Result of executing the fstf_AddressObjects_SearchByName ('Mushroom') function</strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <table><tbody><tr><th>  AOGUID </th><th>  AOLevel </th><th>  Full address </th><th>  ShortName </th><th>  FormalName </th><th>  CurrStatus </th><th>  Actstatus </th></tr><tr><td>  15faf08c-78b6-4b92-8a56-2ff70f2c4cab </td><td>  6 </td><td>  Achinsky district, Mushroom </td><td>  P </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr><tr><td>  f1772172-4dd1-449d-b2d2-ab96883d8871 </td><td>  7 </td><td>  Kezhemsky district, Mr. Kodinsk, per Mushroom </td><td>  per </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr><tr><td>  146cbcb5-4ad9-4578-916f-80ebd5c2b846 </td><td>  7 </td><td>  Yemelyanovsky district, Elite, Lane Mushroom </td><td>  per </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr><tr><td>  a8ee8caf-fd5f-489c-92d9-f560e3f93c8b </td><td>  7 </td><td>  Sukhobuzimsky district, D. Shestakovo, per Mushroom </td><td>  per </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr><tr><td>  84f4baa8-1db2-471d-967d-20d489bca68e </td><td>  7 </td><td>  Kuraginsky district, with Tyhtyat, per Mushroom </td><td>  per </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr><tr><td>  1f2b7975-ce05-4627-bd13-d8d6228accd7 </td><td>  7 </td><td>  Mr. Sorsk, Lane Mushroom </td><td>  per </td><td>  Mushroom </td><td>  0 </td><td>  one </td></tr></tbody></table><br>  There is nothing unexpected in the result obtained, except for a clear proof of the benefits of the function for constructing a full name. <br><br>  Now we change the query.  Find all address-forming elements, in the name of the nearest ancestor of which the word "Mushroom" is found. <br><br>  <strong>Table 9. The result of the function fstf_AddressObjects_SearchByName</strong> <strong><br></strong>  <strong>(NULL, NULL, 'Mushroom')</strong> <br><br><table><tbody><tr><th>  AOGUID </th><th>  AOLevel </th><th>  Full address </th><th>  ShortName </th><th>  FormalName </th><th>  CurrStatus </th><th>  Actstatus </th><th>  Parent ShortName </th><th>  Parent FormalName </th></tr><tr><td>  45064ade-a0a7-4258-88c8-baa57094aa2d </td><td>  7 </td><td>  Achinsky district, Mushroom, ul Railway </td><td>  street </td><td>  Railway </td><td>  0 </td><td>  one </td><td>  P </td><td>  Mushroom </td></tr><tr><td>  ba4ec53c-50b7-4325-866a-81f97a38214c </td><td>  7 </td><td>  Achinsky Rn, p Mushroom, West Street </td><td>  street </td><td>  Western </td><td>  0 </td><td>  one </td><td>  P </td><td>  Mushroom </td></tr><tr><td>  d6e9e0cc-e944-4deb-a09c-c545af691836 </td><td>  7 </td><td>  Achinsky Rn, p Mushroom, North </td><td>  street </td><td>  North </td><td>  0 </td><td>  one </td><td>  P </td><td>  Mushroom </td></tr><tr><td>  5ae71e68-5477-446b-b878-0a9c9bf3bdcd </td><td>  7 </td><td>  Achinsky Rn, p Mushroom, South Street </td><td>  street </td><td>  South </td><td>  0 </td><td>  one </td><td>  P </td><td>  Mushroom </td></tr></tbody></table><br>  The result of this query is somewhat more unexpected, since  in the names of the address-forming elements found there is no word ‚ÄúMushroom‚Äù, but it is in the name of their ancestor. <br><br>  And, finally, consider a search by the name of the progenitor, in which the word ‚ÄúAchinsky‚Äù should be present, and in the name of his grandson there should be a part of the word ‚ÄúOz_rn‚Äù.  A special character is used here - the underscore character ‚Äú_‚Äù.  This symbol indicates that any single character can be in its place.  Here it is applied in order to find not only the elements with the names ‚ÄúLake‚Äù or ‚ÄúLake‚Äù, but also ‚ÄúLake‚Äù or ‚ÄúLake‚Äù. <br><br>  <strong>Table 9. The result of the function fstf_AddressObjects_SearchByName (NULL, NULL, 'Mushroom')</strong> <br><br><table><tbody><tr><th>  AOGUID </th><th>  AOLevel </th><th>  Full address </th><th>  ShortName </th><th>  FormalName </th><th>  CurrStatus </th><th>  Actstatus </th><th>  Parent ShortName </th><th>  Parent FormalName </th><th>  Grand Parent ShortName </th><th>  Grand parent FormalName </th></tr><tr><td>  715eef9d-48f6-4322-bcaa-9d239e89b7e4 </td><td>  7 </td><td>  Achinsky district, d Barabanovka, lane Ozerny </td><td>  per </td><td>  Lake </td><td>  0 </td><td>  one </td><td>  d </td><td>  Drumming </td><td>  rn </td><td>  Achinsky </td></tr><tr><td>  05c7b2ad-e405-4c8b-9503-6761971e858e </td><td>  7 </td><td>  Achinsky district, Ilyinka St., Ozernaya St. </td><td>  street </td><td>  Ozernaya </td><td>  0 </td><td>  one </td><td>  d </td><td>  Ilyinka </td><td>  rn </td><td>  Achinsky </td></tr><tr><td>  bdfcd515-1851-4caf-83ba-12ee79f9f6a7 </td><td>  7 </td><td>  Kazachinsky district, with Dudovka, ul Ozernaya </td><td>  street </td><td>  Ozernaya </td><td>  0 </td><td>  one </td><td>  with </td><td>  Dudovka </td><td>  rn </td><td>  Kazachinsky </td></tr></tbody></table><br>  As a result of the inquiry, Ozernaya streets and a lake lane were found in three settlements of Achinsky and Kazachinsky districts of the Krasnoyarsk Territory.  The text of the function is given in the <a href="https://habr.com/ru/post/316622/">Appendix</a> section <a href="https://habr.com/ru/post/316622/">‚ÄúCreating the function fstf_AddressObjects_SearchByName‚Äù</a> . <br><br><h3>  How it works </h3><br>  If values ‚Äã‚Äãare assigned only to the first two arguments - the name (a_FormalName) and the type (a_ShortName) of the address-forming element, then all records of the fias_AddressObjects table are searched.  Preliminarily, the values ‚Äã‚Äãof the parameters passed are converted to uppercase, spaces are replaced with the ‚Äú%‚Äù symbol.  The same symbol surrounds the value on the right and left.  The values ‚Äã‚Äãthus converted are used in the search query as part of the LIKE operation.  An example of such a request is shown in Fig.  four. <br><br><img src="https://habrastorage.org/files/c5b/894/825/c5b894825cce4aed9ce2935bbb009a4a.png"><br><br>  <strong>Fig.</strong>  <strong>4. Simple search for address-forming element.</strong> <br><br>  The condition for choosing the CurrStatus value was discussed in detail in the first part of the article in the section ‚ÄúAncestor of the Addressing Element‚Äù ‚ÄúHow it works‚Äù. <br><br>  To search by name and type of parent address-forming element, you must assign a value to at least one of two arguments: the third (a_ParentFormalName), or the fourth (a_ParentShortName).  In this case, the search is performed in all records of the table received by the connection (INNER JOIN) of all records of fias_AddressObjects with records of the parent address-forming element based on the pfa.AOGUID = cfa.ParentGUID attribute. <br>  An example of such a request is shown in Fig.  five. <br><br><img src="https://habrastorage.org/files/d96/762/c10/d96762c10c584586b34b23a12645e6d7.png"><br><br>  <strong>Fig.</strong>  <strong>5. Search by name and type of parent address-forming element.</strong> <br><br>  Preliminary processing of input parameter values ‚Äã‚Äãis carried out according to the same rules as in the case of a simple search.  To search by name and type of ancestral address-forming element, you must assign a value to at least one of two arguments: the fifth (a_GrandParentFormalName) or the sixth (a_GrandParentShortName).  In this case, the search is performed in all records of the table obtained by double joining (INNER JOIN) of all records of fias_AddressObjects with records of the parent and ancestral address-forming elements.  An example of such a request is shown in Fig.  6 <br><br><img src="https://habrastorage.org/files/464/42f/7e0/46442f7e0e8844f58bdd4f3abc097ce1.png"><br><br>  <strong>Fig.</strong>  <strong>6. Search by name and type of ancestral address-forming element.</strong> <br><br>  Preliminary processing of input parameter values ‚Äã‚Äãis carried out according to the same rules as in the case of a simple search. <br><br><h2>  ATTACHMENT </h2><a name="Script4"></a><br><h3>  Creating the fstf_AddressObjects_SearchByName function </h3><br><div class="spoiler">  <b class="spoiler_title">Function source code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_AddressObjects_SearchByName( a_FormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), a_ShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), a_ParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), a_GrandParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_GrandParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/***********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_AddressObjects_SearchByName( a_FormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_ShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_ParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_ParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_GrandParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_GrandParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), rtf_AOLevel <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtf_AddressObjectsFullName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>), rtf_ShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), rtf_FormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), rtf_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtf_ParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), rtf_ParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), rtf_GrandParentShortName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), rtf_GrandParentFormalName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_BlankChar CONSTANT VARCHAR(2)=' '; v_FormalNameTemplate VARCHAR(150); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_ShortNameTemplate VARCHAR(20); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ParentFormalNameTemplate VARCHAR(150); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ParentShortNameTemplate VARCHAR(20); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_GrandParentFormalNameTemplate VARCHAR(150); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_GrandParentShortNameTemplate VARCHAR(20); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************ --************************************************************ BEGIN v_ShortNameTemplate:=UPPER(COALESCE(c_WildChar|| REPLACE(TRIM(a_ShortName),c_BlankChar,c_WildChar)|| c_WildChar,c_WildChar)); v_FormalNameTemplate:=UPPER(c_WildChar|| REPLACE(TRIM(a_FormalName),c_BlankChar,c_WildChar)|| c_WildChar); IF a_ParentFormalName IS NULL AND a_ParentShortName IS NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN RETURN QUERY SELECT cfa.AOGUID,cfa.AOLevel, fsfn_AddressObjects_TreeActualName(cfa.AOGUID), cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,NULL::VARCHAR,NULL::VARCHAR, NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME; ELSIF a_ParentFormalName IS NOT NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN v_ParentShortNameTemplate:=UPPER(COALESCE(c_WildChar|| REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar)|| c_WildChar,c_WildChar)); v_ParentFormalNameTemplate:=UPPER(c_WildChar|| REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar)|| c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); RETURN QUERY SELECT cfa.AOGUID,cfa.AOLevel,fsfn_AddressObjects_TreeActualName(cfa.AOGUID), cfa.ShortName,cfa.FORMALNAME,cfa.currstatus, pfa.ShortName,pfa.FORMALNAME, NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID WHERE cfa.currstatus=CASE WHEN 0 &lt; ALL (SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus=CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME, cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME; ELSE v_GrandParentShortNameTemplate:=UPPER(COALESCE(c_WildChar|| REPLACE(TRIM(a_GrandParentShortName),c_BlankChar,c_WildChar)|| c_WildChar,c_WildChar)); v_GrandParentFormalNameTemplate:=UPPER(c_WildChar|| REPLACE(TRIM(a_GrandParentFormalName),c_BlankChar,c_WildChar)|| c_WildChar); v_ParentShortNameTemplate:=COALESCE(UPPER(COALESCE(c_WildChar|| REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar)|| c_WildChar,c_WildChar)),c_WildChar); v_ParentFormalNameTemplate:=COALESCE(UPPER(c_WildChar|| REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar)|| c_WildChar),c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); RETURN QUERY SELECT cfa.AOGUID,cfa.AOLevel,fsfn_AddressObjects_TreeActualName(cfa.AOGUID), cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,pfa.ShortName,pfa.FORMALNAME, gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID WHERE cfa.currstatus=CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus=CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus=CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME, pfa.ShortName,pfa.FORMALNAME, cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_AddressObjects_SearchByName( a_FormalName VARCHAR(150),a_ShortName VARCHAR(20), a_ParentFormalName VARCHAR(150),a_ParentShortName VARCHAR(20), a_GrandParentFormalName VARCHAR(150),a_GrandParentShortName VARCHAR(20)) IS '            '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; --SELECT * FROM fstf_AddressObjects_SearchByName('',''); --SELECT * FROM fstf_AddressObjects_SearchByName(''); --SELECT * FROM fstf_AddressObjects_SearchByName('',NULL,''); --SELECT * FROM fstf_AddressObjects_SearchByName(NULL,NULL,''); --SELECT * FROM fstf_AddressObjects_SearchByName('_','',NULL); SELECT * FROM fstf_AddressObjects_SearchByName('_','','',NULL,'');</span></span></code> </pre> <br></div></div><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/316622/">https://habr.com/ru/post/316622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316608/index.html">Mozilla and Tor closed a critical vulnerability that was actively used to de-anonymize Tor users.</a></li>
<li><a href="../316610/index.html">Double your money in December! New Year's Eve action on "My Circle"</a></li>
<li><a href="../316616/index.html">How we participated in the HR hackathon. Our graduates share their decision and impressions of participation.</a></li>
<li><a href="../316618/index.html">9 ways to optimize front-end performance</a></li>
<li><a href="../316620/index.html">As I opened the Dota-league. Part 2</a></li>
<li><a href="../316624/index.html">Recipes. How to install software on servers using VMmanager and DCImanager</a></li>
<li><a href="../316628/index.html">The main thing from the conference for those who create new media - MediaMakers-2016</a></li>
<li><a href="../316630/index.html">As a developer to open your business. Planning</a></li>
<li><a href="../316634/index.html">What is a DBMS in RAM and how it effectively stores data</a></li>
<li><a href="../316636/index.html">What happens to teams when using BaseCamp, Trello, YouTrack, Smartsheet, Slack, YouGile. Review Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>