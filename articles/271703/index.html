<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How sometimes bad code and antipattern solve</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! 

 Today I would like to tell you how bad code helped me in a project. 

 Who cares, I ask under the cat. 

 I inherited a project for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How sometimes bad code and antipattern solve</h1><div class="post__text post__text-html js-mediator-article">  Hi% username%! <br><br>  Today I would like to tell you how bad code helped me in a project. <br><br>  Who cares, I ask under the cat. <br><a name="habracut"></a><br>  I inherited a project for maintenance.  I do not know who was written, but this person hiccups to this day.  The essence is this - there is an application for collecting photo reports in the store and sending them to the manual on the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything seems to be simple, but there were constant complaints of employees about the fall of the application when photographing.  Analysis of the code showed that when the camera called the intent of the camera application, Android killed the application due to lack of resources and upon returning the result to the activation, the latter was re-created and did not contain the data needed for operation.  Recreation of activation was simply not processed.  Well, yes, there is configChanges * sarcasm * <br><br><h4>  Step 1. Rebuild processing </h4><br>  Having tormented 2 days, having corrected the code, having thrown out repeating fragments I began to test.  I threw a taskkiller into the emulator, launched the camera, killed the process.  Fotkayu - beauty !!!  Everything is beautiful, there is a photo.  I click save and ... broads) The application has fallen. <br><br><h4>  Step 2. Singleton - Evil Evil </h4><br>  The reason for the fall - no data on the current report.  It turned out that the application was a miracle singleton, which was kept in himself EVERYTHING!  Absolutely all the critical data needed for the application and even more.  This includes an authorization token, and 40 report status fields and links to classes describing the report and user geodata and a couple of Bitmap collections.  In an instant, we lost everything that could be lost. <br><br>  The result was described to the customer.  Refactoring is appreciated, but they did not have that much money.  At the same time, tearfully asked to do something and tuck crutches. <br><br><h4>  Step 3. Change Singleton </h4><br>  All that occurred to me was to fix the singleton so that it would become reliable and without change its interface.  The following was thought up - everything that can be pushed into the SharedPreferenses was saved there. <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getStingFromPref(AUTH_TOKEN); } ..... <span class="hljs-comment"><span class="hljs-comment">//   .</span></span></code> </pre> <br><br>  Roughly, stupidly, but there is no need to change the code in the whole project and our Singleton has become more stable (there are Bitmap collections with which we haven‚Äôt done anything yet).  All objects that can only be serialized were serialized and stuffed into SharedPreferences too. <br><br>  The application went to the test, in the product and the fall stopped at 70% of the devices.  On the others, after sending the result from the camera, not the current one, but the previous activation in the stack was recreated.  For me, this is still a mystery.  Guru - explain in the comments. <br>  The essence of this - Activi A starts Activi B with the result.  Activation B launches the camera intent with the result. <br>  When the process was killed during the operation of the camera, activation of A was recreated to create a photo. Activation B did not call either onCreate or onActivityResult.  (PS Android 4.4) <br><br>  google and stackowerflow did not respond, I had to go a different way and write more bad code. <br><br>  If re-creation fails, you can prohibit the kill, I thought, and proceeded to step 4. <br><br><h4>  Step 4. Final.  Foreground garbage truck </h4><br>  How to make Android not kill the process?  My thoughts were: ‚ÄúIf we tell OS, that we have an important foreground service that performs important calculations for us for exactly as long as we take pictures of goods.  It could definitely work. ‚Äù <br><br>  So born in the project foreground-garbage truck.  He drove a cycle from 0 to 60 and fell asleep in the body for a second.  As soon as the result came from the camera, the service was killed.  The application has been collected and given for testing. <br>  The result - KitKat was smarter and nailed the process.  That is, nothing has changed. <br><br>  I was already desperate when another thought occurred to me: ‚ÄúAnd if you stupidly save the link to activations in a singleton and call startActivityForResult right from the foreground garbage truck?‚Äù.  I have never done this, and I hope no more. <br><br>  The application is collected, given to the test and ... lo and behold, the process no longer closes. <br><br>  Instead of a conclusion.  The customer is warned that he has a bad application and I made it even worse, but it works as expected by the company's employees. <br><br>  Finally.  Tell us about your worst ‚Äúcode‚Äù in your career.  Let's cheer each other up. </div><p>Source: <a href="https://habr.com/ru/post/271703/">https://habr.com/ru/post/271703/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271693/index.html">We write software for generating music card data. Part one: parse the MIDI file</a></li>
<li><a href="../271695/index.html">Developer Economics Tenth Study</a></li>
<li><a href="../271697/index.html">Machine Learning Hackathon: Come. To train a model. To win</a></li>
<li><a href="../271699/index.html">Professional test on the knowledge of the realities of the market for customized development and digital communications</a></li>
<li><a href="../271701/index.html">Design prototypes of cells in the same XIB with UITableView</a></li>
<li><a href="../271705/index.html">End of an era of dynamic languages</a></li>
<li><a href="../271707/index.html">Mikrotik: small utility. Part 2</a></li>
<li><a href="../271711/index.html">Features (traits) in Perl 6 - metadata along with a symbol</a></li>
<li><a href="../271713/index.html">"Darknet Weekdays" - video materials for training on information security</a></li>
<li><a href="../271717/index.html">Social engineering first hand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>