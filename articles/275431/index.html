<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hibernate envers. Substitution ID of the user who made the change</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrovchane. This is my first article, please do not swear much. 

 Much has already been written about listening in Hibernate. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hibernate envers. Substitution ID of the user who made the change</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cc0/8a1/c7a/cc08a1c7a991322f0fdc1852b58489da.png" alt="image"><br><br>  Good afternoon, dear habrovchane.  This is my first article, please do not swear much. <br><br>  Much has already been written about listening in Hibernate.  I want to talk about the solution of a not quite standard task - writing to the revision table the ID of any user assigned immediately before the operation of writing an entity to the database.  The standard solution proposed in the official documentation is to use the user ID stored in the session bean.  But it is possible that the user ID must be changed.  Example: a user performs operations through interaction with a telephony server using DTMF signals.  In this case, the session does not need to create.  I have been looking for a solution on the Internet for a long time, but I haven‚Äôt found anything, so I offer you my version.  Perhaps some of the newbies, like me, it will be useful. <br><a name="habracut"></a><br>  Reading the documentation, I realized that listening to Hibernate is based on interceptors.  This means that the thread that updates the entity in the database is responsible for listening - this is already something. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's try to benefit from it.  We create a stateless component in which a static map with pairs will be stored: stream ID ‚Äî user ID.  The start method adds the user ID (passed by the parameter) and the current thread ID to the map, then launches a method in the new transaction that performs the necessary actions, waits for the method (transaction) to end, and removes the stream ID and user ID from the map. <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Stateless</span></span> <span class="hljs-meta"><span class="hljs-meta">@TransactionAttribute</span></span>(TransactionAttributeType.NOT_SUPPORTED) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FakeOwnerTransaction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Provider&lt;FakeOwnerTransaction&gt; providerFakeOwnerNewTransaction; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ThreadLocal&lt;Long&gt; threadOwnerID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;&gt;() <span class="hljs-meta"><span class="hljs-meta">@TransactionAttribute</span></span>(TransactionAttributeType.REQUIRES_NEW) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newCMT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable action)</span></span></span><span class="hljs-function"> </span></span>{ action.run(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long personID, Runnable action)</span></span></span><span class="hljs-function"> </span></span>{ threadOwnerID.set(personID); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { providerFakeOwnerNewTransaction.get().newCMT(action); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { threadOwnerID.remove(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFakeChanger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> threadOwnerID.get(); } }</code> </pre> <br>  Now let's see what the RevisionListener implementation will look like.  If the current thread is associated with a user ID, use this ID, otherwise we take the user ID from the session component UserManager. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Audition</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RevisionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRevision</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Revinfo revinfo)</span></span></span><span class="hljs-function"> </span></span>{ Long personID = FakeOwnerTransaction.getFakeChanger(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (personID == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { UserManager userManager = SystemUtils.lookup(JNDI_NAME_PREFIX, UserManager.class); personID = userManager.getPersonID(); } revinfo.setPersonID(personID); } }</code> </pre><br>  And finally, we will try to make a change in the database using the specified user ID. <br><br><pre> <code class="java hljs">FakeOwnerTransaction fakeOwnerTransaction = SystemUtils.lookup(JNDI_NAME_PREFIX, FakeOwnerTransaction.class); fakeOwnerTransaction.start(getPersonID(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Dao dao = SystemUtils.lookup(JNDI_NAME_PREFIX, Dao.class); dao.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person(‚ÄúSmirmov‚Äù)); } });</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">SystemUtils class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemUtils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String jndiNamePrefix, Class&lt;T&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String jndiName = jndiNamePrefix; jndiName += clazz.getSimpleName() + <span class="hljs-string"><span class="hljs-string">"!"</span></span> + clazz.getName(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InitialContext().lookup(jndiName); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { CoreSharedUtils.getLogger().severe(<span class="hljs-string"><span class="hljs-string">"Error. Bean '"</span></span> + jndiName + <span class="hljs-string"><span class="hljs-string">"' not found!"</span></span>); e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ‚Ä¶ }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Important notes</b> <div class="spoiler_text">  Today, one intelligent person with Habr, who for some reason cannot write comments, noted an important problem that should be paid attention to. <br>  The thread can be terminated from outside the JVM, in which case the block finaly will not be executed.  Hypothetically, this may lead to a memory leak, but this option suits me. <br></div></div><br><br>  I have it all.  If someone has more interesting solutions or criticism, welcome to the comments. </div><p>Source: <a href="https://habr.com/ru/post/275431/">https://habr.com/ru/post/275431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275419/index.html">Android application development contest for students</a></li>
<li><a href="../275421/index.html">New podcasts about professional development for Android</a></li>
<li><a href="../275425/index.html">DevTips: Web Developer Tips (33-48)</a></li>
<li><a href="../275427/index.html">Pro trackpoint and mouse emulation</a></li>
<li><a href="../275429/index.html">Counterfeiters vs. Bankers: Bleed adversarial networks in Theano</a></li>
<li><a href="../275435/index.html">Redux Tutorial from Library Creator</a></li>
<li><a href="../275439/index.html">Working with Arduino from a C # application</a></li>
<li><a href="../275441/index.html">Experience installing SolidWorks on a Windows 7 virtual machine on a Ubuntu host OS</a></li>
<li><a href="../275443/index.html">LastPass users are vulnerable to the simplest phishing attack in Chrome</a></li>
<li><a href="../275445/index.html">Comparison of programming languages ‚Äã‚Äãand frameworks for them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>