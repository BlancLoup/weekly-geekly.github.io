<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HTML5 circular panorama on three.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, more and more you can stumble upon a circular panorama on the Internet. Take for example the same cheese house . This spectacular little thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HTML5 circular panorama on three.js</h1><div class="post__text post__text-html js-mediator-article">  Recently, more and more you can stumble upon a circular panorama on the Internet.  Take for example the same <a href="http://dom.ikea.ru/shkola-remonta/issue/14">cheese house</a> .  This spectacular little thing may soon become commonplace for sites of restaurants, hotels, hotels, etc. However, what to do if there are problems with flash on the computer?  This is a real situation that has arisen in my work due to the tight security policy of the IT department. <br>  In this small article I will tell you about the difficulties that I encountered on the way of creating an interactive panorama on WebGL + THREE.js. <br><a name="habracut"></a><br><br>  Define the requirements for the panorama: <br><ul><li>  We use WebGL, since Canvas panoramas are just awful, and new IE is <a href="http://habrahabr.ru/post/174865/">supported</a> ; </li><li>  View panoramas by dragging the mouse button; </li><li>  Active elements designed to pay attention and communicate information; </li><li>  Ability to view multiple panoramas on one page. </li></ul><br>  To understand how to implement this, I propose to present the following: ‚ÄúWe are in the center of a sphere, on the inner surface of which a panorama texture is applied.  We are a camera that can turn and look up or down.  There are elements on the inner surface of the sphere ("at" the surface, as it turned out), and when we hover over them, a window appears with information. " <br><br><h4>  Sphere </h4><br>  There are at least two options for the implementation of the panorama: cubic and spherical.  I chose spherical, since the placement of visually identical active elements implies an equidistant distance from the center.  For the prototype, take an existing <a href="http://threejs.org/examples/webgl_panorama_equirectangular.html">sample of the panorama</a> from the site of the library developer.  He completely suits us with one exception.  This is a sphere with a texture turned inside out.  It is hard to imagine how it might look. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs">mesh.scale.x = <span class="hljs-number"><span class="hljs-number">-1</span></span>;</code> </pre> <br><br>  Unfortunately, this one detail puts a complete cross over the possibility of adding elements.  The bottom line is that to get at least some information about an object in space using a pointer, you have to ‚Äúshoot‚Äù the ray (Raycaster) from the pointer point in the direction of the vector, only in this case the ray will not hit the wall of the sphere, because the camera ( start) is not inside.  This is done because the texture is stretched only from the outside, but now it is possible to fix this simply by adding the <b>side</b> property to the object of the sphere's matter: <br><br><pre> <code class="javascript hljs">mesh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.SphereGeometry( <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> ), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshBasicMaterial( { <span class="hljs-attr"><span class="hljs-attr">map</span></span>: THREE.ImageUtils.loadTexture( <span class="hljs-string"><span class="hljs-string">'textures/2294472375_24a3b8ef46_o.jpg'</span></span> ) side: THREE.BackSide } ) );</code> </pre><br><br>  By the way, this is a typical object creation in the world of THREE.js.  As a rule, the geometry of the object is created, the material (texture), and then added to the scene. <br><br><h4>  Items </h4><br>  Now we need to think about what those active elements will be of themselves.  Ideally, they should be flat sprites, always displayed facing the camera.  Yes Yes exactly :) <br><br><img src="https://habrastorage.org/storage2/aba/cb6/3bf/abacb63bf9ed59fa43dd53cdf441512a.jpg" alt="image"><br><br>  But here we are in for a surprise.  In THREE.js, there are two ‚Äúclasses‚Äù for rendering: <i>WebGLRenderer</i> and <i>CanvasRenderer</i> .  And two types of simple objects: <i>Particle</i> (particle) and <i>Sprite</i> .  WebGL works with Sprite, and Canvas with Particle.  In this case, we need WebGL, and the Sprite object does not have volume in space.  That is, it is <b>impossible</b> to get on it with the mouse. <br>  Well, let's take and simulate these same sprites using a 3D object with a plane geometry (PlaneGeometry): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itemGeometry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.PlaneGeometry(<span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>), pointMapHovered = THREE.ImageUtils.loadTexture( <span class="hljs-string"><span class="hljs-string">"img/information-hover.PNG"</span></span> ), pointMap = THREE.ImageUtils.loadTexture( <span class="hljs-string"><span class="hljs-string">"img/information-unhover.PNG"</span></span> ); point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh( itemGeometry, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshBasicMaterial({ <span class="hljs-attr"><span class="hljs-attr">map</span></span>: pointMap, <span class="hljs-attr"><span class="hljs-attr">transparent</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">// ,  ,  -    }) );</span></span></code> </pre><br><br>  I want to draw your attention to why this is the case: the geometry of the point and the texture are cached, and the material will be created anew each time.  The fact is that when you hover the mouse over a point, we will replace the texture with a brighter one, for example, but if MeshBasicMaterial is cached and is common to everyone, everyone will light up.  As for mouse hovering, everything is simple - take it <a href="http://threejs.org/examples/webgl_interactive_cubes.html">from here</a> . <br>  The last important part that caused difficulties is the recalculation of the coordinates of the panorama area on the page to the coordinates of the WebGL space for precise selection of points.  Visually, the elements are visible, but their coordinates on the page do not coincide with the coordinates of the 3D space.  There is an <a href="http://stackoverflow.com/questions/11586527/converting-world-coordinates-to-screen-coordinates-in-three-js-using-projection">answer to</a> StackOverFlow. <br><br><h4>  Data </h4><br>  Since it is supposed to be able to view many panoramas on one page, it is better to put all the data in JSON.  Like that: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"points"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"coords"</span></span>: { <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">302.0282521739266</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">-32.30522607035554</span></span>, <span class="hljs-string"><span class="hljs-string">"z"</span></span>: <span class="hljs-number"><span class="hljs-number">389.86440214968525</span></span> }, <span class="hljs-string"><span class="hljs-string">"header"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"."</span></span> }, ], <span class="hljs-string"><span class="hljs-string">"texture"</span></span>: <span class="hljs-string"><span class="hljs-string">"panorama.jpg"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> }</code> </pre><br><br>  To view different panoramas, we will replace the texture of the sphere, delete points and build new ones according to the coordinates. <br><br><h4>  What happened </h4><br>  I invite you to see <div class="spoiler">  <b class="spoiler_title">Demo</b> <div class="spoiler_text">  I apologize in advance for the materials used.  Description of the bakery plant # 7, as well as its name was invented from the head, any coincidences are random and have no connection with reality.  <a href="http://gowrite.ru/">link</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/184488/">https://habr.com/ru/post/184488/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184476/index.html">Product Management: See the product through the user's eyes</a></li>
<li><a href="../184478/index.html">Microsoft is preparing to reorganize</a></li>
<li><a href="../184482/index.html">Creating custom primitives in CAD on the MultiCAD .NET API</a></li>
<li><a href="../184484/index.html">Extending Symfony 2 Forms</a></li>
<li><a href="../184486/index.html">Implementing a useful thread-based log</a></li>
<li><a href="../184490/index.html">IBM Simon is the world's first smartphone. What's inside?</a></li>
<li><a href="../184492/index.html">Overview of the smartphone OPPO Find 5: "non-pop" flagship</a></li>
<li><a href="../184494/index.html">Escene US102 IP Phone Review</a></li>
<li><a href="../184496/index.html">Microsoft patents gestures to control the smartphone in the car</a></li>
<li><a href="../184498/index.html">Embedded language for .NET, or as I argued Eric Lippert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>