<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We investigate protection and restore arcades Namco System ES1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  This story began almost immediately after writing an article about the study of the arcade of a well-known Korean company : in the arcad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We investigate protection and restore arcades Namco System ES1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bb4/ee1/faf/bb4ee1faf899b91090afe6bcca013d31.jpg" alt="Tank!  Tank!  Tank!  Arcade"><h3>  Introduction </h3>  This story began almost immediately after writing an article <a href="https://habrahabr.ru/post/179067/">about the study of the arcade of a well-known Korean company</a> : in the arcade machine Tank!  Tank!  Tank!  from Namco the hard drive failed (which is not surprising, since the manufacturer installed the Seagate 7200.12 not differing in reliability), the disk was taken from the working arcade and copied through WinHex, after which the game stopped running.  Assuming that the integrity of the disk was compromised by carelessly pressing a key in the data editing window on the disk in WinHex, another disk was taken from another working machine, copied in the same way, which also stopped running.  It was then that it became clear that the copy protection was somehow built into the disk. <br><img src="https://habrastorage.org/getpro/habr/post_images/82c/7f6/f79/82c7f6f797b28a8bbc68055996ff6f8d.png" alt="Arcade linux error"><a name="habracut"></a><br><br><h3>  Namco System ES1 </h3>  Arcade Tank!  Tank!  Tank !, released in 2009, works on the System ES1 platform, which is an ordinary computer of those years on the Intel Q35 chipset: <br><ul><li>  Motherboard: Supermicro C2SBM-Q (Intel Q35 + ICH9DO) </li><li>  CPU: Intel Core2 Duo CPU E8400 @ 3.00GHz </li><li>  RAM: 2x512 MB DDR2 800 MHz 1.8V </li><li>  Video: NVIDIA GeForce 9600 GT with 512 MB of GDDR3 Memory </li><li>  HDD: Seagate Barracuda 7200.12 160 GB (ST3160318AS) or Hitachi Deskstar 7K1000.C 160 GB (HDS721016CLA382) </li><li>  Operating system: Arcade Linux (based on Debian 4.0) </li></ul><br>  All this is packaged to a massive case with a screwed-on 110V power supply. <br><img src="https://habrastorage.org/getpro/habr/post_images/ff8/121/22c/ff812122c642d5878397219488a08c0d.jpg" alt="Dead Heat Arcade PC"><br>  <sub><i>Photo System ES1, which comes with the game Dead Heat.</i></sub>  <sub><i>Installed horizontally, unlike the ES1 version in Tank!</i></sub>  <sub><i>Tank!</i></sub>  <sub><i>Tank !.</i></sub> <br><br>  On the ES1 platform, a total of 9 games were released, 4 of which are designed exclusively for the domestic market.  The last game was released in 2014, so we can assume that there will be no new games on this platform.  On the territory of Russia and Ukraine, I met only 4 ES1-games: Tank!  Tank!  Tank !, Dead Heat, Dead Heat Riders and Nirin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Trusted boot and TPM </h3>  The peculiarity of this platform is that it uses the so-called trusted boot (Trusted Boot) with a static trust root (Static Root of Trust) using the Trusted Platform Module (TPM) version 1.2 cryptochip built into the motherboard.  TPM is a great thing - something like a smart card that carries an RSA key, wired by the manufacturer at the production stage, with the ability to generate their keys, the private part of which will never leave TPM, load existing keys, with a small non-volatile storage arbitrary data (NVRAM) on board, random number generator and a whole bunch more.  But the most interesting thing that provides TPM - Platform Configuration Registers (PCR), which can be expanded with SHA-1-sum of some arbitrary data.  It is very important to note that these registers can neither be reset nor set to the desired value, but only supplemented with the new SHA-1-sum, from which the TPM itself will take the new SHA-1-sum from the concatenation of the old and the new values.  Simply put, TPM executes the following command if you are sending to PCR NEW_HASH: <br><pre><code class="hljs matlab">PCR[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] = SHA1(PCR[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] + NEW_HASH)</code> </pre>  The motherboard's BIOS / UEFI, if it supports the Trusted Computing Group (TCG) specifications, measures (that is, sends to the TPM hashes) everything that is involved in the boot since the computer was turned on: BIOS / UEFI Boot Block, BIOS / UEFI itself, UEFI, SMBIOS services, ACPI tables, Option ROM devices (for example, network cards), MBR or EFI boot loader, disk partitions, and a whole lot more. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af2/b99/8fc/af2b998fc59dab3a1285297b4a074ab4.png" alt="PCR Measurements"><br>  <sub>(from <a href="https://cansecwest.com/slides/2013/Evil%2520Maid%2520Just%2520Got%2520Angrier.pdf">Evil Maid Just Got Angrier</a> )</sub> <br><br>  BIOS / UEFI cannot measure anything that is done after booting the MBR or the UEFI boot loader, so in the case of Linux, the boot kernel and the initrd remain unaccounted for in the PCR.  To make measurements after the MBR, there are TPM-capable boot loaders and trusted downloads with a static trust root: TrustedGRUB, TrustedGRUB2, GRUB-IMA.  The latter is used in System ES1.  These bootloaders send hashes to TPM themselves (stage1 and stage2 in the case of GRUB), their settings and loadable modules (kernel, kernel command line and initrd, in the case of Linux). <br><br>  The TPM can encrypt arbitrary data with an RSA key linked to PCR values, and it can only be decrypted if the PCR values ‚Äã‚Äãmatch.  If we encrypt the data in this way, then if the BIOS / UEFI is modified, the boot loader, the GRUB modules, the kernel, the initrd, or just the kernel command line, the data is not decrypted due to a register mismatch. <br><br>  Of the popular software TPM is used, as far as I know, only in Microsoft BitLocker.  TPM can be used as a certificate store for all sorts of bank clients, VPN and SSH access, and it‚Äôs a shame that so few people use it, given its cost (‚âà $ 10, cheaper than typical smart cards), capabilities and the fact that it is already installed in many notebook models, and in the latest processors from Intel, is generally implemented at the software level and is accessible to everyone. <br><br><h3>  ES1 Protection </h3>  Namco System ES1 has three levels of copy protection. <br>  The first is the <b>principle of trusted download</b> : the files and resources of the game are encrypted using the key in the TPM and tied to the PCR values.  The manufacturer, before sending the machine to the customer, starts the process of encrypting the data on the machine, and after that the game disc will be launched only on the arcade where it was originally launched.  For encryption, AES-256 is used in CBC mode using the extremely simple and now deceased loop-AES kernel module to encrypt arbitrary data on block devices.  There is also an encrypted LUKS partition on the disk in which a copy of the game data is stored along with updates, saves and other data. <br><img src="https://habrastorage.org/getpro/habr/post_images/db2/edd/0c0/db2edd0c0171cf38a87a0eec59a83a38.png" alt="Arcade linux boot"><br><br>  The second degree of protection is <b>HDD protection</b> . <br><img src="https://habrastorage.org/getpro/habr/post_images/748/ec0/03f/748ec003f262fc66bbb5312ce8097816.jpg" alt="Seagate hdd"><br>  Why the game does not start after copying the disk?  Perhaps, the manufacturer wrote its firmware for the disk controller, which erases data when accessing some sector, which occurs during the sector copying of the disk, but never occurs during normal use of the disk by the game and the OS?  Knowing Namco, they could take such a step, because they have the means, the experts, and the time to create devices based on the PlayStation 2 ( <a href="http://www.system16.com/hardware.php%3Fid%3D543">System 246</a> ) and 3 ( <a href="http://www.system16.com/hardware.php%3Fid%3D900">System 357</a> ). <br>  But no, everything is simple and ingenious in an evil way: in the MBR disk in the Disk Signature field there are zeros.  As soon as you connect this disk to a computer running Windows, it detects zeros, it does not like it, because Windows uses Disk Signature as a unique disk identifier, generates a random one and quietly writes it to disk.  The motherboard of the device, while loading the game, reads the MBR and sends it to the TPM hash.  When it comes to decrypting the data, the TPM PCR does not match, the data cannot be decrypted and the game does not start.  This was done intentionally - all Linux partition management utilities generate random Disk Signature, not zeros. <br><pre> <code class="hljs 1c">$ cmp -l mbr_working mbr_broken <span class="hljs-string"><span class="hljs-string">| gawk '{printf "</span></span>%<span class="hljs-number"><span class="hljs-number">08</span></span>X %<span class="hljs-number"><span class="hljs-number">02</span></span>X %<span class="hljs-number"><span class="hljs-number">02</span></span>X\n<span class="hljs-string"><span class="hljs-string">", $1-1, strtonum(0$2), strtonum(0$3)}' 000001B8 00 4B 000001B9 00 4D 000001BA 00 17 000001BB 00 CC</span></span></code> </pre> <br>  In addition to the TPM, which is used only to decrypt data using the OS, the games themselves use the <b>USB dongle HASP HL ‚Äã‚ÄãMax</b> .  More precisely, it is not used, but only its presence is checked, and this check costs literally one patch, or is completely disabled in the configuration file.  It is foolish, wasteful, and generally incomprehensible why it is needed. <br><br>  From noteworthy: BIOS and GRUB password, which can be obtained by brute force - <b>016ystn</b> or <b>arcade</b> , depending on the game. <br><br><h3>  Attack options </h3>  So, we have: <br><ul><li>  Disk image that no longer starts </li><li>  2 operational machines </li><li>  2 disabled machines </li></ul><br>  Our task is to restore inoperable machines, which drives failed.  To do this, we need to get the encrypted game data in an unencrypted form from efficient devices, for which we need to somehow get the encryption key first. <br><br><ul><li><h5>  Exploit through usb device </h5></li></ul>  The kernel version 2.6.25 used in the machine contains at least two vulnerable USB device drivers.  In the first of these, the <a href="https://labs.mwrinfosecurity.com/system/assets/173/original/mwri_linux-usb-buffer-overflow_2009-10-29.pdf">Voers</a> PBX Auerswald driver, you can <a href="https://labs.mwrinfosecurity.com/system/assets/173/original/mwri_linux-usb-buffer-overflow_2009-10-29.pdf">exploit a buffer overflow</a> in the device name.  Unfortunately, the buffer overflow is not on the stack, and we can overflow it by only 27 bytes, which is why, most likely, the vulnerability cannot be applied without interacting with the userspace, which does not suit us, because  we do not have access to the terminal or any other ability to execute the code.  But <a href="">everything fell</a> . <br>  The second option is the <a href="https://labs.mwrinfosecurity.com/system/assets/153/original/mwri_caiaq-usb-drivers-buffer-overflow_2011-03-07.pdf">Caiaq sound and MIDI device driver</a> , which, unfortunately, also failed to work for me. <br><br><ul><li><h5>  Cold boot attack </h5></li></ul>  The attack is to dump the memory and search for encryption keys in it.  It can be done in two ways: by running a small dumper program from a USB flash drive (for example, <a href="http://mcgrewsecurity.com/oldsite/projects/msramdmp.1.html">msramdmp</a> ) or HDD immediately after a reboot, or by freezing and removing the memory while preserving its contents on another computer using the same dumper.  The first method will not work because the motherboard complies with the Trusted Computing Group specification, which instructs to perform memory cleaning at boot time, and the dumper will save the already cleared memory, in which, of course, there will be no keys anymore. <br><br><ul><li><h5>  DMA attack </h5></li></ul>  Direct Memory Access attack is based on the execution of requests to the memory management unit via a bus, device or standard that allows such access.  There are commercial cards specifically designed for DMA attacks, there are also boards with a USB 3.0 USB3380 controller ( <a href="https://github.com/NSAPlayset/SLOTSCREAMER">SLOTSCREAMER</a> ), which, by chance, can generate and send PCI packets to the bus, with some limitations, but for DMA requests enough.  The easiest and most affordable way is the Firewire (IEEE 1394) standard, which, however, requires support from the OS.  Fortunately, in our machine, the developers did not block the Firewire SBP2 driver, which allows direct memory access, which means that it is enough to insert the Firewire card into a free PCI or PCI-e slot, connect it to the card in your computer and save RAM using, for example, <a href="https://github.com/carmaa/inception">Inception</a> .  We will use it! <br><br><h3>  Data decryption </h3>  The memory data is still half the battle; you need to find the AES key in them and decrypt the game file.  For the first task, smart people from Princeton University wrote the <a href="https://citp.princeton.edu/research/memory/code/">aeskeyfind</a> utility, which goes through the entire image byte-by-byte, taking random in-memory data for an AES key, and trying to find temporary keys from it that are used in AES rounds ( called key schedule, key schedule).  If we found something similar in memory - great, we have a candidate for the correct encryption key! <br><pre> <code class="hljs go">$ aeskeyfind memdump_0x0<span class="hljs-number"><span class="hljs-number">-0x100000000</span></span>_20160524<span class="hljs-number"><span class="hljs-number">-172534.</span></span>bin f322ee68145f5f32dea7252b2de00ff30003bb2775b7164f7211ba56fbe2012a <span class="hljs-number"><span class="hljs-number">7523d</span></span>fd705d26ce4f34ee872ec88f7ede80ac8ea0f104d3aba4a5d38bfa5849f <span class="hljs-number"><span class="hljs-number">103687f</span></span>ef032a17e830b6709c29bd805</code> </pre>  <i><sub>There were two 256-bit keys and one 128-bit</sub></i> <br><br>  To decrypt files encrypted with loop-AES, I wrote a simple Python script, since  Existing utilities do not know how to work with the key that we found in the RAM (master key), but accept the ‚Äúpassword‚Äù as input, from which the master key is obtained using the key generation function.  We do not have a ‚Äúpassword‚Äù, and it turned out to be easier to write our own than to modify someone else‚Äôs. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs lua">#!/usr/bin/env python3 import sys import struct from Crypto.Cipher import AES <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Namco encrypted game file (.apps, LOOP-AES) decryptor."</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">"USAGE: ENCRYPTED_FILE KEY_FILE OUTPUT_FILE"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"KEY_FILE should be in binary format."</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Use echo KEY_HERE | xxd -r -p"</span></span>) sys.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) aesfile = <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) key = <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>).<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(sys.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>], <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) iv = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> True: enc_data = aesfile.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">512</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> enc_data: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> cipher = AES.new(key=key, mode=AES.MODE_CBC, IV=struct.pack(<span class="hljs-string"><span class="hljs-string">'LL'</span></span>, iv, <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(cipher.decrypt(enc_data)) iv += <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </div></div><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>echo f322ee68145f5f32dea7252b2de00ff30003bb2775b7164f7211ba56fbe2012a | xxd -r -p &gt; key <span class="hljs-string"><span class="hljs-string">$ </span></span>./decrypt.py v352us.apps key v352us.app <span class="hljs-string"><span class="hljs-string">$ </span></span>file v352us.app v352us.app: <span class="hljs-type"><span class="hljs-type">Squashfs</span></span> filesystem, little endian, version <span class="hljs-number"><span class="hljs-number">3.1</span></span>, <span class="hljs-number"><span class="hljs-number">655177264</span></span> bytes, <span class="hljs-number"><span class="hljs-number">6062</span></span> inodes, blocksize: <span class="hljs-number"><span class="hljs-number">131072</span></span> bytes, created: <span class="hljs-type"><span class="hljs-type">Sat</span></span> <span class="hljs-type"><span class="hljs-type">Nov</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2009</span></span></code> </pre>  <i><sub>The first key came up, great!</sub></i> <br><br>  We have everything to make the disk as it was before the device was first turned on at the factory, which means that we can restore any Namco System ES1 machine in the same way as the manufacturer would do! <br>  From the first section, from the arcade directory, delete the encrypted * .apps file and the <code>sealkey</code> encryption <code>sealkey</code> , copy the file with the decrypted * .app data and create an empty <code>RECOVERY</code> file <code>RECOVERY</code> that the scripts will re-encrypt it on startup.  You should have something like this: <br><pre> <code class="hljs pgsql">p1/arcade % ls -lah total <span class="hljs-number"><span class="hljs-number">626</span></span>M drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> root root <span class="hljs-number"><span class="hljs-number">4.0</span></span>K Jun <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> . drwxr-xr-x <span class="hljs-number"><span class="hljs-number">7</span></span> root root <span class="hljs-number"><span class="hljs-number">4.0</span></span>K Nov <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">2009</span></span> .. -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 root root 396 Nov 28 2009 config -rw-r--r-- 1 root root 75 Nov 28 2009 partab -rw-r--r-- 1 root root 0 Jun 27 19:02 RECOVERY -rw-r--r-- 1 root root 625M Nov 28 2009 v352us.app</span></span></code> </pre> <br>  Pay attention to the second section, this is the update section of the game.  If it has a * .pkg file, then you need to delete the <code>INITIALIZED</code> file in order for the game to update itself, otherwise you will get an outdated version. <br><br>  We connect the disk in System ES1, turn on the machine and watch how the game encrypts itself and copies files to the LUKS partition!  Hooray! <br><img src="https://habrastorage.org/getpro/habr/post_images/c96/cb7/f94/c96cb7f94d2e2120edf24ac0ed8b5cde.jpg" alt="Namco System ES1 initialization"><br><br>  Real story: <br><blockquote>  It was a very sad story, in about 2010, when Nirin got enough sleep, and the technician took off from another device to make a copy on Windows using Acronis.  Make a copy, reports that everything is OK.  But the disk from which they tried to make a copy, then, when connected back, shows a blue screen of death and a sign that you have problems with the disk.  The stubborn guy did not stop at this and climbed into the third unit.  History repeated.  But nothing scares our man - he called his colleague in another city and asked him to send a CD with Nirin by mail.  All 4 systems officers left for London (Namco European representative office), and all at the expense of the guy who thought that stubbornness would win!  Almost 8,000 euros for everything cost (repair and round-trip logistics). </blockquote>  What to do if you are so stubborn, and you have no working devices left?  No problem!  It is enough to return zeros in the disk identifier field in the MBR, i.e.  write 4 bytes of zeros at offset 0x1B8.  In Linux, this is done with one command: <br><pre> <code class="hljs swift"># sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/dev/sdX bs=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>=<span class="hljs-number"><span class="hljs-number">4</span></span> seek=<span class="hljs-number"><span class="hljs-number">440</span></span></code> </pre>  And in Windows you can use, for example, WinHex. <br>  After this, the game should start, and you can do all the above described manipulations in order to get the decrypted files and restore the rest of the devices. <br><br>  <b>06.25.2018 UPD</b> : Apparently, Nirin was the first game on System ES1, and Namco did not know how to correctly implement protection using TPM.  The game does not use encryption by means of TPM, but obtains the key by hashing the state of the values ‚Äã‚Äãof Trusted Boot PCR. <br>  You can get the encryption key without a DMA attack by modifying the <code>filesystem.squashfs</code> file to save the state <code>/sys/kernel/security/tpm0/binary_bios_measurements</code> and <code>/sys/class/tpm/tpm0/pcrs</code> and reconstructing the original TPM PCR values. <br>  Script to reconstruct PCR values: <a href="https://github.com/ValdikSS/binary_bios_measurements_parser">github.com/ValdikSS/binary_bios_measurements_parser</a> <br><br><h3>  Conclusion </h3>  The architecture and quality of the scripts and utilities of Arcade Linux left a very positive impression on Namco programmers, and the trick with Disk Signature in the MBR is generally aerobatics.  Of course, for greater protection, IOMMU should have been enabled, so that DMA attacks were (almost) impossible, and the encryption keys should be stored in the processor‚Äôs debug registers, and not in RAM, but I still consider the Namco System ES1 protection to be at least interesting, it was not boring to explore and crack. <br>  Images and decrypted game files are available for download on the co-pig tracker. <br><br>  I can help you if you need to restore arcade software, and if you are a developer of arcade games under Linux (but not pissing gambling / gambling machines!), I will be glad to make you reliable protection that only very smart people can crack. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/cbb/884/91f/cbb88491f50b5fece95c73a31c617a5c.jpg" alt="Pedal"></div></div></div><p>Source: <a href="https://habr.com/ru/post/304014/">https://habr.com/ru/post/304014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303994/index.html">Why is it sometimes better to buy a ready-made software product than to develop your</a></li>
<li><a href="../303998/index.html">Create your tags in RSpec tests</a></li>
<li><a href="../304000/index.html">Vidom - blazingly fast alternative to React</a></li>
<li><a href="../304004/index.html">‚ÄúWhy did I quit algorithmic trading for web startups?‚Äù: The story of a US developer</a></li>
<li><a href="../304008/index.html">Installing Firebird on D-Link DNS-325</a></li>
<li><a href="../304016/index.html">Business processes: the good, the bad and the ugly</a></li>
<li><a href="../304020/index.html">Why did not Pied Piper take off: our analysis of the 9th series of the 3rd season of the series ‚ÄúSilicon Valley‚Äù</a></li>
<li><a href="../304024/index.html">"Cut the Gordian knot" or overcoming the problems of encrypting information in Windows</a></li>
<li><a href="../304026/index.html">JSON and PostgreSQL 9.5: with even more powerful tools</a></li>
<li><a href="../304028/index.html">In St. Petersburg to be: reports of the "confrontation" NeoQUEST-2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>