<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unity3D Speed ‚Äã‚Äãup drawing 2D animations at times? Easy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to talk about how monster painting was accelerated when creating the game Alien Massacre. This solution is suitable for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unity3D Speed ‚Äã‚Äãup drawing 2D animations at times? Easy</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to talk about how monster painting was accelerated when creating the game Alien Massacre.  This solution is suitable for any projects that use sprite animation. <br><br>  As a result of the development of a mobile game, it turned out that playing a large number of animated objects on the stage was a bottleneck.  As a result, the following requirements emerged: <br><br><ul><li>  1 It is necessary to ensure drawing of a large number of animated objects on the stage.  After all, we want the player to shoot from the hordes of monsters. </li><li>  2 Animation progress must be different for each of the objects.  After all, we do not want mobs go build. </li></ul><br><h1>  Out of the box solution </h1><br>  Of course, the first solution was simple: do everything with the help of the Animator component already built into UnityEngine.  Let's see what comes out of it. <br><a name="habracut"></a><br>  As an atlas with the original animation, we will use a malicious monster with 24 frames of sprite animation 64x64 pixels each: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/48f/c0a/2af/48fc0a2afae0404ca9f64f43c1ece392.png"><br><br>  In Unity3D we set the type of texture to sprite and in SpriteEditor we cut it into 24 pieces.  Make an animation for it and throw it all on an empty object.  Now is the time to recall the fact that we had a condition about different animation progress for various objects.  No problem!  A minute of work and the script is ready. <br><br><div class="spoiler">  <b class="spoiler_title">AnimationOffset.cs</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Kalita</span></span> { [RequireComponent(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Animator))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AnimationOffset</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Offset; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsRandomOffset; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> animator = GetComponent&lt;Animator&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runtimeController = animator.runtimeAnimatorController; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clip = runtimeController.animationClips[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsRandomOffset) Offset = Random.Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (clip.length*clip.frameRate)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> time = (Offset*clip.length/clip.frameRate); animator.Update(time); } } }</code> </pre> <br></div></div><br>  Now we collect all this in a heap and we receive the decision which Unity3D gives "from a box". <br><br><img src="https://habrastorage.org/files/3a1/3d7/7fa/3a13d77fa16747d5b7cb728d123d00d7.jpg"><br><br>  Looking ahead, I would say that the out-of-the-box solution has quite a good performance and high flexibility.  Everyone who works in Unity3D has long been accustomed to customize animators.  But what if your application requires more performance? <br><br><h1>  Do-it-yourself solution </h1><br>  Let's start with a general concept: <br><br><ul><li>  Make a calculation of the progress of the animation in the vertex shader </li><li>  We will encode information about the initial frame of the animation (‚Äúlocal progress‚Äù) in the alpha channel of the vertex color (in order not to lose the batching) </li><li>  Create a component that simplifies animation setup in the Unity Editor. </li><li>  Create a component that will calculate the "global" progress of the animation. </li></ul><br>  Let's start with the render shader. <br><br><div class="spoiler">  <b class="spoiler_title">KalitaAtlasDrawer.shader</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">Shader "Kalita/KalitaAtlasDrawer" { Properties { _MainTex ("Texture Atlas (RGBA)", <span class="hljs-number"><span class="hljs-number">2</span></span>D) = "" {} _Frame("Frame", <span class="hljs-type"><span class="hljs-type">float</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> _TotalFrames("Total Frames Count in Sequence", <span class="hljs-type"><span class="hljs-type">float</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span> } SubShader { Tags { "Queue"="Transparent" } Blend SrcAlpha OneMinusSrcAlpha Cull <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> pass { CGPROGRAM #pragma vertex vert #pragma fragment frag sampler2D _MainTex; <span class="hljs-type"><span class="hljs-type">float4</span></span> _MainTex_ST; <span class="hljs-type"><span class="hljs-type">float</span></span> _Frame; <span class="hljs-type"><span class="hljs-type">float</span></span> _TotalFrames; struct appData { <span class="hljs-type"><span class="hljs-type">float4</span></span> vertex : POSITION; fixed4 color : COLOR; float2 uv : TEXCOORD0; }; struct v2f { <span class="hljs-type"><span class="hljs-type">float4</span></span> pos : SV_POSITION; float2 uv : TEXCOORD0; }; v2f vert (appData v) { v2f o; o.pos = mul (UNITY_MATRIX_MVP, v.vertex); <span class="hljs-type"><span class="hljs-type">float</span></span> frame = (_Frame + v.color.a*<span class="hljs-number"><span class="hljs-number">255</span></span>) % (_TotalFrames + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = frame / _TotalFrames; o.uv = v.uv; o.uv.x += <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> o; } fixed4 frag (v2f i) : COLOR { fixed4 color = tex2D (_MainTex, i.uv); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> color; } ENDCG } } FallBack "Diffuse" }</code> </pre><br></div></div><br>  Next, we turn to the component that allows you to easily customize the animation settings from the Unity Editor. <br><br><div class="spoiler">  <b class="spoiler_title">KalitaAnimation.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Kalita</span></span> { [ExecuteInEditMode] [RequireComponent(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (MeshFilter))] [RequireComponent(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (MeshRenderer))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">KalitaAnimation</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Material RendererMaterial { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> meshRenderer.sharedMaterial; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 InGameSize = Vector2.one; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Anchor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2(<span class="hljs-number"><span class="hljs-number">.5</span></span>f, <span class="hljs-number"><span class="hljs-number">.5</span></span>f); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FramesCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsRandomStartAnimation; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> StartFrame; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MeshFilter filter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MeshRenderer meshRenderer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { filter = GetComponent&lt;MeshFilter&gt;(); meshRenderer = GetComponent&lt;MeshRenderer&gt;(); BuildMesh(); SetAnimationOffset(); } <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_EDITOR &amp;&amp; !TEST_RUNNING private void Update() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Application.isPlaying) return; BuildMesh(); SetAnimationOffset(); var mat = meshRenderer.sharedMaterial; mat.mainTextureScale = new Vector2(1f / FramesCount, 1); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> private void BuildMesh() { var anchor = Anchor; anchor.Scale(InGameSize); anchor /= 2; var mesh = BuildQuad(InGameSize, anchor, new Vector2(1f / FramesCount, 1f)); filter.mesh = mesh; } private void SetAnimationOffset() { var mesh = filter.sharedMesh; mesh.name = "Plane"; var cnt = mesh.vertexCount; var clrs = mesh.colors32; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (clrs.Length != cnt) clrs = new Color32[cnt]; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (IsRandomStartAnimation &amp;&amp; Application.isPlaying) StartFrame = (byte)Random.Range(0, 255); for (int i = 0; i &lt; cnt; i++) clrs[i].a = StartFrame; mesh.colors32 = clrs; } public static Mesh BuildQuad(Vector2 size, Vector2 anchor, Vector2 uvStep) { var dx = size.x / 2; var dy = size.y / 2; var vertices = new[] { new Vector3(-dx + anchor.x, -dy + anchor.y, 0), new Vector3(dx + anchor.x, -dy + anchor.y, 0), new Vector3(dx + anchor.x, dy + anchor.y, 0), new Vector3(-dx + anchor.x, dy + anchor.y, 0), }; var uvs0 = new[] { uvStep, new Vector2(0, uvStep.y), new Vector2(0, 0), new Vector2(uvStep.x, 0), }; var indices = new[] { 0, 1, 2, 0, 2, 3 }; var mesh = new Mesh { vertices = vertices, uv = uvs0, triangles = indices }; mesh.Optimize(); return mesh; } } }</span></span></code> </pre><br></div></div><br>  This script works in the Unity3D editor and allows you to immediately see the change of any parameters on the stage, which makes the setup easy and convenient.  Do not forget to create material with the above written shader and assign it to MeshRenderer.  In the Unity3D editor, all this should look like this: <br><br><img src="https://habrastorage.org/files/6a8/e50/cc0/6a8e50cc08b2430993c7806c1de03650.jpg"><br><br>  Well, now the simplest thing is to write a global frame counter.  Here he is: <br><br><div class="spoiler">  <b class="spoiler_title">KalitaAtlasAC.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Kalita</span></span> { [ExecuteInEditMode] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">KalitaAtlasAC</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KalitaAnimation Animation; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> FrameRate = <span class="hljs-number"><span class="hljs-number">24</span></span>; [HideInInspector] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentGlobalFrame; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lastGlobalFrameUpdateTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Animation == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Animation = GetComponentInChildren&lt;KalitaAnimation&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FrameRate &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = Time.time; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextUpdateTime = lastGlobalFrameUpdateTime + <span class="hljs-number"><span class="hljs-number">1f</span></span>/FrameRate; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t &lt; nextUpdateTime) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = t - lastGlobalFrameUpdateTime; lastGlobalFrameUpdateTime = t; <span class="hljs-comment"><span class="hljs-comment">//If we run too slow, we shoud add several frames per update CurrentGlobalFrame += (int) (dt*FrameRate); CurrentGlobalFrame %= Animation.FramesCount; Animation.RendererMaterial.SetFloat("_Frame", CurrentGlobalFrame); } } }</span></span></code> </pre><br></div></div><br>  For correct operation, one KalitaAtlasAC component controls the many KalitaAnimation components.  Since the parameters are set via sharedMaterial, any of the many controlled objects is delayed in the corresponding field (animation) of KalitaAtlasAC. <br><br><h1>  Testing </h1><br>  Well, it's time for testing.  For the test we make a small script that allows you to create the desired number of objects on the scene. <br><br><div class="spoiler">  <b class="spoiler_title">HabrSpawner.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Kalita</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrSpawner</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;GameObject&gt; Objects = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;GameObject&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MobsToSpawn; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mobOnScene; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 SpawnZone = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Screen.sleepTimeout = SleepTimeout.NeverSleep; SpawnMany(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spawnMany) { spawnMany = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; SpawnMany(); } } [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> spawnMany; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SpawnMany</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> layers = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rectBorderSize = Vector2.one*<span class="hljs-number"><span class="hljs-number">2.4f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mobsPerLayer = MobsToSpawn / layers; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zone = SpawnZone; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; layers; j++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; mobsPerLayer; i++) Spawn(zone); zone -= rectBorderSize; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Spawn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 zone</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = Random.Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, Objects.Count); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = Instantiate(Objects[i]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = GetRandomPositionOnRect(zone); Spawn(o, p); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Spawn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameObject o, Vector2 pos</span></span></span><span class="hljs-function">)</span></span> { mobOnScene++; o.SetActive(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); o.transform.position = pos; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> w = <span class="hljs-number"><span class="hljs-number">150</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> h = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rect = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rect(x, y, w, h); <span class="hljs-comment"><span class="hljs-comment">//+One mob is source mob GUI.Label(rect, "MobsOnScene: " + (mobOnScene + 1)); } private Vector2 GetRandomPositionOnRect(Vector2 size) { var spawnRect = size; var resultPos = new Vector2(); switch (Random.Range(0, 4)) { case 0: // Top resultPos.x = Random.Range(0, spawnRect.x) - (spawnRect.x) / 2f; resultPos.y = spawnRect.y / 2; break; case 1: // Right resultPos.x = spawnRect.x / 2; resultPos.y = Random.Range(0, spawnRect.y) - (spawnRect.y) / 2; break; case 2: // Bottom resultPos.x = Random.Range(0, spawnRect.x) - (spawnRect.x) / 2; resultPos.y = -spawnRect.y / 2; break; case 3: // Left resultPos.x = -spawnRect.x / 2; resultPos.y = Random.Range(0, spawnRect.y) - (spawnRect.y) / 2; break; } return resultPos; } } }</span></span></code> </pre><br></div></div><br>  Compare the results.  At first we will start in UnityEditor with the task to draw 20000 objects. <br><br>  When using Unity3D Animator on my Dell M4800 laptop, we get about 5 FPS: <br><br><img src="https://habrastorage.org/files/ced/a47/93a/ceda4793aa304cabbc8f086059aff983.jpg"><br><br>  We start the same task with KalitaAtlasAC + KalitaAnimation and get 20+ FPS: <br><br><img src="https://habrastorage.org/files/2e5/323/c59/2e5323c5965147afa27579cf8ed16800.jpg"><br><br>  What will happen when testing on a real device?  We will reduce the number of created objects to 2000, but we will still work on a mobile device.  The Samsung Galaxy S3 - i9300 turned out to be a handy test subject.  When using Unity3D Animator, we get about 9-10 FPS: <br><br><img src="https://habrastorage.org/files/1e8/125/db8/1e8125db8d0b4de0a47f6662d04b81db.jpg"><br><br>  And when using KalitaAtlasAC + KalitaAnimation, we end up with 35+ FPS: <br><br><img src="https://habrastorage.org/files/a20/c5f/f3e/a20c5ff3eeee464baff1bc85e6c905a7.jpg"><br><br><h1>  Results </h1><br>  If you use a large number of animated objects that use sprite animation, the proposed technique will reduce the cost of drawing up to four times, which can be very critical for mobile applications. <br><br>  By the way, the remaining rgb components of the vertex color can be used as Overlay, as shown in the demo project. <br><br>  The demo project can be downloaded here: <a href="https://bitbucket.org/Philipp0K/kalitaanimator">bitbucket.org/Philipp0K/kalitaanimator</a> </div><p>Source: <a href="https://habr.com/ru/post/302796/">https://habr.com/ru/post/302796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302784/index.html">Freelancer and entrepreneur</a></li>
<li><a href="../302786/index.html">Screwing the Gantt chart</a></li>
<li><a href="../302788/index.html">As a programmer, I bought a car</a></li>
<li><a href="../302792/index.html">Google fixed multiple vulnerabilities in Android</a></li>
<li><a href="../302794/index.html">Gloves for those who complicate things</a></li>
<li><a href="../302798/index.html">How to build a competent testing system? Insights from QA experts: video and presentations from the meeting in Wrike</a></li>
<li><a href="../302800/index.html">1C: Bitrix, protection of arbitrary forms from spam</a></li>
<li><a href="../302802/index.html">How game statistics differ from these playtests</a></li>
<li><a href="../302804/index.html">A minor feature of CHAR and VARCHAR</a></li>
<li><a href="../302806/index.html">Static time analysis demystified. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>