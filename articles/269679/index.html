<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up MikroTik as an OVPN server using client certificates and revocation list</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had a task to configure MikroTik as an OVPN server using client certificates and the possibility of their revocation. I did not find a clear How-To ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up MikroTik as an OVPN server using client certificates and revocation list</h1><div class="post__text post__text-html js-mediator-article">  I had a task to configure MikroTik as an OVPN server using client certificates and the possibility of their revocation.  I did not find a clear How-To on the Internet on this topic, so I decided to invent my own bicycle.  In this article I will describe the configuration scheme of this miracle, which turned out and worked for me. <br><a name="habracut"></a><br><h4>  Using PKI ROS </h4><br>  Regarding PKI, there are two options: <br><br>  1. Using the built-in ROS PKI: <br><br><ul><li>  + we can issue and revoke certificates directly on the microtic, otherwise we will have to manually update crl on it after each review </li><li>  - accidental deletion of the CA certificate used for signing and revoking certificates from the microtic is fatal; There is a current backup of all this) </li><li>  + if we back up the entire config of the microtic, then CA will back up with it </li></ul><br>  2. Using a third-party PKI - openssl, or windows server PKI (DO NOT use trusted StartSSL CAs, they do not issue client certificates to you): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  + protected from the lack of the first option </li><li>  - in the case of openssl, you must manually upload crl to the microtic after each revoked certificate </li><li>  + in the case of windows server PKI, it is theoretically possible to implement authentication through the SCEP mechanism, but has not yet verified </li><li>  - in the case of windows server PKI, a domain is needed, without it, this very PKI will not work </li></ul><br>  I will consider only the first option, because, firstly, it suits me, and secondly, it is more flexible.  Also, I will not dwell on the parameters of certificates and other various parameters of standard ROS tools, since  there is a comprehensive description of them on the official <a href="http://wiki.mikrotik.com/wiki/Main_Page">MikroTik Wiki</a> . <br><br><h4>  We configure the OVPN server on ROS </h4><br><h5>  1. Configure PKI </h5><br>  1.1.  CA Certificate: <br><br> <code>/certificate add name=template-CA country="" state="" locality="" organization="" unit="" common-name="test-CA" key-size=4096 days-valid=3650 key-usage=crl-sign,key-cert-sign <br></code> <br><br> <code>/certificate sign template-CA ca-crl-host=127.0.0.1 name="test-CA" <br></code> <br><br>  Note: ca-crl-host = is a required parameter, otherwise the revocation list will not be created;  The full path to the revocation list will be specified in the certificate parameters, in the column "[1] The Distribution List Distribution Point (CRL)";  in principle, you can specify any of the ip-addresses of our mikrotik, the one that we specify - and will be registered in the certificate.  Domain names are not supported, unfortunately. <br><br>  1.2.  Server Certificate: <br><br> <code>/certificate add name=template-SRV country="" state="" locality="" organization="" unit="" common-name="test-srv-OVPN" key-size=4096 days-valid=1095 key-usage=digital-signature,key-encipherment,tls-server <br></code> <br><br> <code>/certificate sign template-SRV ca="test-CA" name="test-srv-OVPN" <br></code> <br><br>  Note: for the key-usage server certificate, it is better not to change why it is so described <a href="https://www.v13.gr/blog/%3Fp%3D386">here</a> (and if you really want to change it, then it says there that you need to register the client for this in the config file). <br><br>  Note: unlike SSTP, OVPN does not check the common-name of the server certificate against the fqdn of this server. <br><br>  1.3.  Template for client certificates: <br><br> <code>/certificate add name=template-CL country="" state="" locality="" organization="" unit="" common-name="test-client-ovpn-template" key-size=4096 days-valid=365 key-usage=tls-client <br></code> <br><br>  1.3.1 Certificate of the first client: <br><br> <code>/certificate add name=template-CL-to-issue copy-from="template-CL" common-name="test-client-ovpn-1" <br></code> <br><br> <code>/certificate sign template-CL-to-issue ca="test-CA" name="test-client-ovpn-1" <br></code> <br><br>  1.3.2.  Certificate of the second and subsequent clients: <br><br>  See p. 3.1, but changing the value of the parameters. <br><br> <code>common-name="test-client-ovpn-1" <br></code> <br><br>  For the first command, this value must be unique within the same CA. <br><br> <code>name="test-client-ovpn-1"</code> <br> <br>  For the second command, this value must be unique within a single microtic. <br><br>  1.4 In the future, for certificate revocation we use the command: <br><br> <code>certificate issued-revoke %cert-name% <br></code> <br><br>  Where% cert-name% is the name = field of the signed certificate, that is, the PKI display of the microtic. <br><br><h4>  2. Configure the OVPN server </h4><br>  Note: can be configured in tun mode (‚Äúip‚Äù in ROS), or in tap mode (‚Äúethernet‚Äù in ROS).  Tun mode is a normal tunnel.  Tap mode - emulation of high-grade ethernet, in particular, in tap mode, clients can be combined into bridge mode and they will be fine to see each other.  In theory, in tap mode, you can start a DHCP server, but this is not implemented in the current version of ROS. <br><br><h4>  2tun.  Tun mode </h4><br>  2tun.1.  Set the address pool for OVPN clients (can be set directly in the PPP-profile): <br><br> <code>/ip pool add name=OVPN_srv_pool ranges=192.168.100.2-192.168.254 <br></code> <br><br>  2tun.2.  Create a PPP-profile for the OVPN server: <br><br> <code>/ppp profile add name=OVPN_server local-address=192.168.100.1 remote-address=OVPN_srv_pool <br></code> <br><br>  <i>Optional!</i>  The remaining parameters to your taste and in accordance with your goals.  For example: dns = 192.168.100.1 use-ipv6 = no <br><br>  2tun.3.  Configure user authentication mode: <br><br> <code>/ppp aaa set accounting=yes <br></code> <br><br>  2tun.4.  We add users: <br><br> <code>/ppp secret add name=test-user-1 password=P@ssword1 service=ovpn profile=OVPN_server <br></code> <br><br> <code>/ppp secret add name=test-user-2 password=P@ssword2 service=ovpn profile=OVPN_server <br></code> <br><br>  2tun.5.  Enable the OVPN server: <br><br> <code>/interface ovpn-server server set auth=sha1 cipher=blowfish128 default-profile=OVPN_server mode=ip netmask=24 require-client-certificate=yes certificate=test-srv-OVPN enabled=yes <br></code> <br><br><h4>  2tap.  Tap mode </h4><br>  2tap.1.  Set the address pool for OVPN clients (can be set directly in the PPP-profile): <br><br> <code>/ip pool add name=OVPN_srv_pool ranges=192.168.100.2-192.168.254 <br></code> <br><br>  2tap.1 +.  Create a bridge for OVPN connections: <br><br> <code>/interface bridge add name=OVPN_bridge arp=enabled <br></code> <br><br>  Note: It is not necessary to assign an IP for the bridge, it is already in the PPP-profile (besides, if you specify the address for the bridge, but do not specify local-address = in the PPP-profile, the client will not connect). <br><br>  Note: arp must be enabled, otherwise clients will not see each other. <br><br>  2tun.2.  Create a PPP-profile for the OVPN server: <br><br> <code>/ppp profile add name=OVPN_server local-address=192.168.100.1 remote-address=OVPN_srv_pool bridge=OVPN_bridge <br></code> <br><br>  <i>Optional!</i>  The remaining parameters to your taste and in accordance with your goals.  For example: dns = 192.168.100.1 use-ipv6 = no <br><br>  2tap.3.  Configure user authentication mode: <br><br> <code>/ppp aaa set accounting=yes <br></code> <br><br>  2tap.4.  We add users: <br><br> <code>/ppp secret add name=test-user-1 password=P@ssword1 service=ovpn profile=OVPN_server <br></code> <br><br> <code>/ppp secret add name=test-user-2 password=P@ssword2 service=ovpn profile=OVPN_server <br></code> <br><br>  2tap.5.  Enable the OVPN server: <br><br> <code>/interface ovpn-server server set auth=sha1 cipher=blowfish128 default-profile=OVPN_server mode=ethernet netmask=24 require-client-certificate=yes certificate=test-srv-OVPN enabled=yes <br></code> <br><br>  Notes for both modes: <br><br>  1. The presence of the user is mandatory, even despite the authorization by certificates;  You can create one user for all clients and register the same username / password in the client configs, but this makes it impossible to track the connection and actions of a specific user - inconvenient, somewhat insecure. <br><br>  2. I do not consider RADIUS authentication simply because I have not tested it.  I can only assume that it will work only for username / password, and certificates will still be checked on microtic. <br><br>  3. Make sure that the address pool matches the subnet specified in the OVPN server settings.  ROS'ovskiy OVPN-server will not understand whether the local-address = server belongs to the same network and the client address assigned from the pool, moreover, if, for example, you use the mask 29, and the ranges = 192.168.100.0 / 29, Broadcast 192.168.100.7 can be assigned to the client as it was with me.  Exactly the same situation can occur if the specified pool is larger than the mask implies - only the problem will not be revealed immediately, but after a while. <br><br><h4>  3. Export certificates for client configuration </h4><br>  3.1.  Export CA certificate: <br><br> <code>/certificate export-certificate test-CA export-passphrase="" <br></code> <br><br>  Note: We need only the certificate itself, the private key is NOT needed, therefore the export-passphrase = "" parameter must be empty. <br><br>  3.2.  Export customer certificates: <br><br> <code>/certificate export-certificate test-client-ovpn-1 export-passphrase=private-key-password1 <br></code> <br><br> <code>/certificate export-certificate test-client-ovpn-2 export-passphrase=private-key-password2 <br></code> <br><br>  Note: export-passphrase = is a required parameter for exporting private keys;  we use our password for each client;  We DO NOT use the same password, which was indicated in paragraphs 2.4 for users! <br><br>  3.3.  We extract the received files of certificates and keys from the microtic in any convenient way (as a rule, I drag files back and forth directly from the winbox). <br><br><h4>  Setting up a Windows client </h4><br>  1. Get the OVPN distribution with <a href="https://openvpn.net/index.php/open-source/downloads.html">openvpn.net</a> . <br>  2. Set, leave all options by default, including the tap-interface, which is required for any configuration mode. <br>  3. Go to OpenVPN \ config (by default C: \ Program Files \ OpenVPN \ config) and create a client.ovpn file there (or copy from OpenVPN \ sample-config). <br>  4. Create a client configuration, or edit it with sample-config. <br><br><div class="spoiler">  <b class="spoiler_title">Content client.ovpn with small comments</b> <div class="spoiler_text">  # The mode in which the OVPN service works <br> <code>client</code> <br> <br>  # Attention!  We specify only one parameter from two <br>  # For tup mode, specify the parameter <br> <code>dev tun</code> <br>  # For tap mode, specify the parameter <br> <code>dev tap</code> <br> <br>  # This parameter is specified only in the case of using tap mode, and instead of MyTap, we substitute the name of the tap interface in windows (ipconfig / all, or network connections in the control panel) <br> <code>dev-node MyTap</code> <br> <br>  # Used protocol.  ROS'ovskiy OVPN-server works only in tcp mode <br> <code>proto tcp</code> <br> <br>  # Address of the server to which we will connect, and port.  Instead ovpn.my.domain - dns-name or ip-address.  You can specify multiple servers. <br> <code>remote ovpn.my.domain 1194 <br> ;remote my-server-2 1194</code> <br> <br>  # This parameter is needed only when using more than one server;  When specifying this parameter when connecting, the client randomly selects one of the specified servers. <br> <code>;remote-random</code> <br> <br>  # Timeout between attempts to determine the ip-address for the specified DNS server name, in seconds (or infinity - infinite) <br> <code>resolv-retry infinite</code> <br> <br>  # If this parameter is specified, the client will use a dynamic outgoing port to connect <br> <code>nobind</code> <br> <br>  # Allow the client to save the tunnel settings when reconnecting, and also not to re-read the key files <br> <code>persist-key <br> persist-tun</code> <br> <br>  Proxy settings <br> <code>;http-proxy-retry # retry on connection failures <br> ;http-proxy [proxy server] [proxy port #]</code> <br> <br>  # Turn off duplicate packet messages <br> <code>;mute-replay-warnings</code> <br> <br>  # Path to certificate files <br>  # ca - CA certificate that issued the client certificate AND server certificate <br>  # cert - client certificate <br>  # key - client certificate private key <br> <code>ca cert_export_test-CA.crt <br> cert cert_export_test-client-ovpn-1.crt <br> key cert_export_test-client-ovpn-1.key</code> <br> <br>  # auth-user-pass tells the client to use the username and password for authentication (not instead of certificates, but with certificates) <br>  # auth-user-pass tells OVPN client to use login and password (but not instead of certificates, but with certificates) <br>  # user-pwd.txt points to the file in which the username and password are stored;  The first line in the file is the login, the second is the password;  in the absence of this argument, the login and password will be requested each time you connect <br>  # Note: In the case of using a certificate with a private key, to which you need to enter the key every time you connect, I do not consider it necessary to force the user to remember the login with a password <br> <code>--auth-user-pass user-pwd.txt</code> <br> <br>  # Tells the client that he should check the server certificate for the key-usage used. <br> <code>remote-cert-tls server</code> <br> <br>  # Key for encrypting the beginning of the authentication process (handshake), an additional security measure.  It makes sense when using only login / password, without certificates. <br> <code>;tls-auth ta.key 1</code> <br> <br>  # Specify a special encryption method, by default blowfish128 is used. <br> <code>;cipher x</code> <br> <br>  # Use lzo-compression.  OVPN on ROS is not supported. <br> <code>;comp-lzo</code> <br> <br>  # Log level.  The greater the value - the more. <br> <code>verb 3</code> <br> <br>  # Blocking duplicate messages in the log <br> <code>;mute 20</code> <br> <br>  # Above were given the parameters that are present in the "native" example of the config for the client + 1 we need the parameter <br>  # Below I will give a few more, in my opinion, useful parameters. <br><br>  # Route set when starting a connection <br>  # The route does not point to the gateway, but directly to the connection <br> <code>route 192.168.88.0 255.255.255.0</code> <br> <br>  # Pause before installing routes after establishing a connection (in seconds) <br> <code>route-delay 5</code> <br> <br>  # If we want to set an OVPN connection as the main gateway <br> <code><s>route-gateway 192.168.100.1</s> <br> redirect-gateway def1 // </code>  <code><s>route-gateway 192.168.100.1</s> <br> redirect-gateway def1 // </code> @bibliary <code> .     ,        . <br></code> <code> .     ,        . <br></code> <br></div></div><br><br>  Note: to apply the routing parameters specified in the config, the OVPN service itself, or the OVPN GUI, must be run with administrator rights. <br><br>  Note: the list of most parameters is <a href="http://tuxnotes.ru/note/1">here</a> but it is somewhat outdated. <br><br><h4>  Setting up a MikroTik client </h4><br><h5>  1 Import Certificates </h5><br>  1.1 Put the CA certificate file and the certificate file and the client key file in a convenient way <br><br>  1.2 Import CA certificate <br><br> <code>/certificate import file-name=cert_export_test-CA.crt passphrase="" <br></code> <br><br>  1.3 Import the certificate and client key <br><br> <code>/certificate import file-name=cert_export_test-client-ovpn-1.crt passphrase="" <br></code> <br><br> <code>/certificate import file-name=cert_export_test-client-ovpn-1.key passphrase=private-key-password1 <br></code> <br><br>  2. Configure the client <br><br> <code>/interface ovpn-client add name=OVPN_client connect-to={ovpn.my.domain|xxx.xxx.xxx.xxx} port=1194 mode={ip|ethernet} user=test-user-1 password=P@ssword1 profile=default certificate=cert_32 auth=sha1 cipher=blowfish128 add-default-route={no|yes} disabled=no <br></code> <br><br>  Values ‚Äã‚Äãin {} specify in accordance with the previous settings and your needs. <br><br><div class="spoiler">  <b class="spoiler_title">The following equipment and software were used for the experiments:</b> <div class="spoiler_text">  RouterBoard 2011UiAS-2HnD with RouterOS 6.32.2 on board - 2 pcs., One as a server, the other as a client;  both serve as border gateways at home and at work. <br><br>  Laptop with Windows 10 Pro x64 on the bot - 1 pc., As a client;  serves for work and as a laboratory. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">The following resources were used for knowledge:</b> <div class="spoiler_text">  <a href="http://wiki.mikrotik.com/">wiki.mikrotik.com</a> <br>  <a href="https://openvpn.net/index.php/open-source/documentation/howto.html">openvpn.net/index.php/open-source/documentation/howto.html</a> <br>  <a href="http://tuxnotes.ru/note/1">tuxnotes.ru/note/1</a> <br>  <a href="https://www.v13.gr/blog/%3Fp%3D386">www.v13.gr/blog/?p=386</a> <br>  And a lot more in detail from the issuance of the search. <br></div></div><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/269679/">https://habr.com/ru/post/269679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269669/index.html">Brilliance and Poverty HTML5 - Access to Sensors</a></li>
<li><a href="../269671/index.html">Work with Git without using local branches</a></li>
<li><a href="../269673/index.html">Gulp: how I collected a project for production, ran livereload and made error catching</a></li>
<li><a href="../269675/index.html">Approach to implementing large formatted reports in SAP BW</a></li>
<li><a href="../269677/index.html">What Stable has prescribed</a></li>
<li><a href="../269681/index.html">Geek Week 2015: Learn, Learn and Learn More</a></li>
<li><a href="../269685/index.html">Algorithm of search of object displacement in the image</a></li>
<li><a href="../269687/index.html">Technopark Lectures: Alexey Rybak Master Class ‚ÄúAbout what I would like to be told while I was studying‚Äù</a></li>
<li><a href="../269689/index.html">Server Push Implementation for Nancy</a></li>
<li><a href="../269691/index.html">Telecommunications giant TalkTalk suffered from cyber attack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>