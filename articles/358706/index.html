<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Applications for Tarantool. Part 3. Testing and launch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The application for Tarantool is, in fact, a set of stored procedures used as an API. Data is processed on the storage side, which can significantly i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Applications for Tarantool. Part 3. Testing and launch</h1><div class="post__text post__text-html js-mediator-article"><p>  The application for Tarantool is, in fact, a set of stored procedures used as an API.  Data is processed on the storage side, which can significantly improve performance.  However, supporting stored procedures can turn into a nightmare. </p><br><p>  Can.  But not today. </p><br><p>  Today we will look at the quality assurance of the application.  In particular, let's talk about testing, figure out how to run in production, how to use connectors, and also talk about the intricacies of data schema migration. </p><br><p><img src="https://habrastorage.org/web/6bc/a42/ca2/6bca42ca2fc74d00923ad3348e4cdb09.png"></p><a name="habracut"></a><br><h2 id="soderzhanie-cikla-prilozheniya-dlya-tarantool">  Content of the cycle ‚ÄúApplications for Tarantool‚Äù </h2><br><p>  - <a href="https://habrahabr.ru/company/mailru/blog/334266/">Part 1. Stored procedures</a> <br>  - <a href="https://habrahabr.ru/company/mailru/blog/336648/">Part 2. OAuth2 authentication</a> <br>  - <a href="https://habr.com/company/mailru/blog/358706/">Part 3. Testing and running.</a> </p><br><p>  Let me remind you that all the examples in this series of articles are based on the application for authorization of users <a href="https://github.com/mailru/tarantool-authman">tarantool-authman</a> . </p><br><h2 id="testirovanie">  Testing </h2><br><p>  Testing is only one way to improve quality. </p><br><p> In the case of stored procedures, functional tests are a good way to support the current API.  For testing, the Tap <a href="https://tarantool.io/en/doc/1.9/reference/reference_lua/tap.html">(Test Anything Protocol) module</a> built into Tarantool is used.  It includes several methods for basic checks and comparisons of Lua objects.  Let's test two cases of user registration <code>auth.registration(email)</code> . </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> case = {} <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tap = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'tap'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> response = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.response'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> db = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.db'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'test.config'</span></span>) <span class="hljs-comment"><span class="hljs-comment">--     local auth = require('authman').api(config) local test = tap.test('registration_test') --  space     function case.before() db.truncate_spaces() end function case.after() end function test_registration_succes() local ok, code ok, code = auth.registration('test@test.ru') -- ,    ,     ‚Äî  test:is(ok, true, 'test_registration_succes user created') test:isstring(code, 'test_registration_succes code returned') end function test_registration_user_already_exists() local ok, code, got, expected, user ok, code = auth.registration('test@test.ru') --    API,      ok, user = auth.complete_registration('test@test.ru', code, 'password') -- ,      --    ,         Lua- got = {auth.registration('test@test.ru'), } expected = {response.error(error.USER_ALREADY_EXISTS), } -- is_deeply       Lua- test:is_deeply(got, expected, 'test_registration_user_already_active') end case.tests = { test_registration_succes, test_registration_user_already_exists } return case</span></span></code> </pre> <br><p>  Now we will write a small script to run the tests.  Do not forget to also take into account the <code>before</code> and <code>after</code> methods, which will simplify testing. </p><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--  ,   Tarantool box.cfg { listen = 3331, } local TEST_CASES = { 'test.case.registration', } function run() for case_index = 1, #TEST_CASES do local case = require(TEST_CASES[case_index]) for test_index = 1, #case.tests do --    case.before() case.tests[test_index]() case.after() end end end run()</span></span></code> </pre> <br><p>  The result of running tests: </p><br><pre> <code class="hljs erlang-repl">$ tarantool test/authman.test.lua ... TAP version <span class="hljs-number"><span class="hljs-number">13</span></span> ok ‚Äî test_registration_succes user created ok ‚Äî test_registration_succes code returned ok ‚Äî test_registration_user_already_active</code> </pre> <br><h2 id="zapusk-instansa">  Instance running </h2><br><p>  The application is written and tested, which means it's time to deploy it in a production-environment. </p><br><p>  To manage Tarantool instances, the tarantoolctl <a href="https://tarantool.io/ru/doc/1.9/reference/tarantoolctl.html">utility is used</a> .  At first we will create instans with the application.  Do not forget to add the user and give him rights. </p><br><pre> <code class="lua hljs">box.cfg { listen = <span class="hljs-number"><span class="hljs-number">3331</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bootstrap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> box.schema.user.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'my_user'</span></span>, {password = <span class="hljs-string"><span class="hljs-string">'123'</span></span>}) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'my_user'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> box.once(<span class="hljs-string"><span class="hljs-string">'init_user'</span></span>, bootstrap) <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = { <span class="hljs-comment"><span class="hljs-comment">--   } --   auth  auth = require('auth').api(config)</span></span></code> </pre> <br><p>  Now create a symbolic link to this file from the instances.enabled directory: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> ln -s /etc/tarantool/instances.available/auth.lua /etc/tarantool/instances.enabled/auth.lua</code> </pre> <br><p>  Run tarantoolctl and verify that we can connect to Tarantool and use application methods: </p><br><pre> <code class="hljs ruby">$ tarantoolctl start auth $ tarantoolctl enter auth connected to unix/<span class="hljs-symbol"><span class="hljs-symbol">:/var/run/tarantool/auth</span></span>.control unix/<span class="hljs-symbol"><span class="hljs-symbol">:/var/run/tarantool/auth</span></span>.control&gt; ok, user = auth.registration(<span class="hljs-string"><span class="hljs-string">'ivanov@mail.ru'</span></span>) unix/<span class="hljs-symbol"><span class="hljs-symbol">:/var/run/tarantool/auth</span></span>.control&gt; ok, user = auth.complete_registration(<span class="hljs-string"><span class="hljs-string">'ivanov@mail.ru'</span></span>, user.code, <span class="hljs-string"><span class="hljs-string">'123'</span></span>) unix/<span class="hljs-symbol"><span class="hljs-symbol">:/var/run/tarantool/auth</span></span>.control&gt; user --- - <span class="hljs-symbol"><span class="hljs-symbol">is_active:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> ivanov@mail.ru <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>cd27d26-<span class="hljs-number"><span class="hljs-number">3974</span></span>-<span class="hljs-number"><span class="hljs-number">43</span></span>d6-a2b2-<span class="hljs-number"><span class="hljs-number">87202664753</span></span>d ...</code> </pre><br><p>  If something went wrong, you should look at the logs <code>/var/log/tarantool/auth.lua</code> .  More information about administering the Tarantool server can be found <a href="https://tarantool.io/en/doc/1.9/book/admin/index.html">in the documentation</a> . </p><br><h2 id="konnektor">  Connector </h2><br><p>  One of the advantages of stored procedures is the provision of a common interface for services written in different programming languages. </p><br><p><img src="https://habrastorage.org/webt/k1/ei/lc/k1eilckal8f8mrkdplv9ubrfow8.png"></p><br><p>  Consider an example of asynchronous use of Tarantool using a <a href="https://github.com/igorcoding/asynctnt">Python connector</a> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asynctnt <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> tnt_connection = asynctnt.Connection( host=<span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, port=<span class="hljs-string"><span class="hljs-string">'3367'</span></span>, username=<span class="hljs-string"><span class="hljs-string">'my_user'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'123'</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#    user_data = await tnt_connection.call( 'auth.registrtion', ['exaple@mail.ru', ] ) await tnt_connection.disconnect() #    loop = asyncio.get_event_loop() loop.run_until_complete(create_user())</span></span></code> </pre> <br><p>  It is worth noting that you can also interact with Tarantool from another Tarantool instance using the built-in <code>net.box</code> module.  Read more about it <a href="https://tarantool.io/en/doc/1.9/reference/reference_lua/net_box.html">in the documentation</a> . </p><br><h2 id="migracii-dannyh">  Data migration </h2><br><p>  A common task when an application is already running in combat is changing the data schema.  For example, the user is required to add the <code>gender</code> field. </p><br><p><img src="https://habrastorage.org/webt/kv/0g/-5/kv0g-5kgelejw3tdzrwzui8qy-s.png"></p><br><p>  To do this, create a script that changes all the data in space <code>auth_user</code> .  The script itself can be added to the initialization call of the application, and the <code>box.once</code> function <code>box.once</code> restrict the repeated call. </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> fiber = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fiber'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">migrations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">--      box.once('20171101_add_gender', function () local counter = 0 --  space        --       for _, tuple in box.space.auth_user:pairs( nil, {iterator=box.index.ALL} ) do local user_tuple = tuple:totable() --      user_tuple[4] = get_user_gender() box.space.auth_user:replace(user_tuple) counter = counter + 1 end end) end migrations()</span></span></code> </pre> <br><p>  Although the migration can take a long time, the main thread of execution is not blocked.  This is due to the fact that the <code>replace</code> method implicitly calls <code>yield</code> .  In order to explicitly release the execution thread, you need to call the <code>fiber.sleep(0)</code> method.  Read more about this <a href="https://tarantool.io/en/doc/1.9/book/box/atomic.html">in the documentation</a> . </p><br><h2 id="chto-dalshe">  What's next? </h2><br><p>  Tarantool does not stand still and is actively developing. </p><br><p>  Outside this training cycle of articles, there are several important issues that you should pay attention to when writing your own services: </p><br><ul><li>  Sharding and replication.  Using <a href="https://github.com/tarantool/vshard">the vshard module</a> . </li><li>  SQL syntax support in Tarantool.  Optimize stored procedures using SQL. </li><li>  Review of the Vinyl disk engine.  Comparison with Memtx, or "What should I do if the RAM has run out?" </li><li>  Optimization and profiling of stored procedures written in C. </li></ul><br><p>  I remind you that all code examples are taken from the <a href="https://github.com/mailru/tarantool-authman">tarantool-authman application</a> .  It is also evolving, and can now be used as an Oauth2-server. </p><br><p>  If you have any questions beyond the cycle of articles, you can ask them in <a href="https://t.me/tarantoolru">telegram-chat</a> .  A responsive Tarantool community will most likely be able to help you. </p><br><p>  Thanks to everyone who waited for the third part. </p><br><p>  See you again! </p><br><blockquote>  The Tarantool community holds the first <a href="https://conf.tarantool.io/2018">in-memory computing conference on</a> June 21 in Moscow.  Reports are still accepted, call for papers is open. </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358706/">https://habr.com/ru/post/358706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358696/index.html">We update Angular to the 6th version in the project without use of CLI</a></li>
<li><a href="../358698/index.html">13 interesting points from the javascript style guide from google</a></li>
<li><a href="../358700/index.html">GraalVM: mixed in a bunch of C and Scala</a></li>
<li><a href="../358702/index.html">How to run dynamic retargeting effectively in a mobile application</a></li>
<li><a href="../358704/index.html">Dirty tricks video game developers</a></li>
<li><a href="../358708/index.html">Frontend 2018: the variety of frameworks and the lack of middles</a></li>
<li><a href="../358710/index.html">Q & A Explorer. April feature for Power BI Desktop</a></li>
<li><a href="../358712/index.html">7 common mistakes in English that we make when communicating with foreigners</a></li>
<li><a href="../358714/index.html">Two types of PHP extensions. Zend extension VS PHP module</a></li>
<li><a href="../358716/index.html">Documentation Support in ASP.NET Web API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>