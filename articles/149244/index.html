<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client-server communication in Unity3d</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! It is always very interesting to me to read articles about someone else's real experience, and successfully passing through a placer rake or ra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client-server communication in Unity3d</h1><div class="post__text post__text-html js-mediator-article">  Hello!  It is always very interesting to me to read articles about someone else's real experience, and successfully passing through a placer rake or rake.  Therefore, this article I want to start sharing my modest experience from the world of game development on a unit, as well as learn more about someone else's experience with a unit. <br><br>  So, in November last year, our team began to make the client session session mmoshechka - ride on the machines, shoot the enemies.  I must say that the team already had experience of not a successful project for a unit, it was a 3D race for VKontakte.  So the theme of the machines in the unit was already familiar and it was planned to save on this.  The very first thing with which it was decided to start is to make proof of the concept as quickly as possible - a demo of the game that shows the gameplay as accurately as possible.  The purpose of this event is clear - as soon as possible to cut off all that does not fit into the game.  In addition, it was also necessary to choose a server engine.  With the client, everything was clear right away, Unity3d is our everything, but what to choose as a server engine?  That is the question.  I will dwell on this in more detail. <br><br><a name="habracut"></a><br>  So, the following applicants were found: <br>  1. <a href="http://www.exitgames.com/">Photon</a> <br>  2. <a href="http://www.smartfoxserver.com/">Smartfox</a> <br>  3. <a href="http://unity3d.com/unity/engine/networking">Built in Unity Network</a> <br>  4. <a href="http://www.electrotank.com/technology-overview.html">ElektroServer</a> <br>  5. <a href="http://muchdifferent.com/%3Fpage%3Dgame-unitypark">uLink</a> <br>  6. <a href="http://www.crystalengine.ru/">CrystalEngine</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We rejected the <a href="http://unity3d.com/unity/engine/networking">built-in network in Unity</a> immediately.  Despite the fact that this solution provides support for physics on the server, which means it is a fully authoritarian server, in this case, in order to launch a new match-room, you need to raise a new Unity instance on the server, which is very expensive. <br>  <a href="http://www.electrotank.com/technology-overview.html">ElektroServer</a> may be good at heart, at the time of selection, it seemed not as fast developing as the other applicants.  In addition, if you look at their website, the vast majority of customers ordered the services of the studio that created ElektroServer, and those who ordered their server solution alone are a minority.  Therefore, we also refused from ElektroServer. <br>  <a href="http://muchdifferent.com/%3Fpage%3Dgame-unitypark">uLink</a> is an interesting thing, but at the moment it is quite new.  Moreover, as far as I remember, uLink lives inside the unit, that the client, that the server, therefore again raises the question of server performance.  In principle, the solution should be good if you do so that the players themselves can raise the servers for the matches, as in a counter, for example.  In appearance, all sorts of buns in uLink are much more than in the network built into the unit. <br>  <a href="http://www.crystalengine.ru/">CrystalEngine</a> is a young, developing engine.  Of the benefits - at the time of creating the demo for preproduction, our team was the main developer of this engine.  Of the minuses, the engine is too young, there is a lack of documentation and a lack of a large community.  Therefore, this engine decided not to be laid. <br><br>  So we have 2 finalists left: <br>  <a href="http://www.exitgames.com/">Photon</a> vs <a href="http://www.smartfoxserver.com/">smartfox</a> <br><br>  Unfortunately, there was no time to test both solutions during preproduction.  Both engines inspire respect, have released games, documentation and live community.  So, the key role in the choice of the engine was played by the fact that I was already familiar with the smartphone and knew it only from the good side.  Thoughtful, easy to understand API, a huge number of running projects, work on Linux.  In general, Smartfoks won.  We even sketched a demo to test the server, but only ~ 700 clients were able to start from the office, after which the office network was already beginning to die, and the server was barely aware of the load.  In this regard, I have a question - did anyone do load testing of game servers?  If so, how was it tested? <br><br>  Well, let's move on.  At the beginning of the creation of demo programmers in the team were three: I, the main server, and widely known in the narrow circles of Neodrop (the founder of the Russian Internet community on Unity3d and the site <a href="http://unity3d.ru/">3d3d.ru</a> ).  After Smartfox was selected as a server engine, our server operator left.  So I started to pretend to be a server programmer. <br>  For a month and a half of preproduction, it turned out to release a demo in which: <br>  1. There is a garage with common chatikom. <br>  2. You can run the battle on 2 teams. <br>  3. Each player rides the 1st of 4 machines: <br>  a scout, a heavy armored car, artillery, or an engineer. All of this cheerfully drove, flipped over, shot and killed each other.  Oh yeah, there was also a system of visibility like the one in World of Tanks, but not so cool, of course. <br><br>  Looking ahead, it is worth noting the following fact - the creation of such a demo took less than a month and a half of pure time.  Later, when we decided to rewrite everything from scratch for production, so that the code was cleaner, and in general all the necessary features became possible, such as changing modules and equipment, we could only reach the level of playability of such a demo in 2-3 months.  Moreover, the program worked no longer 2 people, but 6-7.  It happened due to the fact that in our demo it was impossible to change modules and equipment in runtime, and this possibility should be in the final product.  So it turns out that one feature can increase labor costs at times.  (Although, of course, not only is she alone. In the final product, all that can and cannot be managed through the admin area is, and this is also the fun one.) <br><br>  Something turned out to hurt a lot of lyrics, try to add a little more technical details.  During the project, a fairly decent number of problems and issues emerged that are of little relevance or practically irrelevant for small projects, but in larger projects it is necessary to solve them so that work does not slow down. <br><br>  The very first problem we encountered was the protocol of communication between the client and the server.  In the smartphone everything is arranged as follows: <br>  1. The client code subscribes to a type event. <br><br><pre><code class="cs hljs">smartFox.AddEventListener(SFSEvent.EXTENSION_RESPONSE, OnExtensionResponse);</code> </pre> <br><br>  2. By calling a command from the server, all subscribers on the client are jerked to the method to which parameters are transmitted from the server.  Parameters from the server are transmitted as a string-name of the command and a certain <code>SFSObject</code> , which is an analogue of the hash table and contains all the data that the server sent us to the client. <br><br>  Therefore, in order to execute a command from the server, we have to subscribe to server messages in the right place, and check whether the command is right for us or not, and if it is the right command, get all the necessary data from <code>SFSObject</code> and finally execute the command .  Naturally, every time I didn‚Äôt want to do this with pens.  The simplest thing that came to mind at once was to sign one game controller for this event, and it‚Äôs time to create an event that explicitly contains a single command, separate parameters.  It turned out something like: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SFSExtensionsController</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtensionResponceDelegate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd, SFSObject parameters</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> ExtensionResponceDelegate onExtensionResponce = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { smartFox.AddEventListener(SFSEvent.EXTENSION_RESPONSE, OnExtensionResponse); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnExtensionResponse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BaseEvent evt</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cmd = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)evt.Params[<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>]; SFSObject sfsParameters = (SFSObject)evt.Params[<span class="hljs-string"><span class="hljs-string">"params"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (onExtensionResponce != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { onExtensionResponce(cmd, sfsParameters); } } }</code> </pre><br><br>  Not bad for a start, but the problem with parsing the parameters in each receiver still remains.  Therefore, the next thing that has been done is that controllers that subscribe to our <code>onExtensionResponce</code> event are <code>onExtensionResponce</code> intercept a logically solid piece of commands inside themselves, for example, those responsible only for moving, or only shooting, and give out events with data ready for game logic. <br>  There are advantages to such a solution - inside the game logic it is not necessary every time to check <code>SFSObject</code> for the presence of the required fields.  But there are enough minuses - if the event is narrowly specialized and the subscriber will be only one - a whole class for the sake of this does not feel like city.  Moreover, when there will be a lot of such controllers - how to find the one in which the necessary event is located?  And also, do not forget that there is no automatic serializer in <code>SFSObject</code> , and so far each class has to be serialized manually, prescribing the necessary code both on the client and on the server.  (Yes, there are methods in the smart phone that should serialize arbitrary classes in <code>SFSObject</code> , but we didn‚Äôt take off this functionality, but there was no time to <code>SFSObject</code> it out.) It is also necessary to maintain the identity of the string command names on the client and on the server.  God forbid, someone is sealed somewhere.  So it turns out that despite the power and reasonableness of Smartfox, it‚Äôs just impossible to take it and use it for your own pleasure in a project in which more than one person is engaged. <br><br>  But ... with all its flaws, the system described above performed its task and the demo worked perfectly on it.  However, this place was the very first to rework in the production stage.  There were several tasks to be solved: <br><br>  1. The identity of the commands in the data exchange protocol, and also the structures of <code>SFSObject</code> that are <code>SFSObject</code> between the client and the server. <br>  2. Automatic serialization / deserialization of game logic data. <br>  3. Convenient sending / receiving messages from the classes that serve the game logic. <br><br>  Let's go out of order. <br><br>  Point two: automatic serialization / deserialization.  It would seem that it could be trivial - use reflexion, write down all the necessary additional information, such as the name of the class, <code>SFSObject</code> will be happiness in <code>SFSObject</code> .  But our happiness in this case will not be complete at all, because it is a real-time toy, with a large flow of constantly changing data, such as the position of the machine, the speed, the turn of the tower, etc.  etc.  Many of these data are sent between the server and the client several times per second for each player, and 32 players are planned for a room, and there are at least 50 such rooms for the server so that the project does not go bust, so the solution does not work.  And here we got the following idea.  The code for packing / unpacking game data in <code>SFSObject</code> is trivial, and even the program can write this code for us.  In total, a utility was written that accepts an xml file in the specified format as input, and produces two source files at the output, one in C # for Unity, the second in java for Smartfox.  The resulting files contain classes, with two methods <code>SFSObject ToSFSObject()</code> and <code>void FromSFSObject(SFSObject sfsObject)</code> . <br><br>  An example of a class generated programmatically for C # <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StartMultipleArtilleryShootProxy</span></span> : <span class="hljs-title"><span class="hljs-title">ISFSSerializable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> userId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> barrelId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> projectile { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3fProxy position { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Vec3fProxy&gt; direction { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> startSpeed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//---------------------------------------------------------------- public StartMultipleArtilleryShootProxy() {} public StartMultipleArtilleryShootProxy(ISFSObject obj) { FromSFSObject(obj); } public StartMultipleArtilleryShootProxy(int userId, long barrelId, long projectile, Vec3fProxy position, List&lt;Vec3fProxy&gt; direction, float startSpeed) { this.userId = userId; this.barrelId = barrelId; this.projectile = projectile; this.position = position; this.direction = direction; this.startSpeed = startSpeed; } //---------------------------------------------------------------- public void FromSFSObject(ISFSObject obj) { this.userId = obj.GetInt("ui"); this.barrelId = obj.GetLong("bi"); this.projectile = obj.GetLong("pr"); this.position = new Vec3fProxy(obj.GetByteArray("p").Bytes); this.direction = new List&lt;Vec3fProxy&gt;(); ISFSArray direction_array = obj.GetSFSArray("d"); for (int i = 0; i &lt; direction_array.Size(); i++) this.direction.Add( new Vec3fProxy(direction_array.GetByteArray(i).Bytes)); this.startSpeed = obj.GetFloat("s"); } //---------------------------------------------------------------- public SFSObject ToSFSObject() { SFSObject obj = new SFSObject(); obj.PutInt("ui", userId); obj.PutLong("bi", barrelId); obj.PutLong("pr", projectile); obj.PutByteArray("p", new ByteArray(position.ToBytes())); if (this.direction == null) Debug.LogError("direction == null in ToSFSObject()"); ISFSArray direction_array = new SFSArray(); for (int i = 0; i &lt; this.direction.Count; i++) direction_array.AddByteArray(new ByteArray(direction[i].ToBytes())); obj.PutSFSArray("d", direction_array); obj.PutFloat("s", startSpeed); return obj; } }</span></span></code> </pre><br><br>  An entry about this class in an xml file: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StartMultipleArtilleryShootProxy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">userId-ui</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"int"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">barrelId-bi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"long"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">projectile-pr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"long"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">position-p</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vec3fProxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">direction-d</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vec3fProxy array"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">startSpeed-s</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"float"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><br>  When changing the protocol, we change the xml file, run the utility, we get the code that can quickly serialize / deserialize <code>SFSObject</code> into the classes we need.  We replace the file on the client and on the server and that's it, it's ready! <br><br>  Point one would be logical to solve, developing the format of ixmelka, and storing there not only the data that will be transmitted between the client and the server, but also the names of the commands.  But ... the timeline is always burning, there is no time to do such things at the moment.  So the problem with typos in the names of the teams was partially solved in the process of solving paragraph 3. <br><br>  The idea of ‚Äã‚Äãthe central controller to receive messages from the server was not so bad, so it was decided to leave this controller.  In addition, it was decided to create a small class for each event from the server, which knows exactly which command it processes and which data it gives to the outside.  We can stuff all such classes in one place, it's nice to name them and initialize them at the start of the application.  Thus, client logic does not need to know anything about all sorts of smartphones, it‚Äôs enough to contact the command store: <br><br><pre> <code class="cs hljs">SFSProtocol.Protocol.BATTLE.HitRivalRequest.onGetResponce += OnGetHitRivalResponce;</code> </pre><br><br>  and the event handler, in turn, accepts the already strictly typed data necessary for the game logic: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGetHitRivalResponce</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HitResultProxy hitResultProxy</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br><br>  And now a little bit of magic, which is based on the fact that Unity promotes single-threaded code within itself, and events from the server are also invoked in one thread.  Thanks to this single-threading, we can check in our only controller, which communicates directly with the smartphone, whether someone has processed the command from the server or not, and if no one has processed, then immediately scream about it in the logs.  It looks like a trivial simple: <br><br><pre> <code class="cs hljs">cmdWasCatched = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (onExtensionResponce != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { onExtensionResponce(cmd, sfsParameters); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cmdWasCatched) { Debug.LogError(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"SFSExtensionsController.OnExtensionResponse cmd={0} was not catched!"</span></span>, cmd)); }</code> </pre><br><br>  In addition, such an architecture allowed to do absolutely necessary things for client-server communication: checking the timeout for a response from the server, adding additional service fields, in addition to the game logic data (for example, the flag if the request from the client was successful or not, and if unsuccessful - description errors from the server.) <br><br>  At the end of the article it is worth mentioning one more rake that we stepped on.  To facilitate the creation of new commands in the protocol, a parameterizable class was made, in which we can specify the type of data that should be sent to the server, the type of data that should be received from the server, and the designer.  The code that deserialized objects inside this class looked like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SFSRequest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TReqData</span></span>, <span class="hljs-title"><span class="hljs-title">TRespData</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">DataTransporter</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TReqData</span></span> : <span class="hljs-title"><span class="hljs-title">ISFSSerializable</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TRespData</span></span> : <span class="hljs-title"><span class="hljs-title">ISFSSerializable</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { ‚Ä¶.......... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Sfs2X.Entities.Data.SFSObject sfsParameters</span></span></span><span class="hljs-function">)</span></span> { responceData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TRespData(); responceData.FromSFSObject(sfsParameters); OnGetResponce(); } }</code> </pre><br><br>  And everything seems to be great, but there is one big but: in this case, the constructor <code>new TRespData()</code> will use reflection.  In the end, with which they fought, they ran into it: reflexion was still used, and already with 8 players in battle, braking was noticeable.  To remedy the situation, 2 fields for delegates were added to the team‚Äôs class <code>TRespData</code> ; they do the only thing ‚Äî create <code>TRespData</code> and <code>TReqData</code> .  So, the base class handler began to look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Sfs2X.Entities.Data.SFSObject sfsParameters</span></span></span><span class="hljs-function">)</span></span> { responceData = respDataConstructor(); responceData.FromSFSObject(sfsParameters); onGetResponce(); }</code> </pre><br><br>  And the final class for a specific command is: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MultipleArtilleryShootStartRequest</span></span> : <span class="hljs-title"><span class="hljs-title">SFSRequest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">StartMultipleArtilleryShootProxy</span></span>, <span class="hljs-title"><span class="hljs-title">StartMultipleArtilleryShootProxy</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MultipleArtilleryShootStartRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sendCommand, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> receiveCommand, Func&lt;StartMultipleArtilleryShootProxy&gt; reqDataConstructor, Func&lt;StartMultipleArtilleryShootProxy&gt; respDataConstructor</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sendCommand, receiveCommand, reqDataConstructor, respDataConstructor</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br><br>  By the way, an article with a habr helped me to find this joint, a link to which I unfortunately lost. <br><br>  By such, not very complicated methods, it turned out to make a fairly convenient client-server communication.  If someone has questions or comments - well in the comments.  For those who have read the article to the end, a small bun - a <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AjZV0SdoOTsPdFVGQWxUWW9Fdmk2RzNfa3hUZU90V1E%26hl%3Den_US">pivot table of parameters for game engines, dug up on the Internet</a> . </div><p>Source: <a href="https://habr.com/ru/post/149244/">https://habr.com/ru/post/149244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149238/index.html">PostgreSQL vs Oracle</a></li>
<li><a href="../149239/index.html">Automatic code check for PHP</a></li>
<li><a href="../149241/index.html">1C server 8.2 + MsSql 2008 + BackUp</a></li>
<li><a href="../149242/index.html">Google Play tightens requirements</a></li>
<li><a href="../149243/index.html">Authorization on sites through Z-Payment (OAuth 2.0)</a></li>
<li><a href="../149247/index.html">Developer, do not be afraid of the new iPhone</a></li>
<li><a href="../149248/index.html">InterSystems Database Mirroring. Creating and testing mirrors. Part 2</a></li>
<li><a href="../149249/index.html">How and why sites are blocked</a></li>
<li><a href="../149251/index.html">SilkRoad's monthly turnover reaches $ 2 million</a></li>
<li><a href="../149253/index.html">Introducing NetBiscuits at Ciklum Speakers' Corner in Dnepropetrovsk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>