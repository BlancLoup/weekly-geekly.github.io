<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We follow the comments on the site in the widget "Comments" from VKontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why, why and how 
 It so happened that our project needed comments from VKontakte, but so that we could follow the comments. Since there are a lot of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We follow the comments on the site in the widget "Comments" from VKontakte</h1><div class="post__text post__text-html js-mediator-article"><h4>  Why, why and how </h4><br>  It so happened that our project needed comments from VKontakte, but so that we could follow the comments.  Since  there are a lot of pages on the site, it is unrealistic to view all pages every day and check them <br>  There were a lot of ways, for example, sending an e-mail message with each comment.  If you use the "comment - alert" method, then there will be a lot of letters, but there is a way out - collecting new messages and sending one e-mail letter. <a name="habracut"></a><br><br><h4>  Watch and punish </h4><br>  Let's get started  First of all, we climb into the <a href="http://vk.com/pages%3Foid%3D-1%26p%3D%25D0%2594%25D0%25BE%25D0%25BA%25D1%2583%25D0%25BC%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D0%25BE_%25D0%25B2%25D0%25B8%25D0%25B4%25D0%25B6%25D0%25B5%25D1%2582%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BC%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B0%25D1%2580%25D0%25B8%25D0%25B5%25D0%25B2">widget's documentation</a> . <br>  Add a widget to the page <br><pre><code class="javascript hljs">&lt;script src=<span class="hljs-string"><span class="hljs-string">"http://userapi.com/js/api/openapi.js"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> charset=<span class="hljs-string"><span class="hljs-string">"windows-1251"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div id=<span class="hljs-string"><span class="hljs-string">"vk_comments"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; VK.init({<span class="hljs-attr"><span class="hljs-attr">apiId</span></span>: *******, <span class="hljs-attr"><span class="hljs-attr">onlyWidgets</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); VK.Widgets.Comments(<span class="hljs-string"><span class="hljs-string">"vk_comments"</span></span>, {<span class="hljs-attr"><span class="hljs-attr">limit</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-string"><span class="hljs-string">"496"</span></span>, <span class="hljs-attr"><span class="hljs-attr">attach</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-attr"><span class="hljs-attr">autoPublish</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><br>  We read the documentation and see that the widget sends us two events via <b>VK.Observer</b> with the parameters <b>num</b> , <b>last_comment</b> , <b>date</b> , <b>sign</b> (for more information, see the link to the documentation): <br>  1) <b>widgets.comments.new_comment</b> - adding a new comment <br>  2) <b>widgets.comments.delete_comment</b> - delete comment 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It turns out that we can follow the actions without problems.  Since  I need to get an answer and perform some actions, I will use jQuery.  Add <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://code.jquery.com/jquery-latest.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Also before we add an action handler. <br><pre> <code class="javascript hljs">VK.Observer.subscribe(<span class="hljs-string"><span class="hljs-string">'widgets.comments.new_comment'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num,last_comment,date,sign</span></span></span><span class="hljs-function">)</span></span>{onComment(num,last_comment,date,sign,<span class="hljs-string"><span class="hljs-string">'new'</span></span>);}); VK.Observer.subscribe(<span class="hljs-string"><span class="hljs-string">'widgets.comments.delete_comment'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num,last_comment,date,sign</span></span></span><span class="hljs-function">)</span></span>{onComment(num,last_comment,date,sign,<span class="hljs-string"><span class="hljs-string">'del'</span></span>);});</code> </pre><br><br>  + notification function <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComment</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">num,last_comment,date,sign,action</span></span></span><span class="hljs-function">)</span></span>{ $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"test.php"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>:{<span class="hljs-string"><span class="hljs-string">"num"</span></span>:num,<span class="hljs-string"><span class="hljs-string">"last_comment"</span></span>:last_comment,<span class="hljs-string"><span class="hljs-string">"date"</span></span>:date,<span class="hljs-string"><span class="hljs-string">'sign'</span></span>:sign,<span class="hljs-string"><span class="hljs-string">'action'</span></span>:action}, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,       . } }); }</span></span></code> </pre><br><br>  Now we set up our php script.  Personally, I decided to use the method of recording new comments in the database with the value of the field <b>approve = 0</b> , in order to show the script the raw comments. <br>  We will not write all the code, but we will write only the main thing - the authentication of the request and the type of action.  To do this, we need to know the "Secure Application Key".  Go to the "Administration" widget, "Assign Administrator", go to the menu item "Settings". <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(md5(<span class="hljs-string"><span class="hljs-string">' '</span></span>.$_POST[<span class="hljs-string"><span class="hljs-string">'date'</span></span>].$_POST[<span class="hljs-string"><span class="hljs-string">'num'</span></span>].$_POST[<span class="hljs-string"><span class="hljs-string">'last_comment'</span></span>])==$_POST[<span class="hljs-string"><span class="hljs-string">'sign'</span></span>]){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'action'</span></span>]==<span class="hljs-string"><span class="hljs-string">'new'</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//   ,  approve=0 }else{ //    , ,  . } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  You can enter into the database the number of comments, the comments themselves, the commenting date. <br>  Then, we write a script that will be called up using the crown, check the database for new comments and, if they exist, send a letter to the host. <br>  You can also add an entry to the <b>$ _SERVER ['HTTP_REFERER']</b> parameter in the database to determine from which page the comment was sent. <br>  When receiving a letter, we look at the presence of undesirable or interesting comments and punish / encourage users. <br><br><h4>  Disappointment </h4><br>  Unfortunately, I did not find in the documentation of events: <br>  1) If the user deleted and restored the comment <br>  2) Received a reply to the comment <br>  Perhaps I was looking bad. <br><br>  If something is not working - the <a href="http://vk.com/pages%3Foid%3D-1%26p%3D%25D0%2594%25D0%25BE%25D0%25BA%25D1%2583%25D0%25BC%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D0%25BE_%25D0%25B2%25D0%25B8%25D0%25B4%25D0%25B6%25D0%25B5%25D1%2582%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BC%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B0%25D1%2580%25D0%25B8%25D0%25B5%25D0%25B2">documentation of the widget</a> </div><p>Source: <a href="https://habr.com/ru/post/164485/">https://habr.com/ru/post/164485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164475/index.html">5 APIs that will change the web in 2013</a></li>
<li><a href="../164477/index.html">Drawing Snowflakes with SVG</a></li>
<li><a href="../164479/index.html">Multiple Assertions without interruption in one unit test using NUnit as an example</a></li>
<li><a href="../164481/index.html">Happy new year, Habr!</a></li>
<li><a href="../164483/index.html">Another look at the Entity Framework: performance and pitfalls</a></li>
<li><a href="../164487/index.html">Java multithreading</a></li>
<li><a href="../164489/index.html">Ways of moving computer characters (Part 1)</a></li>
<li><a href="../164491/index.html">Homemade lights on quadrocopter</a></li>
<li><a href="../164493/index.html">Directives in AngularJS</a></li>
<li><a href="../164495/index.html">Analysis and optimization of a single query in EclipseLink</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>