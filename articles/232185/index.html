<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving the problem with circular references in ObjC blocks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Much has been written about the blocks in ObjC and the correct work with them, including in the Habr√©. The question of how to work correctly with self...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving the problem with circular references in ObjC blocks</h1><div class="post__text post__text-html js-mediator-article">  Much has been written about the blocks in ObjC and the correct work with them, including in the Habr√©.  The question of how to work correctly with self in blocks to avoid circular references is regularly asked at interviews.  When using frameworks such as ReactiveCocoa, the number of blocks in the code increases dramatically, while increasing the chance of making a mistake and losing objects in memory.  About the attempt to finally solve this problem, metaprogramming for c99 with extensions and blocks + hipster macros with @ under the cut. <br><a name="habracut"></a><br>  Consider the problem and how to solve it evolutionally. <br><pre><code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> f1]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> f2]; };</code> </pre> <br>  This code obviously has a problem.  Without the self.block, the object can never be deleted, since the block refers to self.  When LANG_WARN_OBJC_IMPLICIT_RETAIN_SELF is enabled, the compiler will even issue a warning. <br><br><h6>  Improvement 1: </h6><br><pre> <code class="hljs objectivec">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> __<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ [weakSelf m1]; [weakSelf m2]; };</code> </pre><br>  The circular reference problem has been resolved, but another one occurs.  At the time of the block call, the weakSelf object either exists or no longer exists.  If the object does not already exist, weakSelf == nil, m1 and m2 will not be called - it would seem that everything is in order.  However, it may happen that at the time of calling m1, the object still exists, but at the time of calling m2, it no longer exists.  In this case, m1 will be called, and m2 is not - this behavior may be unexpected and incorrect.  This can occur as with race condition in a multi-threaded application, or if m1 reduces the number of references to an object (for example, removes an object from any collection).  In the case of CLANG_WARN_OBJC_REPEATED_USE_OF_WEAK and CLANG_WARN_OBJC_RECEIVER_WEAK included, the compiler issues a warning for this case. <br><br><h6>  Improvement 2: </h6><br><pre> <code class="hljs objectivec">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)strongSelf = weakSelf; [strongSelf m1]; [strongSelf m2]; };</code> </pre><br>  The problem with consistency of method calls inside the block is solved.  But a new one is revealed: <br><pre> <code class="hljs objectivec">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)strongSelf = weakSelf; [strongSelf m1]; [strongSelf m2]; <span class="hljs-built_in"><span class="hljs-built_in">NSAssert</span></span>(foo == bar, <span class="hljs-string"><span class="hljs-string">@"Cool assert!"</span></span>) };</code> </pre><br>  Macros, such as NSAssert and RACObserve, implicitly use self, and a cyclic reference problem is returned. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Improvement 3: </h6><br><pre> <code class="hljs objectivec">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m1]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m2]; <span class="hljs-built_in"><span class="hljs-built_in">NSAssert</span></span>(foo == bar, <span class="hljs-string"><span class="hljs-string">@"Cool assert!"</span></span>) };</code> </pre><br>  Now the problem with macros using self is resolved, but when GCC_WARN_SHADOW is turned on, the compiler issues a warning. <br><br><h6>  Improvement 4: </h6><br>  The libextobjc library has @weakify and @stongify macros that remove the compiler warning and simplify the code a bit. <br><pre> <code class="hljs ruby">@weakify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __weak <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __strong [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m1]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m2]; NSAssert(foo == bar, @<span class="hljs-string"><span class="hljs-string">"Cool assert!"</span></span>) };</code> </pre><br>  This is almost the optimal solution, but it still has several drawbacks: you need to remember to put @weakify and @strongify in the right places;  using self after @weakify is safe, but the compiler may issue a warning. <br>  At the same time, there still remains the probability of accidentally capturing in the self block with a strong link: <br><pre> <code class="hljs ruby">@weakify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __weak <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __strong [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m]; NSLog(@<span class="hljs-string"><span class="hljs-string">"Ivar value form object: %@"</span></span>, _ivar); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      _ivar NSAssert(foo == bar, @<span class="hljs-string"><span class="hljs-string">"Cool assert!"</span></span>) };</code> </pre><br>  In order to avoid this, you must either use only access via property (self.ivar), or use the overridden self explicitly: <br><pre> <code class="hljs ruby">@weakify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __weak <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>      __strong [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> m]; NSLog(@<span class="hljs-string"><span class="hljs-string">"Ivar value form object: %@"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>-&gt;_ivar); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>    _ivar NSAssert(foo == bar, @<span class="hljs-string"><span class="hljs-string">"Cool assert!"</span></span>) };</code> </pre><br>  It should be remembered that self can be nil, and the explicit dereference of self -&gt; _ ivar will cause a crash. <br><br>  Taking into account all these problems, an idea arose to write a macro that will modify not the self, but the block itself in such a way that: <br><ul><li>  self outside the scope of a block should not be changed, as in the case of @weakify </li><li>  inside the self block should be called self to avoid surprises with NSAssert and other macros </li><li>  until the block is called, the object pointed to by self is stored by a weak reference, and during a block call, by a strong </li><li>  if possible, the macro should help find blocks that implicitly capture self through _ivar </li><li>  all type checks should work the same as without a macro </li><li>  minimize code changes when using this macro </li><li>  overhead at runtime should be minimal </li></ul><br>  The macro should work approximately like a decoder function in Python, take a block as input, and wrap it in a new block wrapper that is compatible with the parameters and return value.  For example, consider the block: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre><br>  Let's start modifying the block so that self is captured as a weak link, by analogy with the code from "Improvement 1".  To do this, we need a new scope in which this local link will be declared.  As such a scope, an anonymous block is appropriate, which is called immediately after creation: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [weakSelf description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }; }();</code> </pre><br>  The compiler will automatically display the return type for the external unnamed block, everything remains type safe. <br><br>  Now you need to somehow make it so that at the time of the call inside the body of the internal block, self becomes a strong link.  For this, it is necessary to divide the block into 2 parts: a declaration of the type ^ (NSObject * obj) and, in fact, the body itself in {...}.  Let's transform the body of our block into a block without parameters and place its call into another block created using a type declaration that turns self into a strong link: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^{ __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@, %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }(); }; }();</code> </pre><br>  The main trick is to replace the source block, equivalent to it, but which implicitly captures the weakSelf instead of self, and at the time of the call turns it into a strongSelf. <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@, %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }(); };</code> </pre><br>  essentially the same as <br><pre> <code class="hljs objectivec">^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre><br>  Total instead of one block is created three.  Since the outermost block is called immediately after creation, you can get rid of it using the <a href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Exprs.html">code block evaluation evaluation aka statement expressions extension</a> : <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ({ __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@, %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }(); }; });</code> </pre><br>  It remains to wrap the entire boilerplate in a macro, so that this trick was convenient to use.  If you leave only the common code, you get: <br><pre> <code class="hljs objectivec"> ({ __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> { __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> } (); }; })</code> </pre><br>  The first idea was to make a macro with two parameters, for type and body, which would be called like this: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = weakself(^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj), { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; });</code> </pre><br>  but, unfortunately, when preprocessing, macros are deployed in one line, and, as a result, it is impossible to set a breakpoint on an arbitrary line in the body of the block.  Therefore, I had to do this: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = weakself(^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj)) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } weakselfend ;</code> </pre><br>  this option is equivalent to @ weakify / @strongify from "Enhancement 4".  Macro code: <br><pre> <code class="hljs rust">#define weakself(ARGS) \ ({ __weak <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) _private_weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; \ ARGS { \ __strong <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(_private_weakSelf) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> __attribute__((unused)) = _private_weakSelf; \ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (void) { #define weakselfend } (); }; })</code> </pre><br>  One of the goals when creating a macro was to protect itself from the implicit capture of self when accessing ivar.  Unfortunately, I did not think up how to do this in compile time.  The only option is assert / log for the debug version when creating a block (it is enough just to create a block so that the test works, it is not necessary to call it).  Here it is worth recalling a little about how memory management works for blocks and objects that they capture.  There are 3 types of blocks: <br><ul><li>  NSGlobalBlock - blocks created at the top level of the source code file are essentially similar to functions from the point of view of memory management, variables in the scope do not capture this interest for us are not. </li><li>  NSStackBlock is the initial type for all other blocks created, created on the stack, do not increase reference counters for objects that capture, because the lifetime of such a block is less than or equal to the lifetime of variables from its lexical scope. </li><li>  NSMallocBlock is an NSStackBlock which was moved to heap by explicitly calling copy / Block_copy or implicitly by the compiler.  One of the cases when the compiler implicitly inserts Block_copy is to return a block as a result from a function / block.  At the time that the NSStackBlock is turned into NSMallocBlock, the reference counts for objects that the block has captured in its scope increase. </li></ul><br>  Thus, in order to check whether a block captures a strong reference to self, you need to compare the reference count to self, before the block was transferred to the heap, and after.  If the counter has increased, then the block captured self by a strong link.  This check cannot be reliable in 100% of cases, since the self-reference counter may change from other threads during block transfer to heap, however, this situation is unlikely in a normal program and is quite suitable for a Debug build. <br><br>  The object could have used the retainCount method to get the reference count, but it is no longer available with ARC, but CFGetRetainCount still works through toll-free bridging.  It remains only to insert the calls to this function with the self parameter in the right places and compare the results. <br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = {( __weak typeof(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>    ^(NSObject *obj) { __strong typeof(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (void) { NSLog(@<span class="hljs-string"><span class="hljs-string">"%@, %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }(); }; }) /<span class="hljs-regexp"><span class="hljs-regexp">/     .         statement expression</span></span></code> </pre><br>  The problem is that the result of statement expressions is the last line in it.  The behavior is similar to an anonymous block, which is called immediately after the declaration.  Since the last line of the statement expression is a block declaration, in order for this block to remain valid, the compiler will transfer it to heap.  So, we can save the CFGetRetainCount call for self to a local variable inside the statement expression, and we need to make the second CFGetRetainCount call after the last line of the statement expression.  If we were talking about C ++, we could create an object on the stack, and in the object's destructor we could do everything we need, since the destroyer would be called after the last line of the statement expression.  Fortunately, clang supports gcc-extension which allows you to set a cleanup function (destructor analogue) for any variable on the stack that will be called when the variable goes out of scope.  The @onExit macro from libextobjc runs through this extension. <br><br>  To implement the reference count check, an additional structure is needed: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RefCountCheckerData { <span class="hljs-built_in"><span class="hljs-built_in">CFTypeRef</span></span> weakSelf; <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> refCountBefore; };</code> </pre><br>  And the function that will be exposed as cleanup. <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> vbr_CheckRefCountForWeakSelf(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RefCountCheckerData *data) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> refCountAfter = <span class="hljs-built_in"><span class="hljs-built_in">CFGetRetainCount</span></span>(data-&gt;weakSelf); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> countOfSelfRefInBlock = refCountAfter - data-&gt;refCountBefore; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (countOfSelfRefInBlock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { raise(SIGPIPE); } }</code> </pre><br>  Create a structure on the stack, set the cleanup function, and initialize a pointer to the weakSelf and the number of references to it.  The cleanup function will be called when the _private_refCountCheckerData variable goes out of scope, and at this point our block is already in heap. <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = {( __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; __attribute__((cleanup(vbr_CheckRefCountForWeakSelf), unused)) <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RefCountCheckerData _private_refCountCheckerData = { .weakSelf = (__bridge <span class="hljs-built_in"><span class="hljs-built_in">CFTypeRef</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, .refCountBefore = <span class="hljs-built_in"><span class="hljs-built_in">CFGetRetainCount</span></span>((__bridge <span class="hljs-built_in"><span class="hljs-built_in">CFTypeRef</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>), }; ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj) { __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = weakSelf; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@, %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }(); }; });</code> </pre><br>  With this version of the macro, the breakpoint in the debugger will work when trying to access ivar not via self, for example, self.block = ^ {NSLog (@ "% d", _ivarInteger);  }; <br><br>  Before you submit the final version of the macro, you need to bring it into a modern hipster view.  For ObjC, it is fashionable to make macros that begin, like keywords of a language, with @, for example: @strongify, @onExit.  But the preprocessor does not allow using @ as part of the macro name.  In extobjc, for this purpose, use the insert at the beginning of the macro autoreleasepool {} or try {} <a href="https://habrahabr.ru/users/catch/" class="user_link">catch</a> (...) {}, the @ symbol is thus pasted to either try or to autoreleasepool.  After the macro is expanded, an unnecessary empty autoreleasepool or try catch appears in the code, but nobody cares much about it.  However, this approach does not work for weakself macro, because the result of weakself is an expression, and the expression cannot contain @autoreleasepool <a href="https://habrahabr.ru/users/try/" class="user_link">try</a> {} <a href="https://habrahabr.ru/users/catch/" class="user_link">catch</a> (...) {} at the beginning. <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = @weakself(^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> *obj)) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@ %@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description], obj); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } @weakselfend ;</code> </pre><br>  When it comes to complex expressions in C, the ternary operator comes to mind first.  It remains to understand how to apply it.  The first thing that came to mind was to write something like this: self.block = @ 1?  / * here is the block code * /: nil; <br><br>  To do this, just add 1?  weakself and: nil;  at the end of the weakselfend.  But self.block = 1?  / * here is the block code * /: nil;  quite correct expression, so @weakself and weakself will work. <br><br>  Option self.block = @ []?  / * here is the block code * /: nil;  does not allow using @weakself without @, however, after checking the disassembler, it turned out that the optimizer does not throw away the creation of an empty array, but this is an extra overhead at runtime. <br><br>  Finally, I got the idea to use the features of String Literal Concatenation in ObjC. <br><pre> <code class="hljs ruby">const char *s<span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-string"><span class="hljs-string">"ABC"</span></span> <span class="hljs-string"><span class="hljs-string">"DEF"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   C- <span class="hljs-string"><span class="hljs-string">"ABCDEF"</span></span> NSString *s1 = @<span class="hljs-string"><span class="hljs-string">"ABC"</span></span> @<span class="hljs-string"><span class="hljs-string">"DEF"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ObjC- @<span class="hljs-string"><span class="hljs-string">"ABCDEF"</span></span> NSString *s2 = @<span class="hljs-string"><span class="hljs-string">"ABC"</span></span> <span class="hljs-string"><span class="hljs-string">"DEF"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ObjC- @<span class="hljs-string"><span class="hljs-string">"ABCDEF"</span></span> NSString *s3 = <span class="hljs-string"><span class="hljs-string">"ABC"</span></span> @<span class="hljs-string"><span class="hljs-string">"DEF"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    </code> </pre><br>  So, the final version of the macro: <br><pre> <code class="hljs rust">#define weakself(ARGS) \ <span class="hljs-string"><span class="hljs-string">"weakself should be called as @weakself"</span></span> @<span class="hljs-string"><span class="hljs-string">""</span></span> ? \ ({ __weak <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) _private_weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; \ ARGS { \ __strong <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(_private_weakSelf) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> __attribute__((unused)) = _private_weakSelf; \ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (void) { #define weakselfnotnil(ARGS) \ <span class="hljs-string"><span class="hljs-string">"weakself should be called as @weakself"</span></span> @<span class="hljs-string"><span class="hljs-string">""</span></span> ? \ ({ __weak <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) _private_weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; \ ARGS { \ __strong <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(_private_weakSelf) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> __attribute__((unused)) = _private_weakSelf; \ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ^ (void) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) #define weakselfend \ try {} @finally {} } (); }; \ }) : nil</code> </pre><br>  @weakselfnotnil differs in that if by the time the self block is called, the self is already deleted, the block will not be called.  It is suitable only for cases when the block has no return value, otherwise it is not clear what to return in case self has already been deleted.  Made mainly for the safe use of ivar through explicit dereference to self: <br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = @weakselfnotnil(^) { NSLog(@<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>-&gt;_ivar); } @weakselfend;</code> </pre><br><br><h3>  Performance </h3><br>  It‚Äôs probably not worth worrying about performance because there shouldn't be too much overhead.  The trick to add @ to the beginning of a macro is completely thrown away by the optimizer.  With the overhead of calling an additional block things are more interesting.  To check how things are with the overhead costs, we consider 2 cases using macros from libextobjc and our weakself: <br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)m1 { @weakify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> * obj) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)m2 { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = @weakself(^(<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> * obj)) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> description]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } @weakselfend; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">We compile with -O3, open it in Hooper and look at the pseudo-code for both cases.</b> <div class="spoiler_text"><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> -</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m1]</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vst1</span></span></span><span class="hljs-function">.64 {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d8</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d9</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d10</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d11</span></span></span><span class="hljs-function">}, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4:128]</span></span></span><span class="hljs-function">! }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vst1</span></span></span><span class="hljs-function">.64 {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d12</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d13</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d14</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d15</span></span></span><span class="hljs-function">}, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4:128]</span></span></span><span class="hljs-function"> }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_NSConcreteStackBlock</span></span></span><span class="hljs-function">; *</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((sp - 0x40 &amp; !0xf)</span></span></span><span class="hljs-function"> - 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x50</span></span></span><span class="hljs-function">) = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_4</span></span></span><span class="hljs-function"> = 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xc2000000</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_24</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((sp - 0x40 &amp; !0xf)</span></span></span><span class="hljs-function"> - 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x50</span></span></span><span class="hljs-function">) + 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x14</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function">, {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r2</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r3</span></span></span><span class="hljs-function">} }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 retain]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_initWeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(var_24, r5)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r5 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__objc_personality_v0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function"> = *0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xac24</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_52</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_56</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GCC_except_table0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_60</span></span></span><span class="hljs-function"> = &amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_12</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_68</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sp - 0x40 &amp; !0xf)</span></span></span><span class="hljs-function"> - 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x50</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_64</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r1 | 0x1)</span></span></span><span class="hljs-function"> + 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xabc4</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_32</span></span></span><span class="hljs-function"> = 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x1</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r5 setBlock1:(sp - 0x40 &amp; !0xf) - 0x50]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_destroyWeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(var_24)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_Unwind_SjLj_Unregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;var_28)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vld1</span></span></span><span class="hljs-function">.64 {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d8</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d9</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d10</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d11</span></span></span><span class="hljs-function">}, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4:128]</span></span></span><span class="hljs-function">! }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vld1</span></span></span><span class="hljs-function">.64 {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d12</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d13</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d14</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d15</span></span></span><span class="hljs-function">}, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4:128]</span></span></span><span class="hljs-function"> }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">___20</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m1]</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_block_invoke</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_loadWeakRetained</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0 + 0x14)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 description]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 retain]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NSLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@"%@", r5)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r5 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x0</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> -</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m2]</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_NSConcreteStackBlock</span></span></span><span class="hljs-function">; *</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sp - 0x18)</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_4</span></span></span><span class="hljs-function"> = 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xc2000000</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r3</span></span></span><span class="hljs-function">, {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r2</span></span></span><span class="hljs-function">} }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_initWeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((sp - 0x18)</span></span></span><span class="hljs-function"> + 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x14</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_retainBlock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sp - 0x18)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_destroyWeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((sp - 0x18)</span></span></span><span class="hljs-function"> + 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x14</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 setBlock1:r5]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r5 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">___20</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m2]</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_block_invoke</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_loadWeakRetained</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0 + 0x14)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 description]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 retain]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NSLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@"%@", r5)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r5 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x0</span></span></span><span class="hljs-function">; }</span></span></code> </pre><br></div></div><br>  It turns out that weakself is more efficient than @ weakify / strongify, the internal additional block is completely zainlaynitsya and _block_invoke in both cases looks the same.  But the way that in extobjc "eat" @ at the beginning of the macro adds a useless code for exception handling in runtime, as seen by _Unwind_SjLj_Unregister. <br><div class="spoiler">  <b class="spoiler_title">In the case of compiling with -Os, everything is not so good, the block is not inline and instead of one _block_invoke two are generated.</b> <div class="spoiler_text"><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">___20</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m2]</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_block_invoke</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objc_loadWeakRetained</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0 + 0x14)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_NSConcreteStackBlock</span></span></span><span class="hljs-function">; *</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sp - 0x18)</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_4</span></span></span><span class="hljs-function"> = 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xc2000000</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asm</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function">, {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r2</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r3</span></span></span><span class="hljs-function">} }; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var_20</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 retain]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">___20</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m2]</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_block_invoke_2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sp - 0x18)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[var_20 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r5</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">___20</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ViewController m2]</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_block_invoke_2</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = *</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0 + 0x14)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 description]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r4</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r0 retain]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NSLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@"%@", r4)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[r4 release]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x0</span></span></span><span class="hljs-function">; }</span></span></code> </pre><br></div></div><br>  Unfortunately, the clang does not yet allow adding the always_inline attribute to the block. <br>  Full source code and autocomplete for Xcode <a href="https://gist.github.com/notorca/9192459">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/232185/">https://habr.com/ru/post/232185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232175/index.html">Risk management for foreign patenting</a></li>
<li><a href="../232177/index.html">Let's pedal Vim</a></li>
<li><a href="../232179/index.html">Computer Science Center launches MOOCs on the basics of programming</a></li>
<li><a href="../232181/index.html">Amazon has become a domain name registrar.</a></li>
<li><a href="../232183/index.html">Russian team Brainy Studio becomes the world champion of the Imagine Cup 2014 in the gaming category</a></li>
<li><a href="../232189/index.html">Cashier check design</a></li>
<li><a href="../232191/index.html">Dalek.js - simple functional testing of web applications.</a></li>
<li><a href="../232193/index.html">Everything that I didn‚Äôt understand about the Firefly device was on an Arctic yacht</a></li>
<li><a href="../232195/index.html">Enlarge your pension-2: Rebalancing. Add risk to reduce risk!</a></li>
<li><a href="../232197/index.html">When the game interface itself becomes part of the plot and the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>