<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What to do if Black Friday is tomorrow, and your servers are not ready</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For those who mess up with marketing or just hit the jet, ‚ÄúBlack Friday‚Äù is HYIP, insane orders and crowds of customers. 

 It is necessary to prepare...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What to do if Black Friday is tomorrow, and your servers are not ready</h1><div class="post__text post__text-html js-mediator-article">  For those who mess up with marketing or just hit the jet, ‚ÄúBlack Friday‚Äù is HYIP, insane orders and crowds of customers. <br><br>  It is necessary to prepare infrastructure for an influx in advance, but who thinks about such things in advance?  And sometimes, the decision on participation is made the day before. <br><br>  So, the holiday of consumerism has started, the servers of the online store start to blink merrily, the call center overheats, and the delivery services offer delivery somewhere in January. <br>  What to do, relax and look at fakapy philosophically, or bravely to fight? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/ue/-w/8b/ue-w8bfnunh48ekqvwsgloqmfvs.jpeg"><br><a name="habracut"></a><br>  I accompanied the server infrastructure of online stores during Black Friday, and never approached me in advance and did not give me time to prepare.  I share my experience with those who will receive the same order today. <br><br>  (You are lucky if you can do it right, that is, set up monitoring for several months, analyze traffic, bottlenecks, project architecture, conduct stress tests, if necessary, rebuild the architecture together with the developers, pre-connect additional server capacities.  We'll talk about the right approach some other time, here we will talk about fire fighting measures). <br><br><h2>  We set up monitoring </h2><br>  I think monitoring is primary anyway.  There will still be problems, but thanks to the monitoring schedules one can understand where the bottlenecks are now. <br><br>  If possible, I use Zabbix / Prometheus / ELK solutions (depending on the architecture), if not, I quickly connect the SaaS type okmeter.io.  Even if the sale lasts only a day, you can not look at the monitor at a bunch of indicators like a Zulu day in a row. <br><br>  Another great tool is blackfire.io/newrelic.com for profiling, pinba.org for analyzing the ‚Äúslowing down‚Äù pages in general. <br><br>  blackfire / newrelic will help to make out the problem on a particular page, pinba will help you see which pages are overloaded and run the longest (this is all out of the box in Beatrix, for example, but try logging in to its admin panel and working there). the site is already very bad). <br><br><h2>  Cut off the excess </h2><br>  I disable everything that can be turned off: conditionally unnecessary modules at the moment, all sorts of beautiful, etc. <br><br>  Sale - a simple process, a big discount on a number of products.  A visitor with burning eyes wants to choose a product before it has been bought, to place an order, get a discount, make a payment. <br>  Subscribing to the newsletter, registering on the site, polling about the quality of service - the client is not interested in all this now, these modules can be disabled or simplified.  Turning off everything, without which the site can easily work a couple of days. <br><br>  A case from practice: during Black Friday, I spent debugging on a running server under heavy traffic, and after 2 hours it turned out that the delivery service module, which accesses external services and automatically calculates the shipping cost for each order, brakes wildly.  When traffic grew hundreds of times, these external services simply stopped coping. <br><br>  You can just sit down and think, and what could fall on your site / mobile app / etc? <br><br><h2>  Allow to fall </h2><br>  I am preparing for the fact that any service will still fall.  In this case, it is necessary to show visitors at least something. <br><br>  For example, an inoperative delivery service module or payment form should not block an order as a whole, the user may come the next day and complete their order. <br><br>  On the pages of 50x errors, I show mail or phone number of the sales department. <br><br><pre><code class="plaintext hljs">error_page 500 502 503 504 /50x.html; location = /50x.html { root /srv/www/yourwebsite.com/htdocs/sale-contacts/; }</code> </pre> <br><h2>  Raise a copy of the site </h2><br>  If it is possible to have a copy of the site for testing the changes, this is very good.  I'm not talking about the well-established deployment system :) <br><br>  By the way, fashionable cloud services will allow you to quickly and easily make a copy of the combat server. <br><br>  A case from practice: one site, the infrastructure of which I helped maintain during Black Friday, after the developers optimized (partially on the go), added resources, optimized the software, it began to work more or less with heavy traffic, but still very much braked when placing orders.  Users thought that the orders were not being sent, and just in case they pressed the checkout button several times.  Several figures pressed the button 300 times!  Great stress test :) Hundreds of times more visitors, and some 300 orders more!  :) <br><br><h2>  CDN services </h2><br>  You can do without a CDN, but if the servers cannot objectively cope with the return of the required amount of static, it is imperative. <br><br>  You can quickly connect CDN for popular CMS type <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D38%26LESSON_ID%3D2353">1C-Bitrix</a> , <a href="https://www.wpbeginner.com/showcase/best-wordpress-cdn-services/">Wordpress</a> .  But you will not adjust CDN exactly on the move, you will have to take care in advance. <br><br><h2>  AntiDDoS </h2><br>  I also highly recommend connecting AntiDDoS services, and be sure to advance (otherwise under a sudden load, without adaptation to normal traffic, they can start blocking legitimate visitors). <br><br>  For a certain period it can be done for free: <br><br><ul><li>  qrator.net, 10 days for free, if you have Bitrix - <a href="https://www.1c-bitrix.ru/ddos/">https://www.1c-bitrix.ru/ddos/</a> </li><li>  DDoS-Guard, there is a free tariff - <a href="https://ddos-guard.net/ru/store/web">https://ddos-guard.net/ru/store/web</a> </li><li>  <a href="https://cloudflare.com/">Cloudflare.com</a> , there is a free tariff (but they recommend at least the first paid tariff, and remember that their ip-addresses are often blocked in the Russian Federation) </li></ul><br><h2>  Add server capacity </h2><br>  We foresee the possibility to add resources.  You can add resources to the main server, create a new node for parallelizing queries, a node for mysql, etc.  If not you yourself, then outsourced outsourcers will thank you so much for that. <br>  Conveniently, if your provider has the ability to host physical and cloud servers (Selectel.ru, Servers.com). <br><br><h2>  Whew, let's go </h2><br>  The most dangerous is the first minutes after the mailings.  The cache has not yet been warmed up, there are few statistics, you still do not know the capabilities of the system (if you have not performed serious tests in advance). <br><br><h2>  Some configs </h2><br><h4>  Caching in nginx </h4><br>  Let's make a cache of 500 MB in size for 3 hours for all pages, except order pages. <br><br><pre> <code class="plaintext hljs">proxy_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=blackfriday_cache:180m max_size=500m inactive=7d; #  blackfriday_cache,  180  proxy_cache_key "$request_method$scheme$host$request_uri"; proxy_cache_use_stale error timeout invalid_header http_500; map $uri $cookie_nocache { #     ,   ; 1 - , 0 -  "/order" "1"; "/bitrix" "1" default "0"; } location / { .... proxy_hide_header "Set-Cookie"; #       proxy_ignore_headers "X-Accel-Expires"; proxy_ignore_headers "Expires"; proxy_ignore_headers "Cache-Control"; proxy_ignore_headers "Set-Cookie"; add_header X-Cache $upstream_cache_status; ... proxy_no_cache $cookie_nocache; #  ,   map;  1 -   proxy_cache blackfriday_cache; #    proxy_cache_valid 180m; #  180  proxy_cache_valid 404 1m; # 404  -   1  .... proxy_pass http://backend; #     } location @backend { .... #   }</code> </pre> <br>  Additional materials a lot, links: <br><br><ul><li>  <a href="https://habr.com/post/124684/">habr.com/post/124684</a> </li><li>  <a href="http_proxy_module.html">nginx.org/ru/docs/http/ngx_http_proxy_module.html</a> </li></ul><br>  100 mbit channel allows you to give 12 pages weighing 1 MB per second, it is 43 thousand per hour;  nginx is able to give such volume even on an inexpensive server. <br><br><h4>  Distribute requests across multiple nodes (the site must be ready to work with several web nodes) </h4><br><br><h5>  Via Round-Robin DNS </h5><br><br>  (be careful here, this method is no longer supported correctly by many DNS providers) <br><br><pre> <code class="plaintext hljs">$ dig lifehacker.ru +short 136.243.37.180 136.243.37.178</code> </pre> <br><br><h5>  Via nginx upstreams </h5><br><br><pre> <code class="plaintext hljs">$ cat nginx.conf upstream backend { server backend1.yoursite.com; server backend2.yoursite.com; } server { server_name yoursite.com; location / { proxy_pass http://backend; } } location @backend { .... #   }</code> </pre> <br><br><h5>  Through Cloudflare, Qrator, etc. </h5><br>  They have the ability to set several backends right from the panel, the configuration update is usually instant. <br><br><h2>  Calmly </h2><br>  It happens that it is impossible to provide an ideal job, but the main thing for business is that the system works in principle.  Let it slow down, but it should allow users to make orders, and not endlessly click on F5.  Thousands of clients simultaneously use the ‚Äúmiserable, slowing down, bringing everyone into the nerves‚Äù, and they do, they do, they do orders, and each of them is valuable.  I saw examples when in one day the store made a semi-annual turnover, and the result was worth all the nerves. <br><br>  Successful sales to you :) </div><p>Source: <a href="https://habr.com/ru/post/430710/">https://habr.com/ru/post/430710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430700/index.html">A unified online movie viewing system will start working in Russia</a></li>
<li><a href="../430702/index.html">Very strange training</a></li>
<li><a href="../430704/index.html">How artificial intelligence technologies help Aviasales grow: seven examples</a></li>
<li><a href="../430706/index.html">New theory of evolution</a></li>
<li><a href="../430708/index.html">Tic Tac Toe "Without Borders"</a></li>
<li><a href="../430712/index.html">NeurIPS: how to conquer the best ML conference</a></li>
<li><a href="../430714/index.html">VMware buys Heptio - what does this mean for Kubernetes</a></li>
<li><a href="../430718/index.html">What objects should use cloud video surveillance?</a></li>
<li><a href="../430720/index.html">Intel RealSense D435i: a small update and a small historical excursion</a></li>
<li><a href="../430722/index.html">PHP performance: we plan, profile, optimize</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>