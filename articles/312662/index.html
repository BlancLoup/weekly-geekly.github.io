<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP multithreaded server implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This publication does not pretend to complete the solution of the question. The server is developed for informational purposes only. Many important is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP multithreaded server implementation</h1><div class="post__text post__text-html js-mediator-article">  This publication does not pretend to complete the solution of the question.  The server is developed for informational purposes only.  Many important issues, such as, for example, error handling of sockets, are omitted.  To implement a multi-threaded server, we will use, of course, threads.  Very often you have to see the phrase that, they say, there are no threads in PHP.  So this is not true.  There are threads, but they are implemented in a separate <a href="http://php.net/manual/ru/book.pthreads.php">pthreads</a> extension. <br><a name="habracut"></a><br>  First we need to build PHP compiled with thread safety flag.  I use Windows for work, so I downloaded the finished package <a href="http://windows.php.net/download/">here</a> .  You just need to choose the OS bit, the correct PHP version and, of course, the Thread Safe version.  During the article it will be assumed that we have unpacked the archive with PHP into the C: \ php directory.  Next, we need to install the pthreads extension.  Go <a href="http://windows.php.net/downloads/pecl/releases/pthreads/">here</a> and select the version corresponding to the downloaded version of PHP and system capacity.  From the archive, copy the file php_pthreads.dll to the directory C: \ php \ ext and the file pthreadVC2.dll in the directory C: \ php and C: \ Windows \ System32.  In the C: \ php directory, rename the php.ini-development file in php.ini and add the following line to it: <br><br><pre><code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php_pthreads</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dll</span></span></span></span></code> </pre> <br>  We also find and unravel the extension_dir directive and set it to the value ‚ÄúC: \ php \ ext‚Äù (in my version of PHP7, relative paths did not work).  Open the command prompt and check: <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span></span>.exe -v</code> </pre> <br>  At the end of the first line of output, we should see a mark (ZTS).  We proceed directly to the implementation of the server.  Create a file (in my case it will be located at C: \ server.php. First, create a socket that will listen to port 8080 on our local machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="php hljs">$server = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); socket_bind($server, <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>); socket_listen($server);</code> </pre> <br>  Next, create a pool of workers. <br><br><pre> <code class="php hljs">$pool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pool(<span class="hljs-number"><span class="hljs-number">10</span></span>, Worker::class);</code> </pre> <br>  The first argument sets the maximum number of valid threads, the second class name of the worker.  For any more specific tasks, you can describe your class, inheriting it from the class Worker.  We will use the original class.  Looking ahead, I‚Äôll say that the installed class in the thread class can be obtained through $ this-&gt; worker. <br><br>  Next, we will implement a class that will be executed in a separate thread.  The class must inherit from Threaded. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Task</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Threaded</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket)) { $response = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: 12\r\n\r\nHello world!"</span></span>; socket_write(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $response, strlen($response)); <span class="hljs-comment"><span class="hljs-comment">//        zend_mm_heap currupted,        //socket_close($this-&gt;socket); } } }</span></span></code> </pre><br>  Our class accepts a socket connection to the client in the constructor.  Also, actions performed in a stream must be described in the run () method.  In my case, this is the response of the client to the basic headers and ‚ÄúHello world!‚Äù Text. <br><br>  Next, we will cyclically try to accept connections from the client, and, if successful, create a separate thread and pass the socket descriptor there. <br><br><pre> <code class="php hljs">$servers = [$server]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $read = $servers; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket_select($read, $write, $except, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; in_array($server, $read)) { $task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task(socket_accept($server)); $pool-&gt;submit($task); } }</code> </pre><br>  Since we are using an infinite loop, I will register a function that will be executed when the script exits and stops the pool.  The function should be registered before the start of the cycle. <br><br><pre> <code class="php hljs">register_shutdown_function(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server, $pool)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($server)) { socket_close($server); } $pool-&gt;shutdown(); });</code> </pre><br>  Actually everything.  We start the server at the command line and try to open <a href="http://localhost/">localhost</a> : 8080 in the browser. <br><br><pre> <code class="hljs tex">cd C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">php</span></span></span></span>.exe server.php</code> </pre> <br>  Below is the full server code. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $server = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); socket_bind($server, <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>); socket_listen($server); $pool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pool(<span class="hljs-number"><span class="hljs-number">10</span></span>, Worker::class); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Task</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Threaded</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket)) { $response = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: 12\r\n\r\nHello world!"</span></span>; socket_write(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $response, strlen($response)); } } } register_shutdown_function(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server, $pool)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($server)) { socket_close($server); } $pool-&gt;shutdown(); }); $servers = [$server]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $read = $servers; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket_select($read, $write, $except, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; in_array($server, $read)) { $task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task(socket_accept($server)); $pool-&gt;submit($task); } }</code> </pre> <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/312662/">https://habr.com/ru/post/312662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312652/index.html">Creating shared storage based on CEPH RBD and GFS2</a></li>
<li><a href="../312654/index.html">Blockchain decomposition</a></li>
<li><a href="../312656/index.html">Two-factor authentication in Redmine</a></li>
<li><a href="../312658/index.html">Why is it important to check the values ‚Äã‚Äãreturned by the function?</a></li>
<li><a href="../312660/index.html">Free seminar "Operation of the data center: what you need to do yourself", October 27, Moscow</a></li>
<li><a href="../312664/index.html">Moscow part of the hackathon TADHack: tomorrow</a></li>
<li><a href="../312666/index.html">5 reasons why employers do not like remote workers (and 4 ways to get a job anyway)</a></li>
<li><a href="../312668/index.html">‚ÄúHi, Siri. Turn on the heaters "- Integration of NooLite smart home with Apple HomeKit</a></li>
<li><a href="../312670/index.html">Promises 101</a></li>
<li><a href="../312672/index.html">As an Android developer, time management got carried away, and what came of it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>