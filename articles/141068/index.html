<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a web terminal emulator on Go using Websocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What are we going to write 
 In the last article, we wrote a simple terminal emulator for PHP. I think now is the time to write something more serious...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a web terminal emulator on Go using Websocket</h1><div class="post__text post__text-html js-mediator-article"><h4>  What are we going to write </h4><br>  In the <a href="http://habrahabr.ru/post/139878/">last article,</a> we wrote a simple terminal emulator for PHP.  I think now is the time to write something more serious, on webkets.  What language should I use to work with web socket ..?  Python..?  Ruby ..?  Javascript ..?  Not!  Since Go 1 was released, let's write on it;).  I will try not to repeat myself and not to write the whole code here.  I will cite only interesting, in my opinion, fragments. <br><br><h4>  Demo </h4><br>  Thanks to the user <a href="https://habrahabr.ru/users/aleks_ja/" class="user_link">Aleks_ja</a> for the opportunity to <a href="http://176.9.227.21/term-ws/shell-ws.php">see the terminal emulator in action</a> (you need a browser with the latest version of web sockets, for example, Firefox 11 or the latest Chrome).  From the first time it may not connect, if the daemon does not have time to start in 100 ms - try to refresh the page first. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/dCqXSVPmlAM%3Ffeature%3Doembed&amp;xid=25657,15700002,15700022,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhhUch6AAeowJvREX1baE3Dz3uaFcg" frameborder="0" allowfullscreen=""></iframe>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The source code of the web terminal is available <a href="https://github.com/YuriyNasretdinov/WebTerm">on github</a> .  You need to compile a websok daemon yourself (with the <code>go build</code> ) - this is a small measure of protection against those who like to hack hosters;). <br><a name="habracut"></a><br><h4>  Ingredients </h4><br>  So, we will need: <br><br><ul><li>  Installed <a href="http://golang.org/doc/install">Go language compiler 1</a> </li><li>  Websocket library ( <code>go get code.google.com/p/go.net/websocket</code> ) </li><li>  A browser that supports the latest Websocket specification (for example, the latest Firefox and Chrome) </li><li>  Any web server with PHP (to start the daemon automatically) </li></ul><br><br><h4>  We write a webcam daemon </h4><br>  A web server server and a pseudo-terminal emulator will be combined in our daemon.  Although there is no native support for working with pseudo-terminals in Go, this language is easily integrated with C, so we will use the appropriate C calls to work directly with pseudo-terminals. <br><br><h5>  Work with websockets </h5><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"code.google.com/p/go.net/websocket"</span></span> <span class="hljs-string"><span class="hljs-string">"http"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//  -  func PtyServer(ws *websocket.Conn) { // ws ‚Äî     *websocket.Conn,  //   Read()  Write()  /   } func main() { http.Handle("/ws", websocket.Handler(PtyServer)) //    "/ws"   log.Fatal(http.ListenAndServe(":12345", nil)) //    12345 }</span></span></code> </pre><br><br><h5>  Work with pseudo-terminal </h5><br>  Let's write the binding for forkpty () and ioctl () (in ioctl () we‚Äôll change the size of the terminal‚Äôs window): Go, though, integrates well with C, but doesn‚Äôt understand that pid_t and int are one and the same does not know how to work with a variable number of parameters in C functions. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-comment"><span class="hljs-comment">/* #cgo LDFLAGS: -lutil #include &lt;stdlib.h&gt; #include &lt;sys/ioctl.h&gt; #...     ... int goForkpty(int *amaster, struct winsize *winp) { return forkpty(amaster, NULL, NULL, winp); } int goChangeWinsz(int fd, struct winsize *winp) { return ioctl(fd, TIOCSWINSZ, winp); } */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span></code> </pre><br><br>  In the handler, we use it: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PtyServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ws *websocket.Conn)</span></span></span></span> { cols, rows := <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-comment"><span class="hljs-comment">//    - int var winsz = new(C.struct_winsize) //    "var name = ..." ‚Äî     winsz.ws_row = C.ushort(rows); //         winsz.ws_col = C.ushort(cols); winsz.ws_xpixel = C.ushort(cols * 9); winsz.ws_ypixel = C.ushort(rows * 16); cpttyno := C.int(-1) pid := int(C.goForkpty(&amp;cpttyno, winsz)) pttyno := int(cpttyno) // ... }</span></span></code> </pre><br><br><h5>  Communication between the web socket and the pseudo terminal </h5><br>  Next we have to run, for example, bash and send output from the corresponding descriptor (pttyno) to the web socket, and vice versa, input from the web socket to send pttyno to the input is easy.  A problem occurs when an incomplete UTF-8 sequence comes to us from a pseudo-terminal.  We can read from the pseudo-terminal only in blocks (say, 2 Kb each) and the end of the block can ‚Äúcut‚Äù the UTF-8 character into 2 parts - this ‚Äúscrap‚Äù should not be sent to the browser, otherwise it will simply ignore this fragment.  Here is a small piece of code that correctly handles this situation: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> end = buflen - <span class="hljs-number"><span class="hljs-number">1</span></span>; end &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; end-- { <span class="hljs-comment"><span class="hljs-comment">//    Go    if utf8.RuneStart(buf[end]) { //    ... ch, width := utf8.DecodeRune(buf[end:buflen]) if ch != utf8.RuneError { end += width } break } }</span></span></code> </pre><br><br>  We have to find at the end of the buffer (buf) bytes, which can serve as the beginning of a UTF-8 character (in Go terminology, rune), and then see if this character is intact.  If everything is fine with the last character, then we return the ‚Äúend‚Äù of the buffer back, otherwise we reduce the size of the buffer so that only whole characters are left there. <br><br><h4>  Display output from pseudo-terminal to browser </h4><br>  At first, I used JSLinux to display the output, but its author does not allow modifying and distributing the code of its libraries, so let's take the <a href="https://github.com/selectel/pyte">selectel / pyte</a> library written by the companions from Selectk ... Wait, it‚Äôs python: (!) <a href="https://github.com/YuriyNasretdinov/pyte">rewrite it in Javascript</a> :)!  The port from a python is not perfect, besides I am not a special python expert, but it does its work - Midnight Commander starts and runs without problems. <br><br><h4>  Accept user input </h4><br>  In order to accept user input, I still borrowed a certain amount of code from the author of JSLinux, the basic principles are <a href="http://unixpapa.com/js/key.html">described here</a> .  I also added the ability to insert some text into the input field at the bottom (for example, passwords) and added mappings for the F1 - F12 keys, as well as for Alt + (left / right arrow).  As it turned out, the values ‚Äã‚Äãof the input characters for F-keys depend on the $ TERM environment variable and for vt100 are not defined at all, since in the VT100 they were not on the keyboard :).  Since pyte is used for output, the $ TERM environment variable must be equal to linux, so we will use the mapping for these keys for this terminal. <br><br><h4>  We start the demon "on demand" </h4><br>  I implemented the web-daemon in such a way that it comes out a minute after the last connection, so it would be convenient if the script itself started the web-daemon when we open the terminal page.  The PHP code for this is very simple: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $PORT = <span class="hljs-number"><span class="hljs-number">13923</span></span>; <span class="hljs-comment"><span class="hljs-comment">// port terminal daemon will be run at system('exec nohup ./ws '.$PORT.' &lt;/dev/null &gt;&gt;ws.log 2&gt;&amp;1 &amp;');</span></span></code> </pre><br><br>  If you do not know what <code>exec</code> , I will explain: this is a special builtin-command in any UNIX shell that forces the shell to replace itself with the process being called.  That is, we will not have the ‚Äúextra‚Äù process of <code>sh -c ./ws ...</code> . <br><br><h4>  Moments that I haven't talked about </h4><br>  I did not talk about the following <a href="https://github.com/YuriyNasretdinov/WebTerm">implementation</a> details: <br><ul><li>  The client communication protocol was a bit complicated to support window resizing <s>, but a bug appeared with the introduction of Russian letters</s> </li><li>  the web daemon is password protected, which is automatically generated at startup and used when connecting </li><li>  use your bashrc to set the necessary terminal settings </li><li>  since no rendering takes place on the server, but only bytes are sent, the daemon loads the server comparable to sshd (i.e., the CPU load is close to zero) </li><li>  javascript's pyte implementation works extremely fast: there is no visible delay when starting Midnight Commander, the bandwidth is several thousand lines of text per second </li><li>  when the browser window is closed, the session ends correctly </li><li>  one demon can serve many clients at the same time without problems </li><li>  due to the use of the &lt;audio&gt; tag and sounds from ubuntu, the terminal is able to ‚Äúbeep‚Äù :) </li></ul><br><br><h4>  Project on github </h4><br>  For those interested, I repeat the links to the githab: <br>  <a href="https://github.com/YuriyNasretdinov/WebTerm">github.com/YuriyNasretdinov/WebTerm</a> - terminal emulator, which I described in the article <br>  <a href="https://github.com/YuriyNasretdinov/pyte">github.com/YuriyNasretdinov/pyte</a> is my implementation of the selectel / pyte library in Javascript (unfortunately not accepted by the developers) </div><p>Source: <a href="https://habr.com/ru/post/141068/">https://habr.com/ru/post/141068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141061/index.html">Scene # 27</a></li>
<li><a href="../141062/index.html">Taxer - submission of the annual report to the pension fund of Ukraine online</a></li>
<li><a href="../141063/index.html">Technology: Autograph</a></li>
<li><a href="../141064/index.html">Swedish mobile operators intend to block VoIP traffic</a></li>
<li><a href="../141067/index.html">Using the GDB Debugger to the Maximum</a></li>
<li><a href="../141069/index.html">Understanding XAML</a></li>
<li><a href="../141070/index.html">IconBIT XFIRE 550DV: review and test portable gaming system with a large touch screen and built-in video decoder</a></li>
<li><a href="../141072/index.html">Canobuvosti, 137th edition</a></li>
<li><a href="../141076/index.html">Part number 7. RNAInSpace - software for semi-automatic RNA construction in space</a></li>
<li><a href="../141078/index.html">Facebook Welcome Page and Other Custom Tabs Guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>