<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From parser posters of the theater in Python to Telegram-bot. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue the story of the development of Telegram-bot to find tickets - HappyTicketsBot, the beginning can be read in the first part . 

 In the se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From parser posters of the theater in Python to Telegram-bot. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/8y/yi/y3/8yyiy3gqtzaykc_qebniilwgv7w.png"><br><br>  We continue the story of the development of Telegram-bot to find tickets - HappyTicketsBot, the beginning can be read <a href="https://habr.com/ru/post/444460/">in the first part</a> . <br><br>  In the second I will talk about the bot itself, share the code, as well as ideas that are most likely not destined to become a reality.  Most of the functionality at the time of creation of the bot was already written in a script format, so the main task was to set up the user interaction interface via a Telegram-messenger.  It turned out not boltologically as in the 1st part, so attention is a lot of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Spoiler: HappyTicketsBot did not fly away to spin on a foreign server, it is local and Russian, but one day (I believe) it will take place =) <br><a name="habracut"></a><br><h3>  1. Starting from scratch </h3><br>  Since there was no experience at all in designing Telegram bots, I had to start with basic articles and tutorials, which are very numerous on the web.  Yes, by the way, what was a back-end at that time, I also had a bad idea)) <a href="https://groosha.gitbooks.io/telegram-bot-lessons/content/">This set of lessons</a> became the most informative and applied.  The module on which interaction was conducted with Telegram - pyTelegramBotAPI ( <a href="https://github.com/eternnoir/pyTelegramBotAPI">github</a> ). <br><br>  The longest took the development of the ideology of decorators, read about them in <a href="https://habr.com/ru/post/141411/">this article</a> .  There in two parts and very understandable. <br><br><h3>  2. Bot interaction script with the user.  Basic search </h3><br>  As already mentioned in the preface and <a href="https://habr.com/ru/post/141411/">the 1st part of the article</a> , almost the entire parsing code was ready.  It remained to change the way the search parameters were set.  Based on this, the script of the bot's behavior was constructed.  Commands available to the user are limited to the following set: <br><br><ul><li>  <i>/ Find</i> - start a new search, </li><li>  <i>/ Reset</i> - reset the search and start a new one, </li><li>  <i>/ LastSearch</i> - <i>returns</i> results using the parameters of the last query </li><li>  <i>/ addURL</i> add the URL of the performance to the interests to track the price reduction, </li><li>  <i>/ checkURL</i> - update the prices of the performances of interest, </li><li>  <i>/ showURL</i> - display all URLs added to the list of interests. </li></ul><br>  In the basic search script <i>/ find, the</i> user moves from one status to another, sequentially entering the necessary filter data.  After entering the last parameter ‚Äî the place of presentation ‚Äî the bill is directly parsed using globally declared dictionaries, where the key is the user ID, the values ‚Äã‚Äãare the entered search parameters. <br><br>  In order to remember the state of the user, they are stored in the database.  To work with it, the Vedis modules are used (a key-value database configurator, read the <a href="https://vedis-python.readthedocs.io/en/latest/">documentation</a> ) and Enum (work with listings, see details <a href="https://docs.python.org/3/library/enum.html">1</a> , <a href="https://pynsk.ru/blog/2016/02/13/enum/">2</a> ). <br><br>  In a separate Myconfig.py configuration file, we set the bot parameters (including the unique token received from Telegram) and list the statuses a user can be in.  They came out a bit. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Enum token = <span class="hljs-string"><span class="hljs-string">"4225555:AAGmfghjuGOI4sdfsdfs5656sdfsdf_c"</span></span> <span class="hljs-comment"><span class="hljs-comment"># ,   (  ) db_file = "Mydatabase.vdb" class States(Enum): """   Vedis    ,        (str) """ S_START = "0" #    S_ENTER_MONTH = "1" S_ENTER_PRICE = "2" S_ENTER_TYPE = "3" S_ENTER_PLACE = "4" S_ENTER_URL="5" #      </span></span></code> </pre> <br>  As a result, we get a straightforward chain of status transitions from one to another. <br><br><img src="https://habrastorage.org/webt/lv/bo/_t/lvbo_tapls7ecna-opdl2rqdcag.jpeg"><br><br>  For storage, use the database Vedis.  The user who sent the message is always initialized via message.chat.id. <br><br><div class="spoiler">  <b class="spoiler_title">The code of the dbwoker.py file, which describes the interaction with the database</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> vedis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vedis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Myconfig <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> config <span class="hljs-comment"><span class="hljs-comment">#      def get_current_state(user_id): with Vedis(config.db_file) as db: try: return db[user_id] except KeyError: #  /     return config.States.S_START.value #  -  #       def set_state(user_id, value): with Vedis(config.db_file) as db: try: db[user_id] = value return True except: print('  !') #   -   return False</span></span></code> </pre> <br></div></div><br>  Below is an example of a handler that is activated by the command / find.  As you can see, in this example there is no data entry - there is only a change of status to ‚ÄúS_ENTER_MONTH‚Äù.  After seeing the message about entering the number, the user enters it and sends a message.  When receiving a message with the status S_ENTER_MONTH, the next stage is initiated.  In case of input errors, the status does not change. <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#   @bot.message_handler(commands=["find"]) def cmd_find(message): state = dbworker.get_current_state(message.chat.id) """    ,         .     .    ,           """ if state == config.States.S_ENTER_MONTH.value: bot.send_message(message.chat.id, "    .   ") elif state == config.States.S_ENTER_PRICE.value: bot.send_message(message.chat.id, "      ,   ") elif state == config.States.S_ENTER_TYPE.value: bot.send_message(message.chat.id, ", -    ,       :( ...") else: #  ""   "0" -   bot.send_message(message.chat.id, "      ") dbworker.set_state(message.chat.id, config.States.S_ENTER_MONTH.value) #  </span></span></code> </pre><br>  If the bot receives a message from the user with the status S_ENTER_MONTH, then the following handler will be launched.  Ideologically, it also happens at other stages of the basic search script. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@bot.message_handler(func=lambda message: dbworker.get_current_state(message.chat.id) == config.States.S_ENTER_MONTH.value) def user_entering_month(message): if not message.text.isdigit(): bot.send_message(message.chat.id, ",    ") return # 1 num[message.chat.id]=message.text #  if int(num[message.chat.id])&gt;12 or int(num[message.chat.id])&lt;1: bot.send_message(message.chat.id, "     1  12.   ") # 2 return url_list[message.chat.id]=take_url(num[message.chat.id]) #  URL-   if url_list[message.chat.id]==[]: #    bot.send_message(message.chat.id, " ,     .     ") return bot.send_message(message.chat.id, "!      .") dbworker.set_state(message.chat.id, config.States.S_ENTER_PRICE.value) #    </span></span></code> </pre><br>  In addition to the standard search, it is possible to save interesting performances. <br><br><h3>  3. Tracking price changes </h3><br>  The user can add URLs to the interest list to receive an alert when the price drops.  We remember that we still have the status S_ENTER_URL which is not limited in the basic search.  AT <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@bot.message_handler(commands=["addURL"]) def cmd_add_url(message): bot.send_message(message.chat.id, " url,   .  https://") dbworker.set_state(message.chat.id, config.States.S_ENTER_URL.value) #  @bot.message_handler(func=lambda message: dbworker.get_current_state(message.chat.id) == config.States.S_ENTER_URL.value) def user_entering_URL(message): perf_url=message.text user_id=message.chat.id try: add_new_URL(user_id,perf_url) bot.send_message(message.chat.id, '    !') dbworker.set_state(message.chat.id, config.States.S_START.value) #    except: bot.send_message(message.chat.id, 'URL !    !') dbworker.set_state(message.chat.id, config.States.S_ENTER_URL.value)</span></span></code> </pre><br>  To store the list, use the .csv file.  To interact with it, you need a couple of functions - writing and reading with checking the price change.  If it changes, we notify the user. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_new_URL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id,perf_url)</span></span></span><span class="hljs-function">:</span></span> WAITING_FILE = <span class="hljs-string"><span class="hljs-string">"waiting_list.csv"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(WAITING_FILE, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, newline=<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: curent_url=<span class="hljs-string"><span class="hljs-string">'https://'</span></span>+perf_url text=get_text(curent_url) <span class="hljs-comment"><span class="hljs-comment">#   1   minPrice, name,date,typ,place=find_lowest(text) user = [str(user_id), perf_url,str(minPrice)] writer = csv.writer(file) writer.writerow(user)</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">The price update feature code is slightly longer.</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_prices</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot)</span></span></span><span class="hljs-function">:</span></span> WAITING_FILE = <span class="hljs-string"><span class="hljs-string">"waiting_list.csv"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(WAITING_FILE, <span class="hljs-string"><span class="hljs-string">"r"</span></span>, newline=<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: reader = csv.reader(file) waitingList=[] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> reader: waitingList.append(list(row)) L=len(waitingList) lowest={} <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(WAITING_FILE, <span class="hljs-string"><span class="hljs-string">"w"</span></span>, newline=<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fl: writer = csv.writer(fl) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(L): lowest[waitingList[i][<span class="hljs-number"><span class="hljs-number">1</span></span>]]=waitingList[i][<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-comment"><span class="hljs-comment">#   URL  for k in lowest.keys(): text=get_text('https://'+k) minPrice, name,date,typ,place=find_lowest(text) #    1   if minPrice==0: #   minPrice=100000 if int(minPrice)&lt;int(lowest[k]): #   ,    lowest[k]=minPrice #    for i in range(L): if waitingList[i][1]==k: #  -  URL   waitingList[i][2]=str(minPrice) #  bot.send_message(int(gen[i][0]),'   '+k+'    '+str(minPrice)) writer.writerows(waitingList) #     .    ... ...</span></span></code> </pre><br></div></div><br>  As a result, by the command <i>/ checkURL, the</i> user can get such a result (now I understand that the name of the performance should also be output, but these are things from the ‚Äúhands have not reached‚Äù series). <br><br><img src="https://habrastorage.org/webt/0k/ub/jm/0kubjmqdhjx8ubnsu9y6nhtv3ue.png"><br><br>  Okay, okay.  We can search, we can track.  A couple of friends began to use the bot, I wanted to know who they were and what they were looking for.  This information is good to write to the logs. <br><br><h3>  4. We write activity and errors in the logs </h3><br>  This will help us module Logging.  Information is recorded only at the stage of completion of the basic search, in the handler, in which the user status is transferred from S_ENTER_PLACE to S_START.  Recording errors, in turn, occurs when they occur. <br><br>  I will not be able to say a lot about how the module works, so it‚Äôs better to turn to information <a href="https://python-scripts.com/logging-python">outside</a> . <br><br><img src="https://habrastorage.org/webt/qw/qz/aw/qwqzawdhboak-neygxxyrknafce.png"><br><br><div class="spoiler">  <b class="spoiler_title">Logger description</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_logs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(str)</span></span></span><span class="hljs-function">:</span></span> loggerInfo.info(str) <span class="hljs-comment"><span class="hljs-comment">#    logging.basicConfig(format = u'%(levelname)-8s [%(asctime)s] %(message)s', level = logging.ERROR, filename = u'loggerErrors.log') global loggerInfo loggerInfo = logging.getLogger(__name__) loggerInfo.setLevel(logging.INFO) handler = logging.FileHandler('loggerUsers.log') handler.setLevel(logging.INFO) formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s') handler.setFormatter(formatter) loggerInfo.addHandler(handler) log = logging.getLogger("ex")</span></span></code> </pre><br></div></div><br>  Because the connection was broken, the bot periodically crashed, so the Internet connection error was caught and the bot restarted automatically after 10 seconds.  But this did not always save, so I kept running TeamViewer, in order to raise if necessary. <br><br><h3>  5. Unrealized </h3><br>  We have a bot that replaces the functionality of the script, but allows you to receive information in a convenient form inside the messenger.  He closed my basic needs. <br><br>  Showdown with the modules and writing slender handlers lasted about a month in the mode of work on weekends and sometimes in the evenings.  At the end of this period, interest has already begun to fade and the functional is stuck at the starting point.  It was not possible to break through the principles of work on the webhook, and then Telegram was blocked.  Before that, there was a plan to launch a back-end on a working server, but ... vpn for the sake of it will not be put there =) <br><br>  Here is what is left in the plans, some of which may be realized once on a languid summer / winter evening: <br><br><ul><li>  load testing with a large flow of users.  It is not yet clear whether the bot will work stably and not confuse users; </li><li>  notification of the appearance of a new performance in the artist's schedule.  I have a lot of favorite ‚Äúwhite rabbits‚Äù, I don‚Äôt keep track of everyone (and I would like to); </li><li>  notification of the sale of tickets of a certain category.  There was one acquaintance, an amateur of the first row of an orchestra who is difficult to catch manually; </li><li>  Regular automatic checking of URLs of interest for a timer price reduction.  Now this is done on command, the timer could not be adjusted quickly, so it left it simple; </li><li>  preservation of its history of visits to performances.  Somewhere in the .csv file, the date-name-composition of performers-your comment, so as not to lose; </li><li>  search for a given category of tickets.  To set not only the price, but also the sector (parter-benoir, etc.); </li><li>  transfer everything to the skill for Alice.  why not? </li><li>  make a mobile application with the same functionality.  why not? </li></ul><br>  There was an approach to the Bolshoi Theater.  In order to catch the tickets for ‚ÄúNureyev‚Äù, it was not possible to pick up the html posters in two evenings, so it was also postponed to the list of unrealized. <br><br><h4>  TOTAL </h4><br>  Laziness was the engine of progress and she stopped him.  It didn‚Äôt come to the point of uploading the bot to a third-party server, it still requires more extensive competencies and knowledge of the Web.  The project turned out to be interesting and allowed to master Python a little better, to see another facet of it (besides the usual Machine learning), and also presented many wonderful evenings in the theater at a bargain price.  Thanks to him for this, he closed the tasks assigned to him. <br><br>  No matter how hard I tried, the article still got a lot of code and little text.  I would be happy to explain the incomprehensible or little described in the comments =) </div><p>Source: <a href="https://habr.com/ru/post/445632/">https://habr.com/ru/post/445632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445612/index.html">Cluster storage for small web clusters based on drbd + ocfs2</a></li>
<li><a href="../445618/index.html">We write an operating system on Rust. Implementation of paging memory (new version)</a></li>
<li><a href="../445620/index.html">What does a UX writer do?</a></li>
<li><a href="../445622/index.html">New in Java 12: The Teeing Collector</a></li>
<li><a href="../445626/index.html">How deep is the rabbit hole? CLRium # 5: Garbage Collector</a></li>
<li><a href="../445638/index.html">Blind internship at the Garage Museum of Contemporary Art</a></li>
<li><a href="../445640/index.html">Programming LibreOffice Base. Part 3</a></li>
<li><a href="../445644/index.html">ProContent 2019: conference for technical writers and anyone who works with texts</a></li>
<li><a href="../445646/index.html">CLion 2019.1: ClangFormat, code highlighting via Clangd, memory view, initial microcontroller support</a></li>
<li><a href="../445648/index.html">Server in the clouds 2.0. We start the server in the stratosphere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>