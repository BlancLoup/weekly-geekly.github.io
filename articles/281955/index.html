<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We solve the problem of caching dynamic JavaScript code on the front-end WordPress</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of developing the anti-spam CleanTalk plugin for WordPress, we faced the problem of caching dynamic JavaScript code on the front end of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We solve the problem of caching dynamic JavaScript code on the front-end WordPress</h1><div class="post__text post__text-html js-mediator-article"><p>  In the process of developing the anti-spam <a href="https://cleantalk.org/">CleanTalk</a> plugin for WordPress, we faced the problem of caching dynamic JavaScript code on the front end of sites.  Namely, if you place JavaScript containing any pieces of code dynamically injected from the backend site, then if there is any page caching plug-in on the site, it becomes impossible to use the JavaScript code for its intended purpose. <a name="habracut"></a></p><br><h2>  Consider an example </h2><br><p>  In the backend we have a template JavaScript code, </p><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $html = <span class="hljs-string"><span class="hljs-string">' &lt;script type="text/javascript"&gt; function ctSetCookie(c_name, value, def_value) { document.cookie = c_name + "=" + escape(value.replace(/^def_value$/, value)) + "; path=/"; } ctSetCookie("%s", "%s", "%s"); &lt;/script&gt; '</span></span>; $ct_checkjs_key = rand(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    $field_name = 'ct_checkjs'; //   $ct_checkjs_def = 0; //   $html = sprintf($html, $field_name, $ct_checkjs_key, $ct_checkjs_def); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><p>  An example of frontend output, </p><br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ctSetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c_name, value, def_value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie = c_name + <span class="hljs-string"><span class="hljs-string">"="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">escape</span></span>(value.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^def_value$/</span></span>, value)) + <span class="hljs-string"><span class="hljs-string">"; path=/"</span></span>; } ctSetCookie(<span class="hljs-string"><span class="hljs-string">"ct_checkjs"</span></span>, <span class="hljs-string"><span class="hljs-string">"455"</span></span>, <span class="hljs-string"><span class="hljs-string">"0"</span></span>); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  Accordingly, the JavaScript code gets into the cache in which the value parameter of the ctSetCookie function is unchanged on all pages of the site and is the same for all visitors, which makes it impossible to use JavaScript personally for each visitor.  Consider solutions. </p><br><h2>  We use built-in means to disable caching </h2><br><p>  If the content caching plugin on WordPress is more or less popular, then it most certainly has the means to exclude the list of pages from the cache.  For example, for WP Super cache, you can specify a line in the code of your plugin, </p><br><pre> <code class="php hljs">define( <span class="hljs-string"><span class="hljs-string">"DONOTCACHEPAGE"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> );</code> </pre> <br><p>  This will be enough so that the pages with your dynamic code do not fall into the cache.  Cons of this approach </p><br><ul><li>  You need to integrate and test your plugin with popular caching plugins. </li><li>  Anyway, there will be cases when your code is incorrectly processed, due to the fact that a rarely used caching plugin is installed on a particular site. </li><li>  And most importantly, this approach reduces the use of caching plugins to almost 0, if your JavaScript code is placed on all pages of the site, or on the most loaded pages. </li></ul><br><p>  Let's look at another solution. </p><br><h2>  AJAX call backend </h2><br><p>  The essence of this approach is that at the frontend we place only static JavaScript code, and all that needs to be used is dynamically obtained from the backend of the site via an AJAX call.  Sample code for frond, </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// //    admin-ajax.php // function sendRequest(url,callback,postData) { var req = createXMLHTTPObject(); if (!req) return; var method = "GET"; req.open(method,url,true); if (postData) req.setRequestHeader('Content-type','application/x-www-form-urlencoded'); req.onreadystatechange = function () { if (req.readyState != 4) return; if (req.status != 200 &amp;&amp; req.status != 304) { return; } callback(req); }; if (req.readyState == 4) return; req.send(postData); return null; } var XMLHttpFactories = [ function () {return new XMLHttpRequest()}, function () {return new ActiveXObject("Msxml2.XMLHTTP")}, function () {return new ActiveXObject("Msxml3.XMLHTTP")}, function () {return new ActiveXObject("Microsoft.XMLHTTP")} ]; function createXMLHTTPObject() { var xmlhttp = false; for (var i=0;i&lt;XMLHttpFactories.length;i++) { try { xmlhttp = XMLHttpFactories[i](); } catch (e) { continue; } break; } return xmlhttp; } // //   AJAX . // function ct_callback(req) { ct_cookie=req.responseText.trim(); ct_setCookie('ct_checkjs', ct_cookie); return null; } // //   // function ct_setCookie(name, value) { document.cookie = name+" =; expires=Thu, 01 Jan 1970 00:00:01 GMT; path = /"; document.cookie = name+" =; expires=Thu, 01 Jan 1970 00:00:01 GMT"; var date = new Date; date.setDate(date.getDate() + 1); setTimeout(function() { document.cookie = name+"=" + value + "; expires=" + date.toUTCString() + "; path = /;"}, 500); return null; } var ct_ajaxurl = 'http://wordpress.local/wp-admin/admin-ajax.php'; sendRequest(ct_ajaxurl+'?'+Math.random(),ct_callback,'action=ct_get_cookie');</span></span></code> </pre> <br><p>  Please pay attention to the design, </p><br><pre> <code class="javascript hljs">ct_ajaxurl+<span class="hljs-string"><span class="hljs-string">'?'</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random()</code> </pre> <br><p>  This technique is used to exclude caching, including the AJAX call. </p><br><p>  Moving to the last listing, look at the backend, </p><br><pre> <code class="php hljs">add_action( <span class="hljs-string"><span class="hljs-string">'wp_ajax_nopriv_ct_get_cookie'</span></span>, <span class="hljs-string"><span class="hljs-string">'ct_get_cookie'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-comment"><span class="hljs-comment">/** *    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ct_get_cookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $ct_checkjs_def; $ct_checkjs_key = ct_get_checkjs_value(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $ct_checkjs_key; <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(); }</code> </pre> <br><p>  There is only one downside to this approach - your plugin makes 1 more call to the WordPress backend more.  Taking into account the fact that hosting may not be the fastest, or more than a dozen plug-ins can be installed on WordPress, such a call will lead to an increase in the site response time. </p><br><p>  Good luck in developing under WordPress! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/281955/">https://habr.com/ru/post/281955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281937/index.html">Standard for managing access rights to corporate file information resources</a></li>
<li><a href="../281941/index.html">35 useful virtualization tools</a></li>
<li><a href="../281943/index.html">7 online scanners to search for open ports on the server</a></li>
<li><a href="../281945/index.html">Experience in ensuring the reliability of computing equipment during long-term operation</a></li>
<li><a href="../281949/index.html">Results of the Young Digital Makers Programming Contest</a></li>
<li><a href="../281961/index.html">Top 20 Free Disk Monitoring Tools</a></li>
<li><a href="../281963/index.html">April 20 all day, first time online - IT Director Briefing 2016</a></li>
<li><a href="../281965/index.html">What kind of library to work with HTTP in Android choose?</a></li>
<li><a href="../281967/index.html">JavaScript API Development: 5 Principles for Writing Embedded Scripts</a></li>
<li><a href="../281969/index.html">The great Russian firewall is around the corner.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>