<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automating defragmentation of indexes in MS SQL Server database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 On the Internet you can find a lot of information about defragmentation or rebuilding indexes. However, most recommendations are directed t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automating defragmentation of indexes in MS SQL Server database</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  On the Internet you can find a lot of information about defragmentation or rebuilding indexes.  However, most recommendations are directed to databases that have a minimum load time (mostly at night). <br><br>  And what about databases that are constantly used both to change data and to receive information 24 hours a day, 7 days a week? <br><br>  In this article I will give the implemented mechanism for automating the defragmentation of indexes in the database to support the database in our enterprise.  This mechanism allows you to defragment all the necessary indices all the time, and in the 24x7 system, index fragmentation occurs continuously.  And often defragmentation even once a day is insufficient for indexes. <br><a name="habracut"></a><br><h3>  Decision </h3><br>  First, the general approach: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) to create a representation for the required database, with the help of which it is possible to obtain which indices and how many percent are fragmented <br>  2) create a table to save the results of defragmentation indexes <br>  3) create a stored procedure that will analyze and defragment the selected index <br>  4) create a view to view statistics on the results of index defragmentation <br>  5) create a task in the Agent, which will run the implemented stored procedure in step 3. <br><br>  And now the implementation: <br><br>  1) to create a representation for the required database, with the help of which it is possible to obtain which indices and how many percent are fragmented: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vIndexDefrag] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [object_id], database_id, index_id, index_type_desc, index_level, fragment_count, avg_fragmentation_in_percent, avg_fragment_size_in_pages, page_count, record_count, ghost_record_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_db_index_physical_stats (DB_ID(N<span class="hljs-string"><span class="hljs-string">'__'</span></span>) , <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , N<span class="hljs-string"><span class="hljs-string">'LIMITED'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> index_level = <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> b.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> db, s.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> shema, t.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tb, i.index_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> idx, i.database_id, idx.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> index_name, i.index_type_desc,i.index_level <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>], i.[object_id], i.fragment_count <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> frag_num, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(i.avg_fragmentation_in_percent,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> frag, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(i.avg_fragment_size_in_pages,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> frag_page, i.page_count <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [page], i.record_count <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> rec, i.ghost_record_count <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ghost, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(i.avg_fragmentation_in_percent*i.page_count,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> func <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> i.database_id = b.database_id <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[all_objects] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> i.object_id = t.object_id <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[schemas] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> t.[schema_id] = s.[schema_id] <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">indexes</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> t.object_id = idx.object_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> idx.index_id = i.index_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> i.avg_fragmentation_in_percent &gt;= <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i.index_type_desc &lt;&gt; <span class="hljs-string"><span class="hljs-string">'HEAP'</span></span>; GO</code> </pre> <br></div></div><br><br>  This view displays only those indices whose fragmentation percentage is at least 30. Those indexes that need to be defragmented.  Only those indices that are not heaps are displayed, and the latter, when defragmented, can have a negative effect, expressed either by blocking such a heap, or by even greater fragmentation of the index. <br><br>  The view uses the important system view sys.dm_db_index_physical_stats ( <a href="https://technet.microsoft.com/ru-ru/library/ms188917(v%3Dsql.105).aspx">more</a> ). <br><br>  2) create a table to save the results of defragmentation of indexes: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[Defrag]( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">794</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [db] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [shema] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [IndexName] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [frag_num] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [frag] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [page] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [rec] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [func] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ts] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [tf] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [frag_after] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [object_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [idx] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_Defrag] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]; GO <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[Defrag] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_Defrag_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate]; GO</code> </pre><br></div></div><br>  The main thing in this table is not to forget to delete data (for example, which is more than a month or more often). <br><br>  Fields in the table will be clear on the next item. <br><br>  3) create a stored procedure that will analyze and defragment the selected index: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[AutoDefragIndex] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-comment"><span class="hljs-comment">--   declare @IndexName nvarchar(100) --  ,@db nvarchar(100) --   ,@Shema nvarchar(100) --  ,@Table nvarchar(100) --  ,@SQL_Str nvarchar (2000) --    ,@frag decimal(6,2) --%     ,@frag_after decimal(6,2) --%     --       IN_ROW_DATA ,@frag_num int ,@func int --round(i.avg_fragmentation_in_percent*i.page_count,0) ,@page int ---   ,@rec int -- -  ,@ts datetime --     ,@tf datetime --     --    ,     ,@object_id int ,@idx int; --ID  --     set @ts = getdate(); --     --    .     ,     -- ,         select top 1 @IndexName = index_name, @db=db, @Shema = shema, @Table = tb, @frag = frag, @frag_num = frag_num, @func=func, @page =[page], @rec = rec, @object_id = [object_id], @idx = idx from [srv].[vIndexDefrag] order by func*power((1.0- convert(float,(select count(*) from SRV.[srv].[Defrag] vid where vid.db=db and vid.shema = shema and vid.[table] = tb and vid.IndexName = index_name)) / convert(float, case when (exists (select top 1 1 from SRV.[srv].[Defrag] vid1 where vid1.db=db)) then (select count(*) from SRV.[srv].[Defrag] vid1 where vid1.db=db) else 1.0 end)) ,3) desc --    if(@db is not null) begin --   set @SQL_Str = 'alter index ['+@IndexName+'] on ['+@Shema+'].['+@Table+'] Reorganize'; execute sp_executesql @SQL_Str; --     set @tf = getdate() --     SELECT @frag_after = avg_fragmentation_in_percent FROM sys.dm_db_index_physical_stats (DB_ID(@db), @object_id, @idx, NULL , N'DETAILED') where index_level = 0; --   insert into SRV.srv.Defrag( [db], [shema], [table], [IndexName], [frag_num], [frag], [page], [rec], ts, tf, frag_after, object_id, idx ) select @db, @shema, @table, @IndexName, @frag_num, @frag, @page, @rec, @ts, @tf, @frag_after, @object_id, @idx; --    set @SQL_Str = 'UPDATE STATISTICS ['+@Shema+'].['+@Table+'] ['+@IndexName+']'; execute sp_executesql @SQL_Str; end END</span></span></code> </pre><br></div></div><br><br>  4) create a view to view statistics on the results of index defragmentation: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vStatisticDefrag] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> top <span class="hljs-number"><span class="hljs-number">1000</span></span> [db] ,[shema] ,[<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>] ,[IndexName] ,<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([frag]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgFrag ,<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([frag_after]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgFragAfter ,<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(page) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgPage <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [srv].[Defrag] <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [db], [shema], [<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>], [IndexName] <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([frag])-<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([frag_after])) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; GO</code> </pre><br></div></div><br><br>  This view can be used to notify administrators daily of the work done on automating the defragmentation of indexes. <br><br>  5) create a task in the Agent, which will run the implemented stored procedure in step 3: <br><br>  Here you need to select the time experimentally.  I got about 5 minutes, and about an hour. <br><br>  This algorithm can be extended to several databases, but then you must also enter item 6: <br><br>  Collect all statistics on automating defragmentation of indexes in databases in one place for later sending to administrators. <br><br>  And now I would like to dwell in more detail about the already published recommendations on support for indices: <br><br>  1) defragmentation of all indexes at once during the minimum load of the database - this is unacceptable for 24x7 systems, because the indexes are constantly fragmented and the database is not idle almost. <br><br>  2) rebuilding the index - this operation locks the table or section (in the case of a partitioned index), which is not good for 24x7 systems.  Further, rebuilding the index in real time is supported only in the Enterprise solution, and may also lead to data corruption. <br><br>  This method is not optimal, but successfully copes with the fact that the indices are sufficiently defragmented (no higher than 30-40% of fragmentation) for use by the optimizer for building execution plans. <br><br>  I would be very grateful if in the comments appear argued pros and cons of this approach, as well as proven alternative proposals. <br><br><h3>  Sources: </h3><br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms189858(v%3Dsql.120).aspx">Reorganization and rebuilding indexes</a> <br>  ¬ª <a href="https://technet.microsoft.com/ru-ru/library/ms188917(v%3Dsql.105).aspx">Sys.dm_db_index_physical_stats</a> </div><p>Source: <a href="https://habr.com/ru/post/314454/">https://habr.com/ru/post/314454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314442/index.html">Text translation HighLoad ++ 2016. Day Two</a></li>
<li><a href="../314444/index.html">27 open-source nishtyachkov for iOS developer</a></li>
<li><a href="../314446/index.html">Random number generator without programming and even computer: how to surprise a young programmer?</a></li>
<li><a href="../314448/index.html">Manage development tasks. Life story</a></li>
<li><a href="../314450/index.html">Information security: five ways to protect against cyber attacks</a></li>
<li><a href="../314456/index.html">Canonical has released a new version of Ubuntu Core for IoT applications.</a></li>
<li><a href="../314458/index.html">Attackers continue to use Linux / Moose malware to compromise devices</a></li>
<li><a href="../314460/index.html">David Heinemeyer Hansson: The day I became a millionaire</a></li>
<li><a href="../314462/index.html">We manage the machine on Groovy / Java. As a CNC machine in the home workshop does not turn into a cartoon character "two of the casket"</a></li>
<li><a href="../314464/index.html">The study of graphic voltage based on the model of the electromagnetic field</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>