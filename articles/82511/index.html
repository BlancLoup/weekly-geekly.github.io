<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx + server Javascript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... or how to switch from PHP + JavaScript to JavaScript + JavaScript 
 The idea to implement a project on server side JavaScript has been around for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx + server Javascript</h1><div class="post__text post__text-html js-mediator-article"><h4>  ... or how to switch from PHP + JavaScript to JavaScript + JavaScript </h4><br>  The idea to implement a project on server side JavaScript has been around for a long time.  The problem was the lack of suitable server software.  Existing open projects did not suit for various reasons.  Installing an additional module for <a href="httpd.apache.org/">Apache</a> was not a good idea, because the performance and optimization of memory usage would not be at its best.  Using <a href="http://code.google.com/p/jslibs/">jslibs,</a> you can configure FastCGI, but I really didn‚Äôt want to leave even the slightest chance of ‚Äú502 Bad Gateway‚Äù, the <a href="http_js_module-01/">ngx_http_js_module</a> project remained in the embryonic stage, and <a href="http://code.google.com/p/ngxv8/">ngxv8 is</a> not developed enough to implement real applications.  So I decided to make my own implementation of server javascript.  And try to immediately program all the basic functionality so that you can test it in conditions close to reality. <br><br>  As the main web server, it was decided to use <a href="http://www.nginx.ru/">nginx</a> , as a ‚Äújavascript engine‚Äù - TraceMonkey (a javascript engine from <a href="http://www.mozilla.com/">Mozilla Firefox</a> , formerly SpiderMonkey), and write a module for nginx that would ‚Äústick together‚Äù them.  Nothing complicated at first glance, but I really wanted to have a certain functionality (and it worked out!) So that you could work normally further.  Most of the ideas are borrowed, by the way, from <a href="http://www.php.net/">PHP</a> . <ul><li>  Correct work in multi-thread conditions </li><li>  Ability to execute the script specified in the URL, rather than setting up a separate handler script and handler function for each location </li><li>  Ability to call include (), sleep (), alert () from a script, use __FILE__ and __LINE__ </li><li>  Limit the memory allocated to each script, and the time of the script </li><li>  Protection of files opened by the script, specifying the list of allowed folders in the settings.  Something like <a href="http://ru2.php.net/manual/en/ini.core.php">open_basedir</a> in PHP </li><li>  Automatic parsing of request data (GET, POST, and, of course, cookies), in order not to write javascript data processing </li><li>  Support for application / x-www-form-urlencoded and multipart / form-data requests </li><li>  Basic authorization support </li><li>  Work with databases (first of all, MySQL and SQLite) </li><li>  Working with the file system: reading and writing files, checking for the existence of files, etc. </li><li>  Caching byte-code scripts, such as in <a href="http://eaccelerator.net/">eAccelerator</a> </li></ul>  Plus some other features (tools for templating, for creating configuration files, etc.), but I did not include them in the main list - they can be made possible by the language features of TraceMonkey. <br><br>  From words - to business!  How to compile and configure how to test and compare ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  I do not go deep into the parts of the assembly, otherwise the text will turn out to be incredible sizes.  Users who have experience of ‚Äúbuilding‚Äù programs under Linux will feel quite comfortable, and for everyone else I can offer a <a href="http://js.nnov.ru/nginx/binary.html">binary build</a> and the opportunity to skip the self-compilation process. <br><br>  You will need: <ul><li>  Linux </li><li>  Compilers C and C ++, autoconf 2.13 </li><li>  Nginx sources </li><li>  TraceMonkey from repository </li><li>  <a href="http://www.mozilla.org/projects/nspr/">NSPR</a> library </li><li>  Our module </li><li>  MySQL and SQLite (optional) + development tools </li></ul> The assembly procedure is as follows. <br><br>  First NSPR latest version (at the time of writing - 4.8.2): <br><br> <code><a href=""></a> wget ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.2/src/nspr-4.8.2.tar.gz&lt;br/&gt;tar -xzf nspr-4.8.2.tar.gz&lt;br/&gt;cd nspr-4.8.2/mozilla/nsprpub&lt;br/&gt;./configure --prefix=/usr/local --with-pthreads&lt;br/&gt;make&lt;br/&gt;sudo make install&lt;br/&gt;</code> <br>  Then TraceMonkey from the repository (at the time of writing, version 1.8.5 in the repository, and you can download the source file only for 1.7.0): <br><br> <code><a href="http://hg.mozilla.org/tracemonkey/"></a> hg clone http://hg.mozilla.org/tracemonkey/&lt;br/&gt;cd tracemonkey/js/src&lt;br/&gt;autoconf2.13&lt;br/&gt;./configure --prefix=/usr/local --with-nspr-prefix=/usr/local --with-system-nspr --with-pthreads --enable-threadsafe&lt;br/&gt;make&lt;br/&gt;sudo make install&lt;br/&gt;</code> <br>  This step can be problematic for several reasons.  First, not everyone has the <code>hg</code> command.  And secondly, all Mozilla Firefox sources are downloaded from the repository.  Therefore, the first line of code can be replaced and download the source code only TraceMonkey: <br><br> <code><a href="http://hg.mozilla.org/tracemonkey/"></a> <a href=""></a> # hg clone http://hg.mozilla.org/tracemonkey/&lt;br/&gt;wget http://js.nnov.ru/files/tracemonkey-20100119.tar.gz&lt;br/&gt;tar -xzf tracemonkey-20100119.tar.gz&lt;br/&gt;</code> <br>  And then compile. <br><br>  Next nginx (0.8.32) and the javascript module: <br><br> <code><a href=""></a> <a href="http://nginx-javascript.googlecode.com/svn/trunk/"></a> wget http://sysoev.ru/nginx/nginx-0.8.32.tar.gz&lt;br/&gt;tar -xzf nginx-0.8.32.tar.gz&lt;br/&gt;cd nginx-0.8.32/src/http/modules&lt;br/&gt;svn co http://nginx-javascript.googlecode.com/svn/trunk/ javascript&lt;br/&gt;cd ../../..&lt;br/&gt;./configure --prefix=/usr/local/nginx-javascript --add-module=src/http/modules/javascript&lt;br/&gt;make&lt;br/&gt;sudo make install&lt;br/&gt;</code> <br>  If everything turned out - go to the setting.  Happy owners of the binary assembly will find that the configuration has already been completed, but once again it will not hurt to check it.  It is enough to perform the following steps: <ul><li>  Add application / x-javascript-serverside type to mime.types for files that will be processed as javascript: <br> <code># /usr/local/nginx-javascript/conf/mime.types&lt;br/&gt;types {&lt;br/&gt;    ...&lt;br/&gt;    application/x-javascript-serverside jsx;&lt;br/&gt;    ...&lt;br/&gt;}&lt;br/&gt;</code> <br>  The .jsx extension is selected instead of the standard .js, so that the server does not process the usual java-scripts as server ones </li><li>  Allow javascript processing in the location / nginx.conf file.  At the same time, we will change the port number on which the server will work: <br> <code># /usr/local/nginx-javascript/conf/nginx.conf&lt;br/&gt;...&lt;br/&gt;    server {&lt;br/&gt;        listen 8081;&lt;br/&gt;        ...&lt;br/&gt;        location / {&lt;br/&gt;            ...&lt;br/&gt;            javascript on;&lt;br/&gt;            ...&lt;br/&gt;        }&lt;br/&gt;    }&lt;br/&gt;...&lt;br/&gt;</code> </li> <li>  Run nginx: <br> <code>/usr/local/nginx-javascript/sbin/nginx&lt;br/&gt;</code> </li> <li>  Create a hello.jsx test script: <br> <code>// /usr/local/nginx-javascript/html/hello.jsx&lt;br/&gt;print("Hello, people!");&lt;br/&gt;</code> </li> <li>  Check what hello.jsx looks like in the browser: <br> <code><a href=""></a> curl http://localhost:8081/hello.jsx&lt;br/&gt;</code> </li> </ul>  Having achieved that the server with javascript started working, I wondered how much more profitable this solution was than the standard Apache + PHP.  Since the issues of internal optimization of TraceMonkey and PHP worried me somewhat less (for example, which interpreter performs the cycle of a million steps faster? I suspect that the difference is small), the ‚ÄúHello, people!‚Äù Script was tested first. <br><br>  Participated in the comparison: <ul><li>  Apache / 2.2.14 (prefork) + PHP / 5.2.12 (module) </li><li>  nginx / 0.8.32 (1 workflow) + javascript </li><li>  nginx / 0.8.32 (8 workflows) + javascript </li></ul>  The testing environment is 4-core Xeon with 2GB of RAM and Debian Etch.  All traffic is local.  I don‚Äôt go into the details of the hardware, the configuration details are also more or less standard. <br><br>  First, the test cycle of 1000 requests one by one: <br><br> <code><a href="http://localhost:8085/hello.php"></a> <a href=""></a> <a href=""></a> # Apache 2.2.14 (prefork) + PHP 5.2.12 (module)&lt;br/&gt;ab -n 1000 http://localhost:8085/hello.php&lt;br/&gt;Time per request: <b>5.278</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;# nginx (1 worker) + javascript&lt;br/&gt;ab -n 1000 http://localhost:8081/hello.jsx&lt;br/&gt;Time per request: <b>1.298</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;# nginx (8 workers) + javascript&lt;br/&gt;ab -n 1000 http://localhost:8088/hello.jsx&lt;br/&gt;Time per request: <b>1.322</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;</code> <br>  Now the test loop of 1000 requests when creating 100 simultaneous connections: <br><br> <code><a href="http://localhost:8085/hello.php"></a> <a href=""></a> <a href=""></a> # Apache 2.2 (prefork) + PHP 5.2 (module)&lt;br/&gt;ab -n 1000 -c 100 http://localhost:8085/hello.php&lt;br/&gt;Time per request: <b>1.648</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;# nginx (1 worker) + javascript&lt;br/&gt;ab -n 1000 -c 100 http://localhost:8081/hello.jsx&lt;br/&gt;Time per request: <b>1.277</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;# nginx (8 workers) + javascript&lt;br/&gt;ab -n 1000 -c 100 http://localhost:8088/hello.jsx&lt;br/&gt;Time per request: <b>0.544</b> [ms] (mean, across all concurrent requests)&lt;br/&gt;</code> <br>  Conclusions from testing: <ul><li>  If requests to the server go sequentially, one by one, nginx + javascript works much faster (about 3 times).  At the same time, nginx with one workflow is even slightly faster.  In reality, this situation almost never happens: more often, many customers open different pages at the same time. </li><li>  If server requests are sent at the same time, the speed of apache + php increases (we have shown almost the same speed as nginx + javascript with a single workflow).  But the speed of nginx + javascript with multiple workflows also increases (we have - more than 2 times).  And nginx + javascript with one workflow remained almost unchanged. </li></ul>  Besides the fact that such an implementation of server-side javascript makes it possible to achieve an increase in performance compared to traditional PHP, javascript allows using rather clever language constructs. <br><br> <code>//   id  GET, POST  cookies:&lt;br/&gt;print($request.get['id'], " ", $request.post['id'], " ", $request.cookie['id']);&lt;br/&gt;//   Content-Type:&lt;br/&gt;$result.headers.push("Content-Type: text/html; charset=UTF-8");&lt;br/&gt;//   ,   SELECT  ,   GET,     :&lt;br/&gt;var row = (new SQLite("database")).query("SELECT * FROM `table` WHERE `id`=?", $request.get['id']).fetch();&lt;br/&gt;//  :&lt;br/&gt;print(File.open("index.html").getChars());&lt;br/&gt;//  IP- ,  :&lt;br/&gt;print({$server.remoteAddr});&lt;br/&gt;</code> <br>  In the last example, there is no syntax error; XML documents can actually be used inside scripts.  In this case, you can insert references to variables and calls to functions, enclosing them in braces.  This technology, <a href="https://developer.mozilla.org/en/e4x">E4X</a> , is very convenient for creating templates.  Some more examples can be found at <a href="http://js.nnov.ru/nginx/examples.html">http://js.nnov.ru/nginx/examples.html</a> . <br><br>  Of course, there are a number of problems that need to be gradually solved: <ul><li>  File upload support (coming soon!) </li><li>  Support cURL and GD, without which it is very difficult to live </li><li>  Optimization of the stat () system calls, which are now used to determine the actual path to the file </li></ul>  But, in general, you can use.  By the way, a small site <a href="http://js.nnov.ru/">http://js.nnov.ru</a> is made on JavaScript.  Please do not conduct hard tests for fault tolerance :-) <br><br>  ZY&gt; Special thanks to <a href="https://habrahabr.ru/users/ftm/" class="user_link">FTM</a> for an invite, thanks to which the topic is no longer in the sandbox <br>  UPD&gt; At once would publish in thematic, but there were problems with karma.  Thanks to all involved! <br></div><p>Source: <a href="https://habr.com/ru/post/82511/">https://habr.com/ru/post/82511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../82502/index.html">Reader Brother SV-70</a></li>
<li><a href="../82504/index.html">Robbery in amateurish-2 or how Mail.ru stores passwords</a></li>
<li><a href="../82505/index.html">And medics roam the ports ...</a></li>
<li><a href="../82509/index.html">Description of the process of transferring Ubuntu 9.10 to another hard drive (without using Ghost, Acronis True Image etc ...)</a></li>
<li><a href="../82510/index.html">In the wake of rating compilers</a></li>
<li><a href="../82514/index.html">Fight Memory Leaks (C ++ CRT)</a></li>
<li><a href="../82516/index.html">Idea: direct mail in web studios and advertising agencies</a></li>
<li><a href="../82518/index.html">Google Analytics: Notes are now available for all accounts.</a></li>
<li><a href="../82521/index.html">Canobuvosti, 24th edition</a></li>
<li><a href="../82525/index.html">interface post-up on CentOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>