<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client-server chat using Qt / C ++ sockets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 The article focuses mainly on beginners. The purpose of writing it is a quick and detailed description of sockets, for an initial understan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client-server chat using Qt / C ++ sockets</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  The article focuses mainly on beginners.  The purpose of writing it is a quick and detailed description of sockets, for an initial understanding of the network and sockets.  At one time I was looking for a similar one, but I needed detailed examples.  In the standard example, fortune server / client that comes with qt shows very poorly the capabilities of sockets. <br><br>  So, the server is able: <ul><li>  "Listen" arbitrary address, port </li><li>  Authorize a customer by name </li><li>  Send public, private, server messages </li><li>  Send user list </li></ul>  The client is able to make the appropriate requests to the server. <br><br>  To understand this, Gouy applications will be: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://dl.dropbox.com/u/46279515/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.jpg" alt="image"><br><br>  In qt, there are classes QTcpSocket and QTcpServer for working with sockets.  Using signals and slots, you can work with them in non-blocking (asynchronous mode).  This means if the connection to the server takes a noticeable amount of time, the gui is not blocked, but continues to process events, and when a connection occurs (or an error), a certain slot will be called (in the current case connected to the connected () signal). <br><a name="habracut"></a><br><h4>  Customer </h4><br>  Let's start with a simple one ‚Äî let's not inherit the classes, but use QTcpSocket: <br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//dialog.h class Dialog : public QDialog { private slots: //      void onSokConnected(); void onSokDisconnected(); // readyRead ,     (      )  void onSokReadyRead(); void onSokDisplayError(QAbstractSocket::SocketError socketError); private: QTcpSocket *_sok; // quint16 _blockSize;//    QString _name;//  };</span></span></code> </pre>  In general, when working with sockets, you need to look at the data as a set of bytes, otherwise there may be problems with displaying information only partially (it was not a complete message, and the following is displayed with a piece of the previous one).  To avoid these troubles, we will use data streams (QDataStream) and transfer blocks between sockets in which the first 2 bytes are the size of the current block, the 3rd byte is the client‚Äôs command to the server (or server response), and the rest is data depending on the command.  It is worth saying that the tcp protocol guarantees the delivery of all packets, so you can safely wait for the full block size before processing it. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//dialog.cpp Dialog::Dialog(QWidget *parent) :QDialog(parent),ui(new Ui::Dialog) { //  _sok = new QTcpSocket(this); //  connect(_sok, SIGNAL(readyRead()), this, SLOT(onSokReadyRead())); connect(_sok, SIGNAL(connected()), this, SLOT(onSokConnected())); connect(_sok, SIGNAL(disconnected()), this, SLOT(onSokDisconnected())); connect(_sok, SIGNAL(error(QAbstractSocket::SocketError)),this, SLOT(onSokDisplayError(QAbstractSocket::SocketError))); } //     , ,  connectToHost()   void, ,            onSokDisplayError void Dialog::on_pbConnect_clicked() { _sok-&gt;connectToHost(ui-&gt;leHost-&gt;text(), ui-&gt;sbPort-&gt;value()); } void Dialog::onSokConnected() { //       QByteArray block; QDataStream out(&amp;block, QIODevice::WriteOnly); // 2    .  MyClient    ,        -   //  -  out &lt;&lt; (quint16)0 &lt;&lt; (quint8)MyClient::comAutchReq &lt;&lt; ui-&gt;leName-&gt;text(); _name = ui-&gt;leName-&gt;text(); //   out.device()-&gt;seek(0); //      out &lt;&lt; (quint16)(block.size() - sizeof(quint16)); _sok-&gt;write(block); } void Dialog::onSokReadyRead() { //     QDataStream in(_sok); //     2     if (_blockSize == 0) { //   2     2  if (_sok-&gt;bytesAvailable() &lt; (int)sizeof(quint16)) return; //  (2 ) in &gt;&gt; _blockSize; } //     if (_sok-&gt;bytesAvailable() &lt; _blockSize) return; else //    _blockSize = 0; //3  -   quint8 command; in &gt;&gt; command; switch (command) { //   ,   ,        MyClient::comUsersOnline case MyClient::comUsersOnline: { QString users; in &gt;&gt; users; if (users == "") return; //    ,   (       QStringList) QStringList l = users.split(","); //  ui-&gt;lwUsers-&gt;addItems(l); } break; //    case MyClient::comPublicServerMessage: { //     QString message; in &gt;&gt; message; AddToLog("[PublicServerMessage]: "+message, Qt::red); } ... } }</span></span></code> </pre>  This is all with the client - the main points are described, the rest is pretty simple. <br><br><h4>  Server </h4><br>  The server will be more complicated - separate the gui (dialog), server (myserver) and client (myclient).  Who is unfamiliar with sockets can not understand what client can be in the server?  So, when connecting a socket to the server, on the server, as a rule, a ‚Äúclient‚Äù socket is created, which is added to the array (a thought arises to use an associative array, but for simplicity we take QList). <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//dialog.cpp Dialog::Dialog(QWidget *parent) :QDialog(parent), ui(new Ui::Dialog) { // .    - parent,  -     ,     myclient   _serv = new MyServer(this, this); //      connect(this, SIGNAL(messageFromGui(QString,QStringList)), _serv, SLOT(onMessageFromGui(QString,QStringList))); ... //     127.0.0.1:1234 if (_serv-&gt;doStartServer(QHostAddress::LocalHost, 1234)) {...} else {...} }</span></span></code> </pre><br><br>  We will inherit the class from QTcpServer, it is necessary to redefine the incomingConnection virtual function, in which the incoming connection is intercepted (input parameter is socket descriptor) <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//myserver.h class MyServer : public QTcpServer { public: bool doStartServer(QHostAddress addr, qint16 port); void doSendToAllUserJoin(QString name); //    void doSendToAllUserLeft(QString name); void doSendToAllMessage(QString message, QString fromUsername); //  void doSendToAllServerMessage(QString message);//  void doSendServerMessageToUsers(QString message, const QStringList &amp;users); //   void doSendMessageToUsers(QString message, const QStringList &amp;users, QString fromUsername); QStringList getUsersOnline() const; //   bool isNameValid(QString name) const; //  bool isNameUsed(QString name) const; //    protected: void incomingConnection(int handle); private: QList&lt;MyClient *&gt; _clients; //  QWidget *_widget; //         myclient }; //myserver.cpp void MyServer::incomingConnection(int handle) { //  ,    (   ),    - parent MyClient *client = new MyClient(handle, this, this); //    ,       if (_widget != 0) { connect(client, SIGNAL(addUserToGui(QString)), _widget, SLOT(onAddUserToGui(QString))); connect(client, SIGNAL(removeUserFromGui(QString)), _widget, SLOT(onRemoveUserFromGui(QString))); ... } _clients.append(client); } /*           ,    _clients, ,    */ void MyServer::doSendServerMessageToUsers(QString message, const QStringList &amp;users) { //    QByteArray block; QDataStream out(&amp;block, QIODevice::WriteOnly); out &lt;&lt; (quint16)0 &lt;&lt; MyClient::comPrivateServerMessage &lt;&lt; message; out.device()-&gt;seek(0); out &lt;&lt; (quint16)(block.size() - sizeof(quint16)); //   (  ,     users  ) for (int j = 0; j &lt; _clients.length(); ++j) if (users.contains(_clients.at(j)-&gt;getName())) _clients.at(j)-&gt;_sok-&gt;write(block); }</span></span></code> </pre><br><br>  For a client class, perhaps, it is worth describing only the interface, everything is clear by analogy.  MyClient does not need to inherit from QTcpSocket, you can do it differently: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//myclient.h class MyClient : public QObject { //   MyServer    _sok friend class MyServer; public: static const QString constNameUnknown; static const quint8 comAutchReq = 1; static const quint8 comUsersOnline = 2; ... static const quint8 comErrNameUsed = 202; void setName(QString name) {_name = name;} QString getName() const {return _name;} bool getAutched() const {return _isAutched;} void doSendCommand(quint8 comm) const; void doSendUsersOnline() const; signals: //    void addUserToGui(QString name); void removeUserFromGui(QString name); void messageToGui(QString message, QString from, const QStringList &amp;users); //    QList void removeUser(MyClient *client); //      private slots: void onConnect(); void onDisconnect(); void onReadyRead(); void onError(QAbstractSocket::SocketError socketError) const; private: QTcpSocket *_sok; // MyServer *_serv; //   quint16 _blockSize; //   QString _name; // bool _isAutched; //  };</span></span></code> </pre><br><br>  <b>Upd 2017</b> : <br>  Alas, but the source is already lost forever <br>  <b>Upd 2018</b> : <br>  As you know, everything that has ever been uploaded to the Internet remains there forever.  Thanks to <a href="https://habrahabr.ru/users/vladpower/" class="user_link">vladpower, the</a> <a href="https://yadi.sk/d/vOCC11vC3TCEzF">sources are again available.</a> </div><p>Source: <a href="https://habr.com/ru/post/131585/">https://habr.com/ru/post/131585/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131579/index.html">Using the mediator pattern to switch between activities</a></li>
<li><a href="../131581/index.html">Several useful services</a></li>
<li><a href="../131582/index.html">Samsung Galaxy R - Smartphone Parsing</a></li>
<li><a href="../131583/index.html">Report on meeting Apple Developers Community # 9</a></li>
<li><a href="../131584/index.html">Deface images or you may be substituted.</a></li>
<li><a href="../131586/index.html">Writing a web server in Common Lisp part one</a></li>
<li><a href="../131587/index.html">MobiUs: browser HTML5 applications for iOS</a></li>
<li><a href="../131588/index.html">What state sites show hatred towards citizens?</a></li>
<li><a href="../131589/index.html">Minimal Arduino DIY</a></li>
<li><a href="../131590/index.html">Business Forum in Skolkovo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>