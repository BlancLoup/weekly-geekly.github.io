<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the Hi / Lo algorithm to generate keys in the Entity Framework Core</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Hi / Lo algorithm is useful when you need unique keys. In short, the Hi / Lo algorithm describes the mechanism for generating secure identifiers o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the Hi / Lo algorithm to generate keys in the Entity Framework Core</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/0x/dy/po/0xdypougmqcoefzandpwvrzixio.jpeg"><br><br>  <a href="https://vladmihalcea.com/the-hilo-algorithm/">The Hi / Lo algorithm</a> is useful when you need unique keys.  In short, the Hi / Lo algorithm describes the mechanism for generating secure identifiers on the client side and not in the database ( <i>safe in this context means no collisions</i> ).  It sets unique identifiers to the rows of the table, not depending on whether the row is immediately stored in the database or not.  This allows you to immediately use identifiers, as normal sequential database identifiers. <br><a name="habracut"></a><br>  Database <i>sequences</i> are cached, scaled and solve concurrency problems.  But for each new value of the sequence, we constantly need to contact the database.  And when we have a large number of inserts, it becomes a bit expensive.  Therefore, to optimize work with sequences, use the Hi / Lo algorithm.  EntityFramework Core supports Hi / Lo out of the box using <code>ForSqlServerUseSequenceHiLo</code> method <br><br><h4>  How does hi / lo work </h4><br>  Let's start with <a href="https://stackoverflow.com/questions/282099/whats-the-hi-lo-algorithm">what Hi / Lo is</a> .  The basic idea is that you have two numbers to make up a primary key - a ‚Äúhigh‚Äù ( <i>high</i> ) number and a ‚Äúlow‚Äù ( <i>low</i> ) number.  The client can basically increase the ‚Äúhigh‚Äù sequence, knowing that he can safely generate keys from the entire range of previous ‚Äúhigh‚Äù values ‚Äã‚Äãwith many ‚Äúlow‚Äù values. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, suppose you have a ‚Äúhigh‚Äù sequence with a current value of 35, and a ‚Äúlow‚Äù number is in the range of 0-1023.  The client can then increase the sequence to 36 (for other clients to be able to generate keys when using 35) and know that the keys 35/0, 35/1, 35/2, 35/3 ... 35/1023 are all available. <br><br>  It can be very useful (especially with ORM) to be able to set primary keys on the client side instead of inserting values ‚Äã‚Äãwithout primary keys, and then retrieving them back to the client.  Among other things, this means that you can easily create relationships between parents and children and have all the keys in place before making any inserts, which simplifies their batching. <br><br><h4>  Use Hi / Lo to generate keys in the Entity Framework Core </h4><br>  Let's take a look at how to use Hi / Lo to generate keys using the Entity Framework Core.  Suppose we have a simple Category model: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Category</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  Remember that EF configures the property <code>Id</code> or <code>&lt; &gt;Id</code> as a key.  Now we need to create a DBContext: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SampleDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SampleDBContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Database.EnsureDeleted(); Database.EnsureCreated(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfiguring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptionsBuilder optionBuilder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> onnString = <span class="hljs-string"><span class="hljs-string">@"Server=localhost\SQLEXPRESS01;Database=EFSampleDB;Trusted_Connection=true;"</span></span>; optionBuilder.UseSqlServer(onnString); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityTypeBuilder = modelBuilder.Entity&lt;Category&gt;(); entityTypeBuilder.ToTable(<span class="hljs-string"><span class="hljs-string">"Category"</span></span>); entityTypeBuilder.HasKey(t =&gt; t.Id); entityTypeBuilder.Property(t =&gt; t.Id).ForSqlServerUseSequenceHiLo(); entityTypeBuilder.Property(t =&gt; t.Name).HasMaxLength(<span class="hljs-number"><span class="hljs-number">128</span></span>).IsRequired(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Category&gt; Category { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  DbContext consists of: <br><br><ul><li>  the <code>SampleDBContext</code> constructor <code>SampleDBContext</code> which is the implementation of the <code>DropCreateDatabaseAlways</code> database <code>DropCreateDatabaseAlways</code> ; </li><li>  <code>OnConfiguring</code> method for configuring DBContext; </li><li>  The <code>OnModelCreating</code> method is the place where you can define the configuration of the model.  To determine the Hi / Lo sequence, use the <code>ForSqlServerUseSequenceHiLo</code> extension <code>ForSqlServerUseSequenceHiLo</code> . </li></ul><br>  Run the application.  As a result, the base ‚ÄúEFSampleDB‚Äù with the table ‚ÄúCategory‚Äù and with the sequence ‚ÄúEntityFrameworkHiLoSequence‚Äù should be created.  The name of the sequence and the scheme in which it will be created can be passed as a parameter: <br><br>  <code>ForSqlServerUseSequenceHiLo(string name, string schema)</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/oh/n3/clohn30j-uhrgf37yrb73besxmy.png"></div><br><br>  The ‚ÄúEntityFrameworkHiLoSequence‚Äù creation script looks as follows <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> [dbo].[EntityFrameworkHiLoSequence] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MINVALUE</span></span> <span class="hljs-number"><span class="hljs-number">-9223372036854775808</span></span> MAXVALUE <span class="hljs-number"><span class="hljs-number">9223372036854775807</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  This sequence starts at 1 and increases by 10. There is a difference between the <b>Sequence</b> and the <b>Hi / Lo Sequence</b> with respect to the <code>INCREMENT BY</code> option.  In <b>Sequence</b> <code>INCREMENT BY</code> adds the value to the previous value of the sequence to generate a new value.  Thus, in this case, if your previous sequence value is 11, then the next sequence value will be 11 + 10 = 21. In the case of <b>Hi / Lo Sequence,</b> the <code>INCREMENT BY</code> parameter denotes the block value, this means that the next sequence value will be selected after first use 10. <br><br>  Let's add some data to the database: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SampleDBContext()) { dataContext.Category.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Category { Name = <span class="hljs-string"><span class="hljs-string">"Name-1"</span></span> }); dataContext.Category.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Category { Name = <span class="hljs-string"><span class="hljs-string">"Name-2"</span></span> }); dataContext.Category.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Category { Name = <span class="hljs-string"><span class="hljs-string">"Name-3"</span></span> }); dataContext.SaveChanges(); }</code> </pre> <br>  As soon as this code falls into the line where the category is added to DBContext, the database is called to get the value of the sequence.  This can be verified using SQL Server Profiler. <br><br><img src="https://habrastorage.org/webt/a_/su/jq/a_sujqqx61ci6zrj9a7691gmves.png"><br><br>  When <code>dataContext.SaveChanges();</code> is called <code>dataContext.SaveChanges();</code>  All 3 categories will be saved with primary key values ‚Äã‚Äãthat are already generated and are selected only once. <br><br><img src="https://habrastorage.org/webt/5t/xb/py/5txbpynr2kyb7drrgkl3qdtsioq.png"><br><br>  The sequence value will not be selected from the database until the Lo part is exhausted (10 records in our case), only when adding the 11th record, the database will be called to get the next sequence value (Hi). <br><br>  You can create one sequence of several tables: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.ForSqlServerUseSequenceHiLo(<span class="hljs-string"><span class="hljs-string">"DBSequenceHiLo"</span></span>); }</code> </pre> <br><h4>  Hi / Lo Sequence Setup </h4><br>  There are no parameters in the <code>ForSqlServerHasSequence</code> method to change the initial value and the increment value.  But you can specify these values ‚Äã‚Äãas follows, first we define the sequence with the <code>StartAt</code> and <code>IncrementBy</code> parameters and then use the same <code>ForSqlServerUseSequenceHiLo</code> extension <code>ForSqlServerUseSequenceHiLo</code> . <br><br><pre> <code class="cs hljs">modelBuilder.HasSequence&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"DBSequenceHiLo"</span></span>).StartsAt(<span class="hljs-number"><span class="hljs-number">1000</span></span>).IncrementsBy(<span class="hljs-number"><span class="hljs-number">5</span></span>); modelBuilder.ForSqlServerUseSequenceHiLo(<span class="hljs-string"><span class="hljs-string">"DBSequenceHiLo"</span></span>);</code> </pre> <br>  In this case, the sql script for DBSequenceHiLo will be as follows <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> [dbo].[DBSequenceHiLo] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MINVALUE</span></span> <span class="hljs-number"><span class="hljs-number">-2147483648</span></span> MAXVALUE <span class="hljs-number"><span class="hljs-number">2147483647</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Now, when we add three categories, the key value starts at 1000. And since the <code>IncrementBy</code> parameter is set to ‚Äú5,‚Äù when the sixth entry is added to the context, a query will be made to the database to get the next sequence value.  If you change the code, and add 3 more categories, then on the screenshot you can see the second database call. <br><br><img src="https://habrastorage.org/webt/ei/uh/mg/eiuhmgwukjsyz4q9i5pujwleh7m.png"><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/349250/">https://habr.com/ru/post/349250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349236/index.html">Measuring and shaping the frequency characteristics of electric guitars</a></li>
<li><a href="../349238/index.html">My remarks on the book by L.P. Plekhanov "Fundamentals of self-timed electronic circuits"</a></li>
<li><a href="../349242/index.html">Monitoring IT Performance with Splunk IT Service Intelligence</a></li>
<li><a href="../349246/index.html">Bro, why do we need a business? Let's trade in brooms. After all, they are used in every yard</a></li>
<li><a href="../349248/index.html">Operating systems from scratch; Level 0</a></li>
<li><a href="../349252/index.html">Release Rust 1.24</a></li>
<li><a href="../349254/index.html">ITSM literacy program: Users and Customers - who is behind these names?</a></li>
<li><a href="../349256/index.html">Journal of the work with the network. Part 2</a></li>
<li><a href="../349260/index.html">Is it a bird? This is a plane? No, this is your user's token flying to a new phone.</a></li>
<li><a href="../349262/index.html">Simulation of dynamic systems: the problem of external ballistics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>