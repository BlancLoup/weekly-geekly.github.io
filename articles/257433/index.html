<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did the subway breakdown alert</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Long ago, about a year ago, when the Moscow Metro broke in random places and surprisingly often, we ( dcoder_mm & Irenica ) had the idea: to make some...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did the subway breakdown alert</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fad/152/f11/fad152f1159041ed99abb41eeabebf65.jpg"><br><br>  Long ago, about a year ago, when the Moscow Metro broke in random places and surprisingly often, we ( <a href="https://habrahabr.ru/users/dcoder_mm/" class="user_link">dcoder_mm</a> &amp; <a href="https://habrahabr.ru/users/irenica/" class="user_link">Irenica</a> ) had the idea: to make some sort of service, to alert you about breakdowns. <br><a name="habracut"></a><br>  This idea may seem strange to you, <a href="https://habrahabr.ru/users/dcoder_mm/" class="user_link">dcoder_mm,</a> too, so it seemed, until he got into one of these breakdowns.  Standing on a crowded platform for 10 minutes while waiting for the train, it turned out to be unpleasant, so much so that from now on I decided not to get caught like that. <br><br>  After this incident, they decided to look through twitter: do they write anything about incidents in the subway?  As it turned out, they write.  And the first tweets about it were 10 minutes before I went to the subway. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then, slowly, the idea began to emerge: we collect information from twitter, look for references to metro breakdowns and notify the user if something is found. <br><br>  True, then this idea was abandoned for a long time, but in the fall of 2014 we remembered it again - the metro began to break down again regularly. <br><br>  As a notification method, it was decided to use SMS.  It was possible, of course, to use something else, even though a twitter bot could be used to aggregate messages about the metro, but SMS has one advantage - they get even when there is no normal internet connection.  And in the subway it often does not happen, but at the same time GSM is caught normally.  (When we started to do the service, there was no Wifi in the whole metro yet). <br><br>  The case remained for the small - in fact, to make a parsile of tweets and sending SMS. <br><br>  To test the battle, a simple single-line script was written, receiving through the search (curl search.twitter.com) the latest tweets with the hashtag # of the metro, selecting the necessary ones by keywords, and sending us sms. <br><br><pre><code class="bash hljs">curl -ssl <span class="hljs-string"><span class="hljs-string">"https://twitter.com/search?f=realtime&amp;q=%23%D0%BC%D0%B5%D1%82%D1%80%D0%BE&amp;src=typd"</span></span> | grep -E -o <span class="hljs-string"><span class="hljs-string">"js-tweet-text tweet-text.*&lt;\/p&gt;"</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">'s;[&gt;&lt;\"=-]; ;g;s;js tweet text tweet text lang ru data aria label part 0;;g;s;/a;;g;s;\/\(a\|p\); ;g;s;\(.span\|.strong\|class\|twitter\|timeline\|link\|js display url\|invisible|\tco ellipsis\|href\|nofollow\|dir\|ltr\|data\|expanded\|url\|invisible\|tco\|ellipsis\|google&amp;\;utm_medium\|banner&amp;\;utm_campaign\|business_news\|target\|_blank\|title\|atreply\|pretty\| \;\|rel\|s\|?utm_source\|draggable\|false\|alt\|aria\|label\|u\|hidden\|pre\|embedded|\true\|b\|a\|qery\|orce\|hahtag_click\|hahtag\|j\|nav\|emedded\|tre\|&amp;qot\;\|emedded\|tre\|rc\|hh\|qery\|orce\|hhtg_click\|hhtg\|img\);;g;s; ; ;g;s; \; ;;g;s;&amp;qot\;;;g;s;emedded;;g;s;tre;;g;s; \/ ;;g;s;hhtg_click hhtg;;g;s;hh;;g;s;qery oe;;g;s;\/tg\/[a-zA-Z]*;;g;s;tweet;;g;s;text;;g;s;lng;;g;s;nd;;g;s;prt;;g;s;http://intgrm.com\s\/[a-zA-Z]*\/;;g;s;[AZ%az]*;;g;s;[\/_\/:\/?\.@&amp;;‚Ä¶]*;;g;s;^[0-9]*;;g;s;[0-9]\{3,\};;g;s;^\s*;;g;s; *; ;g;s;^[0-9] ;;g;s;# ;#;g;s;[0-9 #]*$;;g'</span></span> | grep -E -i <span class="hljs-string"><span class="hljs-string">"||||  |||||||||||| ||||| ||||||||||||||| | | |"</span></span> | grep -E -i <span class="hljs-string"><span class="hljs-string">"||||||||||||||||||||||||||||||||||||||||| ||||||||||||||||||||||||||||||||||||||||||||||||||||| |||||||||||||||||||||||||||  |||||||||||-||||1905|||[- ]|[]||||||||||||||||||||||||||||||||||||||||-|  | []|-|  |[][]||  |[][][]|-|  | [][]||  | [][]|[]|  |[][]||-|  | [][]||  |[][][]|[][]|||  ||"</span></span> | grep -i -v -E <span class="hljs-string"><span class="hljs-string">" | | |||||||-||||||||||iphone|||||porn|pron|||follow|retweet||| |||| ||||| |||| |||||||||| || | || ||| ||| | |  ||||| || ||||||||||||| |||||||||"</span></span> | sort | uniq</code> </pre> <br><br>  And oddly enough, it worked quite well.  Sometimes, of course, there were false positives, but the main thing was that alerts came for all the least important breakdowns.  And they came quickly - much earlier than this information appeared in the media or anywhere else. <br><br>  Now it is the turn to filter the false positives.  The most brazen and obvious spam, for example, advertising with the hashtag # metro, did not pass, because it did not contain keywords (such as ‚Äúaccident‚Äù or ‚Äúbreakdown‚Äù).  But this did not save, for example, from reports of metro breakdowns in other cities (not always in the tweet about the breakdown of the metro in St. Petersburg they would write the word ‚Äúpeter‚Äù).  Therefore, I had to enter a list of "stop words" in the presence of which the message was not sent.  It included some station names from other cities, keywords that were often used in advertising, etc. <br><br>  The problem with the fact that a couple of dozen tweets may account for one event, and as many sms, was decided on the forehead: we simply block all messages about this metro line for a certain time. <br><br>  However, there were other causes of false positives: reports of other transport failures (but with the ‚Äúmetro‚Äù tag), reports of old metro breakdowns (a couple of accounts write tweets about the tragedy in the metro in summer 2014, as if it had just happened ). <br><br>  When it finally became more or less stable, we made a web interface with the ability to register by phone number.  Slowly more people began to catch up, and naturally, in full accordance with the law of meanness, a few more false positives happened.  To prevent this from happening again, they made a pre-moderation: That is, first the messages come to us, and if we do not prohibit their sending in a couple of minutes, they are sent to all other users. <br><br>  And we have statistics.  Well, if you are collecting data, it‚Äôs a sin not to make statistics on them.  In our case, this is just a display of the number of breakdowns by branches for a certain period of time.  And a brief description of each breakdown.  In the future, we will probably add something else, first we need to collect more data. <br><br>  In general, who cares: <a href="http://msk-metro.ru/">msk-metro.ru</a> Here we are.  We can assume that the project is still at the stage of beta testing, so if you accidentally receive a left sms, do not worry.  We will fix it, and next time such SMS will not come exactly. <br><br>  And this all lives on Raspberry Pi on debian. </div><p>Source: <a href="https://habr.com/ru/post/257433/">https://habr.com/ru/post/257433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257417/index.html">120 servers in 30 days: tenders and other nuances of working with government agencies</a></li>
<li><a href="../257421/index.html">Interview about testing + screenshots of applications working in ReactOS, sent by testers</a></li>
<li><a href="../257425/index.html">Why not RemoteFX, as well as more information about NVIDIA GRID VGPU technology</a></li>
<li><a href="../257427/index.html">Adjustable power supply from ATX power supply to TL494. Part 1 - iron</a></li>
<li><a href="../257431/index.html">Implement an even more secure VPN protocol</a></li>
<li><a href="../257437/index.html">SkillsWiki conference materials: .NET-developer through the eyes of employers in Russia and abroad</a></li>
<li><a href="../257439/index.html">PHP Data Encryption Guide</a></li>
<li><a href="../257443/index.html">GPS-monitor for android "KidsTrack"</a></li>
<li><a href="../257445/index.html">thd or triggerhappy global hotkey daemon</a></li>
<li><a href="../257449/index.html">Redmine main menu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>