<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Laravel. Install, configure, create and deploy applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, you have the desire to try or learn about the Laravel framework. 

 If you are familiar with other PHP frameworks, it will not be difficult for yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Laravel. Install, configure, create and deploy applications</h1><div class="post__text post__text-html js-mediator-article"> So, you have the desire to try or learn about the <a href="http://laravel.com/">Laravel</a> framework. <br><br>  If you are familiar with other <code>PHP</code> frameworks, it will not be difficult for you, but if not, this is an excellent choice for the first framework. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd0/390/2ac/bd03902ac53eb3a71d96259091c26c28.png" alt="Laravel - PHP framework for artisans!">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The article is very large.  I recommend reading it completely during the weekend. <br><br>  For the lazy: <br>  <a href="https://github.com/andrewdacenko/habrahabr">Github</a> <br>  <a href="http://habr.eu1.frbit.net/">application</a> <br><br><a name="habracut"></a><br><br><h4>  Installation </h4><br>  To install Laravel, we need <a href="http://getcomposer.org/">Composer</a> <br><blockquote>  Composer is a tool for managing dependencies in <code>PHP</code> .  It allows you to declare dependent libraries needed for a project and install them into a project. <br>  - <a href="">Composer</a> <br></blockquote><br>  The installation of the environment will take place in the <code>*nix</code> environment (the site also has a manual for installing on <a href="">Windows</a> , plus you will need a server, for example, <a href="http://www.wampserver.com/ru/">WAMP</a> and <a href="http://windows.github.com/">Git</a> ). <br><br>  Suppose that you have a very clean OS.  Then open the terminal and <s>enter these lines,</s> copy and paste <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    sudo apt-get update sudo apt-get install -y build-essential sudo apt-get install -y python-software-properties #    php 5.5 sudo add-apt-repository ppa:ondrej/php5 sudo apt-get update #   sudo apt-get install -y php5 sudo apt-get install -y apache2 sudo apt-get install -y libapache2-mod-php5 sudo apt-get install -y mysql-server sudo apt-get install -y php5-mysql sudo apt-get install -y php5-curl sudo apt-get install -y php5-gd sudo apt-get install -y php5-mcrypt sudo apt-get install -y git-core sudo apt-get install -y phpmyadmin #   phpmyadmin echo "Include /etc/phpmyadmin/apache.conf" | sudo tee -a /etc/apache2/apache2.conf #  mod_rewrite sudo a2enmod rewrite #  apache    sudo /etc/init.d/apache2 restart #   Composer curl -sS https://getcomposer.org/installer | php sudo mv composer.phar /usr/local/bin/composer</span></span></code> </pre><br>  After a while you will have all the necessary tools installed. <br>  We proceed directly to the installation of <code>Laravel</code> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     cd #    /home/%user% mkdir workspace #  workspace cd workspace #    mkdir php #   php cd php #    php</span></span></code> </pre><br>  Create a <code>laravel</code> project in the <i>habr</i> folder <br><br><pre> <code class="bash hljs">composer create-project laravel/laravel habr --prefer-dist <span class="hljs-comment"><span class="hljs-comment"># ....       ....</span></span></code> </pre><br>  Let's go over to the created project and make sure that everything works by running the <code>php artisan serve</code> command <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> habr php artisan serve</code> </pre><br>  The local server will be available at <a href="http://localhost:8000/">http: // localhost: 8000</a> . <br><br><blockquote>  Just in case, <b>artisan</b> is a command line script found in <code>Laravel</code> .  It provides a number of useful commands for use in development.  It runs on top of the <code>Symfony</code> console component.  ( <a href="http://laravel.com/docs/artisan">Artisan CLI</a> ).  There are many useful commands that can be used to create various useful things on the command line.  For a list of commands, enter <code>php artisan list</code> in the command line. </blockquote><br>  Going to <a href="http://localhost:8000/">http: // localhost: 8000</a> you should see a nice screensaver like at the beginning of the post. <br><br><h4>  Customization </h4><br>  To connect to the database (hereinafter the database), <code>Laravel</code> has the configuration file <i>database.php</i> , it is located in the <i>app / config /</i> folder. <br>  First, create a database and user in <code>MySQL</code> <br><br><pre> <code class="bash hljs">mysql -u root -p <span class="hljs-comment"><span class="hljs-comment">#    &gt; CREATE DATABASE `habr` CHARACTER SET utf8 COLLATE utf8_general_ci; &gt; CREATE USER 'habr'@'localhost' IDENTIFIED BY 'my_password'; &gt; GRANT ALL PRIVILEGES ON habr.* TO 'habr'@'localhost'; &gt; exit</span></span></code> </pre><br>  Fine!  We have all the data to access <code>MySQL</code> : the <b>habr</b> user with the password <b>my_password</b> and the <b>habr</b> database on <b>localhost</b> .  Go to the database configuration file and change our settings. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a9/1d0/12b/8a91d012b342adb7ad7c74107ae96db5.png" alt="Laravel database configuration file"><br><br>  <code>Laravel</code> has great tools - <a href="http://laravel.com/docs/migrations">Migrations</a> and <a href="http://laravel.com/docs/schema">Schema Builder</a> . <br><blockquote>  Migrations are a type of version control in a database.  They allow the development team to change the database schema and stay informed about the current state of the schema.  Migration, as a rule, paired with the Schema Builder will allow you to easily manage the database schema. <br>  - <a href="http://laravel.com/docs/migrations">Migrations</a> <br>  The <b>Schema</b> Builder is a <b>Schema</b> class.  It allows the manipulation of tables in the database.  It works well with all databases that are supported by <code>Laravel</code> , and has a single <code>API</code> for all of these systems. <br>  - <a href="http://laravel.com/docs/schema">Schema Builder</a> </blockquote><br>  First, create a migration table: <br><br><pre> <code class="bash hljs">php artisan migrate:install</code> </pre><br>  If the database connection settings are correct, then we are ready to create migrations and tables. <br>  But before that, I want to introduce you to installing additional packages that can be used to create a web application more efficiently and quickly. <br><br><h5>  Laravel 4 Generators </h5><br>  Mega useful tool - <b>generators</b> from <b>Jeffrey Way</b> .  <a href="https://github.com/JeffreyWay/Laravel-4-Generators">Github</a> <br><br>  He adds many useful commands to the <b>artisan</b> list, such as: <br><br><ul><li>  generate: model - create models </li><li>  generate: controller - creating controllers </li><li>  generate: seed - create files to fill the database with configuration / fake information </li><li>  generate: view - create templates </li><li>  generate: migration - create migrations </li><li>  generate: resource - creating resources </li><li>  generate: scaffold - creation of prototypes (the most interesting, we will consider it in more detail a bit later!) </li><li>  generate: form - create forms </li><li>  generate: test - create tests </li><li>  generate: pivot - create pivot table migration </li></ul><br><br><h6>  Package installation </h6><br>  Installing packages using <code>Composer</code> is quite simple.  You need to edit the <b>composer.json</b> file in the application root by adding the line <code>"way/generators": "1.*"</code> to the <code>"require"</code> list. <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"laravel/framework"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.1.*"</span></span>, <span class="hljs-string"><span class="hljs-string">"way/generators"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.*"</span></span> },</code> </pre><br>  After that, you need to update the project dependencies.  Enter in the terminal <br><br><pre> <code class="bash hljs">composer update</code> </pre><br>  The final touch will be putting in the configuration file <b>app / config / app.php</b> in the list of application providers line <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'Way\Generators\GeneratorsServiceProvider'</span></span></code> </pre><br>  Now the list of <code>php artisan</code> commands will also contain new <code>generate</code> commands.  In the next section, I will show how to use <code>generate</code> to create an application and speed up development. <br><br><h4>  Create application </h4><br>  Suppose we create a <s>blog</s> site with discounts.  For this we need: <br><br><ul><li>  User table with email, username and password </li><li>  Role table </li><li>  User roles table </li><li>  City table </li><li>  Table of companies </li><li>  Tag table </li><li>  Discount table with fields: title, description, city, company,% discount, picture and discount expiration date </li><li>  Table of comments with ratings </li><li>  Discount tag table </li></ul><br><br>  Sketch the table schema in the database.  I got something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/8bc/365/d3c/8bc365d3c167e0140b6411a61df98c12.png" alt="Initial DB Schema"><br><br>  Thanks for this <b>generator</b> 'y.  Since all I did was register 10 lines, by the way, here they are: <br><br><pre> <code class="bash hljs">php artisan generate:migration create_users_table --fields=<span class="hljs-string"><span class="hljs-string">"email:string:unique, password:string[60], username:string:unique, remember_token:string:nullable"</span></span> php artisan generate:scaffold role --fields=<span class="hljs-string"><span class="hljs-string">"role:string:unique"</span></span> php artisan generate:pivot users roles php artisan generate:scaffold city --fields=<span class="hljs-string"><span class="hljs-string">"name:string:unique"</span></span> php artisan generate:scaffold company --fields=<span class="hljs-string"><span class="hljs-string">"title:string:unique"</span></span> php artisan generate:scaffold tag --fields=<span class="hljs-string"><span class="hljs-string">"title:string:unique"</span></span> php artisan generate:scaffold offer --fields=<span class="hljs-string"><span class="hljs-string">"title:string, description:text, city_id:integer:unsigned, company_id:integer:unsigned, off:integer:unsigned, image:string, expires:date"</span></span> php artisan generate:scaffold comment --fields=<span class="hljs-string"><span class="hljs-string">"body:text, user_id:integer:unsigned, offer_id:integer:unsigned, mark:integer"</span></span> php artisan generate:pivot offers tags <span class="hljs-comment"><span class="hljs-comment">#      php artisan migrate</span></span></code> </pre><br>  With the help of the last command, all migrations that have not yet been recorded will be entered in the database.  The important thing is that all new migrations will be launched by one stack.  In order to roll back the migration there is the <code>php artisan migrate:rollback</code> command, and in order to roll back all migrations to zero <code>migrate:reset</code> , to roll to zero and run all migrate <code>migrate:refresh</code> migrations. <br><br><blockquote>  In <code>Laravel</code> version higher than <b>4.1.25</b> , a security update occurred where a hole with stolen cookies was closed.  Details of the update and instructions can be found here: <a href="http://laravel.com/docs/upgrade">http://laravel.com/docs/upgrade</a> for those with a version of <code>Laravel</code> &lt; <b>4.1.26</b> .  Or just read the comments from <a href="https://habrahabr.ru/users/vlom88/" class="user_link">vlom88</a> <a href="http://habrahabr.ru/post/197454/">http://habrahabr.ru/post/197454/#comment_7510479</a> . </blockquote><br><br>  Read more about generator commands: <br><br><ul><li>  <b>generate: migration</b> Accepts the name of the migration argument, and creates the appropriate schema.  In the name of the schema, you can specify keywords, for example, <b>create</b> - creation, followed by the table <b>name</b> and the keyword <b>table</b> .  You can also specify which fields to add to the table via the option <b>--fields = ""</b> , in which you should list the fields with their data type, separated by commas.  <a href="https://github.com/JeffreyWay/Laravel-4-Generators">Create Migration</a> , <a href="http://laravel.com/docs/schema">Data Types and More</a> </li><li>  <b>generate: scaffold</b> Accepts a resource as an argument (for example, <b>role</b> ), and creates such files: <br><ul><li>  <i>app / models / Role.php</i> - class of the model inherited from <a href="http://laravel.com/docs/eloquent">Eloquent ORM</a> for working with the role table (the name of the table itself is a plural form of the resource name) </li><li>  <i>app / controllers / RolesController.php</i> - the controller class that responds to requests to the site, is also a <a href="http://laravel.com/docs/controllers">REST</a> controller <br><table><tbody><tr><td>  HTTP method </td><td>  Path (URL) </td><td>  Act </td><td>  Route name </td></tr><tr><td>  Get </td><td>  / resource </td><td>  index </td><td>  resource.index </td></tr><tr><td>  Get </td><td>  / resource / create </td><td>  create </td><td>  resource.create </td></tr><tr><td>  POST </td><td>  / resource </td><td>  store </td><td>  resource.store </td></tr><tr><td>  Get </td><td>  / resource / {id} </td><td>  show </td><td>  resource.show </td></tr><tr><td>  Get </td><td>  / resource / {id} / edit </td><td>  edit </td><td>  resource.edit </td></tr><tr><td>  PUT / PATCH </td><td>  / resource / {id} </td><td>  update </td><td>  resource.update </td></tr><tr><td>  DELETE </td><td>  / resource / {id} </td><td>  destroy </td><td>  resource.destroy </td></tr></tbody></table><br></li><li>  <i>app / views / roles / index.blade.php</i> - a template that is responsible for the list of all resources (usually generated by a <code>GET</code> request by <code>URL</code> <b>/ roles</b> ), I will tell you about the template engine a little later </li><li>  <i>app / views / roles / show.blade.php</i> - a template that is responsible for displaying a specific resource ( <code>GET</code> request to <code>URL</code> <b>/ roles / {id}</b> ) </li><li>  <i>app / views / roles / create.blade.php</i> - template that contains the form for adding a resource ( <code>GET</code> to <code>URL</code> <b>/ roles / create</b> ) </li><li>  <i>app / views / roles / edit.blade.php</i> - template that contains the form for editing the resource ( <code>GET</code> at the <code>URL</code> <b>/ roles / {id} / edit}</b> ) </li><li>  <i>app / views / layouts / scaffold.blade.php</i> - the main layout of the application (contains the basic html + bootstrap + container for the inserted content) </li><li>  <i>app / database / migrations / Create_roles_table.php</i> - migration </li><li>  <i>app / database / seeds / RolesTableSeeder.php</i> - file for test filling the table with data </li><li>  <i>app / tests / controllers / RolesTest.php</i> - various tests </li></ul><br>  It also updates and adds data to files. <br><ul><li>  <i>app / database / seeds / DatabaseSeeder.php</i> - adds a call to RolesTableSeeder </li><li>  <i>app / routes.php</i> - adds all resource ( <a href="http://laravel.com/docs/controllers">REST</a> ) methods to the route register </li></ul><br></li><li>  <b>generate: pivot</b> Takes 2 arguments (table names).  Creates a pivot table that contains 2 <code>foreign key</code> </li></ul><br><br>  I hope this example of using the generator quite clearly showed how to use it and how useful it is. <br><br>  What we still lack is some of the connections between the tables. <br><blockquote>  <b>It is important to know!</b>  When adding a foreign key to a column in a table, you need to make sure that the column is unsigned. </blockquote><br>  Well, add them: <br><br><pre> <code class="bash hljs">php artisan generate:migration add_foreign_user_id_and_offer_id_to_comments_table php artisan generate:migration add_foreign_city_id_and_company_id_to_offers_table</code> </pre><br>  Now we need to register the addition of indexes inside the migration files themselves, since such changes are not automatically created. <br><br><pre> <code class="php hljs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddForeignUserIdAndOfferIdToCommentsTable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::table(<span class="hljs-string"><span class="hljs-string">'comments'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;index(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>); $table-&gt;index(<span class="hljs-string"><span class="hljs-string">'offer_id'</span></span>); $table-&gt;foreign(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>)-&gt;references(<span class="hljs-string"><span class="hljs-string">'id'</span></span>)-&gt;on(<span class="hljs-string"><span class="hljs-string">'users'</span></span>)-&gt;onDelete(<span class="hljs-string"><span class="hljs-string">'cascade'</span></span>); $table-&gt;foreign(<span class="hljs-string"><span class="hljs-string">'offer_id'</span></span>)-&gt;references(<span class="hljs-string"><span class="hljs-string">'id'</span></span>)-&gt;on(<span class="hljs-string"><span class="hljs-string">'offers'</span></span>)-&gt;onDelete(<span class="hljs-string"><span class="hljs-string">'cascade'</span></span>); }); } ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::table(<span class="hljs-string"><span class="hljs-string">'comments'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;dropForeign(<span class="hljs-string"><span class="hljs-string">'comments_user_id_foreign'</span></span>); $table-&gt;dropForeign(<span class="hljs-string"><span class="hljs-string">'comments_offer_id_foreign'</span></span>); $table-&gt;dropIndex(<span class="hljs-string"><span class="hljs-string">'comments_user_id_index'</span></span>); $table-&gt;dropIndex(<span class="hljs-string"><span class="hljs-string">'comments_offer_id_index'</span></span>); }); } } ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddForeignCityIdAndCompanyIdToOffersTable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::table(<span class="hljs-string"><span class="hljs-string">'offers'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;index(<span class="hljs-string"><span class="hljs-string">'city_id'</span></span>); $table-&gt;index(<span class="hljs-string"><span class="hljs-string">'company_id'</span></span>); $table-&gt;foreign(<span class="hljs-string"><span class="hljs-string">'city_id'</span></span>)-&gt;references(<span class="hljs-string"><span class="hljs-string">'id'</span></span>)-&gt;on(<span class="hljs-string"><span class="hljs-string">'cities'</span></span>)-&gt;onDelete(<span class="hljs-string"><span class="hljs-string">'cascade'</span></span>); $table-&gt;foreign(<span class="hljs-string"><span class="hljs-string">'company_id'</span></span>)-&gt;references(<span class="hljs-string"><span class="hljs-string">'id'</span></span>)-&gt;on(<span class="hljs-string"><span class="hljs-string">'companies'</span></span>)-&gt;onDelete(<span class="hljs-string"><span class="hljs-string">'cascade'</span></span>); }); } ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::table(<span class="hljs-string"><span class="hljs-string">'offers'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;dropForeign(<span class="hljs-string"><span class="hljs-string">'offers_city_id_foreign'</span></span>); $table-&gt;dropForeign(<span class="hljs-string"><span class="hljs-string">'offers_company_id_foreign'</span></span>); $table-&gt;dropIndex(<span class="hljs-string"><span class="hljs-string">'offers_city_id_index'</span></span>); $table-&gt;dropIndex(<span class="hljs-string"><span class="hljs-string">'offers_company_id_index'</span></span>); }); } }</code> </pre><br>  Having taken a look at the DB scheme, we see the situation better. <br><img src="https://habrastorage.org/getpro/habr/post_images/c8f/5e8/d60/c8f5e8d60f3b3a4790c49f8f07f4ada6.png" alt="Cool DB Schema"><br><br>  At the moment, all links to resources are open, and you can go to anyone for them. <br>  Suppose we add the admin role.  Following the link <a href="http://localhost:8000/roles">http: // localhost: 8000 / roles</a> we see the following picture: <br><img src="https://habrastorage.org/getpro/habr/post_images/e27/1ea/f60/e271eaf60c8f97d642fc6bb6a748bd97.png" alt="Admin role added"><br><br>  A bit about templates and <a href="http://laravel.com/docs/templates">Blade's</a> template in Laravel. <br>  For template files, the extension <u>.blade.php is used</u> .  Looking into the file <i>app / views / layouts / scaffold.blade.php</i> we see <br><br><pre> <code class="html hljs xml">// app/views/layouts/scaffold.blade.php <span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">table</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">form</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-bottom</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">form</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">ul</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">list-style</span></span></span><span class="css">: none; } </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.error</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: red; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-style</span></span></span><span class="css">: italic; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding-top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">20px</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (Session::has('message')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flash alert"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ Session::get('message') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @yield('main') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  What's going on here?  The file itself is a skeleton, a layout, which can be expanded by adding some content inside the <code>main</code> section, or another template.  Double curly braces <b>{{$ var}}</b> are analogous to <b>&lt;? Php echo $ var;</b>  <b>?&gt;</b> .  The <a href="http://laravel.com/docs/session">Session</a> class is used here to display messages to the user if we pass a message.  The message is temporary and will disappear when the page is refreshed.  If we open the newly created template <i>app / views / roles / index.blade.php</i> <br><br><pre> <code class="html hljs xml">// app/views/roles/index.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>All Roles<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('roles.create', 'Add new role') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @if ($roles-&gt;count()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table table-striped table-bordered"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Role<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach ($roles as $role) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $role-&gt;role }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('roles.edit', 'Edit', array($role-&gt;id), array('class' =&gt; 'btn btn-info')) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('method' =&gt; 'DELETE', 'route' =&gt; array('roles.destroy', $role-&gt;id))) }} {{ Form::submit('Delete', array('class' =&gt; 'btn btn-danger')) }} {{ Form::close() }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> @else There are no roles @endif @stop</code> </pre><br>  It will become clear to us that this template extends the template <i>app / views / layouts / scaffold.blade.php</i> , the code <code>@extends('layouts.scaffold')</code> speaks for it.  Note that here a point is used to separate folders, although you can also use <b>/</b> . <br><br>  Further, in the <code>main</code> section, everything will be recorded until the first appearance of <code>@stop</code> .  Also here we use the familiar <code>if - else - endif</code> and <code>foreach - endforeach</code> , the auxiliary function <code>link_to_route</code> , which Laravel provides for us (Helper Functions) and the <code>Form</code> class to create forms (preferably you need to use it, at least Form :: open (), so how it creates an additional attribute of the <a href="http://laravel.com/docs/html">_token</a> form - protection against forgery of cross- <a href="http://laravel.com/docs/html">site</a> requests and <a href="http://laravel.com/docs/html">_method</a> in the case of PUT / PATCH or DELETE). <br><br>  First of all we will think about the protection of all resources.  For this we need to enter the authorization. <br><br>  Create a new <code>LoginContoller</code> controller in the <i>app / controllers</i> folder <br><br><pre> <code class="bash hljs">php artisan generate:controller LoginController</code> </pre><br>  And add some templates for it. <br><br><pre> <code class="bash hljs">mkdir app/views/login php artisan generate:view index --path=<span class="hljs-string"><span class="hljs-string">"app/views/login"</span></span> php artisan generate:view register --path=<span class="hljs-string"><span class="hljs-string">"app/views/login"</span></span> php artisan generate:view dashboard --path=<span class="hljs-string"><span class="hljs-string">"app/views/login"</span></span></code> </pre><br>  Now we change the controller itself.  We need 5 methods: <br><ul><li>  index - is responsible for the generation of the login form </li><li>  register - responsible for generating the registration form </li><li>  store - is responsible for registering a new user </li><li>  login - is responsible for logging in to the site </li><li>  logout - responsible for logging in user </li></ul><br>  The modified LoginController controller will look like this: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/LoginController.php class LoginController extends BaseController { /** * Login Form. * * @return Response */ public function index() { return View::make('login.index'); } /** * Registration form. * * @return Response */ public function register() { return View::make('login.register'); } /** * Registring new user and storing him to DB. * * @return Response */ public function store() { $rules = array( 'email' =&gt; 'required|email|unique:users,email', 'password' =&gt; 'required|alpha_num|between:4,50', 'username' =&gt; 'required|alpha_num|between:2,20|unique:users,username' ); $validator = Validator::make(Input::all(), $rules); if($validator-&gt;fails()){ return Redirect::back()-&gt;withInput()-&gt;withErrors($validator); } $user = new User; $user-&gt;email = Input::get('email'); $user-&gt;username = Input::get('username'); $user-&gt;password = Hash::make(Input::get('password')); $user-&gt;save(); Auth::loginUsingId($user-&gt;id); return Redirect::home()-&gt;with('message', 'Thank you for registration, now you can comment on offers!'); } /** * Log in to site. * * @return Response */ public function login() { if (Auth::attempt(array('email' =&gt; Input::get('email'), 'password' =&gt; Input::get('password')), true) || Auth::attempt(array('username' =&gt; Input::get('email'), 'password' =&gt; Input::get('password')), true)) { return Redirect::intended('dashboard'); } return Redirect::back()-&gt;withInput(Input::except('password'))-&gt;with('message', 'Wrong creadentials!'); } /** * Log out from site. * * @return Response */ public function logout() { Auth::logout(); return Redirect::home()-&gt;with('message', 'See you again!'); } }</span></span></code> </pre><br>  The first two methods are generated from HTML templates. <br>  The <code>store</code> method saves a new user to our database, accepting all incoming data via <code>POST</code> from <code>Input::all()</code> .  ( <a href="http://laravel.com/docs/requests">More info</a> ). <br>  The <code>Input</code> class contains the data that was sent during the POST request.  It has a number of static methods, such as <code>all()</code> , <code>get()</code> , <code>has()</code> and others ( <a href="http://laravel.com/docs/requests">Basic Input</a> ). <br><br>  <code>Hash</code> is an encryption class that uses the <a href="http://ru.wikipedia.org/wiki/Bcrypt">bcrypt</a> method to <a href="http://ru.wikipedia.org/wiki/Bcrypt">store</a> passwords in the database in an encrypted form ( <a href="http://laravel.com/docs/security">Laravel Security</a> ). <br><br>  But before registering, we need to validate the incoming data. <br>  For this, <code>Laravel</code> has a class <a href="http://laravel.com/docs/validation">Validator</a> .  The <code>Validation::make</code> method takes 2 or 3 arguments: <br><ol><li>  <code>$input</code> - required, array of input data to be checked </li><li>  <code>$rules</code> - required, array with rules for incoming data </li><li>  <code>$messages</code> - optional, error message array </li></ol><br>  A complete list of available rules can be found here <a href="http://laravel.com/docs/validation">Available Validation Rules</a> . <br><br>  The <code>fails()</code> method returns <b>true</b> or <b>false</b> depending on whether the data passed validation in accordance with the rules that we passed to the <code>make</code> method. <br><br>  The <a href="http://laravel.com/docs/responses">Redirect</a> class is used for redirection.  His methods are: <br><ul><li>  back () - redirects to the page from which the request was sent </li><li>  intended ('fallback') - redirects to the page from which the user came under the authorization filter, if not, then send to the URL, which is transmitted in the <code>fallback</code> </li><li>  withInput () - will transfer data with Input to a temporary session </li><li>  withErrors ($ validator) - will transfer to <b>$ errors</b> variable data with <code>$validator</code> (! It is important to know that <b>$ errors</b> variable is created on all pages during GET requests, therefore it is always available on all pages). </li><li>  with ('variable', 'Your message here') - will transfer to the temporary session the variable 'variable' with the message that you specify </li></ul><br><br>  The <code>Auth</code> class is an authorization class, it has a number of methods, including <code>loginUsingId($id)</code> , which authorizes the user by the specified identifier from the database ( <a href="http://laravel.com/docs/security">Authenticating Users</a> ).  Since after registration we want to automatically authorize the user, we will use it. <br><br>  The <code>login()</code> method of our Controller authorizes the user by <code>email</code> or <code>username</code> and redirects to the page from which he came under the authorization filter.  If the data does not match, it redirects back with incoming data, an error message, but without a password. <br><br>  So we have a controller that is responsible for authorization. <br><br>  The next step to hide all resources from access will be to modify the <i>app / routes.php file</i> , which contains the application routes. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::get('/', array('as' =&gt; 'home', function() { return View::make('hello'); })); Route::get('logout', array('as' =&gt; 'login.logout', 'uses' =&gt; 'LoginController@logout')); Route::group(array('before' =&gt; 'un_auth'), function() { Route::get('login', array('as' =&gt; 'login.index', 'uses' =&gt; 'LoginController@index')); Route::get('register', array('as' =&gt; 'login.register', 'uses' =&gt; 'LoginController@register')); Route::post('login', array('uses' =&gt; 'LoginController@login')); Route::post('register', array('uses' =&gt; 'LoginController@store')); }); Route::group(array('before' =&gt; 'admin.auth'), function() { Route::get('dashboard', function() { return View::make('login.dashboard'); }); Route::resource('roles', 'RolesController'); Route::resource('cities', 'CitiesController'); Route::resource('companies', 'CompaniesController'); Route::resource('tags', 'TagsController'); Route::resource('offers', 'OffersController'); Route::resource('comments', 'CommentsController'); }); Route::filter('admin.auth', function() { if (Auth::guest()) { return Redirect::to('login'); } }); Route::filter('un_auth', function() { if (!Auth::guest()) { Auth::logout(); } });</span></span></code> </pre><br>  Clicking now on the link, for example <b>/ roles,</b> we will be redirected to the <b>/ login</b> page, which <code>"index.blade.php"</code> displays only the standard text <code>"index.blade.php"</code> . <br><br>  For all routes enclosed in <code>Route::group(array('before' =&gt; 'admin.auth'))</code> , the <b>admin.auth</b> filter will be applied, which checks whether the user is a guest or not and if it is - send it to the login page.  You can read about filters <a href="http://laravel.com/docs/routing">here</a> , but about grouping routes <a href="http://laravel.com/docs/routing">here</a> .  The other filter <code>Route::group(array('before' =&gt; 'un_auth'))</code> will check if the user is logged on to the site, and if the check is performed, then he will log him out. <br><br>  For normal operation, change the login and registration files: <br><br><pre> <code class="html hljs xml">// app/views/login/index.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('login.register', 'Register') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('route' =&gt; 'login.index')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('email', 'Email or Username:') }} {{ Form::text('email') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('password', 'Password:') }} {{ Form::password('password') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Submit', array('class' =&gt; 'btn btn-info')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @include('partials.errors', $errors) @stop // app/views/login/register.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('login.index', 'Login') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('route' =&gt; 'login.register')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('email', 'Email:') }} {{ Form::text('email') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('username', 'Username:') }} {{ Form::text('username') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('password', 'Password:') }} {{ Form::password('password') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Submit', array('class' =&gt; 'btn btn-info')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @include('partials.errors', $errors) @stop // app/views/login/dashboard.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Administrative Dashboard<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Nice to see you, <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ Auth::user()-&gt;username }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @stop // app/views/partials/errors.blade.php @if ($errors-&gt;any()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ implode('', $errors-&gt;all('<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span>:message<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> @endif</code> </pre><br>  As you noticed, here I used a new trick in the <code>@include('view', $variable)</code> template <code>@include('view', $variable)</code> .  In the application it is very simple - pass 2 arguments: <br><ol><li>  view - the template to be included in a specific template </li><li>  $ variable - the variable to be passed to draw the template </li></ol><br>  Register on the site to have access to the site. <br><br>  Well, now you can do resources.  Let's start with the cities.  First of all, in the <code>City</code> Model we will change the validation rules: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/City.php class City extends Eloquent { protected $guarded = array(); public static $rules = array( 'name' =&gt; 'required|alpha|min:2|max:200|unique:cities,name' ); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After it, we will change the validation rules for the Models </font></font><code>Company</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as </font></font><code>Role</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">well </font><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">and </font></font><code>Tag</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Company.php ... public static $rules = array( 'name' =&gt; 'required|alpha|min:2|max:200|unique:companies,name' ); ... // app/models/Role.php ... public static $rules = array( 'role' =&gt; 'required|alpha|min:2|max:200|unique:roles,role' ); ... // app/models/Tag.php ... public static $rules = array( 'name' =&gt; 'required|min:2|max:200|unique:tags,name' ); ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the convenience of navigating between links, add a menu to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / layouts / scaffold.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as well as add jQuery and jQuery-UI for future needs</font></font><br><br><pre> <code class="html hljs xml">// app/views/layouts/scaffold.blade.php <span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">table</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">form</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-bottom</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">form</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">ul</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">list-style</span></span></span><span class="css">: none; } </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.error</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: red; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-style</span></span></span><span class="css">: italic; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding-top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">20px</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">input</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">textarea</span></span></span><span class="css">, </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.uneditable-input</span></span></span><span class="css"> {</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">min-width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">200px</span></span></span><span class="css">;} </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> @yield('styles') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav nav-pills"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('offers.index', 'Offers') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('tags.index', 'Tags') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('roles.index', 'Roles') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('cities.index', 'Cities') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('comments.index', 'Comments') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('companies.index', 'Companies') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pull-right"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('login.logout', 'Logout') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> @if (Session::has('message')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flash alert"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ Session::get('message') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @yield('main') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//code.jquery.com/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//code.jquery.com/ui/1.10.3/jquery-ui.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> @yield('scripts') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we proceed to editing the validation rules in the Model </font></font><code>Offer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Offer.php ... public static $rules = array( 'title' =&gt; 'required|between:5,200', 'description' =&gt; 'required|min:10', 'city_id' =&gt; 'required|exists:cities,id', 'company_id' =&gt; 'required|exists:companies,id', 'off' =&gt; 'required|numeric|min:1|max:100', 'image' =&gt; 'required|regex:/\/images\/\d{4}\/\d{2}\/\d{2}\/([A-z0-9]){30}\.jpg/', // matches /images/2012/12/21/ThisIsTheEndOfTheWorldMaya2112.jpg 'expires' =&gt; 'required|date' );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I used a complex pattern for the field </font></font><code>image</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, because I want to use the tools </font></font><code>AJAX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for uploading pictures, and pass only the path to the picture on the server to the validation itself. </font><font style="vertical-align: inherit;">So let's start by changing the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / create.blade.php template</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and creating a separate file for the scripts.</font></font><br><br><pre> <code class="html hljs xml">// app/views/offers/create.blade.php ... {{ Form::label('file', 'Image:') }} {{ Form::file('file')}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"thumb"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"max-width:300px; max-height: 200px; display: block;"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::hidden('image') }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ... @section('scripts') @include('offers.scripts') @stop // app/views/offers/scripts.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//     $('#expires').datepicker({dateFormat: "yy-mm-dd"}); var uploadInput = $('#file'), //    imageInput = $('[name="image"]'), //   URL  thumb = document.getElementById('thumb'), //   error = $('div.error'); //      uploadInput.on('change', function(){ //     FormData var data = new FormData(); //      data.append('file', uploadInput[0].files[0]); //    $.ajax({ //   URL    url: '/upload', //   type: 'POST', //     data: data, //     jQuery   processData: false, //     jQuery    contentType: false, //      dataType: 'json', //      success: function(result) { //     (    result) //      filelink if (result.filelink) { //   URL    thumb.setAttribute('src', result.filelink); //    input' imageInput.val(result.filelink); //   error.hide(); } else { //      error.text(result.message); error.show(); } }, // -    error: function (result) { //     error.text("Upload impossible"); error.show(); } }); }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we will add the image by pressing the </font></font><code>input[name="file"]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and send it using the </font></font><code>AJAX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ upload. </font><font style="vertical-align: inherit;">The response from this URL will be a link to the uploaded image. </font><font style="vertical-align: inherit;">We will insert this link in the src attribute of the #thumb image and save it in a hidden input </font></font><code>image</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Next we need to </font><font style="vertical-align: inherit;">add a route </font><font style="vertical-align: inherit;">in the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> routes.php </font></font><code>upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::group(array('before' =&gt; 'admin.auth'), function(){ ... Route::resource('comments', 'CommentsController'); Route::post('upload', array('uses' =&gt; 'HomeController@uploadOfferImage')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ok, we have registered the URL, it remains to register the logic in </font></font><code>HomeController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To do this, in the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / controllers / HomeController.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> add the </font></font><code>uploadOfferImage</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">min </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php class HomeController extends BaseController { ... public function uploadOfferImage() { $rules = array('file' =&gt; 'mimes:jpeg,png'); $validator = Validator::make(Input::all(), $rules); if ($validator-&gt;fails()) { return Response::json(array('message' =&gt; $validator-&gt;messages()-&gt;first('file'))); } $dir = '/images'.date('/Y/m/d/'); do { $filename = str_random(30).'.jpg'; } while (File::exists(public_path().$dir.$filename)); Input::file('file')-&gt;move(public_path().$dir, $filename); return Response::json(array('filelink' =&gt; $dir.$filename)); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is quite simple: the rules, validation, errors, the answer. </font><font style="vertical-align: inherit;">To save for a start, we will set the folder in which we will save it - this is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public_path () / images / current year / month / date /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (( </font></font><code>public_path()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is an auxiliary function </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the path to public files), then we will create a random file name with a </font></font><code>str_random(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">length of 30 characters and extension </font></font><code>jpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">After that, we use the class </font></font><code>Input</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and its method </font></font><code>file('file')-&gt;move('destination_path', 'filename')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where: 'file' is the incoming file, 'destination_path' is the folder to which we are moving the file, 'filename' is the name for the file to be saved. </font></font><br> <code>Response::json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will give a response in the format </font></font><code>json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>  Fine!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files are now loaded with </font></font><code>AJAX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/a4a/15a/ba7/a4a15aba7b5a85fbb4146554d9276c49.png" alt="AJAX upload Laravel"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next step will be a change </font></font><code>Form::input('number', 'city_id')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and </font></font><code>Form::input('number', 'company_id')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at Selecta with real data.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/views/offers/create.blade.php ... </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> $cities = array(0 =&gt; 'Choose city'); foreach (City::get(array('id', 'name')) as $city) { $cities[$city-&gt;id] = $city-&gt;name; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;li&gt; {{ Form::label('city_id', 'City_id:') }} {{ Form::select('city_id', $cities) }} &lt;/li&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> $companies = array(0 =&gt; 'Choose company'); foreach (Company::get(array('id', 'name')) as $company) { $companies[$company-&gt;id] = $company-&gt;name; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;li&gt; {{ Form::label('company_id', 'Company_id:') }} {{ Form::select('company_id', $companies) }} &lt;/li&gt; ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How selects work you can see here </font></font><a href="http://laravel.com/docs/html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forms &amp; Html (Dropdown Lists)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Thus, we have the opportunity to choose from existing cities and companies in the database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What we still lack is the addition of tags to discounts. </font><font style="vertical-align: inherit;">This is </font></font><a href="http://jqueryui.com/autocomplete/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where jquery-ui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help us </font><a href="http://jqueryui.com/autocomplete/"><font style="vertical-align: inherit;">with autocomplete</font></a><font style="vertical-align: inherit;"> to add multiple values. </font><font style="vertical-align: inherit;">To do this, expand the script file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / create.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="html hljs xml">// app/views/offers/scripts.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ ... function split( val ) { </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> val.split( </span><span class="hljs-regexp"><span class="javascript"><span class="hljs-regexp">/,\s*/</span></span></span><span class="javascript"> ); } </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">extractLast</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params"> term </span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> split( term ).pop(); } $( </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"#tags"</span></span></span><span class="javascript"> ) </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// don't navigate away from the field on tab when selecting an item .bind( "keydown", function( event ) { if ( event.keyCode === $.ui.keyCode.TAB &amp;&amp; $( this ).data( "ui-autocomplete" ).menu.active ) { event.preventDefault(); } }) .autocomplete({ source: function( request, response ) { $.getJSON( "/tags", { term: extractLast( request.term ), }, function( data ) { response($.map(data, function(item) { return { value: item.name } })) } ); }, search: function() { // custom minLength var term = extractLast( this.value ); if ( term.length &lt; 2 ) { return false; } }, focus: function() { // prevent value inserted on focus return false; }, select: function( event, ui ) { console.log(ui); console.log(this); var terms = split( this.value ); // remove the current input terms.pop(); // add the selected item terms.push( ui.item.value ); // add placeholder to get the comma-and-space at the end terms.push( "" ); this.value = terms.join( ", " ); return false; } }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a standard use case from </font></font><a href="http://jqueryui.com/autocomplete/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jqueryui.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , only slightly modified at the response point from the server. </font><font style="vertical-align: inherit;">As you can see, the appeal goes to the address </font></font><code>/tags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We organize the logic of the response to the </font></font><code>AJAX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request for this </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/TagController.php class TagsController extends BaseController { ... /** * Display a listing of the resource. * * @return Response */ public function index() { $tags = $this-&gt;tag-&gt;all(); //   AJAX  if (Request::ajax()) { //    ,      $tags = Tag::where('name', 'like', '%'.Input::get('term', '').'%')-&gt;get(array('name')); //     json return $tags; } return View::make('tags.index', compact('tags')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interestingly, what is </font></font><code>Eloquent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">converted to a format </font></font><code>json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if we return it, so there is no need to use it </font></font><code>Response::json()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And here we auto-complete tags. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last thing we need to do is change the logic for creating discounts.</font></font><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/OffersController.php class OffersController extends BaseController { ... /** * Store a newly created resource in storage. * * @return Response */ public function store() { $rules = Offer::$rules; $rules['expires'] .= '|after:'.date('Ym-d', strtotime('+1 day')).'|before:'.date('Ym-d', strtotime('+1 month')); $validation = Validator::make(Input::all(), $rules); if ($validation-&gt;passes()) { $tags = array(); foreach (explode(', ', Input::get('tags')) as $tag_name) { if ($tag = Tag::where('name', '=', $tag_name)-&gt;first()) { $tags[] = $tag-&gt;id; } } if (count($tags) == 0) { return Redirect::route('offers.create') -&gt;withInput() -&gt;with('message', 'Insert at least one tag.'); } $offer = $this-&gt;offer-&gt;create(Input::except('tags', 'file')); $offer-&gt;tags()-&gt;sync($tags); return Redirect::route('offers.index'); } return Redirect::route('offers.create') -&gt;withInput() -&gt;withErrors($validation) -&gt;with('message', 'There were validation errors.'); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, we expand the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expires</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rule </font><font style="vertical-align: inherit;">, so that the discount ends not earlier than tomorrow, and no later than in 1 month. </font><font style="vertical-align: inherit;">Next, select all the </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tags in a separate array, checking their presence in the database. </font><font style="vertical-align: inherit;">After there is a small check whether tags are entered. </font><font style="vertical-align: inherit;">And at the very end there is a very interesting trick: in Eloquent for a bunch of tables, you can use different relationships ( </font></font><a href="http://laravel.com/docs/eloquent"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eloquent Relationships</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), for example, the Model Offers can have many tags, respectively, we write it in the Model</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Offer.php ... public function tags() { return $this-&gt;belongsToMany('Tag'); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we have created a link between one entry in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">and many entries in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now, turning to the method, </font></font><code>$offer-&gt;tags()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we can get all the tags to which a specific discount is attached. </font><font style="vertical-align: inherit;">But in this example, we still use a special method for working with intermediate tables </font></font><code>sync(array(1, 2, 3))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will be written into the intermediate table as </font></font><code>offer_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needed </font></font><code>tag_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Table </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offer_tag</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/2ea/9f3/b1f/2ea9f3b1f8f89147c6cb9aba70ae6da3.png" alt="Pivot table offer to tag"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also need to specify the link between the record in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">and the records in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cities</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">companies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tables </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Offer.php ... public function city() { return $this-&gt;belongsTo('City'); } public function company() { return $this-&gt;belongsTo('Company'); } public function tags() { return $this-&gt;belongsToMany('Tag'); } //         +     public function webDescription($options = array()) { $str = $this-&gt;description; if (isset($options['shorten'])) { $length = isset($options['length']) ? (int) $options['length'] : 250; $end = isset($options['end']) ? : '‚Ä¶'; if (mb_strlen($str) &gt; $length) { $str = mb_substr(trim($str), 0, $length); $str = mb_substr($str, 0, mb_strlen($str) - mb_strpos(strrev($str), ' ')); $str = trim($str.$end); } } $str = str_replace("\r\n", '&lt;br&gt;', e($str)); return $str; } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains to change the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / index.blade.php</font></font></i> <br><br><pre> <code class="html hljs xml">// app/views/offers/index.blade.php @if ($offers-&gt;count()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table table-striped table-bordered"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Description<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>City<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Company<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Off<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Image<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Tags<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Expires<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach ($offers as $offer) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;title }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $offer-&gt;webDescription(array('shorten' =&gt; true, 'length' =&gt; 60)) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;city-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;company-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;off }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"max-width: 200px; max-height:150px;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach($offer-&gt;tags as $tag) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{$tag-&gt;name}}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;expires }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> {{ link_to_route('offers.edit', 'Edit', array($offer-&gt;id), array('class' =&gt; 'btn btn-info')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('method' =&gt; 'DELETE', 'route' =&gt; array('offers.destroy', $offer-&gt;id))) }} {{ Form::submit('Delete', array('class' =&gt; 'btn btn-danger')) }} {{ Form::close() }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> @else There are no offers @endif</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And we see an excellent picture that fully reflects the structure of the discount: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/f9e/bc6/86b/f9ebc686bd4f3969fb9d54d047799cea.png" alt="All offers"><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{{{$ string}}}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> displays the contents of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ string</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , having previously run through </font></font><code>htmlentities</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, I mean, converts non-safe characters, which protects them from XSS. </font><font style="vertical-align: inherit;">Analog is </font></font><code>&lt;?php echo htmlentities($string); ?&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or auxiliary function</font></font><code>Laravel</code> <code>e($string)</code> </blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it remains to change </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / edit.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / show.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the method </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / controllers / OfferController.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / edit.blade.php</font></font></i> <br><pre> <code class="html hljs xml">// app/views/offers/edit.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Edit Offer<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::model($offer, array('method' =&gt; 'PATCH', 'route' =&gt; array('offers.update', $offer-&gt;id))) }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('title', 'Title:') }} {{ Form::text('title') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('description', 'Description:') }} {{ Form::textarea('description') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> $cities = </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php"> =&gt; </span><span class="hljs-string"><span class="php"><span class="hljs-string">'Choose city'</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">foreach</span></span></span><span class="php"> (City::get(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'id'</span></span></span><span class="php">, </span><span class="hljs-string"><span class="php"><span class="hljs-string">'name'</span></span></span><span class="php">)) </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">as</span></span></span><span class="php"> $city) { $cities[$city-&gt;id] = $city-&gt;name; } </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('city_id', 'City_id:') }} {{ Form::select('city_id', $cities) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> $companies = </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php"> =&gt; </span><span class="hljs-string"><span class="php"><span class="hljs-string">'Choose company'</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">foreach</span></span></span><span class="php"> (Company::get(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'id'</span></span></span><span class="php">, </span><span class="hljs-string"><span class="php"><span class="hljs-string">'name'</span></span></span><span class="php">)) </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">as</span></span></span><span class="php"> $company) { $companies[$company-&gt;id] = $company-&gt;name; } </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('company_id', 'Company_id:') }} {{ Form::select('company_id', $companies) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('off', 'Off:') }} {{ Form::input('number', 'off') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('file', 'Image:') }} {{ Form::file('file')}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"thumb"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"max-width:300px; max-height: 200px; display:block; "</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::hidden('image') }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('expires', 'Expires:') }} {{ Form::text('expires') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('tags', 'Tags:') }} {{ Form::text('tags', Input::old('tags', implode(', ', array_fetch($offer-&gt;tags()-&gt;get(array('name'))-&gt;toArray(), 'name')))) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Update', array('class' =&gt; 'btn btn-info')) }} {{ link_to_route('offers.show', 'Cancel', $offer-&gt;id, array('class' =&gt; 'btn')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @if ($errors-&gt;any()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ implode('', $errors-&gt;all('<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span>:message<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @stop @section('scripts') @include('offers.scripts') @stop</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The changes are very similar to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / create.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , only there is a slight difference in and </font></font><code>{{ Form::text('tags', ... }}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Everything is clear with the picture: if there is an old input - replace it with it, if it doesn‚Äôt, then with the value of </font></font><code>image</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our discount. In the </font></font><code>Form::text('tags', ... )</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first place, we took all the tags that relate to a particular discount </font></font><code>$offer-&gt;tags()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and removed only the fields from the database </font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Next, we used the auxiliary function from </font></font><code>Laravel</code> <a href="http://laravel.com/docs/helpers"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_fetch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so that we would have a one-dimensional array, and at the end we connected this array to the string, inserting a comma and a space between them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the method </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>OfferController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/OfferController.php class OffersController extends BaseController { ... public function update($id) { $offer = $this-&gt;offer-&gt;findOrFail($id); $rules = Offer::$rules; $rules['expires'] .= '|after:'.date('Ym-d', strtotime('+1 day')).'|before:'.date('Ym-d', strtotime('+1 month')); $validation = Validator::make(Input::all(), $rules); if ($validation-&gt;passes()) { $tags = array(); foreach (explode(', ', Input::get('tags')) as $tag_name) { if ($tag = Tag::where('name', '=', $tag_name)-&gt;first()) { $tags[] = $tag-&gt;id; } } if (count($tags) == 0) { return Redirect::route('offers.create') -&gt;withInput() -&gt;withErrors($validation) -&gt;with('message', 'Insert at least one tag.'); } $offer-&gt;update(Input::except('tags', 'file', '_method')); $offer-&gt;tags()-&gt;sync($tags); return Redirect::route('offers.show', $id); } return Redirect::route('offers.edit', $id) -&gt;withInput() -&gt;withErrors($validation) -&gt;with('message', 'There were validation errors.'); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The difference with the method of addition is minimal. </font><font style="vertical-align: inherit;">First, we will throw away the 404 error, if the wrong one is given </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, secondly we will use the method </font></font><code>update($id)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">That's all the change. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, change the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / show.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="html hljs xml">// app/views/offers/show.blade.php ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Description<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>City_id<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Company_id<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Off<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Image<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Tags<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Expires<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;title }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $offer-&gt;webDescription(array('shorten' =&gt; true, 'length' =&gt; 60)) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;city-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;company-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;off }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"max-width: 200px; max-height:150px;"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach($offer-&gt;tags as $tag) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $tag-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;expires }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now and after changing the discount, we will have a nice display of its structure with an image and all relational data. </font></font><br><br><h5>  home page of the site </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The time has finally come to create the main page of the site. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, create a new one </font></font><code>layout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="html hljs xml">// app/views/layouts/main.blade.php <span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ asset('css/main.css') }}"</span></span></span><span class="hljs-tag">&gt;</span></span> @yield('styles') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar navbar-fixed-top"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-inner"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"brand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home') }}"</span></span></span><span class="hljs-tag">&gt;</span></span>Habr Offers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home') }}"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (Session::has('message')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flash alert"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ Session::get('message') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @yield('main') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//code.jquery.com/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> @yield('scripts') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As well as the style file: </font></font><br><br><pre> <code class="css hljs">// <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span>/<span class="hljs-selector-tag"><span class="hljs-selector-tag">css</span></span>/<span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.css</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        -     */</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">padding-top</span></span>: <span class="hljs-number"><span class="hljs-number">60px</span></span>;} <span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.no_decoration</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.no_decoration</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">text-decoration</span></span>: none;} <span class="hljs-comment"><span class="hljs-comment">/*           /  */</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.thumbnail</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.image-container</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">max-height</span></span>: <span class="hljs-number"><span class="hljs-number">200px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">overflow</span></span>: hidden;} <span class="hljs-selector-class"><span class="hljs-selector-class">.thumbnail</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.image-container</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">min-width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">min-height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>;} <span class="hljs-selector-class"><span class="hljs-selector-class">.thumbnail</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h3</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">40px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">overflow</span></span>: hidden;} <span class="hljs-selector-class"><span class="hljs-selector-class">.thumbnail</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.description</span></span> {<span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">overflow</span></span>: hidden;}</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Then we redefine the main page route: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php Route::get('/', array('as' =&gt; 'home', 'uses' =&gt; 'HomeController@index'));</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add to the </font></font><code>HomeController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">missing method </font></font><code>index</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php ... /** * Display a listing of offers. * * @return Response */ public function index() { $offers = Offer::orderBy('created_at', 'desc')-&gt;get(); return View::make('home.index', compact('offers')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / home</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">and add the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><i><font style="vertical-align: inherit;">there</font></i><font style="vertical-align: inherit;"> , as well as create the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_preview.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">in the </font><i><font style="vertical-align: inherit;">app / views / offers</font></i><font style="vertical-align: inherit;"> folder</font></font><i><font style="vertical-align: inherit;"></font></i> <br><br><pre> <code class="html hljs xml">// app/views/home/index.blade.php @extends('layouts.main') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $title }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> @if ($offers-&gt;count()) @foreach ($offers as $key =&gt; $offer) @if($key % 3 == 0) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row-fluid"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"thumbnails"</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"span4"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"thumbnail"</span></span></span><span class="hljs-tag">&gt;</span></span> @include('offers._preview', $offer) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @if($key % 3 == 2 || $key == count($offers) - 1) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @endforeach @else There are no offers @endif @stop // app/views/offers/_preview.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image-container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caption"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;title }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"description"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $offer-&gt;webDescription() }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-important"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;off }}} % off<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Location: {{{ $offer-&gt;city-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Offer by: {{{ $offer-&gt;company-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Expires on: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-warning"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;expires }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Tags: @foreach($offer-&gt;tags as $tag) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{$tag-&gt;name}}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next you need to add a search for discounts on tags, cities and companies. </font><font style="vertical-align: inherit;">To do this, add 3 routes to the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / routes.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> immediately after </font></font><code>home</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::get('by_tag/{name}', array('as' =&gt; 'home.by_tag', 'uses' =&gt; 'HomeController@byTag'))-&gt;where('name', '[A-Za-z0-9 -_]+'); Route::get('by_city/{name}', array('as' =&gt; 'home.by_city', 'uses' =&gt; 'HomeController@byCity'))-&gt;where('name', '[A-Za-z0-9 -_]+'); Route::get('by_company/{name}', array('as' =&gt; 'home.by_company', 'uses' =&gt; 'HomeController@byCompany'))-&gt;where('name', '[A-Za-z0-9 -_]+'); ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now add the missing methods to </font></font><code>HomeController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php ... /** * Display a listing of offers that belongs to tag. * * @param string $name * @return Response */ public function byTag($name) { $tag = Tag::whereName($name)-&gt;firstOrFail(); $offers = $tag-&gt;offers; $title = "Offers tagged as: " . $tag-&gt;name; return View::make('home.index', compact('offers', 'title')); } /** * Display a listing of offers that belongs to city. * * @param string $name * @return Response */ public function byCity($name) { $city = City::whereName($name)-&gt;firstOrFail(); $offers = $city-&gt;offers; $title = "Offers in: " . $city-&gt;name; return View::make('home.index', compact('offers', 'title')); } /** * Display a listing of offers that belongs to company. * * @param string $name * @return Response */ public function byCompany($name) { $company = Company::whereName($name)-&gt;firstOrFail(); $offers = $company-&gt;offers; $title = "Offers by: " . $company-&gt;name; return View::make('home.index', compact('offers', 'title')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For these methods to work correctly, we need to define the links in the Models </font></font><code>City</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Company</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Tag</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/City.php ... public function offers() { return $this-&gt;hasMany('Offer'); } // app/models/Company.php ... public function offers() { return $this-&gt;hasMany('Offer'); } // app/models/Tag.php ... public function offers() { return $this-&gt;belongsToMany('Offer'); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To make this whole thing play, change the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / offers / _preview.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , adding the links:</font></font><br><br><pre> <code class="html hljs xml">// app/views/offers/_preview.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image-container"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.offer', $offer-&gt;id) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caption"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;title }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"description"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $offer-&gt;webDescription() }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-important"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;off }}} % off<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Location: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.by_city', $offer-&gt;city-&gt;name) }}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;city-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Offer by: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.by_company', $offer-&gt;company-&gt;name) }}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;company-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Expires on: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-warning"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;expires }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Tags: @foreach($offer-&gt;tags as $tag) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no_decoration"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.by_tag', $tag-&gt;name) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{$tag-&gt;name}}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click, go, discounts are sorted and displayed in accordance with the criteria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we will make a presentation for viewing a separate discount:</font></font><br><br><pre> <code class="html hljs xml">// app/views/offers/_show.blade.php @extends('layouts.main') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"page-header"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-important label-big"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;off }}}%<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> {{{ $offer-&gt;title }}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span> by <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{{ route('home.by_company', $offer-&gt;company-&gt;name) }}}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;company-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pull-left image-container-big"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"img-rounded"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{{ $offer-&gt;title }}}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"description"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $offer-&gt;webDescription() }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clearfix"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Location: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.by_city', $offer-&gt;city-&gt;name) }}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $offer-&gt;city-&gt;name }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Tags: @foreach($offer-&gt;tags as $tag) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no_decoration"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.by_tag', $tag-&gt;name) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{$tag-&gt;name}}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"page-header"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>User's comments <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span>leave and yours one<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open() }} {{ Form::textarea('body', Input::old('body'), array('class' =&gt; 'input-block-level', 'style' =&gt; 'resize: vertical;'))}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input-append"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::select('mark', array(0 =&gt; 5, 1 =&gt; 4, 2 =&gt; 3, 3 =&gt; 2, 4 =&gt; 1), Input::old('mark', 0)) }} {{ Form::submit('Comment', array('class' =&gt; 'btn btn-success', 'style' =&gt; 'clear: both;')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @include('partials.errors', $errors) @stop // public/css/main.css    body {padding-top: 60px;} .error {color: red;} .no_decoration:hover, .no_decoration:focus {text-decoration: none;} .thumbnail .image-container {width: 100%; max-height: 200px; overflow: hidden; display: block;} .thumbnail .image-container img {min-width: 100%; min-height: 100%;} .thumbnail h3 {height: 40px; overflow: hidden;} .thumbnail .description {height: 100px; overflow: hidden;} .image-container-big {width: 500px; height: 300px; margin: 0 20px 20px 0; text-align: center;} .image-container-big img {max-height: 300px; margin: 0 auto;} .label.label-big {font-size: 32px; line-height: 1.5em; padding: 0 15px; margin-bottom: 5px;}</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to view the discount in full, we will add a route and a method, as well as at the end I added a form for comments. </font><font style="vertical-align: inherit;">For its operation, you also need to add a route and method in the desired controller:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::get('offer_{id}', array('as' =&gt; 'home.offer', 'uses' =&gt; 'HomeController@showOffer'))-&gt;where('id', '[0-9]+'); Route::post('offer_{id}', array('before' =&gt; 'not_guest', 'uses' =&gt; 'HomeController@commentOnOffer'))-&gt;where('id', '[0-9]+'); ... Route::filter('not_guest', function(){ if (Auth::guest()) { return Redirect::back()-&gt;withInput()-&gt;with('message', 'You should be logged in to provide this action.'); } }); // app/controllers/HomeController.php ... /** * Display an offer. * * @param int $id * @return Response */ public function showOffer($id) { $offer = Offer::findOrFail($id); return View::make('offers._show', compact('offer')); } /** * Storing comment on offer. * * @param int $id * @return Response */ public function commentOnOffer($id) { $offer = Offer::findOrFail($id); if ($offer-&gt;usersComments-&gt;contains(Auth::user()-&gt;id)) { return Redirect::back()-&gt;withInput()-&gt;with('message', 'You have already commented on this Offer'); } $rules = array('body' =&gt; 'required|alpha|min:10|max:500', 'mark' =&gt; 'required|numeric|between:1,5'); $validator = Validator::make(Input::all(), $rules); if ($validator-&gt;passes()) { $offer-&gt;usersComments()-&gt;attach(Auth::user()-&gt;id, array('body' =&gt; Input::get('body'), 'mark' =&gt; Input::get('mark'))); return Redirect::back(); } return Redirect::back()-&gt;withInput()-&gt;withErrors($validator); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We will understand everything in order: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> With the presentation of the discount, I hope there are no problems - this is still the same layout + template engine. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the routes, too, everything is simple, everything is the same as before: the link is the controller @ method, except that it </font></font><code>Route::post('/offer_{id}'...)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses a new filter that gives a custom message without authorization.</font></font></li><li> <code>showOffer($id)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also nothing complicated. </font></font></li><li>     .  , ,   <code>id</code>  . <br><br>       <code>offers</code>    .       <code>Offer</code> <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Offer.php ... public function usersComments() { return $this-&gt;belongsToMany('User', 'comments')-&gt;withPivot('body', 'mark')-&gt;withTimestamps(); } ...</span></span></code> </pre><br>  ,      <code>comments</code>  ,  ,          <code>body</code>  <code>mark</code> +       (  ). <br><br>  ,           ( <a href="http://laravel.com/docs/eloquent">contains()</a> ),  .    ‚Äî             . <br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To display comments on the discount page, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">let's modify the app / views / offers / _show.blade.php file a bit.</font></font></i> <br><br><pre> <code class="html hljs xml">// app/views/offers/_show.blade.php ... @if(!$offer-&gt;usersComments-&gt;count()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"well"</span></span></span><span class="hljs-tag">&gt;</span></span>You can be first to comment on this offer!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @if(Auth::guest() || (!Auth::guest() &amp;&amp; !$offer-&gt;usersComments-&gt;contains(Auth::user()-&gt;id))) {{ Form::open() }} {{ Form::textarea('body', Input::old('body'), array('class' =&gt; 'input-block-level', 'style' =&gt; 'resize: vertical;'))}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input-append"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::select('mark', array(5 =&gt; 5, 4 =&gt; 4, 3 =&gt; 3, 2 =&gt; 2, 1 =&gt; 1), Input::old('mark', 5)) }} {{ Form::submit('Comment', array('class' =&gt; 'btn btn-success', 'style' =&gt; 'clear: both;')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @include('partials.errors', $errors) @endif @foreach($offer-&gt;usersComments as $user) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pull-left"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media-object"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"holder.js/64x64"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media-body"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media-heading"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $user-&gt;username }}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-success"</span></span></span><span class="hljs-tag">&gt;</span></span>mark: {{{ $user-&gt;pivot-&gt;mark }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h4</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"muted"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ str_replace("\r\n", '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>', e($user-&gt;pivot-&gt;body)) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach @stop</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, under the discounts, users can leave their comments, one by one, and if the user has already left a comment, the form will not be displayed for him. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next step is to distribute access rights to the site. </font><font style="vertical-align: inherit;">To begin, let us indicate the relationship between users and roles:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/User.php ... public function roles() { return $this-&gt;belongsToMany('Role'); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next, add user role management to the admin panel: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::group(array('before' =&gt; 'admin.auth'), function() { ... Route::resource('users', 'UsersController'); Route::post('upload', array('uses' =&gt; 'HomeController@uploadOfferImage')); }); ... // app/views/layouts/scaffold.blade.php ... &lt;li&gt;{{ link_to_route('users.index', 'Users') }}&lt;/li&gt; &lt;li class="pull-right"&gt;{{ link_to_route('login.logout', 'Logout') }}&lt;/li&gt; ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember that </font></font><code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you need to add a connection </font><font style="vertical-align: inherit;">to the model </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/User.php ... public function roles() { return $this-&gt;belongsToMany('Role'); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a controller </font></font><code>UserController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/UsersController.php class UsersController extends BaseController { /** * User Repository * * @var User */ protected $user; public function __construct(User $user) { $this-&gt;user = $user; } /** * Display a listing of the resource. * * @return Response */ public function index() { $users = $this-&gt;user-&gt;all(); return View::make('users.index', compact('users')); } /** * Display the specified resource. * * @param int $id * @return Response */ public function show($id) { $user = $this-&gt;user-&gt;findOrFail($id); return View::make('users.show', compact('user')); } /** * Show the form for editing the specified resource. * * @param int $id * @return Response */ public function edit($id) { $user = $this-&gt;user-&gt;findOrFail($id); return View::make('users.edit', compact('user')); } /** * Update the specified resource in storage. * * @param int $id * @return Response */ public function update($id) { $user = $this-&gt;user-&gt;findOrFail($id); $roles = array(); foreach (explode(', ', Input::get('roles')) as $role_name) { if ($role = Role::where('role', '=', $role_name)-&gt;first()) { $roles[] = $role-&gt;id; } } $user-&gt;roles()-&gt;sync($roles); return Redirect::route('users.show', $id); } /** * Remove the specified resource from storage. * * @param int $id * @return Response */ public function destroy($id) { $this-&gt;user-&gt;findOrFail($id)-&gt;delete(); return Redirect::route('users.index'); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the folder </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / users</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add 3 files there:</font></font><br><br><pre> <code class="html hljs xml">// app/views/users/index.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>All Users<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> @if ($users-&gt;count()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table table-striped table-bordered"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Username<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Email<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Roles<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach ($users as $user) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $user-&gt;username }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $user-&gt;email }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach($user-&gt;roles as $role) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{$role-&gt;role}}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('users.edit', 'Edit', array($user-&gt;id), array('class' =&gt; 'btn btn-info')) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('method' =&gt; 'DELETE', 'route' =&gt; array('users.destroy', $user-&gt;id))) }} {{ Form::submit('Delete', array('class' =&gt; 'btn btn-danger')) }} {{ Form::close() }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> @else There are no users @endif @stop // app/views/users/show.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Show User<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('users.index', 'Return to all users') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table table-striped table-bordered"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Username<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Email<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Roles<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $user-&gt;username }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $user-&gt;email }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach($user-&gt;roles as $role) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span><span class="hljs-tag">&gt;</span></span>{{{ $role-&gt;role }}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> @endforeach <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('users.edit', 'Edit', array($user-&gt;id), array('class' =&gt; 'btn btn-info')) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open(array('method' =&gt; 'DELETE', 'route' =&gt; array('users.destroy', $user-&gt;id))) }} {{ Form::submit('Delete', array('class' =&gt; 'btn btn-danger')) }} {{ Form::close() }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> @stop // app/views/users/edit.blade.php @extends('layouts.scaffold') @section('main') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Edit User<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::model($user, array('method' =&gt; 'PATCH', 'route' =&gt; array('users.update', $user-&gt;id))) }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('username', 'Username:') }} {{ Form::text('username', $user-&gt;username, array('disabled')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('email', 'Email:') }} {{ Form::text('email', $user-&gt;email, array('disabled')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('roles', 'Roles:') }} {{ Form::text('roles', Input::old('roles', implode(', ', array_fetch($user-&gt;roles()-&gt;get(array('role'))-&gt;toArray(), 'role')))) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Update', array('class' =&gt; 'btn btn-info')) }} {{ link_to_route('users.show', 'Cancel', $user-&gt;id, array('class' =&gt; 'btn')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @if ($errors-&gt;any()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ implode('', $errors-&gt;all('<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span>:message<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @stop @section('scripts') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">split</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params"> val </span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> val.split( </span><span class="hljs-regexp"><span class="javascript"><span class="hljs-regexp">/,\s*/</span></span></span><span class="javascript"> ); } </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">extractLast</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params"> term </span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> split( term ).pop(); } $( </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"#roles"</span></span></span><span class="javascript"> ) </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// don't navigate away from the field on tab when selecting an item .bind( "keydown", function( event ) { if ( event.keyCode === $.ui.keyCode.TAB &amp;&amp; $( this ).data( "ui-autocomplete" ).menu.active ) { event.preventDefault(); } }) .autocomplete({ source: function( request, response ) { $.getJSON( "/roles", { term: extractLast( request.term ), }, function( data ) { response($.map(data, function(item) { return { value: item.role } })) } ); }, search: function() { // custom minLength var term = extractLast( this.value ); if ( term.length &lt; 2 ) { return false; } }, focus: function() { // prevent value inserted on focus return false; }, select: function( event, ui ) { console.log(ui); console.log(this); var terms = split( this.value ); // remove the current input terms.pop(); // add the selected item terms.push( ui.item.value ); // add placeholder to get the comma-and-space at the end terms.push( "" ); this.value = terms.join( ", " ); return false; } }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> @stop</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And also change a little metd </font></font><code>index</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controller</font></font><code>RolesController</code> <br><br><pre> <code class="php hljs"> ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $roles = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;role-&gt;all(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request::ajax()) { $roles = Role::where(<span class="hljs-string"><span class="hljs-string">'role'</span></span>, <span class="hljs-string"><span class="hljs-string">'like'</span></span>, <span class="hljs-string"><span class="hljs-string">'%'</span></span>.Input::get(<span class="hljs-string"><span class="hljs-string">'term'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>).<span class="hljs-string"><span class="hljs-string">'%'</span></span>)-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'role'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $roles; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View::make(<span class="hljs-string"><span class="hljs-string">'roles.index'</span></span>, compact(<span class="hljs-string"><span class="hljs-string">'roles'</span></span>)); } ...</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now autocompletion works. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, in order for us to have no runs, we will roll back all the migrations and use the excellent tool that is provided to us </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is </font></font><a href="http://laravel.com/docs/migrations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DatabaseSeeder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">With it, we can fill our database with some configuration, or start / test data. </font><font style="vertical-align: inherit;">To do this, first create a class </font></font><code>UsersTableSeeder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / database / seeds</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/database/seeds/UsersTableSeeder.php class UsersTableSeeder extends Seeder { public function run() { $users = array( array( 'username' =&gt; 'habrahabr', 'email' =&gt; 'habrahabr@habr.com', 'password' =&gt; Hash::make('habr'), 'updated_at' =&gt; DB::raw('NOW()'), 'created_at' =&gt; DB::raw('NOW()'), ) ); DB::table('users')-&gt;insert($users); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The logic is as follows: clear the table, create an array of data and insert it into the database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do the same with </font></font><code>RolesTableSeeder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/database/seeds/RolesTableSeeder.php class RolesTableSeeder extends Seeder { public function run() { $roles = array( array( 'role' =&gt; 'admin', 'updated_at' =&gt; DB::raw('NOW()'), 'created_at' =&gt; DB::raw('NOW()') ), array( 'role' =&gt; 'manager', 'updated_at' =&gt; DB::raw('NOW()'), 'created_at' =&gt; DB::raw('NOW()') ), array( 'role' =&gt; 'moderator', 'updated_at' =&gt; DB::raw('NOW()'), 'created_at' =&gt; DB::raw('NOW()') ) ); DB::table('roles')-&gt;insert($roles); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I also added roles </font></font><code>manager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>moderator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in order to give users with these roles access to individual resources in the admin panel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, create another class </font></font><code>Seeder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/database/seeds/RoleUserTableSeeder.php class RoleUserTableSeeder extends Seeder { public function run() { // Uncomment the below to wipe the table clean before populating DB::table('role_user')-&gt;truncate(); $role_user = array( array('user_id' =&gt; 1, 'role_id' =&gt; 1) ); // Uncomment the below to run the seeder DB::table('role_user')-&gt;insert($role_user); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So we added the role to </font></font><code>admin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our first user. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To clear the database and fill it with our initial data, first modify the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / database / seeds / DatabaseSeeder.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as follows:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/database/seeds/DatabaseSeeder class DatabaseSeeder extends Seeder { /** * Run the database seeds. * * @return void */ public function run() { Eloquent::unguard(); //         $this-&gt;call('UsersTableSeeder'); $this-&gt;call('RolesTableSeeder'); $this-&gt;call('RoleUserTableSeeder'); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And to accept all changes, run the command via the console (being in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ workspace / php / habr / folder</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><br><pre> <code class="bash hljs">php artisan migrate:refresh --seed</code> </pre><br> <code>migrate:refresh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rolls back all the migrations, and then launches them again, and the option </font></font><code>--seed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will indicate that you also need to start </font></font><code>DatabaseSeeder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we build the logic on the right. </font><font style="vertical-align: inherit;">Make changes to the Model </font></font><code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/User.php ... public function isAdmin() { $admin_role = Role::whereRole('admin')-&gt;first(); return $this-&gt;roles-&gt;contains($admin_role-&gt;id); } ... public function isManager() { $manager_role = Role::whereRole('manager')-&gt;first(); return $this-&gt;roles-&gt;contains($manager_role-&gt;id) || $this-&gt;isAdmin(); } ... public function isModerator() { $admin_role = Role::whereRole('admin')-&gt;first(); return $this-&gt;roles-&gt;contains($admin_role-&gt;id) || $this-&gt;isAdmin(); } ... public function isRegular() { $roles = array_filter($this-&gt;roles-&gt;toArray()); return empty($roles); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next, we will change the route file so that it conforms to the rights to use the site: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::post('offer_{id}', array('before' =&gt; 'not_guest|regular_user', 'uses' =&gt; 'HomeController@commentOnOffer'))-&gt;where('id', '[0-9]+'); ... Route::group(array('before' =&gt; 'admin.auth'), function() { Route::get('dashboard', function() { return View::make('dasboard'); }); Route::group(array('before' =&gt; 'manager_role_only'), function() { Route::resource('cities', 'CitiesController'); Route::resource('companies', 'CompaniesController'); Route::resource('tags', 'TagsController'); Route::resource('offers', 'OffersController'); Route::post('upload', array('uses' =&gt; 'HomeController@uploadOfferImage')); }); Route::resource('comments', 'CommentsController'); Route::group(array('before' =&gt; 'manager_role_only'), function() { Route::resource('roles', 'RolesController'); Route::resource('users', 'UsersController'); }); }); Route::when('comments*', 'moderator_role_only'); Route::filter('admin_role_only', function() { if (Auth::user()-&gt;isAdmin()) { return Redirect::intended('/')-&gt;withMessage('You don\'t have enough permissions to do that.'); } }); Route::filter('manager_role_only', function() { if (!Auth::user()-&gt;isManager()) { return Redirect::intended('/')-&gt;withMessage('You don\'t have enough permissions to do that.'); } }); Route::filter('moderator_role_only', function() { if (!Auth::user()-&gt;isModerator()) { return Redirect::intended('/')-&gt;withMessage('YYou don\'t have enough permissions to do that.'); } }); Route::filter('admin.auth', function() { if (Auth::guest()) { return Redirect::to('login'); } }); Route::filter('un_auth', function() { if (!Auth::guest()) { Auth::logout(); } }); Route::filter('not_guest', function(){ if (Auth::guest()) { return Redirect::intended('/')-&gt;withInput()-&gt;with('message', 'You should be logged in to provide this action.'); } }); Route::filter('regular_user', function(){ if (!Auth::guest()) { if (!Auth::user()-&gt;isRegular()) { return Redirect::back()-&gt;with('message', 'You cannot do that due to your role.'); } } });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you noticed, I added an additional filter to the commenting route. </font><font style="vertical-align: inherit;">In this way, no one except regular users of the site will be able to leave comments on discounts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also here the route was used </font></font><code>Route::when()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is the so-called pattern filter ( </font></font><a href="http://laravel.com/docs/routing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pattern Filter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">It allows the first parameter to pass a pattern </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the second - the filter itself, which needs to be applied, and the third parameter it can accept an array of </font></font><code>HTTP </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, to which the filter should be applied. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the </font></font><code>login()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controller </font><font style="vertical-align: inherit;">method </font></font><code>LoginController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/LoginController.php ... public function login() { if (Auth::attempt(array('email' =&gt; Input::get('email'), 'password' =&gt; Input::get('password')), true) || Auth::attempt(array('username' =&gt; Input::get('email'), 'password' =&gt; Input::get('password')), true)) { if (!Auth::user()-&gt;isRegular()) { return Redirect::to('dashboard'); } return Redirect::intended('/'); } return Redirect::back()-&gt;withInput(Input::except('password'))-&gt;with('message', 'Wrong creadentials!'); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now at the entrance to the site ordinary users will get to the main page, and administrators, moderators and managers in the admin panel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's change a little navigation menu for the administration:</font></font><br><br><pre> <code class="html hljs xml">// app/views/layouts/scaffold.blade.php @if(!Auth::guest()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav nav-pills"</span></span></span><span class="hljs-tag">&gt;</span></span> @if(Auth::user()-&gt;isManager()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('offers.index', 'Offers') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('companies.index', 'Companies') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('tags.index', 'Tags') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('cities.index', 'Cities') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @if(Auth::user()-&gt;isModerator()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('comments.index', 'Comments') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @endif @if(Auth::user()-&gt;isAdmin()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('roles.index', 'Roles') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('users.index', 'Users') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pull-right"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('login.logout', 'Logout') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> @endif</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excellent - now each role will be visible to those resources to which they have access. </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Emails </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An important aspect for a web application is sending mail. </font></font><br><br> <code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses </font></font><code>SwiftMailer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to create letters ( </font></font><a href="http://laravel.com/docs/mail"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravel Mail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First you need to configure the settings for sending mail. </font><font style="vertical-align: inherit;">As a demonstration for sending letters, I will use my account on </font></font><code>gmail</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but you can use essentially any service that provides the ability to send mail from its servers (for example, </font></font><a href="https://postmarkapp.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postmarkapp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail Setup:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/config/mail.php ... return array( ... 'driver' =&gt; 'smtp', ... 'host' =&gt; 'smtp.gmail.com', ... 'port' =&gt; 587, ... 'from' =&gt; array('address' =&gt; 'habrahabr@habr.com', 'name' =&gt; 'Habra Offers'), ... 'encryption' =&gt; 'tls', ... 'username' =&gt; 'mygmailaccount@gmail.com', ... 'password' =&gt; 'mypassword', ... 'pretend' =&gt; false );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The parameter </font></font><code>pretend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is responsible for whether to send letters. </font><font style="vertical-align: inherit;">If it is set to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the sending of letters will not occur, but </font><font style="vertical-align: inherit;">sending </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be saved </font><font style="vertical-align: inherit;">in the site logs ( </font><i><font style="vertical-align: inherit;">app / storage / logs</font></i><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, I want the registration letter to be sent to the user with a greeting, for this we will create a template in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / emails</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="html hljs xml">// app/views/emails/welcome.blade.php <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en-US"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Welcome to Habra Offers!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> We are glad that you are interested in us, {{{ $username }}}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, change </font></font><code>store()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our </font><font style="vertical-align: inherit;">method </font></font><code>LoginController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/LoginController.php ... $user-&gt;save(); Mail::send('emails.welcome', array('username' =&gt; $user-&gt;username), function($message) use ($user) { $message-&gt;to($user-&gt;email, $user-&gt;username)-&gt;subject('Welcome to Habra Offers!'); }); Auth::loginUsingId($user-&gt;id); ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><a href="http://laravel.com/docs/mail"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">for sending mail uses a method </font></font><code>send()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that takes three arguments:</font></font><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ view</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the template to use (or an array of two templates, the first is the html template, the second is plaintext)</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an array of data, the keys of which will be variables in the template</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the function that will be run to configure the parameters of the letter</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But a welcome letter is not the only type of letters we need. </font><font style="vertical-align: inherit;">What if the user forgot his password and wants to recover it? </font><font style="vertical-align: inherit;">For this </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provides </font></font><a href="http://laravel.com/docs/security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Password Reminders &amp; Reset</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What we need to do:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /workspace/php/habr php artisan auth:reminders php artisan migrate</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To recover the password, just call </font></font><code>Password::remind(array('email' =&gt; $email))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and a letter with a link to reset the password will be sent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will need to create 2 templates:</font></font><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / auth / remind.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - to send email for password recovery</font></font><br><pre> <code class="html hljs xml">// app/views/auth/remind.blade.php @extends('layouts.scaffold') @section('main') @if (Session::has('error')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"alert alert-error"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ trans(Session::get('reason')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @elseif (Session::has('success')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"alert alert-success"</span></span></span><span class="hljs-tag">&gt;</span></span> An e-mail with the password reset has been sent. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Forgot your password?<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('login.index', 'No') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open() }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('email', 'Your email')}} {{ Form::email('email') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Send reminder', array('class' =&gt; 'btn')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::close() }} @stop</code> </pre><br></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / auth / reset.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - password recovery form</font></font><br><pre> <code class="html hljs xml">// app/views/auth/reset.blade.php @extends('layouts.scaffold') @section('main') @if (Session::has('error')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"alert alert-error"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ trans(Session::get('reason')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Reset your password<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::open() }} {{ Form::hidden('token', $token) }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::label('email', 'Email')}} {{ Form::email('email', Input::old('email')) }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{Form::label('password', 'New password')}} {{ Form::password('password')}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> {{Form::label('password', 'New password confirmation')}} {{ Form::password('password_confirmation')}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Form::submit('Reset', array('class' =&gt; 'btn'))}} {{ Form::close() }} @stop</code> </pre><br></li></ul><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function </font></font><code>trans()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an auxiliary function that displays the localized string from the configuration. </font><font style="vertical-align: inherit;">You can look in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / lang / en / reminders.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">and see what errors can be displayed. </font><font style="vertical-align: inherit;">To change the localization to, say, the Russian language, you need to change the </font><b><font style="vertical-align: inherit;">locale</font></b><font style="vertical-align: inherit;"> value </font><font style="vertical-align: inherit;">from </font><b><font style="vertical-align: inherit;">en</font></b><font style="vertical-align: inherit;"> to </font><b><font style="vertical-align: inherit;">ru</font></b><font style="vertical-align: inherit;"> in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / config / app.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">and add the </font><i><font style="vertical-align: inherit;">app / lang / ru</font></i><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">in which to recreate files as in the </font><i><font style="vertical-align: inherit;">app / lang / en</font></i><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">.</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next, add 4 routes: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php ... Route::group(array('before' =&gt; 'un_auth'), function() { ... Route::get('password/remind', array('as' =&gt; 'password.remind', 'uses' =&gt; 'LoginController@showReminderForm')); Route::post('password/remind', array('uses' =&gt; 'LoginController@sendReminder')); Route::get('password/reset/{token}', array('as' =&gt; 'password.reset', 'uses' =&gt; 'LoginController@showResetForm')); Route::post('password/reset/{token}', array('uses' =&gt; 'LoginController@resetPassword')); }); ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To proceed with the restoration, we also add a link on the login page: </font></font><br><br><pre> <code class="html hljs xml">// app/views/login/index.blade.php ... {{ Form::close() }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ link_to_route('password.remind', 'Forgot password?') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As well as missing methods in </font></font><code>LoginController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/LoginController.php ... /** * Show reminder form. * * @return Response */ public function showReminderForm() { return View::make('auth.remind'); } /** * Send reminder email. * * @return Response */ public function sendReminder() { $credentials = array('email' =&gt; Input::get('email')); return Password::remind($credentials, function($message, $user) { $message-&gt;subject('Password Reminder on Habra Offers'); }); } /** * Show reset password form. * * @return Response */ public function showResetForm($token) { return View::make('auth.reset')-&gt;with('token', $token); } /** * Reset password. * * @return Response */ public function resetPassword($token) { $credentials = array('email' =&gt; Input::get('email')); return Password::reset($credentials, function($user, $password) { $user-&gt;password = Hash::make($password); $user-&gt;save(); Auth::loginUsingId($user-&gt;id); return Redirect::home()-&gt;with('message', 'Your password has been successfully reseted.'); }); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now any user can recover their password. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add another link to enter and register on the site on the main page:</font></font><br><pre> <code class="html hljs xml">// app/views/layouts/main.blade.php ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"brand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home') }}"</span></span></span><span class="hljs-tag">&gt;</span></span>Habr Offers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home') }}"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn-group pull-right"</span></span></span><span class="hljs-tag">&gt;</span></span> @if(Auth::guest()) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('login.index') }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('login.register') }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> @else <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('login.logout') }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to limit the output on the pages of only those discounts that have not yet ended, we will need to add another method to the Model </font></font><code>Offer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/Offer.php ... public function scopeActive($query) { return $query-&gt;where('expires', '&gt;', DB::raw('NOW()')); } public function scopeSortLatest($query, $desc = true) { $order = $desc ? 'desc' : 'asc'; return $query-&gt;orderBy('created_at', $order); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, in the method we can </font></font><code>HomeController@index</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only change </font></font><code>Offer::orderBy('created_at', 'desc')-&gt;get()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>Offer::active()-&gt;sortLatest()-&gt;get()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Our newly created method will add the conditions we need to the chain of conditions. </font><font style="vertical-align: inherit;">Let's do the same for sorting methods by tags, cities and companies.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php ... public function byTag($name) { ... $offers = $tag-&gt;offers()-&gt;active()-&gt;sortLatest()-&gt;get(); ... }</span></span></code> </pre><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pagination </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An important aspect is pagination. </font><font style="vertical-align: inherit;">Yes, of course, you can send requests to the database, receive thousands of response lines, and then push them all onto the page. </font><font style="vertical-align: inherit;">But this is hardly anyone's approach. </font><font style="vertical-align: inherit;">Limiting the number of returned results from the database is quite simple - at the end of the query, you need to use the method </font></font><code>paginate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead of </font></font><code>get()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or </font></font><code>all()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A simple example:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php ... public function index() { $offers = Offer::active()-&gt;sortLatest()-&gt;paginate(); ... } ... // app/views/home/index.blade.php ... @if ($offers-&gt;count()) {{ $offers-&gt;links() }} ... {{ $offers-&gt;links() }} @else There are no offers @endif ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, only 15 results will be displayed on one page, and there will be page transitions at the bottom. </font><font style="vertical-align: inherit;">The number of results is easily changeable - just transfer the required number to the method, for example, it </font></font><code>paginate(1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will give 1 result per page.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/HomeController.php ... public function byTag($name) { $tag = Tag::whereName($name)-&gt;firstOrFail(); $offers = $tag-&gt;offers()-&gt;active()-&gt;sortLatest()-&gt;paginate(); $title = "Offers tagged as: " . $tag-&gt;name; return View::make('home.index', compact('offers', 'title')); } ... public function byCity($name) { $city = City::whereName($name)-&gt;firstOrFail(); $offers = $city-&gt;offersr()-&gt;active()-&gt;sortLatest()-&gt;paginate(); $title = "Offers in: " . $city-&gt;name; return View::make('home.index', compact('offers', 'title')); } ... public function byCompany($name) { $company = Company::whereName($name)-&gt;firstOrFail(); $offers = $company-&gt;offers()-&gt;active()-&gt;sortLatest()-&gt;paginate(); $title = "Offers by: " . $company-&gt;name; return View::make('home.index', compact('offers', 'title')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is nothing complicated about it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For convenience, we will do the same in the admin panel.</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/controllers/OffersController ... /** * Display a listing of the resource. * * @return Response */ public function index() { $offers = $this-&gt;offer-&gt;sortLatest()-&gt;paginate(); return View::make('offers.index', compact('offers')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last thing I want to add to the site is the conclusion of the last comments on the pages and the bookmarks of the discounts to which the user has posted comments. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start by adding comments to the page frame:</font></font><br><br><pre> <code class="html hljs xml">// app/views/layouts/main.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (Session::has('message')) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flash alert"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ Session::get('message') }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @endif <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row-fluid"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"span3"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Last Comments<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> @if (count($comments = Comment::take(5)-&gt;get()) &gt; 0) @foreach ($comments as $comment) @include('partials.comment', $comment) @endforeach @else There are no comments yet @endif <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"span9"</span></span></span><span class="hljs-tag">&gt;</span></span> @yield('main') <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And also create the template itself </font></font><code>comment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="html hljs xml">// app/views/partials/comment.blade.php <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"well"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ route('home.offer', $comment-&gt;offer_id) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ $comment-&gt;user-&gt;username }} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-success pull-right"</span></span></span><span class="hljs-tag">&gt;</span></span>mark: {{ $comment-&gt;mark }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $comment-&gt;webBody() }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not forget to add a link between the Model </font></font><code>Comment</code> <code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Offer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/models/Comment.php ... public function user() { return $this-&gt;belongsTo('User'); } public function offer() { return $this-&gt;belongsTo('Offer'); } public function webBody($options = array()) { $str = $this-&gt;body; if (isset($options['shorten'])) { $length = isset($options['length']) ? (int) $options['length'] : 50; $end = isset($options['end']) ? : '‚Ä¶'; if (mb_strlen($str) &gt; $length) { $str = mb_substr(trim($str), 0, $length); $str = mb_substr($str, 0, mb_strlen($str) - mb_strpos(strrev($str), ' ')); $str = trim($str.$end); } } $str = str_replace("\r\n", '&lt;br&gt;', e($str)); return $str; } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As well as an auxiliary function to reduce and get rid of the </font></font><code>html-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains to add bookmarks for the user:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/routes.php Route::get('/', array('as' =&gt; 'home', 'uses' =&gt; 'HomeController@index')); Route::get('bookmarks', array('before' =&gt; 'auth', 'as' =&gt; 'home.bookmarks', 'uses' =&gt; 'HomeController@bookmarks')); ... // app/views/layouts/main.blade.php ... @if(Auth::guest()) &lt;a href="{{ route('login.index') }}" class="btn"&gt;Login&lt;/a&gt; &lt;a href="{{ route('login.register') }}" class="btn"&gt;Register&lt;/a&gt; @else &lt;a href="{{ route('home.bookmarks') }}" class="btn"&gt;My Bookmarks&lt;/a&gt; &lt;a href="{{ route('login.logout') }}" class="btn"&gt;Logout&lt;/a&gt; @endif ... // app/models/User.php ... public function usersOffers() { return $this-&gt;belongsToMany('Offer', 'comments')-&gt;withPivot('body', 'mark')-&gt;withTimestamps(); } ... // app/controllers/HomeController.php ... /** * Display a listing of bookmarked offers. * * @return Response */ public function bookmarks() { $offers = Auth::user()-&gt;usersOffers()-&gt;paginate(); $title = "My Bookmarked Offers"; return View::make('home.index', compact('offers', 'title')); } ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To begin with, we added a route to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / route.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then added a link to it in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app / views / layouts / main.blade.php</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , set the connection between Model </font></font><code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Offer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and finally implemented the method </font></font><code>bookmarks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>HomeController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Depla </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The hour of deployment has arrived! For this, I chose </font></font><a href="http://fortrabbit.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fortrabbit.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - hosting for applications on </font></font><code>PHP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It supports </font></font><code>Git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>SSH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Memcached</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Composer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MySQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and more. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The registration process there is quite simple. </font></font><br><br><img src="http://habrastorage.org/storage3/35d/123/121/35d123121dce15cdfafcb5b74f11cc79.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, create a new application. </font></font><br><br><img src="http://habrastorage.org/storage3/9c1/611/a85/9c1611a853b3dced97f8dc911c7e3066.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's call him </font></font><code>habr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The project name will be a link to it </font></font><a href="http://habr.eu1.frbit.net/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.eu1.frbit.net/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Add a note (Habra Offers), and add a </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">key from your car. To view your </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">key enter in the terminal:</font></font><br><br><pre> <code class="bash hljs">cat ~/.ssh/id_rsa.pub</code> </pre><br><br><img src="http://habrastorage.org/storage3/05f/b93/8f0/05fb938f0b408266c4d8367ec9733e45.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final step is to wait for the environment configuration. </font><font style="vertical-align: inherit;">You will generate data for access to the repository </font></font><code>Git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>SSH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>SFTP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MySQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">settings and </font></font><code>ReSync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">access. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The environment is up and running. </font></font><br><br><img src="http://habrastorage.org/storage3/c1d/01c/d1c/c1d01cd1c29ac516bccbae7bd0965ced.png"><br><br> <code>fortrabbit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freezes non-active applications. </font><font style="vertical-align: inherit;">How to unfreeze the application can be read </font></font><a href="http://fortrabbit.com/docs/essentials/freeze"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, in order to fill our application on </font></font><code>fortrabbit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go to the terminal:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> workspace/php/ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@git1.eu1.frbit.com:habr.git fort_habr</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A clone of the empty repository will be created with </font></font><code>fortrabbit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a. </font><font style="vertical-align: inherit;">Then simply transfer the entire project from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workspace / php / habr</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workspace / php / fort_habr folder</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Go to the database configuration file and correct it with new data </font></font><code>MySQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now we are ready to upload our application:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> fort_habr git add . git commit -am <span class="hljs-string"><span class="hljs-string">"Initial Commit"</span></span> git push -u origin master</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After all, it remains to go through </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and start the migration.</font></font> So: <br><br><pre> <code class="bash hljs">ssh u-habr@ssh1.eu1.frbit.com</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then enter your password and you are on the server. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">htdocs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">and execute:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> htdocs php artisan migrate:install php artisan migrate --seed</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the database setting was correct, no problems should arise. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To work with </font></font><code>Composer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the hosting, you can not even use it </font></font><code>ssh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- just add a trigger in the commit:</font></font><br><br><pre> <code class="bash hljs">git commit --allow-empty -am <span class="hljs-string"><span class="hljs-string">"Update dependencies [trigger:composer:update]"</span></span> git push -u origin master</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The option is </font></font><code>--allow-empty</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here so that we can run to make a commit without making any changes to the files. As if an empty commit. But after seeing the comments </font></font><code>[trigger:composer:update]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the hosting will automatically launch the command </font></font><code>composer update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and all the dependencies of the project will be updated. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, in my repository on </font></font><a href="https://github.com/andrewdacenko/habrahabr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I also added </font></font><code>seeds</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pictures for discounts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the last thing: before going to your website, make sure that in </font></font><code>Domains</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the server </font></font><code>Root Path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matches the value </font></font><code>public</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. So how exactly is it arranged </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can play here: </font></font><a href="http://habr.eu1.frbit.net/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habra Offers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope you were interested in reading this, and it is useful to do it. </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- an excellent framework for developing web applications of varying complexity. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I tried to explain the main, and even more, aspects. </font><font style="vertical-align: inherit;">And for the interest of giving homework:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a link to the main menu so that you can see only those offers that expire during the week / day. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add </font><font style="vertical-align: inherit;">comments </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocking</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the admin panel </font><font style="vertical-align: inherit;">so that they are hidden in the list of comments.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a count for the discount (average rating). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add an image management package. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add the ability for the user to upload their avatar. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add </font></font><code>WYSIWYG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">editor to admin panel.</font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perhaps a good task, as you think? </font></font><br><br><h6>  about the author </h6><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I am 24 years old, married. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first higher education: UEC "KROK". </font><font style="vertical-align: inherit;">Specialty: International Economics, Master.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Currently a 3rd year student of NTUU KPI, Faculty of Applied Mathematics. </font><font style="vertical-align: inherit;">Specialty: Software Engineering.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I work as a web developer 15 months on the floor rate. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I study </font></font><code>Laravel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from version 3.</font></font></li></ul><br><br><h6>  Statistics collection </h6><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It took a little more than a week to write an article with the development. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The article contains </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3040</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lines (in a text editor).</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The article contains </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,500</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> characters (in a text editor).</font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All grammatical errors please write in lichku. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haters gonna die (I bet that I'll write it). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Useful links</font></font><br><ul><li> <a href="http://laravel.com/docs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravel Documentation</font></font></a> </li><li> <a href="http://cheats.jesse-obrien.ca/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravel Cheat Sheet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - thanks </font></font><a href="https://habrahabr.ru/users/ytko/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yTko</font></font></a> </li><li> <a href="https://github.com/JeffreyWay/Laravel-4-Generators"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravel 4 Generators</font></font></a> </li><li> <a href="http://vk.com/laravel_rus"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VC community where there are also many resources for learning</font></font></a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/197454/">https://habr.com/ru/post/197454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197442/index.html">Replenishment of Yandex.Money: any account from any (almost) card</a></li>
<li><a href="../197444/index.html">How to discern a forest behind trees: creating a three-dimensional image of the world's forests</a></li>
<li><a href="../197448/index.html">Google Maps API: location map, animation and styling</a></li>
<li><a href="../197450/index.html">As I did W-Mouse - a gaming mouse with unique abilities.</a></li>
<li><a href="../197452/index.html">Who needs interns?</a></li>
<li><a href="../197456/index.html">How we migrated millions of countries in a working day</a></li>
<li><a href="../197460/index.html">LG TVs: 2013 model range</a></li>
<li><a href="../197462/index.html">Big data is an integral part of our lives.</a></li>
<li><a href="../197464/index.html">The ninth Forum for IT directors "Efficiency in our genes!"</a></li>
<li><a href="../197466/index.html">How I hacked Habrahabr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>