<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a bot for MMORPG with assembler and draenei. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! So, let's continue writing our bot. Today we will inject our code into the gameplay (not without the help of assembler), and later we w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a bot for MMORPG with assembler and draenei. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/708/53f/a39/70853fa39f3f4d4f82bc6525a2ebc41f.png" align="left">  Hi% username%!  So, let's continue writing our bot.  Today we will inject our code into the gameplay (not without the help of assembler), and later we will take care that it would not be so easy to find it, because it‚Äôs punished not for cheating, but for getting caught.  And to be honest to the end, even if we don‚Äôt completely embrace the process of the game, we will implement it, and only once during the entire life cycle. <br><br><h6>  But about everything in order, so I am waiting for you under the cut! </h6><br><a name="habracut"></a><br>  <b>Disclaimer: The author is not responsible for your use of the knowledge gained in this article or damage as a result of their use.</b>  <b>All information here is for educational purposes only.</b>  <b>Especially for companies developing MMORPG, that would help them to fight with the bot.</b>  <b>And, of course, the author of the article is not a botmaster, not a cheater, and never was.</b> <br><hr><br>  As you remember from the last article, we found the address of our DirectX function EndScene and counted its first 5 bytes.  If you forgot, then here's the content, if not, then read what we will do with them: <br><br><h6>  <b>Content</b> </h6><br><ol><li>  <a href="http://habrahabr.ru/post/251137/">Part 0 - Search for a code injection point</a> </li><li>  <a href="http://habrahabr.ru/post/251149/">Part 1 - Implementing and executing third-party code</a> </li><li>  <a href="http://habrahabr.ru/post/251199/">Part 2 - Hide the code from prying eyes</a> </li><li>  <a href="http://habrahabr.ru/post/251353/">Part 3 - Under the gun World of Warcraft 5.4.x (Structures)</a> </li><li>  <a href="http://habrahabr.ru/post/251479/">Part 4 - Under the gun World of Warcraft 5.4.x (Moving)</a> </li><li>  Part 5 - Under the gun World of Warcraft 5.4.x (Casting Fireball) </li></ol><br><h5>  <b>1. We plan implementation plan</b> </h5><br>  Today we will inject our code into this function without harming itself.  Below I will show how this will happen: <br><img src="https://habrastorage.org/files/64c/7c1/48b/64c7c148bfdf40b4a06925bd8171e032.png"><br><ul><li>  HookAddress is an address for allocated memory in the game using the VirtualAllocEx function from kernel32.dll using WinApi </li><li>  Address is the address in memory of the DirectX function EndScene or ChainSwap </li><li>  OpCodes are original function opcodes and we need to keep them, since  in the original they will be changed. </li></ul><br><h5>  <b>2. Implementation operation</b> </h5><br>  To open a process, we call WinApi OpenProcess and enable debugging, and then we need to open the main thread of our process 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ProcessHandle = OpenProcess(processId); Process.EnterDebugMode(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dwThreadId = Process.GetProcessById(dwProcessId).Threads[<span class="hljs-number"><span class="hljs-number">0</span></span>].Id; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ThreadHandle = OpenThread(<span class="hljs-number"><span class="hljs-number">0x1F03FF</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)dwThreadId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HookAddress = Memory.AllocateMemory(<span class="hljs-number"><span class="hljs-number">6000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argumentAddress1 = Memory.AllocateMemory(<span class="hljs-number"><span class="hljs-number">80</span></span>); Memory.WriteBytes(argumentAddress1, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">80</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argumentAddress2 = Memory.AllocateMemory(BufferSize); Memory.WriteBytes(argumentAddress2, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">80</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultAddress = Memory.AllocateMemory(<span class="hljs-number"><span class="hljs-number">4</span></span>); Memory.Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(_resultAddress, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  where 0x1F03FF is the access rights to the stream.  Next, we allocate memory for our code and get a <b>HookAddress</b> pointer to it, also reserve memory for the two arguments, argumentAddress1 and argumentAddress2, for the result resultAddress and fill all with zeros.  Now, as promised a little hardcore: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asmLine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">"pushfd"</span></span>, <span class="hljs-string"><span class="hljs-string">"pushad"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov edx, 0"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov ecx, "</span></span> + resultAddress, <span class="hljs-string"><span class="hljs-string">"mov [ecx], edx"</span></span>, <span class="hljs-string"><span class="hljs-string">"@loop:"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov eax, [ecx]"</span></span>, <span class="hljs-string"><span class="hljs-string">"cmp eax, "</span></span> + <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-string"><span class="hljs-string">"jae @end"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov eax, "</span></span> + argumentAddress1, <span class="hljs-string"><span class="hljs-string">"add eax, [ecx]"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov eax, [eax]"</span></span>, <span class="hljs-string"><span class="hljs-string">"test eax, eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"je @out"</span></span>, <span class="hljs-string"><span class="hljs-string">"call eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov ecx, "</span></span> + resultAddress, <span class="hljs-string"><span class="hljs-string">"mov edx, "</span></span> + argumentAddress2, <span class="hljs-string"><span class="hljs-string">"add edx, [ecx]"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov [edx], eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov edx, "</span></span> + argumentAddress1, <span class="hljs-string"><span class="hljs-string">"add edx, [ecx]"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov eax, 0"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov [edx], eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"@out:"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov eax, [ecx]"</span></span>, <span class="hljs-string"><span class="hljs-string">"add eax, 4"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov [ecx], eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"jmp @loop"</span></span>, <span class="hljs-string"><span class="hljs-string">"@end:"</span></span>, <span class="hljs-string"><span class="hljs-string">"popad"</span></span>, <span class="hljs-string"><span class="hljs-string">"popfd"</span></span> }; Memory.Asm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagedFasm(ProcessHandle); Memory.Asm.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> asmLine) { Memory.Asm.AddLine(str); } Memory.Asm.Inject(HookAddress); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) Memory.Asm.Assemble().Length; Memory.WriteBytes(HookAddress + length, OpCodes); Memory.Asm.Clear(); Memory.Asm.AddLine(<span class="hljs-string"><span class="hljs-string">"jmp "</span></span> + (Address + OpCodes.Length)); Memory.Asm.Inject((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)((HookAddress + length) + OpCodes.Length)); Memory.Asm.Clear(); Memory.Asm.AddLine(<span class="hljs-string"><span class="hljs-string">"jmp "</span></span> + HookAddress); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt;= ((OpCodes.Length - <span class="hljs-number"><span class="hljs-number">5</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>); k++) { Memory.Asm.AddLine(<span class="hljs-string"><span class="hljs-string">"nop"</span></span>); } Memory.Asm.Inject(Address);</code> </pre><br>  The assembler code above is written to <b>HookAddress</b> and will transfer control to our code and according to the table, after working it out we return control to the main thread.  Now I will show how to take advantage of this, let‚Äôs have: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectAndExecute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; asm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnValue = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnLength = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { Memory.Asm.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> asm) { Memory.Asm.AddLine(str); } dwAddress = Memory.AllocateMemory(Memory.Asm.Assemble().Length + <span class="hljs-number"><span class="hljs-number">60</span></span>); Memory.Asm.Inject(dwAddress); Memory.Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt;(argumentAddress1, dwAddress); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Memory.Read&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(argumentAddress1) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnValue) { result = Memory.ReadBytes(Memory.Read&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt;(argumentAddress2), returnLength); } Memory.Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(argumentAddress2, <span class="hljs-number"><span class="hljs-number">0</span></span>); Memory.FreeMemory(dwAddress); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  As a result, we have the values ‚Äã‚Äãat the addresses argumentAddress1 and argumentAddress2 should become zeros when our injection works.  If you have many threads that call InjectAndExecute, then you need to provide a queue, for this I used 80 byte size, how to implement it, think for yourself.  And in the next article, I will show my implementation and how to hide our code. </div><p>Source: <a href="https://habr.com/ru/post/251149/">https://habr.com/ru/post/251149/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251131/index.html">Java EE, JCA and jNode 2.X announce</a></li>
<li><a href="../251133/index.html">CxxMock - principle of operation</a></li>
<li><a href="../251137/index.html">We write a bot for MMORPG with assembler and draenei. Part 0</a></li>
<li><a href="../251141/index.html">Another software UART on ATtiny13</a></li>
<li><a href="../251143/index.html">Own implementation of https using crypto ++ for I2P bootstrapping</a></li>
<li><a href="../251155/index.html">Creating MMC Management Console</a></li>
<li><a href="../251157/index.html">The most needed plugins for Grunt</a></li>
<li><a href="../251161/index.html">Introduction to the course "Image and video analysis". Lectures from Yandex</a></li>
<li><a href="../251163/index.html">About Intel Hyper-Threading and Virtual Machine Performance</a></li>
<li><a href="../251165/index.html">22 tips, tricks and shokkat for Android Lollipop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>