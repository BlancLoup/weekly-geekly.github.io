<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java: Socks 4 Proxy work with non-blocking sockets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with version 1.4, j2se introduced package java.nio, which allows you to work with sockets in non-blocking mode, which often improves performa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java: Socks 4 Proxy work with non-blocking sockets</h1><div class="post__text post__text-html js-mediator-article">  Starting with version 1.4, j2se introduced package java.nio, which allows you to work with sockets in non-blocking mode, which often improves performance, simplifies the code and provides additional features and functionality.  And starting with j2se 1.6 on servers under OS Linux management (kernel 2.6), the implementation of the <a title="Javadoc for class selector" href="http://java.sun.com/javase/6/docs/api/java/nio/channels/Selector.html">Selector</a> class is performed using epoll, which ensures the highest possible performance. <br><br>  In the example described below, I will try to demonstrate the basic principle of working with non-blocking sockets, using the example of a very real problem - the implementation of <a href="http://ru.wikipedia.org/wiki/SOCKS">Socks</a> 4 proxy server. <br><a name="habracut"></a><br>  During life, anything can happen to a non-blocking socket, namely <br><br>  <b>ServerSocketChannel</b> <br><ul><li>  OP_ACCEPT - incoming connection </li></ul><br>  <b>SocketChannel</b> <br><ul><li>  OP_READ - on the nipple data or disconnect </li><li>  OP_WRITE - the nipple is ready for recording or disconnected </li><li>  OP_CONNECT - connected or established or not </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br>  Sockets are selected on which something happened using one of the methods <br><ul><li>  <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/Selector.html">select ()</a> - blocking method, wakes up on an event or on <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/Selector.html">wakeUp ()</a> </li><li>  <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/Selector.html">select (long)</a> - same theme only with timeout </li><li>  <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/Selector.html">selectNow ()</a> - well, non-blocking option </li></ul><br><br>  In our case, the proxy is passive, so the basic block select () is more suitable for us. <br>  After that, you need to ask the selector for the keys that were active in the last sample and using the methods <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/SelectionKey.html">isAcceptable ()</a> , <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/SelectionKey.html">isReadable ()</a> , <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/SelectionKey.html">isWriteable ()</a> , <a href="http://java.sun.com/javase/6/docs/api/java/nio/channels/SelectionKey.html">isConnectable () to</a> find out what happened to them. <br><br>  <b>The basic algorithm of our proxy server is:</b> <br><ol><li>  Accept connection </li><li>  Parsim header (to simplify this step, we assume that the header size is always smaller than the buffer size) </li><li>  We establish connection with the purpose </li><li>  We respond to the client that everything is OK </li><li>  Proxy </li><li>  Close connections </li></ol><br><br>  To avoid <b>problems with full socket buffers,</b> we will proxy as follows: <br>  Let us have two ends A and B while A.in = B.out and vice versa, therefore A.interestOps () | OP_READ! = B.interestOps () | OP_WRITE (so that one buffer is not simultaneously used by two channels). <br>  After one of the parties closes the connection, it is necessary to add data from the buffer to the second side and close the connection. <br><br>  <b>Well, actually the code itself, the functions tried to arrange in the order of actions to simplify the understanding of the algorithm, the comments are attached.</b> <br><blockquote>  <font color="#000000">package</font> <font color="#006699">ru.habrahabr</font> <font color="#339933">;</font> <br><br>  <font color="#000000">import</font> <font color="#006699">java.io.IOException</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.net.InetAddress</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.net.InetSocketAddress</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.net.UnknownHostException</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.ByteBuffer</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.ClosedChannelException</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.SelectionKey</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.Selector</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.ServerSocketChannel</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.SocketChannel</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.nio.channels.spi.SelectorProvider</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">java.util.Iterator</font> <font color="#339933">;</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* A class that implements a simple non-blocking Socks 4 Proxy Server Implementing</font> <font color="#008000"><br></font>  <font color="#008000">* connect command only</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @author dgreen</font> <font color="#008000"><br></font>  <font color="#008000">* @date 09/19/2009</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">public</font> <font color="#000000">class</font> Socks4Proxy <font color="#000000">implements</font> <font color="#003399">Runnable</font> <font color="#009900">{</font> <br>  <font color="#006600">int</font> bufferSize = <font color="#cc66cc">8192</font> <font color="#339933">;</font> <br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Port</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#006600">int</font> port <font color="#339933">;</font> <br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Host</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#003399">String</font> host <font color="#339933">;</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Additional information clinging to each key {@link SelectionKey}</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @author dgreen</font> <font color="#008000"><br></font>  <font color="#008000">* @date 09/19/2009</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">static</font> <font color="#000000">class</font> Attachment <font color="#009900">{</font> <br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Buffer for reading, at the time of proxying becomes a buffer for</font> <font color="#008000"><br></font>  <font color="#008000">* entries for key stored in peer</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* IMPORTANT: When parsing Socks4 header, we assume that the size</font> <font color="#008000"><br></font>  <font color="#008000">* Buffer, larger than normal header size, Mozilla browser</font> <font color="#008000"><br></font>  <font color="#008000">* Firefox, header size is 12 bytes 1 version + 1 command + 2 port +</font> <font color="#008000"><br></font>  <font color="#008000">* 4 ip + 3 id (MOZ) + 1 \ 0</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br><br>  <font color="#003399">ByteBuffer</font> in <font color="#339933">;</font> <br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Buffer for writing, at the time of proxying, is equal to read buffer for</font> <font color="#008000"><br></font>  <font color="#008000">* key stored in peer</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#003399">ByteBuffer</font> out <font color="#339933">;</font> <br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Where are we proxying</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#003399">SelectionKey</font> peer <font color="#339933">;</font> <br><br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* the answer is OK or Service is provided</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">static</font> <font color="#000000">final</font> <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> OK = <font color="#000000">new</font> <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#009900">{</font> 0x00, 0x5a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 <font color="#009900">}</font> <font color="#339933">;</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* The heart of a non-blocking server, practically does not change from application to</font> <font color="#008000"><br></font>  <font color="#008000">* application, except when using a non-blocking server in</font> <font color="#008000"><br></font>  <font color="#008000">* multithreaded application, and working with keys from other threads, it is necessary</font> <font color="#008000"><br></font>  <font color="#008000">* will add some KeyChangeRequest, but we are in this application without</font> <font color="#008000"><br></font>  <font color="#008000">* needs</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  @ <font color="#003399">Override</font> <br>  <font color="#000000">public</font> <font color="#006600">void</font> run <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">try</font> <font color="#009900">{</font> <br>  <font color="#666666">// Create Selector</font> <br>  <font color="#003399">Selector</font> selector = <font color="#003399">SelectorProvider</font> .  <font color="#006633">provider</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">openSelector</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Open the server channel</font> <br>  <font color="#003399">ServerSocketChannel</font> serverChannel = <font color="#003399">ServerSocketChannel</font> .  <font color="#006633">open</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Remove the lock</font> <br>  serverChannel.  <font color="#006633">configureBlocking</font> <font color="#009900">(</font> <font color="#006600">false</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Hang on the port</font> <br>  serverChannel.  <font color="#006633">socket</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">bind</font> <font color="#009900">(</font> <font color="#000000">new</font> <font color="#003399">InetSocketAddress</font> <font color="#009900">(</font> host, port <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Register in the selector</font> <br>  serverChannel.  <font color="#006633">register</font> <font color="#009900">(</font> selector, serverChannel. <font color="#006633">validOps</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// The main cycle of the non-blocking server</font> <br>  <font color="#666666">// This cycle will be the same for almost any non-blocking</font> <br>  <font color="#666666">// server</font> <br>  <font color="#000000">while</font> <font color="#009900">(</font> selector. <font color="#006633">select</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">&gt;</font> - <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Get the keys on which the events occurred at the moment</font> <br>  <font color="#666666">// last sample</font> <br>  Iterator <font color="#339933">&lt;</font> SelectionKey <font color="#339933">&gt;</font> iterator = selector.  <font color="#006633">selectedKeys</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">iterator</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">while</font> <font color="#009900">(</font> iterator. <font color="#006633">hasNext</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#003399">SelectionKey</font> key = iterator.  <font color="#006633">next</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  iterator.  <font color="#006633">remove</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> key. <font color="#006633">isValid</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Handle all possible key events</font> <br>  <font color="#000000">try</font> <font color="#009900">{</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> key. <font color="#006633">isAcceptable</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// accept connection</font> <br>  accept <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#000000">if</font> <font color="#009900">(</font> key. <font color="#006633">isConnectable</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Establish connection</font> <br>  connect <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#000000">if</font> <font color="#009900">(</font> key. <font color="#006633">isReadable</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Read the data</font> <br>  read <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#000000">if</font> <font color="#009900">(</font> key. <font color="#006633">isWritable</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Write data</font> <br>  write <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <font color="#000000">catch</font> <font color="#009900">(</font> <font color="#003399">Exception</font> e <font color="#009900">)</font> <font color="#009900">{</font> <br>  e.  <font color="#006633">printStackTrace</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  close <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#009900">}</font> <font color="#000000">catch</font> <font color="#009900">(</font> <font color="#003399">Exception</font> e <font color="#009900">)</font> <font color="#009900">{</font> <br>  e.  <font color="#006633">printStackTrace</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">throw</font> <font color="#000000">new</font> <font color="#003399">IllegalStateException</font> <font color="#009900">(</font> e <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* The function accepts the connection, registers the key with the action of interest.</font> <font color="#008000"><br></font>  <font color="#008000">* read data (OP_READ)</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @param key</font> <font color="#008000"><br></font>  <font color="#008000">* key on which the event occurred</font> <font color="#008000"><br></font>  <font color="#008000">* @throws IOException</font> <font color="#008000"><br></font>  <font color="#008000">* @throws ClosedChannelException</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">private</font> <font color="#006600">void</font> accept <font color="#009900">(</font> <font color="#003399">Selection</font> key Key <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IOException</font> , <font color="#003399">ClosedChannelException</font> <font color="#009900">{</font> <br>  <font color="#666666">// Accepted</font> <br>  <font color="#003399">SocketChannel</font> newChannel = <font color="#009900">(</font> <font color="#009900">(</font> <font color="#003399">ServerSocketChannel</font> <font color="#009900">)</font> key. <font color="#003399">Channel</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">accept</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Non-blocking</font> <br>  newChannel.  <font color="#006633">configureBlocking</font> <font color="#009900">(</font> <font color="#006600">false</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Register in the selector</font> <br>  newChannel.  <font color="#006633">register</font> <font color="#009900">(</font> key. <font color="#006633">selector</font> <font color="#009900">(</font> <font color="#009900">)</font> , <font color="#003399">SelectionKey</font> . <font color="#006633">OP_READ</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* We read data available at the moment.</font>  <font color="#008000">The function is in two states -</font> <font color="#008000"><br></font>  <font color="#008000">* read request header and direct proxying</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @param key</font> <font color="#008000"><br></font>  <font color="#008000">* key on which the event occurred</font> <font color="#008000"><br></font>  <font color="#008000">* @throws IOException</font> <font color="#008000"><br></font>  <font color="#008000">* @throws UnknownHostException</font> <font color="#008000"><br></font>  <font color="#008000">* @throws ClosedChannelException</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">private</font> <font color="#006600">void</font> read <font color="#009900">(</font> <font color="#003399">SelectionKey</font> key <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IOException</font> , <font color="#003399">UnknownHostException</font> , <font color="#003399">ClosedChannelException</font> <font color="#009900">{</font> <br>  <font color="#003399">SocketChannel</font> channel = <font color="#009900">(</font> <font color="#009900">(</font> <font color="#003399">SocketChannel</font> <font color="#009900">)</font> key. <font color="#003399">Channel</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  Attachment attachment = <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> key. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> attachment == <font color="#006600">null</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Lazily initialize the buffers</font> <br>  key.  <font color="#006633">attach</font> <font color="#009900">(</font> attachment = <font color="#000000">new</font> Attachment <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  attachment.  <font color="#006633">in</font> = <font color="#003399">ByteBuffer</font> .  <font color="#006633">allocate</font> <font color="#009900">(</font> bufferSize <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> channel. <font color="#006633">read</font> <font color="#009900">(</font> attachment. <font color="#006633">in</font> <font color="#009900">)</font> <font color="#339933">&lt;</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// -1 - break 0 - there is no space in the buffer, this can only be if</font> <br>  <font color="#666666">// header exceeded buffer size</font> <br>  close <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#000000">if</font> <font color="#009900">(</font> attachment. <font color="#006633">peer</font> == <font color="#006600">null</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// if there is no second end :) therefore we read the title</font> <br>  readHeader <font color="#009900">(</font> key, attachment <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#009900">{</font> <br>  <font color="#666666">// well, if we proxify, then we add interest to the second end</font> <br>  <font color="#666666">// write</font> <br>  attachment.  <font color="#006633">peer</font> .  <font color="#006633">interestOps</font> <font color="#009900">(</font> attachment. <font color="#006633">peer</font> . <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#009900">)</font> | <font color="#003399">SelectionKey</font> . <font color="#006633">OP_WRITE</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// and remove the interest of the first to read, because it has not yet been recorded</font> <br>  <font color="#666666">// current data, we will not read anything</font> <br>  key.  <font color="#006633">interestOps</font> <font color="#009900">(</font> key. <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#009900">)</font> ^ <font color="#003399">SelectionKey</font> . <font color="#006633">OP_READ</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// prepare buffer for writing</font> <br>  attachment.  <font color="#006633">in</font> .  <font color="#006633">flip</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">private</font> <font color="#006600">void</font> readHeader <font color="#009900">(</font> <font color="#003399">SelectionKey</font> key, Attachment attachment <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IllegalStateException</font> , <font color="#003399">IOException</font> , <br>  <font color="#003399">UnknownHostException</font> , <font color="#003399">ClosedChannelException</font> <font color="#009900">{</font> <br>  <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> ar = attachment.  <font color="#006633">in</font> .  <font color="#006633">array</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> ar <font color="#009900">[</font> attachment. <font color="#006633">in</font> . <font color="#006633">position</font> <font color="#009900">(</font> <font color="#009900">)</font> - <font color="#cc66cc">1</font> <font color="#009900">]</font> == <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// If the last byte \ 0 is the end of the user ID.</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> ar <font color="#009900">[</font> <font color="#cc66cc">0</font> <font color="#009900">]</font> <font color="#339933">!</font> = <font color="#cc66cc">4</font> <font color="#339933">&amp;&amp;</font> ar <font color="#009900">[</font> <font color="#cc66cc">1</font> <font color="#009900">]</font> <font color="#339933">!</font> = <font color="#cc66cc">1</font> || attachment. <font color="#006633">in</font> . <font color="#006633">position</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">&lt;</font> <font color="#cc66cc">8</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// A simple check on the protocol version and on the validity</font> <br>  <font color="#666666">// commands</font> <br>  <font color="#666666">// We support only conect</font> <br>  <font color="#000000">throw</font> <font color="#000000">new</font> <font color="#003399">IllegalStateException</font> <font color="#009900">(</font> <font color="#0000ff">"Bad Request"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#009900">{</font> <br>  <font color="#666666">// Create a connection</font> <br>  <font color="#003399">SocketChannel</font> peer = <font color="#003399">SocketChannel</font> .  <font color="#006633">open</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  peer.  <font color="#006633">configureBlocking</font> <font color="#009900">(</font> <font color="#006600">false</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Get the address and port from the packet</font> <br>  <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> addr = <font color="#000000">new</font> <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#009900">{</font> ar <font color="#009900">[</font> <font color="#cc66cc">4</font> <font color="#009900">]</font> , ar <font color="#009900">[</font> <font color="#cc66cc">5</font> <font color="#009900">]</font> , ar <font color="#009900">[</font> <font color="#cc66cc">6</font> <font color="#009900">]</font> , ar <font color="#009900">[</font> <font color="#cc66cc">7</font> <font color="#009900">]</font> <font color="#009900">}</font> <font color="#339933">;</font> <br>  <font color="#006600">int</font> p = <font color="#009900">(</font> <font color="#009900">(</font> <font color="#009900">(</font> 0xFF <font color="#339933">&amp;</font> ar <font color="#009900">[</font> <font color="#cc66cc">2</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">8</font> <font color="#009900">)</font> + <font color="#009900">(</font> 0xFF <font color="#339933">&amp;</font> ar <font color="#009900">[</font> <font color="#cc66cc">3</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Start to connect</font> <br>  peer.  <font color="#006633">connect</font> <font color="#009900">(</font> <font color="#000000">new</font> <font color="#003399">InetSocketAddress</font> <font color="#009900">(</font> <font color="#003399">InetAddress</font> . <font color="#006633">getByAddress</font> <font color="#009900">(</font> addr <font color="#009900">)</font> , p <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Register in the selector</font> <br>  <font color="#003399">SelectionKey</font> peerKey = peer.  <font color="#006633">register</font> <font color="#009900">(</font> key. <font color="#006633">selector</font> <font color="#009900">(</font> <font color="#009900">)</font> , <font color="#003399">SelectionKey</font> . <font color="#006633">OP_CONNECT</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Hear the requesting connection</font> <br>  key.  <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Key exchange :)</font> <br>  attachment.  <font color="#006633">peer</font> = peerKey <font color="#339933">;</font> <br>  Attachment peerAttachemtn = <font color="#000000">new</font> Attachment <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  peerAttachemtn.  <font color="#006633">peer</font> = key <font color="#339933">;</font> <br>  peerKey  <font color="#006633">attach</font> <font color="#009900">(</font> peerAttachemtn <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Clear the buffer with headers</font> <br>  attachment.  <font color="#006633">in</font> .  <font color="#006633">clear</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Write data from the buffer</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @param key</font> <font color="#008000"><br></font>  <font color="#008000">* @throws IOException</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">private</font> <font color="#006600">void</font> write <font color="#009900">(</font> <font color="#003399">Selection</font> key key <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IOException</font> <font color="#009900">{</font> <br>  <font color="#666666">// Close the socket only by writing all the data</font> <br>  <font color="#003399">SocketChannel</font> channel = <font color="#009900">(</font> <font color="#009900">(</font> <font color="#003399">SocketChannel</font> <font color="#009900">)</font> key. <font color="#003399">Channel</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  Attachment attachment = <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> key. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> channel. <font color="#006633">write</font> <font color="#009900">(</font> attachment. <font color="#006633">out</font> <font color="#009900">)</font> == - <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  close <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#000000">if</font> <font color="#009900">(</font> attachment. <font color="#006633">out</font> . <font color="#006633">remaining</font> <font color="#009900">(</font> <font color="#009900">)</font> == <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> attachment. <font color="#006633">peer</font> == <font color="#006600">null</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// Write what was in the buffer and close</font> <br>  close <font color="#009900">(</font> key <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#009900">{</font> <br>  <font color="#666666">// if everything is written, clear the buffer</font> <br>  attachment.  <font color="#006633">out</font> .  <font color="#006633">clear</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Add a read interest to the second end</font> <br>  attachment.  <font color="#006633">peer</font> .  <font color="#006633">interestOps</font> <font color="#009900">(</font> attachment. <font color="#006633">peer</font> . <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#009900">)</font> | <font color="#003399">SelectionKey</font> . <font color="#006633">OP_READ</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// And we remove the interest on the record</font> <br>  key.  <font color="#006633">interestOps</font> <font color="#009900">(</font> key. <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#009900">)</font> ^ <font color="#003399">SelectionKey</font> . <font color="#006633">OP_WRITE</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* Complete the connection</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @param key</font> <font color="#008000"><br></font>  <font color="#008000">* key on which the event occurred</font> <font color="#008000"><br></font>  <font color="#008000">* @throws IOException</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">private</font> <font color="#006600">void</font> connect <font color="#009900">(</font> <font color="#003399">SelectionKey</font> key <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IOException</font> <font color="#009900">{</font> <br>  <font color="#003399">SocketChannel</font> channel = <font color="#009900">(</font> <font color="#009900">(</font> <font color="#003399">SocketChannel</font> <font color="#009900">)</font> key. <font color="#003399">Channel</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  Attachment attachment = <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> key. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Finish the connection</font> <br>  channel.  <font color="#006633">finishConnect</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// Create a buffer and respond OK</font> <br>  attachment.  <font color="#006633">in</font> = <font color="#003399">ByteBuffer</font> .  <font color="#006633">allocate</font> <font color="#009900">(</font> bufferSize <font color="#009900">)</font> <font color="#339933">;</font> <br>  attachment.  <font color="#006633">in</font> .  <font color="#006633">put</font> <font color="#009900">(</font> ok <font color="#009900">)</font> .  <font color="#006633">flip</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  attachment.  <font color="#006633">out</font> = <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> attachment. <font color="#006633">peer</font> . <font color="#006633">attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">in</font> <font color="#339933">;</font> <br>  <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> attachment. <font color="#006633">Peer</font> . <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">out</font> = attachment.  <font color="#006633">in</font> <font color="#339933">;</font> <br>  <font color="#666666">// Put the second end of the flags on the write and read</font> <br>  <font color="#666666">// as soon as it writes OK, it will switch the second end to read and everything</font> <br>  <font color="#666666">// will be happy</font> <br>  attachment.  <font color="#006633">peer</font> .  <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#003399">SelectionKey</font> . <font color="#006633">OP_WRITE</font> | <font color="#003399">SelectionKey</font> . <font color="#006633">OP_READ</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  key.  <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">* No Comments</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @param key</font> <font color="#008000"><br></font>  <font color="#008000">* @throws IOException</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">private</font> <font color="#006600">void</font> close <font color="#009900">(</font> <font color="#003399">SelectionKey</font> key <font color="#009900">)</font> <font color="#000000">throws</font> <font color="#003399">IOException</font> <font color="#009900">{</font> <br>  key.  <font color="#006633">cancel</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  key.  <font color="#006633">channel</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">close</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#003399">SelectionKey</font> peerKey = <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> key. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">peer</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> peerKey <font color="#339933">!</font> = <font color="#006600">null</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> peerKey. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">peer</font> = <font color="#006600">null</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> <font color="#009900">(</font> peerKey. <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">&amp;</font> SelectionKey. <font color="#006633">OP_WRITE</font> <font color="#009900">)</font> == <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#009900">(</font> <font color="#009900">(</font> Attachment <font color="#009900">)</font> peerKey. <font color="#006633">Attachment</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> .  <font color="#006633">out</font> .  <font color="#006633">flip</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  peerKey  <font color="#006633">interestOps</font> <font color="#009900">(</font> <font color="#003399">SelectionKey</font> . <font color="#006633">OP_WRITE</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#006600">void</font> main <font color="#009900">(</font> <font color="#003399">String</font> <font color="#009900">[</font> <font color="#009900">]</font> args <font color="#009900">)</font> <font color="#009900">{</font> <br>  Socks4Proxy server = <font color="#000000">new</font> Socks4Proxy <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  server.  <font color="#006633">host</font> = <font color="#0000ff">"127.0.0.1"</font> <font color="#339933">;</font> <br>  server.  <font color="#006633">port</font> = <font color="#cc66cc">1080</font> <font color="#339933">;</font> <br>  server.  <font color="#006633">run</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Next, open your favorite browser, select socks 4 proxy, enter 127.0.0.1:1080 and check the performance. </div><p>Source: <a href="https://habr.com/ru/post/70690/">https://habr.com/ru/post/70690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70679/index.html">We will live in a new way now</a></li>
<li><a href="../70680/index.html">To attention of Moscow subscribers Yota!</a></li>
<li><a href="../70681/index.html">The first USB 3.0 hard drive</a></li>
<li><a href="../70684/index.html">Diary of MSI. Part 1 - Start</a></li>
<li><a href="../70688/index.html">Windows 7 startup video in 10 seconds</a></li>
<li><a href="../70691/index.html">Windows 7 and Sensor API</a></li>
<li><a href="../70693/index.html">30 years of CompuServe dialup</a></li>
<li><a href="../70694/index.html">Sociological meat</a></li>
<li><a href="../70695/index.html">Audion: the life story of a single program for Mac</a></li>
<li><a href="../70698/index.html">Glory, great glory, honor and praise to the Federal Antimonopoly Service!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>