<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating a domain controller from SAMBA to ActiveDirectory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So it's time to talk about the method, which is a method of scientific tyke, a few smart people and a few hours of free time helped me migrate the dom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating a domain controller from SAMBA to ActiveDirectory</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/120/628/711/120628711fe5e6bdb97c6a6d046df408.png" alt="image"><br>  So it's time to talk about the method, which is a method of scientific tyke, a few smart people and a few hours of free time helped me migrate the domain, built by the previous admin with SAMBA on ActiveDirectory. <br><a name="habracut"></a><br><br>  Many people know and use the opportunity to use SAMBA as a domain, but, in my opinion, this can only be used as a laboratory stand, and in real life it is better not to use it.  Everyone decides for himself, I was not satisfied with the absence of group policies, the constant impossibility of authorization, frequent freezes and incredible memory leaks (after 30 days of continuous work, sometimes all 16 GiB of RAM is devoured and the entire swap partition is consumed).  Therefore, my patience came to an end, I tried to collect my thoughts and tried several times to emulate the transition in a virtual environment, but there was still no time until the Siberian fluffy animal arrived and did not put the whole structure and bind9 depending on it, which completely paralyzed office work in 70 people.  It was then that the time came for an urgent transition, 2 days of reading different manuals, 2 days of attempts to take off from ActiveDirectory did not lead to anything, until I came across <a href="http://sysadmins.ru/post7750072.html">this article</a> and it is on <a href="http://social.technet.microsoft.com/Forums/de-DE/windowsserverru/thread/c75c66cb-5621-4ad7-923d-ec22d81cb2b2">TechNet</a> . <br>  They also tried to change domain roles, i.e.  introduce Windows Server into the Linux domain and make it a backup controller, and then increase its role to pdc, but, as shown by 1 test in a virtual environment, this was a bad idea, because  all the glitches of the GPO were transferred (they simply did not exist), and perhaps some more misunderstandings. <br><br>  I still didn‚Äôt manage to reduce everything to a single button click, so <a href="http://www.activestate.com/activeperl/downloads">Active Perl (x86)</a> , Microsoft Office Excel (did for 2003 and 2007), Batch, VBS, as well as the <a href="http://download.chip.eu/ru/NewSID_163121.html">newsid</a> utility ( <a href="http://technet.microsoft.com/en-us/sysinternals/bb897418.aspx">which was</a> successfully removed <a href="http://technet.microsoft.com/en-us/sysinternals/bb897418.aspx">on the site</a> ) and optional module <a href="http://www.computerperformance.co.uk/w2k3/utilities/acctinfo.htm">acctinfo</a> . <br>  All actions will take place in the Windows environment at the workstation, and then Windows Server (here I would like to clarify that Windows Server was 2003 R2 SP2 for some reasons, therefore, work on more modern systems was not tested), there is also a caveat, Windows Server it is better to use the English version, without MUI, while the migration is taking place, then nothing prevents it from being delivered. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, enough water, let's proceed to the process itself. <br><br>  Before further work, you can start installing the system, but without setting up or creating anything in it (I didn‚Äôt even install the driver until we create users). <br><br>  The day we started, we need to pull out a list of all users and groups in which they are (I had a problem, not all users were exported with the groups into which they belong, we need to check), for this we use the vbs script that I <a href="http://gallery.technet.microsoft.com/scriptcenter/1af1f056-c945-4d18-a4aa-c244ac1daac7">found here</a> , but I had to modify to get more visually and the necessary parameters (it is also worth mentioning that this should be done on a PC that is included in the domain and under the domain account, I did under the account of the global domain administrator). <br><br><div class="spoiler">  <b class="spoiler_title">export AD User Accounts.vbs</b> <div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> strFileName = <span class="hljs-string"><span class="hljs-string">"Users-Groups-SIDs.xlsx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objShell = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Wscript.Shell"</span></span>) strPath = Wscript.ScriptFullName <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objFile = objFSO.GetFile(strPath) strFolder = objFSO.GetParentFolderName(objFile) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> objExcelApp = <span class="hljs-built_in"><span class="hljs-built_in">CREATEOBJECT</span></span>(<span class="hljs-string"><span class="hljs-string">"Excel.Application"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> objWB = objExcelApp.Workbooks.Add <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> objExcel = objWB.Worksheets(<span class="hljs-number"><span class="hljs-number">1</span></span>) objWB.SaveAs(strFolder &amp; <span class="hljs-string"><span class="hljs-string">"\"</span></span> &amp; strFileName) <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> ADS_SCOPE_SUBTREE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objConnection = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Connection"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objCommand = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"ADODB.Command"</span></span>) objConnection.Provider = <span class="hljs-string"><span class="hljs-string">"ADsDSOObject"</span></span> objConnection.Open <span class="hljs-string"><span class="hljs-string">"Active Directory Provider"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objCommand.ActiveConnection = objConnection objCommand.Properties(<span class="hljs-string"><span class="hljs-string">"Page Size"</span></span>) = <span class="hljs-number"><span class="hljs-number">1000</span></span> objCommand.Properties(<span class="hljs-string"><span class="hljs-string">"Searchscope"</span></span>) = ADS_SCOPE_SUBTREE <span class="hljs-comment"><span class="hljs-comment">'Set the path of the file to the same folder of the script 'Open the file and make the workbook visible Set objExcel = CreateObject("Excel.Application") Set objWorkbook = objExcel.Workbooks.Open(strFolder &amp; "\" &amp; strFileName) objExcel.Visible = True 'objExcel.Cells(1, 1).Value = "Name" 'objExcel.Cells(1, 1).Font.Bold = TRUE 'objExcel.Columns(1).ColumnWidth = 40 'objExcel.Cells(1, 2).Value = "Security ID" 'objExcel.Cells(1, 2).Font.Bold = TRUE 'objExcel.Columns(2).ColumnWidth = 60 'Starting row of the Excel is 2, since first row are column headings y = 2 objCommand.CommandText = _ "SELECT * FROM 'LDAP://DC=mvi,DC=srv' WHERE objectCategory='user'" Set objRecordSet = objCommand.Execute objRecordSet.MoveFirst Do Until objRecordSet.EOF strADsPathUser = objRecordSet.Fields("ADsPath").Value 'wScript.echo strADsPathUser Set objUser = GetObject(strADsPathUser) z = 1 objExcel.Cells(y,z) = objUser.sn objExcel.Cells(1, z).Value = "sn" 'Wscript.Echo objUser.sn objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.givenName objExcel.Cells(1, z).Value = "givenName" 'Wscript.Echo objUser.givenName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.initials objExcel.Cells(1, z).Value = "initials" 'Wscript.Echo objUser.initials objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.description objExcel.Cells(1, z).Value = "description" objExcel.Cells(1, z).Font.Bold = TRUE 'Wscript.Echo objUser.description z = z + 1 objExcel.Cells(y,z) = objUser.codePage objExcel.Cells(1, z).Value = "codePage" objExcel.Cells(1, z).Font.Bold = TRUE 'Wscript.Echo objUser.codePage z = z + 1 objExcel.Cells(y,z) = objUser.sAMAccountName objExcel.Cells(1, z).Value = "sAMAccountName" 'Wscript.Echo objUser.sAMAccountName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.codePage objExcel.Cells(1, z).Value = "codePage" objExcel.Cells(1, z).Font.Bold = TRUE 'Wscript.Echo objUser.codePage z = z + 1 objExcel.Cells(y,z) = objUser.mail objExcel.Cells(1, z).Value = "mail" 'Wscript.Echo objUser.mail objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 intUserSID = fnGet_HexString(objUser.ObjectSID) objExcel.Cells(y,z) = intUserSID objExcel.Cells(1, z).Value = "ObjectSID" 'Wscript.Echo objUser.ObjectSID objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.userPrincipalName objExcel.Cells(1, z).Value = "userPrincipalName" 'Wscript.Echo objUser.userPrincipalName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.displayName objExcel.Cells(1, z).Value = "displayName" 'Wscript.Echo objUser.displayName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.distinguishedName objExcel.Cells(1, z).Value = "distinguishedName" 'Wscript.Echo objUser.distinguishedName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 intUserSID = stringlist(objUser.memberOf) objExcel.Cells(y,z) = intUserSID objExcel.Cells(1, z).Value = "memberOf" 'Wscript.Echo objUser.memberOf objExcel.Cells(1, z).Font.Bold = TRUE '   z = z + 1 objExcel.Cells(y,z) = objUser.physicalDeliveryOfficeName objExcel.Cells(1, z).Value = "physicalDeliveryOfficeName" 'Wscript.Echo objUser.physicalDeliveryOfficeName objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.telephoneNumber objExcel.Cells(1, z).Value = "telephoneNumber" 'Wscript.Echo objUser.telephoneNumber objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.profilePath objExcel.Cells(1, z).Value = "profilePath" 'Wscript.Echo objUser.profilePath objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.scriptPath objExcel.Cells(1, z).Value = "scriptPath" 'Wscript.Echo objUser.scriptPath objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.homeDirectory objExcel.Cells(1, z).Value = "homeDirectory" 'Wscript.Echo objUser.homeDirectory objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.homeDrive objExcel.Cells(1, z).Value = "homeDrive" 'Wscript.Echo objUser.homeDrive objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.title objExcel.Cells(1, z).Value = "title" 'Wscript.Echo objUser.title objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.department objExcel.Cells(1, z).Value = "department" 'Wscript.Echo objUser.department objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.company objExcel.Cells(1, z).Value = "company" 'Wscript.Echo objUser.company objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.manager objExcel.Cells(1, z).Value = "manager" 'Wscript.Echo objUser.manager objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.homePhone objExcel.Cells(1, z).Value = "homePhone" 'Wscript.Echo objUser.homePhone objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.pager objExcel.Cells(1, z).Value = "pager" 'Wscript.Echo objUser.pager objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.mobile objExcel.Cells(1, z).Value = "mobile" 'Wscript.Echo objUser.mobile objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.facsimileTelephoneNumber objExcel.Cells(1, z).Value = "facsimileTelephoneNumber" 'Wscript.Echo objUser.facsimileTelephoneNumber objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.ipphone objExcel.Cells(1, z).Value = "ipphone" 'Wscript.Echo objUser.ipphone objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.info objExcel.Cells(1, z).Value = "info" 'Wscript.Echo objUser.info objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.streetAddress objExcel.Cells(1, z).Value = "streetAddress" 'Wscript.Echo objUser.streetAddress objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.postOfficeBox objExcel.Cells(1, z).Value = "postOfficeBox" 'Wscript.Echo objUser.postOfficeBox objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.l objExcel.Cells(1, z).Value = "l" 'Wscript.Echo objUser.l objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.st objExcel.Cells(1, z).Value = "st" 'Wscript.Echo objUser.st objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.c objExcel.Cells(1, z).Value = "c" 'Wscript.Echo objUser.c objExcel.Cells(1, z).Font.Bold = TRUE z = z + 1 objExcel.Cells(y,z) = objUser.wWWHomePage objExcel.Cells(1, z).Value = "wWWHomePage" 'Wscript.Echo objUser.wWWHomePage objExcel.Cells(1, z).Font.Bold = TRUE ''''''''''''''''''''''''''' y = y + 1 objRecordSet.MoveNext Loop objCommand.CommandText = _ "SELECT * FROM 'LDAP://DC=mvi,DC=srv' WHERE objectCategory='group'" Set objRecordSet = objCommand.Execute objRecordSet.MoveFirst Do Until objRecordSet.EOF strADsPathGroup = objRecordSet.Fields("ADsPath").Value 'wScript.echo strADsPathGroup Set objGroup = GetObject(strADsPathGroup) 'if objGroup.groupType = "-2147483646" then objExcel.Cells(y,1) = objGroup.sAMAccountName 'Wscript.Echo objUser.sAMAccountName intGroupSID = fnGet_HexString(objGroup.ObjectSID) objExcel.Cells(y,2) = intGroupSID 'Wscript.Echo intUserSID 'End if y = y + 1 objRecordSet.MoveNext Loop objRecordSet.Close objConnection.Close SET objSheet = NOTHING SET objWB = NOTHING objExcelApp.Quit() SET objExcelApp = NOTHING Wscript.echo "Script Finished..." ''' Function stringlist(memberOf) Dim objmemberOf ' Heart of the script, extract a list of Groups from memberOf objmemberOf = objUser.GetEx("memberOf") For Each objGroup in objmemberOf strList = strList &amp; """" &amp; objGroup &amp; """" &amp; " " Next stringlist = strUser &amp; strList 'WScript.Echo "Groups for " &amp; strUser &amp; strList End Function ''' Function fnGet_HexString(intSID) Dim strRet, i, b strRet = "" For i = 0 to Ubound(intSID) b = hex(ascb(midb(intSID,i+1,1))) If( len(b) = 1 ) then b = "0" &amp; b strRet = strRet &amp; b Next fnGet_HexString = fnHexStrToDecStr(strRet) End Function Function fnHexStrToDecStr(strSid) Dim arrbytSid, lngTemp, j ReDim arrbytSid(Len(strSid)/2 - 1) For j = 0 To UBound(arrbytSid) arrbytSid(j) = CInt("&amp;H" &amp; Mid(strSid, 2*j + 1, 2)) Next fnHexStrToDecStr = "S-" &amp; arrbytSid(0) &amp; "-" &amp; arrbytSid(1) &amp; "-" &amp; arrbytSid(8) lngTemp = arrbytSid(15) lngTemp = lngTemp * 256 + arrbytSid(14) lngTemp = lngTemp * 256 + arrbytSid(13) lngTemp = lngTemp * 256 + arrbytSid(12) fnHexStrToDecStr = fnHexStrToDecStr &amp; "-" &amp; CStr(lngTemp) lngTemp = arrbytSid(19) lngTemp = lngTemp * 256 + arrbytSid(18) lngTemp = lngTemp * 256 + arrbytSid(17) lngTemp = lngTemp * 256 + arrbytSid(16) fnHexStrToDecStr = fnHexStrToDecStr &amp; "-" &amp; CStr(lngTemp) lngTemp = arrbytSid(23) lngTemp = lngTemp * 256 + arrbytSid(22) lngTemp = lngTemp * 256 + arrbytSid(21) lngTemp = lngTemp * 256 + arrbytSid(20) fnHexStrToDecStr = fnHexStrToDecStr &amp; "-" &amp; CStr(lngTemp) lngTemp = arrbytSid(25) lngTemp = lngTemp * 256 + arrbytSid(24) fnHexStrToDecStr = fnHexStrToDecStr &amp; "-" &amp; CStr(lngTemp) End Function</span></span></code> </pre> </div></div><br><br>  At the start, the Office Excel window will open, with the <b>Users-Groups-SIDs.xlsx</b> open file and data will be written to it line by line (do not touch the mouse, do not click anywhere until the work is completed, otherwise there may be errors in the data retrieval).  After the script finishes, we will receive a notification, <b>Script Finished ...</b> which means its completion, now we will wait a few seconds for the script to free the table, we will receive a notification from the office that the table is available for recording, agree and click the ‚Äúsave‚Äù button.  At the output we get a table screen table where there are columns: <b>sn;</b>  <b>givenName;</b>  <b>initials;</b>  <b>description;</b>  <b>codePage;</b>  <b>sAMAccountName;</b>  <b>codePage;</b>  <b>mail;</b>  <b>ObjectSID;</b>  <b>userPrincipalName;</b>  <b>displayName;</b>  <b>distinguishedName;</b>  <b>memberOf;</b>  <b>physicalDeliveryOfficeName;</b>  <b>telephoneNumber;</b>  <b>profilePath;</b>  <b>scriptPath;</b>  <b>homeDirectory;</b>  <b>homeDrive;</b>  <b>title;</b>  <b>department;</b>  <b>company;</b>  <b>manager;</b>  <b>homePhone;</b>  <b>pager;</b>  <b>mobile;</b>  <b>facsimileTelephoneNumber;</b>  <b>ipphone;</b>  <b>info;</b>  <b>streetAddress;</b>  <b>postOfficeBox;</b>  <b>l;</b>  <b>st;</b>  <b>c;</b>  <b>wWWHomePage</b> <br><br>  We don‚Äôt need most of them (you can fix them in the script itself by removing unnecessary parameters, but for the first time let it be all). <br>  From the obtained values, we now need the <b>sAMAccountName</b> and <b>ObjectSID columns</b> , sort the <b>ObjectSID</b> in ascending order (from A to Z) and copy them saving to the text file <b>users.txt</b> , slightly changing their appearance, should learn this: <b>sAMAccountName, ObjectSID</b> <br>  Those.  like this: <br><br><pre> <code class="dos hljs">dns-gw-sult,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1101</span></span> DnsAdmins,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1102</span></span> IIS_IUSRS,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1102</span></span> DnsUpdateProxy,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1103</span></span> ivanov,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1105</span></span> ozonov,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1108</span></span> elina,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1111</span></span> anna,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1113</span></span> dash,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1115</span></span> denis,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1116</span></span> danuev,S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">21</span></span>-<span class="hljs-number"><span class="hljs-number">833212901</span></span>-<span class="hljs-number"><span class="hljs-number">2941102506</span></span>-<span class="hljs-number"><span class="hljs-number">3986841923</span></span>-<span class="hljs-number"><span class="hljs-number">1119</span></span></code> </pre><br><br>  As you can see, each entry is in a separate line, you can see that the last numbers go in order, but there are also missing intervals (since samba wrote users in LDAP with different RIDs (ie, numbers in order), and AD will create users in a row, starting with some specific RID, you need to create all the missing users and somehow more or less understandably call them), so we fill them in using the perl script <b>script-add user.pl</b> : <br><br><div class="spoiler">  <b class="spoiler_title">script-add user.pl</b> <div class="spoiler_text"><pre> <code class="vbscript hljs">use strict; use warnings; use Data::Dumper; my (%input, %output,$max); my $input_file = <span class="hljs-string"><span class="hljs-string">"users.txt"</span></span>; my $output_file = <span class="hljs-string"><span class="hljs-string">"output.txt"</span></span>; my $sambaSID = <span class="hljs-string"><span class="hljs-string">"S-1-5-21-833212901-2941102506-3986841923-"</span></span>; open FIN, <span class="hljs-string"><span class="hljs-string">"&lt;$input_file"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (&lt;FIN&gt;) { chomp(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (/(.*),$sambaSID(.*)/) { $input{$<span class="hljs-number"><span class="hljs-number">2</span></span>}=$<span class="hljs-number"><span class="hljs-number">1</span></span>; $max=$<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> &gt; $max; } } close FIN; print Dumper(\%input); print Dumper($max); open FOUT, <span class="hljs-string"><span class="hljs-string">"&gt;$output_file"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (my $i=<span class="hljs-number"><span class="hljs-number">1001</span></span>;$i&lt;=$max;$i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exists $input{$i}) { print <span class="hljs-string"><span class="hljs-string">"input: $input{$i} i: $i\n"</span></span>; print FOUT <span class="hljs-string"><span class="hljs-string">"$input{$i}\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { print FOUT <span class="hljs-string"><span class="hljs-string">"user$i\n"</span></span>; } } close FOUT;</code> </pre></div></div><br><br>  In the original article there are not very working moments, so I asked a friend to correct errors, at least the script worked as planned. <br>  And at the output we received the file <b>output.txt</b> (in which users will start with RID 1001 and further and have the names user1001, etc.) with the content: <br><br><div class="spoiler">  <b class="spoiler_title">output.txt</b> <div class="spoiler_text"><pre> <code class="dos hljs">user1001 user1002 user1003 user1004 user1005 user1006 user1007 user1008 user1009 user1010 user1011 user1012 user1013 user1014 user1015 user1016 user1017 user1018 user1019 user1020 user1021 user1022 user1023 user1024 user1025 user1026 user1027 user1028 user1029 user1030 user1031 user1032 user1033 user1034 user1035 user1036 user1037 user1038 user1039 user1040 user1041 user1042 user1043 user1044 user1045 user1046 user1047 user1048 user1049 user1050 user1051 user1052 user1053 user1054 user1055 user1056 user1057 user1058 user1059 user1060 user1061 user1062 user1063 user1064 user1065 user1066 user1067 user1068 user1069 user1070 user1071 user1072 user1073 user1074 user1075 user1076 user1077 user1078 user1079 user1080 user1081 user1082 user1083 user1084 user1085 user1086 user1087 user1088 user1089 user1090 user1091 user1092 user1093 user1094 user1095 user1096 user1097 user1098 user1099 user1100 dns-gw-sult IIS_IUSRS DnsUpdateProxy user1104 ivanov user1106 user1107 ozonov user1109 user1110 elina user1112 anna user1114 dash denis user1117 user1118 danuev</code> </pre></div></div><br><br>  The resulting list is placed in the <a href="http://it-kursy.ru/article/admtools/user-xls"><b>dsadd-new.xls</b></a> table <a href="http://it-kursy.ru/article/admtools/user-xls"><b>and</b></a> had to be slightly modified to fit our needs.  In the modified table, put in the <b>Login</b> column.  The initial user SIDs in the SID column and check that the user <b>user-1101</b> should be <b>S-1-5-21-833212901-2941102506-3986841923-1101</b> the user <b>user-1102 is</b> such <b>S-1-5-21-833212901-2941102506-3986841923 -1102</b> (I think that the logic of the work is clear, and the SID of known users should remain the same as it was, we have it in the <b>Users-Groups-SIDs.xlsx file</b> ).  To put the user in the group in which he was previously, then for this you need to take the <b>memberOf</b> column from the <b>Users-Groups-SIDs.xlsx</b> <b>file</b> and put each user in the <b>dsadd-new.xls file</b> in the <b>GROUP</b> column <b>.</b>  It is also necessary to fill in all the other fields, if necessary, but it is <b>necessary to fill out the Last Name and First Name columns, if this is not done, the creation of commands to create will be incorrect</b> .  The <b>Login</b> column will automatically generate a username to log in to the domain, if you are not satisfied with the login change, change the template or write the required login yourself (some of my users didn‚Äôt have the same login name, so they replaced it with the required one). <br>  <strong>I also ask you to pay attention to the fact that if:</strong> <strong><br></strong>  <strong>- the Patronymic column will not be filled, then when creating users, an extra space will be added to them at the end, which may lead to problems for some programs;</strong> <strong><br></strong>  <strong>- I didn‚Äôt manage to automatically create a group, so we‚Äôll create groups using a crypt that will create them in OU-Users, but this may lead to inoperability of some authorizations in various services (Apache, OpenVPN, etc.), because .</strong>  <strong>I also had OU-Builtin and OU-Groups, but decided to lay it all together for the time being.</strong> <strong><br></strong> <br><br><div class="spoiler">  <b class="spoiler_title">add_group.cmd</b> <div class="spoiler_text"><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">rem   (CN)  CN Users rem dsadd group "cn=,cn=users,dc=mvi,dc=srv" for %%A in ( jira-users, jira-administrators, Developers, jira-developers, mvi-users, berry-dev, online-developers, marketing-users, Marketing, ne-users, ne-developers, ne-admin, marketing-administrators, online-users, bills,QA, ) do dsadd group "cn=%%A,cn=users,dc=mvi,dc=srv" rem   (OU)   rem dsadd group "cn=,cn=groups,dc=mvi,dc=srv" dsadd ou "ou=Groups,dc=mvi,dc=srv" for %%B in ( vpn-users, svn-users, jenkins-adm, jenkins, PHP_Developers, amazon-users, ) do dsadd group "cn=%%B,ou=groups,dc=mvi,dc=srv"</span></span></code> </pre></div></div><br><br>  After performing routine operations on copy-paste and verification, you can prepare bat files that will help create users and teams to add them to groups.  In the columns: <b>TOTAL</b> and <b>TOTAL</b> , the group contains commands for creating users and teams for adding them to groups, respectively, and save their contents in bat files <b>add_user.cmd</b> , <b>add_group.cmd</b> . <br>  Formation of users and groups is ready. <br><br>  Now let's do a Windows Server.  To date, the system must be installed.  We will need the newsid utility.  Take the SID from the list of users, this is <b>S-1-5-21-833212901-2941102506-3986841923</b> (from the received user SID, delete the last characters, up to <b>"-"</b> and get the domain SID), and replace the current SID of the system with ours.  The system will start the changes and reboot (after rebooting, you can run the utility again and see that the SID has changed).  Everything, you can install the ActiveDirectory service (I don‚Äôt know how, but I first set the DNS, skipping its settings, then using <b>dcpromo, I</b> set up the domain service itself), but before that I need to either turn off the <b>SAMBA</b> server and <b>bind</b> , or turn off these services (I had to turn off the service, because it is also the gateway to the Internet <s>would have torn off the hands of such an admin</s> ).  I don‚Äôt know if you can specify a different domain name (nothing prevents), but I had to leave the current one.  We make the necessary settings and reboot the system (as usual).  Now you need to install a module to expand the displayed properties of the <b>acctinfo</b> object (from the link above, where to download, it is written how to install), we launch <b>the Active Directory Users and Computers</b> snap <b>-in</b> .  We are trying to create one user from the first line of the script <b>add_user.cmd</b> <br><pre> <code class="dos hljs">dsadd User "cn=user-<span class="hljs-number"><span class="hljs-number">1101</span></span> user-<span class="hljs-number"><span class="hljs-number">1101</span></span> ,cn=users,dc=mvi,dc=srv" -UPN dns-gw-sult@mvi.srv -samid dns-gw-sult -display "user-<span class="hljs-number"><span class="hljs-number">1101</span></span> user-<span class="hljs-number"><span class="hljs-number">1101</span></span> " -fn user-<span class="hljs-number"><span class="hljs-number">1101</span></span> -ln user-<span class="hljs-number"><span class="hljs-number">1101</span></span> -pwd "p6Jx3Xre" -mustchpwd yes -disabled no -pwdneverexpires yes</code> </pre><br>  We look in the <b>"Active Directory Users and Computers"</b> what is its SID in the properties in the tab <b>Additional Account Info</b> .  If the username matches with his SID ending, then everything is correct and does not require correction (if the SID does not match, then we start with the user with the next SID number, ie, add 1 to the current one).  At this place, I had epic fail with one user, his SID contained 1105, and my users started creating from 1106, so I had to suffer for a long time and transfer all user data, because  his id was incorrect. <br>  After clarifying the order from which users are created, it is necessary to correct the creation of users by removing / commenting out commands that no longer correspond, i.e.  remove everything that is up to user-1107 and you can safely run the script <b>add_user.cmd</b> .  After the execution, you need to create groups, otherwise nothing will come out.  Run <b>add_group.cmd,</b> check if all groups have been created (you should pay attention to the fact that global security groups are created, if other types are needed, then you need to add to the script -scope {l | g | u}, read the manual on <b>dsadd group</b> ). <br><br><div class="spoiler">  <b class="spoiler_title">dsadd group /?</b> <div class="spoiler_text"><pre> <code class="dos hljs">.    . : dsadd group &lt;GroupDN&gt; [-secgrp {yes | no}] [-scope {l | g | u}] [-samid &lt;SAMName&gt;] [-desc &lt;Description&gt;] [-memberof &lt;Group ...&gt;] [-members &lt;Member ...&gt;] [{-s &lt;Server&gt; | -d &lt;Domain&gt;}] [-u &lt;UserName&gt;] [-p {&lt;Password&gt; | *}] [-q] [{-uc | -uco | -uci}]    &lt;DN_&gt;   stdin.   (DN)  .     ,      (stdin). -secgrp {yes | no} ,    (yes)    (no)  .  : yes. -scope {l | g | u} ,       (l),  (g)   (u).      ,    .  : . -samid &lt;_SAM&gt;     SAM  &lt;_SAM&gt; (, "operators"). -desc &lt;&gt;    &lt;&gt;. -memberof &lt;...&gt;       ,      DN &lt;...&gt;. -members &lt;...&gt;       .       &lt;...&gt;. {-s &lt;&gt; | -d &lt;&gt;} -s &lt;&gt;      ()   &lt;&gt;. -d &lt;&gt;      .  :    . -u &lt;&gt;    &lt;&gt;.  :  .  : , \   - (UPN). -p {&lt;&gt; | *}   &lt;&gt;.   *,    . -q  :      . {-uc | -uco | -uci} -uc           . -uco          . -uci          . .        ,         (STDIN).  STDIN     ,       .      STDIN     ,  CTRL+Z     (EOF).     ,     (, "CN=Ivan Ivanov,CN=Users,DC=microsoft,DC=com").     ,    (,    ). . : dsadd computer /? -      . dsadd contact /? -      . dsadd group /? -      . dsadd ou /? -      . dsadd user /? -      . dsadd quota /? -      .        : dsadd /? -    . dsget /? -    . dsmod /? -    . dsmove /? -    . dsquery /? -    ,   . dsrm /? -    .</code> </pre></div></div><br><br>  After verification, we run a script that will add users to the <b>add_user_group.cmd</b> groups (note that there may be differences, check where the groups were created and which are specified by the user). <br><br>  So we finished the migration, now we have <b>ActiveDirectory</b> instead of <b>SAMBA</b> , users have the same identifiers, it remains to enter the computers themselves into the domain and the task will be completed, we will only have to finish some moments that are individual for each. <br><br>  The text, written by me, as usual, muddled, chaotic, contains errors, possibly inaccuracies, etc. <br><br>  <a href="http://yadi.sk/d/hQe1ehke3TyLS">All scripts in one place (with examples).</a> <br><br>  PS <br>  I hope everyone remembers that cmd, in this case, should be saved using OEM encoding? <br>  Error please report for correction. <br><br><div class="spoiler">  <b class="spoiler_title">Material used:</b> <div class="spoiler_text">  <a href="http://sysadmins.ru/post7750072.html">sysadmins.ru/post7750072.html</a> <br>  <a href="http://social.technet.microsoft.com/Forums/de-DE/windowsserverru/thread/c75c66cb-5621-4ad7-923d-ec22d81cb2b2">social.technet.microsoft.com/Forums/de-DE/windowsserverru/thread/c75c66cb-5621-4ad7-923d-ec22d81cb2b2</a> <br>  <a href="http://gallery.technet.microsoft.com/scriptcenter/1af1f056-c945-4d18-a4aa-c244ac1daac7">gallery.technet.microsoft.com/scriptcenter/1af1f056-c945-4d18-a4aa-c244ac1daac7</a> <br>  <a href="http://it-kursy.ru/article/admtools/user-xls">it-kursy.ru/article/admtools/user-xls</a> <br>  <a href="http://download.chip.eu/ru/NewSID_163121.html">download.chip.eu/en/NewSID_163121.html</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/173985/">https://habr.com/ru/post/173985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173973/index.html">New version of Python Tools for Visual Studio 2.0 released</a></li>
<li><a href="../173975/index.html">Serializable or Parcelable?</a></li>
<li><a href="../173979/index.html">Bestindigital rating</a></li>
<li><a href="../173981/index.html">Blizzard goes to the mobile market - "Hearthstone: Heroes of Warcraft" in the summer on iPads</a></li>
<li><a href="../173983/index.html">Sandbox overview March 16-22</a></li>
<li><a href="../173987/index.html">How to start your personal account</a></li>
<li><a href="../173989/index.html">Highscreen Boost, smartphone with a normal battery</a></li>
<li><a href="../173991/index.html">Eclipse Improved search and highlighting of code blocks</a></li>
<li><a href="../173995/index.html">China standardizes national OS based on Ubuntu</a></li>
<li><a href="../173997/index.html">GitLab 5.0 release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>