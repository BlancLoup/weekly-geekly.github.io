<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we adapted the ELK stack to monitor and analyze errors in Java and .NET projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The patient comes to the doctor and complains of abdominal pain. ‚ÄúUrgently for surgery! - the doctor answers. - Now we will cut you, dig and try to se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we adapted the ELK stack to monitor and analyze errors in Java and .NET projects</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>The patient comes to the doctor and complains of abdominal pain.</em>  <em>‚ÄúUrgently for surgery!</em>  <em>- the doctor answers.</em>  <em>- Now we will cut you, dig and try to sew as it was.</em> </p><br><p>  When users swore at the system, calling programmers villains, we picked up the event log and watched what went wrong.  And then switched to ELK.  Now we monitor errors in the moment, without slowing down the work of services. </p><br><p>  In this article, we will describe how we adapt and apply the ELK stack on Java and .Net projects and find errors online without opening or using minimally invasive methods.  Yes, we figured out and realized that it is not very important whether Microsoft made this decision or Open Source - everything can be customized to fit your needs. <br></p><br><img src="https://habrastorage.org/webt/bv/cz/jq/bvczjq_28jm_svnfjdpmhbxc81a.jpeg"><a name="habracut"></a><br><br><h2 id="o-kakih-proektah-rech">  What projects are we talking about? </h2><br><h4 id="tyazhelo-i-tschatelno-realii-java">  Hard and thorough: the realities of Java </h4><br><p>  Our Java product is a federal ticketing system.  It should work smoothly, freezing and suspension of work is unacceptable.  And in the event of a failure, you need to quickly and accurately understand the reason, because it is the loss of the client's live money. </p><br><p>  Here ELK works as an online monitoring and work tool for our support service.  We log the ‚Äúraw‚Äù data so that when the customer contacts the technical support we know what data we are discussing, what was the encryption key, etc. </p><br><h4 id="retrospektivnyy-analiz-oshibok-na-net-proektah">  Retrospective error analysis on .Net projects </h4><br><p>  .Net projects are mainly sales and customer support services.  It is used by more than 20 thousand people.  Too much, but the load is not as big as in Java. </p><br><p>  We log errors and information that show the dynamics of business operations.  For example, how many users registered on the site.  And when we see that there were no registrations for two days, it is immediately clear that something happened there.  Or vice versa - they sold a million tickets and sent a letter to the director about it, pleased the person. </p><br><h2 id="kak-rabotaem-s-elk">  How we work with ELK </h2><br><h4 id="logirovanie-serilog--elk">  Logging: Serilog + ELK </h4><br><p>  On .Net-projects we also mainly use Serilog, since it has ample opportunities for pouring data.  There is no point in using beats or Logstash, since Serilog is able to log structuredly: such and such a user logged into the system at a certain time.  And you can also customize values ‚Äã‚Äãfor the necessary pieces of information: API, time, etc.  And when he starts writing logs in Elastic, it will not be a string, but a property of the object by which you can search.  That is, we pass Filebeat and Logstash, eliminating double work. </p><br><h4 id="durable-mode">  Durable mode </h4><br><p>  We use the Serilog mode called Durable mode - it guarantees the delivery of messages, even if Elastic is lying for a while.  It works in the same way as Filebeat plus Logstash - first it puts everything into a file, then it tries to urgently deliver to Elastic, if this fails, then Serilog periodically tries until Elastic rises.  You can configure how often he will contact Elastic. </p><br><p>  <a href="https://github.com/serilog/serilog-sinks-elasticsearch/wiki/durability">Here</a> you can read the instructions for setting up. </p><br><h4 id="konteynery-dlya-logov">  Log Containers </h4><br><p>  on Java projects we write a lot of logs - up to 5 GB per day.  These files are beaten into pieces of 5 MB so that they take up less space and make them easier to store.  ELK is stored and raised in the Docker-containers on our computers - it turns out a virtual machine, just a lighter one that someone has already configured before you. </p><br><p>  On .NET projects, the logs are not as big as on Java projects, so there we beat files not by size, but by day.  And then we analyze the logs, highlighting the types of errors. </p><br><p><img src="https://habrastorage.org/webt/vh/fg/-f/vhfg-fcku-cq4i2fgf11fbcda-e.jpeg"></p><br><h4 id="monitoring-zabbix">  Zabbix monitoring </h4><br><p>  Each entry has a Trace ID, and the browser measures the start and end times of the operation - we log this data on the server, and then monitor it via Zabbix. </p><br><h4 id="kibana-grafana">  Kibana / Grafana </h4><br><p>  Kibana use for daily monitoring errors.  In Kibana, you can do a search in the logs.  We use this function on the server and on the test servers.  We also have Grafana - she has better visualization, all our projects are shown on one dashboard.  Here we can see all the data.  Red marks all errors - this is a reason to get into Kibana and see the details.  We see where the error is, its place in the code, when it arose, the conditions of the environment.  We have one ID that binds all systems together and can trace the complete path of the error. </p><br><p>  If the error is unknown, we begin to understand more closely.  For example, we recently laid out on a single business process.  Testing by the customer went well, but we looked into the logs and saw that there was a mistake.  We immediately corrected it, and no one noticed. </p><br><p>  For example, on this screenshot you can see the number of registrations on one project: </p><br><p><img src="https://habrastorage.org/webt/8b/lu/x8/8blux8frqrbi1xijz49cl4dughy.jpeg"></p><br><h4 id="analiz-oshibok">  Error analysis </h4><br><p>  Every day we get all errors from ELK, we define new ones among them, we classify them, and at the same time we give a human-friendly name. </p><br><p>  We observe the dynamics of already classified errors, catch bursts and understand the causes.  Technical support engineer gets the task to eliminate the causes.  In a day, thousands and tens of thousands of lines need to be analyzed in the logs, and even more on Java projects.  Many mistakes are repeated every minute. </p><br><p>  We started, like many with a visual review of all the logs.  But they quickly realized that with our volumes it was impossible to live like this.  And set up an Excel spreadsheet with macros that can take data from Kibana for a day, select errors from them and distribute them into existing categories. </p><br><p>  As a result, Excel produces a report, where for each error there is information, how many times a day this error occurred.  We receive new errors in a separate list, and we can quickly analyze them first - is there a critical one or not. </p><br><p>  In Kibana we go to look at the detailed information on each new error. </p><br><p>  What file allows to do: </p><br><ul><li>  Receive from Elasticsearch in one table the necessary messages on the necessary projects for the necessary period.  To do this, specify the source data in the settings. </li></ul><br><p><img src="https://habrastorage.org/webt/cd/mn/fo/cdmnfoyciimj6zmjvvcuzjs1p60.png"><br><img src="https://habrastorage.org/webt/hb/f1/tb/hbf1tbggyna6lhelqavj7a-hvpo.png"><br><img src="https://habrastorage.org/webt/aa/ud/eu/aaudeunp68mcyq0ldmqx9hxyzwa.jpeg"></p><br><ul><li>  Assign "names" to errors.  Using regular expressions, a search pattern is defined and a human-readable notation is assigned to it.  Then all matching errors in the source table are labeled with this name. </li></ul><br><p><img src="https://habrastorage.org/webt/5e/ci/ah/5eciahhloa8ud0psqnyjgj54vdu.jpeg"></p><br><ul><li>  The categories OK and ERROR are also assigned, indicating whether to pay attention to the message or not.  By these types can be filtered.  OTHER - shows the total number of messages on the project (not only errors, but simply informational).  And task numbers in TFS are assigned if they are already running. </li></ul><br><p><img src="https://habrastorage.org/webt/qa/gx/ni/qagxnigj_h0cswrxgqai0uuw8ay.jpeg"></p><br><ul><li>  Build a graph for more convenient analysis with the ability to filter. </li></ul><br><p><img src="https://habrastorage.org/webt/5g/xj/9j/5gxj9jsnkxxvyjueaajgusmgjh8.png"></p><br><p>  Let us examine, on the example of one of the projects, fresh errors in the last couple of days: </p><br><p><img src="https://habrastorage.org/webt/7-/mo/az/7-moazipq9jvf51jh5cynpalrcg.jpeg"></p><br><p>  What we see: <br>  1) errors in the upper part that are assigned task numbers are not critical, are waiting for a decision by the developers, they are assigned task numbers from TFS. <br>  2) the error "ADMS service unavailable" appeared 388 times a day - for several hours the service was unavailable, which we saw when contacting Kibana for clarification. </p><br><p><img src="https://habrastorage.org/webt/qz/su/qr/qzsuqrpi7vyux4iwtcnrepzevfy.png"></p><br><p>  3) a new type of error ‚ÄúCould not connect to ...‚Äù appeared - it is connected with the previous one, just logged in one more place. </p><br><p>  We are going to ‚Äúinvestigate‚Äù these two types of errors in order to find out the causes, the likelihood of recurrence and ways to prevent them in the future.  They will be given a generic term so that these errors are ‚Äúcurled‚Äù into one line. </p><br><h3 id="chto-planiruem-uluchshit">  What are planning to improve </h3><br><p>  Now we are working on a separate system, which itself will select all the errors from Elasticsearch according to the schedule, notify the operator about the new ones and notify about the bursts of errors.  It will run faster than an Excel file that is constantly growing.  This system will allow you to build a graph with different discreteness, and not just a day.  The operator will still analyze new errors, give them names and react to unforeseen situations. </p><br><p>  <em>PS Now, thanks to ELK, the doctor himself notices that the patient is unwell, can quickly make a diagnosis and hand a useful pill, and leave the surgery for the most extreme cases.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348054/">https://habr.com/ru/post/348054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348040/index.html">How Atlassian has built a $ 10 billion business. Part 2</a></li>
<li><a href="../348042/index.html">Developing a PCI device driver for Linux</a></li>
<li><a href="../348044/index.html">Rook - "self-service" data store for Kubernetes</a></li>
<li><a href="../348046/index.html">What exactly is personal data?</a></li>
<li><a href="../348052/index.html">Top 5 Information Security Forecasts</a></li>
<li><a href="../348056/index.html">How I wrote the Java Olympics or why it is better not to use Scanner</a></li>
<li><a href="../348058/index.html">Free Tesla K80 GPU for your experiments with neural networks</a></li>
<li><a href="../348060/index.html">‚ÄúHurray, we were checkin!‚Äù Or How to change the data center under load and without downtime when everything goes to hell</a></li>
<li><a href="../348062/index.html">Gas savings in smart Ethereum contracts</a></li>
<li><a href="../348064/index.html">Nemesida Scanner - Web Application Vulnerability Scanner</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>