<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to bind Docker containers without forcing the application to read environment variables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker, if anyone has managed to not hear about it yet - an open source framework for managing container virtualization. He is fast, comfortable, thou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to bind Docker containers without forcing the application to read environment variables</h1><div class="post__text post__text-html js-mediator-article"> Docker, if anyone has managed to not hear about it yet - an open source framework for managing container virtualization.  He is fast, comfortable, thoughtful and fashionable.  In fact, it changes the rules of the game in the noble work of managing the configuration of servers, building applications, executing server code, managing dependencies, and much more. <br><br>  The architecture that Docker encourages is isolated containers, each of which executes one command.  These containers should be known only as each other to find - in other words, you need to know about the container its fqdn and port, or ip and port, that is, nothing more than about any external service. <br><br>  The recommended way to communicate such coordinates within the process running in Docker is to use environment variables.  A typical example of this approach, not applicable to the docker, is <code>DATABASE_URL</code> , adopted in the Rails framework or <code>NODE_ENV</code> adopted in the Nodejs framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so the environment variables allow the application inside the container to conveniently and easily find a database.  But for this, the person who writes the application should know about it.  And although the <a href="http://12factor.net/config">configuration of an application using environment variables is good and correct</a> , sometimes applications are written poorly, but they need to be run somehow. <br><a name="habracut"></a><br><h2>  Docker, environment variables and links </h2><br>  Docker comes to the rescue of us when we want to link two containers and gives us a Docker links mechanism.  You can read more about them in the <a href="https://docs.docker.com/userguide/dockerlinks/">manual on the Docker site itself</a> , but if in brief, it looks like this: <br><br><ol><li>  Give the name of the container at startup: <code>docker run -d --name db training/postgres</code> .  Now we can reference this container by the name of <code>db</code> . </li><li>  We start the second container, associating it with the first: <code>docker run -d -P --name web --link db:db training/webapp python app.py</code>  The most interesting in this line: <code>--link name:alias</code> .  <code>name</code> is the name of the container, <code>alias</code> is the name by which this container will be known to be launched. </li><li>  This will lead to two consequences: firstly, a set of environment variables pointing to the <code>db</code> container will appear in the <code>web</code> container, and secondly an alias <code>db</code> indicating the ip on which we launched the database container will appear in the <code>web</code> container's <code>/etc/hosts</code>  The set of environment variables that will be available in the <code>web</code> container is: </li></ol><br><br><pre> <code class="hljs javascript">DB_NAME=<span class="hljs-regexp"><span class="hljs-regexp">/web/</span></span>db DB_PORT=tcp:<span class="hljs-comment"><span class="hljs-comment">//172.17.0.5:5432 DB_PORT_5432_TCP=tcp://172.17.0.5:5432 DB_PORT_5432_TCP_PROTO=tcp DB_PORT_5432_TCP_PORT=5432 DB_PORT_5432_TCP_ADDR=172.17.0.5</span></span></code> </pre><br><br>  And if the application is desperately not ready to read such variables, then the console utility <code>socat</code> will come to the rescue. <br><br><h2>  socat </h2><br>  <code>socat</code> is a Unix utility for port forwarding.  The idea is that with its help we will create an impression inside the container that, for example, the database is running in the same container on the same host and on its standard port, as it does on the developer‚Äôs computer.  <code>socat</code> , like all low-level unix-like, is very lightweight and does not burden the main process of the container. <br><br>  Let's take a closer look at the environment variables that the link mechanism forwards into the container.  We are particularly interested in one of them: <code>DB_PORT_5432_TCP=tcp://172.17.0.5:5432</code> .  This variable contains all the data we need: the port to listen to on localhost (5432 in <code>DB_5432_TCP</code> ) and the coordinates of the database itself (172.17.0.5:5432). <br><br>  Such a variable will be thrown into the container for each transferred link: database, <code>Redis</code> , auxiliary service. <br><br>  We will write a script that will wrap any command as follows: scan the list of environment variables in search of the ones we are interested in, run socat for each, then run the transferred command and give control.  When the script ends, it must complete all socat processes. <br><br><h2>  Script </h2><br>  Standard header  <code>set -e</code> instructs the shell to terminate the script at the first error, that is, it requires the usual behavior of the programmer. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#!/bin/bash set -e</span></span></code> </pre><br>  Since we will generate additional socat processes, we will need to monitor them so that we can complete them later and wait for them to complete. <br><br><pre> <code class="hljs perl">store_pid() { pids=(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${pids[@]}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"$1"</span></span>) }</code> </pre><br>  Now we can write a function that will spawn child processes that we can memorize. <br><br><pre> <code class="hljs bash"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_command</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Running </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> bash -c <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> &amp; pid=<span class="hljs-string"><span class="hljs-string">"$!"</span></span> store_pid <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pid</span></span></span><span class="hljs-string">"</span></span> } <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_commands</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> cmd; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> start_command <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cmd</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> }</code> </pre><br>  The basis of the idea is to pull out tuples <code>(_,_,_)</code> from a set of environment variables ending in <code>_TCP</code> and turn them into a set of <code>socat</code> start commands. <br><br><pre> <code class="hljs tex">to_link_tuple() { sed 's/.*_PORT_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">[0-9]</span></span></span></span>*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>_TCP=tcp:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span></span>.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span></span>.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>/<span class="hljs-tag"><span class="hljs-tag">\</span></span>1,<span class="hljs-tag"><span class="hljs-tag">\</span></span>2,<span class="hljs-tag"><span class="hljs-tag">\</span></span>3/' } to_socat_call() { sed 's/<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span></span>.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span></span>.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(</span></span></span></span>.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">)</span></span></span></span>/socat -ls TCP4-LISTEN:<span class="hljs-tag"><span class="hljs-tag">\</span></span>1,fork,reuseaddr TCP4:<span class="hljs-tag"><span class="hljs-tag">\</span></span>2:<span class="hljs-tag"><span class="hljs-tag">\</span></span>3/' } env | grep '_TCP=' | to_link_tuple | sort | uniq | to_socat_call | start_commands</code> </pre><br>  <code>env</code> will print a list of environment variables, <code>grep</code> will leave only the necessary ones, <code>to_link_tuple</code> pull out the triples we need, <code>sort | uniq</code>  <code>sort | uniq</code> prevent the launch of two <code>socat</code> s for one service, <code>to_socat_call</code> will create the command we need. <br><br>  We also wanted to complete the <code>socat</code> child processes when the main process is complete.  We will do this by sending a <code>SIGTERM</code> signal. <br><br><pre> <code class="hljs bash"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onexit</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Exiting <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> sending SIGTERM to all processes <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> <span class="hljs-variable"><span class="hljs-variable">${pids[*]}</span></span> &amp;&gt;/dev/null } <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> onexit EXIT</code> </pre><br>  We start the main process with the <code>exec</code> command.  Then the control will be transferred to him, we will see his <code>STDOUT</code> and he will receive <code>STDIN</code> signals as well. <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> <span class="hljs-string"><span class="hljs-string">"$*"</span></span></code> </pre><br>  The whole script can be viewed in <a href="https://gist.github.com/dmitriy-kiriyenko/ee8f4061f4a43649f994">one piece</a> . <br><br><h2>  So what? </h2><br>  We put this script in a container, for example, in <code>/run/links.sh</code> and now start the container like this: <br><br><pre> <code class="hljs pgsql">$ docker run -d -P <span class="hljs-comment"><span class="hljs-comment">--name web --link db:db training/webapp /run/links.sh python app.py</span></span></code> </pre><br>  Voila!  In the container on <code>127.0.0.1</code> on port <code>5432</code> our post-res will be available. <br><br><h2>  Entrypoint </h2><br>  In order not to remember our script, the image can be set as an entry point <a href="https://docs.docker.com/reference/builder/">with the ENTRYPOINT directive in Dockerfile</a> .  This will lead to the fact that any command launched in such an image will first be prefixed with this entry point. <br><br>  Add to your <code>Dockerfile</code> : <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> ./links.sh /run/links.sh ENTRYPOINT ["/run/links.sh"]</code> </pre><br>  and again the container can be started simply by passing commands to it and to be sure that services from the associated containers will be visible to the application as if they were running on a local host. <br><br><h2>  And if there is no access to the image? </h2><br>  In connection with the above, there is an interesting problem: how to make the same convenient proxying services, if there is no access to the inside of the image?  Well, that is, they give us an image and swear that there is <code>socat</code> inside, but our script is not there and we cannot put it on.  But we can make the launching team arbitrarily difficult.  How do we get our wrapper inside? <br><br>  It comes to the aid of the possibility of forwarding a piece of the host file system inside the container.  In other words, we can do, for example, the <code>/usr/local/docker_bin</code> folder on the host file system, put <code>links.sh</code> there and run the container like this: <br><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ docker run -d -P </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--name web </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--link db:db training/webapp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-v /usr/local/docker_bin:/run:ro </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">/run/links.sh python app.py</span></span></code> </pre><br>  As a result, any scripts that we put in <code>/usr/local/docker_bin</code> will be available inside the container to run. <br><br>  Please note that we used the ro flag, which does not allow the container to write to the <code>/run</code> folder. <br><br>  An alternative would be to inherit from the image and just add the files there. <br><br><h2>  Total </h2><br>  With the help of <code>socat</code> and a kind word one can achieve a much more convenient way of communication between containers than with the help of a kind word alone. <br><br><h2>  Instead of an afterword </h2><br>  An attentive and sophisticated reader will probably notice that the <a href="https://github.com/progrium/ambassadord">ambassadord</a> library does the same thing in principle, and it already does.  And this reader will be absolutely right.  A user who just needs to get his system to earn will probably prefer to use a ready-made and proven solution, but Habr does not differ in the mass character of such users.  That is why this opus appeared, which, like a good joke, not only tells the obvious things, but also teaches. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/260053/">https://habr.com/ru/post/260053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260031/index.html">Windows and Mac OS Integration with Acronis Access Connect</a></li>
<li><a href="../260033/index.html">Is it true that Go is faster than Ruby?</a></li>
<li><a href="../260045/index.html">Material Design and Search by the example of a reference application</a></li>
<li><a href="../260047/index.html">Interesting notes on C # and CLR (v2.0)</a></li>
<li><a href="../260049/index.html">One of the features of PHP related to methods and functions</a></li>
<li><a href="../260061/index.html">Development of modular C / C ++ applications using annotations</a></li>
<li><a href="../260065/index.html">NGINX inside: born for performance and scaling</a></li>
<li><a href="../260067/index.html">Reactive User Interface Programming in Jancy</a></li>
<li><a href="../260069/index.html">Squires of microelectronics. Video report from the San Francisco Electronics Design Conference</a></li>
<li><a href="../260071/index.html">Charm Solitaire game defense study</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>