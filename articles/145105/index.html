<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Limit the number of requests - Raterlimiter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you fear that your web service may be ignored by careless users, or you just have a weak server, then you have already thought about limiting the n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Limit the number of requests - Raterlimiter</h1><div class="post__text post__text-html js-mediator-article">  If you fear that your web service may be ignored by careless users, or you just have a weak server, then you have already thought about limiting the number of requests from each user.  In a good way - this is only one of the necessary echelons of defense.  Of course, such a restriction will not save from a serious attack, but from the point of view of price / quality is quite suitable <br><br>  Recently, I began to actively engage in Erlang.  Well and, as usual, for fixing the material implemented a simple web service on <a href="https://github.com/mochi/mochiweb">Mochiweb</a> .  Mochiweb is quite a decent framework for creating web applications, but I did not find the ability to limit the number of requests from one client.  So did it yourself. <br><br>  Because  The functionality of limiting the speed of requests is completely self-contained and not tied to a specific task, I selected the module made in an independent application and decided to post its source code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Task </h5><br>  So, we have <a href="http://www.erlang.org/">Erlang / OTP</a> , Mochiweb, <a href="https://github.com/basho/rebar">rebar</a> .  I would like to count the number of requests from a particular user and give him 413 error code if the requests go too often.  The client is identified by its IP address.  Thereby, which gives <code><b>mochiweb_request:get(peer).</b></code> <br><br>  The task is not so difficult, but perhaps a ready-made solution will save someone time. <br><a name="habracut"></a><br><h5>  An approach </h5><br>  I decided to use the <a href="http://en.wikipedia.org/wiki/Token_bucket">token bucket</a> algorithm. <br>  If we describe it briefly - we consider certain time intervals for each client as baskets, in which we will add user requests for this time interval.  Baskets have a limited volume.  As soon as the basket is filled with requests to the limit, we stop serving the client.  Because  as time goes on, baskets for the customer are constantly changing, and the customer has a chance to be served in a new time interval. <br><br><img src="https://habrastorage.org/storage2/ddb/356/519/ddb356519393b8a96f9352ad4a2d4c32.png"><br>  In the picture above, red indicates the time when each of the customers was not served. <br>  As can be seen from the picture, Client A received a restriction of requests some time ago and did not send them anymore, Client B works quietly and does not exceed the limit, and client C has chosen the current limit of requests and receives refusals. <br><br>  We will create baskets as requests from the client appear and with due account of time.  Each client can have their own time scale, read the basket lifetime.  The volume of the basket, that is, the limit of requests, can be set for each client separately. <br><br>  Store information about customer baskets will be in the dictionary: <br>  <code><b>IP + ‚Ññ </b></code> as a key <br>  <code><b>counter</b></code> - actually the query counter <br><br>  The client API consists of a single <code>check_rate(IP, TimeScale, Limit)</code> function <code>check_rate(IP, TimeScale, Limit)</code> . <br>  Where <br>  <code><b>IP</b></code> is the client's ip address (however, it can be any identifier) <br>  <code><b>TimeScale</b></code> - Basket lifetime in ms. <br>  <code><b>Limit</b></code> - the maximum number of requests in the basket <br><br>  Calling this function increments the counter and returns to the client whether to service the request. <br><br><h5>  Implementation </h5><br>  For storing data, I use an ETS table of type <code>ordered_set</code> .  It is sorted by key and does not allow duplication of keys.  The table is a record <br><pre> <code class="erlang hljs">[BucketID, Counter, CreatedAt, ModifiedAt]</code> </pre><br>  Where <br>  <code><b>BucketID</b></code> - {IP, BucketNum}, is also the key for <code>ordered_set</code> <br>  <code><b>Counter</b></code> - the number of requests from the client <br>  <code><b>CreatedAt</b></code> - Basket creation time (in ms) <br>  <code><b>ModifiedAt</b></code> - Time to change the basket (in ms) <br>  Creation time is more for debugging, you can opt out <br><br>  Main function: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-spec</span></span> count_hit<span class="hljs-params"><span class="hljs-params">(Id::binary(), Scale::integer(), Limit::integer())</span></span> -&gt; {ok, continue} | {fail, Count::integer<span class="hljs-params"><span class="hljs-params">()</span></span>}. <span class="hljs-comment"><span class="hljs-comment">%% Counts request by ID and blocks it if rate limiter fires %% ID of the client %% Scale of time (1000 = new bucket every second, 60000 = bucket every minute) %% Limit - max size of bucket count_hit(Id, Scale, Limit) -&gt; Stamp = timestamp(), %% milliseconds since 00:00 GMT, January 1, 1970 BucketNumber = trunc(Stamp / Scale), %% with scale=1 bucket changes every millisecond Key = {BucketNumber, Id}, case ets:member(?RATERLIMITER_TABLE, Key) of false -&gt; ets:insert(?RATERLIMITER_TABLE, {Key, 1, Stamp, Stamp }), {ok, continue}; true -&gt; % increment counter by 1, created_time by 0, and changed_time by current one Counters = ets:update_counter(?RATERLIMITER_TABLE, Key, [{2,1},{3,0},{4,1,0, Stamp}]), % Counter, created at, changed at [BucketSize, _, _] = Counters, if (BucketSize &gt; Limit) -&gt; {fail, Limit}; true -&gt; {ok, continue} end end.</span></span></code> </pre><br><br>  First, we check if the basket we need is {IP, BucketNumber}. <br>  In the case of a new basket, everything is pretty trite - we create a new basket with initial values ‚Äã‚Äãand say OK. <br><br>  Adding a counter to an existing basket is a little more interesting.  The <a href="http://www.erlang.org/doc/man/ets.html">ets</a> module allows <a href="http://www.erlang.org/doc/man/ets.html">you</a> to <a href="http://www.erlang.org/doc/man/ets.html">modify the counters</a> according to the specified rules.  I liked how gracefully you can combine the increment of a counter with a change in the date of the last access. <br><br>  So the code: <br><pre> <code class="erlang hljs"> Counters = ets:update_counter(?RATERLIMITER_TABLE, Key, [{<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>},{<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>},{<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, Stamp}])</code> </pre><br><br>  increments the counter # 2 by 1 (this is just the hit counter), adds 0 to the creation time, adds 1 to counter # 4 with the maximum value checked.  Because  the maximum value is indicated as 0, the fourth counter is always set to Stamp (current time).  At the output we get a list of all the variable counters in order, i.e. <br><br> <code>[Counter, CreatedTime, ChangedTime]</code> <br> <br>  As a result, in two appeals to the tables, we updated or created a basket and received the number of hits.  In the current implementation of the <i>raterlimiter, the</i> atomicity of changing tables is not critical, it just works synchronously (calling <a href="http://www.erlang.org/doc/man/gen_server.html">gen_server: call / 2 is</a> synchronous). <br><br><h6>  Removing old baskets </h6><br>  Over time, the customer baskets are piling up and piling up.  It is necessary to remove them. <br><br>  Deletion occurs periodically.  Simply remove all baskets older than the specified limit. <br><br>  I must say, on the Erlang everything looks nice and brief - <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_old_limiters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Timeout)</span></span></span><span class="hljs-function"> -&gt;</span></span> NowStamp = timestamp(), Matcher = ets:fun2ms(<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> ({_,_,_,Accessed}) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Accessed &lt; (NowStamp - Timeout) -&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>), ets:select_delete(?RATERLIMITER_TABLE, Matcher).</code> </pre><br><br>  <a href="http://www.erlang.org/doc/man/ets.html">ets: select_delete</a> deletes all entries matching the matching functions ( <b>MatchSpec</b> ).  Writing these match_spec manually is hell.  It is much easier to use the <i>ets: fun2ms function</i> , which converts the normal Erlang function into a matching function.  For example, the above function <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({_,_,_,Accessed})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">when</span></span></span><span class="hljs-function"> A</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ccessed</span></span></span><span class="hljs-function"> &lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NowStamp - Timeout)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  in the final form in the MatchSpec format, for NowStamp = 1000, Timeout = 0 looks like <br><br><pre> <code class="erlang hljs">[{{'_','_','_','$<span class="hljs-number"><span class="hljs-number">1</span></span>'},[{'&lt;','$<span class="hljs-number"><span class="hljs-number">1</span></span>',{'-',<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}}],[true]}]</code> </pre><br><br>  The main <i>thing</i> when using <i>ets: fun2ms</i> do not forget to include an additional file in the source file - <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-include_lib</span></span><span class="hljs-params"><span class="hljs-params">(</span><span class="hljs-string"><span class="hljs-params"><span class="hljs-string">"stdlib/include/ms_transform.hrl"</span></span></span><span class="hljs-params">)</span></span>.</code> </pre><br><br><h5>  Using </h5><br>  The use boils down to a single check_rate call, not counting, of course, the code and settings for running the raterlimiter application itself.  Here is an example from my Mochiweb-based application: <br><br><pre> <code class="erlang hljs"> {Status, _Reason} = raterlimiter:check_rate(Req:get(peer), <span class="hljs-number"><span class="hljs-number">30000</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), <span class="hljs-comment"><span class="hljs-comment">% 500 requests per 30 seconds allowed case Status of ok -&gt; serve_request(Req, DocRoot, Path); _ -&gt; % client wants too much information Req:respond({413,[{"Content-Type", "text/html"}, {"Retry-After", "900 (Too many requests)"}], "  IP   ,  15 ."}) end</span></span></code> </pre><br><br>  Full code is available on <a href="https://github.com/Gromina/raterlimiter">Github</a> .  There you can also report errors, or make a pull request. </div><p>Source: <a href="https://habr.com/ru/post/145105/">https://habr.com/ru/post/145105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145099/index.html">We try Smart Response on the tooth</a></li>
<li><a href="../145100/index.html">OpenStack Outlook: Red Hat vs VMware</a></li>
<li><a href="../145101/index.html">A catalog of thousands of 3D models in the browser using WebGL</a></li>
<li><a href="../145102/index.html">Do you change tools for yourself or prefer what is given by default?</a></li>
<li><a href="../145103/index.html">Release of new OS - release of new certifications and exams</a></li>
<li><a href="../145108/index.html">Another ActiveRecord implementation on Objective-C</a></li>
<li><a href="../145109/index.html">The next-generation Xbox and PS will still be equipped with optical drives.</a></li>
<li><a href="../145111/index.html">ASUS decided to hold off on the shredded</a></li>
<li><a href="../145112/index.html">Again the accident in the cloud Selectel ... How long?</a></li>
<li><a href="../145113/index.html">Hexy - prefab robot based on Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>