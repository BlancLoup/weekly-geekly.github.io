<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video surveillance from idea to ... idea</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have a main job, there are friends who always want to "start a new business." They have their own, but always want to expand. And every time they wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video surveillance from idea to ... idea</h1><div class="post__text post__text-html js-mediator-article">  I have a main job, there are friends who always want to "start a new business."  They have their own, but always want to expand.  And every time they want it, they come to me for advice.  The idea lies on the surface.  "We are engaged in the Internet, and let's do something else on our topic."  So we began to engage in telephony, the sale of network equipment, hosting, kolokeyshinom.  Problem statement always pleased me.  "Let's do telephony," "Let's do hosting."  Well, the last thing was "Let's do video surveillance." <br>  Here "Let's do video surveillance" this was the cherished TK. <br>  What came out of it and experience I will describe in this article. <br><a name="habracut"></a><br>  It so happened historically that I work in organizations where I am surrounded by salespeople, and I <s>am a</s> technical specialist, <s>Dartanyan</s> , as it turned out (over time) with a broad profile. <br>  During my professional career I built not one service-technical department, but I did not reach the level of educated (programmers) people.  By this, I am always in sight, all questions on IT to me.  I have been advising them (acquaintances) for many years in the field of IT, being a systems and business analyst who is free :).  Now to the topic. <br><br>  One day people came to me and said, "we want video surveillance."  I was busy and there was no desire to develop in this direction; then, even without this, there was enough care.  They found another ‚Äúspecialist‚Äù, worked for 6 months, it ended with nothing.  The man turned out to be ‚Äúbeautiful‚Äù, he sang about POWER of zoneminder and motion, then everything will be cloudy.  For 6 months, not a single solution, not a single client. <br>  They are tired, they came to me.  Since I have been working with them for about 10 years, then why not take part in the adventure again.  The offer, as always, was captivating with its originality and novelty: <br>  - We want to do cloud surveillance.  Investment 0, buy equipment, for the development of 0, divide 50/50 money. <br>  By the way, it was always like this, and money was always 50/50, or 30/30/30, depending on the number of people involved. <br>  ‚ÄúWhy not,‚Äù I thought.  Experience will not be superfluous.  (although I am confused by this experience, if you are a generalist and change this profile once a year :) <br><br><h2>  The idea is voiced: "I want cloud video surveillance." </h2><br>  People who want to sell something, they will always be selling something. <br>  It remains to come up with this "Something" and arrange. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Cloud.  0 money, the load is large.  So you need to come up with a prototype that will solve these problems. <br>  At first glance fell on Openstack.  You can expand computing power on the fly, but it takes several machines to start.  Having played with different versions of Openstack, I had to find a more suitable solution.  Glance fell on Proxmox. <br>  A wonderful solution that fit our needs at the start.  And always those VMs can be ported to hardware or another cloud. <br>  I did not have time to take part in the purchase of iron, before my appearance the workhorse was acquired: Intel Core i5-3570K @ 3.40GHz <br>  And here on this gland it was necessary to be engaged in cloudy video surveillance.  Absurd situation :) But we do not give up. <br>  It comes up, some kind of sales system.  Video surveillance coupled with security systems and all sorts of alerts with a tie to the chopy (there is an exit at the state level). <br>  This is stuck in the future <br>  1) permanent video recording <br>  2) motion recording <br>  3) timelapse recording <br>  4) SMS notification <br>  5) a call from the security center for motion detection.  The operator checks the record, calls the chop, notifies the client. <br>  PSC market in Moscow will expand from year to year.  <s>Mi</s> Police every year reduces the amount of security business.  So all this is gradually creeping on private traders. <br><br>  The overall system looked like this: <br><br><img src="https://habrastorage.org/files/0dd/a6e/47d/0dda6e47d35042ccb8c7d5873b55d59f.png" alt="image"><br><br>  Cameras come on any piece of hardware, it can be tied to security.  This piece of hardware can be either a software client or an OpenWrt hardware solution.  RPC is not just drawn.  The idea was to create 2 modules.  The first is completely console.  This would allow it to be implanted into iron, the second graphic module that controls the console.  This would allow to control a piece of iron from any place.  From the user's computer, from the support computer, etc.  Also, the first module is needed to standardize streams and freeze frames from cameras.  Such glands we already run in.  For the prototype fit, the experience was.  No one forbade the logic of this piece of iron to be transferred to us on the server. <br><br>  Now there are dances with a tambourine about how to drive the h264 zoo to disk, and attach detectors and similar crap to the web +, and fit it all into one i5. <br>  ZoneMinder can be a good system, but after adding 4 cameras, it loaded all 4 cores of the system by more than 70%.  From him immediately abandoned. <br><br>  For the prototype took VLC.  It has been developed for a long time, run in by many, we used it many times for some projects. <br>  There are at least 2 tasks to solve. <br>  1) issue to the network <br>  2) record stream <br><br>  The zoo of cameras consists of rtsp and http streams.  VLC can do everything.  We decided to use the VLM.  Has control over tlenet and http. <br>  The input feed is fed into the output. <br> <code>"#{$transcode}std{access=http{mime={$this-&gt;mime}},mux=ts{use-key-frames},dst=*:{$this-&gt;getPort()}/{$this-&gt;path}}";</code> <br>  We get HTTP stream from any incoming url. <br>  HTTP is convenient to us than?  You can drive in hginx, distribute the load, encrypt.  send to https. <br>  1 client - 1 vlc process. <br>  They decided to script the prototype in PHP, since the developer is one, time is short, funding 0. <br>  Startup Team.  (I will give the ready code, it is not difficult to get a command out of it if necessary) <br><pre> <code class="php hljs">$vlc_ifs = <span class="hljs-string"><span class="hljs-string">"-I http --http-host=0.0.0.0 --http-port {$this-&gt;getHttpPort()} -I telnet --telnet-port {$this-&gt;getTelnetPort()} --telnet-password "</span></span>.TLPWD; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(VLC_USE_LOG) $vlc_logs = <span class="hljs-string"><span class="hljs-string">"--extraintf=http:logger --file-logging --log-verbose 0 --logfile {$this-&gt;getLogFile()}"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $vlc_logs = <span class="hljs-string"><span class="hljs-string">'--extraintf=http'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//$vlc_shell = VLCBIN." --rtsp-tcp --ffmpeg-hw --http-reconnect --http-continuous --sout-keep ".VLCD." $vlc_ifs --repeat --loop --network-caching ".VLCNETCACHE." --sout-mux-caching ".VLCSOUTCACHE." $vlc_vlm --pidfile {$this-&gt;getPidFile()} $vlc_logs \n"; $vlc_shell = VLCBIN." --rtsp-tcp ".VLCD." $vlc_ifs --repeat --loop --live-caching ".VLC_LIVE_CACHE." --network-caching ".VLCNETCACHE." --sout-mux-caching ".VLCSOUTCACHE." --sout-ts-dts-delay 400 $vlc_vlm --pidfile {$this-&gt;getPidFile()} $vlc_logs "; if($this-&gt;isValgrind()){ $vlc_shell = "valgrind -v --trace-children=yes --log-file={$this-&gt;getValgrindFile()} --error-limit=no --leak-check=full $vlc_shell"; }</span></span></code> </pre><br><br>  Since we already have a live stream, we can write from it. <br> <code>return "#std{access=file{append},mux=ts{use-key-frames},dst=$filePath.avi}";</code> <br> <br>  VLM is created simply <br>  3 streams can be created on the camera <br>  1) live stream <br>  2) rec stream <br>  3) motion stream <br> <code>$this-&gt;execute("new {$this-&gt;cam} broadcast enabled loop");</code> <br>  after you can play, stop doing <br> <code>$command = "control {$this-&gt;cam} $command";</code> <br>  for rec it is enough, for example, to stop every 10 seconds, change $ filePath, do play <br>  We get a set of files with records.  For motion play and stop. <br>  VLC can also be run both "at us" and "at them". <br>  Motion question. <br>  There is a motion tool.  He computes motion by Jpeg.  Cameras give a shotframe in Jpeg.  We take a freeze frame, we feed in motion, at the output we get what we need. <br><br>  We have a zoo, we need to make a system out of it. <br>  So we do.  We call everything System and try to make a loosely coupled system so that in future we can replace the elements of the system without losses. <br>  We have cameras, Vlc, Motion, recording to disk, online broadcasting. <br><br>  Vlc and motion are unix processes.  Let's call them demons.  (abstract class Daemon) <br>  It turns out that we need 2 streams from the camera.  jpeg and h264. <br>  In the system we create entities <br>  user-dvr-cam-stream <br>  user - user <br>  dvr system that is responsible for daemons and cameras associated with demons <br>  cam - camera entities, stores physical camera settings and virtual streams <br>  stream - any abstract stream. <br><br>  Straem can be started, stopped, disengaged, ‚Äúpulled‚Äù at the time of the ‚Äúupdate‚Äù of the system, for these events he himself decides what to do. <br><br>  We get the System-common entity, which consists only of abstract declarations. <br><br><div class="spoiler">  <b class="spoiler_title">We receive the general factory of construction of system.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $instance = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $commands; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> AbstractFactory */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$instance; } <span class="hljs-comment"><span class="hljs-comment">/** * permanentCommand * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ICommand $command */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPermanentCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ICommand $command)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commands[] = $command; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ISystem $system */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addCommands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ISystem $system)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commands <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $command) $system-&gt;addPermanentCommand($command); } <span class="hljs-comment"><span class="hljs-comment">//todo buildSystem method /** * @return ISystem */ public function createSystem(){ return System::getInstance(); } /** * @return array of Users */ public function createUsers(){ return array(AbstractFactory::getInstance()-&gt;createUser(1)); } /** * @param int $id * @return IUser */ public function createUser($id) { return new User($id); } /** * @param IUser $user * @return IDVR */ public function createDvr(IUser $user) { $dvr = new Dvr($user); $cams = $this-&gt;createCams($dvr); //new+add foreach($cams as $cam){ /** @var $cam Cam */ $dvr-&gt;addCam($cam); } $daemons = $this-&gt;createDaemons($dvr); foreach($daemons as $daemon){ /** @var $daemon Daemon */ $dvr-&gt;addDaemon($daemon); } return $dvr; } /** * @param DVR $dvr * @return array of Cams */ abstract protected function createCams(DVR $dvr); /** * @param DVR $dvr * @return array of Daemons */ abstract protected function createDaemons(DVR $dvr); /** * @param IDVR $dvr * @param ICamSettings $cs * @return ICam */ public function createCam(IDVR $dvr, ICamSettings $cs) { return new Cam($dvr, $cs); } /** * @param $from * @param $to * @return MoveToNfsCommand */ public function createMoveToNfsCommand($from, $to){ return new MoveToNfsCommand($from, $to); } /** * @param ICam $cam * @return ICamStream */ abstract public function createStream(ICam $cam); }</span></span></code> </pre><br></div></div><br><br>  This allows us to hang on the camera absolutely any streams and do with them what comes to our mind.  And allows at least somehow control our zoo.  (he is a prototype) <br><br>  Since our workhorse is VLC, it begins to customize VLC for our system. <br>  Create an abstract class VlcStream extends Stream, class LiveVlcStream extends VlcStream. <br>  VlcStream is ‚Äúfriendly‚Äù with Vlm ($ this-&gt; vlm = new HttpVlm ($ this-&gt; getVlcName (), 'localhost', HTSTART + $ this-&gt; cam-&gt; getDVR () -&gt; getID ());) <br>  And allows you to handle start, stop <br>  Further <br>  abstract class VlcReStream extends VlcStream <br>  VlcReStream - LiveVlcStream takes as input <br>  class RecVlcStream extends VlcReStream - records, ‚Äúmoves‚Äù video from Ram to Nfs <br><br>  And the class Vlc extends Daemon is created, it will be contained in the DVR entity. <br><br>  DVR processes start and stop <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;log(<span class="hljs-keyword"><span class="hljs-keyword">__FUNCTION__</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;startDaemons(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;startCams(); }</code> </pre><br>  Starting the camera starts all stream related to the camera. <br>  Those.  We run unix processes Vlc, motion, do VLM via HTTP. <br>  The stop occurs in the reverse order. <br>  Instead of VLC, you can use any thing you like. <br><br>  But we have video surveillance in the cloud.  Means Sql and similar data storage systems are necessary. <br>  The working system turned out like this: <br><br><div class="spoiler">  <b class="spoiler_title">Factory</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Created by PhpStorm. * User: calc * Date: 16.06.14 * Time: 10:56 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">system2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Class BBFactory * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@package</span></span></span><span class="hljs-comment"> system2 */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BBFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ISystem */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $system = <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::createSystem(); $e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBLogMotionEvent(Motion::EVENT_MOTION_START); $system-&gt;addEventHandler($e); $e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBLogMotionEvent(Motion::EVENT_MOTION_STOP); $system-&gt;addEventHandler($e); $e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBLogMotionEvent(Motion::EVENT_MOTION_DETECTED); $system-&gt;addEventHandler($e); $e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBLogMotionEvent(Motion::EVENT_CAMERA_LOSS); $system-&gt;addEventHandler($e); $recMotionEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBRecMotionEvent(Motion::EVENT_MOTION_START); $system-&gt;addEventHandler($recMotionEvent); $recMotionEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BBRecMotionEvent(Motion::EVENT_MOTION_STOP); $system-&gt;addEventHandler($recMotionEvent); <span class="hljs-comment"><span class="hljs-comment">//   30    update //$system-&gt;addPermanentCommand(new RotateRecCommand()); $this-&gt;addPermanentCommand(new RotateRecCommand()); $this-&gt;addCommands($system); return $system; } /** * @param DVR $dvr * @return array of Daemons */ protected function createDaemons(DVR $dvr) { $vlc = new Vlc($dvr); $this-&gt;addPermanentCommand(new BBDaemonWatchdog($vlc)); //     ,    mtn $cams = $dvr-&gt;getCamIDs(); $ids = array(); foreach($cams as $id){ $cam = $dvr-&gt;getCam($id); $cs = $cam-&gt;getSettings(); /** @var $cs BBCamSettings */ if($cs-&gt;mtn) $ids[] = $id; } $motion = new Motion($dvr, $ids); if(count($cams)) $this-&gt;addPermanentCommand(new BBDaemonWatchdog($motion)); return array($vlc, $motion); } /** * @return array */ public function createUsers() { $users = array(); $db = \Database::getInstance(); $q = "select id from users where banned=0"; $r = $db-&gt;query($q); while(($row = $r-&gt;fetch_row())){ try{ $users[] = AbstractFactory::getInstance()-&gt;createUser($row[0]); } catch(\Exception $e){ Log::getInstance()-&gt;put($e-&gt;getCode().' '.$e-&gt;getMessage()."\n".$e-&gt;getTraceAsString()."\n", __CLASS__, Log::ERROR); } } return $users; } /** * @param DVR $dvr * @return array */ protected function createCams(DVR $dvr){ $db = \Database::getInstance(); $q = mysql::getQuery(mysql::CAM_SETTINGS, array('{dvr_id}' =&gt; $dvr-&gt;getID())); $r = $db-&gt;query($q); $cams = array(); while(($row = $r-&gt;fetch_object('system2\BBCamSettings')) != null){ /** @var BBCamSettings $row */ //$dvr-&gt;addCam(new BBCam($this, $row)); $cam = $this-&gt;createCam($dvr, $row); $cams[] = $cam; //    Motion     ,    $timelapse = new BBArchiveTimelapseCommand($cam); $this-&gt;addPermanentCommand($timelapse); } return $cams; } /** * @param ICam $cam * @return ICamStream */ public function createStream(ICam $cam) { $stream = new Streams($cam); $cs = $cam-&gt;getSettings(); /** @var $cs BBCamSettings */ $motion = new MotionStream($cam, $cs); $motion-&gt;setEnabled($cs-&gt;live &amp;&amp; $cs-&gt;mtn); $stream-&gt;addStream($motion); $live = new BBLiveStream($cam); $live-&gt;setTestInputCommand(new BBTestInputFailSaveCommand($cam, $live)); $live-&gt;setEnabled($cs-&gt;live); $stream-&gt;addStream($live); $hls = new HLSVlcStream($cam, $live); $hls-&gt;setEnabled($cs-&gt;live); $stream-&gt;addStream($hls); //$this-&gt;streams[] = new FlvVlcReStream($this, $live); //nginx rtmp stream //$this-&gt;streams[] = new RtmpVlcReStream($this, $live); $rec = new BBRecStream($cam, $live); $rec-&gt;setEnabled($cs-&gt;live &amp;&amp; $cs-&gt;rec); $rec-&gt;setTestInputCommand(new BBTestInputFailSaveCommand($cam, $rec)); $stream-&gt;addStream($rec); $mtn = new BBRecStream($cam, $live, TIME_LOCK_RECORD, Path::MOTION); $mtn-&gt;setEnabled($cs-&gt;live &amp;&amp; $cs-&gt;mtn &amp;&amp; BBRecMotionEvent::isMotion($cam)); $mtn-&gt;setTestInputCommand(new BBTestInputFailSaveCommand($cam, $mtn)); $stream-&gt;addStream($mtn, Path::MOTION); //motion flv stream $flv = new UrlFlvVlcStream($cam, "http://localhost:".(MOTION_STREAM_PORT + $cam-&gt;getID())); $flv-&gt;setEnabled($cs-&gt;live); $stream-&gt;addStream($flv); return $stream; } }</span></span></code> </pre><br></div></div><br><br>  createSystem, add events of interest to us.  The System class is responsible for their processing. <br>  EVENT_MOTION_START, EVENT_MOTION_STOP, EVENT_MOTION_DETECTED, EVENT_CAMERA_LOSS <br>  this is just what is called from the moton config <br><div class="spoiler">  <b class="spoiler_title">thread</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Command to be executed when an event starts. (default: none) # An event starts at first motion detected after a period of no motion defined by event_gap on_event_start php ~/dvr/bin/system2/main.php event {user_id} {cam_id} motion_start 0 "%Y-%m-%d %T" # Command to be executed when an event ends after a period of no motion # (default: none). The period of no motion is defined by option event_gap. on_event_end php ~/dvr/bin/system2/main.php event {user_id} {cam_id} motion_stop 0 "%Y-%m-%d %T" # Command to be executed when a picture (.ppm|.jpg) is saved (default: none) # To give the filename as an argument to a command append it with %f ; on_picture_save value # Command to be executed when a motion frame is detected (default: none) ; on_motion_detected php ~/dvr/bin/system2/main.php event {user_id} {cam_id} motion_detected 0 "%Y-%m-%d %T" # Command to be executed when motion in a predefined area is detected # Check option 'area_detect'. (default: none) ; on_area_detected value # Command to be executed when a movie file (.mpg|.avi) is created. (default: none) # To give the filename as an argument to a command append it with %f ; on_movie_start value # Command to be executed when a movie file (.mpg|.avi) is closed. (default: none) # To give the filename as an argument to a command append it with %f ; on_movie_end value # Command to be executed when a camera can't be opened or if it is lost # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">NOTE:</span></span></span><span class="hljs-comment"> There is situations when motion don't detect a lost camera! # It depends on the driver, some drivers dosn't detect a lost camera at all # Some hangs the motion thread. Some even hangs the PC! (default: none) on_camera_lost php ~/dvr/bin/system2/main.php event {user_id} {cam_id} motion_camera_lost 0 "%Y-%m-%d %T"</span></span></code> </pre><br></div></div><br>  there is a call to main.php event uid cid event_name parameters <br>  The system class handles this. <br>  By cron, once every 10 minutes (every time any amount of mine), System-update is called. <br>  By update, update of all subsystems is performed and <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;executeCommands(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;executePermanentCommands();</code> </pre><br>  Commands are what the sub-systems need, and permanent commands, such as RotateRecCommand, are responsible for deleting old entries. <br><br>  When creating demons, an addition is being made, for example, BBDaemonWatchdog, it monitors whether the demon has fallen. <br><br>  Users are already created from the database. <br>  Then the camera from the database.  A permanent command is added to create a time-lapse.  Which, in turn, works only once in TIME_LOCK_TIMELAPSE (8 hours) and puts information into Mysql <br><br>  The last is the most interesting, it is streams. <br>  creates a stream of motion, live, hls (HTTP Live Stream), rec, mtn, flv. <br>  live - usual http <br>  rec, mtn - streams for recording <br>  hls and flv for browser output. <br><br>  Github: <a href="https://github.com/Calc86/dvr/tree/master/bin/system2">github.com/Calc86/dvr/tree/master/bin/system2</a> <br><br>  The logic is there.  Need a "physics". <br>  There are many cameras, many streams, one processor. <br>  The entire entry is made in ramdisk, hls in ramdisk, the vlc setting goes this way so that there is no transcoding.  The net flow was taken away, the net flow was saved.  Moving from ram disk to storage (in the prototype was NFS) went through ffmpeg codec copy <br>  This allowed to display in the browser through html5 records. <br>  3 types of records.  Full recording with cutting every 10 minutes, recording on the movement and timelaps recording for 8 hours, where per second is displayed 3 minutes. <br><br>  The construction of the system was planned by the independent placement of the DVR (recording machines), even geographically with minimal code changes. <br><br>  What was implemented <br>  1) all records we want <br>  2) output to the web, hls, flash, records in html5, because of the zoo h264 live codecs in h264 until you went to the web, output to mjpeg (allows you to look at old online video) <br>  3) the web interface of this terrible thing with https, nginx security url and the like. <br>  We stopped on adding cameras via Onvif <br><br>  Why the project has stalled. <br>  1) poor sales (lack of sales and sales system) <br>  2) lack of funding (at least a admin is needed for such a system) <br>  3) lack of free time <br>  4) completely free development <br>  5) no desire to purchase cameras for the test <br>  6) there was no desire to put free cameras on the test, although there was an agreement with the district council. <br>  7) I change my permanent job.  It will not be possible to do this. <br>  8) Purchase of design and purchase of sliced, but in the future, cut on their own. <br>  9) The absence of a person who would constantly monitor the system (found bugs in both motion and vlc, but they are solved by administering the system) <br>  10) Salesmen for the year did not come up with a single system of sales and pricing. <br>  11) I did a lot of things in parallel with the main work, the creation of video surveillance and personal life. <br>  12) Everyone scored a bolt on their agreed duties :) <br><br>  But we had 3 clients, they liked it.  They did not take money for the system, they took money only for the work on installing cameras. <br><br>  What it looked like :) <br><img src="https://habrastorage.org/files/259/652/7fa/2596527faa6a4d8e8c7022ea1375529b.png" alt="image"><br><br>  If the topic goes, I will describe in more detail about VLC and pitfalls.  And about the "mythical" piece of iron and experiments with it too. </div><p>Source: <a href="https://habr.com/ru/post/234139/">https://habr.com/ru/post/234139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234123/index.html">How does attracting money to a startup on Visistarte</a></li>
<li><a href="../234125/index.html">mysqlnd - explorer between PHP and MySQL</a></li>
<li><a href="../234127/index.html">Will 2014 be "the year of VoLTE"?</a></li>
<li><a href="../234131/index.html">Unity Android - now on x86!</a></li>
<li><a href="../234133/index.html">ROM for 1 kilobyte of Minecraft blocks</a></li>
<li><a href="../234141/index.html">The reverse side of the coin or what the CCIE laboratory exam looks like from the other side</a></li>
<li><a href="../234145/index.html">Apple: "value monopolist" in the smartphone market</a></li>
<li><a href="../234147/index.html">The authorities of the state of Delaware legalize the inheritance of accounts in social networks</a></li>
<li><a href="../234149/index.html">Banks vs Exchange: where it is more profitable to buy currency</a></li>
<li><a href="../234151/index.html">Live conference ‚ÄúInternet Marketing. Summer practice MegaIndex ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>