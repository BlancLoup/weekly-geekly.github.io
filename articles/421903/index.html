<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TiKV - distributed key-value database for cloud native</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On August 28, CNCF (Cloud Native Computing Foundation), behind Kubernetes, Prometheus and other open source projects for modern cloud applications, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TiKV - distributed key-value database for cloud native</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/no/aw/mm/noawmmgrfclc2rftv_zq8lavrsi.png"><br><br>  On August 28, CNCF (Cloud Native Computing Foundation), behind Kubernetes, Prometheus and other open source projects for modern cloud applications, <a href="https://www.cncf.io/blog/2018/08/28/cncf-to-host-tikv-in-the-sandbox/">announced</a> the adoption of a new product in its sandbox - <a href="https://github.com/tikv/tikv"><b>TiKV</b></a> . <br><br>  This distributed, key-value transactional database was born as an addition to <a href="https://github.com/pingcap/tidb"><b>TiDB</b></a> ‚Äî a distributed DBMS that offers OLTP and OLAP capabilities and ensures compatibility with the MySQL protocol ... But let's get everything in order. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  TiDB as a parent </h2><br>  Let's start with the "parent" project TiDB, created by the Chinese company PingCAP Inc. <br><br><img src="https://habrastorage.org/webt/ct/kt/zj/ctktzjb_kawxczxe1_4a-5tmupk.png"><br><br>  The first major public release of this DBMS, 1.0, <a href="https://www.nixp.ru/news/14205.html">took place</a> less than a year ago.  Its main features are ‚Äúhybridity‚Äù, combining transactional and analytical data processing (Hybrid Transactional / Analytical Processing, HTAP), as well as the already mentioned compatibility with the MySQL protocol.  A fuller picture of TiDB arises at the mention of others ‚Äî already common for new DBMS features such as horizontal scalability, high availability, and strict ACID compliance. <br><br>  The overall architecture of TiDB is as follows: <br><br><img src="https://habrastorage.org/webt/op/16/gg/op16ggedblv2hjzil0yz9t8qtpg.png"><br><br>  Since TiDB offers NoSQL scalability and ACID guarantees, it is categorized as <b>NewSQL</b> .  The authors do not hide the fact that they created the product under inspiration from other representatives of NewSQL: <a href="https://en.wikipedia.org/wiki/Spanner_(database)">Google Spanner</a> and <a href="https://ai.google/research/pubs/pub38125">F1</a> .  However, Chinese developers insisted on "their best practices and solutions when choosing technologies."  In particular, they chose an algorithm for solving the consensus problems of <a href="https://raft.github.io/"><b>Raft</b></a> (instead of <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science)">Paxos</a> , which is used in Spanner), the <a href="https://rocksdb.org/"><b>RocksDB</b></a> repository (instead of the distributed file system), and Go (and Rust) as the programming language. <br><br>  Many details about the TiDB device can be found in the ‚Äú <a href="https://pingcap.com/blog/2016-10-17-how-we-build-tidb/">How we build TiDB</a> ‚Äù <a href="https://pingcap.com/blog/2016-10-17-how-we-build-tidb/">report</a> from the co-founder and CEO of PingCAP, Max Liu, and we will return to some of them closely related to TiKV.  TiDB source code is <a href="https://github.com/pingcap/tidb">distributed</a> under the free Apache License v2.  Its <a href="">major users</a> include Lenovo, Meizu, Bank of Beijing, Industrial and Commercial Bank of China, and others. <br><br>  What is TiKV and what role does it play in the world of TiDB (and not only)? <br><br><h2>  Architecture and features of TiKV </h2><br>  Let us return to the general architecture of TiDB, in its slightly different representation: <br><br><img src="https://habrastorage.org/webt/9f/ot/kn/9fotknwzhc0e6pruh8cpjjoeywy.png"><br><br>  You can see that TiDB itself provides SQL implementation and compatibility with MySQL *, and entrusts the rest of the work to the TiKV cluster.  What is this ‚Äúother work‚Äù?  Here is a more detailed diagram: <br><br><img src="https://habrastorage.org/webt/no/rl/ps/norlpsjgogayj6gdazt7iku22-a.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">* In two pictures about the MySQL compatibility layer in TiDB.</b> <div class="spoiler_text">  The conversion of tables to key-value happens in such a way that from queries: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"huang@pingcap.com"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tom"</span></span>, <span class="hljs-string"><span class="hljs-string">"tom@pingcap.com"</span></span>);</code> </pre> <br>  ... are obtained: <br><br><img src="https://habrastorage.org/webt/dv/fy/3e/dvfy3encuh2vcdxrgaohxi6odlm.png"><br><br>  Indices in TiDB are ordinary pairs, the values ‚Äã‚Äãof which indicate a data line: <br><br><img src="https://habrastorage.org/webt/wb/tm/0e/wbtm0eiaaxopiluq5kcdn_ylvbw.png"><br></div></div><br>  Explanation of the scheme TiKV: <br><br><ul><li>  <b>KV API</b> - a set of software interfaces for writing / reading data; </li><li>  <b>Coprocessor</b> - a coprocessor framework to support distributed computing (compares with that of HBase); </li><li>  <b>Transaction</b> is a transactional model similar to <a href="https://ai.google/research/pubs/pub36726">Google Percolator</a> (commits protocol in 2 phases; uses timestamp allocator; see also <a href="https://blog.yugabyte.com/implementing-distributed-transactions-the-google-way-percolator-vs-spanner/">comparison with Spanner</a> ); </li><li>  <b>MVCC</b> (MultiVersion Concurrency Control) to provide reads without locks and ACID transactions (data is tagged by versions; any changes made in the current transaction are not visible to other transactions until the time of the commit); </li><li>  <b>Raft KV</b> - the already mentioned Raft algorithm used for horizontal scaling and data consistency;  its implementation in the Rust language is ported from etcd (tested by extensive exploitation);  by the way, the authors of TiKV declared ‚Äúsimple scalability up to 100+ TB of data‚Äù; </li><li>  <b>RocksDB</b> - local storage of key-value type, which has also already proven itself in large-scale projects in production (Facebook); </li><li>  <b>Placement Driver</b> is the ‚Äúbrain‚Äù of the cluster, created according to the concept from Google Spanner and responsible for storing the metadata about the regions, maintaining the necessary number of replicas, and evenly distributing the loads (using Raft). </li></ul><br><img src="https://habrastorage.org/webt/vo/8e/ga/vo8egadfoxvabhuhjma8r6emfhq.jpeg"><br><br>  If you summarize the relationship of the main components, you get the following: <br><br><ul><li>  Each <b>node of the</b> TiKV cluster has one or more <b>repositories</b> (RocksDB). </li><li>  Each repository has many <b>regions</b> . </li><li>  The region is the ‚Äúbase unit of movement of key-value data‚Äù, replicated (using Raft) to multiple nodes.  Such replica sets form <b>the Raft group</b> . </li><li>  Finally, the Manager of this cluster Placement Driver, as you can see, is itself a cluster. </li></ul><br><h2>  Install and Test TiKV </h2><br>  The TiKV codebase is written primarily in Rust, but it also has several third-party components in other languages ‚Äã‚Äã(RocksDB in C ++ and gRPC on Go).  <a href="https://github.com/tikv/tikv">It is distributed</a> under the same free Apache License v2. <br><br>  As mentioned at the beginning of the article, TiKV initially appeared as an important component of TiDB, but today it can be used both within the framework of this DBMS and separately.  (But in any case, its work will require a <a href="https://github.com/pingcap/pd">Placement Driver</a> , written on Go and distributed as a separate component). <br><br>  The shortest <a href="https://pingcap.com/docs/QUICKSTART/">instruction</a> for <b>running TiKV along with a TiDB database</b> requires Git, Docker (17.03+), Docker Compose (1.6.0+), MySQL Client and comes down to the following: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/pingcap/tidb-docker-compose.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tidb-docker-compose &amp;&amp; docker-compose pull docker-compose up -d</code> </pre> <br>  The result of these commands will be the deployment of a TiDB cluster, which by default consists of the following components: <br><br><ul><li>  1 copy of TiDB itself; </li><li>  3 copies of TiKV; </li><li>  3 copies of Placement Driver; </li><li>  Prometheus and Grafana <i>(for monitoring and graphs)</i> ; </li><li>  2 instances (master + slave) <a href="https://github.com/pingcap/tispark">TiSpark</a> <i>(an interlayer for running Apache Spark over TiDB / TiKV to perform complex OLAP queries)</i> ; </li><li>  1 copy of <a href="https://github.com/pingcap/tidb-vision">TiDB-Vision</a> <i>(for visualizing the work of Placement Driver)</i> . </li></ul><br>  Further work with the deployed DBMS: <br><br><ul><li>  connection via MySQL client: <code>mysql -h 127.0.0.1 -P 4000 -u root</code> ; </li><li>  Grafana web interface for viewing the cluster status - <code>http://localhost:3000</code> under admin / admin; </li><li>  The TiDB-Vision web interface for information on load balancing in a cluster and data migration across nodes - <code>http://localhost:8010</code> ; </li><li>  Spark's web interface is <code>http://localhost:8080</code> (access to TiSpark via <code>spark://127.0.0.1:7077</code> ). </li></ul><br>  If you want a <b>not quite standard TiDB cluster</b> (i.e., change its dimensions, use Docker images, ports, etc.), then after cloning the <a href="https://github.com/pingcap/tidb-docker-compose">tidb-docker-compose</a> repository you can edit the config for Docker Compose: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tidb-docker-compose $ vi compose/values.yaml $ helm template compose &gt; generated-docker-compose.yaml $ docker-compose -f generated-docker-compose.yaml pull $ docker-compose -f generated-docker-compose.yaml up -d</code> </pre> <br>  For even more customization, see ‚Äú <a href="https://github.com/pingcap/tidb-docker-compose">Customize TiDB Cluster</a> ‚Äù, where the information is described, where the configs for TiDB, TiKV, Placement Driver and other specifics come from. <br><br>  For a convenient <b>deployment of TiDB to the Kubernetes cluster, the</b> eponymous operator, <a href="https://github.com/pingcap/tidb-operator">TiDB Operator, has</a> <b>been</b> prepared.  It is in the Helm charts, so the installation can be reduced to the following commands (slide from the <a href="https://zhuanlan.zhihu.com/p/35048966">presentation</a> on TiDB DevConf 2018): <br><br><img src="https://habrastorage.org/webt/nl/as/fg/nlasfgegaxotqvvwyxbdt6pqxhu.jpeg"><br><br>  By the way, the same presentation speaks about the viewpoint of TiDB developers on monitoring this DBMS.  The text description, unfortunately, is in Chinese, but a general idea can be obtained from these slides: <br><br><img src="https://habrastorage.org/webt/zu/bu/b1/zubub1owruwhahyofdipppc-fie.jpeg"><br><img src="https://habrastorage.org/webt/z2/k-/f1/z2k-f1vwbtp_zxslpjzjyyufpcc.jpeg"><br><br>  Returning to the topic directly TiKV - this project has published its launch guidelines for test purposes: <br><br><ul><li>  <a href="https://www.pingcap.com/docs/op-guide/docker-compose/">together with TiDB</a> ; </li><li>  separately: <br><ul><li>  <a href="https://www.pingcap.com/docs/tikv/deploy-tikv-docker-compose/">with Docker Compose</a> ; </li><li>  <a href="https://www.pingcap.com/docs/tikv/deploy-tikv-using-docker/">with Docker</a> ; </li><li>  <a href="https://www.pingcap.com/docs/tikv/deploy-tikv-using-binary/">as a binary</a> . </li></ul></li></ul><br>  And for <b>TiKV deployments in production</b> there are ready-made developments with Ansible - again, <a href="https://www.pingcap.com/docs/op-guide/ansible-deployment/">with</a> and <a href="https://www.pingcap.com/docs/tikv/deploy-tikv-using-ansible/">without</a> <a href="https://www.pingcap.com/docs/op-guide/ansible-deployment/">TiDB</a> . <br><br>  Finally, as interfaces for working with TiKV are offered: <br><br><ul><li>  <a href="https://github.com/pingcap/tidb/tree/master/store/tikv">TiDB client on Go</a> ; </li><li>  <a href="https://github.com/pingcap/tispark/tree/master/tikv-client/src/main/java/com/pingcap/tikv">Java client TiSpark</a> ; </li><li>  <a href="https://www.pingcap.com/docs/tikv/go-client-api/">two types of API for Go</a> . </li></ul><br>  The <a href="">developers' plans</a> also include the creation of a client on Rust. <br><br><h2>  Results </h2><br>  Having originated as a component of a larger Open Source-project of a Chinese company, TiKV has already managed to gain fame in wide enough circles.  <a href="https://github.com/tikv/tikv/pulse">GitHub statistics</a> show not only about 3600+ stars, but almost 500 forks, and almost 100 contributors (although more than 10 commits have made only two dozen of them). <br><br>  The joining of TiKV to the number <a href="https://www.cncf.io/projects/">of CNCF projects</a> and the fact that this is the first project of this type also clearly indicates that the product is recognized by the cloud native community ... and should give impetus to the active development of its third-party code base (i.e., outside the founding company and its DBMS a) specialists. <br><br><h2>  PS </h2><br>  Read also in our blog: <br><br><ul><li>  ‚Äú <a href="https://habr.com/company/flant/blog/327640/">Familiarity with the CockroachDB DBMS and the creation of a fault-tolerant cluster with it on Ubuntu 16.04</a> ‚Äù; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/348044/">Rook -‚Äú self-service ‚Äùdata store for Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/417509/">Accelerate the bootstrap of large databases using Kubernetes</a> ‚Äù; </li><li>  " <a href="https://habr.com/company/flant/blog/350928/">CNCF Guide to Open Source Solutions (and more) for cloud native</a> "; </li><li>  " <a href="https://habr.com/company/flant/blog/326414/">Operators for Kubernetes: how to run stateful applications</a> ." </li></ul></div><p>Source: <a href="https://habr.com/ru/post/421903/">https://habr.com/ru/post/421903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421891/index.html">Background: 4-day work week - a real opportunity or a fantasy?</a></li>
<li><a href="../421893/index.html">Tester confession: how I rummaged in a competitor's IDS</a></li>
<li><a href="../421897/index.html">Red Hogwarts. Series 10. Students - metallurgist</a></li>
<li><a href="../421899/index.html">Tester's way: where to start learning automation</a></li>
<li><a href="../421901/index.html">Do not try to predict tomorrow's problems.</a></li>
<li><a href="../421905/index.html">Half a year with different wireless headphones: what did I choose</a></li>
<li><a href="../421909/index.html">Huawei at IFA 2018: chip, smart speaker and tracker (text translation)</a></li>
<li><a href="../421911/index.html">HP iPaq hx4700: five minutes to modern</a></li>
<li><a href="../421913/index.html">Confidential transactions in Monero, or how to transfer it is not known what is unknown where</a></li>
<li><a href="../421915/index.html">Review of the earthquake prediction system on Youtube channel ‚ÄúDutchsinse‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>