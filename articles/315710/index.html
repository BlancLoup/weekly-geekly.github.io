<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arsenal lazy Jedi for remote resuscitation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Each administrator once stops responding to a server on the other side of the city. On Friday evening, you have to drive along the muddy spring city, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arsenal lazy Jedi for remote resuscitation</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/7e2/2d6/226/7e22d62260674e00ba421f2351c31056.jpg"></p><br><p>  Each administrator once stops responding to a server on the other side of the city.  On Friday evening, you have to drive along the muddy spring city, since the patient is not available via the Internet and there is no sane staff nearby.  I remember how in one of these cases it was a shame to see "Press F1 to continue": the UPS failed and the old ProLiant, after a reboot, thought that "Power Supply Failed".  Well, one had to forget to turn off the notification while waiting for a reaction in the BIOS! </p><br><p>  <strong>But there will not be an ode to IPMI, but some personal rakes and tricks of remote recovery of network and server hardware.</strong> <a name="habracut"></a></p><br><h1 id="udalennaya-nastroyka-seti--k-dalney-doroge">  Remote network setup - to the long road </h1><br><p>  For example, I am lazy to go somewhere far to update the firmware of a router or add a few rules to the border firewall, so I do it remotely.  Here it is important to treat the process extremely carefully and carefully think through each step so as not to suddenly be cut off from the console settings, and from the network in general. </p><br><p>  A backup link on an additional router or automatic rollback of incorrect settings insure against such failures.  The option with the settings is more interesting, so I‚Äôll tell you a little more about how to save the devices that fell into the hands. </p><br><h2 id="d-link-serii-dfl">  D-link DFL Series </h2><br><p>  The DFL series has little in common with the usual D-link and its strange glitches - the devices themselves and their software were developed by Clavister. </p><br><p><img src="https://habrastorage.org/files/2f3/556/6cd/2f35566cdc2147cd811e076ba7caf51e.jpg"></p><br><p>  Such devices have the simplest protection mechanism: if, after applying the settings, the administrator could not reconnect to the web interface, the new parameters are not saved.  Reliable like a bayonet and no extra gestures. </p><br><h2 id="mikrotik">  Microtik </h2><br><p>  In the products of our Baltic brothers there is <a href="http://wiki.mikrotik.com/index.php%3Ftitle%3DManual:Console%26redirect%3Dno">Safe Mode</a> .  Since all changes made to the configuration are applied immediately, they should be done only in Safe Mode, after which the device should be correctly switched to normal mode.  Only after moving back will the new configuration be recorded. </p><br><p><img src="https://habrastorage.org/files/09d/cee/a0e/09dceea0e83f4d67b219adc12b7a8149.jpg"></p><br><p>  If Safe Mode was not disabled before terminating the setup session, then after 9 minutes the configuration will be replaced by the one that worked before enabling the safe mode. </p><br><h2 id="cisco">  Cisco </h2><br><p>  Relatively recently, Cisco added a mechanism to automatically roll back timer settings if a configuration archive was configured.  Before important changes you just need to set the time after which the device will cancel the settings made: </p><br><pre><code class="bash hljs">configure terminal revert timer X</code> </pre> <br><p>  Where X is the time in minutes. </p><br><p>  You can disable the timer after successfully applying the settings with the command <em>confirm confirm</em> .  For more examples and details, see the <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/config-mgmt/configuration/15-sy/config-mgmt-15-sy-book/cm-config-rollback-confirmed-change.html">Cisco documentation</a> . </p><br><p>  With the cancellation of the unsuccessful process of updating the firmware, things are more complicated.  If there is no fully independent channel to the remote branch where you want to update the router's software, it is better to go on a trip and do everything personally. </p><br><h1 id="bolshe-zagruzok-horoshih-i-raznyh">  More downloads, good and different </h1><br><p>  If there is no IP-KVM for a specific server or the channel is not wide enough to work remotely with the ISO distribution, then it is worthwhile to consider alternative ways to load recovery tools.  As a primitive solution, you can put a bootable USB flash drive with a set of familiar utilities next to the server rack.  You can activate this emergency dialing with the help of Smart Hands - the most "technical" employee of the branch, who will press the buttons on your pointer. </p><br><p>  Of course, the most popular remote boot method begins with the web interface of the BMC module. </p><br><div class="spoiler">  <b class="spoiler_title">Just in case, a memo about BMC</b> <div class="spoiler_text"><p>  BMC (Baseboard management controller) is a mini-computer installed on the server board and working autonomously, even if the entire system is turned off.  With this device, the server is diagnosed and controlled through several available protocols, the most famous of which is IPMI.  Depending on the manufacturer and model of the server, the controlling module can provide access to the console via IP-KVM.  A special case of the implementation of the BMC are: </p><br><ul><li><p>  HPE iLO. </p><br></li><li><p>  Lenovo IMM. </p><br></li><li>  Dell iDRAC. </li></ul><br></div></div><br><p>  For example, for HPE <a href="https://servermall.ru/catalog/model-hp-dl380-gen9/server-hp-dl380-gen9/">ProLiant DL380 Gen9,</a> it looks like this: </p><br><p><img src="https://habrastorage.org/files/db9/ee3/e08/db9ee3e0863f43d0870ea49eda794221.jpg"></p><br><p>  But even more interesting is the download of recovery tools via PXE: </p><br><p><img src="https://habrastorage.org/files/021/0fe/e64/0210fee64f1e4205a28739d0c0d36c61.jpg"></p><br><p>  <a href="https://habrahabr.ru/company/serverclub/blog/250549/">There are a</a> lot of <a href="https://habrahabr.ru/company/serverclub/blog/250549/">instructions for this case</a> , so I‚Äôll just note that when using BMC without IP-KVM, you need to configure the start of the image without asking any questions. </p><br><p>  It is not necessary to keep a separate server for network boot.  For example, the already mentioned Mikrotik routers can <a href="http://howitmake.ru/blog/waildhand/169.html">cope</a> with the distribution of the image over the network.  With their help, you can even make a ready-made "rescue module" with a backup wireless channel and different images. </p><br><p>  Then the IPMI command to enable PXE boot will look something like this: </p><br><pre> <code class="bash hljs">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; chassis bootdev pxe</code> </pre> <br><p>  Other ways to control downloads via IPMI can be found in <a href="http://ma.ttwagner.com/ipmi-trick-set-the-boot-device/">this article</a> . </p><br><p>  Attention should be paid to the very image.  In addition to providing access to the system being launched over the network, you need to not forget your favorite set of tools for resuscitation.  I usually use Microsoft <a href="https://technet.microsoft.com/ru-ru/library/jj680675(v%3Dvs.85).aspx">DaR</a> <a href="https://technet.microsoft.com/ru-ru/library/jj680675(v%3Dvs.85).aspx">T</a> , so I‚Äôll tell you more about it. </p><br><p>  With DaRT, you can repair any problem Windows system, but many use the tool only locally.  To fix the situation remotely, someone local must run the Remote Connection tool on the patient and give you the ticket data (address, port and number).  Then you can connect to the system using the DaRT Remote Connection Viewer and do all the necessary recovery procedures.  The file with the ticket data after launching Remote Connection is created in <strong>Windows \ System32 \ inv32.xml</strong> . </p><br><p><img src="https://habrastorage.org/files/95a/417/586/95a417586beb49b7a06ca73cc4ef9ba6.jpg"></p><br><div class="spoiler">  <b class="spoiler_title">A more advanced option that does not require any help.</b> <div class="spoiler_text"><p>  For automatic support of remote connection, a ready image from the Network will not work - you will have to do it manually: </p><br><ol><li><p>  Download the image creation tool; </p><br></li><li><p>  At the Remote Connection step, turn it on; </p><br></li><li><p>  Create an image and connect it; </p><br></li><li>  Edit the Windows \ System32 \ winpeshl.ini file: </li></ol><br><pre> <code class="hljs dos">[LaunchApps] "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\netstart.exe -network -remount" "<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span> /C <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> <span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\RemoteRecovery.exe -nomessage"</code> </pre> <br><p>  in this line, copy the% windir% \ system32 \ inv32.xml file to a network folder or // send it to the admin " </p><br><pre> <code class="hljs perl"><span class="hljs-string"><span class="hljs-string">"%windir%\system32\WaitForConnection.exe"</span></span> <span class="hljs-string"><span class="hljs-string">"%SYSTEMDRIVE%\sources\recovery\recenv.exe"</span></span></code> </pre> <br><p>  After all this, collect the image back.  It remains to take the inv32.xml file from the network storage and specify the data to the remote connection tool. </p></div></div><br><h1 id="bez-apparatnogo-upravleniya-izbezhat-poezdok-slozhnee">  Without hardware control, travel is more difficult. </h1><br><p>  Almost all server manufacturers supply their hardware management module (BMC).  But some sell some of the features separately, so be sure to buy a license or learn a free set of tools.  For example, console commands are usually available for free. </p><br><p><img src="https://habrastorage.org/files/82c/4e9/a13/82c4e9a13d9f4873984195b39545e803.jpg"></p><br><p>  If the BMC has IP-KVM, then in most cases you will be able to restart the system, as well as boot from the network or from an ISO image.  All this without using the risky resource Smart Hands.  By the way, ‚Äúthe most intelligent employee‚Äù can easily say something like ‚ÄúWe learned German at school - I don‚Äôt understand what‚Äôs written here‚Äù, which will destroy the whole crystal world of disaster recovery. </p><br><blockquote>  But there are pleasant exceptions.  In one emergency situation, he asked for the telephone the most computer-savvy employee.  The bright eastern accent from the tube immediately somehow tuned to the pessimistic mood ... But it turned out that Fayzulla graduated from a technical university in Tashkent, works as a freelance programmer at night, and during the day he works in a warehouse ‚Äî so to speak, he rests with his brain and saves on fitness. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Important points for setting up BMC for remote access</b> <div class="spoiler_text"><p>  The connection through the BMC should be perceived as a kind of backdoor, which differs from the vulnerability only what serves all of your goals.  Therefore, to put it in a public network is not the best idea.  Even inside the local network, the control interfaces should be output to a separate VLAN with access only from the admin machines.  In the case of a remote object, you must also configure VPN access. </p><br><p>  The ports for the graphical console and Remote Media forwarding for the three popular vendors are as follows: </p><br><table><tbody><tr><td></td><td>  IMM port </td><td>  ILO port </td><td>  IDRAC port </td></tr><tr><td>  Remote media </td><td>  3900 </td><td>  17998 </td><td>  5900 </td></tr><tr><td>  Remote console </td><td>  3900 </td><td>  17990 </td><td>  5900 </td></tr></tbody></table><br><p>  More complete information on network settings is in the official documentation: </p><br><ul><li><p>  <a href="https://lenovopress.com/tips0511-tcpp-ports-cmm-and-imm2-management-processors">Lenovo</a> </p><br></li><li><p>  <a href="http://h20565.www2.hpe.com/hpsc/doc/public/display%3FdocId%3Dc03334051">HPE</a> </p><br></li><li>  <a href="http://www.dell.com/support/manuals/us/en/04/integrated-dell-remote-access-cntrllr-7-v1.50.50/iDRAC7UG1.50.50-v1/iDRAC7-Port-Information%3Fguid%3DGUID-84DAF55C-3171-49FC-B423-CC870F508689%26lang%3Den-us">Dell</a> </li></ul><br><p>  When planning a network configuration, it is worth remembering that the BMC usually operates in one of three modes: </p><br><ul><li><p>  <strong>Dedicated</strong> - when the port is used for control only; </p><br></li><li><p>  <strong>Shared</strong> - IPMI runs on the LAN1 network interface; </p><br></li><li>  <strong>Failover</strong> - IPMI works in Dedicated mode, but if there is no link on the dedicated port, it switches to the Shared mode. </li></ul><br><p>  Using Shared or Failover modes, it is possible to accidentally release the BMC to a common network.  Therefore, wherever possible, you should use a separate interface. </p></div></div><br><blockquote>  As an additional control lever, you can use a GSM-socket: <br><br><img src="https://habrastorage.org/files/e5b/618/2e1/e5b6182e1f8c48efb20d86fdf1cddfa9.jpg"><br><br>  The power management module with a SIM card allows you to restart any connected devices, regardless of the availability of the main Internet channel.  But such a restart can negatively affect the integrity of the server data, because everything happens only in ‚Äúhard‚Äù mode.  For switches and routers, this emergency SMS switch via SMS is very convenient. </blockquote><p>  If the server is still purchased without any BMC implementation, then there are a couple of fallback options: </p><br><ul><li><p>  Separate IP-KVM device.  You can connect many "unmanaged" servers; </p><br></li><li><p>  <a href="http://www.aten.com/global/en/products/kvm/kvm-over-ip-switches/ip8000/">BMC</a> module <a href="http://www.aten.com/global/en/products/kvm/kvm-over-ip-switches/ip8000/">on the PCI-E bus</a> , which can be installed in almost any machine; </p><br></li><li>  In the case when the future server is built on the basis of desktop hardware, you should order a motherboard and a processor with <a href="http://www.intel.ru/content/www/ru/ru/architecture-and-technology/vpro/vpro-technology-general.html">Intel vPro</a> support.  With IPMI implementations, this system has little in common, but provides the functions of IP-KVM. </li></ul><br><blockquote>  By law, Murphy, at the same time with a server crash, the Internet channel or router may fail.  Therefore, it is a good idea to use not one router with two channels, but several separate devices.  A good option is a 3G \ LTE modem with support for VPN tunnels - the speed provided by these networks is enough even for a remote desktop session. </blockquote><br><h1 id="o-polze-nepopulyarnyh-protokolov">  The benefits of unpopular protocols </h1><br><p>  In the era of universal ‚Äúdigital curiosity‚Äù, it is archaic to use a leaky server management protocol, and even using UDP.  In addition to convenient web interfaces, manufacturers often provide alternative management methods: </p><br><ul><li>  <a href="http://www.dmtf.org/standards/wsman">WS-Management</a> .  This protocol is ideologically closer to WBEM than to SNMP.  In a Windows environment, its implementation is WinRM. </li></ul><br><p>  For example, the PowerShell command to reboot using WS-Management looks like this: </p><br><pre> <code class="bash hljs">Restart-Computer -ComputerName <span class="hljs-string"><span class="hljs-string">"Server01"</span></span> -Protocol WSMan -WSManAuthentication Kerberos</code> </pre> <br><ul><li>  <a href="http://www.dmtf.org/standards/smash">SMASH</a> .  An interface standard that works over SSH.  The restart command is simple, as all ingenious: </li></ul><br><pre> <code class="bash hljs">reset</code> </pre> <br><p>  Almost all vendors provide such alternative interfaces, but they are more often used by monitoring tools, and not by the administrators themselves. </p><br><h1 id="itogo">  Total </h1><br><p>  Of course, cluster solutions successfully save from many problems.  But we do not live in a perfect spherical world, and not all services can be arranged reservations.  Therefore, the nuances of "cunning" restorations also come in handy at least once for everyone. </p><br><p>  <strong>You probably have your own tricks for the case of "ping gone, and go far" - share with colleagues in the comments.</strong> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315710/">https://habr.com/ru/post/315710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315696/index.html">Played == okay</a></li>
<li><a href="../315700/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ237 (November 14 - 20, 2016)</a></li>
<li><a href="../315702/index.html">Beta versions of 3CX clients for Android and iOS, and solving the problem with 3CX activation on Windows 7</a></li>
<li><a href="../315706/index.html">Five systemd tools to start using right now</a></li>
<li><a href="../315708/index.html">Why you should refuse the paper registration of visitors in the data center</a></li>
<li><a href="../315712/index.html">PixelPixie - a font generator for LCD and OSD</a></li>
<li><a href="../315714/index.html">How Donald Knut went to school and went to university</a></li>
<li><a href="../315718/index.html">HV or How to draw binary trees nicely</a></li>
<li><a href="../315720/index.html">Why would I not use Rails for a new project?</a></li>
<li><a href="../315722/index.html">How we reassembled servers in the US data center from Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>