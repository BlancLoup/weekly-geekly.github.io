<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Its a web server on NodeJS, and not a single framework. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many people, JavaScript is associatively associated with an abundance of diverse frameworks and libraries. Of course, the tools that help us every...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Its a web server on NodeJS, and not a single framework. Part 1</h1><div class="post__text post__text-html js-mediator-article">  For many people, JavaScript is associatively associated with an abundance of diverse frameworks and libraries.  Of course, the tools that help us every day are good, but it seems to me that we need to find some kind of balance between using the tools and procrastination, as well as know how the things you use work.  Therefore, when I just sat down with NodeJS, I was particularly interested to write a full-fledged web server, which I could use myself. <br><a name="habracut"></a><br>  Newbies in NodeJS can really be hard.  JS is one of the languages ‚Äã‚Äãin which there is often no single correct solution to a specific task, and modules added to a node for working with the file system, http server and other things characteristic of working on the server make it difficult even for those who write good code for browsers.  Nevertheless, I hope that you know the basics of this language and its work in the server environment, if not, I advise you to see a wonderful <a href="http://learn.javascript.ru/screencast/nodejs">screencast</a> , which will help to understand the basics.  And finally - I do not pretend to some kind of exceptionally correct code and I will be glad to hear criticism - we all learn, and this is a great way to get knowledge. <br><br><h3>  Let's start with the file structure </h3><br>  The source nodejs folder is stored on the server at the path / var / www / html /.  It will be our web server.  Then everything is simple: create a routing directory in it, which will contain our index.js script, as well as 4 folders - dynamic, static, nopage and main - for dynamically generated pages, statics, page 404 and the main page.  It looks like this: <br><br><blockquote>  nodejs <br>  --routing <br>  ---- dynamic <br>  ---- nopage <br>  ---- static <br>  ---- main <br>  ---- index.js </blockquote><br><h3>  We create our server </h3><br>  Great, the file structure is more or less defined.  Now we create a server.js file with the following contents in the source folder: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// server.js //    . const http = require('http'); const routing = require('./routing'); let server = new http.Server(function(req, res) { // API     POST-   JSON,    //       jsonString var jsonString = ''; res.setHeader('Content-Type', 'application/json'); req.on('data', (data) =&gt; { //   - . jsonString += data; }); req.on('end', () =&gt; {//    -   . routing.define(req, res, jsonString); //  define    . }); }); server.listen(8000, 'localhost');</span></span></code> </pre> <br>  Great!  Now our server will accept requests, write JSON-data, if there is one, but so far it will crash with an error, because we do not have a define function in /routing/index.js.  Time to fix it. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// /routing/index.js const define = function(req, res, postData) { res.end('Hello, Habrahabr!'); } exports.define = define;</span></span></code> </pre><br>  We start our server: <br><br><pre> <code class="hljs pgsql">node <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js</code> </pre> <br>  We go where he listens to requests.  If you did not change the code, it will be localhost: 8000.  Hooray.  The answer is. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/65e/7d4/8c0/65e7d48c03f4ba680e6eeff75630d028.jpg" alt="image"><br>  Wonderful.  Only this is not exactly what we need from the server, right? <br><br><h3>  We catch requests to our API </h3><br>  Yes, we have received the answer, but so far not too close to the final goal.  It's time to write logic for our router. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// /routing/index.js //    . const url = require('url'); const fs = require('fs'); const define = function(req, res, postData) { //    .     localhost:3000/test,  path  '/test' const urlParsed = url.parse(req.url, true); let path = urlParsed.pathname; //      server.js.    ,     //   systemd,  ,     ,  /etc/systemd/system/... prePath = __dirname; try { //       .     // localhost:8000/api,      /routing/dynamic/api, ,    // index.js,  .  ,    try/catch   ,   //   fs.readFile,       ,    //   . let dynPath = './dynamic/' + path; let routeDestination = require(dynPath); res.end('We have API!'); } catch (err) { //   api? . res.end("We don't have API!"); } }; exports.define = define;</span></span></code> </pre><br>  Is done.  Now we can create <code>/routing/dynamic/api</code> , and test what we have.  I will use for this purpose my ready-made script at / dm / shortenUrl. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/846/488/8f1/8464888f15eb779d3638849fb5beff0c.jpg" alt="image"><br><h3>  Determine whether there is a page </h3><br>  We learned how to find scripts, now we need to learn how to find statics.  First of all, let's go to <code>/routing/nopage</code> and create <code>index.html</code> there.  Just create the backbone of the html page, and make a single h1 heading with the text: "404".  After that, go back to <code>/routing/index.js</code> , but now we will focus on the catch block we‚Äôve already written: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// /routing/index.js:  catch catch (err) { //          . //    ,    '=&gt;',       es6, //   . let filePath = prePath+'/static'+path+'/index.html'; fs.readFile(filePath, 'utf-8', (err, html) =&gt; { //    ,     404   . //   ‚Äî ,        -. if(err) { let nopath = '/var/www/html/nodejs/routing/nopage/index.html'; fs.readFile(nopath, (err , html) =&gt; { if(!err) { res.writeHead(404, {'Content-Type': 'text/html'}); res.end(html); } //     -   ,  ,    //  -   ,    . else{ let text = "Something went wrong. Please contact webmaster@forgetable.ru"; res.writeHead(404, {'Content-Type': 'text/plain'}); res.end(text); } }); } else{ //  , ,  . res.writeHead(200, {'Content-Type': 'text/html'}); res.end(html); } }); }</span></span></code> </pre><br>  Inspiring.  Now we can give page 404, as well as html-pages, which we add ourselves to <code>/routing/static</code> .  In my case, page 404 looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e4c/0db/f31/e4c0dbf31487c34c397dd4f907b6255f.jpg" alt="image"><br><br><h3>  A few words about the API </h3><br>  The way to organize scripts is a personal matter.  At the moment, the code in the try block is: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dynPath = <span class="hljs-string"><span class="hljs-string">'./dynamic/'</span></span> + path; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> routeDestination = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(dynPath); routeDestination.promise(res,postData,req).then( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function"> =&gt;</span></span> { res.writeHead(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.end(result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }, error =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> endMessage = {}; endMessage.error = <span class="hljs-number"><span class="hljs-number">1</span></span>; endMessage.errorName = error; res.end(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(endMessage)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } );</code> </pre><br>  In fact, all my scripts are a function that passes parameters to closures and returns promises, and further logic on promises is tied.  In this context, this approach seems to me very convenient, so catching errors becomes very easy.  It is already possible, in principle, to rewrite this logic on async / await, but I don‚Äôt see much sense for myself in this. <br><br><h3>  Processing browser requests </h3><br>  Now we can use our server, and it will return pages.  However, if you put the same page in <code>/routing/static/somepage</code> , which works great, for example, on Apache, you will encounter some problems. <br><br>  First of all, for this web server, as well as, probably, for all of this kind, you need to set references to css / js / img / ... files differently.  If you want to connect a css-file to page 404 and make it beautiful, then in the case of Apache we would create a style.css file in the same nopage folder and connect it by specifying the following in the link tag: 'href = "style.css "'.  However, now we need to write the path differently, namely: "/routing/nopage/style.css". <br><br>  Secondly, even if we connect everything correctly, then nothing will happen, and we will still have a bare html page.  And here we come to the very last part of today's article - we add the script so that it catches and processes the requests that the browser sends itself, reading the html markup.  Well, let's not forget about favicon - take a favicon and put it in the / routing directory of our server. <br><br>  So, go back to <code>/routing/index.js</code> .  Now we will write the code right before try / catch: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      path  prePath.   ,   //  .     ,        // , : style.css, test.js, song.mp3 if(/\./.test(path)) { if(path == 'favicon.ico') { //    -  ,      'favicon.ico' // ,     prePath, : '/var/www/html/nodejs/routing/favicon.ico'. //    return,        . let readStream = fs.createReadStream(prePath+path); readStream.pipe(res); return; } else{ //       ,    ,    ,    //   res.head,   ,     ,   . //      css, js  mp3  ,      //  , ,   ,      . if(/\.mp3$/gi.test(path)) { res.writeHead(200, { 'Content-Type': 'audio/mpeg' }); } else if(/\.css$/gi.test(path)) { res.writeHead(200, { 'Content-Type': 'text/css' }); } else if(/\.js$/gi.test(path)) { res.writeHead(200, { 'Content-Type': 'application/javascript' }); } //  -,      return,     . let readStream = fs.createReadStream(prePath+path); readStream.pipe(res); return; } }</span></span></code> </pre><br>  Fuh.  All is ready.  Now you can connect our css-file and see our 404 page with all the styles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af6/623/303/af6623303f39b91289bac6d68dc5b41a.jpg" alt="image"><br><br><h3>  findings </h3><br>  Hooray!  We have made a web server that works and works well.  Of course, this is only the beginning of work on the application, but the most important thing is already done - on such a web server you can raise any pages, it can cope with both static and dynamic content, and routing, in my opinion, looks convenient - just put the corresponding a file in static or dynamic, and it will immediately pick up, and you should not write a routing for each specific case. <br><br>  In general, I am very pleased with the work of the server, and now I have refused Apache towards this solution, and on the whole it was a very interesting experience.  Thank you very much, you, the reader, shared it with me, having come to this point. <br><br>  UPD: I do not encourage anyone to use this server on an ongoing basis.  Despite the fact that it completely suits me, it does not have a large number of functions necessary for a regular web server and some ready-made functionality, such as a clear definition of mime types, is not optimized.  This will all be in the following articles. </div><p>Source: <a href="https://habr.com/ru/post/327440/">https://habr.com/ru/post/327440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327430/index.html">Employee Motivation: Office Diplomacy Rules</a></li>
<li><a href="../327432/index.html">Management Toolkit: HPE Project Portfolio Management Center</a></li>
<li><a href="../327434/index.html">The first course Mail.Ru Group on the largest educational platform Coursera</a></li>
<li><a href="../327436/index.html">All on the shelves: web analytics with Rambler / Top 100, part 1</a></li>
<li><a href="../327438/index.html">Now you can learn how to design interfaces on Coursera</a></li>
<li><a href="../327442/index.html">Post effects in mobile games</a></li>
<li><a href="../327444/index.html">Sports data analysis, or how to become a data science specialist</a></li>
<li><a href="../327446/index.html">Your recruitment is not social: features of social networks, lifehacks and tools for HR</a></li>
<li><a href="../327448/index.html">Learning from the masters: design levels Legend Of Zelda</a></li>
<li><a href="../327450/index.html">Operator overloading in freepascal on the example of ordinary fractions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>