<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP, GDB and arrays</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why would a simple PHP developer need a source debug? Well, for example, if he noticed some not obvious behavior and wants to understand him at the mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP, GDB and arrays</h1><div class="post__text post__text-html js-mediator-article">  Why would a simple PHP developer need a source debug?  Well, for example, if he noticed some not obvious behavior and wants to understand him at the most ‚Äúlow‚Äù level.  I would like to talk about such an interesting behavior for me, as well as the process of ‚Äúdebag surasov‚Äù. <br><br><h3>  Motivation </h3><br>  Let's start with the bat, here are two similar pieces of code: <br><br><div class="spoiler">  <b class="spoiler_title">Time</b> <div class="spoiler_text"><pre><code class="php hljs">$arr = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i =<span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">300</span></span>; $i++) { $arr[rand(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>)] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } $sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">1001</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">200000000</span></span>; $i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array_key_exists($i, $arr)){ $sum++; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Two</b> <div class="spoiler_text"><pre> <code class="php hljs">$arr = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i =<span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">300</span></span>; $i++) { $arr[rand(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>)] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } sort($arr); $sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">1001</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">200000000</span></span>; $i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array_key_exists($i, $arr)){ $sum++; } }</code> </pre><br></div></div><br>  The difference between them is that in the second case we sorted the $ arr array, thereby updating the keys 0..count ($ arr) -1.  And I was interested in the moment that the first script runs 6.0 seconds, while the second is 4.7 seconds.  It turns out about 20 percent difference. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you are familiar with the internal structure of the php hash table, as well as with the hash function, then you either already know the answer or can easily guess.  Well, for the rest, I'll tell you how to set up the environment for debugging and find out what's the matter. <br><a name="habracut"></a><br><h3>  Customize the environment </h3><br>  We will need: <br><br><ul><li>  source php. </li><li>  debager gdb. </li><li>  php itself compiled in debug mode. </li></ul><br>  We clone php source files to ourselves: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://git.php.net/repository/php-src.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-src git checkout -b PHP-7.1 origin/PHP-7.1</code> </pre><br>  If you do not have the libraries necessary for compiling, put them too: <br><br><pre> <code class="bash hljs">sudo apt-get install build-essential autoconf automake libtool</code> </pre> <br>  And compile: <br><br><pre> <code class="bash hljs">./buildconf ./configure --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-all --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-debug ‚Äìprefix=<span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/dev/bin/php make &amp;&amp; make install</code> </pre> <br><cut></cut><br><h3>  We start the search </h3><br>  To begin with, we will determine the starting point of our investigation, this will be the function <i>array_key_exists</i> .  Find it in the source of labor will not be if you know how to declare functions in PHP - this is the macro <i>PHP_FUNCTION (% function_name%)</i> .  Do a search for the source code of the string <i>PHP_FUNCTION (array_key_exists)</i> and find our function in <b>extension / standart / array.c</b> .  Code: <br><br><div class="spoiler">  <b class="spoiler_title">PHP_FUNCTION (array_key_exists)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* {{{ proto bool array_key_exists(mixed key, array search) Checks if the given key or index exists in the array */</span></span> PHP_FUNCTION(array_key_exists) { zval *key; <span class="hljs-comment"><span class="hljs-comment">/* key to check for */</span></span> HashTable *<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* array to check in */</span></span> ZEND_PARSE_PARAMETERS_START(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) Z_PARAM_ZVAL(key) Z_PARAM_ARRAY_OR_OBJECT_HT(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>) ZEND_PARSE_PARAMETERS_END(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (Z_TYPE_P(key)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_STRING: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_symtable_exists_ind(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, Z_STR_P(key))) { RETURN_TRUE; } RETURN_FALSE; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_LONG: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_hash_index_exists(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, Z_LVAL_P(key))) { RETURN_TRUE; } RETURN_FALSE; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_NULL: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_hash_exists_ind(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, ZSTR_EMPTY_ALLOC())) { RETURN_TRUE; } RETURN_FALSE; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: php_error_docref(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, E_WARNING, <span class="hljs-string"><span class="hljs-string">"The first argument should be either a string or an integer"</span></span>); RETURN_FALSE; } }</code> </pre> <br></div></div><br>  Before us is a high-level wrapper for core functions of a language, dig a little deeper into the function <i>zend_hash_index_exists</i> . <br><br>  We can find it in <b>Zend / zend_hash.c</b> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">ZEND_API zend_bool ZEND_FASTCALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zend_hash_index_exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HashTable *ht, zend_ulong h)</span></span></span><span class="hljs-function"> </span></span>{ Bucket *p; IS_CONSISTENT(ht); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ht-&gt;u.flags &amp; HASH_FLAG_PACKED) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &lt; ht-&gt;nNumUsed) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_TYPE(ht-&gt;arData[h].val) != IS_UNDEF) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } p = zend_hash_index_find_bucket(ht, h); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><cut></cut><br><h3>  Debashim </h3><br>  We start debager: <br><br><pre> <code class="bash hljs">gdb --args /home/your_pc/dev/bin/php/bin/php /home/your_pc/array_w_sort_test.php</code> </pre><br>  1st parameter is the path to compiled php, 2nd is the path to our test in which we use sorting. <br><br>  After we hit the debager, it‚Äôs worth running the following command: <br><br><pre> <code class="bash hljs">(gdb) <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> ~/dev/c/php-src/.gdbinit</code> </pre><br>  This will give us some very useful commands, you can see the list by writing: <br><br><pre> <code class="bash hljs">(gdb) <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> user-defined</code> </pre><br>  Put a breakpoint on the function <i>zend_hash_index_exists</i> : <br><br><pre> <code class="bash hljs">(gdb) <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> zend_hash_index_exists</code> </pre><br>  And run the script: <br><br><pre> <code class="bash hljs">(gdb) run</code> </pre><br>  We see on the screen something like: <br><br><pre> <code class="bash hljs">(gdb) run Starting program: /home/your_pc/dev/bin/php/bin/php /home/your_pc/array_w_sort_test.php Breakpoint 1, zend_hash_index_exists (ht=0x7ffff7059780, h=1001) at /home/your_pc/dev/c/php-src/Zend/zend_hash.c:2030 2030 IS_CONSISTENT(ht);</code> </pre><br>  Great, we're inside the thread of execution! <br><br>  To see where we are in the PHP code, run the command: <br><br><pre> <code class="bash hljs">(gdb) zbacktrace</code> </pre><br>  The result tells us that the entry point was defined correctly: <br><br><pre> <code class="bash hljs">[0x7ffff7015240] array_key_exists(1001, array(251)[0x7ffff70152a0]) [internal <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>] [0x7ffff7015030] (main) /home/your_pc/array_w_sort_test.php:14</code> </pre><br>  To navigate through the source code use the command: <br><br><pre> <code class="bash hljs">(gdb) next</code> </pre><br>  or <br><br><pre> <code class="bash hljs">(gdb) step</code> </pre><br>  The first will not fall into the functions that occur along the way, the second, respectively, will be. <br><br>  Run the command to view the parameters with which the function is called: <br><br><pre> <code class="bash hljs">(gdb) info args ht = 0x7ffff7059780 h = 1001</code> </pre><br>  ht is a pointer to the hash table, h is the desired key. <br><br>  And so, we get to the line: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ht-&gt;u.flags &amp; HASH_FLAG_PACKED) {</code> </pre> <br>  We do next - the condition is satisfied!  Ok, let's do the same steps for the test without sorting - the condition is not met!  Well, we found the ‚Äúplug‚Äù, which makes such a difference in speed.  We will understand in more detail. <br><br><h3>  A little about the structure of the PHP hash tables. </h3><br>  Run the <b>ptype</b> command to see what the hash table is ht <br><br><pre> <code class="bash hljs">(gdb) ptype ht <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = const struct _zend_array { zend_refcounted_h gc; union { struct {...} v; uint32_t flags; } u; uint32_t nTableMask; Bucket *arData; uint32_t nNumUsed; uint32_t nNumOfElements; uint32_t nTableSize; uint32_t nInternalPointer; zend_long nNextFreeElement; dtor_func_t pDestructor; } *</code> </pre> <br>  Here we are interested in: <br><br><ul><li>  <i>arData</i> - C array containing buckets.  A bucket is a C structure containing a zval - a stored item, a key in a php array, and also a hash of this key as a number. </li><li>  <i>NnumUsed</i> - the maximum occupied index in the <i>arData</i> + 1 array. </li><li>  <i>u.flags</i> - no signed int, each bit of which corresponds to a flag. </li><li>  In addition, carefully looking at the structure, you ask how the key hash is mapped to the <i>arData</i> array?  For this, php developers use the <b>translation table</b> .  It is stored ‚Äúbehind‚Äù the <i>arData</i> array ( <i>arData [-1]</i> , <i>arData [-2]</i> , etc.) and is a map of the hashes to the indices of the arData array. </li><li>  Finally, you need to know that the hash operation does not apply to integer keys, and they are translated into the hash keys of the table ‚Äúas is‚Äù. </li></ul><br><h3>  Back to code </h3><br>  <i>ht ‚Üí u.flags</i> set of flags is collapsed into a number.  For the <i>HASH_FLAG_PACKED</i> flag <i>,</i> we are interested in the 3rd bit. <br><br>  To get the value of the flags, run the command: <br><br><pre> <code class="bash hljs">(gdb) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> ht-&gt;u.flags <span class="hljs-variable"><span class="hljs-variable">$1</span></span> = 30</code> </pre><br>  So it is, in the 3rd bit unit. <br><br>  Since the condition is true we get here: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &lt; ht-&gt;nNumUsed) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_TYPE(ht-&gt;arData[h].val) != IS_UNDEF) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  In line 1, we check whether the value of the required key is valid with respect to the <i>arData</i> array.  If yes, we just have to check whether the <i>arData</i> array at address <i>h</i> contains an element. <br><br>  Well, if the flag <i>HASH_FLAG_PACKED is</i> not set, then we will get here. <br><br><pre> <code class="cpp hljs">p = zend_hash_index_find_bucket(ht, h);</code> </pre><br>  This function will search for the required element, but using the translation table mentioned above. <br><br>  Well, that's all the magic.  Debagger can be closed.  There is only 1 question left.  And what is this actually for the <i>HASH_FLAG_PACKED</i> flag and where is it set? <br><br>  This flag signals us about <b>Packed hashtable optimization</b> - all the keys of the php array are numbers and are sorted in ascending order.  Regarding the test example, it is not difficult to guess, this flag is set inside the sort function.  As it turned out, this optimization affects a fairly large number of aspects of working with the language.  There probably is no other article you can write. <br><br>  And my story ends here, we looked at some of the techniques of working in a bunch of php + dbg, and out of the corner of our eyes took a look at one interesting optimization in hash table algorithms.  I hope the methods described above will help you to research the wonderful PHP tool. </div><p>Source: <a href="https://habr.com/ru/post/358604/">https://habr.com/ru/post/358604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358588/index.html">Application Monitoring with Prometheus</a></li>
<li><a href="../358594/index.html">Utilize Groovy DSL features for configuring Java applications</a></li>
<li><a href="../358596/index.html">John Carmack: My stories about Steve Jobs</a></li>
<li><a href="../358600/index.html">Features of API development: which API is good?</a></li>
<li><a href="../358602/index.html">How to unleash the potential of a product manager? 30 typical PM interview questions</a></li>
<li><a href="../358608/index.html">Each serverless platform has servers.</a></li>
<li><a href="../358610/index.html">The book "Theoretical minimum in Computer Science. All the programmer and developer need is "</a></li>
<li><a href="../358612/index.html">Building an extended anti-virus protection system for a small enterprise. Part 2. Antivirus Gateway USG40W by Zyxel</a></li>
<li><a href="../358614/index.html">Security or paranoia: temporary rights when running commands</a></li>
<li><a href="../358616/index.html">The birth of a virtual mobile operator: the Bank Tinkoff project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>