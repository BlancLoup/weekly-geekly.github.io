<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a native iOS plugin for Unity3d. Undocumented features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Unity3d, it is possible to connect native plugins to an application. On the official Unity3d website there is documentation on interaction with nat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a native iOS plugin for Unity3d. Undocumented features</h1><div class="post__text post__text-html js-mediator-article">  In Unity3d, it is possible to connect native plugins to an application.  On the official Unity3d website there is <a href="http://docs.unity3d.com/ru/current/Manual/PluginsForIOS.html">documentation</a> on interaction with native code on iOS.  This documentation is limited to the description of how to call a particular function from a plugin that you built yourself and how to make a callback.  The documentation describes what the rules should correspond to the described function and a little about how to pass parameters to it.  At the end of the article with the documentation there is a link where you can download an example called Bonjour. <br><br>  Unfortunately, the documentation does not describe what to do if your plugin needs to intercept the event that the user subscribed to the Push Notification or the application switched to the background (AppDidEnterBackgound), while access to this event is necessary for some plugins that you may want to write. <br><a name="habracut"></a><br>  To begin with, the documentation describes that you can transfer parameters from C # or js code to native and back.  However, these rules are not explicitly described, and it may be worthwhile to describe them in more detail.  The rules on the transfer of parameters formulated below were obtained when studying existing plug-ins: <a href="https://developers.facebook.com/docs/unity">Fb Unity SDK</a> and <a href="https://developers.google.com/analytics/devguides/collection/unity/v3/devguide">Google Analytics</a> . <br><br>  Types of parameters that can be passed between native code and C # (and vice versa): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="objectivec hljs">string = <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* <span class="hljs-comment"><span class="hljs-comment">// Unity   char* = string //   Unity bool //(  ) int //(  ) float //(  )</span></span></code> </pre> <br>  When working in native code, const char * can be simply converted to a more convenient for iOS NSString in this way: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* CreateNSString (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* string) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (string) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String: string]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String: <span class="hljs-string"><span class="hljs-string">""</span></span>]; }</code> </pre><br>  String values ‚Äã‚Äãreturned from the native method must be in UTF ‚Äì 8 encoding, encoded and allocated on the heap.  Mono sort calls are free for strings.  Heap allocation is necessary because the Mono compiler for returned C strings creates a .NET string and calls free for the return value. <br><br>  In order to avoid problems, you can call a method that creates a copy of the string on the heap (from the Bonjour example): <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* MakeStringCopy (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* string) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (string == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* res = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)malloc(strlen(string) + <span class="hljs-number"><span class="hljs-number">1</span></span>); strcpy(res, string); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br>  The functionality associated with changing the state of the application or its view is not documented in Unity, a project in which the official Fb SDK for Unity3d was integrated was collected for information.  The project used Unity3d version 5.1.2f1 and Fb Unity SKD version 6.2 ( <a href="https://developers.facebook.com/docs/unity/downloads">can be found here</a> ), iOS SDK 8.4.  The project was compiled under iOS, in Player Settings as the Scripting Backend was chosen IL2CPP. <br><br>  What may need this information?  To develop a native iOS plugin that uses native functions and listens for messages about changes in the application state ( <a href="https://developer.apple.com/library/ios/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/TheAppLifeCycle/TheAppLifeCycle.html">The App Life Cycle - Apple Developer</a> ), changes in the state of the main View of the application and renderer.  For example, this functionality may be required to integrate native social network plugins or plug-ins from various analytics that have native iOS plug-ins supported, but there are no plug-in versions for Unity3d. <br><br>  In this case, there are 2 outputs: <br><ul><li>  Generate an Xcode project.  Find the source code of the application delegate, modify it, and integrate the plugin.  The disadvantage of this approach is that if the version of your application is far from the final and further changes are made, then XCode will have to generate the project again and integrate the plugin from scratch.  I used this approach only once.  The publisher insisted on integrating its own tracker of installs and purchases, and the project used the Unibill plugin, respectively, the tracking of the bills was wrapped up by this plug-in and the code that caused the tracking of the bills from the publisher I called from the native part of the Unibill sources.  This solution was used only because the publisher did not give the time to write the Unity plugin based on the native and the integration itself took half an hour. </li><li>  Use native Unity3d functionality implemented in the iOS project.  The downside is that this functionality is not documented.  However, it is used by Google Analytics and Fb SKD plugins for Unity. </li></ul><br>  Since the current project used the FB SDK, and there was enough time, it was decided to understand what was happening under the hood of the XCode project that Unity generates. <br><br>  The FB plugin for Unity includes two files that are most interested in FbUnityInterface.mm and .h, which contain the native code for iOS. <br><br>  In the .mm file catches the eye this code: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didBecomeActive: (<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span> *)notification { [FBAppCall handleDidBecomeActiveWithSession:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session]; } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)willTerminate:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span> *)notification { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session close]; } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didFinishLaunching:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span> *)notification {</code> </pre><br>  It looks like the FB intercepts calls to the standard delegate methods of the application.  In the header file we see the following sinks: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#if UNITY_VERSION &gt;= 430 #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"AppDelegateListener.h"</span></span></span><span class="hljs-meta"> @interface FbUnityInterface : NSObject </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;AppDelegateListener&gt;</span></span></span></span></code> </pre><br>  AppDelegateListener.h is located in the project's Classes / PluginBase / Xcode directory.  In order to intercept delegate events, Unity describes 4 protocols.  For those who are not familiar with the concept of protocol Objective C - <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/WorkingwithProtocols/WorkingwithProtocols.html">English version</a> and <a href="http://macbug.ru/cocoa/objc2">Russian version of the documentation</a> . <br><br>  The main protocol is LifeCycleListener.  Two of the three remaining protocols expand it.  It allows you to listen to events: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didFinishLaunching:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didBecomeActive:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)willResignActive:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didEnterBackground:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)willEnterForeground:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)willTerminate:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span>*)notification;</code> </pre><br>  And also declares 2 methods: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UnityRegisterLifeCycleListener(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;LifeCycleListener&gt; obj); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UnityUnregisterLifeCycleListener(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;LifeCycleListener&gt; obj);</code> </pre><br>  The first method signs the object to receive the listed events, the second one writes it down.  Next, consider the AppDelegateListener protocol: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppDelegateListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifeCycleListener</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  It gives access to messages about Push Notifications, opening ULR applications and some others. All messages that are available to the class that implements AppDelegateListener can be viewed in AppDelegateListener.mm. <br><br>  RenderPluginDelegate provides access to Unity render events and also extends LifeCycleListener.  The source code contains good comments and information on all methods can be obtained from there. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RenderPluginDelegate</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifeCycleListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  The last in line is the UnityViewControllerLIstener protocol.  It allows you to access the main events of the main view of the application.  This protocol has no dependency on LifeCycleListener.  List of events: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidDisappear: - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewWillDisappear: - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidAppear: - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewWillAppear: - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)interfaceWillChangeOrientation: - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)interfaceDidChangeOrientation:</code> </pre><br>  From the source code of the Fb SDK, you can see that these features appeared in Unity3d only starting from version 4.3. <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#if HAS_UNITY_VERSION_DEF #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UnityTrampolineConfigure.h"</span></span></span><span class="hljs-meta"> #endif #if UNITY_VERSION &gt;= 430 #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"AppDelegateListener.h"</span></span></span><span class="hljs-meta"> @interface FbUnityInterface : NSObject </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;AppDelegateListener&gt;</span></span></span><span class="hljs-meta"> #else</span></span></code> </pre><br>  The HAS_UNITY_VERSION_DEF constant storing information that the project has information about the version of Unity3d used to build the project is declared in the RegisterMonoModules.h header file: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> RegisterMonoModules(); <span class="hljs-meta"><span class="hljs-meta">#define HAS_UNITY_VERSION_DEF 1</span></span></code> </pre><br>  This is all the contents of RigisterMonoModules.h.  If HAS_UNITY_VERSION_DEF is declared in the project, then for the value of the Unity3d version you can refer to the UNITY_VERSION constant.  Thus, if you are using Unity3d version lower than 4.3, then you should not count on the presence of the four protocols described above. <br><br>  For some native plugins, it may be necessary to have one or another key in the native application .plist file.  In fact, plist can be made equivalent to xml.  The Fb SDK includes the FbPlistParser and PlistDic sources, which can be used to add the key that your plugin needs.  For example, you can add a script with <a href="http://docs.unity3d.com/412/Documentation/ScriptReference/PostProcessBuildAttribute.html">PostProcessBuildAttribute</a> to a project so that when the project is finished building, find the plist file in the XCode project and add the necessary keys with values ‚Äã‚Äãto it. <br><br>  I hope that this information was useful and helped someone in the fight against native plugins. </div><p>Source: <a href="https://habr.com/ru/post/266893/">https://habr.com/ru/post/266893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266879/index.html">Grandstream GVC 3200 Video Conferencing Solution Review - ‚ÄúIt Changes Everything‚Äù</a></li>
<li><a href="../266881/index.html">Using Java 8 Libraries for Android Applications with Maven</a></li>
<li><a href="../266883/index.html">How Russian cloud services for business inhibit their own market</a></li>
<li><a href="../266885/index.html">Google's Faces API Example</a></li>
<li><a href="../266891/index.html">Inoventica Services on Habr√©</a></li>
<li><a href="../266895/index.html">HTML5 customization customization element</a></li>
<li><a href="../266897/index.html">Implementing a pseudo-random number generator on a FPGA using Vivado HLS 2014.4</a></li>
<li><a href="../266899/index.html">Reinforced.Typings is a library for automatically generating TypeScript-taipings and not only</a></li>
<li><a href="../266901/index.html">Using handle and intrusive reference counter-s in multi-threaded environments in the C language</a></li>
<li><a href="../266903/index.html">PSR-2, the analysis of one item of the standard. Spaces or tabs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>