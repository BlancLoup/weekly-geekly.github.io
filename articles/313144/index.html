<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>QEMU / KVM and Windows installation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Whether we like it or not, programs for which Windows is needed have not disappeared from offices anywhere. In a situation where there is no alternati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>QEMU / KVM and Windows installation</h1><div class="post__text post__text-html js-mediator-article"><p>  Whether we like it or not, programs for which Windows is needed have not disappeared from offices anywhere.  In a situation where there is no alternative to using them, it is better to have a virtual OS, for example, in order to connect to an audio conference via Skype for Business. </p><br><img src="https://habrastorage.org/files/474/3ff/1f8/4743ff1f819042c0af488e44875a2599.png"><br><p><br>  In this article, I will tell you how to install the guest Windows OS on the <code>QEMU</code> hypervisor using the <code>virt-manager</code> GUI with minimal cost.  We will map all the pitfalls and reefs, and carefully place the bugs in the bank. </p><a name="habracut"></a><br><h2>  Training </h2><br><p>  The very first step is to configure the kernel parameters.  Support for <code>KVM</code> and <code>vhost-net</code> , support for tunnel interfaces <a href="https://habr.com/ru/post/313144/"><sup>[1]</sup></a> and network bridge <a href="https://habr.com/ru/post/313144/"><sup>[2] is</sup></a> desirable.  Full listing on the <a href="https://wiki.gentoo.org/wiki/QEMU">Gentoo QEMU wiki page</a> . </p><br><p>  Prepare disk space.  I allocated 70 GiB, and Windows 8.1 for a couple of months used almost 50 GiB so that I did not have enough disk space to upgrade to the 10th version. </p><br><p>  Next, we need a set of <code>virtio-win</code> Redhat drivers.  If you have RedHat installed, just run </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@server ~</span></span>]<span class="hljs-meta"><span class="hljs-meta"># yum install virtio-win</span></span></code> </pre> <br><p>  and the iso image will be written to the <code>/usr/share/virtio-win/</code> directory.  You can also download it <a href="https://fedoraproject.org/wiki/Windows_Virtio_Drivers">from the Fedora repositories</a> . <br>  <em>Ensure that hardware virtualization support is enabled in BIOS / UEFI</em> .  Without this, <code>KVM</code> <b>will not be activated</b> , and <code>virt-manager</code> will produce just such an error. </p><br><img src="https://habrastorage.org/files/f32/3da/496/f323da496d2d4a06a3eac76bfbf8e678.png"><br><p><br>  As a test, you can read the device file. </p><br><pre> <code class="hljs pgsql">(<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">506</span></span>)$ ll /dev/kvm crw-rw<span class="hljs-comment"><span class="hljs-comment">----+ 1 root kvm 10, 232  9 02:29 /dev/kvm</span></span></code> </pre> <br><p>  If the file is not found, and the kernel options are set correctly, then it‚Äôs about the <code>BIOS/UEFI</code> settings. <br>  Install the necessary packages. </p><br><pre> <code class="hljs ruby">(<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">519</span></span>)$ sudo emerge -av qemu virt-manager</code> </pre> <br><p>  For RedHat 7, it is enough to install only <code>virt-manager</code> , since <code>QEMU</code> installed by default. </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@server ~</span></span>]<span class="hljs-meta"><span class="hljs-meta"># yum install virt-manager</span></span></code> </pre> <br><p>  Debian users need to install the <code>qemu</code> package. </p><br><pre> <code class="hljs objectivec">root<span class="hljs-meta"><span class="hljs-meta"># aptitute install qemu</span></span></code> </pre> <br><p>  You can now proceed to the installation. </p><br><h2>  Launch and installation </h2><br><p>  Run <code>virt-manager</code> and create a new virtual machine from local storage. </p><br><img src="https://habrastorage.org/files/c14/ad0/762/c14ad0762b084d4bab3df0d64cb13a78.png"><br><p><br>  Specify the path to the installation iso image of Windows. </p><br><img src="https://habrastorage.org/files/28b/90e/9a1/28b90e9a1415433ab26bfc246c17002a.png"><br><p><br>  Next, at the 3rd and 4th step there will be a choice of the number of CPUs, the amount of RAM and the size of the disk space, then at the 5th step you <u>should select additional configurations before tuning</u> . </p><br><img src="https://habrastorage.org/files/b5f/a49/0fb/b5fa490fbe584355a7d1f750058d9500.png"><br><p><br>  The advanced settings window is needed in order to perform a feint with your ears.  Its meaning is to add a virtual flopar with drivers from the <code>virtio-win</code> .  <em>This will make it possible to change the type of hard disk: remove the disk with the IDE bus and add it the same, but with the VirtIO bus</em> .  In detail, <a href="https://goo.gl/Ws3OCm">in the docks of RedHat</a> . </p><br><img src="https://habrastorage.org/files/fef/a3f/f84/fefa3ff8458f4df9be366f28ecd7f184.png"><br><p><br>  Register the driver <code>/usr/share/virtio-win/virtio-win.vfd</code> and add a virtual floppy disk.  Then go to the <code>[]  ‚Ññ</code> tab <code>[]  ‚Ññ</code> and make a feint with the replacement of the tire bus: delete with the IDE and add with VirtIO. </p><br><img src="https://habrastorage.org/files/4ac/bb4/b93/4acbb4b93f494e62a98c4eb2587d732d.png"><br><p><br>  I almost forgot to say why this trick is needed.  Experts say that <em>with the VirtIO bus, disk performance is significantly higher</em> . </p><br><p>  In principle, it is already possible to start the installation, but we forgot to add a CD-ROM with <code>virtio-win</code> drivers, and they will be useful to us when the device manager flashes yellow icons of the question mark. </p><br><img src="https://habrastorage.org/files/a8d/93a/336/a8d93a336e9a4a56be2d4f1a74a23667.png"><br><p><br>  Well, now you can start the installation. </p><br><img src="https://habrastorage.org/files/2c9/f10/a71/2c9f10a71cfd49cbad915b2931b10f87.jpg"><br><p><br>  Well, we started the installation.  What if the Windows installer asks you <b>to change the disk</b> ?  Because of this, I had to interrupt a couple of times and start the whole carousel again, but this <a href="http://www.linux-kvm.org/page/Change_cdrom">will not happen to you</a> . </p><br><pre> <code class="hljs sql">(qemu) <span class="hljs-keyword"><span class="hljs-keyword">change</span></span> ide1-cd0 /tmp/windows_8<span class="hljs-number"><span class="hljs-number">.1</span></span>_x64_disk2.iso</code> </pre> <br><h2>  Drivers and tweaks </h2><br><p>  At the end of the installation process, the device manager will miss some of the drivers.  Presumably, these may be: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Ethernet</span></span> Controller PCI Simple Communication Controller SCSI Controller</code> </pre> <br><p>  You need to feed them the driver from the <code>virtio-win</code> kit, which is connected via the IDE CD-ROM in the previous section. </p><br><img src="https://habrastorage.org/files/eae/68f/a09/eae68fa093f442e1999d38897dd2bdf6.png"><br><p><br>  This is done standardly: right-click on the yellow question mark, update the driver, the path to the files. </p><br><img src="https://habrastorage.org/files/052/042/dc2/052042dc2eb9483e9357e0a418b2910a.png"><br><p><br>  Here is the entire list, and this is the <a href="https://goo.gl/YjM9la">next page of RedHat docks</a> , where the driver installation is shown in more detail. </p><br><ul><li>  <i>Balloon</i> , controller of the balloon driver in the System devices group. </li><li>  <i>Vioserial</i> , the serial driver, affects the PCI Simple Communication Controller in the System devices group. </li><li>  <i>NetKVM</i> , the network driver, affects the Network adapters group.  This driver is only available if a virtio NIC is configured.  In the E, NetKVM Driver Parameters. </li><li>  <i>viostor</i> , the block driver, affects the Disk drives group.  This driver is only available if a virtio disk is configured. </li></ul><br><h3>  Equipment </h3><br><p>  Here the area of ‚Äã‚Äãendless possibilities and 101 ways to do it in its own way gradually begins, so I will show how it works for me, and you can customize it more precisely to fit your needs. </p><br><img src="https://habrastorage.org/files/017/3dd/67e/0173dd67e50c4028922da797f9def37d.png"><br><p><br>  I have the <code> Spice</code> display and the <code>ich6</code> sound device <code>ich6</code> .  No, of course, if you have a lot of time and a desire to figure everything out to the very subtleties - dare and try alternative approaches, but my sound took off, rather vibrated, only with such settings.  In the second part, devoted to walking around the rake and catching bugs, I will tell about it in more detail.  In the video tab, I put <code>QXL</code> , because with this option, thanks to the <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D895356">magic driver</a> , I managed to achieve a normal screen resolution. </p><br><p>  Connect to the VM can be varied. </p><br><ol><li>  Through the virt-manager GUI </li><li>  Select the VNC server display and connect via the vnc client </li><li>  Install Spice client and connect through it </li><li>  You can connect to Windows via rdp if the terminal server is enabled. </li></ol><br><p>  I have option 3, for Gentoo, this is <code>spice-gtk</code> </p><br><pre> <code class="diff hljs">$ eix spice-gtk [I] net-misc/spice-gtk  : 0.31 ~0.32-r1 ~0.32-r2 **9999 {dbus gstaudio gstreamer gstvideo gtk3 +introspection libressl lz4 mjpeg policykit pulseaudio python sasl smartcard static-libs usbredir vala webdav PYTHON_SINGLE_TARGET="python2_7 python3_4" PYTHON_TARGETS="python2_7 python3_4"}  : 0.31(16:05:41 18.06.2016)(gtk3 introspection pulseaudio python usbredir -dbus -gstreamer -libressl -lz4 -policykit -sasl -smartcard -static-libs -vala -webdav PYTHON_SINGLE_TARGET="python2_7 -python3_4" PYTHON_TARGETS="python2_7 python3_4")  : http://spice-space.org https://cgit.freedesktop.org/spice/spice-gtk/ : Set of GObject and Gtk objects for connecting to Spice servers and a client GUI</code> </pre> <br><h3>  Network </h3><br><p>  The network for the VM can be configured differently, on Habr√©, the craftsmen have already <a href="https://habrahabr.ru/post/120717/">written about this</a> .  I tried several ways, and at the end simplicity again took up.  The VM itself is launched from under the root <a href="https://habr.com/ru/post/313144/"><sup>[3]</sup></a> , but the <code>spice-gtk</code> graphical interface is launched from the usual unprivileged user.  This allows us to solve the dilemma: for network options, root rights are needed, and for the pulseaudio sound daemon, the root is prohibited.  I tried to hang all the rights to a regular user, but nothing worked, the pulse does not pulsate, the network is not created, there is a lot of information and there is little.  In the end, decided so pleased.  I would be glad if the best way is found in the comments. </p><br><img src="https://habrastorage.org/files/fb5/7eb/584/fb57eb58441847ca87e64a1a65e572ee.png"><br><p><br>  This simple selection of network options gives you superior results.  3 additional network interfaces are created: <em>virbr0, virbr0-nic, vnet0</em> . </p><br><pre> <code class="diff hljs">$ ip addr ... 4: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 52:54:00:cc:2a:1e brd ff:ff:ff:ff:ff:ff inet 192.168.102.1/24 brd 192.168.102.255 scope global virbr0 valid_lft forever preferred_lft forever 5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000 link/ether 52:54:00:cc:2a:1e brd ff:ff:ff:ff:ff:ff 11: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN group default qlen 1000 link/ether fe:54:00:fb:50:45 brd ff:ff:ff:ff:ff:ff inet6 fe80::fc54:ff:fefb:5045/64 scope link valid_lft forever preferred_lft forever</code> </pre> <br><p>  In <code>iptables</code> , a set of rules is created, here are the main ones: </p><br><pre> <code class="hljs vhdl">$ sudo iptables -L ... Chain FORWARD (policy ACCEPT) target prot opt source destination ACCEPT <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-comment"><span class="hljs-comment">-- anywhere 192.168.102.0/24 ctstate RELATED,ESTABLISHED ACCEPT all -- 192.168.102.0/24 anywhere</span></span></code> </pre> <br><p>  Windows VM: </p><br><pre> <code class="diff hljs">C:\Users\user&gt;ipconfig Windows IP Configuration Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Link-local IPv6 Address . . . . . : fe80::90c3:a458:6645:7b9a%7 IPv4 Address. . . . . . . . . . . : 192.168.102.203 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.102.1 Tunnel adapter isatap.{BD8F0DA4-92A8-42BD-A557-23AC89AED941}: Media State . . . . . . . . . . . : Media disconnected Connection-specific DNS Suffix . : Tunnel adapter IPHTTPSInterface: Connection-specific DNS Suffix . : IPv6 Address. . . . . . . . . . . : 2620:0:a13:8a7:51af:79ae:92b8:828a Temporary IPv6 Address. . . . . . : 2620:0:a13:8a7:b49d:81fe:e509:16e7 Link-local IPv6 Address . . . . . : fe80::51af:79ae:92b8:828a%15 Default Gateway . . . . . . . . . :</code> </pre> <br><p>  <u>I repeat, libvirtd creates all this on its own, no need to do anything for it</u> .  As a result, we have normal routing between the host and the VM, we can exchange files via <code>ssh / scp</code> .  You can go ahead and create a ball on Windows, and on a Linux host, configure samba, but this seemed redundant to me. </p><br><h2>  In conclusion </h2><br><p>  It‚Äôs hard to tell in one article about all aspects of Windows + QEMU / KVM, so let's end with the next.  And there will be the most gusto, command interface, screen resolution a maximum of 1024x768, Scylla pulseaudio and Charybdis network, the <code>virsh</code> command and VM setup from the config file, file with <code>tpm</code> , binary device syntax and other quiet joys. </p><br><hr><br><ol><li><a name="cite_ref-1"></a>  <a href="https://habr.com/ru/post/313144/">‚Üë</a> TUN / TAP interfaces </li><li><a name="cite_ref-2"></a>  <a href="https://habr.com/ru/post/313144/">‚Üë</a> Ethernet bridging </li><li><a name="cite_ref-3"></a>  <a href="https://habr.com/ru/post/313144/">‚Üë</a> From English root </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/313144/">https://habr.com/ru/post/313144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313132/index.html">VK rake SDK for Android</a></li>
<li><a href="../313134/index.html">Acyclic Visitor</a></li>
<li><a href="../313136/index.html">Karate Motivation: How to stop worrying about inefficient employees?</a></li>
<li><a href="../313138/index.html">Kinematics modeling is not difficult</a></li>
<li><a href="../313142/index.html">Joker 2016 Java Conference: More, More, More Interesting</a></li>
<li><a href="../313146/index.html">OpenShift + Jenkins + Bitbucket, continuous integration and publishing out of the box</a></li>
<li><a href="../313148/index.html">The best projects of the telecom hackathon TADHack Moscow 2016</a></li>
<li><a href="../313150/index.html">DPDK Introduction: Architecture and Operation</a></li>
<li><a href="../313152/index.html">Esoteric language Piet</a></li>
<li><a href="../313156/index.html">Useful life hacking: answering the most popular questions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>