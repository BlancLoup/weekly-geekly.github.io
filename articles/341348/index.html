<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript, Node, Puppeteer: Chrome Automation and Web Scraping</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The puppeteer library for Node.js allows you to automate the work with the Google Chrome browser. In particular, with the help of puppeteer you can cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript, Node, Puppeteer: Chrome Automation and Web Scraping</h1><div class="post__text post__text-html js-mediator-article"> The <a href="https://github.com/GoogleChrome/puppeteer">puppeteer</a> library for Node.js allows you to automate the work with the Google Chrome browser.  In particular, with the help of <code>puppeteer</code> you can create programs for automatic data collection from web sites, so-called web scrapers, imitating the actions of a regular user.  In such scenarios, a browser without a user interface, the so-called ‚ÄúHeadless Chrome‚Äù, can be used.  Using <code>puppeteer</code> , you can control the browser, which is running normally, which is especially useful when debugging programs. <br><br><div style="text-align:center;"> <a href="https://habrahabr.ru/company/ruvds/blog/341348/"><img src="https://habrastorage.org/getpro/habr/post_images/4ed/df8/7a0/4eddf87a0d6a492dc0eccc32a75effa8.png" alt="image"></a> </div><br>  Today we will talk about creating a web scraper based on Node.js and <code>puppeteer</code> .  The author of the material sought to ensure that the article was interesting to the widest possible audience of programmers, therefore, those web developers who already have some experience with <code>puppeteer</code> and those who first encounter such a concept as ‚Äú Headless Chrome. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Preliminary preparation</font> </h2><br>  Before you start, you need Node 8+.  You can find and download it <a href="https://nodejs.org/en/">here</a> by selecting the current (Current) version.  If you've never worked with Node before, take a look at <a href="https://codeburst.io/learn-node-js-the-3-best-online-node-js-courses-87e5841f4c47">these training courses</a> or look for other materials, good enough, plenty of them on the Web. <br><br>  After installing Node, create a folder for the project and install <code>puppeteer</code> .  Along with it, the current version of Chromium will be installed, which is guaranteed to work with the API of interest to us.  You can do this with the following command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-comment"><span class="hljs-comment">--save puppeteer</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Example # 1: Making Screen Copies</font> </h2><br>  After installing <code>puppeteer</code> let's take a simple example.  He, with minor changes, repeats the documentation for the library.  The code that we are going to look at now makes a screenshot of the given web page. <br><br>  First, create a file <code>test.js</code> and put the following into it: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">'https://google.com'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.screenshot({<span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'google.png'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } getPic();</code> </pre> <br>  Disassemble this code line by line.  First we show the big picture. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>);</code> </pre> <br>  In this line, we include the previously installed <code>puppeteer</code> library as a dependency. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... }</code> </pre> <br>  Here is the main function, <code>getPic()</code> .  This function contains code that automates the work with the browser. <br><br><pre> <code class="hljs lisp">getPic()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  In this line, we call the <code>getPic()</code> function, that is, execute it. <br><br>  It is important to note that the <code>getPic()</code> function is asynchronous, it is defined with the <code>async</code> .  It uses the <code>async / await</code> construction from ES 2017. Since <code>getPic()</code> is an asynchronous function, it returns a <code>Promise</code> object when called.  Such objects are usually called "promises".  When a function defined with the <code>async</code> terminates and returns a value, the promise will either be allowed (if the operation completes successfully) or is rejected (if an error occurs). <br><br>  Due to the use of the <code>async</code> keyword when defining a function, we can execute calls of other functions in it with the <code>await</code> keyword.  It suspends the execution of the function and allows waiting for the permission of the corresponding promise, after which the function will continue.  If this is all you do not understand yet - just read further and gradually everything will start to fall into place. <br><br>  Now let's <code>getPic()</code> function code. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch();</code> </pre> <br>  Here we run <code>puppeteer</code> .  In fact, this means that we launch an instance of the Chrome browser and write a link to it in the <code>browser</code> constant just created.  Since the <code>await</code> keyword is used in this line, the execution of the main function will be suspended until the corresponding promise is enabled.  In this case, this means waiting for either the successful launch of the Chrome instance or the occurrence of an error. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage();</code> </pre> <br>  Here we create a new page in the browser, controlled by the program code.  Namely, we request this operation, we wait for its completion and we write down the link to the page in <code>page</code> constant. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span>(<span class="hljs-string"><span class="hljs-string">'https://google.com'</span></span>);</code> </pre> <br>  Using the <code>page</code> variable created in the previous line, we can give the page a command to go to the specified URL.  In this example, we are going to <code>https://google.com</code> .  The execution of the code, as in the previous lines, will pause until the completion of the operation. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">await</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.screenshot</span></span>({<span class="hljs-attribute"><span class="hljs-attribute">path</span></span>: <span class="hljs-string"><span class="hljs-string">'google.png'</span></span>});</code> </pre> <br>  Here we request <code>puppeteer</code> create a screenshot of the current page represented by the <code>page</code> constant.  The <code>screenshot()</code> method takes, as a parameter, an object.  Here you can specify the path by which you want to save the screenshot in <code>.png</code> format.  Again, the <code>await</code> keyword is used here, which causes the function to be suspended until the operation is completed. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close();</code> </pre> <br>  The <code>getPic()</code> function <code>getPic()</code> and we close the browser. <br><br><h2>  <font color="#3AC1EF">Run example</font> </h2><br>  The above code, stored in the <code>test.js</code> file, can be run using Node as follows: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">node</span></span> test.js</code> </pre> <br>  Here's what happens after he successfully runs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66a/8db/ca5/66a8dbca5b15566f395ec6bf4163279c.png"><br><br>  Wonderful!  And now, so that it is more fun (and to make debugging easier), we can do the same thing by running Chrome in the normal way. <br><br>  What would it mean?  Try it and see for yourself.  To do this, replace this line of code: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch();</code> </pre> <br>  On this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({headless: <span class="hljs-literal"><span class="hljs-literal">false</span></span>});</code> </pre> <br>  Save the file and run it again using Node: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">node</span></span> test.js</code> </pre> <br>  Great, right?  By <code>{headless: false}</code> object as a parameter when launching the browser, we can observe how the code controls the operation of Google Chrome. <br>  Before we go further, we'll do something else.  Have you noticed that the screenshot that the program makes includes only part of the page?  This is due to the fact that the browser window is slightly smaller than the size of the web page.  You can fix this by using the following line, which changes the size of the window: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">await</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.setViewport</span></span>({<span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, height: <span class="hljs-number"><span class="hljs-number">500</span></span>})</code> </pre> <br>  It must be added to the code immediately after the command to go to the URL.  This will cause the program to make a screenshot that looks much better: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f92/35c/305/f9235c305a20fdfc6c6011658dca2751.png"><br><br>  Here‚Äôs what the final version of the code will look like: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({<span class="hljs-attr"><span class="hljs-attr">headless</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">'https://google.com'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.setViewport({<span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">500</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.screenshot({<span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'google.png'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } getPic();</code> </pre> <br><h2>  <font color="#3AC1EF">Example 2: web scraping</font> </h2><br>  Now that you have mastered the basics of Chrome automation using <code>puppeteer</code> , let's look at a more complex example in which we will collect data from web pages. <br><br>  First you should look at the <a href="">documentation</a> for <code>puppeteer</code> .  You can pay attention to the fact that there are a huge number of different methods that allow us not only to simulate mouse clicks on page elements, but also to fill out forms and read data from pages. <br><br>  We will collect data from the <a href="http://books.toscrape.com/">Books To Scrape</a> website.  This is an imitation of an electronic bookstore created for web scraping experiments. <br><br>  In the same directory as the <code>test.js</code> file, create a <code>scrape.js</code> file and paste the following blank there: <br><br><pre> <code class="hljs coffeescript">const puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>); let scrape = async () =&gt; { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ... <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   }; scrape().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(value); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ! });</code> </pre> <br>  Ideally, after parsing the first example, you should already understand how this code works.  But if this is not the case - no big deal. <br><br>  In this snippet we connect the previously installed <code>puppeteer</code> .  Next, we have the <code>scrape()</code> function, in which, below, we will add the code for scraping.  This function will return some value.  Finally, we call the <code>scrape()</code> function and work with what it returned.  In this case, just output it to the console. <br><br>  Check this code by adding a line to the <code>scrape()</code> function: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> scrape = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'test'</span></span>; };</code> </pre> <br>  After this, run the program with the <code>node scrape.js</code> .  The word <code>test</code> should appear in the console.  The efficiency of the code, we confirmed the desired value falls into the console.  Now you can do web scraping. <br><br><h3>  <font color="#3AC1EF">‚ñç Step 1: Setup</font> </h3><br>  First you need to create a browser instance, open a new page and go to the URL.  Here's how we do it all: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> scrape = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({headless: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span>(<span class="hljs-string"><span class="hljs-string">'http://books.toscrape.com/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.waitFor(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    browser.close(); return result; };</span></span></code> </pre> <br>  Let's sort this code. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({headless: <span class="hljs-literal"><span class="hljs-literal">false</span></span>});</code> </pre> <br>  In this line, we create an instance of the browser and set the <code>headless</code> parameter to <code>false</code> .  This allows us to observe what is happening. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage();</code> </pre> <br>  Here we create a new page in the browser. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span>(<span class="hljs-string"><span class="hljs-string">'http://books.toscrape.com/'</span></span>);</code> </pre> <br>  Go to <code>http://books.toscrape.com/</code> . <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.waitFor(<span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre> <br>  Here we add a delay of 1000 milliseconds in order to give the browser time to fully load the page, but usually this step can be omitted. <br><br><pre> <code class="hljs pgsql">browser.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre> <br>  Here we close the browser and return the result. <br><br>  Preliminary preparation is complete, now we will be engaged in scraping. <br><br><h3>  <font color="#3AC1EF">‚ñçStep 2: scraping</font> </h3><br>  As you have probably understood, there is a large catalog of real books with conditional data on Books To Scrape.  We are going to take the first book located on the page and return its name and price.  Here is the home page of the site.  Click on the first book (it is highlighted with a red frame). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d25/ae7/fe0/d25ae7fe05c3219fd02f15bbb95f449c.png"><br><br>  In the <code>puppeteer</code> documentation, you can find a method that allows you to simulate mouse clicks on the page: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.click</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">selector</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[, options]</span></span>)</code> </pre> <br>  The construction of the <code>selector &lt;string&gt;</code> is a selector for searching for an element that needs to be clicked.  If several elements are found that satisfy the selector, then a click will be made on the first one. <br><br>  It‚Äôs very good that the Google Chrome developer‚Äôs tools allow you to define a specific element selector without much difficulty.  In order to do this, simply click the right mouse button on the image and select the <code>Inspect</code> command. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d36/ec3/330/d36ec33304df998fa646d97142efdc28.png"><br><br>  This command will open the <code>Elements</code> panel, in which the page code will be displayed, a fragment of which corresponding to the element of interest to us will be highlighted.  After that you can click on the button with three dots on the left and in the appeared menu select the command <code>Copy ‚Üí Copy selector</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22a/ec1/999/22aec1999b2349088540f96bae01007c.png"><br><br>  Fine!  Now we have a selector and everything is ready to form the <code>click</code> method and insert it into the program.  Here is what it will look like: <br><br><pre> <code class="hljs erlang">await page.click('#default &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> &gt; section &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span>:nth-child(<span class="hljs-number"><span class="hljs-number">2</span></span>) &gt; ol &gt; li:nth-child(<span class="hljs-number"><span class="hljs-number">1</span></span>) &gt; article &gt; <span class="hljs-keyword"><span class="hljs-keyword">div</span></span>.image_container &gt; a &gt; img');</code> </pre> <br>  Now the program simulates a click on the first product image, which leads to the opening of the product page. <br><br>  On this new page we are interested in the name of the book and its price.  They are highlighted in the figure below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d0a/8da/1ca/d0a8da1ca5223f2d70b968d34d44478f.png"><br><br>  To get to these values, we will use the <code>page.evaluate()</code> method.  This method allows you to use JavaScript methods to work with the DOM, like <code>querySelector()</code> . <br><br>  First, <code>page.evaluate()</code> call the <code>page.evaluate()</code> method and set the value returned to it to the <code>result</code> constant: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// -  });</span></span></code> </pre> <br>  In this function, we can select the necessary elements.  In order to understand how to describe what we need, we‚Äôll use the Chrome developer tools again.  To do this, right-click on the book title and select the <code>Inspect</code> command. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a5/198/218/1a51982185ce417576b0f59e8d8e8b27.png"><br><br>  In the <code>Elements</code> panel you can see that the title of the book is the usual first-level heading, <code>h1</code> .  This item can be selected using the following code: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> title = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>);</code> </pre> <br>  Since we need the text contained in this element, we will need to use the <code>.innerText</code> property.  As a result, we arrive at the following construction: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> title = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>).innerText;</code> </pre> <br>  The same approach will help us figure out how to get the price of the book from the page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/95d/ced/b1a/95dcedb1ac9abb4cd191abcec1b76a0e.png"><br><br>  You may notice that the line with the price corresponds to the class <code>price_color</code> .  We can use this class to select an element and read the text contained in it: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> price = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'.price_color'</span></span>).innerText;</code> </pre> <br>  Now that we‚Äôve pulled the book‚Äôs name and price out of the page, we can return all of this from the function as an object: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { title, price }</code> </pre> <br>  The result is the following code: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> title = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>).innerText; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> price = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'.price_color'</span></span>).innerText; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { title, price } });</code> </pre> <br>  Here we read the name of the book and the price from the page, save them in the object and return this object, which results in its being written to <code>result</code> . <br><br>  Now it remains only to return the <code>result</code> constant and output its contents to the console. <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre> <br>  The full code for this example will look like this: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> scrape = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; {   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({<span class="hljs-attr"><span class="hljs-attr">headless</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>});   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage();   <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">'http://books.toscrape.com/'</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.click(<span class="hljs-string"><span class="hljs-string">'#default &gt; div &gt; div &gt; div &gt; div &gt; section &gt; div:nth-child(2) &gt; ol &gt; li:nth-child(1) &gt; article &gt; div.image_container &gt; a &gt; img'</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.waitFor(<span class="hljs-number"><span class="hljs-number">1000</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> title = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>).innerText;       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> price = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'.price_color'</span></span>).innerText;       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {           title,           price       }   });   browser.close();   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; scrape().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) =&gt;</span></span> {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(value); <span class="hljs-comment"><span class="hljs-comment">// ! });</span></span></code> </pre> <br>  Now you can run the program using Node: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">node</span></span> scrape.js</code> </pre> <br>  If everything is done correctly, the title of the book and its price will be displayed in the console: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">title</span></span>: <span class="hljs-string"><span class="hljs-string">'A Light in the Attic'</span></span>, price: <span class="hljs-string"><span class="hljs-string">'¬£51.77'</span></span> }</code> </pre> <br>  As a matter of fact, all this is web scraping and you have just taken the first steps in this lesson. <br><br><h2>  <font color="#3AC1EF">Example number 3: improving the program</font> </h2><br>  Here you may have quite reasonable questions: ‚ÄúWhy click on the link leading to the page of the book, if both its name and price are displayed on the home page?  Why not take them straight from there?  And if we were able to do this, why not read the titles and prices of all the books? ‚Äù <br><br>  The answer to these questions is that there are many approaches to web scraping!  In addition, if we limit ourselves to the data displayed on the home page, you may encounter the fact that book titles will be shortened.  However, all these reflections give you a great opportunity to practice. <br><br><h3>  <font color="#3AC1EF">‚ñçTask</font> </h3><br>  Your goal is to read all the titles of the books and their prices from the home page and return them as an array of objects.  Here is what array I got: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ce/984/dea/6ce984dea4ccbfdf413f2d7bab8b8d1f.png"><br><br>  You can proceed.  Do not read further, try to do everything yourself.  I must say that this task is very similar to the one we just solved. <br><br>  Happened?  If not, then here is a hint. <br><br><h3>  <font color="#3AC1EF">‚ñçTip</font> </h3><br>  The main difference of this task from the previous example is that here we need to go through the list of data.  Here's how to do it: <br><br><pre> <code class="hljs ruby">const result = await page.evaluate(() =&gt; { let data = []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    let elements = document.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'xxx'</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   /<span class="hljs-regexp"><span class="hljs-regexp">/         /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     data.push({title, price}); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     return data; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     });</span></span></code> </pre> <br>  If you still fail to solve the problem, there is nothing to worry about.  This is a matter of practice.  Here is one of the possible options for its solution. <br><br><h3>  <font color="#3AC1EF">‚ñç Solving the problem</font> </h3><br><pre> <code class="hljs coffeescript">const puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span>); let scrape = async () =&gt; {   const browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({headless: <span class="hljs-literal"><span class="hljs-literal">false</span></span>});   const page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage();   <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">'http://books.toscrape.com/'</span></span>);   const result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {       let data = []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>             let elements = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'.product_pod'</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>          <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var element <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> elements){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>                 let title = element.childNodes[<span class="hljs-number"><span class="hljs-number">5</span></span>].innerText; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>             let price = element.childNodes[<span class="hljs-number"><span class="hljs-number">7</span></span>].children[<span class="hljs-number"><span class="hljs-number">0</span></span>].innerText; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>             data.push({title, price}); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>             }       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     });   browser.close();   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   }; scrape().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(value); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ! });</code> </pre> <br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  From this material, you learned how to use the Google Chrome browser and the Puppeteer library to create a web scraping system.  Namely, we looked at the structure of the code, the methods of browser control, the method of creating screen copies, the methods of simulating the user's work with the page, and the approaches to reading and saving data placed on web pages.  If this was your first encounter with web scraping, we hope you now have everything you need to get everything you need from the Internet. <br><br>  Dear readers!  Do you use the Puppeteer library and Google Chrome browser without a user interface? </div><p>Source: <a href="https://habr.com/ru/post/341348/">https://habr.com/ru/post/341348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341336/index.html">Review of the reports of the conference Mobius 2017 Moscow - leap of faith in mobile technology</a></li>
<li><a href="../341338/index.html">Bitcoin and Security Software Wallets</a></li>
<li><a href="../341340/index.html">SAP HANA Support: New Features</a></li>
<li><a href="../341344/index.html">Threat Hunting: A new fileless attack for crypto mining has been discovered.</a></li>
<li><a href="../341346/index.html">10 Lessons from the Quora Recommender System</a></li>
<li><a href="../341350/index.html">Typical beginner problems when working with Docker (video from the conference)</a></li>
<li><a href="../341352/index.html">FrontFest.Keynote - Blaine Cook (creator of OAuth) and Mateus Fernandez (CTO Zeit)</a></li>
<li><a href="../341354/index.html">Bayram Annakov (CEO App in the Air): How to do the right onboarding</a></li>
<li><a href="../341356/index.html">Digest: ITMO University developments in 2017</a></li>
<li><a href="../341360/index.html">Deobfuscation of a single script with popups</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>