<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing an Android application with Cloud to Device Messaging (C2DM) support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, readers Habrahabr! 

 In this post I want to pay attention to the C2DM service from Google and try to tell you how to implement support for thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing an Android application with Cloud to Device Messaging (C2DM) support</h1><div class="post__text post__text-html js-mediator-article"> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/9c/25/9c2506f1622db60eee6e0db21e3c72e3.png"></a> <br><br>  Hello, readers Habrahabr! <br><br>  In this post I want to pay attention to the C2DM service from Google and try to tell you how to implement support for this service in your Android application.  Recall that C2DM is a special service that provides an API for sending messages to applications installed on Android devices.  Using this service is an indispensable way if you need to send a message to a user application that is registered in the system but is not currently active. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although C2DM is one of the fundamental features of the Android platform, there is little information about it in runet.  Attempting to change this situation is one of the tasks of this post. <br><br>  Under the cut, I'll tell you how to write simple client and server applications, show some ‚Äúpitfalls‚Äù, and also give links to code examples. <br><br><a name="habracut"></a><h4>  Cloud to Device Messaging </h4><br>  But for now a bit of theory.  As I wrote above, C2DM is a message delivery service from user applications to Android applications, you can read more <a href="http://code.google.com/android/c2dm/index.html">here</a> .  Those.  This is an analogue of Push Notification, in terms of Apple.  The general scheme of interaction is shown in this picture found on the Internet: <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/7e/94/7e94c4de49c10be97cd923a41564c47f.png"></a> <br>  Three main parts are visible from the diagram: <br><ol><li>  <b>C2DM service.</b>  ‚ÄúCloud‚Äù from Google, responsible for delivering messages.  As well as registration / deregistration of devices and authentication. </li><li>  <b>Client part.</b>  An Android application that accepts messages. </li><li>  <b>Server part</b>  A client application (‚Äú3rd party server‚Äù in Google terms) that sends messages. </li></ol>  Details about the process of sending messages written on the link that I cited above, but if it is short, then it consists of the following: <br><ol><li>  The Android application <a href="http://code.google.com/android/c2dm/index.html">registers</a> with C2DM, thereby announcing its readiness to receive messages, and receives a <b>Registration ID</b> .  Registration ID is a unique identifier of the device, knowing that the backend can send a message to the recipient.  When registering, you need to specify the name of the Google account, but I will write about this later when I consider the client part. </li><li>  The application sends the Registration ID of the server part so that it knows to whom it is possible to send messages. </li><li>  The server part is authenticated on the Google server, using the same account as the Android application when registering with C2DM, and gets <b>Auth Token</b> .  Details about authorization \ authentication in Google‚Äôs services are written <a href="http://code.google.com/apis/gdata/docs/auth/overview.html">here</a> . </li><li>  Knowing the Registration ID and Auth Token, the server part sends a message to the Android application. </li></ol>  Now you can go directly to the development.  Let's start with the client part (Android application). <br><br><h4>  Client part </h4><br>  To use C2DM Android, the device must meet the following requirements: <br><ol><li>  It must be a version of Android 2.2 or higher.  On previous versions, C2DM is not supported! </li><li>  There must be <b>any</b> working Google account.  If you are running the Android Market, then you have it. </li></ol>  If everything is done, you can proceed to create the application.  For this we will use the Eclipse + Android SDK.  You can create the simplest ‚ÄúHello, World‚Äù on TextView.  I will not describe the procedure for creating an application, so much has been written about it, for example, <a href="http://habrahabr.ru/blogs/android_development/109944/">here</a> or <a href="http://habrahabr.ru/blogs/android_development/110247/">here</a> .  It should turn out something like: <br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/62/dc/62dc9511e855186e0b04a5b54262f341.png"></a> <br><br>  <i>Note: If you do not have Android 2.2, you can use the emulator, you only need to use Google APIs (API 8 or higher), not the standard SDK Platform.</i>  <i>The standard SDK does not support Google accounts.</i> <br><br>  After you have created an application, you must register it on a special <a href="http://code.google.com/android/c2dm/signup.html">site</a> where you need to specify the package name (package name), and, most importantly, your Google email account that will be used to forward messages.  It is this mail that we will use in the client during registration and on the server during authentication.  You must receive a letter with registration confirmation, after this letter the specified account can be used to work with C2DM. <br><br>  Next, we proceed to the modification of our ‚ÄúHello, World!‚Äù Application.  We need to implement the code responsible for registering / unregistering, and, of course, receiving messages.  It‚Äôs really hard to write it yourself the first time.  It is difficult to take into account all the nuances, so we will use the code, which is kindly provided by Google itself as an <a href="http://code.google.com/android/c2dm/index.html">example</a> .  Downloading a ready-made set of classes for working with C2DM on the client side from svn <a href="http://code.google.com/p/chrometophone/source/browse/">storage</a> .  And we add them to the project, to the directory " <b>src \ com \ google \ android \ c2dm</b> ".  It should turn out like this: <br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/f7/26/f7263dde1715c25e071bee12660a45c9.png"></a> <br><br>  Now you need to implement the methods of the abstract class C2DMBaseReceiver, for this we will write the class C2DMReceiver, while only logging calls, and put it next to the Main.  Content Class C2DMReceiver: <br><blockquote><ol><li>  <font color="#000000">package</font> <font color="#006699">com.home.c2dmtest</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000000">import</font> <font color="#006699">com.google.android.c2dm.C2DMBaseReceiver</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000000">import</font> <font color="#006699">android.app.Notification</font> <font color="#339933">;</font> </li><li>  <font color="#000000">import</font> <font color="#006699">android.app.NotificationManager</font> <font color="#339933">;</font> </li><li>  <font color="#000000">import</font> <font color="#006699">android.app.PendingIntent</font> <font color="#339933">;</font> </li><li>  <font color="#000000">import</font> <font color="#006699">android.content.Context</font> <font color="#339933">;</font> </li><li>  <font color="#000000">import</font> <font color="#006699">android.content.Intent</font> <font color="#339933">;</font> </li><li>  <font color="#000000">import</font> <font color="#006699">android.util.Log</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000000">public</font> <font color="#000000">class</font> C2DMReceiver <font color="#000000">extends</font> C2DMBaseReceiver <font color="#009900">{</font> </li><li>  <font color="#000000">public</font> C2DMReceiver <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000000">super</font> <font color="#009900">(</font> <font color="#0000ff">"&lt;your mail&gt; @ gmail.com"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">public</font> <font color="#006600">void</font> onRegistered <font color="#009900">(</font> <font color="#003399">Context</font> context, <font color="#003399">String</font> registrationId <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  Log  <font color="#006633">w</font> <font color="#009900">(</font> <font color="#0000ff">"onRegistered"</font> , registrationId <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">public</font> <font color="#006600">void</font> onUnregistered <font color="#009900">(</font> <font color="#003399">Context</font> context <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  Log  <font color="#006633">w</font> <font color="#009900">(</font> <font color="#0000ff">"onUnregistered"</font> , <font color="#0000ff">""</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">public</font> <font color="#006600">void</font> onError <font color="#009900">(</font> <font color="#003399">Context</font> context, <font color="#003399">String</font> errorId <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  Log  <font color="#006633">w</font> <font color="#009900">(</font> <font color="#0000ff">"onError"</font> , errorId <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">protected</font> <font color="#006600">void</font> onMessage <font color="#009900">(</font> <font color="#003399">Context</font> context, Intent intent <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  Log  <font color="#006633">w</font> <font color="#009900">(</font> <font color="#0000ff">"onMessage"</font> , <font color="#0000ff">""</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li><li></li></ol></blockquote><br>  But the application is not yet ready to work with C2DM, since  Required rights are not set and BroadcastReceiver is not registered.  To fix this, you need to modify AndroidManifest.xml, how to do this you can read <a href="http://code.google.com/android/c2dm/index.html">here</a> .  For my example, the file looks like this: <br><blockquote><ol><li>  <font color="#009900"><font color="#000000">&lt;? xml</font> <font color="#000066">version</font> = <font color="#ff0000">"1.0"</font> <font color="#000066">encoding</font> = <font color="#ff0000">"utf-8"</font> <font color="#000000">?&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;manifest</font> <font color="#000066">xmlns: android</font> = <font color="#ff0000">" <a href="http://schemas.android.com/apk/res/android%2522">schemas.android.com/apk/res/android"</a></font></font> </li><li>  <font color="#009900"><font color="#000066">android: versionCode</font> = <font color="#ff0000">"1"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: versionName</font> = <font color="#ff0000">"1.0"</font> <font color="#000066">package</font> = <font color="#ff0000">"com.home.c2dmtest"</font> <font color="#000000">&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;application</font></font> </li><li>  <font color="#009900"><font color="#000066">android: debuggable</font> = <font color="#ff0000">"true"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: label</font> = <font color="#ff0000">"@ string / app_name"</font> <font color="#000000">&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;activity</font> <font color="#000066">android: name</font> = <font color="#ff0000">"Main"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: label</font> = <font color="#ff0000">"@ string / app_name"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: theme</font> = <font color="#ff0000">"@android: style / Theme.NoTitleBar"</font> <font color="#000000">&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;action</font> <font color="#000066">android: name</font> = <font color="#ff0000">"android.intent.action.MAIN"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;category</font> <font color="#000066">android: name</font> = <font color="#ff0000">"android.intent.category.LAUNCHER"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ activity <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;service</font> <font color="#000066">android: name</font> = <font color="#ff0000">".C2DMReceiver"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;receiver</font></font> </li><li>  <font color="#009900"><font color="#000066">android: name</font> = <font color="#ff0000">"com.google.android.c2dm.C2DMBroadcastReceiver"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: permission</font> = <font color="#ff0000">"com.google.android.c2dm.permission.SEND"</font> <font color="#000000">&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;action</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.google.android.c2dm.intent.RECEIVE"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;category</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.home.c2dmtest"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;action</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.google.android.c2dm.intent.REGISTRATION"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;category</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.home.c2dmtest"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ intent-filter <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ receiver <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ application <font color="#000000">&gt;</font></font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;uses-sdk</font> <font color="#000066">android: minSdkVersion</font> = <font color="#ff0000">"8"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;permission</font></font> </li><li>  <font color="#009900"><font color="#000066">android: name</font> = <font color="#ff0000">"com.home.c2dmtest.permission.C2D_MESSAGE"</font></font> </li><li>  <font color="#009900"><font color="#000066">android: protectionLevel</font> = <font color="#ff0000">"signature"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;uses-permission</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.home.c2dmtest.permission.C2D_MESSAGE"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;uses-permission</font> <font color="#000066">android: name</font> = <font color="#ff0000">"com.google.android.c2dm.permission.RECEIVE"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;uses-permission</font> <font color="#000066">android: name</font> = <font color="#ff0000">"android.permission.INTERNET"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;uses-permission</font> <font color="#000066">android: name</font> = <font color="#ff0000">"android.permission.WAKE_LOCK"</font> <font color="#000000">/&gt;</font></font> </li><li>  <font color="#009900"><font color="#000000">&lt;/ manifest <font color="#000000">&gt;</font></font></font> </li></ol></blockquote><br>  <i>Note: The right <a href="http://developer.android.com/reference/android/Manifest.permission.html">android.permission.WAKE_LOCK is</a> not needed to use C2DM, but we will need it later, and in order not to bring this file twice, I decided to add it in advance.</i> <br><br>  Now you can register a device in C2DM, for this we call the following code in OnCreate: <br><blockquote>  C2DMessaging.  <font color="#006633">register</font> <font color="#009900">(</font> <font color="#000000">this</font> , <font color="#0000ff">"&lt;yourmail&gt; @ gmail.com"</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br>  If everything went fine, then after a couple of seconds, the new Regestration ID will fall into the onRegistered method of the C2DMReceiver class.  If this does not happen, you need to look at the LogCat log for errors. <br><br>  You can check out by calling the method: <br><blockquote>  C2DMessaging.  <font color="#006633">unregister</font> <font color="#009900">(</font> <font color="#000000">this</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br>  Get current Registration ID: <br><blockquote>  <font color="#003399">String</font> id = C2DMessaging.  <font color="#006633">getRegistrationId</font> <font color="#009900">(</font> <font color="#000000">this</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br>  Registration ID can change at any second, i.e.  Google can send its new value, and, therefore, such a situation must be able to handle.  In our example, everything is already done for this, the implementation of this mechanism is in the C2DMBaseReceiver class, the handleRegistration method. <br><br>  The final project looks like this: <br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/a3/98/a398413c1706e11bde1b22c365d1df43.png"></a> <br><br>  Now we need to make our project more visual, we will expand the processing of messages.  Let <a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html">Notification</a> appear when a new message arrives, and when it is selected, our application will be launched with the text specified by the server. <br><br>  Ok, for this we modify the onMessage code as follows: <br><blockquote><ol><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">protected</font> <font color="#006600">void</font> onMessage <font color="#009900">(</font> <font color="#003399">Context</font> context, Intent receiveIntent <font color="#009900">)</font> </li><li>  <font color="#009900">{</font> </li><li>  <font color="#003399">String</font> data = receiveIntent.  <font color="#006633">getStringExtra</font> <font color="#009900">(</font> <font color="#0000ff">"message"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">if</font> <font color="#009900">(</font> data <font color="#339933">!</font> = <font color="#006600">null</font> <font color="#009900">)</font> </li><li>  <font color="#009900">{</font> </li><li>  Log  <font color="#006633">w</font> <font color="#009900">(</font> <font color="#0000ff">"C2DMReceiver"</font> , data <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  Intent intent = <font color="#000000">new</font> Intent <font color="#009900">(</font> <font color="#000000">this</font> , Main. <font color="#000000">Class</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  intent.  <font color="#006633">putExtra</font> <font color="#009900">(</font> <font color="#0000ff">"message"</font> , data <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  NotificationManager mManager = <font color="#009900">(</font> NotificationManager <font color="#009900">)</font> </li><li>  getSystemService <font color="#009900">(</font> <font color="#003399">Context</font> . <font color="#006633">NOTIFICATION_SERVICE</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#003399">Notification</font> notification = <font color="#000000">new</font> <font color="#003399">Notification</font> <font color="#009900">(</font> android. <font color="#006633">R.</font> <font color="#006633">Drawable</font> . <font color="#006633">Ic_dialog_info</font> , </li><li> <font color="#0000ff">"My C2DM message"</font> , <font color="#003399">System</font> .  <font color="#006633">currentTimeMillis</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  notification.  <font color="#006633">setLatestEventInfo</font> <font color="#009900">(</font> context, <font color="#0000ff">"App Name"</font> , <font color="#0000ff">"C2DM notification"</font> , </li><li>  PendingIntent.  <font color="#006633">getActivity</font> <font color="#009900">(</font> <font color="#000000">this</font> . <font color="#006633">getBaseContext</font> <font color="#009900">(</font> <font color="#009900">)</font> , <font color="#cc66cc">0</font> , </li><li>  intent, pendingintent.  <font color="#006633">FLAG_CANCEL_CURRENT</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  mManager.  <font color="#006633">notify</font> <font color="#009900">(</font> <font color="#cc66cc">0</font> , notification <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  <b>message</b> is the <b>message</b> identifier that the server sends.  We will add it to the new Intent so that we can get it in Main. <br><br>  Modify Main to display the transmitted message: <br><blockquote><ol><li>  @ <font color="#003399">Override</font> </li><li>  <font color="#000000">public</font> <font color="#006600">void</font> onCreate <font color="#009900">(</font> Bundle savedInstanceState <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000000">super</font> .  <font color="#006633">onCreate</font> <font color="#009900">(</font> savedInstanceState <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  TextView view = <font color="#000000">new</font> TextView <font color="#009900">(</font> <font color="#000000">this</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003399">String</font> message = getIntent <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">getStringExtra</font> <font color="#009900">(</font> <font color="#0000ff">"message"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">if</font> <font color="#009900">(</font> message == <font color="#006600">null</font> <font color="#009900">)</font> </li><li>  view.  <font color="#006633">setText</font> <font color="#009900">(</font> <font color="#0000ff">"Hello, World !!!"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">else</font> </li><li>  view.  <font color="#006633">setText</font> <font color="#009900">(</font> <font color="#0000ff">"Your message:"</font> + message <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  setContentView <font color="#009900">(</font> view <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003399">String</font> id = C2DMessaging.  <font color="#006633">getRegistrationId</font> <font color="#009900">(</font> <font color="#000000">this</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">if</font> <font color="#009900">(</font> id == <font color="#0000ff">""</font> <font color="#009900">)</font> </li><li>  <font color="#009900">{</font> </li><li>  C2DMessaging.  <font color="#006633">register</font> <font color="#009900">(</font> <font color="#000000">this</font> , <font color="#0000ff">"&lt;yourmail&gt; @ gmail.com"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  In real life, we certainly need to write a Registration ID transfer mechanism to the server and other trifles, but since  For this example, we‚Äôll stop here and the Registration ID will be hard-coded on the server. <br><br><h4>  Server part </h4><br>  First you need to get Auth Token.  This is well written in <a href="http://prodroid.com.ua/%3Fp%3D52">this</a> blog (There is also a lot of other useful information).  In general, there is an example, everything is in Russian, so we will not repeat it and we will assume that we received it. <br><br>  So we have a Registration ID and Auth Token.  Things are easy, you need to send a message.  For some reason, there is very little information about this part of the Internet, although there is nothing difficult here. <br><br>  We need to establish a connection with the Google server, form a request in the <a href="http://code.google.com/android/c2dm/index.html">correct</a> format.  And that's all.  A simplified example of sending a message is given in the following code: <br><blockquote><ol><li>  <font color="#000000">public</font> <font color="#006600">boolean</font> sendData <font color="#009900">(</font> </li><li>  <font color="#003399">String</font> authToken </li><li>  <font color="#003399">String</font> registrationId, </li><li>  <font color="#003399">String</font> collapse </li><li>  <font color="#003399">String</font> key </li><li>  <font color="#003399">String</font> value <font color="#009900">)</font> </li><li>  <font color="#000000">throws</font> <font color="#003399">IOException</font> <font color="#009900">{</font> </li><li></li><li>  <font color="#666666">// Set Registration ID</font> </li><li>  <font color="#003399">StringBuilder</font> postDataBuilder = <font color="#000000">new</font> <font color="#003399">StringBuilder</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  postDataBuilder.  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"registration_id"</font> <font color="#009900">)</font> . </li><li>  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"="</font> <font color="#009900">)</font> .  <font color="#006633">append</font> <font color="#009900">(</font> registrationId <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#666666">// Set collapse_key - groups messages if the collapse key is the same, and</font> </li><li>  <font color="#666666">// a device, for example, is turned off, then only one message will be sent,</font> </li><li>  <font color="#666666">// not all at once.</font> </li><li>  postDataBuilder.  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"&amp;"</font> <font color="#009900">)</font> .  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"collapse_key"</font> <font color="#009900">)</font> .  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"="</font> <font color="#009900">)</font> . </li><li>  <font color="#006633">append</font> <font color="#009900">(</font> collapse <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#666666">// Add the transmitted date, in the format &lt;data.&gt; &lt;Key&gt; = &lt;value&gt;</font> </li><li>  postDataBuilder.  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"&amp;"</font> <font color="#009900">)</font> .  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"data."</font> + key <font color="#009900">)</font> .  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#0000ff">"="</font> <font color="#009900">)</font> . </li><li>  <font color="#006633">append</font> <font color="#009900">(</font> <font color="#003399">URLEncoder</font> . <font color="#006633">encode</font> <font color="#009900">(</font> value, <font color="#0000ff">"UTF-8"</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#006600">byte</font> <font color="#009900">[</font> <font color="#009900">]</font> postData = postDataBuilder.  <font color="#006633">toString</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">getBytes</font> <font color="#009900">(</font> <font color="#0000ff">"UTF-8"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003399">URL</font> url = <font color="#000000">new</font> <font color="#003399">URL</font> <font color="#009900">(</font> <font color="#0000ff">" <a href="https://android.clients.google.com/c2dm/send%2522">android.clients.google.com/c2dm/send"</a></font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#666666">// Establish connection</font> </li><li>  <font color="#666666">// Proxy proxy = new Proxy (Proxy.Type.HTTP, new InetSocketAddress ("lazerboy.local", 8080));</font> </li><li>  <font color="#003399">HttpsURLConnection</font> conn = <font color="#009900">(</font> <font color="#003399">HttpsURLConnection</font> <font color="#009900">)</font> url.  <font color="#006633">openConnection</font> <font color="#009900">(</font> <font color="#666666">/ * proxy * /</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setDoOutput</font> <font color="#009900">(</font> <font color="#006600">true</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setHostnameVerifier</font> <font color="#009900">(</font> <font color="#000000">this</font> . <font color="#000000">new</font> MyHostnameVerifier <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setRequestMethod</font> <font color="#009900">(</font> <font color="#0000ff">"POST"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setRequestProperty</font> <font color="#009900">(</font> <font color="#0000ff">"Content-Type"</font> , </li><li>  <font color="#0000ff">"application / x-www-form-urlencoded; charset = UTF-8"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setRequestProperty</font> <font color="#009900">(</font> <font color="#0000ff">"Content-Length"</font> , <font color="#003399">Integer</font> . <font color="#006633">toString</font> <font color="#009900">(</font> postData. <font color="#006633">length</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  conn.  <font color="#006633">setRequestProperty</font> <font color="#009900">(</font> <font color="#0000ff">"Authorization"</font> , <font color="#0000ff">"GoogleLogin auth ="</font> + authToken <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#003399">OutputStream</font> out = conn.  <font color="#006633">getOutputStream</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  out.  <font color="#006633">write</font> <font color="#009900">(</font> postData <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  out.  <font color="#006633">close</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#666666">// Get the response code.</font> </li><li>  <font color="#006600">int</font> responseCode = conn.  <font color="#006633">getResponseCode</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000000">if</font> <font color="#009900">(</font> responseCode == HttpServletResponse. <font color="#006633">SC_UNAUTHORIZED</font> || </li><li>  responseCode == HttpServletResponse.  <font color="#006633">SC_FORBIDDEN</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#003399">System</font> .  <font color="#006633">out</font> .  <font color="#006633">printf</font> <font color="#009900">(</font> <font color="#0000ff">"Unauthorized - need token"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">return</font> <font color="#006600">false</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#000000">if</font> <font color="#009900">(</font> responseCode == HttpServletResponse. <font color="#006633">SC_OK</font> <font color="#009900">)</font> </li><li>  <font color="#009900">{</font> </li><li>  <font color="#003399">System</font> .  <font color="#006633">out</font> .  <font color="#006633">printf</font> <font color="#009900">(</font> <font color="#0000ff">"Data sent to device!"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000000">return</font> <font color="#006600">true</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  <font color="#003399">System</font> .  <font color="#006633">out</font> .  <font color="#006633">printf</font> <font color="#009900">(</font> <font color="#0000ff">"Something wrong, response message:"</font> , conn. <font color="#006633">getResponseMessage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000000">return</font> <font color="#006600">false</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  One very important detail is missing here: the processing of messages from the server.  For example, the situation when Auth Token becomes outdated is not processed in any way.  But I wanted to write an example of a working application, but not ready to use library.  Moreover, everything you need can be found in the source from Google, for example, <a href="http://code.google.com/p/jumpnote/source/browse/">here</a> . <br><br>  If the code runs successfully, the user on his device will see our notification in the notification area, and if he clicks on it, then our application will start with the text from the server.  Hooray, this is exactly what we wanted. <br><br><h4>  Conclusion </h4><br>  I showed how it is possible to fasten C2DM support to an Android application without a special headache.  What you need to do, both on the client side and on the server side.  Of course, there were "white spots", but again, the main task was to bring ideas and show code examples to make it easy for people reading this post to start developing applications with C2DM support. <br><br><h4>  useful links </h4><ol><li>  <a href="http://code.google.com/android/c2dm/index.html">Android Cloud to Device Messaging</a> </li><li>  <a href="http://code.google.com/android/c2dm/signup.html">Place where you need to register an account to use C2DM</a> </li><li>  <a href="http://prodroid.com.ua/">Russian-language blog on C2DM and Android</a> </li><li>  <a href="http://code.google.com/p/chrometophone/">Google Sample</a> </li><li>  <a href="http://blog.mediarain.com/2011/03/simple-google-android-c2dm-tutorial-push-notifications-for-android/">Another blog on the topic</a> </li><li>  <a href="http://mylifewithandroid.blogspot.com/2010/10/push-service-from-google.html">C2DM usage example</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/116106/">https://habr.com/ru/post/116106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116098/index.html">Google introduced Think Quarterly online edition</a></li>
<li><a href="../116099/index.html">Selected 17 new wallpaper for Ubuntu 11.04 and slightly updated default desktop image</a></li>
<li><a href="../116101/index.html">A conversation between two chatbots and how one caught the other in that he is AI</a></li>
<li><a href="../116102/index.html">Webcams and orientation events</a></li>
<li><a href="../116103/index.html">UsbFlashSpeed ‚Äã‚Äã9 months later</a></li>
<li><a href="../116108/index.html">Product Lifecycle Management System: CAD attached</a></li>
<li><a href="../116110/index.html">Spree 0.50.0 released</a></li>
<li><a href="../116111/index.html">IT infrastructure at CodeFest (WiFi, projectors, laptops, etc.)</a></li>
<li><a href="../116112/index.html">Report on the first master classes from the Bars Group in python in Kazan</a></li>
<li><a href="../116113/index.html">Combating e-waste and CO2 emissions. Toshiba methods</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>