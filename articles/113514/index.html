<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VLAN + DHCP + VoIP = Cisco</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the topic of setting up DHCP on Cisco equipment with regard to VLAN, I propose to consider the matter further: let's cross the desc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VLAN + DHCP + VoIP = Cisco</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the topic of <a href="http://habrahabr.ru/blogs/cisconetworks/113431/">setting up DHCP</a> on Cisco equipment with regard to VLAN, I propose to consider the matter further: let's cross the described functionality with VoIP technology.  What if we decided to integrate VoIP into our network with all the ensuing consequences: a separate device with Communication Manager Express, VoIP phones and the need to prioritize traffic? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9d/5f6/bdd/b9d5f6bdd55e4d85e49241f8a498b88c.jpg"><br><br><a name="habracut"></a>  First, briefly about the Cisco VoIP architecture shown here.  Let's start with the phones.  Cisco's VoIP phones have a built-in two-port miniswitch that allows you to connect the phone to an outlet, and the computer to the phone.  By this we save sockets and ports on the switch, but we also create an additional problem for ourselves: VoIP traffic must be isolated from the traffic intended for the computer.  In the name of prioritization, which is critical for VoIP, and security. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To solve this problem, Cisco uses, using abstruse words, 802.1q trunk technology, and simpler, VLAN.  The VoIP phone adds a tag to its traffic, according to which the switch recognizes that the frame belongs to VoIP traffic, and it needs to be given special attention. <br>  There is a separate command on the ports of the switch to set the VLAN for the phone that is connected to it.  Now the port setting will look like this: <br><pre><code class="tex hljs">interface FastEthernet0/1 switchport mode access switchport access vlan 50 switchport voice vlan 10</code> </pre> <br>  After that, a CDP switch will transfer the phone number of its VLAN to the phone and it will be able to tag the frames with the correct tag. <br><br>  ‚ÄúAha,‚Äù the attentive and cunning reader will say, ‚Äúbut you see, all VoIP traffic of the entire network is concentrated in one VLAN?‚Äù  So our computer can turn off the phone, pretend to it and listen to all conversations on the network? ‚Äù <br><br>  ‚ÄúAnd why is this crutch at all with switchport voice vlan?  - the attentive and intelligent reader will ask, - because you can configure the port on the switch as a trunk, pointing it to allowed vlan 10 and native vlan 50? ‚Äù <br><br>  The answer to both these questions is one: Cisco has provided a mechanism that prevents a foreign device from pretending to be a VoIP phone.  This mechanism is enabled by the switchport voice vlan command.  The second attentive reader is right, its configuration is correct and will work, but it will make the first attentive reader to the right.  And this we absolutely do not need. <br><br>  A detailed story about the mechanism of Voice VLAN is a topic for a separate post.  Those who are interested and want to find out about it right now can <a href="http://www.cisco.com/en/US/docs/switches/lan/catalyst2960/software/release/12.2_40_se/configuration/guide/swvoip.pdf">read about it</a> on the Cisco website and, who knows, maybe in the process of becoming interested in something else from Tsiskovsky VoIP. <br><br>  But back to our task.  Not only workstations need an IP address, but also IP phones.  However, only devices from VLAN 50, that is, computers, have access to the DHCP server.  What to do phones? <br><br>  And for phones, we use two interesting DHCP mechanisms: the helper-address command and the principle by which DHCP allocates addresses. <br><br>  Configure the DHCP server on the router with two pools: <br><pre> <code class="tex hljs">ip dhcp pool VOICE network 172.16.1.0 /24 default-router 172.16.1.1 dns-server 4.2.2.2</code> </pre> <br>  The network command in configuring DHCP on Cisco is one of the few where we can specify a subnet mask using a slash.  And we can not ask at all, then it will be determined automatically, depending on the class of the network. <br>  The default-router command sets the default gateway for the network, and the dns-server, respectively, the DNS server.  4.2.2.2 is the address of the public NDS server, which is maintained by the University of Berkeley, and is a reliable alternative if for some reason you do not trust your provider‚Äôs DNS. <br>  Just a couple of sentences about another DHCP feature in VoIP: with its help, telephones get the address of the TFTP server on which the operating system image for them is stored.  This functionality is known as option 150 and is given by the command: <br><pre> <code class="tex hljs">option 150 ip 'TFTP server IP address'</code> </pre> <br>  If you go deeper into DHCP even more, then all the functions of this wonderful protocol are options.  So, the default gateway can be set as default-router, or you can as option 3. Under these options you can find a lot of interesting additional functionality, which, unfortunately, will not fit in one post either. <br><br>  All-all, I'm already finishing my distractions: in the same way we will configure a pool of IP addresses for workstations: <br><pre> <code class="tex hljs">ip dhcp pool DATA network 172.16.2.0 /24 default-router 172.16.2.1 dns-server 4.2.2.2</code> </pre> <br>  Then we go to the CME router subinterfaces (I assume that you are familiar with routing between VLANs and have already configured them yourself).  All broadcast packets with which our phones will reach the general public: ‚Äúhey, who is the DHCP server here, I need an IP address‚Äù will come to the Fa0 / 0.10 subinterface - because the phones are in VLAN 10. There would be these calls for help and to die - in VLAN 10 there is no DHCP server - but this is not an option.  The output is the ip helper-address command: <br><pre> <code class="tex hljs">interface FastEthernet0/0.10 ip helper-address 172.16.2.5</code> </pre> <br>  With this command, we tell the CME router: when you receive a broadcast DHCP packet, send it to the DHCP server at 172.16.2.5.  This server will answer you, and then you will give it to the one who sent you the request. <br><br>  ‚ÄúWait,‚Äù our attentive readers will say, ‚Äúbut the phones transmit with broadcast packets‚Äú hey, give us the IP address ‚Äùjust like computers - all these devices have no addresses.  How does the DHCP server find out that it is necessary for the phones to give out addresses from the VOICE pool, and to computers - from the DATA pool? ‚Äù <br><br>  Here we come to the second interesting point: in fact, the DHCP server does not know.  If all the phones and computers were in the same VLAN, he would say: ‚ÄúI don‚Äôt know who you are.  All your requests came to me through the interface 172.16.2.5, so I will give you all the addresses from the network to which this interface belongs, that is, 172.16.2.0/24. ‚Äù <br><br>  But we used helper-address!  See how it works now: computers send the request ‚Äúhey, give me an IP address‚Äù.  The request goes to the DHCP server through interface 172.16.2.5 ‚Äî the server is in the same VLAN as the computers.  And he gives them addresses from the network 172.16.2.0/24 - our DATA pool.  But the broadcast packets of the phones go in a different VLAN.  They arrive at the Fa0 / 0.10 subinterface, which is the default gateway for them, and the CME sends them to ip helper-address - 172.16.2.5. <br><br>  And when the CME sends phone requests, it does not send them as broadcast.  He sends them as unicast.  A unicast IP packet has the source and destination addresses.  And in our case, the IP address of the source of the DHCP request will be the address of the Fa0 / 0.10 subinterface, because there these frames first reached the third level, there they learned for the first time that there are IP addresses in the world! <br><br>  So, the DHCP server receives a unicast request, the source address of which is 172.16.1.1.  ‚ÄúYeah,‚Äù says the server, ‚Äúthen the source of the request has a connection to this address.  So, it is necessary to give him an IP address from the network to which this address belongs. ‚Äù  And responds to the request by issuing an address from the network 172.16.1.1/24 - our VOICE pool! <br><br>  Thus, we get exactly what we wanted: all our phones received IP addresses from the required subnet, they are isolated from the data VLAN and only communicate with the CME, which can connect them to other phones via PSTN or VoIP via the Internet.  Computers also received addresses from another network, they can now exchange data with company branches, server farm or anything else.  We got a flexible network configuration, the ability to prioritize traffic at the second and third levels, and bandwidth and resource savings by using a single DHCP server for several isolated VLANs. <br><br>  <b>PS</b> I want to express my gratitude for the inspiration for this post and a significant layer of my telecom knowledge to the incomparable Jeremy Cioara.  I hope you forgive too loosely the tone of the story. </div><p>Source: <a href="https://habr.com/ru/post/113514/">https://habr.com/ru/post/113514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113504/index.html">Google, Facebook and other large companies want to buy Twitter</a></li>
<li><a href="../113507/index.html">Scientists plan to create Wikipedia for robots</a></li>
<li><a href="../113508/index.html">Uploading files with the html5 File API, with preference and dancers</a></li>
<li><a href="../113510/index.html">First look at the HP TouchPad</a></li>
<li><a href="../113512/index.html">Announcement of node 0.4 - second stable branch</a></li>
<li><a href="../113517/index.html">Phantom of the Floppera</a></li>
<li><a href="../113518/index.html">Four steps to choosing a web developer</a></li>
<li><a href="../113520/index.html">What happened to Opera Mini?</a></li>
<li><a href="../113521/index.html">Not exactly a facebook phone</a></li>
<li><a href="../113523/index.html">Oracle Essbase 9 - installation and configuration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>