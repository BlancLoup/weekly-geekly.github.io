<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>History of development and optimization of a single high-loaded resource</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 It all started with the fact that I became a system administrator at one provincial Internet service provider. In addition to administe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>History of development and optimization of a single high-loaded resource</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/82d7354c/0aa92381/e5e11403/0de52d30.jpg"><br><br><h5>  Introduction </h5><br>  It all started with the fact that I became a system administrator at one provincial Internet service provider.  In addition to administering various kinds of resources, I took care of one young but rapidly developing resource.  The resource was a classic <a href="http://ru.wikipedia.org/wiki/LAMP">LAMP</a> project.  The site where content generators were regular users. <br>  <i>* By the way, at that time I didn‚Äôt understand anything in * nix systems, although all the servers I got were on it, I understood all this quickly enough.</i> <br><br>  As it usually happens with the resources that are gaining popularity, the glands on which everything is spinning, they no longer cope.  The resource was on an old dual-processor server, where almost all services for users were spinning.  At that time, the authorities did not perceive the resource as a worthwhile investment, therefore, to my regret (and later, fortunately), I was not allocated any money for a new piece of metal. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  nginx + php-fpm </h5><br>  Google came to the rescue.  As it turned out, for high-load projects, people use php in fast-cgi mode.  It turned out that there are several schemes for implementing such a regime, but in the end, preference was given to Russian developments, the <a href="http://sysoev.ru/nginx/">nginx</a> bundle (Igor Sysoev) and <a href="http://php-fpm.org/">php-fpm</a> (Andrey Nigmatulin).  The performance gain, compared to Apache and its mod_php, is achieved by the fact that php-fpm creates n php processes, which later hang in the system and process scripts transferred from the web server.  With this scheme, time and system resources are saved to call the php interpreter.  Do not ask why I didn‚Äôt choose any spawn-fcgi c lighttpd, I don‚Äôt want to start a holivar on this topic, and it doesn‚Äôt matter in principle.  System performance has increased, the load has subsided, I breathed a sigh of relief for a while. <br><br><h5>  eAccelerator </h5><br>  The next step towards high performance is installing a php-accelerator.  The essence of his work is to cache the binary code of the script.  Indeed, why waste precious processor time on translating a script into a binary code with each call?  Such calls to the same script could be up to 100 per second, so the <a href="http://eaccelerator.net/">eAccelerator</a> came in handy.  After it was installed, the system performance increased again, the load decently fell, the page generation time decreased dramatically, and users again became content with an accelerated resource. <br><br><h5>  MySQL indexes </h5><br>  I have to say that before working at the company I indulged myself with php, so I was well aware of the resource code and understood what was needed there, but I understood that, like any code, there are bottlenecks and I decided to start their search.  After adding timers to the project, counting the execution time of php and the execution time of the sql queries, the bottleneck was found immediately.  The resource was based on one open-source CMS and judging by the code, some of the developers had no idea about the <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BA%25D1%2581_(%25D0%25B1%25D0%25B0%25D0%25B7%25D1%258B_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585)">indexes</a> in MySQL.  Well, began the long identification and rework of problem queries, as well as adding indexes to where they are really needed.  <a href="http://habrahabr.ru/blogs/mysql/31129/">EXPLAIN has</a> become my companion for the next few days.  As a result, the execution time of the SQL queries in some places was reduced to 10‚Äì20 times, and again happy days began for dear users. <br><br><h5>  Memcached </h5><br>  By the time the load was back on the shelf, the bosses had already allocated a full-fledged server for the resource.  But I already had a sporting interest.  When the page generation time drops from 2 seconds to 0.5 seconds, it is very, very inspiring, but I wanted more.  I wanted to get rid of heavy sql queries at all, leaving only a critical minimum.  Plowing through the spaces, I came across the report by Andrei Smirnov: ‚ÄúWeb, caching and memcached‚Äù (performance on HighLoad ++ 2008).  Indeed, this is what you need!  <a href="http://memcached.org/">Memcached</a> - the simplest and at the same time high-performance caching server developed at one time for livejournal.com, fit into my scheme at an opportune time.  Unfortunately, it was not possible for me to use memcache in full, because my work was not limited to this web resource, but much was still done.  I used memcached to cache the result of sql queries, or to store already prepared, rendered blocks.  On many pages of the site, the time of their generation has been reduced to horribly small numbers - 0.009s!  This was the biggest discovery and achievement of all time. <br><br><h5>  Sysctl and unix-sockets </h5><br>  Another important moment in the struggle for the quality of the resource is the <a href="http://ru.wikipedia.org/wiki/Sysctl">sysctl</a> tuning.  At high loads, the default configuration leaves much to be desired.  A couple of weeks were spent on finding the optimal parameters of the network subsystem.  Also, if possible, php-fpm, memcached, and MySQL were hung on <a href="http://ru.wikipedia.org/wiki/Unix_domain_socket">unix-sockets</a> .  As a result, the server gives content to peak loads as quickly as it does without loads. <br><br><h5>  Sphinx </h5><br>  By the time I mastered caching, I wondered if it was possible to accelerate anything else.  Naturally!  Search was the weakest point of the site.  Guess why?  Right!  There was used a terrible evil - LIKE in sql query.  This is where the <a href="http://sphinxsearch.com/">Sphinx</a> search engine came to the rescue!  Unfortunately, in my case, it turned out to use Sphinx only for saggests (tooltips during the search), because  updating the main sql table was very frequent, and the relevance of the data was very important, so we had to abandon it.  However, if I had more time for a detailed analysis of this point, perhaps I would have coped with this problem and Sphinx would be another key point in the development of the service. <br><br><h5>  MySQL in tmpfs </h5><br>  A lot of time has passed since all my tunings and optimizations.  The resource became significant for the company, money was allocated for its support and now it was served by 2 servers.  The first acted as a web server and processed php, the second was used under MySQL.  But the development did not stand still and now the resource reaches 600 hits per second, both parts of the resource stop cope.  Plug-in both at the php level, and at the MySQL level.  After receiving the third server, the question arose of scaling it, but I could not think of an ideal option.  And here on the pages of Habr saw the topic of <a href="http://habrahabr.ru/blogs/mysql/104217/">MySQL in tmpfs</a> .  And I thought, why not?  Spent some preparatory work with the base.  As much as possible reduced a DB by deletions of unimportant but "gluttonous" functions.  Removed some of the logging functions in the database.  Ultimately, the weight of the database was reduced from 11 to 2.5 GB.  And so, it was decided to use 2 servers under php, and on the 3 rd, start MySQL with ‚Äúdope‚Äù.  The standard <a href="http://dev.mysql.com/doc/refman/5.0/en/mysqlhotcopy.html">mysqlhotcopy</a> utility works very well with backup (1.5 seconds and you're done!).  So did.  The load on MySQL decreased by 4 times, the performance also increased. <br><br><h5>  Conclusion </h5><br>  Why did I decide to tell all this?  Perhaps this article will be interesting to a certain circle of people who are faced with similar problems.  If I had found something similar in my time, it would have helped me a lot.  Another resource will undergo great changes.  Everything will be rewritten, and from the old nothing will be left except for content and users.  For me, the sunset of all my achievements seems to be, but I got a great experience thanks to them, and the experience is invaluable.  And the article will be for me the memory of what I once did. <br><br>  In the process of work, my colleague ( <a href="http://habrahabr.ru/users/centalt/" class="user_link">CentAlt</a> ) helped me a <a href="http://habrahabr.ru/users/centalt/" class="user_link">lot</a> , who strongly supported me in all his endeavors and for that he was very grateful.  By the way, maybe some of you know him.  It keeps one very useful <a href="http://centos.alt.ru/">repository for Centos</a> , where you can find the latest versions of nginx, php-fpm, unbound, clamav, postfix, dovecot, etc. <br><br>  The article does not claim to primacy or popularity.  This is not an instruction on how to do it or not.  This is the story of a single high-load project, which I happened to develop and adminit. <br><br>  Thank you for reading to the end! </div><p>Source: <a href="https://habr.com/ru/post/106311/">https://habr.com/ru/post/106311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../106304/index.html">Ajenti 0.4</a></li>
<li><a href="../106305/index.html">Died CC search Yahoo!</a></li>
<li><a href="../106307/index.html">Homemade spacecraft</a></li>
<li><a href="../106308/index.html">Microsoft decided to reduce the price of the Xbox 360</a></li>
<li><a href="../106309/index.html">Eric Schmidt predicts the emergence of new billions of web users</a></li>
<li><a href="../106312/index.html">Techsupport</a></li>
<li><a href="../106314/index.html">Installing StartSSL Certificates - Postfix / Dovecot / Nginx</a></li>
<li><a href="../106319/index.html">The first clock on electronic ink</a></li>
<li><a href="../106320/index.html">Azimov's laws penetrate the present</a></li>
<li><a href="../106321/index.html">Chrome, Android, Geo / Maps hackathons before and after GDD 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>