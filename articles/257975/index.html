<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Messaging in Microsoft Azure, or How to communicate in the clouds</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My acquaintance with the Azure cloud began during my practice at DataArt. In the third month of training, my colleague Anton came to my mentor Dima an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Messaging in Microsoft Azure, or How to communicate in the clouds</h1><div class="post__text post__text-html js-mediator-article">  My acquaintance with the Azure cloud began during my practice at DataArt.  In the third month of training, my colleague Anton came to my mentor Dima and said that he needed someone for a small demonstration project.  So we met. <br><br>  Anton - a man enthusiastic and very active, knows how to inspire ideas.  The practice ended a long time ago, after some time, Anton broke up with DataArt, but continues to be actively interested in and promote Microsoft Azure, often consults our colleagues on Azure technology and offers to participate in various thematic events.  In particular, he holds various seminars, trainings, meetings dedicated to this cloud, and not long ago, the first Ukrainian Azure Community in our country was created in Kiev. <br><br>  This is a group of like-minded people who are actively interested in technology, share their knowledge and communicate on the subject of Azure.  Once a month or two meetings are held, each devoted to a separate topic.  Often these meetings take place just at the DataArt office in Kiev. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The theme of the meeting, where, in particular, I spoke, chose to exchange messages using different Azure services.  We heard about Azure Storage Queues, Azure Service Bus Queues, Azure Service Bus Topics &amp; Subscriptions. <br><br>  I will share the technical part.  There are three types of messaging models. <br><br><img src="https://habrastorage.org/files/f72/e42/e21/f72e42e21b11462780cfc88230380be6.png"><br>  <i>Fig.</i>  <i>one</i> <br><br>  In the case of model A, the message is sent directly from the sender to the recipient.  This is the simplest model, but it has flaws: <br>  - it is difficult to scale (yes, yes, these are clouds!); <br>  - it is easy to lose messages (for example, the recipient goes offline); <br>  - difficult to implement retry policy. <br>  Because of these shortcomings, models B are mainly used in Azure (the message gets into a kind of broker, the recipient "picks up" it from there) and B (the message gets into the broker, and the broker sends it to the recipient). <br><a name="habracut"></a><br><h5>  <b>Azure Storage Queues</b> </h5><br>  This is the most common FIFO queue.  It corresponds to model B. <br>  Within one Azure account, you can create an arbitrary number of queues with unique names.  The queue name must be url-friendly.  Each queue can contain an arbitrary number of messages, but the size of a single message is limited to 64 KB.  That is, the queue is not intended for exchanging data, but only for exchanging tasks. <br>  <i>(A question to think: what if the message for some reason does not fit in 64K? Think in the context of Azure.)</i> <br><br><img src="https://habrastorage.org/files/ae3/823/1ff/ae38231fff394cec84723e236028ad27.png"><br>  <i>Fig.</i>  <i>2</i> <br><br>  Sending a message to the queue looks like this: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Retrieve storage account from connection string CloudStorageAccount storageAccount = CloudStorageAccount.Parse(_cloudConnectionString); // Create the queue client CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient(); // Retrieve a reference to a queue CloudQueue queue = queueClient.GetQueueReference("somecorrectqueuename"); // Create the queue if it doesn't already exist queue.CreateIfNotExists(); string messageToSend = string.Format("message #{0}", i); // Create a message and add it to the queue. CloudQueueMessage message = new CloudQueueMessage(messageToSend); queue.AddMessage(message);</span></span></code> </pre> <br><br>  The capacity of Azure to send to the queue - up to 20 thousand messages per second. <br>  The peculiarity of this queue is a specific timeout (by default 30 seconds) for processing a single message.  That is, when reading, the message is not removed from the queue, but becomes invisible to other recipients.  If the message was processed correctly, it must be explicitly removed from the queue.  If there are read errors or another exception - in general, if the timeout expires, the message will not be explicitly deleted - it will again appear in the head of the queue and become available for reading by other recipients. <br><br>  Correct processing of the message looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Retrieve storage account from connection string CloudStorageAccount storageAccount = CloudStorageAccount.Parse(_cloudConnectionString); // Create the queue client CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient(); // Retrieve a reference to a queue CloudQueue queue = queueClient.GetQueueReference("somecorrectqueuename "); while (true) { // Get the next message CloudQueueMessage retrievedMessage = queue.GetMessage(); if (retrievedMessage != null) { //Process the message in less than 30 seconds, and then delete the message queue.DeleteMessage(retrievedMessage); } else { Thread.Sleep(2000); } }</span></span></code> </pre><br><br>  Timeout for each message you can set your own (on the recipient side).  Messages can only contain lines that are encoded in base64 for forwarding.  In addition, there is an opportunity to "see" the contents of the message, without taking it from the queue, and you can read the message in "packets" - several at once. <br><br>  REST api is provided for working with Azure Storage Queue, which allows working with queues regardless of platform.  By the way, this is currently the only messaging technology in Azure, with which you can work directly from JS. <br><br>  As you can see, the service provides not very wide functionality, or rather, strictly defined.  Nevertheless, it provides an opportunity to raise the probability of message delivery to the recipient compared to forwarding messages using model A (without an intermediary).  Such a queue is well suited for architectures when the recipient is not always online.  Example - the sender performs some activity during the day, logs its activity in the queue, and at the end of the day the receiver appears in the network, processes this information, generates reports, for example, and again ‚Äúfalls asleep‚Äù until the next day. <br><br>  Finally, Azure Storage Queue is the cheapest messaging service in Azure. <br><br><h5>  <b>Azure Service Bus Queues, Azure Service Bus Topics &amp; Subscriptions</b> </h5><br>  Azure Service Bus is a service that provides several messaging capabilities.  In principle, they can be divided into two types: <br><ul><li>  Brokered bus - asynchronous messaging;  saves messages, sends them when the recipient is ready to read them, uses two mechanisms: 'queues' and 'topics and subscription' </li><li>  Relayed bus - synchronous messaging;  Messages are not saved anywhere, they are sent ‚Äúon Wednesday‚Äù and, if the recipient is ready, he will read them, if not - messages are lost. </li><li>  Azure Service Bus Queues (Fig. 3) assumes model B (Fig. 1).  It is fundamentally different from Azure Storage Queues in that messages from the broker are sent to the recipient when it reports readiness, and not vice versa.  You can also send several messages at a time (using transactions).  In addition, if Azure Storage Queues support the At-Least-Once delivery guarantee, that is, messages will be read at least once (or even under certain scenarios and more), Azure Service Bus Queues support At-Least-Once At ‚ÄúMost-Once Guaranteed‚Äù means that the message will be read no less and no more than once. </li></ul><br><br><img src="https://habrastorage.org/files/783/a0b/821/783a0b8218014c839c99a0559cfa6400.png"><br>  <i>Fig.</i>  <i>3</i> <br><br>  Azure Service Bus Topics &amp; Subscriptions (Fig. 4) also implements model B, but in a completely different way. <br><br><img src="https://habrastorage.org/files/6b1/35c/9c2/6b135c9c259b4821b570197910f08d52.png"><br>  <i>Fig.</i>  <i>four</i> <br><br>  In the service bus namespace, so-called topics are created.  This can literally be understood as ‚Äúthemes‚Äù.  Subscriptions to themes are also created there - subscriptions.  A message from the sender passes a specific topic (the sender decides which topic to send the message to) and already in the topic it is automatically filtered and copied into each subscription that satisfies the filter.  The message is not stored in the topic.  If there is no suitable subscription for the message, it disappears.  If there are several suitable subscriptions, it will be copied to each of them. <br><br>  Subscriptions create message recipients.  For each filter is specified (which may be empty, it will mean that all the messages that come to the corresponding topic will be copied to the subscription).  The filter can be changed without changing the subscription, while the messages that are already there will not be lost, and the new ones will be received by the updated filter. <br><br>  Reading messages by the recipient can be organized using two mechanisms: <b>ReceiveAndDelete</b> and <b>PeekLock</b> .  The first involves the usual reading of a message from the queue - after a request is received for a message in a subscription, it is sent to the recipient and removed from the queue.  The second mechanism, as in Azure Storage Queues, involves some kind of timeout to process the message.  And if, upon its expiration, there is no confirmation that the message was successfully processed, it again becomes visible to other recipients. <br><br>  Read more about Azure Storage Queues <a href="http://azure.microsoft.com/uk-ua/documentation/articles/storage-dotnet-how-to-use-queues/">here</a> . <br><br>  About Azure Service Bus Queues <a href="http://azure.microsoft.com/uk-ua/documentation/articles/service-bus-dotnet-how-to-use-queues/">here</a> . <br><br>  <a href="https://msdn.microsoft.com/en-us/library/azure/hh767287.aspx">A comparison of Azure Storage Queues and Azure Service Bus Queues</a> . <br><br>  About Azure Service Bus Topics &amp; Subscriptions <a href="http://azure.microsoft.com/uk-ua/documentation/articles/service-bus-dotnet-how-to-use-topics-subscriptions/">here</a> . <br><br>  Which implementation of messaging to choose for the project, you decide.  First of all, you need to build on how critical the delivery of messages is and how much you are willing to pay for it. <br><br>  In conclusion, I would like to note that Microsoft Azure technologies are developing very rapidly, new features appear, some become outdated, so it's always better to check the latest information on the official website. <br><br>  Author: Anastasia Belokurova, .NET Developer </div><p>Source: <a href="https://habr.com/ru/post/257975/">https://habr.com/ru/post/257975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257959/index.html">Conference YAPC :: Russia :: MayPerl 2015 in Moscow on May 16-17, do not miss</a></li>
<li><a href="../257965/index.html">Adobe has released a set of updates for its products.</a></li>
<li><a href="../257967/index.html">Bug fixes - phppgadmin</a></li>
<li><a href="../257969/index.html">No need to host static sites on Heroku</a></li>
<li><a href="../257971/index.html">Books and educational resources on algorithmic trading</a></li>
<li><a href="../257977/index.html">Wiren Board 4 - controller for automation</a></li>
<li><a href="../257979/index.html">How I started working with nRF24LE or another way to program this chip</a></li>
<li><a href="../257981/index.html">Automatically Testing JavaFX Applications</a></li>
<li><a href="../257985/index.html">Development of MMO RPG - a practical guide. Server (Part 1)</a></li>
<li><a href="../257991/index.html">Features of API development on symfony2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>