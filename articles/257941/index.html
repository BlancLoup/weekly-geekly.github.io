<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LFS: The dark side of power. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 So, in the previous article, we started to build LFS, having stopped at the fact that we have assembled a temporary system that has all the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LFS: The dark side of power. Part 2</h1><div class="post__text post__text-html js-mediator-article"><h1>  Foreword </h1><br>  So, in the <a href="http://habrahabr.ru/post/257663/">previous article,</a> we started to build LFS, having stopped at the fact that we have assembled a temporary system that has all the necessary tools for further assembly. <br><br>  Now we will build the main system, performing the necessary settings for the work.  As this article continues the LFS cycle, let's get down to business without any special prefaces. <br><br>  However, before moving on, move a little away from the classical scheme proposed by the authors of the book and do this 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs ruby">$ su - lfs $ wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/roy.marples.name/downloads</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dhcpcd/dhcpcd</span></span>-<span class="hljs-number"><span class="hljs-number">6.7</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.tar.bz2 --directory-prefix=$LFS/sources $ wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.linuxfromscratch.org/blfs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/downloads/</span></span><span class="hljs-number"><span class="hljs-number">7.7</span></span>/blfs-bootscripts-<span class="hljs-number"><span class="hljs-number">20150304</span></span>.tar.bz2 --directory-prefix=$LFS/sources $ logout</code> </pre> <br><br>  The fact is that the standard documentation concerning the assembly of the base system does not describe the process of setting up the network when you receive an ip-address from a DNS provider, or if a dynamic ip gives you your home router.  Or if you are building a VM that has access to the network through NAT. <br><br>  Therefore, after we collect everything and everything, we will additionally install and configure a DHCP client, which will allow the fresh system to get ip immediately after a reboot and still have access to the network.  This step already refers to the book BLFS. <br><a name="habracut"></a><br><h1>  1. Chroot, Great and Awful </h1><br>  First of all, again, let's make the root user the owner of the $ LFS / tools directory <br><br><pre> <code class="hljs ruby">$ su - root <span class="hljs-comment"><span class="hljs-comment"># export LFS=/mnt/lfs # chown -R root:root $LFS/tools</span></span></code> </pre><br><br>  Before that, he belonged to the user lfs, but this user is in the host system and he is not (there are no users there yet!) In the system we are collecting.  All further actions will be performed as root in the section where the system is built.  In this regard, we need to solve the following problems <br><ul><li>  <b>Problem # 1</b> (main): All paths that we will use must start from the root of the real system.  This is vital for the normal operation of the entire assembled environment and the system core. <br></li><li>  <b>Problem # 2</b> (attendant): taking into account that the installation paths of binary files in the assembled system and the host system are the same (or almost the same), it is necessary to ‚Äúfence off‚Äù the system directories of the host and the assembled system from each other. <br></li></ul><br>  Both problems are solved by the chroot command, which allows changing the root directory of the system on the fly.  The chroot field on the $ LFS section all paths to LFS directories will begin with "/", that is, we create the appearance of work in the root of the system being assembled.  Those directories that are above $ LFS (that is, the / mnt / lfs directory) will be completely cut off and will not be accessible to them.  This is great - all actions performed by us as root will not affect the host system.  But we will need access to the VFS ‚Äî the virtual file system of the host machine formed by the directories / dev, / proc, / sys, and / run.  We remember one of the basic concepts of unix - ‚Äúeverything is a file‚Äù.  We will need access to equipment and system resources, and it is done by working with VFS objects. <br><br>  Access to host directories from chroot is possible if you pre-mount the necessary directories to the corresponding LFS directories.  To do this, perform the following operations.  Create VFS Mount Points <br><br><pre> <code class="hljs mel"># mkdir -pv $LFS/{dev,<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>,sys,run}</code> </pre><br><br>  Create character devices / dev / console and / dev / null <br><br><pre> <code class="hljs swift"># mknod -m <span class="hljs-number"><span class="hljs-number">600</span></span> $<span class="hljs-type"><span class="hljs-type">LFS</span></span>/dev/console <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> # mknod -m <span class="hljs-number"><span class="hljs-number">666</span></span> $<span class="hljs-type"><span class="hljs-type">LFS</span></span>/dev/null <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><br>  The <i>-m</i> switch defines access rights to the device file;  <i>c</i> - indicates that the device is a character, and the following digits - the major and minor number of the device.  The first characterizes the type of character device, the second - the device number in the system. <br><br>  / dev / console provides a terminal system, / dev / null is most often used to get data from an empty file, or to redirect output to nowhere. <br><br>  Now we will mount the virtual file system in a special way.  Such a mount is often called a "binding" - when it is executed, the contents of the mounted directory are mapped to the directory specified as the mount point. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mount -v --bind /dev $LFS/dev</span></span></code> </pre><br><br>  Now our temporary system will have access to device files.  Mount the remaining VFS nodes <br><br><pre> <code class="hljs mel"># mount -vt devpts devpts $LFS/dev/pts -o gid=<span class="hljs-number"><span class="hljs-number">5</span></span>,mode=<span class="hljs-number"><span class="hljs-number">620</span></span> # mount -vt <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> $LFS/<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> # mount -vt sysfs sysfs $LFS/sys # mount -vt tmpfs tmpfs $LFS/run</code> </pre><br><br>  / dev / pts is a file system that provides access to pseudo terminals.  It is mounted with the gid = 5 identifier of the tty group with 620 access rights (-rw- -r- ---). <br><br>  / proc is a virtual file system containing information about the processes running on the system. <br><br>  / sys - virtual file system that adds to the user space information about devices and drivers present in the system <br><br>  / run is a virtual file system designed to create temporary files in the early stages of system boot.  Previously, such files were created in / dev, but at the initiative of Lenard Pottering, in connection with the advancement of systemd, an additional directory was added for this purpose. <br><br>  In addition, on some host systems, symbolic links to / run / shm may exist in / dev - temporary files for accessing shared memory.  We check their availability on our host and, if necessary, create them in the temporary system <br><br><pre> <code class="hljs ruby">$ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -h $LFS/dev/shm ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> &gt; mkdir -pv $LFS/$(readlink $LFS/dev/shm) &gt; fi</code> </pre><br><br>  Now, after the ‚Äúchruta‚Äù, we get the structure shown schematically in the following figure. <br><br>  <i>LFS directory tree relative to host system</i> <br><img src="https://habrastorage.org/files/331/732/2de/3317322de9bd49ce979f50cb50e88ea2.png"><br><br>  Actually we are now entering the temporary system. <br><br><pre> <code class="hljs tex"># chroot "<span class="hljs-formula"><span class="hljs-formula">$LFS" /tools/bin/env -i </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; HOME=/root </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; TERM="$</span></span>TERM" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; PS1='<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">$</span></span></span></span> ' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; PATH=/bin:/usr/bin:/sbin:/usr/sbin:/tools/bin <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; /tools/bin/bash --login +h</code> </pre><br><br>  The command changes the system root directory to $ LFS and executes two commands - / tools / bin / env - creates a new ‚Äúclean‚Äù user environment, assigning some variables: HOME - the position of the home directory;  TERM - terminal type;  PS1 - command line prompt format;  PATH - list of paths to executable files;  / tools / bin / bash --login + h - launches a new instance of the command shell, and the launch is performed as an entrance to a separate user session with disabling hashing of the paths to executable files.  Note - we use programs (env and bash) compiled by us at the previous stage. <br><br>  After executing the commands, we get the following result <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">I</span></span> have <span class="hljs-literal"><span class="hljs-literal">no</span></span> name!:/<span class="hljs-comment"><span class="hljs-comment"># ls dev proc run sources sys tools</span></span></code> </pre><br>  The root of the system has successfully changed, and at the command line prompt there is a warning ‚ÄúI have no name!‚Äù, Which occurs due to the absence of the / etc / passwd file in the system.  Do not let this confuse you, we will create a file soon. <br><br>  <b>Note</b> : Building the system can take a long time, so the VFS mount and chroot commands can be combined into a script in order to simplify entry into the assembled system after turning off the computer. <br><br><h1>  2. Creating the necessary directories and files </h1><br>  Now we need to create a directory tree of our system. <br><br><pre> <code class="hljs pgsql"># mkdir -pv /{bin,boot,etc/{opt,sysconfig},home,lib/firmware,mnt,opt} # mkdir -pv /{media/{floppy,cdrom},sbin,srv,var} # install -dv -m <span class="hljs-number"><span class="hljs-number">0750</span></span> /root # install -dv -m <span class="hljs-number"><span class="hljs-number">1777</span></span> /tmp /var/tmp # mkdir -pv /usr/{,<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/}{bin,<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>,lib,sbin,src} # mkdir -pv /usr/{,<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/}<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/{color,dict,doc,<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>,locale,man} # mkdir -v /usr/{,<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/}<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/{misc,terminfo,zoneinfo} # mkdir -v /usr/libexec # mkdir -pv /usr/{,<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/}<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/man/man{<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>} # <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $(uname -m) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &gt; x86_64) ln -sv lib /lib64 &gt; ln -sv lib /usr/lib64 &gt; ln -sv lib /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib64 ;; &gt; esac # mkdir -v /var/{<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>,mail,spool} # ln -sv /run /var/run # ln -sv /run/<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> # mkdir -pv /var/{opt,<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>,lib/{color,misc,locate},local}</code> </pre><br><br>  Directories created by the mkdir command have, by default, 755 access (drwx rx rx).  The install command is used in this case to create directories with a specific meaning of access attributes: 0750 (drwx rx ---) for / root - the root directory of the home directory;  1777 (drwx rwx rwx) for / tmp and / var / tmp are directories for hosting temporary files that all users of the system should have access to.  However, it is necessary to prohibit the movement of files of another user contained in the temporary directory.  For this, the so-called sticky bit is cocked, indicating that deleting files in the temporary directory is allowed only to their owner. <br><br>  In case a 64-bit system is built, it is necessary to create symbolic links leading to the / lib directory containing the system libraries.  In addition, some programs use hard-coded paths to the necessary components of the system.  While we are working on a temporary system, these paths will be different (for example, all executable files are currently located in the / tools / bin directory), therefore, it is necessary to create symbolic links to correct this discrepancy <br><br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment"># ln -sv /tools/bin/{bash,cat,echo,pwd,stty} /bin # ln -sv /tools/bin/perl /usr/bin # ln -sv /tools/lib/libgcc_s.so{,.1} /usr/lib # ln -sv /tools/lib/libstdc++.so{,.6} /usr/lib # sed 's/tools/usr/' /tools/lib/libstdc++.la &gt; /usr/lib/libstdc++.la # ln -sv bash /bin/sh</span></span></code> </pre><br><br>  Traditionally, in Linux, the list of mounted file systems was located in the / etc / mtab file.  However, modern kernels use the / proc virtual file system for this.  Create a symbolic link <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># ln -sv /proc/self/mounts /etc/mtab</span></span></code> </pre><br><br>  for programs that continue to use / etc / mtab. <br><br>  Now we need to create the / etc / passwd file containing the list of users registered in the system. <br><br><pre> <code class="hljs pgsql"># cat &gt; /etc/passwd &lt;&lt; "EOF" &gt; root:x:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>:root:/root:/bin/bash &gt; bin:x:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:bin:/dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>:/bin/<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> &gt; daemon:x:<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>:Daemon <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>:/dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>:/bin/<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> &gt; messagebus:x:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:D-Bus Message Daemon <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>:/var/run/dbus:/bin/<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> &gt; nobody:x:<span class="hljs-number"><span class="hljs-number">99</span></span>:<span class="hljs-number"><span class="hljs-number">99</span></span>:Unprivileged <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>:/dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>:/bin/<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> &gt; EOF</code> </pre><br><br>  using for this purpose the redirection of standard input to the file, since in the temporary system we do not have a text editor.  This text file has the following format - each line contains information about the user in the form <br><br><pre> <code class="hljs ruby">&lt;login&gt;<span class="hljs-symbol"><span class="hljs-symbol">:&lt;password&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;UID&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;GID&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;GECOS&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;home&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;shell&gt;</span></span></code> </pre><br><br><ul><li>  login - username in the system <br></li><li>  password is a password hash that was previously stored here, but now moved to a separate / etc / shadow file, which is not readable by the average user.  Instead, the placeholder "x" is now put. <br></li><li>  UID - user ID - a number from 0 to 2 <sup>32</sup> - 1. Actually, the main purpose of this file is to match the login and user ID. <br></li><li>  GID - the default group identifier in which the user is included <br></li><li>  GECOS - information field that stores additional information about the user.  It has no clear syntax and in fact can contain any comments on this account. <br></li><li>  home - the absolute path to the user's home directory <br></li><li>  shell - the command shell used in this user's session <br></li></ul><br><br>  A colon is used as a field separator.  Our file contains a description of the superuser root, as well as special users bin, daemon, a messagebus on whose behalf some programs and services are started. <br><br>  The unprivileged user nobody has a separate meaning - on its behalf we will run tests of some collected system components.  Since we do not yet have access to the useradd utility of this user, as well as others, we create it manually. <br><br>  Manually create and the necessary set of user groups in the / etc / group file <br><br><pre> <code class="hljs pgsql"># cat &gt; /etc/<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> &lt;&lt; "EOF" &gt; root:x:<span class="hljs-number"><span class="hljs-number">0</span></span>: &gt; bin:x:<span class="hljs-number"><span class="hljs-number">1</span></span>:daemon &gt; sys:x:<span class="hljs-number"><span class="hljs-number">2</span></span>: &gt; kmem:x:<span class="hljs-number"><span class="hljs-number">3</span></span>: &gt; tape:x:<span class="hljs-number"><span class="hljs-number">4</span></span>: &gt; tty:x:<span class="hljs-number"><span class="hljs-number">5</span></span>: &gt; daemon:x:<span class="hljs-number"><span class="hljs-number">6</span></span>: &gt; floppy:x:<span class="hljs-number"><span class="hljs-number">7</span></span>: &gt; disk:x:<span class="hljs-number"><span class="hljs-number">8</span></span>: &gt; lp:x:<span class="hljs-number"><span class="hljs-number">9</span></span>: &gt; dialout:x:<span class="hljs-number"><span class="hljs-number">10</span></span>: &gt; audio:x:<span class="hljs-number"><span class="hljs-number">11</span></span>: &gt; video:x:<span class="hljs-number"><span class="hljs-number">12</span></span>: &gt; utmp:x:<span class="hljs-number"><span class="hljs-number">13</span></span>: &gt; usb:x:<span class="hljs-number"><span class="hljs-number">14</span></span>: &gt; cdrom:x:<span class="hljs-number"><span class="hljs-number">15</span></span>: &gt; adm:x:<span class="hljs-number"><span class="hljs-number">16</span></span>: &gt; messagebus:x:<span class="hljs-number"><span class="hljs-number">18</span></span>: &gt; systemd-journal:x:<span class="hljs-number"><span class="hljs-number">23</span></span>: &gt; <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>:x:<span class="hljs-number"><span class="hljs-number">24</span></span>: &gt; mail:x:<span class="hljs-number"><span class="hljs-number">34</span></span>: &gt; nogroup:x:<span class="hljs-number"><span class="hljs-number">99</span></span>: &gt; users:x:<span class="hljs-number"><span class="hljs-number">999</span></span>: &gt; EOF</code> </pre><br><br>  Each line describes a separate group in the format <br><br><pre> <code class="hljs ruby">&lt;group name&gt;<span class="hljs-symbol"><span class="hljs-symbol">:&lt;group</span></span> passwd&gt;<span class="hljs-symbol"><span class="hljs-symbol">:&lt;GID&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;users</span></span> list&gt;</code> </pre><br><br><ul><li>  group name - the symbolic name of the group <br></li><li>  group passwd - group password - contains ‚Äúx‚Äù because this field is obsolete and is not used at present <br></li><li>  GID - group ID <br></li><li>  users list - a list of users in a group, separated by commas. <br></li></ul><br><br>  I will briefly describe the purpose of each group. <br><br><ul><li>  root - a group of super users with root rights.  Under normal conditions, this is only the root user. <br></li><li>  bin, sys - these groups are preserved as historically existing, some programs do not work if they are not in the system <br></li><li>  kmem - kernel memory access group <br></li><li>  tape - device node access group <br></li><li>  tty - group access terminal devices (including the console) <br></li><li>  daemon - unprivileged daemon startup group <br></li><li>  floppy, cdrom, disk - groups of access to various types of disk drives <br></li><li>  lp is a group of access to a printer historically ‚Äúsitting‚Äù on a parallel LPT port. <br></li><li>  dialout - a group of access to devices that perform "dialing" during a network connection (modems) <br></li><li>  audio, video - access to multimedia devices <br></li><li>  usb - USB bus access group <br></li><li>  adm - access group for viewing system logs in the / var / log directory <br></li><li>  messagebus - group access to the transmission of messages between the devices D-BUS <br></li><li>  systemd-journal - access to systemd logs <br></li><li>  input - access to user input devices <br></li><li>  mail - access to e-mail services <br></li><li>  nogroup is an empty group <br></li><li>  users - ordinary, unprivileged, system users <br></li></ul><br><br>  You can now re-enter a user session. <br><br><pre> <code class="hljs pgsql">exec /tools/bin/bash <span class="hljs-comment"><span class="hljs-comment">--login +h</span></span></code> </pre><br><br>  and, voila, the system now knows the name of the user on whose behalf you are logged in <br><br><pre> <code class="hljs objectivec">root:/<span class="hljs-meta"><span class="hljs-meta">#</span></span></code> </pre><br><br>  We initialize some of the log files required by the system, assigning the appropriate rights. <br><br><pre> <code class="hljs javascript">root:<span class="hljs-regexp"><span class="hljs-regexp">/# touch /</span></span><span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/{btmp,lastlog,wtmp} root:<span class="hljs-regexp"><span class="hljs-regexp">/# chgrp -v utmp /</span></span><span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/lastlog root:<span class="hljs-regexp"><span class="hljs-regexp">/# chmod -v 664 /</span></span><span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/lastlog root:<span class="hljs-regexp"><span class="hljs-regexp">/# chmod -v 600 /</span></span><span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/btmp</code> </pre><br><br><h1>  3. The long and tedious process of building a GNU environment ... </h1><br>  This stage is the most laborious and long.  You have to <b>manually</b> collect all the necessary packages GNU-environment - the minimum set of programs that allows you to get a workable linux-system. <br><br>  I must say, as we move through the list of collected packages, the nervous tension increases - the list is quite extensive, and the operations are quite monotonous.  At some point, the question arises in my head - but to hell do I need it at all ???  The main thing here is to collect thoughts and an effort of will to overcome discouragement - everything started should be completed. <br><br>  The sequence of assembling packages is designed so that at the current stage all dependencies necessary for its implementation are satisfied.  So the order of assembly can not be violated. <br><br>  The assembly of each package is accompanied by detailed instructions, providing in general <br><br><ul><li>  applying patches to the source code of the package.  All necessary patches are downloaded by us and located in the / sources directory <br></li><li>  source editing performed by sed.  Here it is advisable to grasp the meaning of regular expressions defining the editing pattern, since thoughtless input of commands will most likely lead to errors.  And sed does not display error messages - if you make a mistake when entering the template, the operation may not be performed or will be executed incorrectly, which will be fatal to the build process. <br></li><li>  configuration  Separate attention to directory prefixes - when installing, all executable binaries, libraries and documentation should appear in their places. <br></li><li>  copying binary files, assigning rights to files and directories, creating symbolic links.  Some links may lead to non-existent FS points, so the syntax of symlink creation commands should be taken literally and should not allow any independent activity when constructing paths.  Follow the instructions rigorously! <br></li></ul><br><br>  And finally, the most important thing is the tests!  When building a temporary system, we ignored the tests, firstly because testing tools were not available to us, and secondly, there was no need for tests.  Now, when we collect the final versions of the system software, we are obliged to comprehensively check the result of the assembly for proper functioning.  This is especially true of the compiler, standard libraries and software assembly tools (assembler and linker). <br><br>  Do not skip testing if there is a note in the instructions stating that it should be completed.  Testing takes a lot of time, for example, building a GCC with tests takes place within 63 SBUs, which is about 150 minutes on my machine.  But we have no other choice. <br><br>  The instruction contains remarks about which tests may not take place with an indication of the reasons.  After the tests are completed, we verify the obtained result with the expected one according to the instructions.  The reference logs of all tests performed for the LFS 7.7 version are based on <a href="http://www.linuxfromscratch.org/lfs/build-logs/7.7/i7-5820K/">this link.</a> <br><br>  As an example, I‚Äôll give a squeeze from my GCC testing log. <br><br><div class="spoiler">  <b class="spoiler_title">GCC short test log</b> <div class="spoiler_text">  === g ++ Summary === <br><br>  # of expected passes 88501 <br>  # of unexpected successes 2 <br>  # of expected failures 443 <br>  # of unsupported tests 3058 <br>  /sources/gcc-build/gcc/testsuite/g++/../../xg++ version 4.9.2 (GCC) <br><br>  - === gcc Summary === <br><br>  # of expected passes 106352 <br>  # of expected failures 252 <br>  # of unsupported tests 1422 <br>  / sources / gcc-build / gcc / xgcc version 4.9.2 (GCC) <br><br>  === libatomic tests === <br>  - === libatomic Summary === <br><br>  # of expected passes 54 <br>  === libgomp tests === <br><br>  Running target unix <br><br>  === libgomp Summary === <br><br>  # of expected passes 693 <br>  === libitm tests === <br><br>  Running target unix <br><br>  === libitm Summary === <br><br>  # of expected passes 26 <br>  # of expected failures 3 <br>  # of unsupported tests 1 <br>  === libstdc ++ tests === <br><br>  - === libstdc ++ Summary === <br><br>  # of expected passes 9925 <br>  # of expected failures 41 <br>  # of unsupported tests 233 <br><br>  Compiler version: 4.9.2 (GCC) <br>  Platform: x86_64-unknown-linux-gnu <br></div></div><br><br>  which can be compared with the sample <br><br><div class="spoiler">  <b class="spoiler_title">The official GCC build log from the LFS authors</b> <div class="spoiler_text">  === gcc Summary === <br><br>  # of expected passes 106401 <br>  # of expected failures 252 <br>  # of unsupported tests 1404 <br>  / sources / gcc-build / gcc / xgcc version 4.9.2 (GCC) <br><br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / gcc' <br>  - === g ++ Summary === <br><br>  # of expected passes 88501 <br>  # of unexpected successes 2 <br>  # of expected failures 443 <br>  # of unsupported tests 3058 <br>  /sources/gcc-build/gcc/testsuite/g++/../../xg++ version 4.9.2 (GCC) <br><br>  - === libstdc ++ Summary === <br><br>  # of expected passes 9835 <br>  # of expected failures 41 <br>  # of unsupported tests 278 <br>  make [5]: Leaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libstdc ++ - v3 / testsuite' <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libstdc ++ - v3 / testsuite' <br>  Making check in python <br>  - === libgomp Summary === <br><br>  # of expected passes 693 <br>  make [5]: Leaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libgomp / testsuite' <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libgomp / testsuite' <br>  make [4]: ‚Äã‚ÄãEntering directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libgomp' <br>  true DO = all multi-do # make <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libgomp' <br>  - === libitm Summary === <br><br>  # of expected passes 26 <br>  # of expected failures 3 <br>  # of unsupported tests 1 <br>  make [5]: Leaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libitm / testsuite' <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libitm / testsuite' <br>  make [4]: ‚Äã‚ÄãEntering directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libitm' <br>  - === libatomic Summary === <br><br>  # of expected passes 54 <br>  make [5]: Leaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libatomic / testsuite' <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libatomic / testsuite' <br>  make [4]: ‚Äã‚ÄãEntering directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libatomic' <br>  true DO = all multi-do # make <br>  make [4]: ‚Äã‚ÄãLeaving directory '/ sources / gcc-build / x86_64-unknown-linux-gnu / libatomic' <br>  - === g ++ Summary === <br><br>  # of expected passes 88501 <br>  # of unexpected successes 2 <br>  # of expected failures 443 <br>  # of unsupported tests 3058 <br>  /sources/gcc-build/gcc/testsuite/g++/../../xg++ version 4.9.2 (GCC) <br><br>  - === gcc Summary === <br><br>  # of expected passes 106401 <br>  # of expected failures 252 <br>  # of unsupported tests 1404 <br>  / sources / gcc-build / gcc / xgcc version 4.9.2 (GCC) <br><br>  === libatomic tests === <br>  - === libatomic Summary === <br><br>  # of expected passes 54 <br>  === libgomp tests === <br><br>  Running target unix <br><br>  === libgomp Summary === <br><br>  # of expected passes 693 <br>  === libitm tests === <br><br>  Running target unix <br><br>  === libitm Summary === <br><br>  # of expected passes 26 <br>  # of expected failures 3 <br>  # of unsupported tests 1 <br>  === libstdc ++ tests === <br><br>  - === libstdc ++ Summary === <br><br>  # of expected passes 9835 <br>  # of expected failures 41 <br>  # of unsupported tests 278 <br><br>  Compiler version: 4.9.2 (GCC) <br>  Platform: x86_64-unknown-linux-gnu <br></div></div><br><br>  I was lucky - I got the results that coincide well with the proposed authors.  What and you want. <br><br><h1>  4. Re-login, clearing debug information, deleting temporary system </h1><br>  So, you have collected all the packages.  Congratulations - the most and most difficult part of the journey has been covered by you.  Now let's get into our new system. <br><br><pre> <code class="hljs tex"># logout # chroot <span class="hljs-formula"><span class="hljs-formula">$LFS /tools/bin/env -i </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; HOME=/root TERM=$</span></span>TERM PS1='<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">$</span></span></span></span> ' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; PATH=/bin:/usr/bin:/sbin:/usr/sbin <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; /tools/bin/bash --login</code> </pre><br><br>  restarting / tools / bin / bash with hashing enabled, and removing the / tools / bin directory from the search paths for executable files.  We cut off debug information <br><br><pre> <code class="hljs mel"># /tools/bin/find /{,usr/}{bin,lib,sbin} -type f \ &gt; -<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> /tools/bin/<span class="hljs-keyword"><span class="hljs-keyword">strip</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">strip</span></span>-debug <span class="hljs-string"><span class="hljs-string">'{}'</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span></code> </pre><br><br>  Clean temporary directory from files left after testing. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># rm -rf /tmp/*</span></span></code> </pre><br><br>  log in again, launching already ‚Äúcombat‚Äù bash <br><br><pre> <code class="hljs tex"># chroot "<span class="hljs-formula"><span class="hljs-formula">$LFS" /usr/bin/env -i </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; HOME=/root TERM="$</span></span>TERM" PS1='<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">$</span></span></span></span> ' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; PATH=/bin:/usr/bin:/sbin:/usr/sbin <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; /bin/bash --login</code> </pre><br><br>  Now we no longer need a temporary system - delete it <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># rm -rf /tools</span></span></code> </pre><br><br>  Fuh ... the main difficulties are over.  It remains for us to configure our system to boot, build the kernel, configure the network.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But I will write about this in the final article. </font></font><br><br> <i><a href="http://habrahabr.ru/post/258227/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ending should ...</font></font></a></i> </div><p>Source: <a href="https://habr.com/ru/post/257941/">https://habr.com/ru/post/257941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257929/index.html">Microsoft fixes an important vulnerability in Windows</a></li>
<li><a href="../257931/index.html">"Night of Museums" at ROBOTS</a></li>
<li><a href="../257935/index.html">All that is acquired by overwork. About using the free version of Arcserve UDP in everyday life</a></li>
<li><a href="../257937/index.html">New competition at PHDays: hacking mobile communications, electrical substations and routing protocols</a></li>
<li><a href="../257939/index.html">How Youtube banned our channel and how we restored it</a></li>
<li><a href="../257943/index.html">Budget device based on Arduino for the blind (open hardware)</a></li>
<li><a href="../257945/index.html">LoveQA mitap on RHS ++</a></li>
<li><a href="../257947/index.html">Developing an IR remote control for a camera</a></li>
<li><a href="../257949/index.html">Distributed transactions between RabbitMQ and MS SQL</a></li>
<li><a href="../257951/index.html">Vulnerability "VKontakte" allows you to get direct links to private photos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>