<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NeoQuest 2018: Cheating and only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all. Last week the next full-time stage of NeoQuest ended . So it's time to publish an analysis of some tasks. I know many have been waiti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NeoQuest 2018: Cheating and only</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ar/ac/3u/arac3utzewnaj8j6xszhypfyklg.png"><br><br>  Good day to all.  Last week the next full-time stage of <a href="https://neoquest.ru/timeline.php%3Fyear%3D2018%26part%3D1">NeoQuest ended</a> .  So it's time to publish an analysis of some tasks.  I know many have been waiting for this analysis, so I ask all those interested in a cat. <a name="habracut"></a><br><h1>  Hellish reverser - my amplua! </h1><br><img src="https://habrastorage.org/webt/hf/rp/ca/hfrpca-gr3jiox5cqmnydop2mxk.png"><br><br>  In the task we are offered to download the binary, and get acquainted with its source code, to search for vulnerabilities in it, download and unpack it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is only one directory in the archive, and as it is not difficult to guess, it contains the source code <i>LUA</i> , taken with <a href="https://github.com/lua/lua">git</a> .  We look at what has been changed: <br><img src="https://habrastorage.org/webt/b-/wm/ua/b-wmuafzc-4tk3jzjnkk6_jbz_q.png"><br><br>  As you can see, the new file <i>larray.c</i> was added, which apparently contains the vulnerable code.  Well, now let's try to determine the location of the flag.  Having connected to the server and pressing <b>TAB</b> twice, we can see in the current directory the file <b>FLAG __. TXT</b> <br><br>  OK.  Challenge accepted. <br>  In <i>LUA</i> you can probably execute console commands or just try to open the file.  However, not everything is so simple, not only was the new file added to the source code, but some functions were also excluded: <br><div class="spoiler">  <b class="spoiler_title">git diff lbaselib.c</b> <div class="spoiler_text"><pre><code class="diff hljs">gh0st3rs@user-pc:lua$ git diff lbaselib.c diff --git a/lbaselib.cb/lbaselib.c index 00452f2..52ec9c6 100644 --- a/lbaselib.c +++ b/lbaselib.c @@ -480,18 +480,18 @@ static int luaB_tostring (lua_State *L) { static const luaL_Reg base_funcs[] = { {"assert", luaB_assert}, {"collectgarbage", luaB_collectgarbage}, - {"dofile", luaB_dofile}, + // {"dofile", luaB_dofile}, {"error", luaB_error}, {"getmetatable", luaB_getmetatable}, {"ipairs", luaB_ipairs}, - {"loadfile", luaB_loadfile}, - {"load", luaB_load}, + // {"loadfile", luaB_loadfile}, + // {"load", luaB_load}, #if defined(LUA_COMPAT_LOADSTRING) - {"loadstring", luaB_load}, + // {"loadstring", luaB_load}, #endif {"next", luaB_next}, {"pairs", luaB_pairs}, - {"pcall", luaB_pcall}, + // {"pcall", luaB_pcall}, {"print", luaB_print}, {"rawequal", luaB_rawequal}, {"rawlen", luaB_rawlen}, @@ -502,7 +502,7 @@ static const luaL_Reg base_funcs[] = { {"tonumber", luaB_tonumber}, {"tostring", luaB_tostring}, {"type", luaB_type}, - {"xpcall", luaB_xpcall}, + // {"xpcall", luaB_xpcall}, /* placeholders */ {LUA_GNAME, NULL}, {"_VERSION", NULL},</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">git diff linit.c</b> <div class="spoiler_text"><pre> <code class="diff hljs">gh0st3rs@user-pc:lua$ git diff linit.c diff --git a/linit.cb/linit.c index 3c2b602..d7e03c9 100644 --- a/linit.c +++ b/linit.c @@ -41,17 +41,18 @@ */ static const luaL_Reg loadedlibs[] = { {LUA_GNAME, luaopen_base}, - {LUA_LOADLIBNAME, luaopen_package}, + // {LUA_LOADLIBNAME, luaopen_package}, {LUA_COLIBNAME, luaopen_coroutine}, {LUA_TABLIBNAME, luaopen_table}, - {LUA_IOLIBNAME, luaopen_io}, - {LUA_OSLIBNAME, luaopen_os}, + // {LUA_IOLIBNAME, luaopen_io}, + // {LUA_OSLIBNAME, luaopen_os}, {LUA_STRLIBNAME, luaopen_string}, {LUA_MATHLIBNAME, luaopen_math}, {LUA_UTF8LIBNAME, luaopen_utf8}, - {LUA_DBLIBNAME, luaopen_debug}, + // {LUA_DBLIBNAME, luaopen_debug}, #if defined(LUA_COMPAT_BITLIB) {LUA_BITLIBNAME, luaopen_bit32}, + {LUA_ARRAY, luaopen_array}, #endif {NULL, NULL} };</code> </pre> <br></div></div><br>  But looking at the changes in the makefile, you can see that the <i>TESTS</i> module was left on purpose or by mistake. <br><div class="spoiler">  <b class="spoiler_title">git diff makefile</b> <div class="spoiler_text"><pre> <code class="diff hljs">gh0st3rs@user-pc:lua$ git diff makefile diff --git a/makefile b/makefile index 8160d4f..d9df7e8 100644 --- a/makefile +++ b/makefile @@ -53,12 +53,12 @@ LOCAL = $(TESTS) $(CWARNS) -g # enable Linux goodies -MYCFLAGS= $(LOCAL) -std=c99 -DLUA_USE_LINUX -DLUA_COMPAT_5_2 -MYLDFLAGS= $(LOCAL) -Wl,-E +MYCFLAGS= $(LOCAL) -std=c99 -DLUA_USE_LINUX -DLUA_COMPAT_5_2 -fPIE -fPIC # -fsanitize=address -fno-omit-frame-pointer +MYLDFLAGS= $(LOCAL) -Wl,-E # -fsanitize=address MYLIBS= -ldl -lreadline -CC= clang-3.8 +CC= gcc # clang-5.0 CFLAGS= -Wall -O2 $(MYCFLAGS) AR= ar rcu RANLIB= ranlib @@ -74,7 +74,7 @@ LIBS = -lm CORE_T= liblua.a CORE_O= lapi.o lcode.o lctype.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o \ lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o \ - ltm.o lundump.o lvm.o lzio.o ltests.o + ltm.o lundump.o lvm.o lzio.o ltests.o larray.o AUX_O= lauxlib.o LIB_O= lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o \ lutf8lib.o lbitlib.o loadlib.o lcorolib.o linit.o @@ -194,5 +194,6 @@ lvm.o: lvm.c lprefix.h lua.h luaconf.h ldebug.h lstate.h lobject.h \ ltable.h lvm.h lzio.o: lzio.c lprefix.h lua.h luaconf.h llimits.h lmem.h lstate.h \ lobject.h ltm.h lzio.h +larray.o: larray.c # (end of Makefile)</code> </pre> <br></div></div><br>  Googling how it can be used, we arrive at a simple code to extract the flag: <br><pre> <code class="lua hljs">L1 = T.newstate() T.<span class="hljs-built_in"><span class="hljs-built_in">loadlib</span></span>(L1) a,b,c = T.doremote(L1, <span class="hljs-string"><span class="hljs-string">[[ os = require'os'; os.execute('cat FLAG__.TXT') ]]</span></span>)</code> </pre><br>  What the code does: <br><ol><li>  First we initiate a new test context. </li><li>  Then we load libraries for working with FS. </li><li>  And through <i>doremote we</i> execute system commands in a test context. </li></ol><br>  After execution we get the key: <b>c91a8674a726823e9edad1a4262da4be7f216d74</b> <br><br><h1>  QEMU + Ecos = QEcos </h1><br><img src="https://habrastorage.org/webt/bw/az/ru/bwazrux3w1hgj-sgvxda2bpaug4.png"><br><br>  This year, it was also not without assignments with <i>QEMU</i> .  In the task 2 keys are hidden, having found which it was possible to receive +200 points.  Let's start: <br>  After downloading all 3 files, let's start studying them: <br><img src="https://habrastorage.org/webt/eq/gu/5d/eqgu5dnbmabr5wbfshowauaiwns.png"><br><br>  The first thing you have to deal with is a modified order of bytes in the dump; it is easy to determine this by running the command: <br><pre> <code class="bash hljs">$ strings dump.bin .... :CCGbU( utnu3.6 1-0.ubu22utn.6 ) 0.371026040</code> </pre> <br>  In <i>Python,</i> this is solved quite simply: <br><div class="spoiler">  <b class="spoiler_title">revert.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import sys fixed = open(sys.argv[2], 'wb') dump = open(sys.argv[1], 'rb').read() [fixed.write(dump[x:x + 4][::-1]) for x in range(0, len(dump), 4)] fixed.close()</span></span></code> </pre> <br></div></div><br>  After the conversion, you can work with the dump: <br><img src="https://habrastorage.org/webt/tx/zy/bx/txzybxeycj0l9hpxvt7tehekefk.png"><br><br>  And so, we have 2 <i>eCos</i> images and a header, the images are separated by zeros between them.  through dd cut it into 3 parts, they will be needed later. <br>  But at the beginning, we will try to launch the first image to find out what is required of us: <br><img src="https://habrastorage.org/webt/il/ay/ex/ilayexqnnhva3kdxhbienfnk-4e.png"><br><br>  After downloading, you need to enter a password, and if it turns out to be wrong, we get the message: <i>AUTH FAIL</i> <br>  Unpack the image and send it to IDA.  Further by cross-references we find a function that displays an error message: <br><div class="spoiler">  <b class="spoiler_title">print_fail</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hw/rr/q0/hwrrq0bwys087uhj0e8ra75c04o.png"><br></div></div><br>  We rise to the level above, where we see 2 conditions under which the test fails: <br><div class="spoiler">  <b class="spoiler_title">led_check</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_9/0u/wx/_90uwxsxsfactj89jtryxzmkz84.png"><br></div></div><br>  Things are easy: <br><ul><li>  Patch these transitions </li><li>  Archive the ecos.bin file and paste it into the unpacker </li><li>  Using the mkimage utility we build a new image for u-boot </li><li>  And check the result </li></ul><br>  After launching a new image to any password, we receive a message with a string that needs to be entered into the u-boot: <br><blockquote>  Auth process started ... <br><br>  =============== <br>  === AUTH OK === <br>  =============== <br><br>  use this key in u-boot: 4a2 # * a11gpiun% 25 <br></blockquote><br>  Enter and get another key (previously taking from the line sha1 hash): <b>ddf5957cd43a3712e0c67d019a37223043ae6df5</b> <br><img src="https://habrastorage.org/webt/8b/jm/oj/8bjmojc4gon6hwmsqnkn_u8ohxg.png"><br><blockquote>  PS As it turned out later, there was a <i>race condition</i> type vulnerability - it was necessary to change the combination while checking it </blockquote><br>  With the second key, everything is a little more complicated.  If you try to run the second image (for this you need to collect the dump in this order: header -&gt; image2 -&gt; image1, or simply change the boot parameters in the u-boot), then the image will not load, but will swear at the wrong CRC32 value: <br><img src="https://habrastorage.org/webt/ol/e3/o4/ole3o4wlncczctwqgjzqmggjhge.png"><br><br>  After a long search, as well as comparing the image size and the number of entries in the log, we find the following: <br><ol><li>  Each block in the log is long: 0xE1 </li><li>  Total blocks: 0x48D1 </li><li>  A critical error has occurred in block 0x2580 </li><li>  It began with an offset in the block: [0x44, 0x47) i.e.  3 bytes </li></ol><br>  Comparing the dimensions of the block with the real position in the dump, we determine that in the second image the archive ecos.bin.gz is damaged.  There is nothing left but to truncate the missing 3 bytes, having the original CRC32 image and the position in which the error occurred. <br><div class="spoiler">  <b class="spoiler_title">bruteCRC.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import sys import binascii import os import subprocess import struct START_OFFSET=0xf5c5 END_OFFSET=0xf5c8 OUT_FILE=sys.argv[1]+'.patch' dump = open(sys.argv[1], 'rb').read() crc1 = struct.unpack('&gt;I', dump[24:28])[0] for x in range(0xa2, -1, -1): for y in range(0xff, -1, -1): for z in range(0xff, -1, -1): number='%02x%02x%02x' % (x,y,z) crc = binascii.crc32(dump[0x40:START_OFFSET] + binascii.unhexlify(number.encode()) + dump[END_OFFSET:]) if crc == crc1: print('Possible fix: %s' % number) print('Status: %s' % number)</span></span></code> </pre> <br></div></div><br>  Using the simplest script, run the brute force, and after some time we get the right combination.  Then you can collect the dump and run it, or just unpack the image and use <i>grep to</i> find the desired line: <br><pre> <code class="bash hljs">$ strings ecos.bin | grep KEY KEY: xs26k=b<span class="hljs-variable"><span class="hljs-variable">$km</span></span>*8_mNf</code> </pre><br>  Taking from the received line sha1 hash, we get another 1 key: <b>35f6e7d0d65097f29ad74a7aaf991f2166b0a492</b> <br><br><h1>  Specter </h1><br><img src="https://habrastorage.org/webt/k6/m_/xh/k6m_xhqndkapvkfoc6egwwonfge.png"><br>  Here the authors became very confused and suggested that we find and correct the so-called typos in the code.  I will give a list of corrections right away, and then I will tell you how they could be found: <br><div class="spoiler">  <b class="spoiler_title">List of fixes Address: OldBytes: NewBytes</b> <div class="spoiler_text">  0x7c3: 75: 74 <br>  0x7f0: 9d: 9c <br>  0x8bc: 75: 74 <br>  0xd86: 3e: 3f <br>  0x277e: f1: ee <br>  0x2ac1: 03: 02 <br>  0x2c79: 00 00 10: 10 04 00 <br>  0x3b19: 74: 70 <br>  0x3b73: 6A: 75 <br>  0x3b75: 5f 5f: 6e 65 <br>  0x3be7: 77: 6f <br>  0x52b0: 4f 4b: 4d 5a <br></div></div><br><h3>  Errors # 9 # 10 </h3><br>  At the very beginning, the function <i>check_cpu ()</i> is called in the <i>main</i> function at the address: <i>0x000000013FE517E7</i> : <br><img src="https://habrastorage.org/webt/jx/kq/tw/jxkqtwjixff50ztygx-wbjjnggw.png"><br><br>  Here there is a check that the processor model matches, but the string with which the comparison is made is erroneous.  In debugging, we see that the value should be correct: <b>GenuineIntel</b> <br><br><h3>  Error # 11 </h3><br>  Being in the function of generating the first key, we see that it is based on the string: <b>A docatca cells.</b>  Google search, prompted, its correct spelling: <b>A hecatonicosachoron or 120-cell is a regular polychoron having 120 dodecahedral cells.</b> <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53323</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte_13FE57030</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE5332A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">aAHecatwnicosac</span></span> ; "<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hecatwnicosachoron</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">or</span></span> 120<span class="hljs-selector-tag"><span class="hljs-selector-tag">-cell</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">is</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ar</span></span>"... <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53331</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53334</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 1</code> </pre> <br><br><h3>  Error # 5 </h3><br>  If you look below, we see the function call at the wrong offset: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE5337D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">near</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub_13FE53070</span></span>+3 <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53382</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movzx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+48h+arg_0]</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53387</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span></code> </pre> <br><br><h3>  Error # 1 </h3><br>  In the function at the address <i>0x000000013FE51390</i> , a second key is generated: <br>  During debugging, you can see that the conditional transition, after generating the first part of the key, is not true: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513B9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513BC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub_13FE53460</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513C1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513C3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jnz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_13FE513C9</span></span></code> </pre> <br><br><h3>  Error # 2 </h3><br>  The next thing that catches your eye when further viewing this function is not a valid offset when calling a function that accesses the registry: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513EF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">near</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_SoftwareType</span></span>+1 <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513F4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE513F6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_13FE51415</span></span></code> </pre> <br><br><h3>  Error # 6 </h3><br>  Going deeper into the <i>get_SoftwareType</i> function, and checking the arguments of the <i>RegOpenKeyExA</i> function, <i>we</i> understand that the value: <i>0x80000003</i> does not explicitly correspond to <b>HKEY_LOCAL_MACHINE</b> : <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536A9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+0D8h+hkey]</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536AE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">SubKey</span></span> ; "<span class="hljs-selector-tag"><span class="hljs-selector-tag">SOFTWARE</span></span>\\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span>\\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Windows</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NT</span></span>\\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Curren</span></span>"... <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536B5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r9d</span></span>, 20019<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">samDesired</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536BB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8d</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8d</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">ulOptions</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536BE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFFFFFFF80000003h</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">hKey</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536C5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+0D8h+var_90]</span></span>, 64<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536CD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+0D8h+phkResult]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">phkResult</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536D2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:RegOpenKeyExA</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE536D8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span></code> </pre> <br><br><h3>  Error # 7 </h3><br>  Scrolling through the function of generating a second key, to the next part, we see an attempt to get the home directory for the <i>explorer.exe</i> process, and it seems to be nothing ordinary, but from the documentation, you can see that the access mode is not specified correctly, and should be 0x410: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53871</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8d</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+278h+pe.th32ProcessID]</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">dwProcessId</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53876</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">bInheritHandle</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53878</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, 100000<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">dwDesiredAccess</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE5387D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:OpenProcess</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53883</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE53886</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span></code> </pre> <br><br><h3>  Error # 3 </h3><br>  When debugging a function that generates the third key, we note that another incorrect conditional transition, as a result, does not take into account the response from the executable call from resources: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514B1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">load_exe</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514B6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdi</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514B9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514BC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jnz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_13FE514D7</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514BE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+28h+a2]</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">a2</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514C3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">out_hash</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514C6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE514C9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">calc_sha</span></span></code> </pre> <br><br><h3>  Error # 8 </h3><br>  If you extract the <i>tmp.exe</i> file from the resources, then after a quick study it becomes clear that the only argument with which it works is <b>-p</b> : <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE51147</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">memset</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE5114C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE5114E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">CommandLine</span></span> ; "<span class="hljs-selector-tag"><span class="hljs-selector-tag">tmp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-t</span></span>" <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE51155</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp+118h+ProcessInformation.hProcess]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span></code> </pre> <br><br><h3>  Error # 12 </h3><br>  When trying to extract the <i>tmp.exe</i> file from resources, we notice that it does not have a valid header, we fix <b>OK</b> on <b>MZ</b> and everything works: <br><img src="https://habrastorage.org/webt/wd/v0/5p/wdv05pnbdju0wcgykdlu718edkm.png"><br><br><h3>  Error # 4 </h3><br>  It is strange that the second key completely duplicates the first one, because, as we remember, the result should be in the r15 register: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE51872</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key2</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE51877</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r15</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/e8/uz/vs/e8uzvsveb81eiavcu-1vvmivxis.png"><br><br>  But this is not all in the process of debugging and patching, we stumble on a couple of protective measures.  The first is the <i>Explained IsDebuggerPresent</i> : <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE517EE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_13FE51844</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE517F0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:IsDebuggerPresent</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE517F6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE517F8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loc_13FE51856</span></span></code> </pre> <br>  The second is to check the integrity of the file based on the sha1 hash: <br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516C3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+original_hash]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">D8086BF9h</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516CA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+original_hash+4]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">AA45EFE5h</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516D1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+original_hash+8]</span></span>, 492519<span class="hljs-selector-tag"><span class="hljs-selector-tag">ECh</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516D8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+original_hash+0Ch]</span></span>, 212<span class="hljs-selector-tag"><span class="hljs-selector-tag">C9756h</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516DF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+var_30]</span></span>, 5<span class="hljs-selector-tag"><span class="hljs-selector-tag">BB58EA1h</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516E6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+hash]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">bl</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516E9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+hash+1]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516ED</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+var_17]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516F1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+var_F]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ax</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516F5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+var_D]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516F8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">calc_sha</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE516FD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+hash]</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000013FE51701</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">qword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp+original_hash]</span></span></code> </pre> <br>  The integrity check function can either be scored by nop-s, or at the very end simply correct the original hash. <br><br>  After all these changes, we immediately get all 3 keys: <br>  First key: <b>2A 93 E7 6A F5 BB E0 92 83 E5 99 E6 63 6D 04 1C 95 9B 3C D7</b> <br>  Second key: <b>B2 D7 CC 3F 58 03 EB C6 4D 14 8E A6 AB 2E FC 10 DE B1 45 8D</b> <br>  Third key: <b>DB 0D 81 6E 50 63 BA 13 65 2F 35 7B 1F 7C E9 FC 1E A1 C1 C6</b> </div><p>Source: <a href="https://habr.com/ru/post/351484/">https://habr.com/ru/post/351484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351470/index.html">New 4G LTE vulnerabilities: mass mailing, impersonation of subscriber devices and others</a></li>
<li><a href="../351476/index.html">Protection against creative abuse of HSTS</a></li>
<li><a href="../351478/index.html">Hyperpilot 100% open source for its products.</a></li>
<li><a href="../351480/index.html">[bookmark] JS developer tools to pay attention to</a></li>
<li><a href="../351482/index.html">Profiling: optimization</a></li>
<li><a href="../351486/index.html">Video conferencing in 7 steps</a></li>
<li><a href="../351488/index.html">Digital events in Moscow from March 19 to March 25</a></li>
<li><a href="../351490/index.html">KOMPAS-3D Home - professional CAD software for home and hobby</a></li>
<li><a href="../351492/index.html">C ++ 20 is getting closer. Meeting in jacksonville</a></li>
<li><a href="../351496/index.html">Writing celestial bees on Cloud Haskell</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>