<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From ASP.Net to Node.JS: how we rewrote the server part of ONLYOFFICE editors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To the release of the ONLYOFFICE Enterprise Edition corporate solution, we rewrote the server-side code of our online editors at Node.JS and now, in f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From ASP.Net to Node.JS: how we rewrote the server part of ONLYOFFICE editors</h1><div class="post__text post__text-html js-mediator-article">  To the release of the <a href="http://www.onlyoffice.com/blog/2015/11/onlyoffice-enterprise-edition-released/">ONLYOFFICE Enterprise Edition</a> corporate solution, we rewrote the server-side code of our online editors at Node.JS and now, in fact, we want to share the experience of exemption from ASP.Net, which we were trapped five years ago. <br><br>  The transition to Node.JS was a logical continuation of the development of the cloud office on Linux.  The first version appeared for him almost a year ago - then we decided to use the Mono project.  We have already <a href="http://habrahabr.ru/post/246777/">talked</a> about the problems that arose when porting to Mono systems for collaboration.  At that time, work on editors for Linux was just beginning.  First came the beta version of ONLYOFFICE Document Server, also written using Mono.  Now it is available in open source version 3.0. <br><br>  In the new server solution ONLYOFFICE Enterprise Edition, we have included the updated ONLYOFFICE Document Editors 3.5 editors, already on Node.JS.  Why, how and what happened next. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/7b5/403/db5/7b5403db526c4c21928344d2b732aa36.jpg" alt="image"><br><a name="habracut"></a><br>  <b>Mono Motives</b> <br><br>  <u>1. Reducing the number of bugs</u> <br><br>  The use of someone else's product, albeit a good one (now we are talking about Mono), is fraught with multiplication of bugs exponentially.  We run our code, conditionally speaking, in the ‚Äúblack box‚Äù, in which almost anything happens to it.  The number of our bugs is multiplied by the number of bugs of someone else's product and, as a result, an endless struggle for stability begins, which often has to be started anew with the release of regular (and extraordinary) updates. <br><br>  <u>2. Cross-platform</u> <br><br>  We needed a cross-platform code for desktop editors running on all operating systems, including mobile ones.  Just recently, <a href="http://www.onlyoffice.com/blog/2015/11/onlyoffice-documents-1-2-dlya-ios-dostupno-v-appstore/%3Flang%3Dru">ONLYOFFICE Documents for iOS was released,</a> with the ability to edit text and view tables, pdf-files and presentations.  We do not plan to dwell on this, but plans are on later. <br><br>  By and large, we realized that ASP.Net and Mono had stopped responding to our needs, and we asked ourselves: what should we write on next? <br><br>  <b>Why Node.JS?</b> <br><br>  Having considered several options (among them Ruby, Java, Python, Node.JS), we chose the latter.  The reasons for the choice are fairly obvious: we already had quite a good experience with this platform - the editors of the server parts were written on Node.JS: the CoAuthoring and SpellChecker services. <br><br>  In the process of work, we tried to lay in the architecture the possibilities of more stable operation, scaling and clustering.  In addition, I had to face some difficulties associated with the features of Node.JS.  Tell about it in more detail. <br><br>  <b>Difficulties in moving to Node.JS</b> <br><br>  <u>1. Problem with bit operations</u> <br><br>  <b>What happened:</b> In JavaScript, before bit operations, the number is converted to 32-bit signed int <br><br>  For example, we had C # code: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteCount = Math.Min(<span class="hljs-number"><span class="hljs-number">5</span></span>, data.Length - i); <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> buffer = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; byteCount; ++j) { buffer = (buffer &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[i + j]; }</code> </pre> <br><br>  <b>Problem:</b> In Node.JS after the loop, the variable buffer becomes 2 ^ 40 and contains an incorrect number. <br><br>  <b>Solution in Node.JS:</b> To avoid "transformations", we rewrote such places without bit operations. <br><br><pre> <code class="cs hljs">buffer = (buffer * <span class="hljs-number"><span class="hljs-number">256</span></span>) + data[i + j];</code> </pre><br><br>  <u>2. The problem with downloading the file</u> <br><br>  <b>What was:</b> Files are downloaded by reference when converting documents.  In C #, the System.Net.HttpWebRequest class was used for downloading. <br><br>  <b>Problem:</b> In Node.JS there are two standard modules for web requests - http and https.  The interfaces of the modules are exactly the same, and the developer must manually select which module to use in each particular case.  At the same time, standard modules do not support automatic navigation to the address specified in the redirection header, if the server returns status 301 or 302. <br><br>  <b>Solution in Node.JS:</b> We used an additional module that wraps standard modules and automatically solves the problem with the choice between http and https and redirects.  There are several similar modules in Node.JS - of which our choice fell on ‚Äúrequest‚Äù. <br><br>  <u>3. Problem with processing requests</u> <br><br>  <b>What happened:</b> In C #, we created a descendant class from IHttpAsyncHandler or IHttpHandler to handle requests.  Thus, all request processing was out of the box. <br><br>  <b>Problem:</b> Node.JS does not have built-in modules for processing requests, so it had to be assembled ‚Äúby itself‚Äù. <br><br>  <b>Solution in Node.JS:</b> To process requests in Node.JS, we use the ‚Äúexpress‚Äù module, and in order to have access to the POST request body, the ‚Äúbody-parser‚Äù module. <br><br>  To handle POST with multipart / form-data, we chose from a variety of modules with similar functionality.  The possible options (multiparty, busboy, formidable) differ in the interface, settings, the ability to disable the recording of a temporary file in the temp and support threads.  We chose ‚Äúmultiparty‚Äù ‚Äîwith it, you can directly write data as a stream in the Amazon S3 storage. <br><br>  <u>4. The problem with the features of the language and standard libraries</u> <br><br>  <b>What was:</b> One of the main advantages of C # is a large standard library and a diverse syntax. <br><br>  For example, in C # you can pass a parameter to a function by reference (ref) <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateIndexByOctetAndMovePosition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentPosition, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] index</span></span></span><span class="hljs-function">)</span></span></code> </pre><br><br>  <b>Problem:</b> If we rewrite this function in javascript ‚Äúin the forehead‚Äù, then the string passed as an argument will be copied.  When working with large lines, this will lead to wasting CPU time on copying them and increasing memory consumption. <br><br>  <b>Solution in Node.JS:</b> To prevent large lines from being copied when passed to a function, we had to either translate them into a binary format (Buffer), or wrap it into an object and pass it. <br><br>  In addition, in Node.JS there are no ‚Äúout of the box‚Äù functions for deleting non-empty directories, creating directories without parent subdirectories, working with xml, etc.  They had to finish their hands. <br><br>  <b>Results and plans</b> <br><br>  We received a new server that does not use ASP.Net, which is able to withstand heavy loads.  Pros for the end user: he does not fall or hang.  Pluses for us as developers: it does not fall or hang. <br><br>  But, naturally, everything was started not only for the sake of servers on Node.JS - we needed a cross-platform code, and we received it.  Now our editors will be able to work on any OS. <br><br>  Our desktop editors for Windows, MacOS and Linux are now preparing to release (yes, browsing also has some limitations that we want to overcome).  In addition, we continue to improve our online editors.  For example, very soon <a href="http://www.onlyoffice.com/blog/2015/11/onlyoffice-documents-1-2-dlya-ios-dostupno-v-appstore/%3Flang%3Dru">ONLYOFFICE Documents for iOS</a> , about which we wrote above, a table editor will appear (currently in testing) and a presentation editor (ibid.).  Android editors will be released in 2016. </div><p>Source: <a href="https://habr.com/ru/post/272047/">https://habr.com/ru/post/272047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272037/index.html">Release typescript 1.7</a></li>
<li><a href="../272039/index.html">Setting up public Internet access in five minutes</a></li>
<li><a href="../272041/index.html">Architecture and technological approaches to processing BigData on the example of "1C-Bitrix BigData: Personalization"</a></li>
<li><a href="../272043/index.html">Record of the webinar "What's new in Kerio Co. Connect 9"</a></li>
<li><a href="../272045/index.html">A bit about Yandex Protect</a></li>
<li><a href="../272049/index.html">Everything you wanted to know about models and collections in Titanium</a></li>
<li><a href="../272051/index.html">Want to integrate Telegram into Redmine? There is a solution</a></li>
<li><a href="../272053/index.html">Recommendations for writing C # code from Aviva Solutions</a></li>
<li><a href="../272055/index.html">Thinking out loud about TypeScript</a></li>
<li><a href="../272057/index.html">Accident history on the UPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>