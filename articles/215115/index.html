<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The tale of the lost Moscow time, or what were the wrong guys from Microsoft</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day, I regretfully discovered that the Windows operating system family contains incorrect information about Moscow time. It is noteworthy th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The tale of the lost Moscow time, or what were the wrong guys from Microsoft</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d33/6de/52b/d336de52bca6f8abc78badc12c8b84fc.jpg"><br><br>  The other day, I regretfully discovered that the Windows operating system family contains incorrect information about Moscow time.  It is noteworthy that the error has not yet been fixed, although it was leaked into the system back in 2011.  The consequences of the error will be shown using .NET, but this is relevant for all technologies that trust Windows data on time zones and time offsets. <br><a name="habracut"></a><br>  So, the time zone of Moscow is set on my car: <br><img src="https://habrastorage.org/getpro/habr/post_images/b2a/3f4/09c/b2a3f409c3c4c970ab0144338c149b85.png"><br><br>  We create date 09.03.2014 10:00 in UTC.  Then we translate it in Moscow time.  As you know, now for Moscow the offset <a href="http://ru.wikipedia.org/wiki/UTC%2B04:00">UTC + 04: 00</a> is valid all year round: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2014</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-comment"><span class="hljs-comment">//09.03.2014 10:00 UTC Console.WriteLine("UTC: {0},\nMoscow: {1}",dt, dt.ToLocalTime() );</span></span></code> </pre> <br>  We get: <br><blockquote>  UTC: 03/09/2014 10:00:00, <br>  Moscow: 03/09/2014 2:00:00 PM </blockquote><br>  Well, not bad.  However, plunge a little deeper into the past.  Before the cancellation of the transfer of clocks to winter time, our country translated the hands of clocks twice a year.  In winter, Moscow time had an offset of UTC + 03: 00, and in the summer of UTC + 04: 00. <br>  Repeat the operation for the date 09/03/2010 10:00 in UTC. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2010</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-comment"><span class="hljs-comment">//09.03.2010 10:00 UTC Console.WriteLine("UTC: {0},\nMoscow: {1}",dt, dt.ToLocalTime() );</span></span></code> </pre><br>  We get: <br><blockquote>  UTC: 3/9/2010 10:00:00, <br>  Moscow: 03/09/2010 2:00:00 PM </blockquote><br>  Something is wrong.  In March of 2010, the winter time was in effect, for which the shift should be +03: 00 hours, not +04: 00.  Similarly, for summer time (June 2010): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2010</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-comment"><span class="hljs-comment">//09.06.2010 10:00 UTC Console.WriteLine("UTC: {0},\nMoscow: {1}",dt, dt.ToLocalTime() );</span></span></code> </pre><br><blockquote>  UTC: 06/09/2010 10:00:00 <br>  Moscow: 06/09/2010 15:00:00 </blockquote><br>  In the summer, the offset was +04: 00, but we received an offset of +05: 00, which never happened in the Moscow time zone! <br><br><h4>  What is the matter? </h4><br>  Information about time zones is stored in the Windows registry and updated with patches.  Instead of using the <a href="http://ru.wikipedia.org/wiki/Tz_database">tz database</a> , which updates information on world time zones (and which is used in * nix systems, BSD systems and Mac OS X), Microsoft maintains its own database. <br><img src="https://habrastorage.org/getpro/habr/post_images/857/ad3/5b0/857ad35b0738c66bffdec87e9411c671.jpg"><br>  If you simplify a little, the information in it is stored as follows.  For the time zone, the base offset is indicated relative to UTC, followed by information on daylight saving time.  It talks about when the transition is performed and how the base offset changes.  Before the cancellation of the transition to winter time for Moscow, the following figures were in effect: <br><ul><li>  Base offset: UTC + 03: 00 </li><li>  Winter time = base offset </li><li>  Summer time = base offset +01: 00 </li></ul><br>  After the <a href="http://support.microsoft.com/gp/cp_dst/ru">abolition of the</a> transition to winter time, the <a href="http://support.microsoft.com/kb/2570791">hotfix</a> came <a href="http://support.microsoft.com/kb/2570791">out</a> , which was supposed to fix the year-round shift for UTC + 04: 00 for Moscow.  But there was an error.  Instead of setting permanent summer time, Microsoft changed the base offset from +03: 00 to +04: 00 and turned on permanent wintertime.  But the fact is that the Microsoft time zone database does not contain historical information about the change in base offset.  As a result, for dates before the summer of 2010 we get the following situation.  When winter time is in effect, its offset coincides with the base.  Before the release of the patch, it was +03: 00, and now it's +04: 00.  When summer time is in effect, it has an offset of +01: 00 relative to the baseline.  Previously, it turned out +04: 00, and after the patch was released it was +05: 00. <br><br>  After some time, this problem <a href="https://connect.microsoft.com/VisualStudio/feedback/details/686169/incorrent-utc-to-local-time-conversion-after-kb-2570791">was noticed</a> , and Microsoft prepared another <a href="http://support.microsoft.com/kb/2657025">hotfix</a> , which should have rectified the situation.  However, installing it does not fix the problem. <br><br>  At the moment, experimentally found that the error is reproduced on Windows 7, Windows 8, as well as Windows Server 2008 R2.  In the case of .NET, this problem can be solved by working with dates using the <a href="http://nodatime.org/">NodaTime</a> library, which uses the tz database. </div><p>Source: <a href="https://habr.com/ru/post/215115/">https://habr.com/ru/post/215115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215103/index.html">How to make friends LO and MSO. Part 2: Automatic test generation for docx and odt</a></li>
<li><a href="../215105/index.html">Games with UEFI</a></li>
<li><a href="../215107/index.html">A plugin that adds tabs to QtCreator</a></li>
<li><a href="../215109/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ99 (March 2 - 8, 2014)</a></li>
<li><a href="../215111/index.html">Running SSH commands on hundreds of servers using Go</a></li>
<li><a href="../215117/index.html">Simple language about HTTP</a></li>
<li><a href="../215119/index.html">Things everyone should do: Code Review</a></li>
<li><a href="../215121/index.html">Information and technological tools for the practical survival of social communities in the context of the Internet shutdown in 2014</a></li>
<li><a href="../215123/index.html">Two Bit Idiot Threatens Bitcoin Foundation Board of Directors</a></li>
<li><a href="../215125/index.html">Nietzsche, the rake and the craving for beauty</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>