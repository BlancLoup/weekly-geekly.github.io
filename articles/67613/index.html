<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Capifony. Or deploy symfony project through Capistrano</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I‚Äôve been programming PHP for a year now using the symfony framework, and I‚Äôm finding it a real pleasure. However, there are some site development pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Capifony. Or deploy symfony project through Capistrano</h1><div class="post__text post__text-html js-mediator-article">  I‚Äôve been programming PHP for a year now using the <a href="http://symfony-project.org/">symfony framework,</a> and I‚Äôm finding it a real pleasure.  However, there are some site development processes that this framework does not fully cover, and is not obliged =) <br>  One such process is deployment or deployment and update of a project on a production server.  To perform such a routine operation, many scripts have been written and one of the most popular is <a href="http://www.capify.org/index.php/Capistrano">Capistrano</a> .  It is extremely easy to learn, functionally perfect and extremely flexible in customization, however, it is sharpened out of the box under the deployment of RoR applications, which is why it was created. <br>  Today I will try to tell you how to use Capistrano for deployment of symfony projects. <br><a name="habracut"></a><br><h2>  What is capify? </h2><br>  Capistrano is a ruby ‚Äã‚Äãlibrary that performs a routine for rolling out a site and provides flexible means for timely rollback of a project to a previous version (previous deployment). <br>  Capistrano, by connecting via SSH, operates with remote directories, creating a new directory with the current code and creating the necessary <a href="http://en.wikipedia.org/wiki/Symbolic_link">symlinks</a> .  The current Capistrano code can copy from any other machine via an SSH server, use the GIT or SVN repositories.  Capify does not end there.  In principle, the script, if properly configured, is able to execute any set of unix commands on any number of remote systems (to which you have access, of course).  However, the greatest number of scripts and settings Capistrano has mainly for remote deployment of applications, which we are talking about today. <br>  capify - command for creating a Capistrano config <br><br><h2>  Standard Deployment Process </h2><br>  The implementation of the deployment process is divided into atomic operations-tasks, each of which is responsible for a separate aspect of rollout.  In this case, the global execution of the deployment behaves as a full-fledged <a href="http://en.wikipedia.org/wiki/Database_transaction">transaction,</a> and if at least one operation is not performed, the whole process is canceled, and the remote file system returns to the state before the deployment. <br>  Basic commands for capistrano: <br><ol><li><code>capify .</code>  - creates in the current directory files for the configuration of access to a remote system and setting up the process.  These files: <br><ol><li>  <em>Capfile</em> - the main script, tightened by the command "capify" </li><li>  <em>config / deploy.rb</em> - process settings, loaded into Capfile.  It is in this file that you need to register all our paths to the servers and settings before executing the following commands. </li></ol><br></li><li>  <code>cap deloy:setup</code> - deploys on a remote server / servers (there may be several) the file structure for subsequent deployment processes </li><li>  <code>cap deploy</code> - performs deployment.  At the same time, a new directory for the project is created, symlinks are made in it on shared (shared) resources and then, a symlink of current is made on this directory, slipping the actual code to the web server </li><li>  <code>cap rollback</code> - roll back to the previous deployment.  At the same time, the directory with the current version is deleted (with a hard-core rollback), and the current symlink is interrupted by the previous deployment directory. </li></ol><br><br><h2>  Why do you need capifony? </h2><br>  As I said, capistrano was originally created for deploying RoR applications and there are some places that are tied to it (out of the box) for this framework.  For example, the structure and list of shared folders in Rails and symfony projects are different.  When deploying a symfony project, you also need to do some tasks, such as <code>symfony plugin:publish-assets</code> to create symlinks for plug-in assets, <code>symfony cc</code> to reset the cache, and <code>symfony fix-perms</code> to restore permishenes to cache and / or web uploads folders. <br>  To solve all these problems, I slightly expanded the base deployment scripts of capistrano, which gave birth to <strong>capifony</strong> <br>  Download the script and take part in its development here: <a href="http://github.com/everzet/capifony/tree/master">http://github.com/everzet/capifony/tree/master</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Using </h2><br>  So, we have a project that needs to be deployed on a production server.  This project is stored in a remote git repository on the production server (it may not be git and the code can be stored anywhere, where there is SSH access and in any form that Capistrano knows, but he knows a lot =)). <br>  First, we move to the local directory with the project that needs to be uploaded and the remote git repository of which is located on the server: <br><ol><li>  At the root, we execute the capify <code>capify .</code>  that creates <em>Capfile</em> in the root and <em>deploy.rb</em> in config / </li><li>  Download the file <em>capifony.rb</em> from the <a href="http://github.com/everzet/capifony/tree/master">github</a> and put it in the config / </li><li>  At the end of <em>Capfile we</em> add <code>load 'config/capifony'</code> </li><li>  And the final touch - we register the connection settings to the remote server in deploy.rb: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">set</font> :application, <font color="#A31515">"YOUR_APPLICATION_NAME"</font> &lt;br&gt; <font color="#0000ff">set</font> :repository, <font color="#A31515">"YOUR_SSH_SERVER_NAME:/PATH/TO/repos/#{application}.git"</font> &lt;br&gt; <font color="#0000ff">set</font> :deploy_to, <font color="#A31515">"/PATH/TO/www/#{application}.com"</font> &lt;br&gt; <font color="#0000ff">set</font> :scm, <font color="#A31515">"git"</font> &lt;br&gt;&lt;br&gt;default_run_options[:pty] = <font color="#0000ff">true</font> &lt;br&gt;ssh_options[:forward_agent] = <font color="#0000ff">true</font> &lt;br&gt;&lt;br&gt;server <font color="#A31515">"YOUR_SSH_SERVER_NAME"</font> , :web, :app, :db</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br></li><li>  Now we call <code>cap deploy:setup</code> from the console to set up the remote file structure and <code>cap deploy</code> to execute the deployment.  And do not forget, if something suddenly goes wrong with subsequent deployments (it has gone through, but the site has fallen, for example) - <code>cap rollback</code> will help </li></ol><br><br>  It should be noted that the <em>log /</em> , <em>web / uploads</em> directories do not participate in deployment, since  are shared resources that are stored between deployments.  Therefore, if you have already accumulated a set of files for web / uploads, you need to manually upload them to the server at <em>/PATH/TO/www/#{application}.com/shared/web/uploads/</em> <br>  That's all.  If you liked this article - let me know, maybe next time I will talk about another interesting aspect of development along with a great symfony ... <br><br>  <strong>upd: I</strong> forgot 1 thing.  According to the standard, when symfony generates a project, it sets in the config / ProjectConfiguration.class.php the absolute path to symfony, which may differ on the working machine and production.  To solve the problem both on the production and on the working machine, add the path to the library directory (including symfony) to include_path (for example: include_path = ".: / Php / includes: / opt / local / lib / php"), and the path to ProjectConfiguration.class.php change to relative <em>require_once 'symfony / autoload / sfCoreAutoload.class.php';</em> <br></div><p>Source: <a href="https://habr.com/ru/post/67613/">https://habr.com/ru/post/67613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../67604/index.html">Experience using the HTC Magic phone based on the Android OS</a></li>
<li><a href="../67605/index.html">Armagetron</a></li>
<li><a href="../67607/index.html">Corporate ISP rates are evil</a></li>
<li><a href="../67610/index.html">Ukrainian antivirus "Zillya!"</a></li>
<li><a href="../67611/index.html">Lenses are good</a></li>
<li><a href="../67615/index.html">Obvious next</a></li>
<li><a href="../67616/index.html">New trailer for Mass Effect 2</a></li>
<li><a href="../67617/index.html">Installing PHP on ubuntu</a></li>
<li><a href="../67622/index.html">A simple way to queue up from AJAX requests</a></li>
<li><a href="../67627/index.html">Literature 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>