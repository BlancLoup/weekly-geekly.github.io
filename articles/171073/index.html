<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mass client migration between hosting providers: struggling with entropy on an industrial scale</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the life of any hosting provider, transferring clients between their own servers is a fairly common task. For such a transfer, there can be many re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mass client migration between hosting providers: struggling with entropy on an industrial scale</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8ec/cec/737/8eccec737dcc2d4dcca3d5bf1a779312.jpg" alt="image"><br><br>  In the life of any hosting provider, transferring clients between their own servers is a fairly common task.  For such a transfer, there can be many reasons: starting with a planned upgrade of equipment or software and a planned "redistribution" of clients due to uneven server load, ending with the urgent movement of users in case of accidents. <br><br>  Less often in the life of providers, there are tasks for transferring clients from another shared-hosting provider. <br>  The reason for such a transfer can be either the ‚Äúfatigue‚Äù of the hosting provider ‚Äúdonor‚Äù from such a high-tech business, or the outsourcing of hosting services to a larger hosting company if the provision of these services is not for the organization that has decided to change if we are talking about a web-studio, Internet service provider, service provider, etc.). <br>  The number of potential problems when transferring clients between different providers is much greater than when transferring within a single hosting provider.  This is due to the fact that the infrastructure of the ‚Äúold‚Äù and ‚Äúnew‚Äù providers may differ significantly: <br><a name="habracut"></a><ul><li>  Different billing panels are used; </li><li>  Different hosting control panels are used; </li><li>  Different versions of PHP / other interpreters with different settings; </li><li>  Different modes of running scripts (fastcgi vs mod_something); </li><li>  Different web server settings; </li><li>  A different scheme for the inclusion of web servers (with or without using frontend) </li><li>  Different settings and differences in security policy; </li><li>  Different paths in the system to the sites and external utilities; </li><li>  Different mail servers and mail sending schemes (sending sendmail to 25 port vs sendmail). </li></ul>  At the same time, it would not be desirable to completely copy someone else's infrastructure, which may turn out to be suboptimal or having any limitations.  Even if the initial infrastructure is of high quality and interesting, there is no point in producing a ‚Äúzoo‚Äù - one can only borrow interesting finds in order to implement them in the future.  Thus, it is usually necessary to transfer sites to a completely new environment and map the ‚Äúalien‚Äù infrastructure to ‚Äúyour own‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are also various potential "inconsistencies" from real life, taking into account the possibilities of small hosting providers: <br><ul><li>  Different options and different amounts of resources on the tariff plans (1: 1 tariffs are almost never combined); </li><li>  Different clients of one hoster may live in different hosting / billing panels, and some customers may be entered ‚Äúin Excel‚Äù in general, and their payment will be monitored manually (of course, some of this information may not be relevant); </li><li>  Sites that are physically on the servers, but not in the billing; </li><li>  The same clients can be duplicated on different physical servers.  For example, if the client was transferred from the server to the server, and forgot to delete it from the old server; </li><li>  Different sites of the same hosting client (having a single account in the hosting panel) can be served on different servers; </li><li>  Other exotic options that need to somehow resolve. </li></ul><br>  Naturally, we have to deal with all these problems and somehow resolve them.  At the same time, it is necessary to do it in such a way that none of the clients "should not be hurt": no one's websites would "fall", and the tariff conditions would not worsen.  In general, so that ‚Äúno one is forgotten and nothing is forgotten‚Äù and, at the same time, everything continues to work. <br><br>  In fact, in this case, you need to solve <b>three problems</b> : <br><ul><li>  Display foreign infrastructure on your own, so that everything continues to work; </li><li>  "Restore order", eliminating all possible inconsistencies and getting rid of technological chaos; </li><li>  Minimize downtime when migrating. </li></ul><br>  In this review article I will try to tell how these problems are solved in REG.RU. <br>  Usually the process consists of several technological, organizational and informational <b>stages</b> : <br><br>  <b>1. Notification of customers about the upcoming transfer:</b> <br>  a) News on the site hosting; <br>  b) News on REG.RU; <br>  c) Press release; <br>  d) Newsletter to customers about the upcoming transfer; <br>  e) Pause 1-2 weeks.  This is done so that those who do not want to be transferred can declare this or independently switch to another hosting provider. <br><br>  <b>The goal of the stage</b> is to exclude all sorts of surprises so that customers understand that they will be transferred to a new provider while improving the conditions of service.  In addition, users need to make it clear that the transfer will occur automatically, and every effort will be made to minimize downtime.  At the same time, it is necessary to inform you that you can refuse to transfer or go to an alternative hoster with a refund for the unused paid period. <br><br>  <b>2. Technical preparation for the transfer.</b> <b><br></b>  <b>2.1.</b>  <b>Compilation of customer base and services for transfer:</b> <br>  a) We read and convert to the common format the data from the billing panels (of which there can be several); <br>  b) Collect data from other sources (customers without billing); <br>  c) Among overdue hosting sites, which are not yet physically remote, we isolate customers who actually do not use hosting anymore and whom it does not make sense to transfer, most likely they will no longer extend hosting. <br>  It would be possible, say, to check the delegation of a domain for IP hosting, but not everything is so simple - there are situations when: <br><ul><li>  The client forgot to renew the domain, although he plans to use the services; </li><li>  The client uses hosting only for mail (then you only need to watch MX); </li><li>  The client uses hosting to store some personal files; </li><li>  The client uses the hosting for tests or some kind of training and at the same time does not use the domain (it edits the hosts to access the site). </li></ul>  So, ideally, you need to look at the logs if there are any real visits to the site. <br><br>  <b>The goal of the stage</b> is to compile an accurate list of customers and services for transfer, including domain registration services.  In addition, it is necessary to collect all data for billing, including customer contact information, information on account balances, services paid for and payment periods, as well as tariffs and tariff options for services related to billing. <br><br>  <b>2.2.</b>  <b>Entering data about customers and their services into the billing database:</b> <br>  a) Generation of a username (prefix with the hostname, suffix - login from the previous hoster or converted e-mail, if there is no login); <br>  b) Password generation; <br>  c) Transfer of contacts; <br>  d) Transfer of balances on personal accounts / data on the dates of service disconnection; <br>  e) Creating domains (it is possible to add API to third-party registrars if the domains are in other registrars and their mass transfer is impossible); <br>  e) Creation of services.  We take into account the display of tariffs at the previous hoster and with us.  If the client does not fit in the tariff limits - we raise the tariff "at our expense"). <br><br>  <b>The goal of the stage</b> is to add information about all customers and their services to the billing database. <br><br>  <b>2.3.</b>  <b>Preparing for physical migration / splitting clients across servers:</b> <br>  a) We compile a complete and ‚Äúfinal‚Äù list of accounts that need to be migrated; <br>  b) Putting order in the previously created list (you can say that we put things in order on the hosting, from where we transfer accounts): we look to see if there are not two or more servers of the same users or www-domains on two or more servers.  If such are available - in the semi-automatic and manual mode we understand and remove the excess; <br>  c) We divide the entire list of users into groups that satisfy the following conditions: <br><ul><li>  There should be no more than n users in one group; </li><li>  In one group, the total limits of the resources used should not be exceeded; </li><li> To facilitate the subsequent proxying of traffic from the old servers to the new ones (which will turn on after the transfer), it is also advisable not to split accounts from the same source server into different groups. </li></ul>  d) We verify the settings of the source servers and the allowed rights on the source with the settings and rights on the destination server. <br><br>  <b>The goal of the stage</b> is to distribute clients between the destination servers, taking into account all the limitations and nuances. <br><br>  <b>2.4.</b>  <b>Transfer accounts between hosting panels:</b> <br>  a) Preparation of lists of sites for transfer (we consider aliases, redirects); <br>  b) Transferring account settings (version and PHP startup mode, etc.); <br>  c) Transfer of mail settings (mail accounts, mail groups, redirects); <br>  d) Transferring the DNS settings (simultaneously changing the IP addresses of the servers of the old infrastructure to new ones, leaving no changes to the additional DNS entries made by the client); <br>  e) Renaming / ordering database names.  We prepare the replacement table (old database name =&gt; new), adding a prefix with the user ID.  We pay special attention to: <br><ul><li>  Databases with names less than n characters; </li><li>  Databases with names like sql, mysql, new, user, etc., which cause confusion in the namespace of databases. </li></ul><br>  For such bases, additional control and preparation of a manual patch for replacing names from old to new ones is needed, since the automaton replacing the alternate bases in scripts and configs is highly likely to make a mistake by confusing them with other strings. <br><br>  <b>The goal of the stage</b> is to create all the necessary accounts and their settings in the database of the ‚Äúhosting‚Äù hosting panel. <br><br>  <b>3. Physical transfer of sites:</b> <br>  For each group of clients intended for transfer to the next server: <br>  a) We start the automatic migration mechanism of one group; <br>  b) Run the automatic script for automatic reconfiguration of the site configs for the new environment: <br><ul><li>  We change the old names of the bases for the new ones (see p. 2.4 (e)); </li><li>  Change old paths to files / directories for new ones; </li><li>  We resolve conflicts when the machine doubts the replacement is correct: in an amicable way, you need to drive out the machine before transferring and prepare a manual patch for questionable places that is currently rolling. </li></ul><br>  d) We launch the automatic machine for testing the main pages of the sites after the transfer: the automatic machine looks that the HTTP statuses of the main pages of all the sites have not changed; <br>  c) Additionally we carry out a manual check - we give the list of www-domains of this group to the hosting support service / testing service; <br>  e) Edit the found bugs; <br>  f) Enable proxying for domains of the migrated group to us, block clients of this group at the source. <br><br>  <b>The purpose of the stage</b> is the physical transfer of files and databases of sites, as well as the contents of mailboxes to new servers, change of script settings due to the changed environment, the physical launch of sites on the new server and the traffic going there. <br><br>  <b>4. Actions after transfer:</b> <br>  a) We send customers a notification with their new account details to access the billing / control panels and features of the new hosting, which should be paid attention to. <br>  b) Final control of the transfer correctness, correction of errors; <br>  c) Automatically change DNS servers to ours (for those domains that are under our control); <br>  d) We distribute to clients with their own DNS with a request to change the DNS to ours (for domains outside our reach). <br><br>  <b>The purpose of the stage</b> is to change DNS to new IP and send all necessary notifications to customers. <br><br>  One of the latest examples of such a massive transfer of clients is cooperation with <b>Hostingjoomla.ru</b> , as a result of which more than 500 clients (750+ www-domains) were transferred from several old servers to new ones.  Along the way, a lot of work was done to combat chaos (elements of this work were listed above). <br><br>  As a result, everyone got the desired PROFIT: <br><ul><li>  Web Studio RedSoft (which owns the project Hostingjoomla.ru), which specializes in launching projects based on CMS Joomla !, transferred hosting services to a specialized operator and got the opportunity to fully focus on the core business, relying on a more stable platform for their clients' projects; </li><li>  Clients received a better and more stable hosting service at a favorable price, round-the-clock quality technical support and a much larger number of options and additional services (dedicated IP addresses, SSL certificates, domains in more than 200 zones, etc.) that can be order in the format of "one window" (one account in REG.RU); </li><li>  REG.RU has received new loyal customers aimed at long-term cooperation, because web sites rarely go off from shipyards of web studios; </li><li>  REG.RU engineers received additional experience points and the next addition to a set of automatic scripts to resolve difficult situations associated with the transfer. </li></ul><br>  But the story with Hostingjoomla.ru is not over - we optimized for the needs of CMS Joomla!  <a href="https://hosting.reg.ru/hosting/joomla">line of existing tariffs</a> , added the ability to order Joomla-tariffs in our API, <a href="https://www.reg.ru/company/news/2458">finalized REG.Panel</a> , also adding new tariffs there and even choosing the Joomla version for auto-installation.  As a result, web studio clients received a product that was fully optimized for their needs.  And this is PROFIT for the entire market. <br><br>  In general, the transfer of hosting infrastructure from small providers to larger ones has become a prevailing trend in the Russian market, as this is a chance to transfer the hosting infrastructure to reliable hands, having received in return the opportunity to focus on other tasks.  Any questions - write: we will help, we will help! </div><p>Source: <a href="https://habr.com/ru/post/171073/">https://habr.com/ru/post/171073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171059/index.html">President Barack Obama has awarded IBM scientists with national medals</a></li>
<li><a href="../171061/index.html">Forget about B2B and B2C. Mobile technology turns everything into B2P - a business for people</a></li>
<li><a href="../171063/index.html">Microsoft suspected the creators of the terrorist recognition complex of plagiarism</a></li>
<li><a href="../171069/index.html">Fire Safety in Version Control Systems</a></li>
<li><a href="../171071/index.html">Sergey Brin: smartphones are asocial</a></li>
<li><a href="../171077/index.html">Dennis Tito plans to send people to Mars in 2018</a></li>
<li><a href="../171079/index.html">About correct memory usage in Linux NUMA systems</a></li>
<li><a href="../171081/index.html">The method of image formation in the projection of Gauss-Kruger</a></li>
<li><a href="../171083/index.html">Compliance with standards and policies in vulnerability scanners and SIEM</a></li>
<li><a href="../171087/index.html">Getting started with Push Notifications in PhoneGap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>