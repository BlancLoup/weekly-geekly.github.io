<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeBSD + PostgreSQL: database server tuning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habsoobshchestvu! 

 Probably, my article will not be of interest to experienced system administrators and will seem like a copy-paste. But I addr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeBSD + PostgreSQL: database server tuning</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habsoobshchestvu! <br><br>  Probably, my article will not be of interest to experienced system administrators and will seem like a copy-paste.  But I address it to those who, like me, being only a developer, first encountered the need to also administer the server, while solving the tasks of a high-load database.  And so that Google does not curse you, I will try to gather in one place the basic techniques for overclocking the database server, which I successfully managed to implement. <br><a name="habracut"></a><br>  The input to my task is as follows: a dual-processor (Intel Xeon) machine, 8 hard drives of 500 GB and 12 GB of RAM.  And full, including physical, access to this good.  Task: organize a fast database server based on FreeBSD and PostgreSQL OS. <br><br><h4>  1. RAID </h4><br>  Proper partitioning of the existing hard drives into raids will be needed for the PostgreSQL feature like tablespacing (see below).  I divided my 8 hards into pairs, organizing in this way: I combined two pairs in RAID1 and two pairs in RAID0 (in general, we need at least 6 hards for our purposes - combine two pairs in RAID1, leave the other 2 as is).  If there are more hard drives, you can think of something more reliable, such as RAID5, RAID10, etc., but there is a chance that it will work somewhat slower.  I will not go into details on how to organize raids, because  I am not strong in hardware, I can only say that I did not touch any controllers, because  on the server after the BIOS utility is loaded that allows you to do it programmatically. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  2. Installing the OS, database server and using your own kernel </h4><br>  At first, we simply install fryahu on the first RAID1.  I installed the FreeBSD 8.2 Release AMD64 distribution with all the files.  The 64-bit version is needed for the system to ‚Äúsee‚Äù all the RAM. <br><br>  Now the most interesting thing: why do we need to compile the kernel and what parameters to change?  This is necessary to allow the PostgreSQL server to use as many resources as is required for high load.  So, what parameters of a DB interest us.  In the <a href="http://postgresql.leopard.in.ua/">book by</a> Alexey Vasiliev ‚ÄúWorking with Postgresql.  Configuring, scaling "The following parameters are recommended for heavily loaded databases (postgresql.conf file): <br><ul><li>  shared_buffers = 1/8 RAM or more (but not more than 1/4); </li><li>  swork_mem in 1/20 RAM; </li><li>  smaintenance_work_mem in 1/4 ram; </li><li>  smax_fsm_relations in the planned number of tables in the bases * 1.5; </li><li>  max_fsm_pages in max_fsm_relations * 2000; </li><li>  fsync = true; </li><li>  wal_sync_method = fdatasync; </li><li>  commit_delay = 10 to 100; </li><li>  commit_siblings = 5 to 10; </li><li>  effective_cache_size = 0.9 from the cached value, which shows free; </li><li>  random_page_cost = 2 for fast cpu, 4 for slow; </li><li>  cpu_tuple_cost = 0.001 for fast cpu, 0.01 for slow ones; </li><li>  cpu_index_tuple_cost = 0.0005 for fast cpu, 0.005 for slow ones; </li><li>  autovacuum = on; </li><li>  autovacuum_vacuum_threshold = 1800; </li><li>  autovacuum_analyze_threshold = 900; </li></ul><br>  These options really suit us, except for two: <br><br>  <b>1) Maximum number of connections</b> <br><br>  Depends on the specific situation.  The script in krone works for me (to connect to a DB and enters data), I considered that 256 should suffice: <br><ul><li>  max_connection = 256; </li></ul><br>  But the default FreeBSD configuration does not provide such a value for the number of connections.  If you set this value and try to start the postgre daemon, it will not work.  It is necessary to increase the corresponding parameters of the system.  To do this, and collect your core.  Take the default kernel configuration GENERIC, make a copy with the name KERNEL_MAX_PERF, edit KERNEL_MAX_PERF as follows: change the number of semaphores, adding the following to the default options: <br><blockquote><code>options SEMMNI=512 <br> options SEMMNS=1024 <br> options SEMUME=64 <br> options SEMMNU=512 <br></code> </blockquote><br>  (these are values ‚Äã‚Äãfor max_connection = 256). <br><br>  <b>2) The maximum amount of RAM</b> that PostgreSQL can take (this is important for large queries).  The shared_buffers parameter in postgresql.conf is responsible for it.  There are different recommendations for the value for this quantity.  I came to the conclusion that if this is a dedicated server for a database, then it is possible for one process to give almost the entire amount of RAM minus what the system needs for its needs.  I selected 8 GB from 12. In order for the system to allow us to set the value we need for shared_buffers, in the kernel it is necessary to change the SHMMAXPGS option, the value of which is calculated by the formula: <br><br>  SHMMAXPGS = shared_buffers / PAGE_SIZE <br><br>  in my case shared_buffers = 8GB, PAGE_SIZE = 4Kb for all i386, it means <br>  SHMMAXPGS = 8 * 1024 * 1024/4 = 2097152);  now we can write the SHMMAX parameter (it is calculated dynamically in the kernel).  So, we write to the kernel config: <br><blockquote> <code>options SHMMAXPGS = 2097152 <br> options SHMMAX = "(SHMMAXPGS*PAGE_SIZE + 1)"</code> </blockquote> <br><br>  It remains to compile the kernel with the KERNEL_MAX_PERF config.  The kernel compilation procedure itself is simple, here I refer you to the official mana. <br><br>  We load the OS with our kernel, install the latest version of PostgreSQL (I had version 9.0.4), first we will start PostgreSQL with the default config for verification.  If everything is ok, we change the parameters in postgresql.conf to those specified above, we restart PostgreSQL.  It started - we go further. <br><br>  <i>Note: if for some reason it was not possible to compile the kernel with the parameters set, then you can register them in sysctl.conf:</i> <i><br></i> <blockquote> <i><code>kern.ipc.shmall=2097152 <br> kern.ipc.shmmax=8589938688 <br> kern.ipc.semmap=256</code></i> </blockquote> <i><br></i>  <i>and start up with the default kernel GENERIC.</i> <br><br><h4>  3. Tablespacing </h4><br>  Tablespacing is the ability of PostgreSQL to determine locations in the file system where files representing database objects will be stored.  Simply put, if we spread tables, indexes and logs on different disks, then read / write data will be faster than if all of this were on the same disk. <br><br>  This is where we need our raids.  Let me remind you that we have four sections: two RAID1 and two RAID0.  On the first RAID1, we have installed an OS and a postgres.  On the second RAID1 we will store the tables of our database.  Suppose it is mounted as / disk1.  On the first RAID0 we will store indexes.  Let it be mounted on the file system as / disk2.  Logs leave the second RAID0, we assume that it is mounted as / disk3. <br><br>  The following steps should be taken: <br><ol><li>  create folders for tables, indexes and log: <br><blockquote> <code>#mkdir -p /disk1/postgresql/tables <br> #mkdir -p /disk2/postgresql/ind <br> #mkdir -p /disk3/postgresql/log</code> </blockquote> </li><li>  make a postgres ounder for these folders, and take away all the rights from the rest (let me remind you that postgres is the user who starts up when installing PostgreSQL, if the installation is done in the standard way according to the official mana): <br><blockquote> <code>#chown -R postgres /disk1/postgresql/tables /disk2/postgresql/ind /disk3/postgresql/log <br> #chmod -R go-rwx /disk1/postgresql/tables /disk2/postgresql/ind /disk3/postgresql/log</code> </blockquote> <br></li><li>  log into the psql client under postgres and create two tablespaces: <br><blockquote>  <font color="#993333">CREATE</font> TABLESPACE space_table LOCATION <font color="#ff0000">'/ disk1 / postgresql / tables'</font> ; <br>  <font color="#993333">CREATE</font> TABLESPACE space_index LOCATION <font color="#ff0000">'/ disk2 / postgresql / ind'</font> ; </blockquote><br></li><li>  if your database‚Äôs invader is not postgres, but, for example, myuser, then you must give the user myuser permissions to the created tablespace (you can also execute in the client): <br><blockquote>  <font color="#993333">GRANT</font> <font color="#993333">CREATE</font> <font color="#993333">ON</font> TABLESPACE space_table <font color="#993333">TO</font> myuser; <br>  <font color="#993333">GRANT</font> <font color="#993333">CREATE</font> <font color="#993333">ON</font> TABLESPACE space_index <font color="#993333">TO</font> myuser; </blockquote><br></li><li>  Now under myuser 'om you can change the tablespace for tables and indexes: <br><blockquote>  <font color="#993333">ALTER</font> <font color="#993333">TABLE</font> mytable <font color="#993333">SET</font> TABLESPACE space_table; <br>  <font color="#993333">ALTER</font> <font color="#993333">INDEX</font> mytable <font color="#993333">SET</font> TABLESPACE space_index; </blockquote><br></li><li>  stop the postgres daemon, move the folder with the log and make a symbolic link to it: <br><blockquote> <code>#/usr/local/bin/rc.d/postgres.sh stop <br> #mv /usr/local/pgsql/data/pg_xlog /disk3/postgresql/log <br> #cd /usr/local/pgsql/data <br> #ln -s /disk3/postgresql/log/pg_xlog</code> </blockquote> <br>  We start postgres: <br><blockquote> <code>#/usr/local/bin/rc.d/postgres.sh start</code> </blockquote> <br>  If everything is done correctly, the daemon should start. <br></li></ol><br><br><h4>  4. Partitioning </h4><br>  Partitioning is a logical partitioning of one large table into small physical chunks.  This allows you to significantly speed up the query execution time, if the table is really large. <br><br>  I have a rather typical situation: the script works in crown, collecting statistics for a certain dimension.  On the web interface, the user can view these statistics.  For a week about 10 million rows are inserted into the table.  If everything is written in one table, then you will be cursed.  It will all work terribly slow. <br><br>  Let's try to break this table into pieces, taking time as the partitioning criterion.  In this case, when the user wants to see the statistics, and you can see it only for a certain time period, the database server, when prompted, will have to wool not the entire large table, but several small ones that fall into the selected time period. <br><br>  Unfortunately, in PostgreSQL, partitioning is not implemented at the database level, so you have to do it with pens using the table inheritance property. <br><br>  So, we have a table measure_data_master, where we write our measurements.  For example, as a time period, one week suits.  Go: <br><ol><li>  for the master table measure_data_master do NOT make any integrity constraints check and do NOT create indexes </li><li>  in the postgresql.conf config edit option: <br><blockquote> <code>constraint_exclusion = on</code> </blockquote> <br></li><li>  create descendant tables of the form: <br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> measure_data_y2011m06d06 <font color="#66cc66">(</font> <font color="#993333">CHECK</font> <font color="#66cc66">(</font> measure_time <font color="#66cc66">=</font> DATE <font color="#ff0000">'2011-06-06'</font> <font color="#993333">AND</font> measure_time DATE <font color="#ff0000">'2011-06-13'</font> <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> INHERITS <font color="#66cc66">(</font> measure_data_master <font color="#66cc66">)</font> ; </blockquote><br></li><li>  create indexes for descendant tables: <br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">INDEX</font> measure_data_y2011m06d06_key <font color="#993333">ON</font> measure_data_y2011m06d06 <font color="#66cc66">(</font> measure_time <font color="#66cc66">)</font> ; </blockquote><br></li><li>  it is necessary that when you insert a new row, it is recorded in the desired child table.  Create for this trigger function: <br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">OR</font> <font color="#993333">REPLACE</font> <font color="#993333">FUNCTION</font> measure_insert_trigger <font color="#66cc66">(</font> <font color="#66cc66">)</font> <br>  RETURNS <font color="#993333">TRIGGER</font> <font color="#993333">AS</font> $$ <br>  BEGIN <br>  <font color="#993333">IF</font> <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> Measure_time <font color="#66cc66">&gt; =</font> DATE <font color="#ff0000">'2011-06-06'</font> <font color="#993333">AND</font> <br>  NEW <font color="#66cc66">.</font>  measure_time <font color="#66cc66">&lt;</font> DATE <font color="#ff0000">'2011-06-13'</font> <font color="#66cc66">)</font> THEN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> measure_data_y2011m06d06 <font color="#993333">VALUES</font> <font color="#66cc66">(</font> NEW <font color="#66cc66">. *</font> <font color="#66cc66">)</font> ; <br>  ELSIF <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> Measure_time <font color="#66cc66">&gt; =</font> DATE <font color="#ff0000">'2011-06-13'</font> <font color="#993333">AND</font> <br>  NEW <font color="#66cc66">.</font>  measure_time <font color="#66cc66">&lt;</font> DATE <font color="#ff0000">'2011-06-20'</font> <font color="#66cc66">)</font> THEN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> measure_data_y2011m06d13 <font color="#993333">VALUES</font> <font color="#66cc66">(</font> NEW <font color="#66cc66">. *</font> <font color="#66cc66">)</font> ; <br>  <font color="#66cc66">.....................................</font> <br>  ELSIF <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> Measure_time <font color="#66cc66">&gt; =</font> DATE <font color="#ff0000">'2011-12-19'</font> <font color="#993333">AND</font> <br>  NEW <font color="#66cc66">.</font>  measure_time <font color="#66cc66">&lt;</font> DATE <font color="#ff0000">'2011-12-26'</font> <font color="#66cc66">)</font> THEN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> measure_data_y2011m12d19 <font color="#993333">VALUES</font> NEW <font color="#66cc66">. *</font> <font color="#66cc66">)</font> ; <br>  ELSE <br>  RAISE EXCEPTION <font color="#ff0000">'Date out of range.Fix the measure_insert_trigger () function!'</font>  ; <br>  END <font color="#993333">IF</font> ; <br>  <font color="#993333">RETURN</font> <font color="#993333">NULL</font> ; <br>  END; <br>  $$ <br>  <font color="#993333">LANGUAGE</font> plpgsql; </blockquote><br></li><li>  well, the trigger itself, which will call the function: <br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TRIGGER</font> insert_measure_trigger <br>  BEFORE <font color="#993333">INSERT</font> <font color="#993333">ON</font> measure_data_master <br>  <font color="#993333">FOR</font> EACH ROW EXECUTE PROCEDURE measure_insert_trigger <font color="#66cc66">(</font> <font color="#66cc66">)</font> ; </blockquote><br></li></ol><br>  Of course, writing such large queries is inconvenient.  I wrote a php script that creates the tables and all that is needed for them for the whole year ahead. <br><br>  Here, perhaps, all that I wanted to tell.  If you share your experiences from this area, I will be very grateful. </div><p>Source: <a href="https://habr.com/ru/post/120932/">https://habr.com/ru/post/120932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120925/index.html">The development of Funnybeanbag. May 2011</a></li>
<li><a href="../120927/index.html">Calendar of the ancient Maya - how to calculate the date?</a></li>
<li><a href="../120928/index.html">IPO for dummies. Part II: stock price, stock exchange, the best way to trade potatoes, and who can be met on the stock exchange</a></li>
<li><a href="../120930/index.html">The figure of the maximum area that can swim through the channel</a></li>
<li><a href="../120931/index.html">Custom View, scrolling and gestures in Android on the example of a simple image viewer</a></li>
<li><a href="../120935/index.html">Online project environment: problem statement</a></li>
<li><a href="../120936/index.html">Acer Aspire Ethos 8951G and removable touchpad</a></li>
<li><a href="../120939/index.html">Public and private computing clouds - real-world experience</a></li>
<li><a href="../120941/index.html">The system of protection against theft in the office. Anti-consulting</a></li>
<li><a href="../120942/index.html">Moj plugin to participate in TopCoder SRM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>