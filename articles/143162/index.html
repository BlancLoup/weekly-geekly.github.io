<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Realtime monitoring system of user activity on the site. Now on Node.js + Socket.IO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 In this article I will discuss how to implement a system for monitoring user activity using Node.js and Socket.IO. It looks like this: 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Realtime monitoring system of user activity on the site. Now on Node.js + Socket.IO</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  In this article I will discuss how to implement a system for monitoring user activity using Node.js and Socket.IO.  It looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/499/31b/2d4/49931b2d4d31370c6af0fcd76c327307.jpg" alt="image"><br><a name="habracut"></a><br>  It was written for the ERP-system, in which the interaction of workers is important, in particular, to avoid situations when two operators will edit one product. <br><br><h5>  Task </h5><br>  So, for the server on Node.js (express, connect) it was necessary to implement this monitoring system, which would inform about the activity of users in real time (i.e., the user who left the system would immediately disappear from the ‚Äú <i>Users online</i> ‚Äù list, switched to another page - disappeared from " <i>This page is being viewed</i> ", and the one who entered, accordingly, appeared in the lists). <br>  At once I will make a reservation that due to the closedness of the system from the rest of the world, authentication is a mandatory start. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, before you start - those who are not very familiar with the basics of Socket.IO I advise you to look at the <a href="http://habrahabr.ru/post/127525/">typical implementation of the chat</a> . <br><br><h5>  Customer </h5><br>  The client part in this case is implemented quite simply, so I will not focus on external beauty.  I will only mention that the code below is included in the base template, i.e.  present on every download page. <br>  Here is a list of what we need: elements with id = "sockstat" (to display the connection status), with id = "alsohere" (for the list of those who view the page), id = "online" (for the list of all those who are online ), of course, such a thing <br><pre><code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"/js/lib/jquery.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"/socket.io/lib/socket.io.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre>  , <br>  and a small auxiliary function that makes elements of a bulleted list from an array: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lister</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-string"><span class="hljs-string">''</span></span>; $.each(arr, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ s += <span class="hljs-string"><span class="hljs-string">'&lt;li&gt;&lt;b&gt;'</span></span> + value.name + <span class="hljs-string"><span class="hljs-string">'&lt;/b&gt; (login: '</span></span> + value.login + <span class="hljs-string"><span class="hljs-string">', id: '</span></span> + value.user_id + <span class="hljs-string"><span class="hljs-string">')&lt;/li&gt;'</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s; }</code> </pre> <br><br>  Now everything is ready.  The mechanism is as follows: <br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> socket = io.connect(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      socket.on("connect", function () { // ,  : $("#sockstat").text("connected ok"); //        socket.emit("iamhere", { location: document.URL } ); //      socket.on("alsohere", function (alsohere) { //        ,  : $("#alsohere").html('  : &lt;ul&gt;' + lister(alsohere) + '&lt;/ul&gt;'); }); socket.on("online", function (online) { //      - $("#online").html(' : &lt;ul&gt;' + lister(online) + '&lt;/ul&gt;'); }); socket.on("disconnect", function () { //    -    (  ,   ) setTimeout(function () { $("#sockstat").text("connection lost!"); }, 500); }); }); });</span></span></code> </pre><br>  Leaving the page (following the link, for example), the socket connection with the server is first broken, and only then a new page is rendered and given to the client, resuming the connection.  Therefore, in order to leave the page, the message about the gap in vain for a split second was not displayed, and this delay was made in half a second. <br>  A little trick, but the user will always be able to confidently say: ‚ÄúThere were no breaks!‚Äù Until the server really falls. <br><br>  It seems simple?  And so it is. <br><br><h5>  Server: surface </h5><br>  In the code of the project file being launched, in index.js, in addition to any pieces of type <pre> <code class="javascript hljs">app.configure();</code> </pre>  We connect our handwritten sockets.js, which is responsible for working with the sockets necessary in our business: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./sockets'</span></span>);</code> </pre> <br><br>  In addition to actually processing the events, it contains the authorization function - which gives permission to create a connection for those who are suitable according to certain criteria.  In our case, those who previously logged in. <br>  In general, it looks <a href="https://gist.github.com/1865578">like this</a> (note <i>sio.set ('authorization' ...)</i> ). <br><br>  And now the algorithm itself.  For starters - in Russian. <br>  There will be 2 labels here: <br><ul><li>  <b>online</b> - a list of all users online </li><li>  <b>alsohere</b> - a list of users on the same page as the client </li></ul><br>  The steps in the algorithm are also 2 ‚Äî handling the new connection and processing the message that the client has disconnected. <br>  As soon as it connects to us (the server), i.e.  passes authorization, enters the page and reports its location - <pre> <code class="javascript hljs">socket.emit(<span class="hljs-string"><span class="hljs-string">"iamhere"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">location</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.URL } );</code> </pre>  customer, we must: <br><ol><li>  remember who went and where (add it online) </li><li>  send updated to all active online </li><li>  send out to everyone viewing the same page - alsohere updated </li></ol><br><br>  When the client disconnects - <ol><li>  remember who came out and where (remove it from online) </li><li>  send updated to all active online </li><li>  send to viewers the page from which the client has just left, updated alsohere </li></ol><br>  Is it logical  We continue. <br><br><h5>  Server: a little deeper </h5><br><br>  To implement the above, I decided not to specifically load the socket.js file and rendered the ‚Äúbring-bring‚Äù functions into a separate file - auth.js. <br>  It is designed like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-string"><span class="hljs-string">"use strict"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Private -   / var __users = [], ..., return { ... // Public -  / }; }(); module.exports = auth;</span></span></code> </pre><br><br>  The main socket.js block is: <br><pre> <code class="javascript hljs">sio.sockets.on(<span class="hljs-string"><span class="hljs-string">'connection'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">socket</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hs = socket.handshake; auth.addActiveUser({ <span class="hljs-attr"><span class="hljs-attr">login</span></span>: hs.session.user, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: hs.session.username, <span class="hljs-attr"><span class="hljs-attr">id</span></span>: hs.session.user_id }); <span class="hljs-comment"><span class="hljs-comment">//  ,     -      socket.on('iamhere', function (msg) { //        -   auth.addPageActiveUser({ login: hs.session.user, path: msg.location, path_id: socket.id }); auth.getListActiveUser(function (online) { //     online ( 2) socket.emit('online', online); socket.broadcast.emit('online', online); }); auth.getListByPageActiveUser({ path: msg.location }, function (alsohere) { //     -    ,  //    ,   ,   alsohere var i, len; auth.getListByPageConnection({ path: msg.location, users: alsohere }, function (connections) { len = connections.length; for (i = 0; i &lt; len; i++) { sio.sockets.sockets[connections[i].id].emit('alsohere', alsohere); } }); }); }); socket.on('disconnect', function () { //    : var s = auth.getPageByIdConnection(socket.id); // ,    , setTimeout(function () { auth.removeActiveUser({ login: hs.session.user }); //     , auth.getListActiveUser(function (online) { //    online, socket.broadcast.emit('online', online); }); auth.removePageActiveUser({ login: hs.session.user, path_id: socket.id }); //        auth.getListByPageActiveUser({ path: s }, function (alsohere) { //    ,      //    alsohere var i, len; auth.getListByPageConnection({ path: s, users: alsohere }, function (connections) { len = connections.length; for (i = 0; i &lt; len; i++) { sio.sockets.sockets[connections[i].id].emit('alsohere', alsohere); } }); }); }, 1000); //      -    //   "" ,      }); });</span></span></code> </pre><br>  Voila <br><br><h5>  Magic disclosure </h5><br>  In the auth module, all this data about users ‚Äî about their connections and pages, sessions ‚Äî is stored as an object in the private variable __activeUsers. <br>  For each user, a field is created - __activeUsers [login], containing the following fields: <ul><li>  <b>name</b> - username - not to be confused with the login ("vasya" / "Vasily Ivanovich") </li><li>  <b>user_id</b> - internal user id - like the previous field, is used for subsequent transfer to the client, for example, to generate links "/ users / user_id" </li><li>  <b>locations</b> is an array of objects consisting of two fields: <b>path</b> is the path to the open page and <b>id</b> is the id of the connection to the socket </li></ul><br><br>  Accordingly, the auth module exposes only public methods that work with the above variable.  They are f-AI, consisting of <i>for</i> , <i>for..in</i> , <i>push</i> 'her and <i>splice</i> ' s <i>enumeration</i> : <br><ul><li>  <b>addActiveUser</b> - adds new user data to __activeUsers </li><li>  <b>addPageActiveUser</b> - adds a new open page to the user ( <i>__activeUsers [sLogin] .locations.push ({path: sPath, id: sPath_id});</i> ) </li><li>  <b>getListActiveUser</b> - returns a list of active users ( <i>for (i in __activeUsers) {list.push (...</i> </li><li>  <b>getListByPageActiveUser</b> - returns a list of users browsing the same page along the passed path </li><li>  <b>getListByPageConnection</b> - returns a list of user connections that refer to the same page to the passed page address </li><li>  <b>getPageByIdConnection</b> - by the connection id returns the address of the page (leaving the page the client sends us only the id, not the path) </li><li>  <b>removeActiveUser</b> - decrements the number of open pages to the user </li><li>  <b>removePageActiveUser</b> - removes a closed page from the list of open </li></ul><br><br>  By connecting to the server and successfully authenticating, the user gets a <i>socket.handshake</i> with a unique id for that user. <br>  Opening a new page, a unique <i>socket.id</i> for this page is <i>brought</i> to this connection.  That is, 1 user with 10 open pages is 1 handshake.id and 10 different socket.id. <br>  And then the matter of technology - by manipulating this data, we can always tell who and what we are viewing / editing using the above described data structure. <br>  And the whole "complexity" of the implementation is to iterate over the object fields and arrays, taking the right one.  And we can do it :) <br><br>  So now you can look at the above piece of code again and everything will become clear. <br>  I hope the principle of work you understand where any id will not confuse, where you need to insert timeouts to smooth the information transferred to the client;  Well, with the implementation for your specific task problems should arise. <br>  Good luck. <br><br>  PS Opera (tested on v.11.62) when closing pages, unlike FF and chrome, does not bother sending a client disconnect message to the server.  Therefore, users who have disconnected / left the page will be listed in the active list for a few more seconds, until the server automatically turns them off after a timeout. </div><p>Source: <a href="https://habr.com/ru/post/143162/">https://habr.com/ru/post/143162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143157/index.html">Desktop Virtualization with Microsoft RemoteFX</a></li>
<li><a href="../143158/index.html">Introduction to CSS3 Multicolumn. We work with speakers</a></li>
<li><a href="../143159/index.html">JavaFX on Raspberry Pi</a></li>
<li><a href="../143160/index.html">Meet May and 2GIS 3.6</a></li>
<li><a href="../143161/index.html">RIM puts everything on BlackBerry 10</a></li>
<li><a href="../143163/index.html">USPS (and not only) stops the delivery of products with lithium batteries</a></li>
<li><a href="../143164/index.html">Droider Show # 38. America without Apple</a></li>
<li><a href="../143165/index.html">UPS Shipping Labels or Single Return History</a></li>
<li><a href="../143166/index.html">What do we know about executors of IT projects?</a></li>
<li><a href="../143167/index.html">Evernote Dev Meetup Moscow Results</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>