<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we rewrote the Yandex.Pogoda architecture and made a global forecast on maps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 


 As they say, according to tradition, once a year we are rolling out something new at Yandex.Pododa. At first, it was Meteum - a traditio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we rewrote the Yandex.Pogoda architecture and made a global forecast on maps</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr! </p><br><p>  As they say, according to tradition, once a year we are rolling out something new at Yandex.Pododa.  At first, it was <a href="https://habrahabr.ru/company/yandex/blog/271725/">Meteum</a> - a traditional weather forecast using machine learning, then <a href="https://habrahabr.ru/company/yandex/blog/317626/">science</a> - a short-term forecast of precipitation based on meteorological radars and neural networks.  In this post, I will tell you about how we made a global weather forecast and built beautiful weather maps based on it. </p><br><p> <a href="https://habrahabr.ru/company/yandex/blog/343518/"><img src="https://habrastorage.org/webt/n5/z4/f-/n5z4f-elvhhgdpvctybqwmwwily.jpeg"></a> </p><br><p>  First a few words about the product.  Weather maps - a way to find out the weather, which is very popular in the west and is not yet very popular in Russia.  The reason for this is, in fact, the weather itself.  Due to the climatic features, the most populated regions of our country are not subject to sudden weather disasters (and this is good).  Therefore, the residents of these regions are more interested in the weather  So, it is important for people in central Russia to know, for example, what kind of weather will be in Moscow at the weekend or that it will rain in St. Petersburg on Thursday.  Such information is easiest to find out from the table, in which there will be a date, time and a set of weather parameters. </p><a name="habracut"></a><br><p>  On the other hand, it is more important for residents of the US Eastern Coast to know the trajectory of the next hurricane with a beautiful female name, and for farmers from Dakota - to follow the spread of hail along the fields where corn is growing.  Such information is much easier to learn from the map than from a variety of tables.  So it turned out that weather services in Russia are rather tables, and in the West they are more like maps.  However, in Russia there are patterns of weather consumption, when the user needs to know exactly where the weather will be, which he needs: these are people who choose a picnic place at the weekend, athletes, especially with the prefix "wind" and "kite" and, finally, summer residents .  It is for these categories of users that we have made our product.  And now I will talk about what is under his hood. </p><br><h1 id="raschet-prognoza-personalnyy-i-globalnyy">  Forecast calculation: personal and global </h1><br><p>  We immediately decided that in order to build maps, our forecast should become global.  Well, if only because the maps covering not the entire globe, give the Middle Ages.  Thus, we needed to expand Meteum to global coverage.  However, the previous system architecture was not very scalable. </p><br><p>  Summary of the previous series.  As the attentive reader remembers, in the first implementation of Meteum we calculated the weather forecast as necessary.  As soon as the user got to our site, we collected a list of factors for his coordinates and transferred to the trained MatrixNet model.  Microservice was responsible for collecting factors, which we called vector-api.  Microservice was good for all but one: when adding new factors and / or expanding the geography of coverage, we were approaching the memory limit of the physical machines on which microservice worked.  In addition, in itself, the formation of the response of the final weather API contained a time-consuming and processor-intensive operation using the Matriksnet model.  Both factors strongly impeded the construction of a global forecast.  Plus, in our backlog, there was a whole line of factors that increased the accuracy of the prediction in the experiments, but could not go into production due to the limitations described above. </p><br><p>  We also faced the shortcomings of the chosen architecture for the precipitation map, hotly beloved by many users.  For the storage and processing of data necessary for the construction of precipitation information, PostgreSQL DBMS with the PostGIS extension was used.  During summer thunderstorms, the number of requests to heavy handles per second lightning-fast turned from hundreds to tens of thousands, which entailed a high consumption of processors and network channels of database servers.  These circumstances served as an additional incentive to think about the future of the service and apply a different approach in processing and storing weather data. </p><br><p>  An alternative to calculating the weather in runtime was a preliminary calculation of forecasts for a large set of coordinates as the factors were updated.  We settled on a global grid covering land with a resolution of 2x2 km, and water with a resolution of 10x10 km.  The grid is divided into squares of 3 to 3 degrees - these squares allow us to simultaneously prepare factors for the model and process the results.  Here is how it looks on the map. </p><br><p><img src="https://habrastorage.org/webt/uy/o1/kn/uyo1knps159ms7sp90qjl3trcm0.png"><br>  <em>Splitting global regular grid areas</em> </p><br><p>  The process of preparing weather factors begins with the Meteo cluster.  According to the name, ‚Äúclassical meteorology‚Äù takes place on this cluster.  Here we download observational data and forecasts of GFS (USA), ECMWF (England), JMA (Japan), CMC (Canada), EUMETSAT (France), Earth Networks (USA) and many other suppliers.  Here is the calculation of the weather model WRF for the most interesting regions for us.  Meteorological data obtained from partners or as a result of calculations is usually packed in GRIB or NetCDF formats with different levels of compression.  Depending on the supplier or method of calculation, this data may cover the Moscow region or the whole world and weigh from 200MB to 7GB. </p><br><p>  From a meteocluster, the weather forecast files first go to MDS (Media Storage, storage for large pieces of binary information), and then to <a href="https://habrahabr.ru/company/yandex/blog/311104/">YT</a> - our Yandex Map-Reduce system.  Work in YT is divided into two stages, conditionally called "supply" and "application."  Supply is the preparation of factors for the subsequent application of a trained model.  Factors should be correctly re-interpolated to the final grid, lead to a single unit of measurement and cut into 3 by 3 degrees squares for parallel processing and application.  The complexity of the procedure here lies in the large amounts of data and the need to do an exercise every time a new forecast data has arrived for a particular area. </p><br><p>  After the first step has worked, the application of pre-trained machine learning models begins.  In the first implementation of Meteum, we could predict only two main weather parameters using machine learning: temperature and precipitation.  Now that we have switched to a new calculation scheme, we can use the same approach to calculate the remaining weather parameters.  The use of machine learning gives a tangible increase in accuracy for new parameters: pressure, wind speed and humidity.  The forecast error of these parameters for 24 hours ahead drops by up to 40%.  In addition to the fact that for many users, the most accurate wind and pressure indicators are important, this improvement allows us to more accurately calculate another popular parameter - temperature on sensations.  It consists of normal temperature, wind speed and humidity.  Another notable innovation was the new method of calculating weather phenomena.  Now it is based on a multi-classification formula - it determines not only the presence or absence of precipitation, but also their type (rain, snow, hail), and the presence and intensity of cloudiness. </p><br><p>  All these models need to be applied for a limited time for each point of the regular grid.  After the models have been applied, there is another layer of data processing - business logic.  In this section, we bring the variables predicted by machine learning to the units we need, and also make the forecast consistent.  Since right now the ML models know little enough about the physics of processes, mainly relying on factors derived from meteorological models, we can get inconsistent weather conditions, such as "rain at a temperature of -10".  We have ideas on how to do more correctly in this place, but right now this is being solved by formal constraints. </p><br><p>  The difficulty in applying the trained models is that for each prediction, it is necessary to perform about 14 billion operations.  There are hundreds of factors necessary for each calculation, and the list of these factors is very mobile: we constantly experiment with them, try new ones, add whole groups, throw out weak ones.  Not all factors are taken directly from suppliers.  We are experimenting with factor-functions of several parameters.  The rules for forming such a number of features are very difficult to maintain as a Python code: it is cumbersome, it is difficult to do lazy calculations, it is difficult to analyze and diagnose which features (or source data for features) are no longer needed.  Therefore, we invented its own analogue LISP.  Strictly speaking, this is not a LISP, but a ready-made AST, which is very similar to the LISP dialect, which takes into account the specificity of our data.  We made the processor of this LISP the way we need it: lazy and caching.  Therefore, we, firstly, do not calculate factors that are no longer needed, and secondly, do not calculate twice what we need twice.  These mechanisms automatically apply to all calculations.  And thanks to the fact that this is a formal AST, we can: easily analyze what is needed and what is not needed;  serialize and store separate parts of logic, write business parts into logs, form large parts of logic automatically (bypassing the presentation in the form of code), version them for experiments, and so on.  The overhead turned out to be completely insignificant, since all operations are performed immediately above the matrices. </p><br><p><img src="https://habrastorage.org/webt/0d/5n/8f/0d5n8fejf6eqxswz8zagjlvewkw.png"><br>  <em>The general scheme of data delivery to the API</em> </p><br><p>  After calculating the forecasts, we write them into a special format - ForecastContainer and load these containers into the microservice to return data from the memory.  The fact is that for the whole world with our grid of 0.02 degrees we get about 1 166 400 000 floating point values, and this is 34 GB of data for only one parameter.  We have more than 50 such parameters - therefore, it was not possible to keep this data completely in the memory of one physical machine.  We began to look for a format that supports fast reading of compressed data.  The first candidate was HDF5 - which has the functionality of chunking data and buffer support for unpacked chunks.  The second candidate was our self-proprietary format ‚Äî the matrices of floats compressed by LZ4 and recorded in Flatbuffer.  The test results showed that opening a file with data for work takes two times less time for Flatbuffers than for HDF5, as well as reading an arbitrary point from the cache.  As a result, now the data for 50 variables occupy 52.1GB. </p><br><p>  Since the requirements for memory consumption and response time were very high since the formulation of the problem, we decided to rewrite the old microservice written in Python in C ++.  And it gave its results: The response time of the service in 99 quantile fell from 100ms to 10ms. </p><br><p>  The transfer of the service to the new backend architecture allowed us to give weather forecasts to our internal and external partners directly, bypassing the caches and model calculations in runtime, made it possible, with an urgent need, to easily scale the load using Yandex cloud technologies. </p><br><p>  In total, the new architecture allowed us to reduce the response timings, keep a lot of work and get rid of the data that was given to different partners.  Yandex.Pogoda data is represented in a large number of Yandex services and not only: the Yandex main page, the weather plugin in Yandex. Browser, the weather on the Rambler, and so on.  As a result, they all had the opportunity to give exactly the values ‚Äã‚Äãthat the users of the <a href="http://yandex.ru/pogoda">main Yandex.Pogoda page</a> see at that moment. </p><br><h1 id="blizhe-k-lyudyam-tayl-server-i-front">  Closer to the people: Tile server and front </h1><br><p> In order to draw forecasts on our new maps, a lot of additional processing is needed.  First, we run MapReduce operations on the same data that is given by microservice and API to generate data for the whole world on a regular latitudinal-longitudinal grid with a resolution of 0.02 degrees.  At the output for each parameter: temperature, pressure, wind speed and direction, as well as for each horizon: forecast time in the future or fact time in the past, we get the matrix of size 9001 * 18000. </p><br><p>  After that, we build the Mercator projection using this data and cut them into tiles in accordance with the requirements of the Yandex.Maps API.  Here we meet with one of the biggest difficulties in the chain of preparing weather maps: the number of tiles that need to be updated promptly when generating each new forecast.  So, each next level of map zooming requires 4 times more tiles than the previous one.  It is easy to estimate that for all levels of approximation from 0 up to 8 you need to prepare </p><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mn>4</mn><mn>0</mn></msup><mo>+</mo><msup><mn>4</mn><mn>1</mn></msup><mo>+</mo><mtext>&amp;#xA0;</mtext><mi>d</mi><mi>o</mi><mi>t</mi><mi>s</mi><mo>+</mo><msup><mn>4</mn><mn>7</mn></msup><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>$</mo></mrow><mn>2184</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.936ex" height="2.66ex" viewBox="0 -987.6 12458.6 1145.2" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-34" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-30" x="707" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-2B" x="1176" y="0"></use><g transform="translate(2177,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-34" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-31" x="707" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-2B" x="3353" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMATHI-64" x="4604" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMATHI-6F" x="5128" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMATHI-74" x="5613" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMATHI-73" x="5975" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-2B" x="6666" y="0"></use><g transform="translate(7667,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-34" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-37" x="707" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-3D" x="8899" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-24" x="9956" y="0"></use><g transform="translate(10456,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-31" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-38" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/343518/&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh990x8z8vNsVMJR5OIC88fd51ABg#MJMAIN-34" x="1501" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mn>4</mn><mn>0</mn></msup><mo>+</mo><msup><mn>4</mn><mn>1</mn></msup><mo>+</mo><mtext>&nbsp;</mtext><mi>d</mi><mi>o</mi><mi>t</mi><mi>s</mi><mo>+</mo><msup><mn>4</mn><mn>7</mn></msup><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo>$</mo></mrow><mn>2184</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> 4 ^ 0 + 4 ^ 1 + \ dots + 4 ^ 7 = $ 2184</script></p><br>  pictures.  In total, for each of the four parameters, we show 25 horizons, of which there are 12 forecasts for the future. Therefore, every hour it is required to update 1048560 pictures. <br><p>  As the pictures are ready, we upload them to the internal storage of Yandex files with high parallelism.  As soon as the entire map layer for all the zooms is loaded, we replace the index value, according to which the front understands where to go for the new tiles.  Thus, a sufficiently high rate of appearance of new forecasts on the map and consistency of data within the forecast time is achieved. </p><br><p>  Even despite the serious preparation on the back end, drawing and animating weather maps is also a difficult task.  It‚Äôs impossible to tell everything in one article, so here we have focused on the most noticeable feature - the rendering of animated particles, showing the direction of wiping. </p><br><p><img src="https://habrastorage.org/webt/ff/nd/pf/ffndpfkyaxt2qpt-yroud7hw8y8.png"><br>  <em>This is how the wind animation particles look on weather maps.</em> </p><br><p>  To optimize the resource consumption of the client device, wind animation was performed using WebGL.  WebGL allows you to use significant graphics adapter resources, offloading the processor's flow of code execution, as well as optimizing battery consumption.  The task of the processor in this case is to set the execution arguments for shader programs.  To move the particles, the particle position storage approach is used in 2x texture color channels for each axis (x / y).  There are two such textures of position: one stores the current position of the particles, the second is designed to preserve the new state. </p><br><p>  The process of particle rendering is described by several WebGL programs.  For greater compatibility, the first version of this standard is used.  In a browser, using WebGL is done through the corresponding context of the canvas element.  Since the graphics accelerator is capable of performing several times more parallel operations through a processor, the movement of particles should be performed through the WebGL program.  The output of such a program is a set of points in a given space.  This default space is the visible area of ‚Äã‚Äãyour canvas, that is, the user's screen.  However, it is possible to specify the purpose of rendering the texture using framebuffers. </p><br><p>  When the wind layer starts, the processor generates the initial position of the particles, creating a typed array of elements in the range of 0 ... 255, in an amount (particles * components) (RGBA).  From this array, two WebGL location textures are created.  Data on wind speed is also recorded in the texture so that the video card has access to them.  The red and green channels of this texture contain the value of parallel and meridional speeds, respectively, where the value 127 corresponds to the absence of wind, values ‚Äã‚Äãless than 127 set the wind speed in the negative direction along the axis, the values ‚Äã‚Äãmore - in positive.  Using the prepared textures, the current position of the particles is drawn.  After rendering, one of the position textures is updated using the second texture as the source of the current state data.  The following visible frames will be formed by drawing the previous image of the position of the particles with increased transparency, on top of which the current position of the particles will be plotted.  Thus particles with damped tails are obtained. </p><br><p><img src="https://habrastorage.org/webt/bk/ac/vn/bkacvnjkahcqh5v1cvxlur7zwgq.jpeg"><br>  <em>This is how the particles of the wind animation look like in the process of their creation.</em> </p><br><p>  As it turned out, the current algorithm for coding the position of particles in texture pixels for high-quality visualization requires support at the hardware level of high precision calculations and float values ‚Äã‚Äãin the textures themselves, which is often not the case on mobile devices, so the algorithm will be revised and improved. </p><br><h1 id="zaklyuchenie-i-plany">  Conclusion and plans </h1><br><p>  Here's about everything that I wanted to tell you about the architecture of Yandex. Weather.  During this year, we completely redesigned the service from the inside (described above) and outside (almost all the platforms on which Ya.Pogoda is present were significantly redrawn).  The final of these changes were interactive weather maps that you can try on <a href="https://yandex.ru/pogoda/moscow/maps/temperature">our service</a> . </p><br><p>  However, we never rest on our laurels.  Next year you will find a lot of interesting grocery and technological updates: from the service that allows you to explore the climate in different parts of the Earth to the answer to the question "what does a person breathe".  And this, of course, not all.  Stay with us. </p><br><p>  Always yours, <br>  Team Yandex.Pogody </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343518/">https://habr.com/ru/post/343518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343508/index.html">Yes, PVS-Studio can detect memory leaks</a></li>
<li><a href="../343510/index.html">Olympiad "I am a professional" track "Information and cyber security"</a></li>
<li><a href="../343512/index.html">Is it possible to push number recognition in any tamagotchi?</a></li>
<li><a href="../343514/index.html">Face Recognition. Create and try on masks</a></li>
<li><a href="../343516/index.html">Developers on the dirtiest software tricks in games</a></li>
<li><a href="../343522/index.html">Setting up a WEB system - testing based on headless chromium-browser, chromedriver, nightwatch and node.js on Ubuntu</a></li>
<li><a href="../343524/index.html">Network JTAG programmer for Altera Quartus Prime from Raspberry Pi3</a></li>
<li><a href="../343526/index.html">Two geometric tasks that came across at the interview, and where they live</a></li>
<li><a href="../343530/index.html">Development for Sailfish OS: Using Sensors (Part 2)</a></li>
<li><a href="../343532/index.html">Mikrotik: Download speed limit for certain IP addresses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>