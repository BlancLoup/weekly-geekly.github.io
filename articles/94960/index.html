<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data acquisition, part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous sections, I outlined the process of collecting data from web sources. In this post I will show how to make a generic host for processi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data acquisition, part 4</h1><div class="post__text post__text-html js-mediator-article">  In the previous sections, I outlined the process of collecting data from web sources.  In this post I will show how to make a generic host for processing various sites using WatiN.  Also, I will address the issue of multithreading in the use of WatiN.  Sources, as always, <a href="http://bitbucket.org/nesteruk/datagatheringdemos">here</a> . <br><a name="habracut"></a><br><h3>  Generic WatiN host using MEF </h3><br>  Since it is dangerous to run several WatiN-managed services, we need to control this process using a service (host) that implements the plug-in architecture.  To begin with, let's define a certain interface on which WatiN-managed services will work: <br><br><blockquote><code><font color="black"><font color="#00008B">public</font> <font color="#00008B">abstract</font> <font color="#00008B">class</font> WatinDataAcquisitionService : DataAcquisitionService&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#006400">/// &lt;summary&gt;</font> <br> <font color="#006400">/// This method must be implemented by any scraping service that needs to</font> <br> <font color="#006400">/// use WatiN.</font> <br> <font color="#006400">/// &lt;/summary&gt;</font> <br> <font color="#006400">/// &lt;param name="browser"&gt;A preinitialized &lt;c&gt;Browser&lt;/c&gt; object</font> <br> <font color="#006400">/// that one can use for scraping.&lt;/param&gt;</font> <br> <font color="#006400">/// &lt;remarks&gt;Do not pass the &lt;c&gt;browser&lt;/c&gt; object into other</font> <br> <font color="#006400">/// threads or asynchronous operations.&lt;/remarks&gt;</font> <br> <font color="#00008B">public</font> <font color="#00008B">abstract</font> <font color="#00008B">void</font> AcquireData(Browser browser, ILog log);&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  Our interface has only one method for scrapping.  In this service we transfer the already initialized object of <code>Browser</code> type (it can be <code>IE</code> or <code>FireFox</code> ) as well as a link to the logger from the main service - this allows us to log the process from the main host. <br><br>  In order to get all the available WatiN services, our host uses MEF, declaring the fact that he wants to load all objects of the <code>WatinDataAcquisitionService</code> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><font color="black">[ImportMany( <font color="#00008B">typeof</font> (WatinDataAcquisitionService))]&lt;br/&gt; <br> <font color="#00008B">public</font> WatinDataAcquisitionService[] WatinServices { get; set; }&lt;br/&gt; <br></font></code> </blockquote><br>  Loading of available services occurs in the initialization of the service itself.  In our case, we just find all the DLLs in the <code>plugins</code> subdirectory: <br><br><blockquote> <code><font color="black">cat = <font color="#00008B">new</font> DirectoryCatalog( <font color="#A52A2A">"plugins"</font> );&lt;br/&gt; <br> cc = <font color="#00008B">new</font> CompositionContainer(cat);&lt;br/&gt; <br> cc.ComposeParts( <font color="#00008B">this</font> );&lt;br/&gt; <br></font></code> </blockquote><br>  Our stereotypical <code>DoWork()</code> method looks quite chic.  Let's show it first: <br><br><blockquote> <code><font color="black"><font color="#00008B">private</font> <font color="#00008B">void</font> DoWork()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">while</font> ( <font color="#00008B">true</font> )&lt;br/&gt; <br> {&lt;br/&gt; <br> log.InfoFormat( <font color="#A52A2A">"Found {0} WatiN services"</font> , WatinServices.Length);&lt;br/&gt; <br> <font color="#00008B">if</font> (WatinServices.Length &gt; 0)&lt;br/&gt; <br> <font color="#00008B">using</font> ( <font color="#00008B">var</font> browser = <font color="#00008B">new</font> IE())&lt;br/&gt; <br> {&lt;br/&gt; <br> browser.Visible = <font color="#00008B">false</font> ;&lt;br/&gt; <br> <font color="#00008B">foreach</font> ( <font color="#00008B">var</font> s <font color="#00008B">in</font> WatinServices)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">using</font> ( <font color="#00008B">var</font> timer = <font color="#00008B">new</font> MyTimer(s.GetType().FullName, log))&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#006400">// prevent errors from bleeding through</font> <br> <font color="#00008B">try</font> &lt;br/&gt; <br> {&lt;br/&gt; <br> s.AcquireData(browser, log);&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">catch</font> (Exception ex)&lt;br/&gt; <br> {&lt;br/&gt; <br> log.Error(&lt;br/&gt; <br> <font color="#00008B">string</font> .Format( <font color="#A52A2A">"WatiN service {0} threw an exception"</font> , s.GetType().FullName),&lt;br/&gt; <br> ex);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#006400">// do some work, then</font> <br> Thread.Sleep(pollingFrequency);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  There are a few things happening here - measuring time, launching services and logging errors in case their authors allow exceptions to break through the meningeal barrier (House should be watched).  Since services are called sequentially, they all use the browser without interfering with each other. <br><br>  As for our plugin, everything is very simple - this is a DLL in which there is a class (s) marked with the <code>Export</code> attribute.  Like this: <br><br><blockquote> <code><font color="black">[Export( <font color="#00008B">typeof</font> (WatinDataAcquisitionService))]&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">class</font> PokemonService : WatinDataAcquisitionService&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">override</font> <font color="#00008B">void</font> AcquireData(Browser browser, ILog log)&lt;br/&gt; <br> {&lt;br/&gt; <br> log.Info( <font color="#A52A2A">"Pokemon service running"</font> );&lt;br/&gt; <br> browser.GoTo( <font color="#A52A2A">"http://www.pokemon.com"</font> );&lt;br/&gt; <br> <font color="#00008B">var</font> doc = <font color="#00008B">new</font> HtmlDocument();&lt;br/&gt; <br> doc.LoadHtml(browser.Body.OuterHtml);&lt;br/&gt; <br> <font color="#00008B">var</font> h3 = doc.DocumentNode.SelectNodes( <font color="#A52A2A">"//h3"</font> ).First();&lt;br/&gt; <br> log.Info(h3.InnerText);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  The beauty of MEF is that the resulting DLL can be simply copied into <code>plugins</code> daddy and everything will work.  Danger, Will Robinson: dependencies, too, need to be copied to this folder or do ILmerge (the second is preferable). <br><br><h3>  Seriously, what about multithreading? </h3><br>  In fact, multi-threaded use of WatiN is certainly possible - after all, we can open multiple copies of IE at the same time, right?  But not everything is so simple. <br><br>  First, you cannot open immediately, say, 100 copies of IE - what specifically breaks is not clear (COM exceptions are such informative ...), but problems are guaranteed.  On the other hand, you can open for example <code>2*Environment.ProcessorCount</code> copies and everything is more or less working. <br><br>  The second problem is that if you use, say, TPL, then you need to write your <code>StaTaskScheduler</code> that will create STA threads instead of MTA.  Fortunately, this solution was already on the network ( <a href="http://code.msdn.microsoft.com/ParExtSamples">on MSDN</a> ), and I put it in the examples.  Here is an example of how you can run 4 copies of IE each time: <br><br><blockquote> <code><font color="black"><font color="#00008B">var</font> po = <font color="#00008B">new</font> ParallelOptions();&lt;br/&gt; <br> po.TaskScheduler = <font color="#00008B">new</font> StaTaskScheduler(4);&lt;br/&gt; <br> Parallel.For(0, 100, po, x =&gt;&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">using</font> ( <font color="#00008B">var</font> browser = <font color="#00008B">new</font> IE( <font color="#A52A2A">"http://news.bbc.co.uk"</font> ))&lt;br/&gt; <br> {&lt;br/&gt; <br> browser.Visible = <font color="#00008B">false</font> ;&lt;br/&gt; <br> <font color="#00008B">var</font> doc = <font color="#00008B">new</font> HtmlDocument();&lt;br/&gt; <br> doc.LoadHtml(browser.Body.OuterHtml);&lt;br/&gt; <br> <font color="#00008B">var</font> h3 = doc.DocumentNode.SelectNodes( <font color="#A52A2A">"//h3"</font> ).First();&lt;br/&gt; <br> Console.WriteLine(h3.InnerText);&lt;br/&gt; <br> }&lt;br/&gt; <br> });&lt;br/&gt; <br></font></code> </blockquote><br>  By analogy with this approach, our host server can open not one browser, but have a whole pool of, say, 10 browsers that can be selectively transferred to the services under control. </div><p>Source: <a href="https://habr.com/ru/post/94960/">https://habr.com/ru/post/94960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../94951/index.html">Samsung have developed a USB monitor for PC</a></li>
<li><a href="../94952/index.html">Enable IPv6 on dd-wrt</a></li>
<li><a href="../94953/index.html">One of the most promising projects of Mozilla Labs has been updated - Firefox Sync (formerly Weave)</a></li>
<li><a href="../94955/index.html">A minute of history, or what computers did the USSR</a></li>
<li><a href="../94957/index.html">Amp Music Player - an alternative player without jailbreak</a></li>
<li><a href="../94962/index.html">Dead time to wait, or how the iPhone gave us back three months of life (well, almost)</a></li>
<li><a href="../94964/index.html">Results of testing cloud service scalability</a></li>
<li><a href="../94967/index.html">Google easter eggs</a></li>
<li><a href="../94968/index.html">Internet Explorer 9 - the most comprehensive developer guide (and not only)</a></li>
<li><a href="../94969/index.html">Resonance in the service ... (continued)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>