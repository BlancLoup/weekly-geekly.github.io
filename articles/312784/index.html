<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NPM module support in backend as a service Scorocode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Welcome, Habrovchane and Skorokodery! In the article about the development of Scorocode, we asked the community what new functionality you would like ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NPM module support in backend as a service Scorocode</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7cc/226/6a1/7cc2266a1d604501af079898f1f4e554.jpg"><br><br>  Welcome, Habrovchane and Skorokodery!  In the <a href="https://habrahabr.ru/company/scorocode/blog/307056/">article about the development of Scorocode,</a> we asked the community what new functionality you would like to see in the service.  One of the popular options was support in the server code of npm modules.  You asked - we did!  For details, we ask under the cat. <br><a name="habracut"></a><br><h1>  <font color="#4BA7DE">Briefly about implementation</font> </h1><br>  To implement the npm modules, we had to completely revise the file and script storage device.  We refused to store scripts in a third-party cloud and transferred all data to our servers.  This allowed us to create a reserve for the implementation of the necessary functionality, as well as to improve the speed of working with data. <br><br>  Next came the turn of the JS file handler itself.  This handler (hereinafter referred to as ‚Äúbroker‚Äù) listens to RabbitMQ and, when a task arrives, sends it to the pool of workers for further processing.  The broker itself is written in Go and uses the Go-V8 bridge to execute JavaScript code.  It was clear that to support npm modules pure V8 will not work, implementing the most popular and necessary modules on request is also a utopian idea.  In any case, the code had to be executed in NodeJS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Many of our competitors have npm modules either unsupported or supported from the whitelist.  We immediately determined for ourselves that we want to give our users full access to npm, without limiting them to any list of supported modules.  This made us find the ability to run handlers in isolation from the rest, so that the code could not break other people's data. <br><br>  To solve the problem of running JavaScript code in isolation, we chose Docker.  This allowed us to start processing JavaScript code in the container, and not to restrict users in the choice of modules in the future.  The container is created from the image when the script runs.  The script itself and the installed modules are forwarded in the form of a file and folders inside the container.  Additionally, we modified the native require function so that it can support user scripts, installed npm modules, as well as native NodeJS modules. <br><br><h1>  <font color="#4BA7DE">As we left the admin and developer without beer</font> </h1><br>  This implementation was ready for a long time, we tested it for about a week and, at first glance, everything worked without problems.  In an effort to please users as early as possible, we decided to roll out updates on Friday afternoon.  After laying out the release, as well as data migration, everything worked with a bang, until our developer tried to write code using setInterval. <br><br>  As it turned out, when using the timeout parameter of the native vm module, the sandbox runs exactly as much as needed, but as soon as setInterval occurs in our code, timeout does not work.  Unfortunately, we did not have time to deal with the problem, and after some deliberation, the task of controlling the execution time of the scripts was placed on the broker‚Äôs shoulders. <br><br>  As a result, the release was laid out, problems were fixed, but the weekend for our administrator and developer began only on Saturday at 1:58, so we had to forget about the glass of Friday beer in the bar.  Break the commandment "do not lay out releases on Friday" will not :) <br><br><h1>  <font color="#4BA7DE">How to use npm modules in Scorocode</font> </h1><br>  In order to connect the necessary modules, you need to go to the ‚ÄúApplication Settings‚Äù section and select the ‚Äúnpm dependencies‚Äù tab. <br><br><img src="https://habrastorage.org/files/b79/15d/365/b7915d365aed48afbb3cecfb94d6e126.png"><br><br>  In the dependencies section, describe all the modules you intend to use.  The property is the name of the module, the value is the required version (you can leave the version value empty, in which case the latest version of the module will be installed). <br><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"scorocode"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"underscore"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"async"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }</code> </pre> <br>  After that we press the save button and go to the ‚ÄúServer Code‚Äù section and create a new script: <br><br><img src="https://habrastorage.org/files/6e3/7cc/66a/6e37cc66acc84b369b4eba46e6ef1484.png"><br><br>  As you can see from the screenshot, using installed modules is no different from using NodeJS.  To connect the required modules, use require. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SC = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'scorocode'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'async'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'underscore'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  .....</span></span></code> </pre><br><h1>  <font color="#4BA7DE">Conclusion</font> </h1><br>  In general, we managed to implement the support for npm modules in user applications fairly painlessly.  And now we are interested in receiving feedback, how will you use this functionality in your applications? <br><br>  Also, given the limitations of npm, we are eyeing the support of the package manager for node.js from facebook <a href="https://yarnpkg.com/">yarn</a> .  Has anyone tried it, what opinions do you have about it? </div><p>Source: <a href="https://habr.com/ru/post/312784/">https://habr.com/ru/post/312784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312774/index.html">Why do we need the Ho-Kashyap algorithm?</a></li>
<li><a href="../312776/index.html">DSL for regular expressions on Kotlin</a></li>
<li><a href="../312778/index.html">OpenShift v 3 III. OpenShift Origin 1.3</a></li>
<li><a href="../312780/index.html">Joanna Hoffman - Steve Jobs's ‚ÄúGuardian Angel‚Äù</a></li>
<li><a href="../312782/index.html">Basics of Auto Layout - Concept, structure, application</a></li>
<li><a href="../312786/index.html">October 22 in Moscow - a jitter for Java seniors: meeting with the CEO and the Crossover team</a></li>
<li><a href="../312792/index.html">Enum-switch antipattern</a></li>
<li><a href="../312794/index.html">The digest of interesting materials for the Mobile Developer # 175 (October 10-16)</a></li>
<li><a href="../312796/index.html">Donald Knut: How the ‚ÄúArt of Programming‚Äù was created (33,38,39 / 97)</a></li>
<li><a href="../312800/index.html">Introducing 3CX V15 SP2 with Debian Linux 8 support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>