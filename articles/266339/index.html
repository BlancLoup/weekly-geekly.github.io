<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I tried to make friends with Google API with CodeIgniter A3M and what came of it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the task arose of screwing the A3M library (this is a fairly popular authentication library for CodeIgniter) to support OAuth2 authenticatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I tried to make friends with Google API with CodeIgniter A3M and what came of it</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/3bd/280/1f8/3bd2801f8ae84a04ac0ff99d03e9a843.png" align="left"><br><br>  Recently, the task arose of <a href="https://github.com/donjakobo/A3M">screwing the A3M</a> library (this is a fairly popular authentication library for CodeIgniter) to support OAuth2 authentication via Google.  It all started when a comrade approached me a couple of months ago.  He has a website written by someone in ancient times on CodeIgniter.  Naturally, this someone has already disappeared in an unknown direction. <br><br>  The site is quite working and doesn‚Äôt have any particular problems, so the comrade didn‚Äôt sweat much and didn‚Äôt even think about updates or (God forbid) migration to anywhere. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One day, he discovered that when logging in via Google, this message arrives: <br><br>  <i>OpenID 2.0 for Google Accounts is Going Away.</i>  <i>OpenID 2.0 is no longer supported.</i>  <i>If your app uses OpenID 2.0, you must migrate your app by the date of April 20, 2015, as shown in the migration schedule.</i> <br><br>  Although my friend was never a programmer, he sensed something was wrong and turned to me in the hope that I could fix this thing. <br>  It has a rather large database of users on the site who logged in via Google, and if this business is not fixed until April 20th, many users will suddenly not be able to access the site. <br><br>  ‚ÄúNot a problem, let's fix it,‚Äù I said, and went into the Google <a href="https://developers.google.com/identity/protocols/OpenID2Migration">manual on migration</a> . <a name="habracut"></a>  After reading the first time, I realized that everything was difficult and decided to look for simpler ways.  ‚ÄúIt‚Äôs logical,‚Äù I thought, ‚Äúthat the authors of A3M are also aware that Google is stopping support for OpenID 2.0 and has already rolled out the patch on GitHub.‚Äù  And although the authors, in general, are aware, they have no time for that, desire / something else. <br><br>  I was sent to the beta-branch, where they complete the integration of <a href="https://github.com/donjakobo/A3M/tree/ci3-beta">A3M with HybridAuth</a> , which should <s>solve all the problems of humanity</s> logs in via OAuth2.  I, of course, this very brunch logs in through Google flatly refused for all sorts of different reasons.  I, in principle, could continue to sit at night with a debagger and make it work, but as time went on, April 20 inexorably approached, and I decided to look for another, more effective method. <br><br>  As it turned out, the guys from Google do not lose time and they already have a <a href="https://github.com/google/google-api-php-client">ready Client API</a> in all less known languages.  Now it remains only to ‚Äúintroduce‚Äù A3M to google-api-php-client. <br><br>  Well, for the work. <br><br>  So, first download the Google API PHP Client: <br><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/google/google-api-php-client</code> </pre> <br>  Copy the entire folder into application / libraries.  It remains only to connect everything beautifully. <br><br>  Now go here: <a href="https://console.developers.google.com/">console.developers.google.com</a> .  Here you need to create a new project.  After that, go to the API's, find the Google+ API and enable it.  Then go to "Credentials" and create a "New Client ID".  You must specify the correct Redirect URIs and origins JavaScript.  After creation we will receive our client id and client secret. <br><br>  Actually code: <br>  Go to application / controllers / account / connect_google.php.  First of all, connect the google API.  It is important to specify the absolute path to the library, otherwise the composer will not be able to download all the necessary components: <br><br><pre> <code class="php hljs">set_include_path ( get_include_path () . PATH_SEPARATOR . APPPATH .<span class="hljs-string"><span class="hljs-string">'application/libraries/google-api-php-client/src/Google'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> APPPATH . <span class="hljs-string"><span class="hljs-string">"libraries/google-api-php-client/src/Google/autoload.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> APPPATH . <span class="hljs-string"><span class="hljs-string">"libraries/google-api-php-client/src/Google/Client.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> APPPATH . <span class="hljs-string"><span class="hljs-string">"libraries/google-api-php-client/src/Google/Service/Oauth2.php"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    ,    Google API. $client = new Google_Client (); $client-&gt;setApplicationName ( "A3M with OAuth2 support" ); $client-&gt;setClientId ( $client_id ); $client-&gt;setClientSecret ( $client_secret ); $client-&gt;setRedirectUri ( $redirect_uri ); $client-&gt;addScope ( "email" ); $client-&gt;setOpenidRealm ( $redirect_uri ); //      OpenID 2.0</span></span></code> </pre><br>  That is, if you request <b>openid_realm</b> , we get back <b>openid_id</b> , which CodeIgniter uses as the unique user ID in the database. <br><br>  By the way, there is one interesting point.  If we (on the CodeIgniter site) already have an old user base that logged in with Google, when it still supported OpenID 2.0, then most likely when trying to authenticate through OAuth2 we will get a completely different <b>openid_id</b> and, accordingly, will not be able to identify the user from the database. <br><br>  In order for open_id to always be the same, it is necessary that the Redirect URI in both cases be identical. <br>  More details can be read here: <br>  <a href="http://stackoverflow.com/a/23051643/524743">stackoverflow.com/a/23051643/524743</a> <br>  <a href="http://stackoverflow.com/q/29229204/524743">stackoverflow.com/q/29229204/524743</a> <br><br>  Here is the method for getting the client's <b>openid_id</b> : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// This method extracts openID2 ID form id token for backward compatibility private function getOpenIDFromToken($client, $token) { $id_token = json_decode ( $token ); $ticket = $client-&gt;verifyIdToken ( $id_token-&gt;{'id_token'} ); if ($ticket) { $data = $ticket-&gt;getAttributes (); return $data ['payload'] ['openid_id']; // user ID } return false; }</span></span></code> </pre><br>  Begin the authentication process: <br><br><pre> <code class="php hljs">$objOAuthService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Google_Service_Oauth2 ( $client ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span> ( $authURL )) <span class="hljs-comment"><span class="hljs-comment">//         ‚ÄúExpired Token‚Äù unset ( $_SESSION ['access_token'] ); //       //       endpoint if (isset ( $_GET ['code'] )) { $client-&gt;authenticate ( $_GET ['code'] ); $_SESSION ['access_token'] = $client-&gt;getAccessToken (); header ( 'Location: ' . filter_var ( $redirect_uri, FILTER_SANITIZE_URL ) ); } //    ,  openid_id if (isset ( $_SESSION ['access_token'] ) &amp;&amp; $_SESSION ['access_token']) { $client-&gt;setAccessToken ( $_SESSION ['access_token'] ); $openid_id = $this-&gt;getOpenIDFromToken ( $client, $client-&gt;getAccessToken () ); } //           if ($client-&gt;getAccessToken ()) { $userData = $objOAuthService-&gt;userinfo-&gt;get (); $data ['userData'] = $userData; $_SESSION ['access_token'] = $client-&gt;getAccessToken (); $openid_id = $this-&gt;getOpenIDFromToken ( $client, $client-&gt;getAccessToken () ); } //       ,    URI,     . else { $authUrl = $client-&gt;createAuthUrl (); $data ['authUrl'] = $authUrl; header ( 'Location:' . $authUrl ); die (); //      :) }</span></span></code> </pre><br>  ... <br>  After receiving user data, we check if it is in the database, and if not, create a new record: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;authentication-&gt;is_signed_in ()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($userData) { $email = $userData-&gt;getEmail (); $openid_google = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'fullname'</span></span> =&gt; $userData-&gt;getName (), $openid_google <span class="hljs-string"><span class="hljs-string">'gender'</span></span> =&gt; $userData-&gt;getGender (), $openid_google <span class="hljs-string"><span class="hljs-string">'language'</span></span> =&gt; $userData-&gt;getLocale (), $openid_google <span class="hljs-string"><span class="hljs-string">'firstname'</span></span> =&gt; $userData-&gt;getGivenName (), <span class="hljs-comment"><span class="hljs-comment">// google only $openid_google 'lastname' =&gt; $userData-&gt;getFamilyName (), // google only ); } // Store user's google data in session $this-&gt;session-&gt;set_userdata ( 'connect_create', array ( array ( 'provider' =&gt; 'openid', 'provider_id' =&gt; isset ( $openid_id ) ? $openid_id : NULL, 'email' =&gt; isset ( $email ) ? $email : NULL ), $openid_google ) ); // Create a3m account redirect ( 'account/connect_create' );</span></span></code> </pre><br><br>  Done!  User in the database, authentication failed and everyone is happy. <br><br>  All sources are <a href="https://github.com/samuelsh/A3M">here</a> .  If you have any questions, I will be happy to help. </div><p>Source: <a href="https://habr.com/ru/post/266339/">https://habr.com/ru/post/266339/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266327/index.html">Installing Zabbix 2.4 on RedHat Openshift</a></li>
<li><a href="../266329/index.html">RailsClub 2015: Interview with Cyrus Shatrov</a></li>
<li><a href="../266331/index.html">Launch of RAD Studio 10 Seattle in Moscow and Almaty</a></li>
<li><a href="../266335/index.html">Examples of classic code that has become open source</a></li>
<li><a href="../266337/index.html">Bleed TinyMCE 4</a></li>
<li><a href="../266341/index.html">The course "Basics of effective work with Wolfram technologies". Lesson 2.1: Introduction to the Wolfram Language, its features. The main difficulties of novice users. Work with the Mathematica interface and its capabilities</a></li>
<li><a href="../266343/index.html">Handling cloud traffic. Who needs network function virtualization (NFV)?</a></li>
<li><a href="../266345/index.html">A practical guide to hacking (and protecting) games on Unity</a></li>
<li><a href="../266347/index.html">Overview of segmentation algorithms</a></li>
<li><a href="../266349/index.html">Practical training in pentest laboratories. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>