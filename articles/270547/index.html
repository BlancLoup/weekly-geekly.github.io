<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hidden dependencies as a design ‚Äúsmell‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mark Siman wrote a wonderful post "Service Locator breaks encapsulation." The name of the post speaks for itself that it is dedicated to the Service L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hidden dependencies as a design ‚Äúsmell‚Äù</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://blog.ploeh.dk/about.html">Mark Siman</a> wrote a <a href="http://habrahabr.ru/post/270005/">wonderful post "Service Locator breaks encapsulation."</a>  The name of the post speaks for itself that it is dedicated to the <i>Service Locator</i> pattern (anti-pattern).  When a programmer randomly calls an IoC container in code to resolve a dependency of an object, he uses the <i>Service Locator</i> anti-pattern.  Mark considers the following example: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IOrderProcessor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validator = Locator.Resolve&lt;IOrderValidator&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (validator.Validate(order)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shipper = Locator.Resolve&lt;IOrderShipper&gt;(); shipper.Ship(order); } } }</code> </pre> <br><a name="habracut"></a><br>  As we can see, the encapsulation of the <i>OrderProcessor</i> type is broken due to two hidden dependencies that are quietly resolved in the <i>Process</i> method.  These dependencies are hidden from the calling code, which can lead to an exception at runtime if the client has not properly configured the IoC container, determining the necessary dependencies in it.  As a solution to the problem, Mark suggests transferring dependency resolution to the object's constructor. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IOrderProcessor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderProcessor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IOrderValidator validator, IOrderShipper shipper</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">) }</span></span></code> </pre><br>  Thus, the calling code will be aware of what the <i>OrderProcessor</i> object actually requires. <br><br>  However, in my opinion, there are still scenarios where dependency hiding can be applied.  Consider a WPF application where virtually any <i>ViewModel</i> requires the following dependencies: <i>IEventAggregator, IProgress, IPromptCreator</i> .  To reveal the meaning of the last two interfaces, I would add that the implementation of <i>IProgress</i> should be able to accept a piece of long-running code and show a window with a progress scale, <i>IPromptCreator</i> allows <i>you</i> to open windows asking for confirmation, consent or refusal (modal dialogs).  Now imagine that there are <i>ViewModels</i> that require in addition two (and maybe three) dependencies to create a model.  Here‚Äôs how the <i>ViewModel</i> can start to look like with so many dependencies: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PaymentViewModel</span></span>: <span class="hljs-title"><span class="hljs-title">ICanPay</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PaymentViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPaymentSystem paymentSystem, IRulesValidator rulesValidator, IEventAggregator aggregator, IProgress progress, IPromptCreator promptCreator</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PayFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">) }</span></span></code> </pre><br>  What a mess!  Too much noise in the constructor declaration.  Only two dependencies really carry useful information in terms of business logic. <br><br>  If we, say, use MEF for dependency injection, then we can do the following: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Export</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PaymentViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">ICanPay</span></span> { [Import] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> IEventAggregator aggregator; [Import] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> IProgress progress; [Import] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> IPromptCreator promptCreator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PaymentViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPaymentSystem paymentSystem, IRulesValidator rulesValidator</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PayFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//use aggreagtor, progress, promptCreator } }</span></span></code> </pre><br>  We moved the dependencies from the constructor to the field declarations and marked them with the <i>Import</i> attribute.  Despite the fact that we do not call the IoC container directly (although, MEF is not a pure IoC container), we hide dependencies in the same way as in Mark's example.  Nothing really changed.  Why do I think this code is not so bad?  For several main reasons: <br><ul><li>  <i>ViewModels</i> are not business entities, they are just pieces of code for pasting <i>Models</i> and <i>Views</i> .  Nobody really cares about the above dependencies; </li><li>  <i>ViewModels</i> are not public APIs and they are not reused (in most cases); </li><li>  Given the two previous points, team members can simply agree that all <i>ViewModels</i> have these utilitarian dependencies, and that's it; </li><li>  These utilitarian dependencies are defined as protected, which allows us to create a <i>ViewModel</i> class inheriting the <i>PaymentViewModel</i> in the tests and replace the dependencies with mocks, since we will have access to those fields.  Thus, we do not lose the opportunity to cover the tests <i>PaymentViewModel</i> .  In Mark's example (where <i>Service Locator is used</i> ), it was necessary to set up an IoC container in a unit test project in order to lock or fix those dependencies, and this practice can become painful for the unit testing process. </li></ul><br><h2>  Conclusion </h2><br>  As I have already said, there are no only correct answers or statements for programming in all cases.  Generally speaking, we should avoid using the <i>Service Locator</i> , because it breaks encapsulation, as Mark says in his article.  Before you use the <i>Service Locator</i> , assess the potential harm you will cause the system.  If you are sure that hidden dependency resolution does not affect client code (which your teammates can write) and there is no potential harm to the system, then go ahead with the song. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/270547/">https://habr.com/ru/post/270547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270531/index.html">About Parboiled (Part 2)</a></li>
<li><a href="../270537/index.html">How I became an android developer without a core education, simultaneously hindering concrete</a></li>
<li><a href="../270541/index.html">How to calculate the range of communication equipment Ubiquiti. New version of the calculator AirLink</a></li>
<li><a href="../270543/index.html">TensorFlow: Google's machine learning, now smarter for everyone</a></li>
<li><a href="../270545/index.html">Declarative C ++ programming</a></li>
<li><a href="../270549/index.html">How we moved the disk space of hundreds of bank branches to a single storage system in Moscow without losing LAN speeds in the field</a></li>
<li><a href="../270551/index.html">Use VTune Amplifier 2016 to analyze the HelloOpenCL application for GPU</a></li>
<li><a href="../270555/index.html">Veeam Cloud Connect in Microsoft Azure</a></li>
<li><a href="../270557/index.html">What is useful you can extract from the report on the clouds in Russia</a></li>
<li><a href="../270559/index.html">The book "Learning C + + through game programming"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>