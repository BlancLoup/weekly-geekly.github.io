<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up an Internet gateway for a small office CentOS, Iptables, NAT, Squid Transparent, Sarg</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gone are the days when our office had 2 computers, and a DSL modem for 4 ports with 2 megabit Internet 
 saved the situation. Now the office has 5 wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up an Internet gateway for a small office CentOS, Iptables, NAT, Squid Transparent, Sarg</h1><div class="post__text post__text-html js-mediator-article">  Gone are the days when our office had 2 computers, and a DSL modem for 4 ports with 2 megabit Internet <br>  saved the situation.  Now the office has 5 working machines and 1 server for developer tasks. <br><br>  When connecting everyone to a switch with a standard Tp Link gateway, if someone started downloading, the Internet would hang on everyone.  It was decided to create your own Internet gateway, with a traffic shaper, DNS, DHCP and statistics (squid + sarg) and a proxy. <br><br>  A DualCore pentium, 4 GB RAM with CentOS 6.4 minimal installed onboard was chosen as a server. <br>  So, let's proceed to the configuration of our future Internet gateway. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>The task is to configure</b> : <br>  Internet distribution via NAT (iptables, htb), DHCP, DNS, HTTPD, NGINX, SARG <br><a name="habracut"></a><br><h5>  The first step, installing the necessary basic software </h5><br>  Add the necessary repositories <br><pre><code class="bash hljs">rpm --import http://apt.sw.be/RPM-GPG-KEY.dag.txt rpm -ivh http://packages.sw.be/rpmforge-release/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm rpm --import https://fedoraproject.org/static/0608B895.txt rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm rpm --import http://rpms.famillecollet.com/RPM-GPG-KEY-remi rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</code> </pre> <br>  Clear YUM cache <br><pre> <code class="bash hljs">yum clean all</code> </pre><br>  Install the software to build <br><pre> <code class="bash hljs">yum -y groupinstall <span class="hljs-string"><span class="hljs-string">"Development tools"</span></span></code> </pre><br>  Install other necessary utilities. <br><pre> <code class="bash hljs">yum -y install git mc htop lftp unzip zlib zlib-devel openssl openssl-devel patch libtool re2c bison fprintd-pam subversion sshfs curlftpfs</code> </pre><br><br><h5>  The second step, installing nginx </h5><br><pre> <code class="bash hljs">useradd nginx -s /bin/<span class="hljs-literal"><span class="hljs-literal">false</span></span> -M -U mkdir /var/run/nginx/ chown -R nginx:nginx /var/run/nginx/ mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/ chown -R nginx:nginx /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://nginx.org/download/nginx-1.4.2.tar.gz tar xvzf nginx* <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx* git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/yaoweibin/nginx_tcp_proxy_module.git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/mikewest/nginx-static-etags.git patch -p1 &lt; nginx_tcp_proxy_module/tcp.patch wget -O release-1.6.29.5-beta.zip https://github.com/pagespeed/ngx_pagespeed/archive/release-1.6.29.5-beta.zip unzip release-1.6.29.5-beta.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ngx_pagespeed-release-1.6.29.5-beta/ wget --no-check-certificate -O 1.6.29.5.tar.gz https://dl.google.com/dl/page-speed/psol/1.6.29.5.tar.gz tar -xzvf 1.6.29.5.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/nginx* ./configure --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error_log --pid-path=/var/run/nginx/nginx.pid --lock-path=/var/lock/subsys/nginx --add-module=nginx-static-etags --add-module=nginx_tcp_proxy_module --add-module=ngx_pagespeed-release-1.6.29.5-beta --user=nginx --group=nginx --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --without-http_geo_module --without-http_ssi_module --without-http_empty_gif_module --without-http_browser_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --with-pcre=/usr/src/pcre-8.33 --without-http_memcached_module --without-http_scgi_module --without-http_uwsgi_module --without-http_fastcgi_module --http-fastcgi-temp-path= --http-uwsgi-temp-path= --prefix=/server/nginx --with-ipv6 make make install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /server/nginx/conf/ &amp;&amp; rm -f fastcgi.conf fastcgi.conf.default fastcgi_params fastcgi_params.default koi-utf koi-win mime.types.default nginx.conf.default scgi_params scgi_params.default uwsgi_params uwsgi_params.default win-utf mkdir /server/nginx/conf/conf.d/</code> </pre><br>  Create the nginx.conf file: <br><pre> <code class="bash hljs">touch /server/nginx/conf/nginx.conf</code> </pre><br>  Contents of nginx.conf <br><pre> <code class="bash hljs">worker_processes 8; events { worker_connections 25000; use epoll; } http { include mime.types; default_type application/octet-stream; sendfile on; tcp_nopush on; gzip on; gzip_min_length 1000; gzip_proxied any; gzip_types text/plain text/xml application/xml application/x-javascript text/javascript text/css text/json; gzip_comp_level 8; client_max_body_size 20M; server { listen 192.168.5.1:80 default_server; stub_status on; location = /apache-stats { proxy_pass http://127.0.0.1:80; } allow 192.168.5.1; deny all; } include conf.d/*.conf; }</code> </pre><br>  File to run: <br><pre> <code class="bash hljs">touch /etc/init.d/nginx chmod +x /etc/init.d/nginx</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # chkconfig: - 58 74 # # Source function library. . /etc/init.d/functions # Source networking configuration. . /etc/sysconfig/network if [ -f /etc/sysconfig/nginx ];then . /etc/sysconfig/nginx fi RETVAL=0 prog="nginx" start() { # Check that networking is up. [ "$NETWORKING" = "no" ] &amp;&amp; exit 1 echo -n $"Starting $prog: " daemon /server/nginx/sbin/nginx $OPTIONS RETVAL=$? echo [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/nginx return $RETVAL } stop() { echo -n $"Shutting down $prog: " killproc /server/nginx/sbin/nginx RETVAL=$? echo [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx return $RETVAL } # See how we were called. case "$1" in start) start ;; stop) stop ;; status) status nginx RETVAL=$? ;; restart|reload) stop start RETVAL=$? ;; condrestart) if [ -f /var/lock/subsys/nginx ]; then stop start RETVAL=$? fi ;; *) echo $"Usage: $0 {start|stop|restart|condrestart|status}" RETVAL=3 esac exit $RETVAL</span></span></code> </pre><br><br><h5>  The third step, installing httpd </h5><br><br>  <b>For Apache we supply APR, APR-UTIL, PCRE</b> <br>  Install APR <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://apache.ip-connect.vn.ua//apr/apr-1.5.0.tar.gz tar xvzf apr-1.5.0* <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> apr-1.5.0 ./configure --prefix=/server/misc/apr make make install</code> </pre><br>  Installing APR-UTIL <br><pre> <code class="bash hljs">yum -y install openldap-devel nss nss-devel <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://apache.ip-connect.vn.ua//apr/apr-util-1.5.3.tar.gz tar xvzf apr-util* <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> apr-util-* ./configure --prefix=/server/misc/apr-util --with-apr=/server/misc/apr --with-crypto --with-ldap make make install</code> </pre><br>  PCRE installation <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://ftp.exim.llorien.org/pcre/pcre-8.33.tar.gz tar xvzf pcre-8.33.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> pcre* ./configure --prefix=/server/misc/pcre make make install</code> </pre><br>  APACHE installation <br><pre> <code class="bash hljs">useradd apache -s /bin/<span class="hljs-literal"><span class="hljs-literal">false</span></span> -M -U mkdir /var/run/httpd/ &amp;&amp; chown -R apache:apache /var/run/httpd/ mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/ &amp;&amp; chown -R apache:apache /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://mpm-itk.sesse.net/mpm-itk-2.4.4-04.tar.gz tar xvzf mpm* wget http://archive.apache.org/dist/httpd/httpd-2.4.6.tar.gz tar xvzf httpd* cp -r httpd-2.4.6 httpd-2.4.6.orig <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> httpd-2.4.6 patch -p1 &lt; /usr/src/mpm-itk-2.4.4-04/patches/r1389339-pre-htaccess-hook.diff rm -rf /usr/src/httpd-2.4.6.orig ./buildconf --with-apr=/usr/src/apr-1.4.8 --with-apr-util=/usr/src/apr-util-1.5.2 ./configure --prefix=/server/httpd --with-mpm=prefork --with-apr=/server/misc/apr --with-apr-util=/server/misc/apr-util --with-pcre=/server/misc/pcre --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-version --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-status --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-rewrite=static --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-realip=static --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-mods-static=<span class="hljs-string"><span class="hljs-string">"authn_file mime authn_core authz_host authz_groupfile authz_user authz_core access_compat auth_basic reqtimeout filter log_config env headers setenvif unixd dir alias realip status info"</span></span> make make install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/mpm* ./configure --with-apxs=/server/httpd/bin/apxs make make install mkdir -p /server/httpd/conf/conf.d/sites/ rm -rf /server/httpd/man rm -rf /server/httpd/manual rm -rf /server/httpd/icons rm -rf /server/httpd/cgi-bin rm -rf /server/httpd/logs rm -rf /server/httpd/conf/extra rm -rf /server/httpd/conf/original mkdir /var/www chown root:root /var/www chown -R apache:apache /server/httpd</code> </pre><br>  Let's fix httpd.conf to this view: <br><pre> <code class="bash hljs">ServerRoot <span class="hljs-string"><span class="hljs-string">"/server/httpd"</span></span> Listen 127.0.0.1:80 LoadModule mpm_itk_module modules/mpm_itk.so LoadModule remoteip_module modules/mod_remoteip.so &lt;IfModule unixd_module&gt; User apache Group apache &lt;/IfModule&gt; ServerAdmin webmaster@{HOSTNAME} ServerName {HOSTNAME} &lt;IfModule dir_module&gt; DirectoryIndex index.html &lt;/IfModule&gt; &lt;Files <span class="hljs-string"><span class="hljs-string">".ht*"</span></span>&gt; Require all denied &lt;/Files&gt; ErrorLog <span class="hljs-string"><span class="hljs-string">"/var/log/httpd/error_log"</span></span> LogLevel warn PidFile /var/run/httpd/httpd.pid &lt;IfModule log_config_module&gt; LogFormat <span class="hljs-string"><span class="hljs-string">"%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span></span> combined LogFormat <span class="hljs-string"><span class="hljs-string">"%h %l %u %t \"%r\" %&gt;s %b"</span></span> common CustomLog <span class="hljs-string"><span class="hljs-string">"/var/log/httpd/access_log"</span></span> common <span class="hljs-comment"><span class="hljs-comment">#CustomLog "/var/log/httpd/logs/access_log" combined &lt;/IfModule&gt; &lt;IfModule alias_module&gt; ScriptAlias /cgi-bin/ "/server/httpd/cgi-bin/" &lt;/IfModule&gt; &lt;Directory "/server/httpd/cgi-bin"&gt; AllowOverride None Options None Require all granted &lt;/Directory&gt; &lt;IfModule mime_module&gt; TypesConfig conf/mime.types AddType application/x-compress .Z AddType application/x-gzip .gz .tgz &lt;/IfModule&gt; &lt;IfModule prefork.c&gt; StartServers 6 MinSpareServers 5 MaxSpareServers 10 ServerLimit 256 MaxClients 256 MaxRequestsPerChild 10000 &lt;/IfModule&gt; ServerName 127.0.0.1 IncludeOptional conf/conf.d/*.conf IncludeOptional conf/conf.d/sites/*.conf # Timeout: The number of seconds before receives and sends time out. Timeout 60 # KeepAlive: Whether or not to allow persistent connections (more than one request per connection). Set to "Off" to deactivate. KeepAlive On # MaxKeepAliveRequests: The maximum number of requests to allow during a persistent connection. Set to 0 to allow an unlimited amount. We recommend you leave this number high, for maximum performance. MaxKeepAliveRequests 100 # KeepAliveTimeout: Number of seconds to wait for the next request from the same client on the same connection. KeepAliveTimeout 5 # Set to one of: Full | OS | Minor | Minimal | Major | Prod where Full conveys the most information, and Prod the least. ServerTokens Prod UseCanonicalName Off AccessFileName .htaccess ServerSignature Off HostnameLookups Off ExtendedStatus On &lt;IfModule reqtimeout_module&gt; RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500 &lt;/IfModule&gt; &lt;IfModule remoteip_module&gt; RemoteIPHeader X-Forwarded-For RemoteIPInternalProxy 127.0.0.1 &lt;/IfModule&gt;</span></span></code> </pre><br>  Create a file to run: <br><pre> <code class="bash hljs">touch /etc/init.d/httpd chmod +x /etc/init.d/httpd</code> </pre><br>  with content: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # httpd Startup script for the Apache HTTP Server # # chkconfig: - 85 15 # description: The Apache HTTP Server is an efficient and extensible \ # server implementing the current HTTP standards. # processname: httpd # config: /server/httpd/conf/httpd.conf # pidfile: /var/run/httpd/httpd.pid # ### BEGIN INIT INFO # Provides: httpd # Required-Start: $local_fs $remote_fs $network $named # Required-Stop: $local_fs $remote_fs $network # Should-Start: distcache # Short-Description: start and stop Apache HTTP Server # Description: The Apache HTTP Server is an extensible server # implementing the current HTTP standards. ### END INIT INFO # Source function library. . /etc/rc.d/init.d/functions # Start httpd in the C locale by default. HTTPD_LANG="C" # This will prevent initlog from swallowing up a pass-phrase prompt if # mod_ssl needs a pass-phrase from the user. INITLOG_ARGS="" # Set HTTPD=/usr/sbin/httpd.worker in /etc/sysconfig/httpd to use a server # with the thread-based "worker" MPM; BE WARNED that some modules may not # work correctly with a thread-based MPM; notably PHP will refuse to start. # Path to the apachectl script, server binary, and short-form for messages. apachectl=/server/httpd/bin/apachectl httpd=/server/httpd/bin/httpd prog=httpd pidfile=/var/run/httpd/httpd.pid lockfile=/var/lock/subsys/httpd RETVAL=0 STOP_TIMEOUT=10 # The semantics of these two functions differ from the way apachectl does # things -- attempting to start while running is a failure, and shutdown # when not running is also a failure. So we just do it the way init scripts # are expected to behave here. start() { echo -n $"Starting $prog: " LANG=$HTTPD_LANG daemon --pidfile=${pidfile} $httpd $OPTIONS RETVAL=$? echo [ $RETVAL = 0 ] &amp;&amp; touch ${lockfile} return $RETVAL } # When stopping httpd, a delay (of default 10 second) is required # before SIGKILLing the httpd parent; this gives enough time for the # httpd parent to SIGKILL any errant children. stop() { echo -n $"Stopping $prog: " killproc -p ${pidfile} -d ${STOP_TIMEOUT} $httpd RETVAL=$? echo [ $RETVAL = 0 ] &amp;&amp; rm -f ${lockfile} ${pidfile} } reload() { echo -n $"Reloading $prog: " if ! LANG=$HTTPD_LANG $httpd $OPTIONS -t &gt;&amp;/dev/null; then RETVAL=6 echo $"not reloading due to configuration syntax error" failure $"not reloading $httpd due to configuration syntax error" else # Force LSB behaviour from killproc LSB=1 killproc -p ${pidfile} $httpd -HUP RETVAL=$? if [ $RETVAL -eq 7 ]; then failure $"httpd shutdown" fi fi echo } # See how we were called. case "$1" in start) start ;; stop) stop ;; status) status -p ${pidfile} $httpd RETVAL=$? ;; restart) stop start ;; condrestart|try-restart) if status -p ${pidfile} $httpd &gt;&amp;/dev/null; then stop start fi ;; force-reload|reload) reload ;; graceful|help|configtest|fullstatus) $apachectl $@ RETVAL=$? ;; *) echo $"Usage: $prog {start|stop|restart|condrestart|try-restart|force-reload|reload|status|fullstatus|graceful|help|configtest}" RETVAL=2 esac exit $RETVAL</span></span></code> </pre><br><br><h5>  The fourth step, setting up the distribution of the Internet </h5><br>  The server has two network interfaces: <br>  eth0 - Internet from the provider <br>  eth1 - Our local network <br><br>  Create a file / iptables with the contents: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh PATH=/usr/sbin:/sbin:/bin:/usr/bin # -   iptables -F iptables -t nat -F iptables -t mangle -F iptables -X iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -m state --state NEW ! -i eth0 -j ACCEPT iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to 192.168.5.1:3128 echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span></span></code> </pre><br>  We give the right to run the file: <br><pre> <code class="bash hljs">chmod +x /iptables</code> </pre><br>  Run <br><pre> <code class="bash hljs">/iptables</code> </pre><br>  Editing the network interface: <br><pre> <code class="bash hljs">mcedit /etc/sysconfig/network-scripts/ifcfg-eth1</code> </pre><br><pre> <code class="bash hljs">DEVICE=eth1 HWADDR=00:0E:0C:73:E4:F9 TYPE=Ethernet ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=static IPADDR=192.168.5.1 NETMASK=255.255.255.0 GATEWAY=192.168.1.106 NETWORK=192.168.5.0</code> </pre><br><br>  GATEWAY - ip eth0 interface <br><br>  Reboot the network: <br><pre> <code class="bash hljs">service network restart</code> </pre><br><br><h5>  The fifth step, setting dhcpd </h5><br>  Install it through yum <br><pre> <code class="bash hljs">yum -y install dhcpd</code> </pre><br>  Configuring: <br><pre> <code class="bash hljs">mcedit /etc/dhcp/dhcpd.conf</code> </pre><br><pre> <code class="bash hljs">ddns-update-style none; ignore client-updates; DHCPARGS=<span class="hljs-string"><span class="hljs-string">"eth1"</span></span>; INTERFACES=<span class="hljs-string"><span class="hljs-string">"eth1"</span></span>; subnet 192.168.5.0 netmask 255.255.255.0 { range 192.168.5.100 192.168.5.200; option routers 192.168.5.1; option subnet-mask 255.255.255.0; option domain-name <span class="hljs-string"><span class="hljs-string">".loc"</span></span>; option domain-name-servers 192.168.5.1; option time-offset -18000; default-lease-time 21600; max-lease-time 43200; } host astraPC1 { hardware ethernet 00:21:91:91:11:42; fixed-address 192.168.5.6; } host astraPC2 { hardware ethernet D0:27:88:43:7E:AE; fixed-address 192.168.5.7; } host astraPC3 { hardware ethernet D0:27:88:43:7F:0E; fixed-address 192.168.5.8; } host astraPC4 { hardware ethernet 90:2B:34:BB:15:F2; fixed-address 192.168.5.9; } host astraPC5 { hardware ethernet 90:2B:34:BA:E1:55; fixed-address 192.168.5.10; }</code> </pre><br><br>  Here we specified dns server, ip of our gateway.  As DNS, it is logical to use something simple, I chose dnsmasq <br><br><h5>  Step Six, configure the server dns </h5><br><pre> <code class="bash hljs">yum -y install dnsmasq</code> </pre><br><br>  We already have DHCP installed, we do not need the rest of the functionality, the config file is quite simple according to the principle of including only what is needed <br><pre> <code class="bash hljs">interface=eth1 no-dhcp-interface=eth1 port=53 <span class="hljs-comment"><span class="hljs-comment"># -     /etc/hosts localise-queries all-servers # -     clear-on-reload # - DNS   server=192.168.1.1</span></span></code> </pre><br><br>  In / etc / hosts, some hosts were needed for our local network: <br><pre> <code class="bash hljs">192.168.5.1 sarg.loc 192.168.5.1 mysql.loc</code> </pre><br><br>  SARG - log generator for SQUID <br><br><h5>  Step Seven, installing squid </h5><br><pre> <code class="bash hljs">yum -y install squid</code> </pre><br>  The configuration file is governed to the following state: <br><pre> <code class="bash hljs">acl manager proto cache_object acl localhost src 127.0.0.1/32 ::1 acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1 acl lan src 192.168.5.1/32 acl localnet src 10.0.0.0/8 <span class="hljs-comment"><span class="hljs-comment"># RFC1918 possible internal network acl localnet src 172.16.0.0/12 # RFC1918 possible internal network acl localnet src 192.168.0.0/16 # RFC1918 possible internal network acl localnet src fc00::/7 # RFC 4193 local private network range acl localnet src fe80::/10 # RFC 4291 link-local (directly plugged) machines acl SSL_ports port 443 acl Safe_ports port 80 # http acl Safe_ports port 21 # ftp acl Safe_ports port 443 # https acl Safe_ports port 70 # gopher acl Safe_ports port 210 # wais acl Safe_ports port 1025-65535 # unregistered ports acl Safe_ports port 280 # http-mgmt acl Safe_ports port 488 # gss-http acl Safe_ports port 591 # filemaker acl Safe_ports port 777 # multiling http acl CONNECT method CONNECT http_access allow manager localhost http_access deny manager http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow localnet http_access allow localhost http_access allow lan http_access deny all # -   http_port 3128 transparent hierarchy_stoplist cgi-bin ? coredump_dir /var/spool/squid refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\?) 0 0% 0 refresh_pattern . 0 20% 4320 # -  squid    forwarded_for off request_header_access From deny all request_header_access Server deny all request_header_access Link deny all request_header_access X-Forwarded-For deny all request_header_access Via deny all request_header_access Cache-Control deny all visible_hostname myhost.com</span></span></code> </pre><br><br><h5>  Step Eight, install sarg </h5><br><pre> <code class="bash hljs">yum -y install sarg</code> </pre><br>  Since the settings are not important in our local network, the standard ones are quite suitable, the only thing needed was to specify the folder where to save the logs, we edit the configuration file to this state: <br><pre> <code class="bash hljs">mcedit /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/sarg.conf</code> </pre><br><pre> <code class="bash hljs">output_dir /var/www/sarg/public_html/sarg.loc</code> </pre><br>  It is desirable to add SARG to kroons, so that he would keep statistics every day.  Log generation is performed by running the command: <br><pre> <code class="bash hljs">sarg</code> </pre><br><br><h5>  Step Nine, HTB Setup </h5><br><pre> <code class="bash hljs">wget -O /etc/init.d/htb wget http://downloads.sourceforge.net/project/htbinit/HTB.init/0.8.5/htb.init-v0.8.5?use_mirror=citylan</code> </pre><br>  Shaper settings depend on your needs.  In our case, the initial data were: <br>  Channel width: 6Mbit / sec <br>  Users: 5 <br>  Note: Users rarely download, often "surf" on the Internet. <br><br>  Create files: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/sysconfig/htb touch eth1 touch eth1-2.root touch eth1-2:06.astraPC1 touch eth1-2:07.astraPC2 touch eth1-2:08.astraPC3 touch eth1-2:09.astraPC4 touch eth1-2:10.astraPC5</code> </pre><br><br>  eth1 - The root file of our interface <br>  # - Shaper accuracy <br><pre> <code class="bash hljs">R2Q=20 DEFAULT=0</code> </pre><br><br>  eth1-2.root - Set the rules for the whole chain <br><pre> <code class="bash hljs">RATE=6Mbit CEIL=6Mbit</code> </pre><br><br>  eth1-2: 06.astraPC1 - File for the machine, for convenience, the file extension is the host computer, and the prefix is ‚Äã‚Äãthe last octet of the ip <br><pre> <code class="bash hljs">BURST=100kb RATE=1024Kbit CEIL=3064Kbit LEAF=sfq PRIO=1 RULE=192.168.5.6</code> </pre><br><br>  The remaining files are made by analogy. </div><p>Source: <a href="https://habr.com/ru/post/205460/">https://habr.com/ru/post/205460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205450/index.html">Axure Interactive Prototype in 20 Minutes</a></li>
<li><a href="../205452/index.html">20 years DOOM</a></li>
<li><a href="../205454/index.html">Data replication. Attunity Replicate and Greenplum</a></li>
<li><a href="../205456/index.html">How to make friends with the Yandex API and AJAX captcha</a></li>
<li><a href="../205458/index.html">Installing XenServer 6.2 in Hetzner</a></li>
<li><a href="../205462/index.html">Reading Mettler Toledo PS60 Scale Data</a></li>
<li><a href="../205464/index.html">Working with Group Policy Preferences: Interacting with Local Accounts</a></li>
<li><a href="../205466/index.html">Development of Windows 8.1 applications on XAML / –° #. Part 3. Toolbars</a></li>
<li><a href="../205472/index.html">turbofilm.tv blocked</a></li>
<li><a href="../205476/index.html">Rake using common .dll</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>