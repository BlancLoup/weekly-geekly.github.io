<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Twitter-based bot Markov and phrases from the series</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I looked through the forums looking for questions that python programmers ask during interviews and came across one very wonderful one. I will quote h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Twitter-based bot Markov and phrases from the series</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/16b/af8/108/16baf8108e04478895e3b4af429b2c9b.jpg"><br><br>  I looked through the forums looking for questions that python programmers ask during interviews and came across one very wonderful one.  I will quote him at ease: "They asked to write a generator of nonsense based on an n-th Markov chain."  ‚ÄúBut I don‚Äôt have such a generator yet!‚Äù Shouted my inner voice, ‚ÄúHurry up and open the sublime and write!‚Äù He continued insistently.  Well, I had to obey. <br><br>  And here I will tell you how I did it. <br><a name="habracut"></a><br>  It was immediately decided that the generator would put all its thoughts on Twitter and its website.  I chose Flask and PostgreSQL as the main technologies.  They will communicate with each other through SQLAlchemy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Structure. </h3><br>  So.  The models look like this: <br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Srt</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> id = db.Column(db.Integer, primary_key = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) set_of_words = db.Column(db.Text()) list_of_words = db.Column(db.Text()) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpperWords</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> word = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">40</span></span>), index = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, primary_key = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.word <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phrases</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> id = db.Column(db.Integer, primary_key = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) created = db.Column(db.DateTime, default=datetime.datetime.now) phrase = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">140</span></span>), index = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str(self.phrase)</code> </pre> <br>  As the source code, it was decided to take the subtitles from popular TV shows.  The Srt class stores an ordered set of all words from revised subtitles to a single episode and a unique set of the same words (without repetition).  So it will be easier for bot to search for a phrase in specific subtitles.  First, he will check if the set of words is contained in the set of words of the subtitles, and then see if they are there in the right order. <br><br>  The first word of a phrase is a random word that starts with a capital letter.  UpperWords serves to store these words.  Words are recorded there as well without repetition. <br><br>  Well, the Phrases class is needed to store already generated tweets. <br>  The structure is desperately simple. <br><br>  The subtitle parser format .srt displayed in a separate module add_srt.py.  There is nothing extraordinary, but if anyone is interested, all the source code is on <a href="https://github.com/tenoclock/series_nerd/">GitHub</a> . <br><br><h3>  Generator. </h3><br>  First you need to select the first word for tweet.  As mentioned earlier, this will be any word from the UpperWords model.  His choice is implemented in the function: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_word</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(word_list, n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> word_list: word = db.session.query(models.UpperWords).order_by(func.random()).first().word <span class="hljs-comment"><span class="hljs-comment">#postgre elif len(word_list) &lt;= n: word = get_word(word_list, len(word_list)) else: word = get_word(word_list, n) if word: word_list.append(word) return True else: return False</span></span></code> </pre><br>  The choice of this word is implemented directly by the line: <br><br>  word = db.session.query (models.UpperWords) .order_by (func.random ()). first (). word <br><br>  If you use MySQL, then you need to use func.rand () instead of func.random ().  This is the only difference in this implementation, everything else will work completely identical. <br><br>  If the first word already exists, the function looks at the chain length, and depending on this, selects with how many words in the text you need to compare our list (chain of the n-th order) and get the next word. <br><br>  And we get the next word in the get_word function: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_word</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(word_list, n)</span></span></span><span class="hljs-function">:</span></span> queries = models.Srt.query.all() query_list = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> queries: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> set(word_list) &lt;= set(query.set_of_words.split()): query_list.append(query.list_of_words.split()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> query_list: text = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> lst <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query_list: text.extend(lst) indexies = [i+n <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(text[:-n]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> text[i:i+n] == word_list[len(word_list)-n:]] word = text[random.choice(indexies)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> word <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  First of all, the script runs over all loaded subtitles and checks whether our set of words is included in the set of words of specific subtitles.  Then the texts of the screened subtitles are added to one list and the whole phrase is searched for in it and the positions of the words following these phrases are returned.  Everything ends with a blind choice (random) of the word.  Just like in life. <br>  So words are added to the list.  The very same tweet is going to function: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_twit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> word_list = list() n = N <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> len(<span class="hljs-string"><span class="hljs-string">' '</span></span>.join(word_list))&lt;<span class="hljs-number"><span class="hljs-number">140</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> add_word(word_list, n): <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(<span class="hljs-string"><span class="hljs-string">' '</span></span>.join(word_list))&gt;<span class="hljs-number"><span class="hljs-number">140</span></span>: word_list.pop() <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> word_list[<span class="hljs-number"><span class="hljs-number">-1</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'.?!'</span></span>: word_list.pop() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>.join(word_list)</code> </pre><br>  It's very simple - it is necessary that the tweet does not exceed 140 characters and ends with a punctuation mark ending the sentence.  Everything.  The generator has done its job. <br><br><h3>  Display on the site. </h3><br>  Display on the site involved in the module views.py. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/') def index(): return render_template("main/index.html")</span></span></code> </pre><br>  Just displays the template.  All tweets will be pulled from it using js. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/page') def page(): page = int(request.args.get('page')) diff = int(request.args.get('difference')) limit = 20 phrases = models.Phrases.query.order_by(-models.Phrases.id).all() pages = math.ceil(len(phrases)/float(limit)) count = len(phrases) phrases = phrases[page*limit+diff:(page+1)*limit+diff] return json.dumps({'phrases':phrases, 'pages':pages, 'count':count}, cls=controllers.AlchemyEncoder)</span></span></code> </pre><br>  Returns tweets of a specific page.  It is necessary for the endless scrolling.  Everything is pretty ordinary.  diff is the number of tweets added after the site has been uploaded with an update.  For this amount you need to shift the selection of tweets for the page. <br><br>  And directly update itself: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/update') def update(): last_count = int(request.args.get('count')) phrases = models.Phrases.query.order_by(-models.Phrases.id).all() count = len(phrases) if count &gt; last_count: phrases = phrases[:count-last_count] return json.dumps({'phrases':phrases, 'count':count}, cls=controllers.AlchemyEncoder) else: return json.dumps({'count':count})</span></span></code> </pre><br>  On the client side, it is called every n seconds and uploads newly added tweets in real time.  This is how the display of our tweet works.  (If someone is interested, you can look at the AlchemyEncoder class in controllers.py, using it to serialize tweets received from SQLAlchemy) <br><br><h3>  Adding tweets to the database and posting to Twitter. </h3><br>  For posting on Twitter, I used tweepy.  Very handy battery, start up immediately. <br><br>  What it looks like: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">twit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> phrase = get_twit() twited = models.Phrases(phrase=phrase) db.session.add(twited) db.session.commit() auth = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET) auth.set_access_token(ACCESS_TOKEN, ACCESS_TOKEN_SECRET) api = tweepy.API(auth) api.update_status(status=phrase)</code> </pre><br>  I called this function in cron.py at the root of the project, and, as you might guess, it runs on cron.  Every half an hour a new tweet is added to the database and Twitter. <br><img src="//habrastorage.org/files/4d1/9a3/84f/4d19a384f2934c7eb37ad18b90ed9842.png"><br>  <i>It all worked!</i> <br><br><h3>  Finally. </h3><br>  At the moment I have loaded all the subtitles for the series ‚ÄúFriends‚Äù and ‚ÄúThe Big Bang Theory‚Äù.  The degree of the Markov chain has so far chosen equal to two (with an increase in the base of the subtitles, the degree will increase).  How it works can be viewed on <a href="https://twitter.com/series_nerd">Twitter</a> , and all the sources are available and lie on the <a href="https://github.com/tenoclock/series_nerd">githaba</a> .  Intentionally not posting a link to the site itself.  If someone needs her, he will definitely get her. <br><br>  Thank you all for your attention.  See you again! </div><p>Source: <a href="https://habr.com/ru/post/249637/">https://habr.com/ru/post/249637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249627/index.html">We convert what3words addresses to other spatial coordinates using TWCC</a></li>
<li><a href="../249629/index.html">BemPHP: implementation of the BEM methodology using PHP</a></li>
<li><a href="../249631/index.html">The first development and publication of the game in social networks</a></li>
<li><a href="../249633/index.html">What is CRM-systems and how to choose them correctly?</a></li>
<li><a href="../249635/index.html">Yandex killed service Subscriptions</a></li>
<li><a href="../249639/index.html">KISS - the design principle, containing all other design principles</a></li>
<li><a href="../249641/index.html">Diablo 3 - Resource Bubbles</a></li>
<li><a href="../249643/index.html">New Year star with Wi-Fi based on ESP8266</a></li>
<li><a href="../249645/index.html">Kernel .Net (GC, JIT, interop, ...) in Open Source</a></li>
<li><a href="../249647/index.html">Making a queue of incoming calls with the callback function</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>