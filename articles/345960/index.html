<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ICA (state machine) for teapots on the example of the class "button" in the arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why is all this necessary? 


 When a teapot, having rested on the need to move away from a simple sequence of actions, asks a question like ‚Äúhow to d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ICA (state machine) for teapots on the example of the class "button" in the arduino</h1><div class="post__text post__text-html js-mediator-article"><h2 id="zachem-vsyo-eto-nuzhno">  Why is all this necessary? </h2><br><p>  When a teapot, having rested on the need to move away from a simple sequence of actions, asks a question like ‚Äúhow to do this?‚Äù In Habr√©, with a probability of 70%, ‚Äúgoogle finite automata‚Äù and 30% ‚Äúuse finite state machine‚Äù depending on the employer's country professional  The next question is "how?"  sent to google.  There is such a teapot that he just finished blinking with an LED and wiped sweat from his forehead, that he taught German at school and worked all his life as a bulldozer in this Google and sees there <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">Wikipedia articles about finite automata</a> with formulas and in which only prepositions are clear. </p><br><p>  Since I am also a teapot, but before the bulldozer I worked as a programmer 30 years ago, stepping on a lot of rakes as I mastered programming microcontrollers, I decided to write this article in simple language for beginners. </p><a name="habracut"></a><br><p>  So, the task is, for example, to teach an Arduin to understand pressing a button like click, pressing and holding, that is, a short button into a button, long and very long.  Any beginner can do this in the loop () function and be proud of it, but what if there are several buttons?  And if at the same time it is necessary not to interfere with the execution of another code?  I wrote a library <a href="https://github.com/nw-wind/SmartButton">SmartButton</a> for Arduino, then not to return to the topic of buttons.  Here I will write how it works. </p><br><h2 id="chto-nam-meshaet-zhit-i-kak-s-etim-borotsya">  What prevents us from living and how to deal with it? </h2><br><p>  The delay () function prevents us from living, I overcame it with the help of the ICA and wrote my own class <a href="https://github.com/nw-wind/SmartDelay">SmartDelay</a> .  I have already made a new class (SmartDelayMs) generated from SmartDelay, everything is the same there, but in milliseconds.  In this article, I do not use this library, just bragging. </p><br><p>  In order not to bore the reader again with a story about how to use the delay () function badly and how to live without it, I recommend reading my old article <a href="https://habrahabr.ru/post/319184/">Replacing delay () for non-blocking delays in the Arduino IDE first</a> .  I will repeat the main points here a little more here as I write the code. </p><br><h2 id="nemnogo-teorii">  Some theory </h2><br><p>  One way or another, but you have <strong>objects</strong> .  You can call them buttons, displays, LED strips, robots and a water level meter in the tank.  If your code is executed not in one thread sequentially, but for some events, you keep the <strong>state of the</strong> objects.  You can call it whatever you like, but that's a fact.  For a button, there are, for example, "pressed" and "released" states.  For a robot, for example: standing, going straight, turning.  The number of these states of course.  Well, in our case, yes.  Add states "click", "click" and "hold".  Already five states that we need to distinguish.  Moreover, we are interested in only the last three.  These five states live button.  In the terrible external world, events occur that do not depend on the button in general: poking a finger at it, releasing it, holding it for a different time, and so on.  Let's call them an <strong>event</strong> . </p><br><p>  So, we have <strong>an object</strong> "button" which has a finite number of <strong>states</strong> and <strong>events</strong> affect it.  This is the <strong>state machine</strong> ( <abbr title="State Machine">SC</abbr> ).  In CA theory, the list of possible events is called a dictionary, and events are words.  I wildly apologize, I passed this 30 years ago and do not remember the terminology very well.  You don't need terminology, do you? </p><br><p>  In this article we will write a wonderful code that will translate our spacecraft from state to state depending on the events.  It is the actual <strong>machine of finite automata</strong> ( <abbr title="End Machine Machine">ICA</abbr> ). </p><br><p>  It is not necessary to push all your device into one huge spacecraft, it can be divided into separate objects, each of which is serviced by its own ICA and is even located in a separate code file.  You can put many of your objects on <a href="http://github.com/">GitHub</a> in the form of ready-made arduin libraries and use them later without delving into their implementation. </p><br><p>  If your code does not require portability and reuse, you can sculpt everything into one large file, which is what beginners do. </p><br><h2 id="praktika">  Practice </h2><br><p>  The basis for the design of the ICA is the table. </p><br><ul><li>  Horizontally we write all possible events. </li><li>  Vertically all states. </li><li>  In action cells.  Transition to a new state is also an action. </li></ul><br><p>  For a button, it will look like this: </p><br><table><thead><tr><th>  State \ Event </th><th>  Pressed </th><th>  Released </th><th>  Pressed 20ms </th><th>  250ms pressed </th><th>  Pressed 1s </th><th>  Pressed 3s </th></tr></thead><tbody><tr><td>  Not pressed </td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>  Clicked </td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>  Pressed </td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>  Retained </td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>  Held too long </td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><br><p>  Why so hard?  It is necessary to describe all possible states and take into account all possible events. </p><br><p>  Developments: </p><br><ul><li>  Pressed - this is when we find that the contact is closed. </li><li>  Released - this is when it became clear that the contact is open. </li><li>  Pressed 20ms - it is necessary to take into account contact bounce and ignore the opening for some time, then it is already considered that click. </li><li>  Pressed 250ms - enough to click 250ms, all that is longer - this is pressing. </li><li>  Pressed 1c - more than 1c is already holding. </li><li>  pressed 3c - hold more than 3c is considered an error. </li></ul><br><p>  You can set your time as you like.  In order not to change the numbers in different places, it is better to immediately replace them with letters :) </p><br><pre><code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SmartButton_debounce 20 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SmartButton_hold 250 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SmartButton_long 1000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SmartButton_idle 3000</span></span></code> </pre> <br><p>  States: </p><br><ul><li>  Not pressed - we report that no one touched the button. </li><li>  Bounce - We are waiting for the end of contact bounce. </li><li>  Clicked - was click. </li><li>  Pressed - clicked. </li><li>  Hold - the button is pressed and held. </li><li>  For too long held down - something went wrong, I suggest to refuse to press in this case. </li></ul><br><p>  So, we translate Russian into C ++ </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     byte btPin; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  enum event {Press, Release, WaitDebounce, WaitHold, WaitLongHold, WaitIdle}; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  enum state {Idle, PreClick, Click, Hold, LongHold, ForcedIdle}; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   enum state btState = Idle; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     unsigned long pressTimeStamp;</span></span></code> </pre> <br><p>  I‚Äôll draw your attention to the fact that both events and states are not specified as an integer variable of the type byte or int, but as enum.  Such a record is not so loved by professionals as it does not save bits so expensive in memory microcontrollers, but, on the other hand, it is very visual.  When using enum, we do not care how much each code is encoded, we use words, not numbers. </p><br><div class="spoiler">  <b class="spoiler_title">How to decipher enum?</b> <div class="spoiler_text"><p>  enum Name {Constant, Constant, Constant}; <br>  So we create <strong>the data type</strong> enum Name, which has a set of fixed values ‚Äã‚Äãfrom those in curly braces.  Actually, of course, this is a numeric integer type, but the value of the constants is numbered automatically. <br>  You can also specify the values ‚Äã‚Äãmanually: <br>  enum Name {ConstantA = 0, ConstantB = 25}; </p><br><p>  To declare a variable of this type, you can write: <br>  enum Name Variable; </p><br><p>  In the example with the button: </p><br><ul><li>  enum event myEvent; </li><li>  enum state currentState; </li></ul></div></div><br><p>  Let's fill the table already.  The icon -&gt; I denote the transition to a new state. </p><br><table><thead><tr><th>  State \ Event </th><th>  Pressed </th><th>  Released </th><th>  Pressed 20ms </th><th>  250ms pressed </th><th>  Pressed 1s </th><th>  Pressed 3s </th></tr></thead><tbody><tr><td>  Not pressed </td><td>  -&gt; Bounce </td><td>  -&gt; Not Pressed </td><td></td><td></td><td></td><td></td></tr><tr><td>  Bounce </td><td></td><td>  -&gt; Not Pressed </td><td>  -&gt; Clicked </td><td></td><td></td><td></td></tr><tr><td>  Clicked </td><td></td><td>  -&gt; Not Pressed </td><td></td><td>  -&gt; Pressed </td><td></td><td></td></tr><tr><td>  Pressed </td><td></td><td>  -&gt; Not Pressed </td><td></td><td></td><td>  -&gt; Retained </td><td></td></tr><tr><td>  Retained </td><td></td><td>  -&gt; Not Pressed </td><td></td><td></td><td></td><td>  -&gt; Too long withheld </td></tr><tr><td>  Held too long </td><td></td><td>  -&gt; Not Pressed </td><td></td><td></td><td></td><td></td></tr></tbody></table><br><p>  To implement the table, we will make the function void doEvent (enum event e).  This function receives the event and performs the action as described in the table. </p><br><h2 id="otkuda-berutsya-sobytiya">  Where do events come from? </h2><br><p>  It is time to briefly leave our cozy button and plunge into the terrible external world of the loop () function. </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { //     unsigned long mls = millis(); //   //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(btPin)) doEvent(Press) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> doEvent(<span class="hljs-keyword"><span class="hljs-keyword">Release</span></span>) //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_debounce) doEvent(WaitDebounce); //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_hold) doEvent(WaitHold); //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_long) doEvent(WaitLongHold); //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_idle) doEvent(WaitIdle); }</code> </pre> <br><p>  So, having an event generator at hand, you can start implementing the ICA. </p><br><p>  In fact, events can be generated not only by raising the signal level at the controller's foot and by time.  Events can be transferred from one object to another.  For example, you want to press one button automatically to "release" another.  To do this, just call its doEvent () with the Release parameter.  ICA is not only buttons.  Exceeding the temperature threshold is an event for the ICA and causes the fan to turn on in the greenhouse, for example.  The fan fault sensor changes the state of the greenhouse to "emergency" and so on. </p><br><h2 id="tri-podhoda-k-realizacii-tablicy-v-kod">  Three approaches to the implementation of the table in the code </h2><br><h3 id="plan-a-if--elsif--else-">  Plan A: if {} elsif {} else {} </h3><br><p>  This is the first thing that comes to mind beginner.  In fact, this is a good option if there are very few cells in the table and actions are reduced only to a change of states. </p><br><pre> <code class="hljs ruby">void doAction(enum event e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e == Press &amp;&amp; btState == Idle) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       btState=PreClick; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      pressTimeStamp=millis(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e == Release) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   btState=Idle; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e == WaitDebounce &amp;&amp; btState == PreClick) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    btState=Click; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,    } /<span class="hljs-regexp"><span class="hljs-regexp">/          }</span></span></code> </pre> <br><p>  Pros: </p><br><ul><li>  Just write to a newbie, who took the Arduin in his hands for the first time. </li><li>  The first thing that comes to mind. </li></ul><br><p>  Minuses: </p><br><ul><li>  Difficult to read code. </li><li>  It is difficult to modify the code if something has changed in the table. </li><li>  Hell, if most of the cells in the table are full. </li></ul><br><h3 id="plan-b-tablica-ukazateley-na-funkcii">  Plan-B: Table of function pointers </h3><br><p>  The other extreme is a table of transitions or functions.  I wrote about this approach in the article <a href="https://habrahabr.ru/post/319180/">Processing keystrokes for Arduino.</a>  <a href="https://habrahabr.ru/post/319180/">Cross OOP and ICA.</a>  .  In a nutshell, you create a separate function for each <strong>different</strong> table cell and make a table of pointers to them. </p><br><pre> <code class="hljs markdown">//  ,   typedef void (<span class="hljs-emphasis"><span class="hljs-emphasis">*MKA)(enum event e); //   MKA action[6][6]={ {&amp;toDebounce,$toIdle,NULL,NULL,NULL,NULL}, {NULL,&amp;toIdle,&amp;toClick,NULL,NULL,NULL}, {NULL,&amp;toIdle,NULL,&amp;toHold,NULL,NULL}, {NULL,&amp;toIdle,NULL,NULL,&amp;toLongHold,NULL}, {NULL,&amp;toIdle,NULL,NULL,NULL,&amp;toVeryLongHold}, {NULL,&amp;toIdle,NULL,NULL,NULL,NULL} }; //  doEvent    void doEvent(enum event e) { if (action[btState][e] == NULL) return; (*</span></span>(action[<span class="hljs-string"><span class="hljs-string">btState</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">e</span></span>]))(e); } //     //   " " void toIdle(enum event e) { btState=Idle; } //     void toDebounce(enum event e) { btState=PreClick; pressTimeStamp=millis(); } //   </code> </pre> <br><div class="spoiler">  <b class="spoiler_title">What are the weird words and badges used here?</b> <div class="spoiler_text"><p>  typedef allows you to define your data type and is often convenient to use.  For example, the enum event can be defined as: </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> event BottonEvent;</code> </pre> <br><p>  In the program after that you can write: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">BottonEvent</span></span> myEvent;</code> </pre> <br><p>  I have defined a pointer to a function that takes a single argument of type enum event and returns nothing: </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*<span class="hljs-built_in"><span class="hljs-built_in">MKA</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> event e);</code> </pre> <br><p>  So I made a new data type MKA. </p><br><p>  The &amp; icon is translated into Russian as an "address" or "pointer."  Thus, MKA is not a function value, but a pointer to it. </p><br><pre> <code class="hljs markdown">MKA action[<span class="hljs-string"><span class="hljs-string">6</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">6</span></span>]; //   action   </code> </pre> <br><p>  I immediately filled it with pointers to functions that perform actions.  If there is no action, I put the "pointer to nowhere" NULL. </p><br><p>  The doEvent function checks the pointer from the table in the coordinates "current state" x "incident event" and if there is a pointer to the function for this, calls it with the "event" parameter. </p><br><pre> <code class="hljs markdown"> if (action[<span class="hljs-string"><span class="hljs-string">btState</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">e</span></span>] == NULL) return; //    -  (*(action[<span class="hljs-string"><span class="hljs-string">btState</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">e</span></span>]))(e); //      </code> </pre> <br><p>  For more information about pointers and address arithmetic in the C language, you can google it in books like "C language for teapots". </p></div></div><br><p>  Pros: </p><br><ul><li>  Very readable code.  Do not laugh.  It is enough to once taste the arrays with pointers and you will get a simple beautiful code.  You have a plate as a plate, the cells are painted separately - beauty. </li><li>  Easy to write. </li><li>  It is very easy to modify the logic. </li></ul><br><p>  Minuses: </p><br><ul><li>  Eating memory.  Each pointer is two to four bytes.  6x6 = 36 cells occupy from 72 to 144 bytes of memory and this is on each button, and if there are, say, four?  Let me remind you that you have only 2048 bytes of memory for the popular arduin chips. </li></ul><br><p>  The minus turned out to be so bold that I after writing the <a href="https://habrahabr.ru/post/319180/">Processing of button presses for the Arduino.</a>  <a href="https://habrahabr.ru/post/319180/">Cross OOP and ICA.</a>  And the very first application of the code in the case I saw it all nafig.  In the end, I came to the golden mean "switch {switch {}}". </p><br><h3 id="plan-v-zolotaya-seredina-ili-switch--switch-">  Plan-In: Golden mean or switch {switch {}} </h3><br><p>  The most common, medium variant is the use of nested switch statements.  For each event as a case of the switch statement, you must write a switch with the current state.  It turns out long, but more or less clear. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span><span class="hljs-function"><span class="hljs-params"> e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Press: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (btState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Idle: btState=PreClick; pressTimeStamp=millis(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Release: btState=Idle; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ...   ... } }</span></span></code> </pre> <br><p>  A smart compiler will still build a transition table, as described in Plan B above, but this table will be in flash, in code, and will not occupy the memory of variables so dear to us. </p><br><p>  Pros: </p><br><ul><li>  Quick code. </li><li>  Memory is saved. </li><li>  The logic is clear.  You can read. </li><li>  Easy to change logic. </li></ul><br><p>  Minuses: </p><br><ul><li>  Pullladder in several screens with a large number of states and events, which is difficult to cut into separate files. </li></ul><br><p>  In fact, you can use Plan-B and Plan-A, that is, switch by event, but if inside by state.  For my taste, switch and for that and for that it is clearer and more convenient, if you need to change something later. </p><br><h2 id="kuda-vstavlyat-moy-kod-kotoryy-zavisit-ot-nazhatiy-knopki">  Where to insert my code, which depends on the button presses? </h2><br><p>  In the tablet, we did not take into account the presence of other ICAs focusing on our button event handler.  In practice, it is required not only to rejoice at the fact that the button works, but also to perform other actions. </p><br><p>  We have two important places to insert good code: </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Release: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(btState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Click: <span class="hljs-comment"><span class="hljs-comment">//       .    . break;</span></span></code> </pre> <br><pre> <code class="hljs ruby"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-symbol"><span class="hljs-symbol">WaitDebounce:</span></span> switch (st) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-symbol"><span class="hljs-symbol">PreClick:</span></span> btState=Click; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .           <span class="hljs-string"><span class="hljs-string">""</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre> <br><p>  It is best not to spoil the beauty, write your own functions like offClick () and onClick (), in which these events will be processed, it is possible that they will transfer it to another ICA: D </p><br><p>  I wrapped all the logic of the ICA button in the <a href="https://github.com/nw-wind/SmartButton">class C ++</a> .  This is convenient, since it does not distract from writing the main code, all the buttons work independently, I don‚Äôt need to reinvent the heap variable names.  Only this is a completely different story and I can write how to arrange your ICA into classes and make libraries for Arduino out of them.  Write in the comments wishes. </p><br><h2 id="chto-v-itoge">  What is the result? </h2><br><p>  As a result, in theory, after reading this article, there should be a desire to replace in your favorite arduin sketch your unreadable buggy shit code with a beautiful structured one and using ICA. </p><br><p>  Please note that in the loop () function, which in our case only generates events, there is not a single delay.  Thus, after the above code, you can write something else: generate events for other ICA, execute some other code that does not contain delay (); </p><br><p>  I really hope that this article has helped you understand what ICA is and how to implement them in your sketch. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345960/">https://habr.com/ru/post/345960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345948/index.html">Enterprise Architecture vs alchemy enterprises. Part 2. Nowhere is easier: simple framework and simple enterprise.</a></li>
<li><a href="../345950/index.html">Welcome to the era of deep neuroevolution</a></li>
<li><a href="../345954/index.html">Simplify the work with RecyclerView</a></li>
<li><a href="../345956/index.html">History 3 places Russian AI Cup 2017</a></li>
<li><a href="../345958/index.html">How I wrote the game in 6 days</a></li>
<li><a href="../345962/index.html">Coding with the withdrawal of information. Part 2, Mathematical</a></li>
<li><a href="../345964/index.html">On the question of the principles of asynchronous solutions</a></li>
<li><a href="../345968/index.html">System for collecting, analyzing, notifying and visualizing logs on syslog-ng, elasticsearch, kibana, grafana, elasticalert</a></li>
<li><a href="../345972/index.html">TAU for the smallest: an example of the implementation of the PID controller in Unity3D</a></li>
<li><a href="../345974/index.html">Akumuli - time series database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>