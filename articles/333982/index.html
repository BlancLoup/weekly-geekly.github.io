<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hummingbirds for Phantom</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Summary: development of the Kolibri OS Compatibility Module inside the Unix OS Compatibility Module (Phantom OS) 

 Inside the OS Phantom there is a l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hummingbirds for Phantom</h1><div class="post__text post__text-html js-mediator-article">  Summary: development of the Kolibri OS Compatibility Module inside the Unix OS Compatibility Module (Phantom OS) <br><br>  Inside the OS Phantom there is a little simple Unix.  POSIX subsystem.  In principle, the Phantom itself is optional and rather incomplete - Unix Quake was able to be built under it, and, for example, the Apache will not gather almost certainly.  Nevertheless - it is. <br><br>  To continue, you need to understand what a Colibri OS is.  Hummingbirds are a Russified western project of micro-OSes on an assembler.  Actually, this description is quite complete.  Fans of programming on the x86 assembler are working on Hummingbirds. It is, therefore, intolerable and, unfortunately, very poorly designed.  Very - it is disastrous.  To understand the scale of a disaster, there is no general mechanism for determining the success or failure of a system call.  For some, it is simply impossible to determine non-success, some calls return their own set of error codes, some - some other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why is it nevertheless curious to implement a compatibility layer with this OS?  There are several reasons for this: <br><br><ul><li>  It is very compact.  Looking ahead - the first program for the Hummingbird in the Phantom was able to start after four hours of work. </li><li>  This mini-project has become a driver for the development of some native subsystems of the Phantom, <br>  in particular - window. </li><li>  The main thing - the entire state of the Hummingbird process, known to the core, fits into a small structure.  Many (almost all!) Challenges are stateless, that is, they do not rely on any knowledge <br>  stored in the kernel.  This is an ideal candidate for implementing persistent (undergoing OS restart) binary (not written in bytecode-language) processes in Phantom. </li></ul><a name="habracut"></a><br>  For the curious, <a href="">code</a> , <a href="">heder</a> . <br><br>  Actually, the development of the compatibility layer is divided into several obvious parts: <br><br><ul><li>  Executable image loader </li><li>  System Call Entry Point </li><li>  "Gaskets" for system calls, converting them into the semantics of existing components of the system </li><li>  Development of missing functionality </li></ul><br>  The Hummingbird Image Downloader is trivial, except for the implementation of running packed programs.  Unfortunately, the implementation of unpacking on the available fragmentary specimens did not lead to success, and it was not possible to find someone who understands.  Unpacked programs are very simple, so that the detection and loading of the image complemented the existing elf loader without problems.  By the way, under the Phantom of the program for the Hummingbird you can compile the usual elf-ovsky toolchain - regardless of which bootloader downloaded the program, it can refer to both the POSIX system calls and the Hummingbird.  Can be mixed) <br><br>  The entry point also does not represent anything unexpected - calls are made via a software interrupt, the usual IDT gate and a <a href="">small assembler springboard</a> solve the problem. <br><br>  The main work, of course, is the implementation of system calls.  The work is laborious for two reasons - firstly, the calls are schematically documented, and secondly, their creators really did not bother themselves with any consistency.  For example, calling the process information request in one of the fields returns ... the number of <i>another</i> process whose window is located at a given z-position on the screen. <br><br>  Call implementation was made according to the ‚ÄúTDD type‚Äù principle: instead of implementing a system call, we simply write an error to the log, launch application programs, if an unimplemented system call is called, implement what was caused.  So if the call is not made, then I did not reach the application program that needs it. <br><br>  In general, calls are divided into several groups. <br><br><h4>  Informational </h4><br>  Everything is simple with them.  Also because some of the information can be given in constant or fake form.  A good example is <code>st-&gt;eax = dummy++; // TODO n of context switches</code>  <code>st-&gt;eax = dummy++; // TODO n of context switches</code> - increases, and it is fine.  Where possible, of course, the information is given real. <br><br><h4>  Low-level </h4><br>  The hummingbird is a system with almost no protection, the process can be very much, including modifying the processor registers, which are usually available only to the kernel.  Most of these calls, of course, are simply not implemented. <br><br><h4>  File operations </h4><br>  The Hummingbird file operations are more or less consistent (at least, the error codes are the same), but their implementation is very expensive - they all store almost no state in the kernel and, de facto, are reduced to the open / do / close group.  That is, reading from the file for each call performs the opening and closing of the file.  In principle, you can try to optimize it through the hash map of the file name and keep the pool of open descriptors, but this is not included in the weekend project skoup.  I did not do it.  Otherwise, the implementation is more or less trivial. <br><br><h4>  Graphics </h4><br>  Here I expected problems.  They were, but mostly not as creepy as they could have happened.  However, there is a feeling that the presentation of the authors of the Hummingbird graphics subsystem to the end I still did not comprehend - some programs work fine, some - strange.  Alas, without actually reading the source code of the original implementation, probably progress is impossible here, and the source code, I remind you, is in assembly language.  I didn‚Äôt find enough courage in myself, and I stopped at the fact that some subset of programs was working fine. <br><br>  The main difference between Hummingbird graphics is that the core implements some of the traditionally applied components of a window ‚Äî in particular, buttons.  There was no ready mate in the window system of the Phantom, I had to write.  Obviously, the Hummingbird application code is rigidly tied to specific fonts used in the kernel - the fonts had to be extracted and converted into the format of the Phantom window subsystem, plus a few modifications to the font rendering code.  There were other little things, in general, insignificant. <br><br><h4>  Implemented but not tested </h4><br>  Hummingbird supports simple IPC mechanism - mailboxes.  It is implemented schematically, but not subjected to detailed testing.  The launch of additional threads of the process is also implemented - also without serious testing.  By the way, it is not quite clear which part of the state of the kernel should relate to the process, and which part to the thread. <br><br><h4>  Missing </h4><br>  Fully implemented memory mapping control functions ‚Äî currently, the Phantom core only works with one address space (Unix and Colibri processes are supported through the x86 segment addressing mechanism), so there‚Äôs nothing to display them.  Due to this fact, it is difficult (although possible) to implement a change in the size of the address space of the process.  Support for the DLL Colibri DLL itself is not implemented very inactive, and the plan was to make the minimum necessary.  However, this is not difficult. <br><br><h4>  Project development </h4><br>  It is pretty obvious that to continue the work you need: <br><br><ul><li>  A set of regression tests.  Preferably in the form of a) internal unit tests for components; <br>  b) special test application programs; and c) running existing programs with monitoring their performance. </li><li>  Code review by experienced Hummingbird kernel developer for compliance with the original implementation </li><li>  Review of the code on the subject of detailed verification of all entry points of the Humming-Phantom regarding the admissibility and meaningfulness of the parameters. </li></ul><br>  In general, you need a hero from the Kolibri OS team.  I need a hero :) </div><p>Source: <a href="https://habr.com/ru/post/333982/">https://habr.com/ru/post/333982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333970/index.html">Choosing the right HPE Aruba switch for your small or medium business network</a></li>
<li><a href="../333972/index.html">How and why to hide phone numbers</a></li>
<li><a href="../333976/index.html">Come down from heaven: let's just count?</a></li>
<li><a href="../333978/index.html">We attack DHCP</a></li>
<li><a href="../333980/index.html">Take care of your points or how to resist fraud in loyalty programs</a></li>
<li><a href="../333984/index.html">Found new version of the program. Install?</a></li>
<li><a href="../333986/index.html">Why we chose TypeScript: the history of developers from Reddit</a></li>
<li><a href="../333988/index.html">A team of web enthusiasts introduced the P2P browser Beaker</a></li>
<li><a href="../333992/index.html">Optical alignment and user interfaces</a></li>
<li><a href="../333996/index.html">Take out the local server to the network using another external server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>