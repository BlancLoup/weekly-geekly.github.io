<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring and alerting about events in Windows logs: sending to E-mail in Windows Server 2012 R2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, in order to successfully pass an audit for compliance with PCI DSS standards, it was necessary to enable auditing of Windows server e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring and alerting about events in Windows logs: sending to E-mail in Windows Server 2012 R2</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, in order to successfully pass an audit for compliance with PCI DSS standards, it was necessary to enable auditing of Windows server events and, most importantly, to set up sending notifications of critical events to E-mail.  For Linux servers, the issue is solved by installing and configuring <a href="http://habrahabr.ru/post/192800/">OSSEC</a> (well, <b>syslog</b> ws <b>loganalyzer</b> and <b>auditd</b> may also be needed), for Windows Server 2012 R2, and even the Russian version, it did not fit (later we managed to configure it adequately, if it‚Äôs interesting, I can describe as).  So we decided to look for other ways ... <br><br>  The first thing to do is to include an audit of all necessary operations (account management and file integrity control) in the domain policy.  And if everything is simple with the audit of operations on Active Directory objects, then you have to tinker with the audit of file operations.  Here, at an opportune time, the company Netwrix (do not consider it an advertisement, the company is the author of commercial audit software) prepared a wonderful article: <a href="http://habrahabr.ru/company/netwrix/blog/208892/">‚ÄúSetting up an audit of file servers: detailed instructions and a cheat sheet‚Äù</a> (.pdf). <br><br>  But back to our "crutches".  After successful activation of the audit of all the necessary operations and detection of events of interest in the <b>Windows</b> logs, the question arose of sending them to the monitoring server ... It would be logical to use the built-in tools (" <b>Attach Task To This Event</b> " is not the most informative tool, but native for Windows ), but here the first curious and unpleasant moment from Microsoft comes up - <a href="https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f3f2641-963d-4f6d-a77e-3974ebb3bf07/2012rc-task-scheduler-cant-send-email-deprecated">‚ÄúSend an email message and display a message</a> . <a href="https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f3f2641-963d-4f6d-a77e-3974ebb3bf07/2012rc-task-scheduler-cant-send-email-deprecated">‚Äù</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Send an e-mail (deprecated)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/803/9b8/f00/8039b8f00f9b47cda4a958319ee1d507.jpg"></div></div>  ... <br><a name="habracut"></a><br>  According to the recommendations from Microsoft, as a replacement for the built-in ‚Äúdeprecated‚Äù functionality, they decided to use <b>PowerShell</b> scripts to filter the logs and send by E-mail, since there are detailed instructions: <br>  <a href="http://habrahabr.ru/post/147750/">"Active Directory Audit Powershell Change Alert</a> . <a href="http://habrahabr.ru/post/147750/">"</a> <br>  <a href="http://habrahabr.ru/post/150149/">‚ÄúAudit of deleting and accessing files and recording events to a log file using Powershell‚Äù</a> <br>  But then another difficulty arose: the above scripts sent only the headers (themes) of events to the E-mail, the message body was empty :( For all this, if you run the PowerShell script in ISE PowerShell "as Administrator", then the full message comes, as it was intended! <br><br><div class="spoiler">  <b class="spoiler_title">An example of the script to send a notification about the event "Account is blocked" - Event ID 4725:</b> <div class="spoiler_text"><pre><code class="cpp hljs">$time = (get-date) - (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-timespan -min <span class="hljs-number"><span class="hljs-number">60</span></span>) $Subject = ‚Äú <span class="hljs-string"><span class="hljs-string">" $Theme = ‚Äú    ‚Äù $Server = ‚Äúsmtp.server.local‚Äù $From = ‚ÄúAD@domain.local‚Äù $To = ‚Äúsupport@domain.local‚Äù $encoding = [System.Text.Encoding]::UTF8 #      ID. $TimeSpan = new-TimeSpan -sec 1 foreach($event in $events) { $PrevEvent = $Event. $PrevEvent = $PrevEvent - 1 $TimeEvent = $Event.TimeCreated $TimeEventEnd = $TimeEvent+$TimeSpan $TimeEventStart = $TimeEvent- (new-timespan -sec 1) $Body=Get-WinEvent -maxevents 1 -FilterHashtable @{LogName=‚ÄùSecurity‚Äù;ID=4725;StartTime=$TimeEventStart;} | Select TimeCreated,@{n=‚ÄùAccount Name‚Äù;e={([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúTargetUserName‚Äù} |%{$_.'#text'}}},@{n=‚ÄùComputer‚Äù;e={([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúTargetDomainName‚Äù}| %{$_.'#text'}}} $body = $body -replace "</span></span>@{<span class="hljs-string"><span class="hljs-string">" -replace "</span></span>}<span class="hljs-string"><span class="hljs-string">" -replace "</span></span>=<span class="hljs-string"><span class="hljs-string">", "</span></span>: <span class="hljs-string"><span class="hljs-string">" -replace "</span></span>;<span class="hljs-string"><span class="hljs-string">","</span></span>`n<span class="hljs-string"><span class="hljs-string">" -replace "</span></span>TimeCreated<span class="hljs-string"><span class="hljs-string">","</span></span> <span class="hljs-string"><span class="hljs-string">" -replace "</span></span>^<span class="hljs-string"><span class="hljs-string">","</span></span>`n<span class="hljs-string"><span class="hljs-string">" $BodyM = $Body } Send-MailMessage -From $From -To $To -SmtpServer $server -Body ‚Äú$BodyM `n$Theme‚Äù -Subject $Subject -Encoding $encoding</span></span></code> </pre> </div></div><br>  In general, if you have real working scripts for such a case - you are welcome in the comments. <br><br>  We switched to another method (inspired by this article: " <a href="http://winitpro.ru/index.php/2015/04/02/triggery-sobytij-windows/">Monitoring and notifying about events in Windows logs: event triggers</a> " and rescued this utility: <a href="http://caspian.dotconf.net/menu/Software/SendEmail/">sendEmail</a> ): <br><br><ol><li>  Add a task for the event of interest to the <b>Task Scheduler</b> (directly from the " <b>Security</b> " -&gt; " <b>Attach Task To This Event ...</b> " log) <br><br><img src="https://habrastorage.org/files/52e/d1f/168/52ed1f168c334fd48da2ad4eb62b4d9b.jpg"></li><li>  In <b>Actions, we</b> specify the launch of the script, in which we use the <b>wevtutil</b> utility <b>to</b> make a selection from the log and save the result to a file. <br><br><div class="spoiler">  <b class="spoiler_title">script example - event selection with Event ID 4726</b> <div class="spoiler_text"><pre> <code class="cpp hljs">del c:\Audit\query_ID4726.txt wevtutil qe Security /q:<span class="hljs-string"><span class="hljs-string">"*[System[(EventID=4726)]]"</span></span> /f:text /rd:<span class="hljs-literal"><span class="hljs-literal">true</span></span> /c:<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; c:\Audit\query_ID4726.txt</code> </pre><br></div></div><br></li><li>  In the second step, using the sendEmail utility, we send the saved file to the destination: <br><br><div class="spoiler">  <b class="spoiler_title">example arguments for the sendEmail start command:</b> <div class="spoiler_text"><pre> <code class="cpp hljs">-f audit_AD@domain.local -s smtp.domain.local:<span class="hljs-number"><span class="hljs-number">25</span></span> -t support@domain.local -m <span class="hljs-string"><span class="hljs-string">"AD User Account Management - Event ID 426 - Account was Deleted"</span></span> -a C:\Audit\query_ID4726.txt</code> </pre><br></div></div><br><img src="https://habrastorage.org/files/654/cda/adc/654cdaadcac14382bcfef1638b2fc917.jpg"><br></li></ol><br>  As a result, should get something like this: <br><br><img src="https://habrastorage.org/files/8b5/d57/376/8b5d5737611a46c3b9f4e41e28c1d8ba.jpg"><br><br>  PS Thanks to all the authors of the sources mentioned earlier! </div><p>Source: <a href="https://habr.com/ru/post/260947/">https://habr.com/ru/post/260947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260933/index.html">Zombie hunt from the cloud</a></li>
<li><a href="../260935/index.html">How to write a simple solver tsumego</a></li>
<li><a href="../260941/index.html">Google broke GCM in Chrome</a></li>
<li><a href="../260943/index.html">Intel Edison on guard of health. Experience "FRUIT MD"</a></li>
<li><a href="../260945/index.html">What you need to know about working with text preview emails</a></li>
<li><a href="../260949/index.html">Why is programming so hard?</a></li>
<li><a href="../260953/index.html">10 Tips for Using ExecutorService</a></li>
<li><a href="../260955/index.html">Backup with Bareos and Relax-and-Recover</a></li>
<li><a href="../260957/index.html">Who is stronger - an elephant or ... an elephant?</a></li>
<li><a href="../260961/index.html">We write on JS in functional and declarative style</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>