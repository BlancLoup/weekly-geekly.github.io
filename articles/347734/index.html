<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic monitoring of newly installed software in ZABBIX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ZABBIX has an excellent mechanism that allows you to automatically detect and monitor file systems, network interfaces, CPUs, CPU cores and other obje...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic monitoring of newly installed software in ZABBIX</h1><div class="post__text post__text-html js-mediator-article">  ZABBIX has an excellent mechanism that allows you to automatically detect and monitor file systems, network interfaces, CPUs, CPU cores and other objects.  But unfortunately, he can't do the same with the software out of the box. <br><br>  With just a couple of scripts, one of which must be put on the server, and the second scattered across clients, you can do low-level auto-detection of nginx, mongod, rabbitmq, mysql, postgresql and any other service. <br><a name="habracut"></a><br>  Of course, my version of this implementation is not without flaws and most likely the guru will shower me with tomatoes!  I would be extremely grateful to constructive criticism and advice. <br><br><h3>  The course of action, the description of the functional and principle of operation </h3><br>  Hanging on the host template auto detection "Template service auto discovery" in the template or already on the host in the macro "{$ SERVICES}" add a list of services (separated by spaces) that need to be detected and put on monitoring. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">picture with a list in a macro</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gz/h2/hv/gzh2hv1iusanyq8lsjonbvrdips.png"><br></div></div><br>  If the required service is installed and started, for example, ‚Äúnginx‚Äù, then the data element ‚ÄúSERVICE_AUTO_DISCOVERY: detected_and_run_nginx‚Äù appears on the host <br><br><img src="https://habrastorage.org/webt/io/er/ca/ioercaur0doxlwimep17hm2tele.png"><br><br>  and the SERVICE_AUTO_DISCOVERY trigger: trigger_detected_and_run_nginx, <br>  after 30 seconds, the trigger is triggered, and on the triggered trigger, the action is started, <br><br><div class="spoiler">  <b class="spoiler_title">action picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xy/t5/z1/xyt5z1jcnwvjjelrlefo4koyxww.png"><br></div></div><br>  the action is performed by the ‚Äúauto-discovery.py‚Äù script (do not forget to change the login ‚Äúzabbixapi_API_user‚Äù and the password ‚Äúpassword‚Äù to your own) on the zabbix server. <br><br><div class="spoiler">  <b class="spoiler_title">picture describing the operation when the action is triggered</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/zw/ed/qz/zwedqzbhpcv6d7tf44slxe_dtpw.png"><br></div></div><br>  The script in turn through the API-zabbix disables the corresponding trigger and hangs the template required for this service. <br><br><div class="spoiler">  <b class="spoiler_title">Triggered triggers</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tt/lh/ik/ttlhik01uazx8utfzom1nu4chok.png"><br></div></div><br>  It would be possible to directly contact the API directly from the client, but then you have to keep this script on the client.  It is not very safe.  the API password will have to be kept on the host i.  in the script.  By the way, we have zabbix server for NAT. <br><br>  It was decided that we will discover the running software, because there is no point in putting on monitoring what is not working (a lot of alerts, panic, calls, etc.). <br><br><h3>  Summing up: </h3><br>  You can use absolutely any template to monitor any service.  To do this, you need to rename the template by giving it the name of the form: <br>  "Template_ &lt;service name from macro&gt;". <br>  That is, to monitor the mongo database, you must add the mongod to the macro "{$ SERVICES}", and rename the template for the mongo monitoring to Template_mongod. <br><br><div class="spoiler">  <b class="spoiler_title">PS</b> <div class="spoiler_text">  Please pay attention to the underscore in the template name, it is with it that the script searches for a suitable template.  The name of the template and the name of the trigger must be "absolute" the same after "_" otherwise either the template is not thrown or the trigger does not work. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pattern Examples</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fi/3u/4o/fi3u4odhecc_fhdqakbqnpxfn1c.png"><br></div></div><br>  The scripts and templates themselves are on a <a href="https://github.com/viktor-gorinskiy/zabbix">githaba</a> in the autodiscovery folder. <br><br><div class="spoiler">  <b class="spoiler_title">Advanced Host Script Functionality</b> <div class="spoiler_text">  The script on the host was trained to detect systemctl sevises.  Developers in our company often write their services that need to be monitored off / on.  Auto-discovery of these services occurs if the service is "is-enabled". <br>  The macro is called {$ SERVICE}, you can omit the ".service" in the service names, and also list them separated by spaces. <br><br>  Please note that there are no templates here, but a data element and a trigger necessary for monitoring the service are being created. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">A little about debag:</b> <div class="spoiler_text"><h4>  If the service is not detected, i.e.  no triggers are created: </h4><br>  On the host, check how the auto-detection script handles: <br><br><pre><code class="bash hljs">/etc/zabbix/scripts/run_service.sh mongo {<span class="hljs-string"><span class="hljs-string">"data"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"{#SERVICE}"</span></span>:<span class="hljs-string"><span class="hljs-string">"mongo"</span></span>}]}root@bla_bla_bla:/tmp<span class="hljs-comment"><span class="hljs-comment"># _______________________________________________________________________ /etc/zabbix/scripts/run_service.sh mongo nginx supervisor {"data":[{"{#SERVICE}":"mongo"},{"{#SERVICE}":"nginx"},{"{#SERVICE}":"supervisor"}]}root@bla_bla_bla:/tmp# _______________________________________________________________________ /etc/zabbix/scripts/run_service.sh mongodb {"data":[]}root@bla_bla_bla:/tmp#</span></span></code> </pre> <br>  Ie, if the service is not found, the script will return an empty JSON. <br><br><h4>  If the service is found, but the triggers are not disabled: </h4><br>  Most likely the script cannot connect to the zabbix API.  Checking what is happening: <br>  From the side of the zabbix server, run the script and pass two parameters to it?  the first is the name of the host, and the second is the name of the trigger.  The host name as the name of the trigger is taken from the webmord zabbixa, the name of the trigger is taken from the name of the trigger in the host. <br><br><pre> <code class="bash hljs">/usr/bin/python3 /lib/zabbix/externalscripts/api/auto-discovery.py {HOST.NAME} {TRIGGER.NAME}</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Chicken or egg?</b> <div class="spoiler_text">  The next stage I think is to finish the integration with Ansible: <br>  But then the question arises: What should be the first zabbix or ansible? <br>  If zabbix, then erroneous actions in the monitoring system will lead to unnecessary installation of unnecessary software. <br><br>  If the first is ansible, then its integration with zabbix is ‚Äã‚Äãsuperfluous, because zabbix will detect and monitor everything, and throw the scripts and configs necessary for the zabbix-agent during the expansion of the playbook. <br><br>  There is a third option, when throwing a template with auto-detection (in which standard services are listed in the macro) to the host, zabbiz will simultaneously launch a playbook for deploying scripts and configs for zabbix-agent.  But again, if the services are standard then on the host, at least when deploying these standard services, it is necessary to deploy the role for monitoring. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/347734/">https://habr.com/ru/post/347734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347720/index.html">"... They want to know what will happen" or write a fortunetech ball in C # NanoCAD CAD software (MultiCAD .NET API)</a></li>
<li><a href="../347722/index.html">PHP Digest number 124 (January 14 - 28, 2018)</a></li>
<li><a href="../347726/index.html">What is Tokio and Async I / O and why is it needed?</a></li>
<li><a href="../347728/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ299 (January 22 - 28, 2018)</a></li>
<li><a href="../347730/index.html">Elm Developer Tools</a></li>
<li><a href="../347736/index.html">CC1101 running a PIC controller or building a peer-to-peer network for a radio engineer (part 2)</a></li>
<li><a href="../347738/index.html">Mobile devices from the inside. What is GPT?</a></li>
<li><a href="../347740/index.html">Front End Developer Checklist</a></li>
<li><a href="../347744/index.html">How to package a dependent library in obr when developing a plugin for Jira</a></li>
<li><a href="../347746/index.html">Chromium: memory leaks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>