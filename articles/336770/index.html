<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dive into Ethereum development. Part 2: Web3.js and gas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we described the deployment of contracts and interaction with them through the user interface of the Mist wallet, but this is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dive into Ethereum development. Part 2: Web3.js and gas</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/336132/">previous article,</a> we described the deployment of contracts and interaction with them through the user interface of the Mist wallet, but this is not suitable for actual development.  We need a library that will allow you to work with the blockchain from the code of the user application.  In this article we will briefly review what the Web3.js library is like, having felt it from the Geth console.  And one more important topic, which certainly interests not only developers, but also potential customers - how much are transactions on the blockchain, because each of them requires gas, which is bought for broadcasting. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/3a1/c27/eba/3a1c27eba14045b8b83028f232638339.jpg"></div><a name="habracut"></a><br>  We already know how to deploy contracts from Mist.  But Mist is only an application that provides a graphical interface to the main functions.  It works on the Geth client.  Geth is included in the Ethereum protocol's Go implementation.  Go-implementation is not the only one, one of the most common is for example Parity - Rust-implementation.  It is worth noting that in Parity, you can use another test network, Kovan, using Proof-of-Authority ‚Äî the same distribution algorithm for building blocks as Rinkeby (instead of Proof-of-Work in Ropsten).  In addition, Parity does not use Mist, but a wallet on the web interface.  But we will focus on the Go-implementation for now.  Geth is the entry point to the Ethereum network.  To demonstrate his work, we can use the command line provided to them.  The command line interprets plain javascript.  Let's try to access the same contract that we created through Mist in the previous article.  To begin, save the address and interface of the contract in any file, they will be needed later.  Since Mist uses Geth, we close Mist in order not to create conflicts (This does not apply to the Mist Windows implementation, which, as it turned out, requires running Geth to work). <br><br><h2>  "Hello command line!" </h2><br>  Run geth with the console (you can see how to install geth <a href="https://www.ethereum.org/cli">here</a> ): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">$ geth console --testnet 2&gt;&gt;geth.log</code> </pre> <br>  The <code>--testnet</code> flag connects us to the Ropsten test network.  To connect to Rinkeby, use the <code>--rinkeby</code> flag <code>--rinkeby</code> .  Additionally, we redirect messages from the standard stream (stderr) of geth to the geth.log file, otherwise they will be interfered with in the console. <br>  As a result, the team will display a welcome message.  To begin with, let's try to find out the balance of our wallet by the following team (not necessarily ours, any other one, but we have our address: it was displayed in the greeting called coinbase): <br><br><pre> <code class="javascript hljs">&gt; eth.getBalance(eth.coinbase)</code> </pre> <br>  Sample result: <code>22159430784000000000</code> <br><br>  The number is so big because it is displayed not in ether, but in wei - the smallest possible unit of measurement for the amount of ether, it is also used in the code when manipulating the ether.  To display the number in the usual ether, as in the wallet Mist, you can add a conversion: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.getBalance(eth.coinbase) ) <span class="hljs-number"><span class="hljs-number">22.159430784</span></span></code> </pre> <br>  We proceed to the opening of the contract.  Assign the contract address to a variable: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> address = <span class="hljs-string"><span class="hljs-string">"0x65cA73D13a2cc1dB6B92fd04eb4EBE4cEB70c5eC"</span></span>;</code> </pre> <br>  Assign the contract interface to a variable: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> abi = [ { <span class="hljs-string"><span class="hljs-string">"constant"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"inputs"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"newString"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"setString"</span></span>, <span class="hljs-string"><span class="hljs-string">"outputs"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"payable"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"function"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"constant"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"inputs"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"getString"</span></span>, <span class="hljs-string"><span class="hljs-string">"outputs"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"payable"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"function"</span></span> } ];</code> </pre> <br>  Create a contract object: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contract = web3.eth.contract(abi);</code> </pre> <br>  This object can be used to open an existing contract or to deploy a new one.  In this case, we need the first, for this we execute the command: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stringHolder = contract.at(address)</code> </pre> <br>  Each command displays <code>undefined</code> - do not pay attention.  Instead of the address and the interface, substitute your own values, and if you are on the same test network (Ropsten) as we are while creating our example, you can use our contract.  Call the contract functions: <br><br><pre> <code class="javascript hljs">&gt; stringHolder.getString() <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span> &gt; stringHolder.setString(<span class="hljs-string"><span class="hljs-string">"Hello my baby, hello my honey!"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>: invalid address at web3.js:<span class="hljs-number"><span class="hljs-number">3879</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> at web3.js:<span class="hljs-number"><span class="hljs-number">3705</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> at web3.js:<span class="hljs-number"><span class="hljs-number">4948</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span> at map (&lt;native code&gt;) at web3.js:4947:12 at web3.js:4973:18 at web3.js:4998:23 at web3.js:4061:16 at apply (&lt;native code&gt;) at web3.js:4147:16</code> </pre> <br>  We see that the <code>getString</code> method worked correctly, and <code>setString</code> caused an error.  In this case, this error occurs due to the fact that transactions must be carried out from any account that can pay off the air.  Unlock the account with the following command (you will need to enter the password from the private key) and run <code>setString</code> again with an additional option, specifying from which account to perform the transaction: <br><br><pre> <code class="javascript hljs">&gt; web3.personal.unlockAccount(eth.coinbase); Unlock account <span class="hljs-number"><span class="hljs-number">0</span></span>x&lt;  &gt; Passphrase: <span class="hljs-literal"><span class="hljs-literal">true</span></span> &gt; stringHolder.setString(<span class="hljs-string"><span class="hljs-string">"Hello my baby, hello my honey!"</span></span>, {<span class="hljs-attr"><span class="hljs-attr">from</span></span>: eth.coinbase}); <span class="hljs-string"><span class="hljs-string">"0x5f9c3a61c79df36776713f7373b902feea802cf6d3903195f8070ff2d376c669"</span></span></code> </pre> <br>  The transaction number is returned.  By this number you can track the transaction on the website etherscan: <a href="https://ropsten.etherscan.io/">ropsten.etherscan.io</a> for Ropsten and <a href="https://rinkeby.etherscan.io/">rinkeby.etherscan.io</a> for Rinkeby, by entering the transaction number in the search, or by running the command: <br><br><pre> <code class="javascript hljs">&gt; web3.eth.getTransaction(<span class="hljs-string"><span class="hljs-string">"0x5f9c3a61c79df36776713f7373b902feea802cf6d3903195f8070ff2d376c669"</span></span>);</code> </pre> <br>  Do not forget to substitute the number of your transaction instead of ours. <br><br>  See the structure with transaction details.  Now you can run <code>getString</code> and see that the string has changed: <br><br><pre> <code class="javascript hljs">&gt; stringHolder.getString(); <span class="hljs-string"><span class="hljs-string">"Hello my baby, hello my honey!"</span></span></code> </pre> <br><h2>  How gas is consumed </h2><br>  In the <a href="https://habrahabr.ru/post/336132/">last article</a> we already wrote what gas is.  For convenience, we recall: <br><blockquote>  The broadcast is needed for any operations to change data, they are paid for the so-called gas - an abstract unit of measure, which serves to assess the work required to complete the transaction.  It is necessary for the independence of this assessment from the current market value of the air.  When sending a transaction, you can specify how much air you pay for each unit of gas and the maximum amount of gas you are willing to pay.  The more you allocate - the more priority your transaction is for potential miners.  After all, in essence, the payment for gas is the payment for the work of miners to complete your transaction and include it in the next block.  Therefore, when mining, in addition to a fixed fee for the block found - at the time of writing it is 5 airs - the miner also receives payment for transactions, as a rule it is a few hundredths of aired.  The amount of gas per transaction depends on the computational complexity of operations on data. </blockquote><br>  In order to demonstrate how the payment and the gas flow occurs during the execution of the transaction, we will create a new contract.  At the same time, we will use another compilation method and deploy - via the command line. <br><br><h4>  1. Deploy contract for demonstration </h4><br>  Consider the following contract: <br><br><pre> <code class="javascript hljs">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>; contract UselessWorker { int public successfullyExecutedIterations = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int _iterations</span></span></span><span class="hljs-function">) </span></span>{ successfullyExecutedIterations = _iterations; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _iterations; i++) { keccak256(i); } } }</code> </pre> <br>  The contract contains only one <code>doWork</code> function, which takes the number of iterations <code>int _iterations</code> as a parameter, and then counts the <code>keccak256</code> hash from the loop counter.  So we can give a different amount of work and see how the amount of required gas depends on it.  The only variable stored in the contract ‚Äî <code>successfullyExecutedIterations</code> ‚Äî is used to save the number of cycles performed during the last run.  It is needed to demonstrate what happens in case of excess gas flow. <br><br>  Save the contract text to a file UselessWorker.sol.  To compile, we will use the solc compiler, solidity (you can find the installation instructions by <a href="http://solidity.readthedocs.io/en/develop/installing-solidity.html">reference</a> ): <br><br><pre> <code class="bash hljs">$ solc --bin --abi UselessWorker.sol</code> </pre> <br>  Using the <code>--bin</code> and <code>--abi</code> we tell the compiler to generate the binary code and interface. A command is given a response similar to the following: <br><br><pre> <code class="hljs ruby">======= UselessWorker.<span class="hljs-symbol"><span class="hljs-symbol">sol:</span></span>UselessWorker ======= <span class="hljs-symbol"><span class="hljs-symbol">Binary:</span></span> Contract JSON ABI [{<span class="hljs-string"><span class="hljs-string">"constant"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:true</span></span>,<span class="hljs-string"><span class="hljs-string">"inputs"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:[]</span></span>,<span class="hljs-string"><span class="hljs-string">"name"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"successfullyExecutedIterations"</span></span></span></span>,<span class="hljs-string"><span class="hljs-string">"outputs"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span>[{<span class="hljs-string"><span class="hljs-string">"name"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">""</span></span></span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"int256"</span></span></span></span>}],<span class="hljs-string"><span class="hljs-string">"payable"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:false</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"function"</span></span></span></span>},{<span class="hljs-string"><span class="hljs-string">"constant"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:false</span></span>,<span class="hljs-string"><span class="hljs-string">"inputs"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span>[{<span class="hljs-string"><span class="hljs-string">"name"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"_iterations"</span></span></span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"int256"</span></span></span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"doWork"</span></span></span></span>,<span class="hljs-string"><span class="hljs-string">"outputs"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:[]</span></span>,<span class="hljs-string"><span class="hljs-string">"payable"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:false</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"function"</span></span></span></span>}]</code> </pre> <br>  Run geth to do the deployment: <br><br><pre> <code class="bash hljs">$ geth console --testnet 2&gt;&gt;geth.log</code> </pre> <br>  To begin with, assign the binary code and interface to the variables, copying them from the compiler output.  <i>Please note that you should add 0x before the binary code</i> : <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bin = <span class="hljs-string"><span class="hljs-string">""</span></span>; &gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> abi = [{<span class="hljs-string"><span class="hljs-string">"constant"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"inputs"</span></span>:[],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"successfullyExecutedIterations"</span></span>,<span class="hljs-string"><span class="hljs-string">"outputs"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"int256"</span></span>}],<span class="hljs-string"><span class="hljs-string">"payable"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"function"</span></span>},{<span class="hljs-string"><span class="hljs-string">"constant"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"inputs"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"_iterations"</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"int256"</span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"doWork"</span></span>,<span class="hljs-string"><span class="hljs-string">"outputs"</span></span>:[],<span class="hljs-string"><span class="hljs-string">"payable"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"function"</span></span>}];</code> </pre> <br>  Create a contract object as in the case of opening: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contract = web3.eth.contract(abi);</code> </pre> <br>  Let's execute the contract.  Deploy is also a transaction that must be performed on behalf of a specific account, consumes gas and requires waiting.  Therefore, the contract contract, in addition to the constructor arguments, which in this case are not required, and the array of parameters (from, data, gas), accepts a callback (in this case, the simplest, issuing either the error text or the address of the contract).  But you first need to unlock the account: <br><br><pre> <code class="javascript hljs">&gt; web3.personal.unlockAccount(eth.coinbase);</code> </pre> <br>  Then you can execute the command with sending the transaction from this account: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uselessWorker = contract.new( {<span class="hljs-attr"><span class="hljs-attr">from</span></span>: eth.coinbase, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: bin, <span class="hljs-attr"><span class="hljs-attr">gas</span></span>: <span class="hljs-number"><span class="hljs-number">1000000</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, contract</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contract.address) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log (<span class="hljs-string"><span class="hljs-string">"mined "</span></span> + contract.address); } } });</code> </pre> <br>  Further expect a similar answer: <br><br><pre> <code class="bash hljs">mined 0xaad3bf6443621f24099ee4f51a22c8d7e9f63548</code> </pre> <br>  This means that the contract is closed, you can call the functions of this contract: <br><br><pre> <code class="javascript hljs">&gt; uselessWorker.successfullyExecutedIterations(); <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Please note that we did not describe such a function in the contract; it is created automatically for each <code>public</code> field. <br><br><h4>  2. Experiments with gas flow </h4><br>  We start by calculating the approximate amount of gas that will be required when calling a function. To do this, you can call the <code>estimateGas()</code> method on the contract method of interest, and the parameters of the method of interest are passed as parameters in <code>estimateGas</code> .  In our case, you can call this: <br><br><pre> <code class="javascript hljs">&gt; uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-number"><span class="hljs-number">41801</span></span> &gt; uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-number"><span class="hljs-number">41914</span></span> &gt; uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-number"><span class="hljs-number">42027</span></span></code> </pre> <br>  We see that each cycle according to calculations must spend 113 gas.  How much will it cost on the air?  To do this, you need to know what price of gas will be used.  If it is not specified when sending a transaction, you can see the default value (immediately convert to ether): <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.gasPrice ); <span class="hljs-number"><span class="hljs-number">1e-7</span></span></code> </pre> <br>  This means 1 gas by default in this case is 0.0000001 ether.  This price is not fixed and changed even in the course of how we executed the current commands.  Therefore, your values ‚Äã‚Äãare likely to be different.  The commission for the transaction in this way will be equal to the price of gas multiplied by the amount of gas.  We calculate the price for one cycle (the price includes not only the cycle itself, but also some initial price just for accepting a transaction): <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.gasPrice * uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">1</span></span>) ); <span class="hljs-string"><span class="hljs-string">"0.0041801"</span></span></code> </pre> <br>  At this price, about 10,000 cycles should give a commission in the tenths of the ether.  Check: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.gasPrice * uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">10000</span></span>) ); <span class="hljs-string"><span class="hljs-string">"0.1171752"</span></span></code> </pre> <br>  Really.  But what happens if you specify not 10,000, for example, 1,000,000?  The result will be the following: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.gasPrice * uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">1000000</span></span>) ); <span class="hljs-string"><span class="hljs-string">"0.4704624"</span></span></code> </pre> <br>  This disproportion arises from the fact that there is also the maximum amount of gas that can be consumed.  This number also has a default value, but in this case it cannot be viewed.  Let's see what happens if we explicitly set the gas limit, which we are ready to pay.  But first, check to see if the price has changed: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( eth.gasPrice ); <span class="hljs-number"><span class="hljs-number">2.8e-7</span></span></code> </pre> <br>  She grew up almost 3 times (it happened in less than half an hour).  The default price is taken as the market price, therefore it changes dynamically.  To keep the estimate for the same price that we used at the beginning, we will assign our price for gas (in wei) to a variable: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fixedGasPrice = <span class="hljs-number"><span class="hljs-number">100000000000</span></span>;</code> </pre> <br>  We calculate the price for 100 thousand cycles (a million can run too long) with our price, but with a modified gas limit (gas parameter). <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( fixedGasPrice * uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">100000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">gas</span></span>: <span class="hljs-number"><span class="hljs-number">100000000</span></span>}) ); <span class="hljs-string"><span class="hljs-string">"1.1341816"</span></span></code> </pre> <br>  Limit the amount of gas to 1000: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( fixedGasPrice * uselessWorker.doWork.estimateGas(<span class="hljs-number"><span class="hljs-number">100000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">gas</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>}) ); <span class="hljs-string"><span class="hljs-string">"0.0001"</span></span></code> </pre> <br>  In this case, all the supplied gas is consumed.  No changes on the blockchain will be saved, but the miner still gets paid, as he did the work until the gas ran out.  Therefore, it is important to correctly specify the gas limit.  The <code>estimateGas</code> function may not always provide reliable data, because its execution is based on the current state of the blockchain, which may be different during the execution of this transaction, which will result in a different gas flow. <br><br>  Let us turn to the actual execution of the methods and comparison with the predicted values.  First, let's see and remember the balance of your account: <br><br><pre> <code class="javascript hljs">&gt; initialBalance = eth.getBalance(eth.coinbase); <span class="hljs-number"><span class="hljs-number">5006820644000000000</span></span></code> </pre> <br>  Suppose we want to perform 10 cycles.  Calculate how much gas should be required for this call: <br><br><pre> <code class="javascript hljs">&gt; uselessWorker.doWork.estimateGas( <span class="hljs-number"><span class="hljs-number">10</span></span> ); <span class="hljs-number"><span class="hljs-number">42818</span></span></code> </pre> <br>  We use our <code>fixedGasPrice</code> price for this operation, but we will set the maximum amount of gas to 42000 (this is probably not enough, since it is less than the predicted value).  Therefore, our payment, taking into account the consumption of all the gas provided, should be in wei: <br><br><pre> <code class="javascript hljs">&gt; predictedCost = <span class="hljs-number"><span class="hljs-number">42000</span></span> * fixedGasPrice; <span class="hljs-number"><span class="hljs-number">4200000000000000</span></span></code> </pre> <br>  What will be on the air: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei(predictedCost); <span class="hljs-string"><span class="hljs-string">"0.0042"</span></span></code> </pre> <br>  Perform a transaction with the task of our limit and price (but before that unlock the account): <br><br><pre> <code class="javascript hljs">&gt; web3.personal.unlockAccount(eth.coinbase); &gt; transaction = uselessWorker.doWork( <span class="hljs-number"><span class="hljs-number">10</span></span>, { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: eth.coinbase, <span class="hljs-attr"><span class="hljs-attr">gas</span></span>: <span class="hljs-number"><span class="hljs-number">42000</span></span>, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: fixedGasPrice } ); <span class="hljs-string"><span class="hljs-string">"0xc0590a2cf39c3e4339253ecf11d124177b75502cea368adcf30d1b7d6933ef5a"</span></span></code> </pre> <br>  By the transaction number, you can track its status by running: <br><br><pre> <code class="javascript hljs">&gt; result = web3.eth.getTransactionReceipt(transaction);</code> </pre> <br>  The result is a structure that looks like this: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">blockHash</span></span>: <span class="hljs-string"><span class="hljs-string">"0x91b63b43856e62fd26ad7f401bfe556cc100e8adf4b5ac510261e91adb9953a3"</span></span>, blockNumber: <span class="hljs-number"><span class="hljs-number">1375978</span></span>, contractAddress: null, cumulativeGasUsed: <span class="hljs-number"><span class="hljs-number">740323</span></span>, from: <span class="hljs-string"><span class="hljs-string">"0x334731990b420d7fe77347545c45a689becfca08"</span></span>, gasUsed: <span class="hljs-number"><span class="hljs-number">42000</span></span>, logs: [], logsBloom: <span class="hljs-string"><span class="hljs-string">"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"</span></span>, root: <span class="hljs-string"><span class="hljs-string">"0x07dc7178ac2abaa2460cd94d5eb7bf6d7ed9ed09e3e74a4b53321b5c210932c0"</span></span>, to: <span class="hljs-string"><span class="hljs-string">"0xaad3bf6443621f24099ee4f51a22c8d7e9f63548"</span></span>, transactionHash: <span class="hljs-string"><span class="hljs-string">"0xc0590a2cf39c3e4339253ecf11d124177b75502cea368adcf30d1b7d6933ef5a"</span></span>, transactionIndex: <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  If, as a result, you have <code>nil</code> , then the transaction has not yet been added to the block, you must wait and repeat the command. <br><br>  In this structure, we see that <code>gasUsed</code> gas <code>gasUsed</code> turned out to be 42,000, as expected.  Check if our balance has changed: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( initialBalance - eth.getBalance(eth.coinbase) ); <span class="hljs-string"><span class="hljs-string">"0.0042"</span></span></code> </pre> <br>  Consumption turned out to be 0.0042 ether, as expected.  Check if the data in the contract has changed: <br><br><pre> <code class="javascript hljs">&gt; uselessWorker.successfullyExecutedIterations(); <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Nothing was saved to the variable, although the assignment in the contract was done before the loop.  It is thus seen that in the event of a gas shortage, the changes roll back completely.  But this transaction is still added to the block, because the work was carried out, so we can see the block number and all other information.  However, in the information we see no other signs of error, except that all the gas was spent.  How to determine the status of the transaction in a rare, but possible, case when all the gas was consumed, but no more was needed?  Unfortunately, there is no easier way than to look through the site (for example, <a href="https://ropsten.etherscan.io/tx/0xc0590a2cf39c3e4339253ecf11d124177b75502cea368adcf30d1b7d6933ef5a">here is the link</a> for our transaction, you can search for any other transaction and see if it ended with an error), or re-simulate sending the same transaction using debag. <br><br>  Check now what will happen if you specify the limit a little more than predicted.  Also save the initial balance: <br><br><pre> <code class="javascript hljs">&gt; initialBalance = eth.getBalance(eth.coinbase); <span class="hljs-number"><span class="hljs-number">5002620644000000000</span></span></code> </pre> <br>  This time we will allocate 43,000 gas, we can expect a change in the balance <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-number"><span class="hljs-number">43000</span></span> * fixedGasPrice; <span class="hljs-number"><span class="hljs-number">4300000000000000</span></span></code> </pre> <br>  Let's execute transaction with the task of the new limit: <br><br><pre> <code class="javascript hljs">&gt; web3.personal.unlockAccount(eth.coinbase); &gt; transaction = uselessWorker.doWork( <span class="hljs-number"><span class="hljs-number">10</span></span>, { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: eth.coinbase, <span class="hljs-attr"><span class="hljs-attr">gas</span></span>: <span class="hljs-number"><span class="hljs-number">43000</span></span>, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: fixedGasPrice } );</code> </pre> <br>  And we get the result of its implementation: <br><br><pre> <code class="javascript hljs">&gt; result = web3.eth.getTransactionReceipt(transaction);</code> </pre> <br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">blockHash</span></span>: <span class="hljs-string"><span class="hljs-string">"0xe9793206faf5e923042488d4312d542db2c5189d25a0014d894179fce222705d"</span></span>, blockNumber: <span class="hljs-number"><span class="hljs-number">1376028</span></span>, contractAddress: null, cumulativeGasUsed: <span class="hljs-number"><span class="hljs-number">131780</span></span>, from: <span class="hljs-string"><span class="hljs-string">"0x334731990b420d7fe77347545c45a689becfca08"</span></span>, gasUsed: <span class="hljs-number"><span class="hljs-number">42817</span></span>, logs: [], logsBloom: <span class="hljs-string"><span class="hljs-string">"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"</span></span>, root: <span class="hljs-string"><span class="hljs-string">"0x51fd139db608c2fa833e5de205497368362853b8e778787e85180e1cde206151"</span></span>, to: <span class="hljs-string"><span class="hljs-string">"0xaad3bf6443621f24099ee4f51a22c8d7e9f63548"</span></span>, transactionHash: <span class="hljs-string"><span class="hljs-string">"0xd69e46cbb9c139cc2c56ae4860b2e73e4581a97fc016c2848dc6bd399e9b5196"</span></span>, transactionIndex: <span class="hljs-number"><span class="hljs-number">2</span></span> }</code> </pre> <br>  Used 42817 gas (1 less than predicted). <br>  Air consumption: <br><br><pre> <code class="javascript hljs">&gt; web3.fromWei( initialBalance - eth.getBalance(eth.coinbase) ); <span class="hljs-string"><span class="hljs-string">"0.0042817"</span></span></code> </pre> <br>  Exactly as much as necessary to pay for used gas. <br><br>  Are there any changes to the contract? <br><br><pre> <code class="javascript hljs">&gt; uselessWorker.successfullyExecutedIterations(); <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  Yes, saved. <br><br><h2>  To be continued </h2><br>  That's all for now.  You can see the geth documentation <a href="https://github.com/ethereum/go-ethereum/wiki/geth">here</a> . <br><br>  <a href="https://solidity.readthedocs.io/en/develop/">Solidity</a> documentation. <br><br>  In geth, the web3.js library is used; documentation on it can be found <a href="https://github.com/ethereum/wiki/wiki/JavaScript-API">here</a> . <br>  This is one of the most common libraries for connecting to the Ethereum-blockchain.  We specialize in developing Ruby on Rails, so we set ourselves the goal of finding a suitable ruby ‚Äã‚Äãinterface.  In the next article, we will describe what comes of it. <br><br>  ‚Üí <a href="https://habrahabr.ru/post/336132/">Link to part 1</a> </div><p>Source: <a href="https://habr.com/ru/post/336770/">https://habr.com/ru/post/336770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336760/index.html">VMware vSAN 6.6.1 ‚îÄ one more step to perfection</a></li>
<li><a href="../336762/index.html">Go on devices with small memory</a></li>
<li><a href="../336764/index.html">[in bookmarks] PDF-version of articles about Bash-scripts</a></li>
<li><a href="../336766/index.html">A prototype project worth $ 86 million in 57 lines of code</a></li>
<li><a href="../336768/index.html">JEP 181: Access Control for Nested Classes</a></li>
<li><a href="../336772/index.html">5 ways to use red in your company colors</a></li>
<li><a href="../336774/index.html">Happy birthday, Linux! Recall Core 1.0</a></li>
<li><a href="../336778/index.html">Modern hiring - sucks</a></li>
<li><a href="../336780/index.html">In search of a lost gigabit or a bit about windows in TCP</a></li>
<li><a href="../336782/index.html">Interview with Ivar Jacobson, founder of UML, RUP, Essence</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>