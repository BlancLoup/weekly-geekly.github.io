<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build-traffic light: the story of another introduction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Discussing the implementation of auto-testing in our company, the idea of ‚Äã‚Äãvisualizing the results using a traffic light was proposed. This tool is s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build-traffic light: the story of another introduction</h1><div class="post__text post__text-html js-mediator-article">  Discussing the implementation of auto-testing in our company, the idea of ‚Äã‚Äãvisualizing the results using a traffic light was proposed.  This tool is simple and clear to everyone, and also produces a small wow effect.  Under the cut there will be a history of the introduction of a traffic light into our autotest system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c8/74e/f28/4c874ef28870c48e602024ac1a84eba6.png"><br><a name="habracut"></a><br><br><h5>  Search and purchase of traffic lights </h5><br>  On the Internet a huge number of proposals for the purchase of a traffic light.  We did not bother and collect our own, but immediately bought ready. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Technical characteristics of the GOST R 52282-2004 LED traffic light:</b> <div class="spoiler_text">  ‚Ä¢ Minimum power consumption of a traffic light: not more than 6W (red and yellow section) and 8W (green section) per section; <br>  ‚Ä¢ Operating supply voltage: 220V AC, in accordance with GOST 13109. According to tests, the dielectric strength of the insulation can withstand a voltage of at least 1500V at a frequency of 50 Hz without breakdowns for 1 min; <br>  ‚Ä¢ Warranty from the manufacturer for 3 years.  The service life of traffic lights at least 12 years.  Durable energy-saving LED emitters (LEDs) are used. The average lifetime of LEDs is 100,000 hours; <br>  ‚Ä¢ Operating temperature range of LED traffic lights: from - 60  to +60 ; <br>  ‚Ä¢ Lighting parameters of traffic lights, axial luminous intensity of emitters of road traffic lights in accordance with GOST R 52282-2004; <br>  ‚Ä¢ Small weight of the traffic light no more than 8 kg; <br></div></div><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5d/775/dd6/d5d775dd62a463539bc63f1abdc47d1c.jpg"><br><br>  Traffic light is expensive.  This model cost us almost 13,000 p.  The big plus of such a traffic light is its compactness.  The thickness of the traffic light, including peaks, is 275 mm.  Without peaks 138 mm.  Length 840 mm.  The set includes brackets with which we hung it on a ... cabinet. <br><br><h5>  Electronics </h5><br>  To control the traffic light, we decided to use the Quartech-Jackpot-USB discrete I / O card developed by our friends. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04e/8f7/39e/04e8f739e67b6fc4a8a49651241be5da.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/679/31b/3f6/67931b3f6613ff6f344a8cd1a8b4fa47.jpg"><br><br>  The control board is located in the traffic light body and controls three COSMO solid-state relays, providing with a large margin not only galvanic isolation, but also the required load capacity (if desired, more than one dozen such traffic lights can be controlled through them). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16a/930/b49/16a930b4976d6a6f7af06ad29ff74406.jpg"><br><br>  An extensible control protocol was developed and implemented, which allows using this board to control not only the traffic light, but also many other peripheral devices (power supply of surveillance cameras, lighting control systems, various buttons and sensors on demonstration layouts). <br><br><div class="spoiler">  <b class="spoiler_title">Control Protocol Description</b> <div class="spoiler_text">  The entire exchange is made in the mode of request-response from the PC, or in the mode of streaming data in a special mode. <br><br><h6>  Physical level </h6><br>  Full duplex USB sharing through a virtual COM port, open at 9600kb / s. <br><br><h6>  Transport level </h6><br>  The exchange between any devices occurs in the mode of direct connection.  All messages at the transport level have a standardized format: <br><br><table><tbody><tr><td width="77">  <strong>Field</strong> <br><br></td><td width="82">  <strong>Starting byte</strong> <br><br></td><td width="82">  <strong>Team size (number + data)</strong> <br><br></td><td width="108">  <strong>Current status</strong> <br><br></td><td width="81">  <strong>Team number</strong> <br><br></td><td width="102">  <strong>Command data</strong> <br><br></td><td width="110">  <strong>Check sum</strong> <br><br></td></tr><tr><td width="77">  The size <br><br></td><td width="82">  one <br><br></td><td width="82">  one <br><br></td><td width="108">  one <br><br></td><td width="81">  one <br><br></td><td width="102">  0-254 <br><br></td><td width="110">  one <br><br></td></tr><tr><td width="77">  Value <br><br></td><td width="82">  0x7E <br><br></td><td width="82">  1 - 255 <br><br>  0 - error <br><br></td><td width="108">  A bit field that determines the current state of each type of device. <br><br></td><td width="81">  1 - 255 <br><br>  0 - error <br><br></td><td width="102">  Determined by the team <br><br></td><td width="110">  <em>The sum of all previous message fields, including the start byte</em> <br><br></td></tr></tbody></table><br><br>  The current status bit field has the following fields: <br>  bit 0: 0 - normal operation, 1 - error <br>  bit 1: 0 - request waiting mode, 1 - streaming data <br><br><h6>  Command level </h6><br>  Each team consists of a ‚ÄúTeam Number‚Äù field and an optional ‚ÄúTeam Data‚Äù field.  Even numbers of commands - requests, odd - answers. <br><br><table><tbody><tr><td width="122">  <strong>Team number</strong> <br><br></td><td width="218">  <strong>Command description</strong> <br><br></td><td width="302">  <strong>Data</strong> <br><br></td></tr><tr><td width="122">  0x01 <br><br></td><td width="218">  Device Type Request <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x02 <br><br></td><td width="218">  Device Type Response <br><br></td><td width="302">  1 byte: <br><br>  0 - error <br><br>  1 - measuring part <br><br>  2 - interface part <br><br>  3 - PC <br><br></td></tr><tr><td width="122">  0x03 <br><br></td><td width="218">  Serial Number Request <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x04 <br><br></td><td width="218">  Serial Number Answer <br><br></td><td width="302">  2 bytes <br><br></td></tr><tr><td width="122">  0x05 <br><br></td><td width="218">  Request software version <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x06 <br><br></td><td width="218">  Answer software version <br><br></td><td width="302">  2 bytes <br><br></td></tr><tr><td width="122">  0x07 <br><br></td><td width="218">  Request Iron Version <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x08 <br><br></td><td width="218">  Iron version response <br><br></td><td width="302">  2 bytes <br><br></td></tr><tr><td width="122">  0x0A <br><br></td><td width="218">  Set port status <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x0B <br><br></td><td width="218">  Request port status <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x0C <br><br></td><td width="218">  Port Status Response <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x0D <br><br></td><td width="218">  Turn on beeper, ms <br><br></td><td width="302">  1-2 bytes <br><br></td></tr><tr><td width="122">  0x0E <br><br></td><td width="218">  Jumper Status Request <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x0F <br><br></td><td width="218">  Jumper Status Response <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x10 <br><br></td><td width="218">  Request for input status (optocoupler) <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x11 <br><br></td><td width="218">  Input Status Response <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x12 <br><br></td><td width="218">  Query the number of input fronts <br><br></td><td width="302">  1 byte (login number) <br><br></td></tr><tr><td width="122">  0x13 <br><br></td><td width="218">  Answer the number of fronts of inputs <br><br></td><td width="302">  5 bytes: <br><br>  1st byte - entry number <br><br>  2-3 bytes - the number of leading fronts <br><br>  4-5 bytes - the number of rear edges <br><br></td></tr><tr><td width="122">  0x14 <br><br></td><td width="218">  Batch request for the status of the inputs and the number of edges <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x15 <br><br></td><td width="218">  Response to batch request for the status of inputs and counters of the number of edges <br><br></td><td width="302">  33 bytes: <br><br>  1st byte - input status <br><br>  2-17 bytes - the number of leading edges of 2 bytes per input starting from zero <br><br>  18-33 bytes - the number of rear edges of 2 bytes per input starting from zero <br><br></td></tr><tr><td width="122">  0x16 <br><br></td><td width="218">  Resetting front counters <br><br></td><td width="302">  No (a 0x15 command with zero counter values ‚Äã‚Äãis issued in response) <br><br></td></tr><tr><td width="122">  0x20 <br><br></td><td width="218">  Setting the auto flashing bits of the outputs <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x21 <br><br></td><td width="218">  Request set bits flashing outputs <br><br></td><td width="302">  not <br><br></td></tr><tr><td width="122">  0x22 <br><br></td><td width="218">  The response of the set bits flashing outputs <br><br></td><td width="302">  1 byte <br><br></td></tr><tr><td width="122">  0x23 <br><br></td><td width="218">  Setting the blink time of output <br><br></td><td width="302">  3 bytes: <br><br>  1st byte - exit number <br><br>  2-3 bytes - period in ms <br><br>  The default period is 500ms.  If bytes 2-3 are 0, then the default period is set. <br><br></td></tr><tr><td width="122">  0x24 <br><br></td><td width="218">  Output flashing period response <br><br></td><td width="302">  3 bytes (similar to the 0x23 command) <br><br></td></tr></tbody></table><br><br>  If the response to the command is not received within the guard interval, then the connected device is considered lost. <br><br><h6>  Example: </h6><br><br>  Manage output lines of the board. <br><br>  In the virtual COM-port, you must send the command 0x0A with the data corresponding to the desired state of the output lines.  If it is necessary to signal only to the zero line, then in the data byte of the commands it is necessary to transmit 0x01.  Thus, the whole team will look like this: <br><br>  0x7E 0x02 0x00 0x0A 0x01 0x8B <br><br>  in response to this command, if it is possible, the board will respond with a 0x0C command with data corresponding to the state of the installed output lines: <br><br>  0x7E 0x02 0x00 0x0C 0x01 0x8D <br><br>  or, if it is impossible to execute, will report an error: <br><br>  0x7E 0x00 0x01 0x7F <br><br></div></div><br><br><h5>  Testing system </h5><br>  The system of automatic testing is written in the python3 language.  At intervals of one minute, the presence of a new revision in the repository is checked.  If such is present, it is pumped out, and tests are ‚Äúpitted‚Äù against it.  Tests are separate scripts on all the same python3, between which there are dependencies.  Thanks to the dependencies, the tests are arranged in a certain sequence: first, a test is run that builds the project;  behind him are ‚Äúquick‚Äù tests;  the last is all the rest.  The results of the tests are placed in a database (sqlite). <br><br>  A separate script implements a web server that visualizes the results of test execution. <br><img src="https://habrastorage.org/getpro/habr/post_images/ba7/457/4a5/ba74574a5ab8b47e8957a006eea012de.png"><br><br>  The same web-server was taught to form a summary of the totality of tests.  This feature is used to control the traffic light. <br><br><div class="spoiler">  <b class="spoiler_title">Under the cut script code to control the traffic light:</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env python3 import sys, os, termios, threading, time, http.client if len(sys.argv)&lt;=1: sys.exit("Usage: {0} CONFIG-FILE".format(sys.argv[0])) exec(open(sys.argv[1], "rt").read()) portfd=os.open(serialport, os.O_RDWR) # Configure serial port - make it "raw", set 9600 baud rate and 8N1 iflag,oflag,cflag,lflag,ispeed,ospeed,cc=tuple(termios.tcgetattr(portfd)) iflag&amp;=~(termios.IGNBRK|termios.BRKINT|termios.PARMRK|termios.ISTRIP|termios.INLCR|termios.IGNCR|termios.ICRNL|termios.IXON) oflag&amp;=~(termios.OPOST) lflag&amp;=~(termios.ECHO|termios.ECHONL|termios.ICANON|termios.ISIG|termios.IEXTEN) cflag&amp;=~(termios.CSIZE|termios.PARENB|termios.CSTOPB) cflag|=termios.CS8 ispeed=termios.B9600 ospeed=termios.B9600 termios.tcsetattr(portfd, termios.TCSANOW, [iflag, oflag, cflag, lflag, ispeed, ospeed, cc]) # Current state of traffic light: # 0 - fail (red light) # 1 - success (green light) # 2 - in progress (yellow light) # 3 - no data (blinking yellow) state=3 RED=0 YELLOW=1 GREEN=2 def trafficLightControl(light): cmd=[0x7E, 0x02, 0xFF, 0x0A] if light==RED: cmd.append(1) elif light==YELLOW: cmd.append(2) elif light==GREEN: cmd.append(4) else: cmd.append(0) cmd.append(sum(cmd)&amp;0xFF) os.write(portfd, bytes(cmd)) def controlThreadProc(): while True: if state==0: trafficLightControl(RED) elif state==1: trafficLightControl(GREEN) elif state==2: trafficLightControl(YELLOW) else: trafficLightControl(YELLOW) time.sleep(1.5) trafficLightControl(None) time.sleep(1.5) controlThread=threading.Thread(target=controlThreadProc) controlThread.start() def pollThreadProc(): global state connection=None while True: try: if connection is None: connection=http.client.HTTPConnection(server) connection.request("GET", "/{0}/status?test={1}".format(project, ",".join(tests))) r=connection.getresponse().readall() state=int(r.decode("ascii")) except: state=3 connection=None time.sleep(5) pollThread=threading.Thread(target=pollThreadProc) pollThread.start()</span></span></code> </pre> <br></div></div><br><br>  The configuration file contains the server address and a list of tests that will be monitored by the traffic light. <br><br><pre> <code class="python hljs">server=<span class="hljs-string"><span class="hljs-string">"192.168.2.245"</span></span> project=<span class="hljs-string"><span class="hljs-string">"tvz-win-trunk"</span></span> tests=[<span class="hljs-string"><span class="hljs-string">'build'</span></span>, <span class="hljs-string"><span class="hljs-string">'xmlcheck'</span></span>, <span class="hljs-string"><span class="hljs-string">'qdebug'</span></span>, <span class="hljs-string"><span class="hljs-string">'runss'</span></span>, <span class="hljs-string"><span class="hljs-string">'runssc'</span></span>, <span class="hljs-string"><span class="hljs-string">'tr_en'</span></span>, <span class="hljs-string"><span class="hljs-string">'trcyr_en'</span></span>, <span class="hljs-string"><span class="hljs-string">'warning1'</span></span>, <span class="hljs-string"><span class="hljs-string">'warning10'</span></span>, <span class="hljs-string"><span class="hljs-string">'warning100'</span></span>, <span class="hljs-string"><span class="hljs-string">'xmldeps'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue16683a'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17071'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue16796'</span></span>, <span class="hljs-string"><span class="hljs-string">'runmain'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17319'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17318'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17396a'</span></span>, <span class="hljs-string"><span class="hljs-string">'smartstation_su'</span></span>, <span class="hljs-string"><span class="hljs-string">'xmlrpcdoc_ss'</span></span>, <span class="hljs-string"><span class="hljs-string">'src_encoding'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17241'</span></span>, <span class="hljs-string"><span class="hljs-string">'issue17228'</span></span>] serialport=<span class="hljs-string"><span class="hljs-string">"/dev/ttyUSB0"</span></span></code> </pre><br><br>  The logic of the traffic light in the test system is very simple: <br><ul><li>  Red - test failed </li><li>  Yellow - test runs or recheck test </li><li>  Green - all tests completed successfully. </li><li>  Blinking amber - no connection to server </li></ul><br><br><h5>  Results </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/127/05d/87e/12705d87ec4c6f2801f1c888a42d7282.jpg"><br><br>  A traffic light was placed before leaving the office.  This gives a rather tangible psychological effect: a green traffic light is on - the path is clear (you can safely go home), red - you need to correct the error. </div><p>Source: <a href="https://habr.com/ru/post/216743/">https://habr.com/ru/post/216743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216733/index.html">Dynamic trees</a></li>
<li><a href="../216735/index.html">Making the server with your own hands</a></li>
<li><a href="../216737/index.html">Interface with drag-and-drop: how not to confuse the user?</a></li>
<li><a href="../216739/index.html">SQLite database encryption in Qt</a></li>
<li><a href="../216741/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ101 (March 16 - 22, 2014)</a></li>
<li><a href="../216747/index.html">In a major anti-piracy campaign, the BSA used "pirated" photo</a></li>
<li><a href="../216751/index.html">HTTP Strict-Transport-Security or how to protect yourself from man-in-the-middle attacks and force the browser to always use HTTPS</a></li>
<li><a href="../216753/index.html">Transformation of backup storage technologies: software products and data deduplication devices</a></li>
<li><a href="../216755/index.html">Useful materials for mobile developer # 45 (March 17-23)</a></li>
<li><a href="../216757/index.html">Boat for the arcade. Part number 2: connect OpenCV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>