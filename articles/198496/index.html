<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing "Redmine" on "Linux Ubuntu" with transparent domain authentication (Apache, Passenger, RVM, MySQL)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this post I would like to start a series of articles on how we have adapted the Redmine task tracker to fit our needs. 

 About 2 years ago, I ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing "Redmine" on "Linux Ubuntu" with transparent domain authentication (Apache, Passenger, RVM, MySQL)</h1><div class="post__text post__text-html js-mediator-article">  With this post I would like to start a series of articles on how we have adapted the Redmine task tracker to fit our needs. <br><br>  About 2 years ago, I had to change the profile of my activity quite strongly, and from system administration to go into development on the Ruby on Rails framework.  It was necessary to adapt Redmine to the needs of a fairly large IT department, and then to the needs of the company as a whole.  Then, I ran into the relative non-simplicity of installing “Redmine”.  And the comprehensive article for beginners really lacked! <br><br>  There are several ways to install the ROR application, which is the “Redmine”.  This article will discuss installing on the Apache web server using Passenger and RVM.  As a database server, we still use “MySQL” (or rather, MariaDB), although we are thinking about moving to “PostgreSQL”. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Apache </h4><br>  Install the Apache web server: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install apache2</span></span></code> </pre> <br>  The main reason for using “Apache” is the presence of a module for transparent authentication in the “Windows” domain.  We initially wanted to simplify the use of Redmine.  Not having to enter a password twice was a big plus. <br><br>  Immediately configure the virtual hosts "Apache".  First, we set up virtual hosts without Ruby support.  Just to check that “Apache” works correctly and configure the transparent authentication module in the “Windows” domain. <br><br>  Create a folder where the Redmine distribution will be located: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#mkdir /usr/share/srv-redmine/redmine-2.3</span></span></code> </pre><br>  Create a link from the “/ var / www” directory (the directory in which the Apache websites are usually located) to the folder with our future Redmine distribution: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#ln -s /usr/share/srv-redmine/redmine-2.3 /var/www/srv-redmine</span></span></code> </pre><br>  Create a virtual host file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#touch /etc/apache2/sites-available/redmine</span></span></code> </pre><br>  Fill the file with the following contents (configuring a virtual host): <br><br><pre> <code class="bash hljs"> &lt;VirtualHost *:80&gt; ServerName redmine.local ServerAdmin support@redmine.local DocumentRoot /var/www/srv-redmine/public Options Indexes ExecCGI FollowSymLinks &lt;Directory /var/www/srv-redmine/public&gt; AllowOverride all Options -MultiViews &lt;/Directory&gt; &lt;/VirtualHost&gt;</code> </pre><br>  The domain name "redmine.local" must be defined (resolved) on the network where you will use Redmine. <br><br>  We include our site: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#a2ensite redmine</span></span></code> </pre><br>  A package that implements the “a2ensite” command may not be installed in “Ubuntu”.  In this case, a hint will appear in the console how to install it. <br><br>  Restart apache: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#service apache2 restart</span></span></code> </pre><br>  To verify that the virtual host is configured correctly.  Create a file “index.html” with arbitrary content in the virtual host directory. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#touch /usr/share/srv-redmine/redmine-2.3/public/index.html</span></span></code> </pre><br>  Having opened the page “http: //redmine.local” in the browser, we should see the contents of our file. <br><br><h5>  Transparent Domain Authentication Module </h5><br>  Sadly, we didn’t find such a module under “ngix”.  Probably for this reason, we still use “Apache”. <br><br>  We swing the module, we unpack somewhere.  I usually unpack to my home directory: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cd ~ #wget http://modntlm.sourceforge.net/mod_ntlm2.tar.gz #tar -zxvf ./mod_ntlm2.tar.gz</span></span></code> </pre><br>  Install the package to compile the modules: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install apache2-prefork-dev</span></span></code> </pre><br>  With this module there is subtlety.  It does not authenticate too long logins.  Therefore, if the company has employees with logins like “rimsky-korsakov”, then before compiling the module, you need to change the maximum login length in the file “ntlmssp.inc.c” by editing the line “define MAX_USERLEN 32” <br><br>  Go to the unzipped directory.  Compile the module: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cd mod_ntlm2 #apxs2 -i -a -c mod_ntlm.c</span></span></code> </pre><br>  During the compilation process errors may occur.  This is normal. <br><br>  In the virtual host settings, add directives that are responsible for authentication.  The virtual host file should now look like this: <br><br><pre> <code class="bash hljs"> &lt;VirtualHost *:80&gt; ServerName redmine.local ServerAdmin support@redmine.local DocumentRoot /var/www/srv-redmine/public Options Indexes ExecCGI FollowSymLinks &lt;Directory /var/www/srv-redmine/public&gt; AllowOverride all Options -MultiViews &lt;/Directory&gt; &lt;LocationMatch <span class="hljs-string"><span class="hljs-string">"/login"</span></span>&gt; AuthType NTLM NTLMAuth on NTLMAuthoritative on NTLMDomain OUR_DOMAIN.LOCAL NTLMServer dc1.our_domain.local NTLMBackup dc2.our_domain.local require valid-user &lt;/Location&gt; &lt;/VirtualHost&gt;</code> </pre><br>  During operation, it was observed that this module can significantly slow down the return of static data.  Therefore, we configured the module so that it connects only on the authentication page in Redmine.  The rest of the authentication work is implemented by our <a href="https://github.com/tdvsdv/single_auth">transparent authentication plugin</a> . <br><br><h4>  MySQL (MariaDB) </h4><br>  Install the database server "Mysql". <br><br>  “MySQL” is a bit old, so it’s better to use its “MariaDB” fork.  At some stage we moved from the first to the second, without any problems.  In terms of installation and configuration for both database servers, everything is about the same. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install mysql-server</span></span></code> </pre><br>  Connect to the server with the password entered during the installation phase: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#mysql -uroot -pour_password</span></span></code> </pre><br>  Create an empty database for Redmine and assign privileges: <br><br><pre> <code class="bash hljs">create database redmine character <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> utf8; create user <span class="hljs-string"><span class="hljs-string">'redmine'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> identified by <span class="hljs-string"><span class="hljs-string">'password_for_redmine_user'</span></span>; grant all privileges on redmine.* to <span class="hljs-string"><span class="hljs-string">'redmine'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>;</code> </pre><br><h4>  RVM </h4><br>  In a nutshell, RVM allows you to install different versions of Ruby on the same computer.  We constantly argue with my colleague, do we really need an “RVM” on a production server? <br><br>  There is no direct need for it, but I love it because it allows you to greatly simplify the installation of "Ruby".  Ubuntu doesn't always have the latest Ruby packages, but RVM has it!  In general, we use "RVM". <br><br>  To install "RVM" you need to install "Curl": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install curl</span></span></code> </pre><br>  Then we exit the “root” user and then run as a normal user: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$curl</span></span> -L https://get.rvm.io | bash -s stable</code> </pre><br>  After installation, RVM will tell us which other packages need to be delivered to Ubuntu.  At the time of this writing, these were the following packages: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion</span></span></code> </pre><br>  Install "ruby-1.9.3", but first you need to put "ruby-1.8.7", otherwise nothing. <br>  If the message “RVM is not a function, selecting rubies with 'rvm use ...' will not work”, then the command “/ bin / bash --login” should be executed.  And then you can work with “RVM”: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> install ruby-1.8.7-head <span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> use ruby-1.8.7-head <span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> install ruby-1.9.3-head <span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> use ruby 1.9.3-head --default <span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> gemset create rails3 <span class="hljs-variable"><span class="hljs-variable">$rvm</span></span> use 1.9.3-head@rails3 --default</code> </pre><br>  When I mastered RVM, this post really helped me: <a href="http://habrahabr.ru/post/120504/">http://habrahabr.ru/post/120504/</a> . <br><br><h4>  Passenger </h4><br>  Passenger is an Apache module that allows you to run Ruby applications.  RVM allows you to compile Passenger for a particular jamset.  After compilation, RVM will advise how to connect Passenger to Apache. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apt-get install libapache2-mod-passenger $gem install passenger $rvmsudo /home/user/.rvm/gems/ruby-1.9.3-head@rails3/gems/passenger-4.0.8/bin/passenger-install-apache2-module #apt-get install libcurl4-openssl-dev</span></span></code> </pre><br>  The version of “Passenger” is subject to change.  Therefore, you need to make sure that the path is correct (in the 3rd team). <br><br>  In the corresponding Apache directories, we create the module configuration files and the module download files: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#touch /etc/apache2/mods-available/passenger.load</span></span></code> </pre><br>  Write the following content to the file: <br><br><pre> <code class="bash hljs">LoadModule passenger_module /home/user/.rvm/gems/ruby-1.9.3-head@rails3/gems/passenger-4.0.8/buildout/apache2/mod_passenger.so</code> </pre><br>  Configuration file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#touch /etc/apache2/mods-available/passenger.conf</span></span></code> </pre><br>  The contents of the configuration file: <br><br><pre> <code class="bash hljs">&lt;IfModule mod_passenger.c&gt; PassengerRoot /home/user/.rvm/gems/ruby-1.9.3-head@rails3/gems/passenger-4.0.8 PassengerDefaultRuby /home/user/.rvm/wrappers/ruby-1.9.3-head@rails3/ruby &lt;/IfModule&gt;</code> </pre><br>  After compiling Passenger, RVM will generate the correct contents of these files.  You just need to create files and copy the contents. <br><br>  We connect our module: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#a2enmod passenger</span></span></code> </pre><br>  Immediately change the configuration file "Apache".  Now we have Passenger: <br><br><pre> <code class="bash hljs"> &lt;VirtualHost *:80&gt; ServerName redmine.local ServerAdmin support@redmine.local DocumentRoot /var/www/srv-redmine/public Options Indexes ExecCGI FollowSymLinks PassengerResolveSymlinksInDocumentRoot on RailsEnv production RailsBaseURI / &lt;Directory /var/www/srv-redmine/public&gt; AllowOverride all Options -MultiViews &lt;/Directory&gt; &lt;LocationMatch <span class="hljs-string"><span class="hljs-string">"/login"</span></span>&gt; AuthType NTLM NTLMAuth on NTLMAuthoritative on NTLMDomain OUR_DOMAIN.LOCAL NTLMServer dc1.our_domain.local NTLMBackup dc2.our_domain.local require valid-user &lt;/Location&gt; &lt;/VirtualHost&gt;</code> </pre><br>  Restart Apache: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#service apache2 restart</span></span></code> </pre><br><br><h4>  Redmine </h4><br>  We take the latest version of Redmine from the SVN repository.  SVN client may not be installed in Ubuntu.  Then you need to install it. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cd /usr/share/srv-redmine #svn co http://redmine.rubyforge.org/svn/branches/2.3-stable redmine-2.3 #chmod 775 -R /usr/share/srv-redmine/redmine-2.3 #chown -R www-data:user /usr/share/srv-redmine/redmine-2.3</span></span></code> </pre><br>  The user is the user under whom we installed “RVM”. <br><br>  Install “Rmagic” and the <a href="http://stackoverflow.com/questions/3894225/imagemagick-rmagick-cant-install-rmagick-2-13-1-cant-find-magick-config">package without which gem will not be</a> installed. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#sudo apt-get install librmagick-ruby1.8 #sudo apt-get install libmagick9-dev #sudo apt-get install libmagickcore-dev libmagickwand-dev</span></span></code> </pre><br>  or like this (depending on the version of "Ubuntu"): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#sudo apt-get install graphicsmagick-libmagick-dev-compat #sudo apt-get install libmagickwand-dev</span></span></code> </pre><br>  Change the settings of the connection "Redmine" to the database.  In our case, this is “MySQL”: <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cd</span></span> /usr/share/srv-redmine/redmine-2.3/config</code> </pre><br>  Change the database.yml file: <br><br><pre> <code class="bash hljs">production: adapter: mysql2 database: redmine host: localhost username: redmine password: password_for_redmine_user encoding: utf8</code> </pre><br>  At the same time, we are configuring the sending of mail messages from Redmine.  File "configuration.yml": <br><br><pre> <code class="bash hljs">production: email_delivery: delivery_method: :smtp smtp_settings: address: <span class="hljs-string"><span class="hljs-string">"smtp_server"</span></span> port: 25 domain: <span class="hljs-string"><span class="hljs-string">"mail_domain_name"</span></span> authentication: none</code> </pre><br>  We have configured a mail server that does not require authentication within the network.  Therefore, the file is.  Your file may be different.  Read more here: <a href="http://www.redmine.org/projects/redmine/wiki/EmailConfiguration">http://www.redmine.org/projects/redmine/wiki/EmailConfiguration</a> <br><br>  Install all the jams that Redmine needs: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cd</span></span> /usr/share/srv-redmine/redmine-2.3 <span class="hljs-variable"><span class="hljs-variable">$bundle</span></span> install --without development <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  “Redmine” out of the box allows you to not transparently authenticate in the domain.  For this, the “net-ldap” jam is used.  This jam contains one very serious error. <br><br>  You need to find this jam in jamset and handles to fix the file according to this <a href="https://github.com/ruby-ldap/ruby-net-ldap/commit/401f3a3c33b7f1c82b6074a5f63d4cbf0e385fca">commit</a> . <br><br>  Otherwise, when certain data in Cyrillic is requested from “LDAP”, unexpected errors may occur. <br><br>  Then everything according to <a href="http://www.redmine.org/projects/redmine/wiki/RedmineInstall">the installation instructions «Redmine»</a> : <br><br>  We generate the secret key: <br><br><pre> <code class="bash hljs">rake generate_secret_token</code> </pre><br>  We create labels in our database: <br><br><pre> <code class="bash hljs">RAILS_ENV=production rake db:migrate</code> </pre><br>  Fill the database with basic data: <br><br><pre> <code class="bash hljs">RAILS_ENV=production REDMINE_LANG=ru rake redmine:load_default_data</code> </pre><br><br>  Actually that's all.  Restart Apache.  Everything should work. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#service apache restart</span></span></code> </pre><br><h4>  What other ways are there to install Redmine? </h4><br>  You can simply download <a href="http://bitnami.com/stack/redmine">"Bitnami Stack"</a> . <br><br>  You can install “Redmine” from the repositories: “apt-get install redmine”.  In Ubuntu, it is, but not always fresh. <br><br>  I prefer to go through a more complicated installation path, but then, have a deeper understanding of my server. <br><br>  I hope the article will be useful. </div><p>Source: <a href="https://habr.com/ru/post/198496/">https://habr.com/ru/post/198496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198486/index.html">The new law on SORM. To chat is useless, to run away too. Must fight!</a></li>
<li><a href="../198488/index.html">Responsive Design and IE8</a></li>
<li><a href="../198490/index.html">Ubuntu Birthday</a></li>
<li><a href="../198492/index.html">Home “cloud” server at 10 watts? Completely!</a></li>
<li><a href="../198494/index.html">Let's launch a probe on an asteroid?</a></li>
<li><a href="../198498/index.html">ICANN gave the green light to delegate two new zones: ONLINE and SITE</a></li>
<li><a href="../1985/index.html">Wikipedia is looking for valuable content to free it from copyright</a></li>
<li><a href="../19850/index.html">Lego art</a></li>
<li><a href="../198504/index.html">[Translation] 6 misconceptions in the methodology "Lean Startup" ("Lean Startup")</a></li>
<li><a href="../198506/index.html">Gartner Gartner technology maturity cycle - when introducing a new system in the enterprise</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>