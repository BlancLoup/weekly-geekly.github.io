<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Diarrhea for your backend on Node.JS - reduce build weight</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For certain you often noticed how much garbage is inside node modules. These are tests, benchmarks, readme files, licenses, typing script, and even an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Diarrhea for your backend on Node.JS - reduce build weight</h1><div class="post__text post__text-html js-mediator-article"><p>  For certain you often noticed how much garbage is inside node modules.  These are tests, benchmarks, readme files, licenses, typing script, and even an insane amount of garbage that can be more or less safely removed.  What we actually do in this post. <br>  I have already mentioned the last few publications about the weight of the node module, so here's another one, which generally reflects the current situation.  Little Big, ‚ÄúLife in da trash‚Äù is recommended as a soundtrack for the post. </p><br><p><img src="https://habrastorage.org/webt/gq/fu/s6/gqfus66jvoefmy9jyn9al5mylkk.png"></p><a name="habracut"></a><br><h2 id="nachalo">  Start </h2><br><p>  So, once again, by accidentally going inside the node modules, I mourn, and I began by saying that for the experiment I wrote several scripts with my hands, which I drove through my project.  They looked like this: </p><br><pre><code class="bash hljs">find ./ -iname <span class="hljs-string"><span class="hljs-string">"tests"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./node_modules -iname <span class="hljs-string"><span class="hljs-string">"test"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./node_modules -iname <span class="hljs-string"><span class="hljs-string">"*.gif"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./node_modules -iname <span class="hljs-string"><span class="hljs-string">"*.jpg"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./node_modules -iname <span class="hljs-string"><span class="hljs-string">"*.jpeg"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./node_modules -iname <span class="hljs-string"><span class="hljs-string">"*.png"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"*.md"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"*.log"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"LICENSE*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"README*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"LICENCE*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"AUTHORS*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"NOTICE*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">"changelog*"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".travis.yml"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".coveralls.yml"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".npmignore"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".gitignore"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".jshintrc"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".eslintrc"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".jscs.json"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".editorconfig"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".vs"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \; find ./ -iname <span class="hljs-string"><span class="hljs-string">".babelrc"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} \;</code> </pre> <br><p>  In general, it was already quite good, and it gave some savings, but I wanted some more elegant and general solution.  And quickly enough, I found a module that does exactly what I wanted - <a href="https://www.npmjs.com/package/modclean">ModClean</a> . </p><br><h2 id="modclean">  Modclean </h2><br><p>  The module has a lot of settings, and also lists of ‚Äúextra files‚Äù in the form of plug-ins, which are connected as npm packages.  By default, <a href="">this is the</a> list. </p><br><p>  There are three levels of deletion security files in it - I highly recommend that you look at the list and see what may cause you problems.  For example, I did not understand why on the list they included ‚Äúsemver‚Äù ... </p><br><p>  The only drawback is that for some reason the author of the module did not think that you might also want to remove all the garbage before building in your own project - for example, you absolutely do not need production test files ... <br>  True, it turned out that it was easy to get around by specifying the project directory as the module directory: </p><br><pre> <code class="bash hljs">modclean --modules-dir .</code> </pre> <br><h2 id="rezultaty">  results </h2><br><p>  It is clear that the results can be very different in different projects, but I have saved from 10% to 20% of the savings.  In advanced cases, there may be more.  This may not seem like the biggest figure, but this reduction in the storage space required by 20% or 20% faster rolling out projects from virtually nothing - so why not? <br>  For the curious on the module site there are also benchmarks for removal, but it is better to just try it at home. </p><br><h2 id="diarrhea">  Diarrhea </h2><br><p>  On this positive note, I would like to say that I have solved my task, and I recommend everyone to use this excellent module.  But you saw the word ‚Äúdiarrhea‚Äù in the title, not ‚Äúmodclean‚Äù, right?  This means that one more thing remains.  The nuance is quite fat in the literal sense of the word - it turned out that the module has 123 transitive dependencies and it weighs 4MB.  What is generally considered to be more or less the standard for the modules of the node, but can not deliver the heartache. </p><br><p>  At the same time, 1.2 megabytes is occupied by the wildly popular <a href="https://www.npmjs.com/package/update-notifier">update-notifier module</a> , all it does is that it draws such a frame if updates are available: <br><img src="https://habrastorage.org/webt/kh/-q/em/kh-qemxza1w9fw2x6ye0kehysnw.png"><br>  1 megabyte for this, Karl!  I, as a Node.JS developer, want to fail with shame. </p><br><p>  And most of the rest of the space is occupied by the <a href="https://www.npmjs.com/package/clui">clui module</a> , which contains all sorts of decorations for working with the terminal - only a couple of functions are used. </p><br><p>  In general, I could not bear it, and did my build - without blackjack and everything else.  I completely cut out the notification of updates from there, and I assembled the necessary functions from thick modules with a large number of dependencies into a minified bundle using a webpack.  In general, it was possible to play a little more and still reduce the weight of the module - but I reached the weight of 700 kilobytes and so far calmed down.  I also added the option --root, which allows you to more clearly not clean the dependencies, but the root of your project. </p><br><p>  Issues for all the above reasons I threw in the modclean, and I also made a pull request there, and if everything is approved, then I will deny this fork in favor of the main module - but for now there is a feeling that the modclean is abandoned - so if there are good ideas, throw them to me. </p><br><p>  You can install my version, as always, <a href="https://www.npmjs.com/package/diarrhea">from npm</a> . </p><br><h2 id="preduprezhdenie">  A warning </h2><br><p>  Double-check that you have everything you need in the repository - diarrhea can delete unnecessary files, files, teeth, and kill kittens.  I take off for this all responsibility. </p><br><h2 id="integraciya-v-ci">  CI Integration </h2><br><p>  It is best to use diarrhea like this: </p><br><ol><li>  First, we remove all the garbage from node modules; </li><li>  Then we run the unit tests to make sure that we haven't taken anything extra; </li><li>  Then we remove the garbage from the main project, including the actual tests; </li><li>  We do npm prune --production; </li><li>  We collect artifact. </li></ol><br><h2 id="todo">  ToDo </h2><br><p>  The module was made in haste for personal use, so in the future I would like to add the following: </p><br><ul><li>  Tests  Oddly enough, modClean doesn't have them at all; </li><li>  Compatibility with node up to version 8  Since there is already a webpack, it is not difficult; </li><li>  Cut a few more dependencies in which there is no special meaning; </li><li>  Minimal version without terminal decorations for CI </li></ul><br><h2 id="vyvody">  findings </h2><br><ul><li>  Once again, I get scared of what terrible things create a low threshold for entering my favorite ecosystem.  With this, you definitely need to do something, and I hope that this will somehow be decided at the npm level.  But right now I see that this beautiful update-notifier is in dependencies of the npm itself, which is very distressing.  This unfortunate notifier has 2 million downloads per week!  2 million megabytes (almost 2 terabytes) spent on the fucking frame with the message about the update! </li><li>  Always check the weight of your dependencies, even on the backend; </li><li>  Clean your dependencies; </li><li>  Strangely enough, a little bit I come to the idea that backend dependencies also need to be assembled into a common bundle.  What is being done quite easily and naturally with any tool of your choice, and does not add pain when debugging - after all, you can generate a search tool.  The only drawback is that not every package can be included in a bundle, I regularly encounter some problems in this, mostly due to the fact that everyone loves to connect dynamic dependencies.  For example, the same update-notifier cannot be shoved into a bundle. </li></ul><br><p>  Well, that's all. </p><br><p>  If you were interested, you might also like my other articles on this topic: </p><br><ul><li>  <a href="https://habr.com/post/353912/">Check for duplication of dependencies</a> using wtfwith; </li><li>  <a href="https://habr.com/post/347934/">Check security</a> dependencies using snyk; </li><li>  <a href="https://habr.com/post/346492/">A story</a> about how I live via meltdown on your phones using npm. </li></ul><br><p>  I can also tell you about various instances of the use of Node.JS on the backend, participate in the survey if you are interested. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354504/">https://habr.com/ru/post/354504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354492/index.html">How to develop a system that recognizes a person by keyboard writing</a></li>
<li><a href="../354494/index.html">GDPR on the nose - stop panic and begin to escape</a></li>
<li><a href="../354498/index.html">HOPE X. Conference "Breaking the elevator: from the basement to the penthouse." Part 2. "Security Systems"</a></li>
<li><a href="../354500/index.html">Badoo geolocation testing: bumps, stones, crutches and selfie stick</a></li>
<li><a href="../354502/index.html">The insides of the protocol, which browsers transmit voice and video</a></li>
<li><a href="../354506/index.html">How to fix the infrastructure after the tsunami</a></li>
<li><a href="../354508/index.html">Let's take a look at the SObjectizer under the hood</a></li>
<li><a href="../354510/index.html">Mail.Ru Group at the fifth Moscow Data Fest</a></li>
<li><a href="../354512/index.html">How to use trams to make it easier for a taxi driver to find you</a></li>
<li><a href="../354516/index.html">There is work in RnD, or how to get away from monotonous and minor tasks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>