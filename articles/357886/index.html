<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino: TV viewing time limit using RFID RC522 and</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will talk about how I have limited the time watching TV for a child using Arduino. 

 For some time, I began not to make a child's assess...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino: TV viewing time limit using RFID RC522 and</h1><div class="post__text post__text-html js-mediator-article">  This article will talk about how I have limited the time watching TV for a child using Arduino. <br><br>  For some time, I began not to make a child's assessment at school.  Passwords were set on the tablet and smartphone, time of use was limited to the PC, but the TV remained.  Hiding the cable every day, tired, and not the fact that he had not bought his own.  As a result, I decided to make a device that would limit TV viewing time, i.e.  would just disconnect 220V. <br><a name="habracut"></a><br>  To implement my idea I used: <br><br>  1. Double Side Prototype PCB Tinned Universal Breadboard 2x8 cm 20mmx80mm FR4: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/4d0/56a/e7e/4d056ae7e7686e3275a962275152c7cf.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2. 5V One 1 Channel Relay Module Board Shield For PIC AVR DSP ARM MCU Arduino: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/b45/40e/ba6/b4540eba64f7c2825341c0b3b6ff4a1e.jpg" alt="image"><br><br>  3. USB Nano V3.0 ATmega328 16M 5V Micro-controller CH340G board For Arduino: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/f4b/a98/b52/f4ba98b526f24fd2dabf3b3af648516e.jpg" alt="image"><br><br>  4. Mifare RC522 Card Read Antenna RF Module RFID Reader IC Card Proximity Module: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/2a0/a5b/ca1/2a0a5bca101557c02d13034ec831b291.jpg" alt="image"><br><br>  5. White 3-5V 0.96 "SPI Serial 128X64 OLED LCD LED Display Module for Arduino: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/c91/ac1/08b/c91ac108b3aebe914618014f5032edf7.jpg" alt="image"><br><br>  When the device is turned on, it reads information from the EEPROM for the presence of recorded cards (I limited the maximum number of cards to 6).  The EEPROM stores the last 4 bytes of the UID map translated into decimal format.  For reading and writing to the EEPROM I used the <a href="http://freeduino.ru/arduino/sample_EEPROM.html">EEPROM2.h</a> library. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cpp hljs">cardPresent = readCards(); <span class="hljs-function"><span class="hljs-function">boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCards</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ cardPresent = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt;<span class="hljs-number"><span class="hljs-number">6</span></span>; k++) { EEPROM_read(k*<span class="hljs-number"><span class="hljs-number">6</span></span>+<span class="hljs-number"><span class="hljs-number">4</span></span>, time[k]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(time[k] &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { cardPresent = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; EEPROM_read(k*<span class="hljs-number"><span class="hljs-number">6</span></span>, cards[k]); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cardPresent; }</code> </pre> <br></div></div><br>  To work with the MFRC522 module, I used the <a href="https://github.com/miguelbalboa/rfid">MFRC522.h</a> library.  Read the cards as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">MFRC522 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mfrc522</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SS_PIN, RST_PIN)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SPI.begin(); <span class="hljs-comment"><span class="hljs-comment">// Init SPI bus mfrc522.PCD_Init(); // Init MFRC522 void loop() { // Look for new cards if ( ! mfrc522.PICC_IsNewCardPresent()) { return; } // Select one of the cards if ( ! mfrc522.PICC_ReadCardSerial()) { return; } String s = dump_byte_array(mfrc522.uid.uidByte, mfrc522.uid.size); mfrc522.PICC_HaltA(); //           (  dump_byte_array    ,      ). Serial.println(s); }</span></span></code> </pre><br></div></div><br>  If there are no maps in the EEPROM, the first attached map is assigned by the master and is written to cell 0: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!cardPresent) { <span class="hljs-comment"><span class="hljs-comment">//  ,      short master = 0; EEPROM_write(0, uiddec); EEPROM_write(4, master); message = "NEW MASTER"; cardPresent = true; readCards(); }</span></span></code> </pre><br></div></div><br>  Display messages on the monitor.  Used library <a href="">HCuOLED.h</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Create an instance of the library (uncomment one of the lines below) */</span></span> <span class="hljs-comment"><span class="hljs-comment">//HCuOLED HCuOLED(SSD1307, SS_DI, DC_DI, RST_DI); // For SSD1307 displays (HCMODU0050 &amp; HCMODU0052) HCuOLED HCuOLED(SH1106, CS_DI, DC_DI, RST_DI); // For SH1106 displays (HCMODU0058 &amp; HCMODU0059) void setup() { HCuOLED.Reset(); } void drawUid(char *s) { HCuOLED.Erase(0,16,120,32); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,16); HCuOLED.Print(s); HCuOLED.Refresh(); } void drawLong(long uid) { HCuOLED.Erase(0,33,120,48); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,33); HCuOLED.Print(uid); HCuOLED.Refresh(); } void drawCardTime(String s) { char mess[12]; s.toCharArray(mess, 12); HCuOLED.Erase(0,49,120,80); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,49); HCuOLED.Print(mess); HCuOLED.Refresh(); }</span></span></code> </pre><br></div></div><br>  Now I will give the code of the String function dump_byte_array (byte * buffer, byte bufferSize).  It is called after reading the card.  The operation of the device is implemented as follows: <br><br>  1. We translate the last 4 bytes into decimal format and display the uid of the card in both formats, we look for the coincidence of the uid with what we considered from the EEPROM: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> String s; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> uiddec = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> temp; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> uid[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte m = (bufferSize &gt; <span class="hljs-number"><span class="hljs-number">4</span></span> ? (bufferSize - <span class="hljs-number"><span class="hljs-number">4</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>); m &lt; bufferSize; m++) { <span class="hljs-comment"><span class="hljs-comment">//   4       unsigned long p = 1; for(int k = 0; k &lt; bufferSize-m-1; k++) { p = p*256; } uiddec += p*buffer[m]; s = s + (buffer[m] &lt; 0x10 ? "0" : ""); s = s + String(buffer[m], HEX); } s.toCharArray(uid, 8); drawUid(uid); drawLong(uiddec); message = "unknow"; short currentCard = -1; for(int k = 0; k &lt;6; k++) { //  uid        if((time[k] &gt;=0) &amp;&amp; (cards[k] == uiddec)) { currentCard = k; } }</span></span></code> </pre><br></div></div><br>  2. Next comes the code that implements the device logic.  If the card is known, but it is not a master, then the onRelay (Relay, currentCard) function is called, which checks whether the time has passed for switching on. <br><br><div class="spoiler">  <b class="spoiler_title">String onRelay (int relayPin, short card)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRelay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> relayPin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> card)</span></span></span><span class="hljs-function"> </span></span>{ String messa; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(time[card] == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//  offAllCards(); //   messa = "master ON"; digitalWrite(relayPin, LOW); //  } else { if(!isOn[card]) { //    unsigned long lastOn = (lastTime[card] == NULL ? 0 : lastTime[card]); //   if((millis()-lastOn)/60000 &gt; (freqOn - 1)) { //    ,     messa = "time:" + String(time[card]); lastTime[card] = someCardsIsOn() + time[card]*60000; //          +   isOn[card] = true; //       digitalWrite(relayPin, LOW); //  } else { //      short waitminutes = freqOn - (millis()-lastOn)/60000; //      messa = "Wait:" + String(waitminutes/60) + "h" + String(waitminutes%60)+ "m"; //messa = String(waitminutes); } } else { messa = "Allready ON"; } } return messa; } void offAllCards() { for(int k = 0; k &lt; 10; k++) { isOn[k] = false; } } unsigned long someCardsIsOn() { // -   ,          unsigned long maxtime = millis(); for(int k = 0; k &lt;6; k++) { if(isOn[k]&amp;&amp;(lastTime[k] &gt; maxtime)) { maxtime = lastTime[k]; } } return maxtime; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(currentCard &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ,     message = onRelay(Relay, currentCard); } else { if(currentCard == 0) { // ,     ,     EEPROM,  ,     if(!masterPresent) { newCard = false; masterPresent = true; message = "master in"; onRelay(Relay, currentCard); } else { if(newCard) { for(int k = 1; k &lt; 6; k++) { if(time[k] &lt; 0) { writeNewCard(newCardUid,k); //Serial.println("new card write to " + String(k)); newCard = false; message = "card added"; break; } } } else { masterPresent=false; offRelay(Relay); message = "master out"; } } } else { //   0,   ,   ,  ,    ,    if(masterPresent) { newCard = true; newCardUid = uiddec; message = "confirm?"; } else {message = "unknow";} } } if(!cardPresent) { //  ,      short master = 0; EEPROM_write(0, uiddec); EEPROM_write(4, master); message = "NEW MASTER"; cardPresent = true; readCards(); } if(uiddec == 696374757) { //      eraseCards(); cardPresent = readCards(); message = "ERASED"; } drawCardTime(message); } void eraseCards() { short master = -1; for(int t = 0; t &lt; 40; t++) { EEPROM_write(t*2, master);} readCards(); //Serial.println("Cards erased"); } void writeNewCard(unsigned long uid, int k) { short time = 30; EEPROM_write(k*6, uid); EEPROM_write(k*6+4, time); readCards(); }</span></span></code> </pre><br></div></div><br>  Now let's not forget to turn off the device when the time runs out. To do this, add the following code to the very beginning of the loop () function <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((millis()/<span class="hljs-number"><span class="hljs-number">10000</span></span>)%<span class="hljs-number"><span class="hljs-number">2</span></span> ^ i) { <span class="hljs-comment"><span class="hljs-comment">//check each 10 seconds i = !i; if(!masterPresent) { if(millis() &gt; (someCardsIsOn()-1000)) { offRelay(Relay); message = "Time over"; } else { message = "Remain:" + String((someCardsIsOn() - millis())/60000+1); Serial.println(message); } drawCardTime(message); HCuOLED.Refresh(); } }</span></span></code> </pre><br></div></div><br>  Sketch code entirely: <br><br><div class="spoiler">  <b class="spoiler_title">Sketch code entirely</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Typical pin layout used: * ----------------------------------------------------------------------------------------- * MFRC522 Arduino Arduino Arduino Arduino Arduino * Reader/PCD Uno Mega Nano v3 Leonardo/Micro Pro Micro * Signal Pin Pin Pin Pin Pin Pin * ----------------------------------------------------------------------------------------- * RST/Reset RST 9 5 D9 RESET/ICSP-5 RST * SPI SS SDA(SS) 10 53 D10 10 10 * SPI MOSI MOSI 11 / ICSP-4 51 D11 ICSP-4 16 * SPI MISO MISO 12 / ICSP-1 50 D12 ICSP-1 14 * SPI SCK SCK 13 / ICSP-3 52 D13 ICSP-3 15 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SPI.h&gt; #include &lt;MFRC522.h&gt; #include &lt;HCuOLED.h&gt; #include &lt;EEPROM2.h&gt; #define RST_PIN 6 // #define SS_PIN 7 // /* Digital pin number for the displays chip select pin */ #define CS_DI 10 /* Digital pin number for the displays data/command pin */ #define DC_DI 9 /* Digital pin number for the displays reset pin */ #define RST_DI 8 #define Relay 3 #define freqOn 300 //      unsigned long cards[6]; //uids    eeprom unsigned long newCardUid; //     boolean i = false; short time[6]; //        ,   eeprom unsigned long lastTime[6]; //    boolean isOn[6]; //      boolean cardPresent; //       eeprom boolean masterPresent = false; //   boolean newCard = false; //    String message; /* Create an instance of the library (uncomment one of the lines below) */ //HCuOLED HCuOLED(SSD1307, SS_DI, DC_DI, RST_DI); // For SSD1307 displays (HCMODU0050 &amp; HCMODU0052) HCuOLED HCuOLED(SH1106, CS_DI, DC_DI, RST_DI); // For SH1106 displays (HCMODU0058 &amp; HCMODU0059) MFRC522 mfrc522(SS_PIN, RST_PIN); // Create MFRC522 instance void setup() { Serial.begin(9600); // Initialize serial communications with the PC //while (!Serial); // Do nothing if no serial port is opened (added for Arduinos based on ATMEGA32U4) pinMode(Relay, OUTPUT); digitalWrite(Relay, HIGH); SPI.begin(); // Init SPI bus mfrc522.PCD_Init(); // Init MFRC522 ShowReaderDetails(); // Show details of PCD - MFRC522 Card Reader details //Serial.println(F("Scan PICC to see UID, type, and data blocks...")); HCuOLED.Reset(); //HCuOLED.SetFont(MedProp_11pt); //HCuOLED.Cursor(40,0); //HCuOLED.Print("Uid:"); //eraseCards(); cardPresent = readCards(); } void loop() { if((millis()/10000)%2 ^ i) { //check each 10 seconds i = !i; if(!masterPresent) { if(millis() &gt; (someCardsIsOn()-1000)) { offRelay(Relay); message = "Time over"; } else { message = "Remain:" + String((someCardsIsOn() - millis())/60000+1); Serial.println(message); } drawCardTime(message); HCuOLED.Refresh(); } } // Look for new cards if ( ! mfrc522.PICC_IsNewCardPresent()) { return; } // Select one of the cards if ( ! mfrc522.PICC_ReadCardSerial()) { return; } String s = dump_byte_array(mfrc522.uid.uidByte, mfrc522.uid.size); mfrc522.PICC_HaltA(); Serial.println(s); } void ShowReaderDetails() { // Get the MFRC522 software version byte v = mfrc522.PCD_ReadRegister(mfrc522.VersionReg); Serial.print(F("MFRC522 Software Version: 0x")); Serial.print(v, HEX); if (v == 0x91) Serial.print(F(" = v1.0")); else if (v == 0x92) Serial.print(F(" = v2.0")); else Serial.print(F(" (unknown)")); Serial.println(""); // When 0x00 or 0xFF is returned, communication probably failed if ((v == 0x00) || (v == 0xFF)) { Serial.println(F("WARNING: Communication failure, is the MFRC522 properly connected?")); } } String dump_byte_array(byte *buffer, byte bufferSize) { String s; unsigned long uiddec = 0; unsigned long temp; char uid[8]; for (byte m = (bufferSize &gt; 4 ? (bufferSize - 4) : 0); m &lt; bufferSize; m++) { //   4       unsigned long p = 1; for(int k = 0; k &lt; bufferSize-m-1; k++) { p = p*256; } uiddec += p*buffer[m]; s = s + (buffer[m] &lt; 0x10 ? "0" : ""); s = s + String(buffer[m], HEX); } s.toCharArray(uid, 8); drawUid(uid); drawLong(uiddec); message = "unknow"; short currentCard = -1; for(int k = 0; k &lt;6; k++) { //  uid        if((time[k] &gt;=0) &amp;&amp; (cards[k] == uiddec)) { currentCard = k; } } if(currentCard &gt; 0) { // ,     message = onRelay(Relay, currentCard); } else { if(currentCard == 0) { // ,     ,     EEPROM,  ,     if(!masterPresent) { newCard = false; masterPresent = true; message = "master in"; onRelay(Relay, currentCard); } else { if(newCard) { for(int k = 1; k &lt; 6; k++) { if(time[k] &lt; 0) { writeNewCard(newCardUid,k); //Serial.println("new card write to " + String(k)); newCard = false; message = "card added"; break; } } } else { masterPresent=false; offRelay(Relay); message = "master out"; } } } else { //   0,   ,   ,  ,    ,    if(masterPresent) { newCard = true; newCardUid = uiddec; message = "confirm?"; } else {message = "unknow";} } } if(!cardPresent) { //  ,      short master = 0; EEPROM_write(0, uiddec); EEPROM_write(4, master); message = "NEW MASTER"; cardPresent = true; readCards(); } if(uiddec == 696374757) { eraseCards(); cardPresent = readCards(); message = "ERASED"; } drawCardTime(message); return s; } void drawUid(char *s) { HCuOLED.Erase(0,16,120,32); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,16); HCuOLED.Print(s); HCuOLED.Refresh(); } void drawLong(long uid) { HCuOLED.Erase(0,33,120,48); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,33); HCuOLED.Print(uid); HCuOLED.Refresh(); } void drawCardTime(String s) { char mess[12]; s.toCharArray(mess, 12); HCuOLED.Erase(0,49,120,80); HCuOLED.SetFont(MedProp_11pt); HCuOLED.Cursor(0,49); HCuOLED.Print(mess); HCuOLED.Refresh(); } void eraseCards() { short master = -1; for(int t = 0; t &lt; 40; t++) { EEPROM_write(t*2, master);} readCards(); //Serial.println("Cards erased"); } boolean readCards() { cardPresent = false; for(int k = 0; k &lt;6; k++) { EEPROM_read(k*6+4, time[k]); if(time[k] &gt;= 0) { cardPresent = true; EEPROM_read(k*6, cards[k]); //Serial.print(cards[k]); //Serial.print(" - "); //Serial.println(time[k]); } } return cardPresent; } void writeNewCard(unsigned long uid, int k) { short time = 30; EEPROM_write(k*6, uid); EEPROM_write(k*6+4, time); readCards(); } String onRelay(int relayPin, short card) { String messa; if(time[card] == 0) { //  offAllCards(); //   messa = "master ON"; digitalWrite(relayPin, LOW); //  } else { if(!isOn[card]) { //    unsigned long lastOn = (lastTime[card] == NULL ? 0 : lastTime[card]); //   if((millis()-lastOn)/60000 &gt; (freqOn - 1)) { //    ,     messa = "time:" + String(time[card]); lastTime[card] = someCardsIsOn() + time[card]*60000; //          +   isOn[card] = true; //       digitalWrite(relayPin, LOW); //  } else { //      short waitminutes = freqOn - (millis()-lastOn)/60000; //      messa = "Wait:" + String(waitminutes/60) + "h" + String(waitminutes%60)+ "m"; //messa = String(waitminutes); } } else { messa = "Allready ON"; } } return messa; } void offRelay(int relayPin) { offAllCards(); digitalWrite(relayPin, HIGH); } void offAllCards() { for(int k = 0; k &lt; 10; k++) { isOn[k] = false; } } unsigned long someCardsIsOn() { unsigned long maxtime = millis(); for(int k = 0; k &lt;6; k++) { if(isOn[k]&amp;&amp;(lastTime[k] &gt; maxtime)) { maxtime = lastTime[k]; } } return maxtime; }</span></span></span></span></code> </pre><br></div></div><br>  Connection diagram: <br><br> <a href="http://radikal.ru/fp/7ef705361d744ec397e7a3408f1c515c"><img src="https://habrastorage.org/getpro/geektimes/post_images/a8b/194/f73/a8b194f73fea3bd0cff5e4eab7bc17c3.jpg" alt="image"></a> <br> <a href="http://radikal.ru/fp/8242b551dc964190b053ccdf7d0f59c6"><img src="https://habrastorage.org/getpro/geektimes/post_images/58d/f6b/108/58df6b108156fd0a388ef5f4ceda6adc.jpg"></a> <br><br>  <a href="https://drive.google.com/open%3Fid%3D0B6csuiJ_-HxiSFQ4Y1hXNEhrS0k">Sketch reference</a> <br><br>  Demonstration of work: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/wYFNM5UHfaY%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhj9WxTsiFgodd2cj6gvWVGbt5BrhA" frameborder="0" allowfullscreen=""></iframe><br><br>  What I would like to change / add: <br><br>  1. Make it possible to change the time of use of the device for the card and remove it (putting the wizard to change the time several times: 30, 45, 60, 90, 120, -1). <br>  2. Add a button to the circuit with which you can reset the device. </div><p>Source: <a href="https://habr.com/ru/post/357886/">https://habr.com/ru/post/357886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357864/index.html">Roskomnadzor will conduct an "experiment" on blocking Zello Internet radio in Russia</a></li>
<li><a href="../357866/index.html">Roskomnadzor continues to destroy the Internet: it's Google's turn</a></li>
<li><a href="../357880/index.html">Arduino programmable relay</a></li>
<li><a href="../357882/index.html">Laser link between two Arduino Morse code</a></li>
<li><a href="../357884/index.html">Forecaster Class for Weather Station or Weather Predictor</a></li>
<li><a href="../357888/index.html">DMX-512 Channel Level Transmission Visualization</a></li>
<li><a href="../357890/index.html">We process lines on Arduino</a></li>
<li><a href="../357892/index.html">Based on "Processing lines on Arduino"</a></li>
<li><a href="../357894/index.html">Crazy hands: "Stern dispenser"</a></li>
<li><a href="../357896/index.html">Arduino Home Weather Station</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>