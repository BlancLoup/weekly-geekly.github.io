<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remove the starry sky with Emgu CV</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habr. 

 It just so happens that I have been interested in photography and astronomy for a long time. I like to shoot the starry sky. Since ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remove the starry sky with Emgu CV</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c7d/bdb/c19/c7dbdbc196292a202c4f71da7377ae8a.jpg" alt="image"></a> <br><br>  Good day, Habr. <br><br>  It just so happens that I have been interested in photography and astronomy for a long time.  I like to shoot the starry sky.  Since there is little light at night, in order to get something really beautiful you have to do quite a lot of exposure.  But another problem comes up - due to the fact that the Earth rotates, the stars in the sky move.  Accordingly, with relatively long exposures, the stars cease to be points, and begin to draw arcs.  To compensate for this movement when photographing / observing deep-sky objects, there are devices - <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BA%25D0%25B2%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25BE%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0">mount</a> .  Unfortunately, at the moment there is no possibility to buy a mount, so I decided to ask myself: is it possible to implement a similar effect programmatically and what will be the result? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Under the cut a lot of photos.</i>  <i>All photos in my post, (almost all) are clickable and free-to-download.</i> <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  The problem with shooting stars is this - they move.  At first glance it may seem that this movement is completely imperceptible, but even at relatively short exposures (20 ‚Äù+) the stars already cease to be points ‚Äî short arcs begin to be seen, which they draw while moving across the sky. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d71/738/99b/d7173899b7001240be23ca730d678a94.jpg" alt="image"></a> <br>  <i>Exposure ~ 15 "</i> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f2c/ec7/2f2/f2cec72f2b4ee1e09713253684b0ec17.jpg" alt="image"></a> <br>  <i>Exposure ~ 20 '</i> <br><br><h4>  Theory </h4><br>  Earth rotates around its own axis.  Relatively distant stars, this period is <a href="http://en.wikipedia.org/wiki/Earth%27s_rotation">86164.090530833 seconds</a> . <br>  Accordingly, knowing the shutter speed of the frame, it is possible to calculate by how many degrees all the stars in the frame have turned around the center.  The idea is such that if you compensate for this rotation, turning the entire frame in the opposite direction by this value, then all the stars should remain in place. <br><br>  The problem of finding a center around which everything revolves is not a problem.  It is enough to find a polar star - the axis of rotation of the Earth passes very close to it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3cf/134/e88/3cf134e88c05a8d6b5aeb6905f04dc7b.png" alt="image"><br>  <i>Celestial Pole - the same axis.</i> <br><br><h4>  Implementation </h4><br><br>  To implement this idea, I decided to use <a href="http://www.emgu.com/wiki/index.php/Main_Page">Emgu CV</a> - the wrapper of the OpenCV library for .NET. <br><br>  I will not paint the entire program - I will only talk about the main methods. <br><br>  If you put photos one on top of another, then in Photoshop I usually used Blending Mode: Lighten.  Its essence is such that from the two images it is one, choosing the pixels with the greatest brightness.  Ie, if there are two pixels in the two source images, then the resulting image will be the pixel that is brighter. <br><br>  Emgu CV has already implemented this method. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Image&lt;TColor, TDepth&gt; Max( Image&lt;TColor, TDepth&gt; img2 )</code> </pre> <br><br><h5>  Mode 1: Adding images without rotation </h5><br>  There is nothing complicated here - just alternately overlay all the photos from the list one on another. <br><br><pre> <code class="cpp hljs">List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; fileNames = (List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;)filesList; <span class="hljs-comment"><span class="hljs-comment">// input Image&lt;Bgr, Byte&gt; image = new Image&lt;Bgr, Byte&gt;(fileNames.First()); // resulting foreach (string filename in fileNames) { Image&lt;Bgr, Byte&gt; nextImage = new Image&lt;Bgr, byte&gt;(filename); image = image.Max(nextImage); nextImage.Dispose(); pictureProcessed(this, new PictureProcessedEventArgs(image)); // updating image in imagebox }</span></span></code> </pre><br><br>  Why do you need this mode?  Then, after the addition of photos, arcs are produced due to the movement of stars.  It is very easy to find the center of rotation (polar star).  Yes, and sometimes get some pretty interesting photos with traces. <br><br><h5>  Mode 2: Addition of Rotation Compensated Images </h5><br>  In this mode, everything becomes a bit more complicated.  Initially, we need to calculate the angle of displacement of the star during the shooting.  There was an idea to calculate it simply on the basis of an excerpt, but I understood that this may not be the most accurate.  Therefore, we will pull out the time taken from the <b>EXIF</b> data photos. <br><br><pre> <code class="cpp hljs">Bitmap referencePic = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(fileNames.First()); <span class="hljs-comment"><span class="hljs-comment">//loading first image byte[] timeTakenRaw = referencePic.GetPropertyItem(36867).Value; // EXIF DateTime taken string timeTaken = System.Text.Encoding.ASCII.GetString(timeTakenRaw, 0, timeTakenRaw.Length - 1); // array to string without last char (newline) DateTime referenceTime = DateTime.ParseExact(timeTaken, "yyyy:MM:d H:m:s", System.Globalization.CultureInfo.InvariantCulture);</span></span></code> </pre><br><br>  Now in order. <br>  We need to determine the moment of the beginning of the shooting in order to start counting the displacement of the remaining frames from it. <br>  Load the photo and get the PropertyItem ID: 36867 - the date and time of receiving the frame. <br>  We convert the array of characters into a string (the last character is \ n, so we exclude it). <br>  Got a time when shooting started. <br><br>  For each subsequent photo, we will find the same and use the time difference to calculate the angle of rotation. <br>  Everything is considered simple, knowing <a href="http://en.wikipedia.org/wiki/Earth%27s_rotation">how many seconds it takes a complete revolution of the Earth</a> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> secondsShift = (dateTimeTaken - referenceTime).TotalSeconds; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> rotationAngle = secondsShift / stellarDay * <span class="hljs-number"><span class="hljs-number">360</span></span>;</code> </pre><br><br>  Rotate the image will be <a href="http://en.wikipedia.org/wiki/Affine_transformation">an affine transformation</a> , but for this we need to calculate the rotation matrix. <br>  Fortunately, in Emgu CV this is all done for us. <br><br><pre> <code class="cpp hljs">RotationMatrix2D&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; rotationMatrix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotationMatrix2D&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(rotationCenter, -rotationAngle, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//change rotationAngle sign for CW/CCW</span></span></code> </pre><br><br>  Having a matrix, you can apply an affine transformation to the current photo, and then add them as in the first mode. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Image&lt;Bgr, Byte&gt; imageToRotate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image&lt;Bgr, Byte&gt;(currentPic)) { referenceImage = referenceImage.Max(imageToRotate.WarpAffine&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(rotationMatrix, Emgu.CV.CvEnum.INTER.CV_INTER_CUBIC, Emgu.CV.CvEnum.WARP.CV_WARP_FILL_OUTLIERS, background)); }</code> </pre><br><br>  Actually, that's all.  For each photo, we perform these two methods, and see what happens. <br><br><h4>  Tests </h4><br>  Source Images: <br><img src="https://habrastorage.org/storage2/f73/80b/597/f7380b59709180335388e13320dd4f26.jpg"><br>  <i>27 pieces</i> <br><br><h5>  Test 1: Stack </h5><br>  Results overlay all photos into one. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c7d/bdb/c19/c7dbdbc196292a202c4f71da7377ae8a.jpg" alt="image"></a> <br><br><h5>  Test 2: Rotate &amp; Stack </h5><br>  Marked the center of rotation, and forward. <br><img src="https://habrastorage.org/storage2/165/6bf/baa/1656bfbaa468c70172807ca6e621bd05.jpg"><br><br>  In the second test, a rather strange effect was obtained. <br>  1. The earth is smeared - this is normal.  Stars must be fixed. <br>  2. The stars in the center remained in their places, that is, everything worked as it should. <br>  3. Stars at the edges "floated" <br><br>  Why did it happen?  I have no idea!  I suppose that due to the distortion of the lens, the trajectory of the stars ceased to be around - became an ellipse. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f4a/0ad/7e0/f4a0ad7e090824e0972197bcff625bcb.jpg" alt="image"></a> <br>  <i>Exposure ~ 43 '</i> <br><br>  In this photo you can clearly see that the trajectory is different from the ideal circle - and this was all calculated for. <br><br><h5>  Equipment </h5><br>  Everything was shot on a Canon 7D with a Canon EF-S 10-22mm.  This lens is not the best optical parameters - namely, distortion.  Therefore, I blame him for the fact that everything did not turn out so smoothly.  Next time I will try to correct the distortion and test it again. <br><br>  <i>Clear sky!</i> <br><br>  <a href="https://github.com/dimkagfx/StarStacker">Github repository</a> </div><p>Source: <a href="https://habr.com/ru/post/179541/">https://habr.com/ru/post/179541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179531/index.html">How I chose Android for testing</a></li>
<li><a href="../179533/index.html">Improving 3d printing quality with cooling</a></li>
<li><a href="../179535/index.html">Million PPS per second - connectedness and balancing</a></li>
<li><a href="../179537/index.html">Sysadmin to 1C developer</a></li>
<li><a href="../179539/index.html">Game Boy Pocket: quick review + giblets</a></li>
<li><a href="../179543/index.html">How to drop Windows with six lines of code</a></li>
<li><a href="../179547/index.html">How are you looking for freelance orders on exchanges?</a></li>
<li><a href="../179553/index.html">How I bought a 42-inch LCD TV: the experience of choice and operation</a></li>
<li><a href="../179559/index.html">Dr. Tariff (tariffs and balance): How I began to help people save on mobile costs</a></li>
<li><a href="../179561/index.html">I am writing a toy OS (about mutex implementation)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>